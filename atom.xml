<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">
  <title>æ‹¾å¿†é±¼&#39;s Blog</title>
  
  <subtitle>æ„¿ä¸ºæ±Ÿæ°´ ä¸å›é‡é€¢</subtitle>
  <link href="https://www.haipeng-lin.cn/atom.xml" rel="self"/>
  
  <link href="https://www.haipeng-lin.cn/"/>
  <updated>2024-11-03T10:58:51.424Z</updated>
  <id>https://www.haipeng-lin.cn/</id>
  
  <author>
    <name>æ‹¾å¿†é±¼</name>
    
  </author>
  
  <generator uri="https://hexo.io/">Hexo</generator>
  
  <entry>
    <title>åŸºäºESå’ŒCanalåˆ†åˆ«å®ç°æ•°æ®æ£€ç´¢/åŒæ­¥</title>
    <link href="https://www.haipeng-lin.cn/posts/2fccc80a.html"/>
    <id>https://www.haipeng-lin.cn/posts/2fccc80a.html</id>
    <published>2024-11-03T10:56:12.000Z</published>
    <updated>2024-11-03T10:58:51.424Z</updated>
    
    <content type="html"><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="\assets\css\APlayer.min.css"><script src="\assets\js\APlayer.min.js" class="aplayer-secondary-script-marker"></script><h1 id="åŸºäºeså’Œcanalåˆ†åˆ«å®ç°æ•°æ®æ£€ç´¢åŒæ­¥"><a class="markdownIt-Anchor" href="#åŸºäºeså’Œcanalåˆ†åˆ«å®ç°æ•°æ®æ£€ç´¢åŒæ­¥"></a> åŸºäºESå’ŒCanalåˆ†åˆ«å®ç°æ•°æ®æ£€ç´¢/åŒæ­¥</h1><h2 id="1å‰è¨€"><a class="markdownIt-Anchor" href="#1å‰è¨€"></a> 1.å‰è¨€</h2><p>åœ¨æœ¬ç¯‡ä¸­ï¼Œæˆ‘ä»¬å°†ä½¿ç”¨ElasticSearchå®ç°æ–‡ç« æ£€ç´¢ï¼Œä½¿ç”¨Canalå®ç°ESå’ŒMySQLæ•°æ®åŒæ­¥ï¼Œå…¶ä¸­å…·ä½“å®ç°äº†å…¨é‡æ•°æ®åŒæ­¥å’Œå¢é‡æ•°æ®åŒæ­¥ï¼›åŒæ—¶å°†æ•´åˆESå®¢æˆ·ç«¯å®ç°æ•°æ®æ£€ç´¢</p><h2 id="2ç¯å¢ƒå‡†å¤‡"><a class="markdownIt-Anchor" href="#2ç¯å¢ƒå‡†å¤‡"></a> 2.ç¯å¢ƒå‡†å¤‡</h2><p>æˆ‘ä»¬éœ€è¦å®‰è£…ElasticSearchï¼ˆv7.17.4ï¼‰ã€Kinabaï¼ˆv7.17.4ï¼‰ã€IKåˆ†è¯å™¨ï¼ˆv7.17.4ï¼‰ã€Canalï¼ˆv1.1.7ï¼‰</p><p>ä¸€å®šä¸€å®šè¦ä¿æŒä¸‹è½½ç‰ˆæœ¬å’Œä¸Šè¿°çš„ä¸€è‡´ï¼Œä¸ç„¶ä¼šå‡ºç°å„ç§ç‰ˆæœ¬ä¸å…¼å®¹é—®é¢˜ï¼Œå¯åŠ¨å¤±è´¥</p><h3 id="21elasticsearch"><a class="markdownIt-Anchor" href="#21elasticsearch"></a> 2.1ElasticSearch</h3><blockquote><p>dockerå®‰è£…ESå‘½ä»¤ï¼š</p></blockquote><figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># æ‹‰å–ESé•œåƒ</span></span><br><span class="line"><span class="string">docker</span> <span class="string">pull</span> <span class="string">elasticsearch:7.17.4</span></span><br></pre></td></tr></table></figure><figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># å¯åŠ¨ESå®¹å™¨ æ³¨æ„/mydata/elasticsearch/pluginsï¼Œåé¢ä¼šç”¨åˆ°</span></span><br><span class="line"><span class="string">docker</span> <span class="string">run</span> <span class="string">--name</span> <span class="string">my-es</span> <span class="string">-p</span> <span class="number">9200</span><span class="string">:9200</span> <span class="string">-p</span> <span class="number">9300</span><span class="string">:9300</span> <span class="string">\</span></span><br><span class="line"><span class="string">-e</span> <span class="string">&quot;discovery.type=single-node&quot;</span> <span class="string">\-e</span> <span class="string">ES_JAVA_OPTS=&quot;-Xms64m</span> <span class="string">-Xmx512m&quot;</span> <span class="string">\</span></span><br><span class="line"><span class="string">-v</span> <span class="string">/mydata/elasticsearch/data:/usr/share/elasticsearch/data</span> <span class="string">\</span></span><br><span class="line"><span class="string">-v</span> <span class="string">/mydata/elasticsearch/plugins:/usr/share/elasticsearch/plugins</span> <span class="string">\</span></span><br><span class="line"><span class="string">-d</span> <span class="string">elasticsearch:7.17.4</span></span><br></pre></td></tr></table></figure><ul><li>æµ‹è¯•æ˜¯å¦åˆ›å»ºæˆåŠŸï¼šipåœ°å€:9200</li></ul><p><img src="https://haipeng-lin.oss-cn-shenzhen.aliyuncs.com/202411031729067.png" alt="image-20241103172936394" /></p><h3 id="22kibana"><a class="markdownIt-Anchor" href="#22kibana"></a> 2.2Kibana</h3><blockquote><p>dockerå®‰è£…kibanaå‘½ä»¤ï¼š</p></blockquote><figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">docker</span> <span class="string">pull</span> <span class="string">kibana:7.17.4</span></span><br></pre></td></tr></table></figure><figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># æ³¨æ„ï¼Œè‹¥ESå®‰è£…åœ¨æœ¬åœ°ï¼Œåˆ™ESçš„åœ°å€è¦å¡«è™šæ‹Ÿåœ°å€ï¼ˆipconfigå‘½ä»¤ï¼‰</span></span><br><span class="line"><span class="string">docker</span> <span class="string">run</span> <span class="string">--name</span> <span class="string">kibana</span> <span class="string">-e</span> <span class="string">ELASTICSEARCH_HOSTS=http://192.168.234.128:9200</span> <span class="string">-p</span> <span class="number">5601</span><span class="string">:5601</span> <span class="string">\</span></span><br><span class="line"><span class="string">-d</span> <span class="string">kibana:7.17.4</span></span><br></pre></td></tr></table></figure><ul><li>æµ‹è¯•æ˜¯å¦è®¿é—®æˆåŠŸï¼š<a href="http://127.0.0.1:5601/">http://127.0.0.1:5601/</a></li><li>æ“ä½œESåœ°å€ï¼š<a href="http://localhost:5601/app/dev_tools#/console">http://localhost:5601/app/dev_tools#/console</a></li></ul><h3 id="23ikåˆ†è¯å™¨"><a class="markdownIt-Anchor" href="#23ikåˆ†è¯å™¨"></a> 2.3IKåˆ†è¯å™¨</h3><ul><li>ä¸‹è½½åœ°å€ï¼š<a href="https://github.com/medcl/elasticsearch-analysis-ik/releases/tag/v7.17.4">https://github.com/medcl/elasticsearch-analysis-ik/releases/tag/v7.17.4</a></li></ul><p><img src="https://haipeng-lin.oss-cn-shenzhen.aliyuncs.com/202411031736475.png" alt="image-20241103173610918" /></p><ul><li>å°†ä¸‹è½½çš„å‹ç¼©åŒ…è§£å‹ç¼©åœ¨ESçš„pluginsæ–‡ä»¶å¤¹ä¸‹ï¼Œå¹¶é‡å‘½åä¸ºikã€‚è™šæ‹Ÿæœºå³/mydata/elasticsearch/pluginsä½ç½®ï¼Œwindowsè§è‡ªå·±è®¾ç½®çš„æ˜ å°„ä½ç½®ï¼š</li></ul><p><img src="https://haipeng-lin.oss-cn-shenzhen.aliyuncs.com/202411031739529.png" alt="image-20241103173940475" /></p><ul><li>é‡å¯ESï¼Œæµ‹è¯•æ˜¯å¦å®‰è£…æˆåŠŸ</li></ul><p><img src="https://haipeng-lin.oss-cn-shenzhen.aliyuncs.com/202411031740635.png" alt="image-20241103174052107" /></p><h3 id="24canal"><a class="markdownIt-Anchor" href="#24canal"></a> 2.4Canal</h3><h4 id="241ä¸‹è½½åœ°å€"><a class="markdownIt-Anchor" href="#241ä¸‹è½½åœ°å€"></a> 2.4.1ä¸‹è½½åœ°å€</h4><ul><li>ä¸‹è½½åœ°å€ï¼š<a href="https://github.com/alibaba/canal/releases/tag/canal-1.1.7">https://github.com/alibaba/canal/releases/tag/canal-1.1.7</a></li><li>æ³¨æ„ï¼šå¿…é¡»ä¸‹è½½v1.1.7æ­£å¼ç‰ˆæœ¬ï¼Œéƒ½æ˜¯æœ¬äººäº²è‡ªè¸©çš„å‘ğŸ˜­ğŸ˜­ğŸ˜­<ul><li>1.1.6æ­£å¼ç‰ˆæœ¬å…¼å®¹ä¸äº† JDK1.8ç‰ˆæœ¬ï¼Œéœ€è¦å‡çº§ JDKç‰ˆæœ¬</li><li>1.1.7çš„alphaç‰ˆæœ¬ä¼šå‡ºç° é…ç½®ä¸èƒ½ä»¥&quot;_&quot;å¼€å¤´å¯¼è‡´çš„esMapingååºåˆ—åŒ–å¤±è´¥ çš„bug</li></ul></li><li>canal.deployerï¼šcanalçš„æœåŠ¡ç«¯ï¼Œå¯ä»¥åœ¨å®¢æˆ·ç«¯æ¥æ”¶æ•°æ®åº“å˜æ›´ä¿¡æ¯</li><li>canal.adapterï¼šå¢åŠ å®¢æˆ·ç«¯æ•°æ®è½åœ°çš„é€‚é…ï¼Œå³å½“æœåŠ¡ç«¯æ¥æ”¶åˆ°æ¶ˆæ¯åï¼Œä¼šæ ¹æ®ä¸åŒçš„ç›®æ ‡æºåšé€‚é…ï¼Œæ¯”å¦‚ESç›®æ ‡æºå’Œhbaseé€‚é…</li></ul><p><img src="https://haipeng-lin.oss-cn-shenzhen.aliyuncs.com/202411031754981.png" alt="image-20241103175430859" /></p><h4 id="242canaldeployeré…ç½®"><a class="markdownIt-Anchor" href="#242canaldeployeré…ç½®"></a> 2.4.2canal.deployeré…ç½®</h4><ul><li>ä¿®æ”¹ï¼šconfæ–‡ä»¶å¤¹çš„<strong>canal.properties</strong>ï¼ŒæœåŠ¡ç«¯æ³¨å†Œçš„åœ°å€ã€ç«¯å£ï¼›ç”¨äºadapterå‘ç°</li></ul><figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># register ip to zookeeper</span></span><br><span class="line"><span class="string">canal.register.ip</span> <span class="string">=</span> <span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span></span><br><span class="line"><span class="string">canal.port</span> <span class="string">=</span> <span class="number">11111</span></span><br></pre></td></tr></table></figure><ul><li>ä¿®æ”¹ï¼šconfâ€”â€”&gt;exampleæ–‡ä»¶å¤¹çš„ <strong>instance.properties</strong> ç›‘å¬çš„æ•°æ®åº“é…ç½®</li></ul><figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># position info</span></span><br><span class="line"><span class="string">canal.instance.master.address=127.0.0.1:3306</span></span><br></pre></td></tr></table></figure><ul><li>å¯åŠ¨ï¼šbinæ–‡ä»¶å¤¹çš„startup.batå‘½ä»¤</li><li>æŸ¥çœ‹æ—¥å¿—ï¼š</li></ul><p><img src="https://haipeng-lin.oss-cn-shenzhen.aliyuncs.com/202411031804236.png" alt="image-20241103180424841" /></p><h4 id="243canaladapteré…ç½®"><a class="markdownIt-Anchor" href="#243canaladapteré…ç½®"></a> 2.4.3canal.adapteré…ç½®</h4><ul><li>é¦–å…ˆï¼ŒæŠŠadapter çš„config ä¸‹é¢çš„ bootstrap.yml å†…å®¹å…¨éƒ¨æ³¨é‡Šæ‰ï¼Œå¦åˆ™ä¼šæç¤º XX è¡¨ä¸å­˜åœ¨</li></ul><p><img src="https://haipeng-lin.oss-cn-shenzhen.aliyuncs.com/202411031806781.png" alt="image-20241103180633645" /></p><ul><li>ä¿®æ”¹ï¼šadapter çš„config çš„ application.yml é…ç½®æ–‡ä»¶ï¼Œè¿æ¥canalçš„æœåŠ¡ç«¯ã€å…¨é‡æ•°æ®åŒæ­¥è®¾ç½®ã€ESé…ç½®</li></ul><p><img src="https://haipeng-lin.oss-cn-shenzhen.aliyuncs.com/202411031810974.png" alt="image-20241103181039302" /></p><ul><li>æ–°å¢ï¼šåœ¨adapterâ€”â€”&gt;configâ€”â€”&gt;esæ–‡ä»¶å¤¹æ–°å¢æ–‡ä»¶ article.ymlï¼Œå¯¹articleè¡¨è¿›è¡Œç›‘å¬</li></ul><figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">dataSourceKey:</span> <span class="string">defaultDS</span></span><br><span class="line"><span class="attr">destination:</span> <span class="string">example</span></span><br><span class="line"><span class="attr">groupId:</span> <span class="string">g1</span></span><br><span class="line"><span class="attr">esMapping:</span></span><br><span class="line">  <span class="attr">_index:</span> <span class="string">article</span></span><br><span class="line">  <span class="attr">_id:</span> <span class="string">_id</span></span><br><span class="line"><span class="comment">#  upsert: true</span></span><br><span class="line"><span class="comment">#  pk: id</span></span><br><span class="line">  <span class="attr">sql:</span> <span class="string">&quot;SELECT t.id As _id, t.id, t.user_id, t.article_type,t.title,t.short_title,t.picture,t.summary,t.category_id,t.source,t.source_url,t.offical_stat,t.topping_stat,</span></span><br><span class="line"><span class="string">        t.cream_stat,t.status,t.deleted,t.create_time,t.update_time</span></span><br><span class="line"><span class="string">        FROM article t&quot;</span></span><br><span class="line"><span class="comment">#sq1æ˜ å°„</span></span><br><span class="line">  <span class="attr">commitBatch:</span> <span class="number">1</span></span><br></pre></td></tr></table></figure><ul><li>å¯åŠ¨ï¼šbinç›®å½•ä¸‹çš„startup.batå‘½ä»¤ï¼Œå¯åŠ¨8081ç«¯å£</li></ul><h3 id="25esæ–°å¢ç´¢å¼•"><a class="markdownIt-Anchor" href="#25esæ–°å¢ç´¢å¼•"></a> 2.5ESæ–°å¢ç´¢å¼•</h3><figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">PUT</span> <span class="string">/article</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="attr">&quot;mappings&quot;:</span> &#123;</span><br><span class="line">    <span class="attr">&quot;properties&quot;:</span> &#123;</span><br><span class="line">      <span class="attr">&quot;id&quot;:</span> &#123;</span><br><span class="line">        <span class="attr">&quot;type&quot;:</span> <span class="string">&quot;integer&quot;</span></span><br><span class="line">      &#125;,</span><br><span class="line">      <span class="attr">&quot;user_id&quot;:</span> &#123;</span><br><span class="line">        <span class="attr">&quot;type&quot;:</span> <span class="string">&quot;integer&quot;</span></span><br><span class="line">      &#125;,</span><br><span class="line">      <span class="attr">&quot;article_type&quot;:</span> &#123;</span><br><span class="line">        <span class="attr">&quot;type&quot;:</span> <span class="string">&quot;integer&quot;</span></span><br><span class="line">      &#125;,</span><br><span class="line">      <span class="attr">&quot;title&quot;:</span> &#123;</span><br><span class="line">        <span class="attr">&quot;type&quot;:</span> <span class="string">&quot;text&quot;</span>,</span><br><span class="line">        <span class="attr">&quot;analyzer&quot;:</span> <span class="string">&quot;ik_max_word&quot;</span></span><br><span class="line">      &#125;,</span><br><span class="line">      <span class="attr">&quot;short_title&quot;:</span> &#123;</span><br><span class="line">        <span class="attr">&quot;type&quot;:</span> <span class="string">&quot;text&quot;</span>,</span><br><span class="line">        <span class="attr">&quot;analyzer&quot;:</span> <span class="string">&quot;ik_max_word&quot;</span></span><br><span class="line">      &#125;,</span><br><span class="line">      <span class="attr">&quot;picture&quot;:</span> &#123;</span><br><span class="line">        <span class="attr">&quot;type&quot;:</span> <span class="string">&quot;text&quot;</span>,</span><br><span class="line">        <span class="attr">&quot;analyzer&quot;:</span> <span class="string">&quot;ik_max_word&quot;</span></span><br><span class="line">      &#125;,</span><br><span class="line">      <span class="attr">&quot;summary&quot;:</span> &#123;</span><br><span class="line">        <span class="attr">&quot;type&quot;:</span> <span class="string">&quot;text&quot;</span>,</span><br><span class="line">        <span class="attr">&quot;analyzer&quot;:</span> <span class="string">&quot;ik_max_word&quot;</span></span><br><span class="line">      &#125;,</span><br><span class="line">      <span class="attr">&quot;category_id&quot;:</span> &#123;</span><br><span class="line">        <span class="attr">&quot;type&quot;:</span> <span class="string">&quot;integer&quot;</span></span><br><span class="line">      &#125;,</span><br><span class="line">      <span class="attr">&quot;source&quot;:</span> &#123;</span><br><span class="line">        <span class="attr">&quot;type&quot;:</span> <span class="string">&quot;integer&quot;</span></span><br><span class="line">      &#125;,</span><br><span class="line">      <span class="attr">&quot;source_url&quot;:</span> &#123;</span><br><span class="line">        <span class="attr">&quot;type&quot;:</span> <span class="string">&quot;text&quot;</span>,</span><br><span class="line">        <span class="attr">&quot;analyzer&quot;:</span> <span class="string">&quot;ik_max_word&quot;</span></span><br><span class="line">      &#125;,</span><br><span class="line">      <span class="attr">&quot;offical_stat&quot;:</span> &#123;</span><br><span class="line">        <span class="attr">&quot;type&quot;:</span> <span class="string">&quot;integer&quot;</span></span><br><span class="line">      &#125;,</span><br><span class="line">      <span class="attr">&quot;topping_stat&quot;:</span> &#123;</span><br><span class="line">        <span class="attr">&quot;type&quot;:</span> <span class="string">&quot;integer&quot;</span></span><br><span class="line">      &#125;,</span><br><span class="line">      <span class="attr">&quot;cream_stat&quot;:</span> &#123;</span><br><span class="line">        <span class="attr">&quot;type&quot;:</span> <span class="string">&quot;integer&quot;</span></span><br><span class="line">      &#125;,</span><br><span class="line">      <span class="attr">&quot;status&quot;:</span> &#123;</span><br><span class="line">        <span class="attr">&quot;type&quot;:</span> <span class="string">&quot;integer&quot;</span></span><br><span class="line">      &#125;,</span><br><span class="line">      <span class="attr">&quot;deleted&quot;:</span> &#123;</span><br><span class="line">        <span class="attr">&quot;type&quot;:</span> <span class="string">&quot;integer&quot;</span></span><br><span class="line">      &#125;,</span><br><span class="line">      <span class="attr">&quot;create_time&quot;:</span> &#123;</span><br><span class="line">        <span class="attr">&quot;type&quot;:</span> <span class="string">&quot;date&quot;</span></span><br><span class="line">      &#125;,</span><br><span class="line">      <span class="attr">&quot;update_time&quot;:</span> &#123;</span><br><span class="line">        <span class="attr">&quot;type&quot;:</span> <span class="string">&quot;date&quot;</span></span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="26æ•°æ®åŒæ­¥"><a class="markdownIt-Anchor" href="#26æ•°æ®åŒæ­¥"></a> 2.6æ•°æ®åŒæ­¥</h3><h4 id="261å…¨é‡åŒæ­¥"><a class="markdownIt-Anchor" href="#261å…¨é‡åŒæ­¥"></a> 2.6.1å…¨é‡åŒæ­¥</h4><ul><li>ä½¿ç”¨adapteræœåŠ¡æä¾›çš„æ¥å£å®ç°å…¨é‡æ•°æ®åŒæ­¥</li></ul><p><img src="https://haipeng-lin.oss-cn-shenzhen.aliyuncs.com/202411031454378.png" alt="image-20241103145435839" /></p><ul><li>æŸ¥è¯¢æ•°æ®ï¼š</li></ul><p><img src="https://haipeng-lin.oss-cn-shenzhen.aliyuncs.com/202411031819045.png" alt="image-20241103181858140" /></p><h4 id="262å¢é‡åŒæ­¥"><a class="markdownIt-Anchor" href="#262å¢é‡åŒæ­¥"></a> 2.6.2å¢é‡åŒæ­¥</h4><ul><li>æ–°å¢ã€ä¿®æ”¹ã€åˆ é™¤æ–‡ç« éƒ½ä¼šåŒæ—¶ä¿®æ”¹ESçš„æ•°æ®</li></ul><img src="https://haipeng-lin.oss-cn-shenzhen.aliyuncs.com/202411031853912.png" alt="image-20241103185342591" style="zoom: 67%;" /><h2 id="3eså®¢æˆ·ç«¯æ£€ç´¢æ•°æ®"><a class="markdownIt-Anchor" href="#3eså®¢æˆ·ç«¯æ£€ç´¢æ•°æ®"></a> 3.ESå®¢æˆ·ç«¯æ£€ç´¢æ•°æ®</h2><h3 id="31å¼•å…¥ä¾èµ–"><a class="markdownIt-Anchor" href="#31å¼•å…¥ä¾èµ–"></a> 3.1å¼•å…¥ä¾èµ–</h3><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.elasticsearch<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>elasticsearch<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>6.8.2<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.elasticsearch.client<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>elasticsearch-rest-client<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>6.8.2<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.elasticsearch.client<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>elasticsearch-rest-high-level-client<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>6.8.2<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure><h3 id="32é…ç½®yml"><a class="markdownIt-Anchor" href="#32é…ç½®yml"></a> 3.2é…ç½®yml</h3><figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># elasticsearché…ç½®</span></span><br><span class="line"><span class="attr">elasticsearch:</span></span><br><span class="line">  <span class="comment"># æ˜¯å¦å¼€å¯ESï¼Ÿæœ¬åœ°å¯åŠ¨å¦‚æœæ²¡æœ‰å®‰è£…ESï¼Œå¯ä»¥è®¾ç½®ä¸ºfalseå…³é—­ES</span></span><br><span class="line">  <span class="attr">open:</span> <span class="literal">false</span></span><br><span class="line">  <span class="comment"># esé›†ç¾¤åç§°</span></span><br><span class="line">  <span class="attr">clusterName:</span> <span class="string">elasticsearch</span></span><br><span class="line">  <span class="attr">hosts:</span> <span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span><span class="string">:9200</span></span><br><span class="line">  <span class="attr">userName:</span> <span class="string">elastic</span></span><br><span class="line">  <span class="attr">password:</span> <span class="string">elastic</span></span><br><span class="line">  <span class="comment"># es è¯·æ±‚æ–¹å¼</span></span><br><span class="line">  <span class="attr">scheme:</span> <span class="string">http</span></span><br><span class="line">  <span class="comment"># es è¿æ¥è¶…æ—¶æ—¶é—´</span></span><br><span class="line">  <span class="attr">connectTimeOut:</span> <span class="number">1000</span></span><br><span class="line">  <span class="comment"># es socket è¿æ¥è¶…æ—¶æ—¶é—´</span></span><br><span class="line">  <span class="attr">socketTimeOut:</span> <span class="number">30000</span></span><br><span class="line">  <span class="comment"># es è¯·æ±‚è¶…æ—¶æ—¶é—´</span></span><br><span class="line">  <span class="attr">connectionRequestTimeOut:</span> <span class="number">500</span></span><br><span class="line">  <span class="comment"># es æœ€å¤§è¿æ¥æ•°</span></span><br><span class="line">  <span class="attr">maxConnectNum:</span> <span class="number">100</span></span><br><span class="line">  <span class="comment"># es æ¯ä¸ªè·¯ç”±çš„æœ€å¤§è¿æ¥æ•°</span></span><br><span class="line">  <span class="attr">maxConnectNumPerRoute:</span> <span class="number">100</span></span><br></pre></td></tr></table></figure><h3 id="33esé…ç½®ç±»"><a class="markdownIt-Anchor" href="#33esé…ç½®ç±»"></a> 3.3ESé…ç½®ç±»</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Slf4j</span></span><br><span class="line"><span class="meta">@Data</span></span><br><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="comment">// ä¸‹é¢è¿™ä¸ªè¡¨ç¤ºåªæœ‰ elasticsearch.open = true æ—¶ï¼Œé‡‡è¿›è¡Œesçš„é…ç½®åˆå§‹åŒ–ï¼›å½“ä¸ä½¿ç”¨esæ—¶ï¼Œåˆ™ä¸ä¼šå®ä¾‹ RestHighLevelClient</span></span><br><span class="line"><span class="meta">@ConditionalOnProperty(prefix = &quot;elasticsearch&quot;, name = &quot;open&quot;)</span></span><br><span class="line"><span class="meta">@ConfigurationProperties(prefix = &quot;elasticsearch&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ElasticsearchConfig</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// æ˜¯å¦å¼€å¯ES</span></span><br><span class="line">    <span class="keyword">private</span> Boolean open;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// es host ip åœ°å€ï¼ˆé›†ç¾¤ï¼‰</span></span><br><span class="line">    <span class="keyword">private</span> String hosts;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// esç”¨æˆ·å</span></span><br><span class="line">    <span class="keyword">private</span> String userName;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// eså¯†ç </span></span><br><span class="line">    <span class="keyword">private</span> String password;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// es è¯·æ±‚æ–¹å¼</span></span><br><span class="line">    <span class="keyword">private</span> String scheme;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// esé›†ç¾¤åç§°</span></span><br><span class="line">    <span class="keyword">private</span> String clusterName;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// es è¿æ¥è¶…æ—¶æ—¶é—´</span></span><br><span class="line">    <span class="keyword">private</span> <span class="type">int</span> connectTimeOut;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// es socket è¿æ¥è¶…æ—¶æ—¶é—´</span></span><br><span class="line">    <span class="keyword">private</span> <span class="type">int</span> socketTimeOut;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// es è¯·æ±‚è¶…æ—¶æ—¶é—´</span></span><br><span class="line">    <span class="keyword">private</span> <span class="type">int</span> connectionRequestTimeOut;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// es æœ€å¤§è¿æ¥æ•°</span></span><br><span class="line">    <span class="keyword">private</span> <span class="type">int</span> maxConnectNum;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// es æ¯ä¸ªè·¯ç”±çš„æœ€å¤§è¿æ¥æ•°</span></span><br><span class="line">    <span class="keyword">private</span> <span class="type">int</span> maxConnectNumPerRoute;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * å¦‚æœ<span class="doctag">@Bean</span>æ²¡æœ‰æŒ‡å®šbeançš„åç§°ï¼Œé‚£ä¹ˆè¿™ä¸ªbeançš„åç§°å°±æ˜¯æ–¹æ³•å</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Bean(name = &quot;restHighLevelClient&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> RestHighLevelClient <span class="title function_">restHighLevelClient</span><span class="params">()</span> &#123;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// æ­¤å¤„ä¸ºå•èŠ‚ç‚¹es</span></span><br><span class="line">        <span class="type">String</span> <span class="variable">host</span> <span class="operator">=</span> hosts.split(<span class="string">&quot;:&quot;</span>)[<span class="number">0</span>];</span><br><span class="line">        <span class="type">String</span> <span class="variable">port</span> <span class="operator">=</span> hosts.split(<span class="string">&quot;:&quot;</span>)[<span class="number">1</span>];</span><br><span class="line">        <span class="type">HttpHost</span> <span class="variable">httpHost</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">HttpHost</span>(host, Integer.parseInt(port));</span><br><span class="line"></span><br><span class="line">        <span class="comment">// æ„å»ºè¿æ¥å¯¹è±¡</span></span><br><span class="line">        <span class="type">RestClientBuilder</span> <span class="variable">builder</span> <span class="operator">=</span> RestClient.builder(httpHost);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// è®¾ç½®ç”¨æˆ·åã€å¯†ç </span></span><br><span class="line">        <span class="type">CredentialsProvider</span> <span class="variable">credentialsProvider</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">BasicCredentialsProvider</span>();</span><br><span class="line">        credentialsProvider.setCredentials(AuthScope.ANY, <span class="keyword">new</span> <span class="title class_">UsernamePasswordCredentials</span>(userName, password));</span><br><span class="line"></span><br><span class="line">        <span class="comment">// è¿æ¥å»¶æ—¶é…ç½®</span></span><br><span class="line">        builder.setRequestConfigCallback(requestConfigBuilder -&gt; &#123;</span><br><span class="line">            requestConfigBuilder.setConnectTimeout(connectTimeOut);</span><br><span class="line">            requestConfigBuilder.setSocketTimeout(socketTimeOut);</span><br><span class="line">            requestConfigBuilder.setConnectionRequestTimeout(connectionRequestTimeOut);</span><br><span class="line">            <span class="keyword">return</span> requestConfigBuilder;</span><br><span class="line">        &#125;);</span><br><span class="line">        <span class="comment">// è¿æ¥æ•°é…ç½®</span></span><br><span class="line">        builder.setHttpClientConfigCallback(httpClientBuilder -&gt; &#123;</span><br><span class="line">            httpClientBuilder.setMaxConnTotal(maxConnectNum);</span><br><span class="line">            httpClientBuilder.setMaxConnPerRoute(maxConnectNumPerRoute);</span><br><span class="line">            httpClientBuilder.setDefaultCredentialsProvider(credentialsProvider);</span><br><span class="line">            <span class="keyword">return</span> httpClientBuilder;</span><br><span class="line">        &#125;);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">RestHighLevelClient</span>(builder);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="34esæ£€ç´¢æ•°æ®"><a class="markdownIt-Anchor" href="#34esæ£€ç´¢æ•°æ®"></a> 3.4ESæ£€ç´¢æ•°æ®</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> List&lt;SimpleArticleDTO&gt; <span class="title function_">querySimpleArticleBySearchKey</span><span class="params">(String key)</span> &#123;</span><br><span class="line">    <span class="comment">// å½“keyä¸ºç©ºæ—¶ï¼Œè¿”å›çƒ­é—¨æ¨è</span></span><br><span class="line">    <span class="keyword">if</span> (StringUtils.isBlank(key)) &#123;</span><br><span class="line">        <span class="keyword">return</span> Collections.emptyList();</span><br><span class="line">    &#125;</span><br><span class="line">    key = key.trim();</span><br><span class="line">    <span class="keyword">if</span> (!openES) &#123;</span><br><span class="line">        <span class="comment">// 1ã€æ•°æ®åº“æ£€ç´¢</span></span><br><span class="line">        List&lt;ArticleDO&gt; records = articleDao.listSimpleArticlesByBySearchKey(key);</span><br><span class="line">        <span class="keyword">return</span> records.stream().map(s -&gt; <span class="keyword">new</span> <span class="title class_">SimpleArticleDTO</span>().setId(s.getId()).setTitle(s.getTitle()))</span><br><span class="line">            .collect(Collectors.toList());</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 2ã€ESæ£€ç´¢</span></span><br><span class="line">    <span class="comment">// 2.1ã€SearchSourceBuilderï¼šæ„å»ºæœç´¢è¯·æ±‚</span></span><br><span class="line">    <span class="type">SearchSourceBuilder</span> <span class="variable">searchSourceBuilder</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">SearchSourceBuilder</span>();</span><br><span class="line">    <span class="comment">// 2.2ã€MultiMatchQueryBuilderï¼šæ„å»ºå¤šå­—æ®µåŒ¹é…æŸ¥è¯¢</span></span><br><span class="line">    <span class="type">MultiMatchQueryBuilder</span> <span class="variable">multiMatchQueryBuilder</span> <span class="operator">=</span> QueryBuilders.multiMatchQuery(key,</span><br><span class="line">                                                                                  EsFieldConstant.ES_FIELD_TITLE,</span><br><span class="line">                                                                                  EsFieldConstant.ES_FIELD_SHORT_TITLE);</span><br><span class="line">    searchSourceBuilder.query(multiMatchQueryBuilder);</span><br><span class="line">    <span class="comment">// 2.3ã€æ‰§è¡ŒæŸ¥è¯¢</span></span><br><span class="line">    <span class="type">SearchRequest</span> <span class="variable">searchRequest</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">SearchRequest</span>(<span class="keyword">new</span> <span class="title class_">String</span>[]&#123;EsIndexConstant.ES_INDEX_ARTICLE&#125;, searchSourceBuilder);</span><br><span class="line">    <span class="type">SearchResponse</span> <span class="variable">searchResponse</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        searchResponse = SpringUtil.getBean(RestHighLevelClient.class).search(searchRequest, RequestOptions.DEFAULT);</span><br><span class="line">    &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">        log.error(<span class="string">&quot;failed to query from es: key&quot;</span>, e);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 2.4ã€è·å–æŸ¥è¯¢ç»“æœçš„å‘½ä¸­ï¼ˆSearchHitsï¼‰ï¼Œå¹¶æå–æ‰€æœ‰å‘½ä¸­çš„æ–‡ç« ï¼ˆSearchHitæ•°ç»„ï¼‰ã€‚</span></span><br><span class="line">    <span class="comment">// åˆ›å»ºä¸€ä¸ªidsåˆ—è¡¨ï¼Œæ”¶é›†æ‰€æœ‰åŒ¹é…æ–‡ç« çš„ID</span></span><br><span class="line">    <span class="type">SearchHits</span> <span class="variable">hits</span> <span class="operator">=</span> searchResponse.getHits();</span><br><span class="line">    SearchHit[] hitsList = hits.getHits();</span><br><span class="line">    List&lt;Integer&gt; ids = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;();</span><br><span class="line">    <span class="keyword">for</span> (SearchHit documentFields : hitsList) &#123;</span><br><span class="line">        ids.add(Integer.parseInt(documentFields.getId()));</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (ObjectUtils.isEmpty(ids)) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    List&lt;ArticleDO&gt; records = articleDao.selectByIds(ids);</span><br><span class="line">    <span class="keyword">return</span> records.stream().map(s -&gt; <span class="keyword">new</span> <span class="title class_">SimpleArticleDTO</span>().setId(s.getId()).setTitle(s.getTitle()))</span><br><span class="line">        .collect(Collectors.toList());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>]]></content>
    
    
      
      
    <summary type="html">&lt;link rel=&quot;stylesheet&quot; class=&quot;aplayer-secondary-style-marker&quot; href=&quot;&#92;assets&#92;css&#92;APlayer.min.css&quot;&gt;&lt;script src=&quot;&#92;assets&#92;js&#92;APlayer.min.js&quot; cla</summary>
      
    
    
    
    <category term="ã€çŸ¥è¯†æµã€‘" scheme="https://www.haipeng-lin.cn/categories/%E3%80%90%E7%9F%A5%E8%AF%86%E6%B5%81%E3%80%91/"/>
    
    
  </entry>
  
  <entry>
    <title>åŸºäºRediså®ç°ç”¨æˆ·æ´»è·ƒæœˆ/æ—¥æ’è¡Œæ¦œ</title>
    <link href="https://www.haipeng-lin.cn/posts/46ceb5bd.html"/>
    <id>https://www.haipeng-lin.cn/posts/46ceb5bd.html</id>
    <published>2024-10-29T03:44:41.000Z</published>
    <updated>2024-10-29T03:47:26.341Z</updated>
    
    <content type="html"><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="\assets\css\APlayer.min.css"><script src="\assets\js\APlayer.min.js" class="aplayer-secondary-script-marker"></script><h2 id="1å‰è¨€"><a class="markdownIt-Anchor" href="#1å‰è¨€"></a> 1.å‰è¨€</h2><p>ä½œä¸ºä¸€ä¸ªçŸ¥è¯†äº¤æµç¤¾åŒºï¼Œä¸ºä½¿å¾—å¹³å°ç”¨æˆ·æœ‰å‚ä¸æ„Ÿï¼Œæˆ‘ä»¬å®ç°äº†ç”¨æˆ·æœˆã€æ—¥æ´»è·ƒæ’è¡Œæ¦œ</p><ul><li>æ•ˆæœå›¾ï¼š</li></ul><p><img src="https://haipeng-lin.oss-cn-shenzhen.aliyuncs.com/202410291127892.png" alt="image-20241029112717802" /></p><h2 id="2æ–¹æ¡ˆè®¾è®¡"><a class="markdownIt-Anchor" href="#2æ–¹æ¡ˆè®¾è®¡"></a> 2.æ–¹æ¡ˆè®¾è®¡</h2><h3 id="21æ´»è·ƒåº¦è®¡ç®—æ–¹å¼"><a class="markdownIt-Anchor" href="#21æ´»è·ƒåº¦è®¡ç®—æ–¹å¼"></a> 2.1æ´»è·ƒåº¦è®¡ç®—æ–¹å¼</h3><ul><li>ç”¨æˆ·æ¯è®¿é—®ä¸€ä¸ªé¡µé¢ï¼š+1åˆ†</li><li>å¯¹äºä¸€ç¯‡æ–‡ç« ï¼Œç‚¹èµã€æ”¶è—ï¼š+2åˆ†ï¼Œå–æ¶ˆåˆ™æ”¶å›æ´»è·ƒåˆ†</li><li>å‘å¸ƒä¸€ç¯‡å®¡æ ¸é€šè¿‡çš„æ–‡ç« ï¼š+10åˆ†</li></ul><p>åŒæ—¶ï¼Œåªå±•ç¤ºæœˆã€æ—¥æ´»è·ƒåº¦æœ€é«˜çš„å‰30åç”¨æˆ·</p><h3 id="22å­˜å‚¨å•å…ƒ"><a class="markdownIt-Anchor" href="#22å­˜å‚¨å•å…ƒ"></a> 2.2å­˜å‚¨å•å…ƒ</h3><p>å­˜å‚¨å•å…ƒå¯çœ‹ä½œæ˜¯åç«¯è¿”å›ç»™å‰ç«¯çš„æ•°æ®</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// ç”¨æˆ·æ ‡è¯†</span></span><br><span class="line"><span class="type">long</span> userId;</span><br><span class="line"><span class="comment">// ç”¨æˆ·åœ¨æ’è¡Œæ¦œä¸Šçš„æ’å</span></span><br><span class="line"><span class="type">long</span> rank;</span><br><span class="line"><span class="comment">// ç”¨æˆ·çš„ç§¯åˆ†</span></span><br><span class="line"><span class="type">long</span> score;</span><br></pre></td></tr></table></figure><h3 id="23zsetæ•°æ®ç»“æ„"><a class="markdownIt-Anchor" href="#23zsetæ•°æ®ç»“æ„"></a> 2.3zsetæ•°æ®ç»“æ„</h3><p>æˆ‘ä»¬ä½¿ç”¨äº†Redisçš„zsetæ•°æ®ç»“æ„ï¼Œå®ç°äº†æœˆ/æ—¥æ’è¡Œæ¦œ</p><ul><li>setï¼šç¡®ä¿é›†åˆå…ƒç´ çš„å”¯ä¸€æ€§</li><li>scoreï¼šæ¯ä¸ªå…ƒç´ çš„ç§¯åˆ†</li><li>æ’åï¼šæ ¹æ®ç§¯åˆ†è·å–æ’å</li></ul><h2 id="3é¡¹ç›®å®æˆ˜"><a class="markdownIt-Anchor" href="#3é¡¹ç›®å®æˆ˜"></a> 3.é¡¹ç›®å®æˆ˜</h2><h3 id="31å°è£…ç±»"><a class="markdownIt-Anchor" href="#31å°è£…ç±»"></a> 3.1å°è£…ç±»</h3><ul><li>æ’è¡Œæ¦œä¿¡æ¯ç±»</li></ul><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Data</span></span><br><span class="line"><span class="meta">@Accessors(chain = true)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">RankItemDTO</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * æ’å</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> Integer rank;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * è¯„åˆ†</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> Integer score;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * ç”¨æˆ·</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> SimpleUserInfoDTO user;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ul><li>æ´»è·ƒåˆ†ä¸šåŠ¡ç±»</li></ul><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Data</span></span><br><span class="line"><span class="meta">@Accessors(chain = true)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ActivityScoreBo</span> &#123;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * è®¿é—®é¡µé¢å¢åŠ æ´»è·ƒåº¦</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> String path;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * ç›®æ ‡æ–‡ç« </span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> Long articleId;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * è¯„è®ºå¢åŠ æ´»è·ƒåº¦</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> Boolean rate;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * ç‚¹èµå¢åŠ æ´»è·ƒåº¦</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> Boolean praise;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * æ”¶è—å¢åŠ æ´»è·ƒåº¦</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> Boolean collect;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * å‘å¸ƒæ–‡ç« å¢åŠ æ´»è·ƒåº¦</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> Boolean publishArticle;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * è¢«å…³æ³¨çš„ç”¨æˆ·</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> Long followedUserId;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * å…³æ³¨å¢åŠ æ´»è·ƒåº¦</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> Boolean follow;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ul><li>Zsetæ•°æ®ç»“æ„<ul><li>keyï¼šrank_å¹´æœˆæ—¥ï¼Œæˆ–è€… rankå¹´æœˆ</li><li>valueï¼šhashç»“æ„ï¼Œkeyä¸ºç”¨æˆ·idï¼Œvalueä¸ºç”¨æˆ·å¾—åˆ†</li></ul></li></ul><h3 id="32æ›´æ–°ç”¨æˆ·æ´»è·ƒåˆ†"><a class="markdownIt-Anchor" href="#32æ›´æ–°ç”¨æˆ·æ´»è·ƒåˆ†"></a> 3.2æ›´æ–°ç”¨æˆ·æ´»è·ƒåˆ†</h3><p>åœ¨å®é™…åœºæ™¯ä¸­ï¼Œç”±äºç½‘ç»œæŠ–åŠ¨ç­‰åŸå› ï¼Œå¯èƒ½ä¼šå‡ºç°é‡å¤å‘é€ç‚¹èµã€æ”¶è—ç­‰è¯·æ±‚ï¼Œè¿™æ—¶ä¼šå‡ºç°åŠ é‡å¤çš„æ´»è·ƒåˆ†çš„æƒ…å†µï¼Œæ‰€ä»¥æˆ‘ä»¬éœ€è¦åšä¸€ä¸ªå¹‚ç­‰ï¼Œé˜²æ­¢é‡å¤æ·»åŠ ï¼Œå³åˆ¤æ–­ä¸‹ä¹‹å‰æœ‰æ²¡æœ‰é‡å¤æ·»åŠ è¿‡ç›¸å…³çš„æ´»è·ƒåº¦</p><h4 id="321å¹‚ç­‰ç­–ç•¥"><a class="markdownIt-Anchor" href="#321å¹‚ç­‰ç­–ç•¥"></a> 3.2.1å¹‚ç­‰ç­–ç•¥</h4><p>æˆ‘ä»¬å°†ç”¨æˆ·çš„æ¯ä¸ªåŠ åˆ†é¡¹éƒ½ç›´æ¥è®°å½•ä¸‹æ¥ï¼Œåœ¨æ‰§è¡ŒåŠ åˆ†æ“ä½œæ—¶ï¼Œç”¨æ¥åšå¹‚ç­‰åˆ¤æ–­</p><ul><li>setæ•°æ®ç»“æ„<ul><li>keyï¼šrank_ç”¨æˆ·id-å¹´æœˆæ—¥</li><li>filedä¸ºç”¨æˆ·çš„å…·ä½“å·¥ä½œï¼ˆæµè§ˆã€ç‚¹èµã€è¯„è®ºï¼‰ï¼Œå€¼ä¸ºç›¸åº”çš„å¾—åˆ†</li></ul></li></ul><p><img src="https://haipeng-lin.oss-cn-shenzhen.aliyuncs.com/202410291057608.png" alt="image-20241029105658158" /></p><h4 id="322æ›´æ–°æ´»è·ƒåˆ†"><a class="markdownIt-Anchor" href="#322æ›´æ–°æ´»è·ƒåˆ†"></a> 3.2.2æ›´æ–°æ´»è·ƒåˆ†</h4><p>åŸºæœ¬æµç¨‹å¦‚ä¸‹ï¼š</p><ol><li>è®¡ç®—æ­¤æ¬¡æ“ä½œçš„æ´»è·ƒåˆ†ï¼Œç‚¹èµã€æ”¶è—åˆ™ä¸ºæ­£æ´»è·ƒåˆ†ï¼Œå–æ¶ˆåˆ™ä¸ºè´Ÿæ•°</li><li>å¹‚ç­‰ï¼šåˆ¤æ–­ä¹‹å‰æ˜¯å¦æœ‰æ›´æ–°è¿‡ç›¸å…³çš„æ´»è·ƒåº¦ä¿¡æ¯ã€‚æ ¹æ® rank_ç”¨æˆ·idå¹´æœˆæ—¥ ä½œä¸ºkeyï¼ŒåŠ¨ä½œä¸ºfield åˆ¤æ–­<ol><li>æ²¡æœ‰åŠ è¿‡åˆ†ï¼šè®°å½•åŠ åˆ†æ“ä½œã€æ›´æ–°ç”¨æˆ·æœˆã€æ—¥æ´»è·ƒæ¦œï¼ˆä½¿ç”¨zsetçš„zincrbyå‘½ä»¤ï¼šzincrby key increment fieldï¼‰</li><li>åŠ è¿‡åˆ†ï¼šç§»é™¤ç”¨æˆ·çš„æ´»è·ƒæ‰§è¡Œè®°å½•ã€æ›´æ–°ç”¨æˆ·æœˆã€æ—¥æ´»è·ƒæ¦œ</li></ol></li></ol><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">addActivityScore</span><span class="params">(Long userId, ActivityScoreBo activityScore)</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (userId == <span class="literal">null</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 1. è®¡ç®—æ´»è·ƒåº¦(æ­£ä¸ºåŠ æ´»è·ƒ,è´Ÿä¸ºå‡æ´»è·ƒ)</span></span><br><span class="line">    String field;</span><br><span class="line">    <span class="type">int</span> <span class="variable">score</span> <span class="operator">=</span> <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">if</span> (activityScore.getPath() != <span class="literal">null</span>) &#123;</span><br><span class="line">        field = <span class="string">&quot;path_&quot;</span> + activityScore.getPath();</span><br><span class="line">        score = <span class="number">1</span>;</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (activityScore.getArticleId() != <span class="literal">null</span>) &#123;</span><br><span class="line">        field = activityScore.getArticleId() + <span class="string">&quot;_&quot;</span>;</span><br><span class="line">        <span class="keyword">if</span> (activityScore.getPraise() != <span class="literal">null</span>) &#123;</span><br><span class="line">            field += <span class="string">&quot;praise&quot;</span>;</span><br><span class="line">            score = BooleanUtils.isTrue(activityScore.getPraise()) ? <span class="number">2</span> : -<span class="number">2</span>;</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (activityScore.getCollect() != <span class="literal">null</span>) &#123;</span><br><span class="line">            field += <span class="string">&quot;collect&quot;</span>;</span><br><span class="line">            score = BooleanUtils.isTrue(activityScore.getCollect()) ? <span class="number">2</span> : -<span class="number">2</span>;</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (activityScore.getRate() != <span class="literal">null</span>) &#123;</span><br><span class="line">            <span class="comment">// è¯„è®ºå›å¤</span></span><br><span class="line">            field += <span class="string">&quot;rate&quot;</span>;</span><br><span class="line">            score = BooleanUtils.isTrue(activityScore.getRate()) ? <span class="number">3</span> : -<span class="number">3</span>;</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (BooleanUtils.isTrue(activityScore.getPublishArticle())) &#123;</span><br><span class="line">            <span class="comment">// å‘å¸ƒæ–‡ç« </span></span><br><span class="line">            field += <span class="string">&quot;publish&quot;</span>;</span><br><span class="line">            score += <span class="number">10</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (activityScore.getFollowedUserId() != <span class="literal">null</span>) &#123;</span><br><span class="line">        field = activityScore.getFollowedUserId() + <span class="string">&quot;_follow&quot;</span>;</span><br><span class="line">        score = BooleanUtils.isTrue(activityScore.getFollow()) ? <span class="number">2</span> : -<span class="number">2</span>;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">final</span> <span class="type">String</span> <span class="variable">todayRankKey</span> <span class="operator">=</span> todayRankKey();</span><br><span class="line">    <span class="keyword">final</span> <span class="type">String</span> <span class="variable">monthRankKey</span> <span class="operator">=</span> monthRankKey();</span><br><span class="line">    <span class="comment">// 2. å¹‚ç­‰ï¼šåˆ¤æ–­ä¹‹å‰æ˜¯å¦æœ‰æ›´æ–°è¿‡ç›¸å…³çš„æ´»è·ƒåº¦ä¿¡æ¯</span></span><br><span class="line">    <span class="keyword">final</span> <span class="type">String</span> <span class="variable">userActionKey</span> <span class="operator">=</span> ACTIVITY_SCORE_KEY + userId + DateUtil.format(DateTimeFormatter.ofPattern(<span class="string">&quot;yyyyMMdd&quot;</span>), System.currentTimeMillis());</span><br><span class="line">    <span class="type">Integer</span> <span class="variable">ans</span> <span class="operator">=</span> RedisClient.hGet(userActionKey, field, Integer.class);</span><br><span class="line">    <span class="keyword">if</span> (ans == <span class="literal">null</span>) &#123;</span><br><span class="line">        <span class="comment">// 2.1 ä¹‹å‰æ²¡æœ‰åŠ åˆ†è®°å½•ï¼Œæ‰§è¡Œå…·ä½“çš„åŠ åˆ†</span></span><br><span class="line">        <span class="keyword">if</span> (score &gt; <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="comment">// è®°å½•åŠ åˆ†è®°å½•</span></span><br><span class="line">            RedisClient.hSet(userActionKey, field, score);</span><br><span class="line">            <span class="comment">// ä¸ªäººç”¨æˆ·çš„æ“ä½œè®°å½•ï¼Œä¿å­˜ä¸€ä¸ªæœˆçš„æœ‰æ•ˆæœŸï¼Œæ–¹ä¾¿ç”¨æˆ·æŸ¥è¯¢è‡ªå·±æœ€è¿‘31å¤©çš„æ´»è·ƒæƒ…å†µ</span></span><br><span class="line">            RedisClient.expire(userActionKey, <span class="number">31</span> * DateUtil.ONE_DAY_SECONDS);</span><br><span class="line"></span><br><span class="line">            <span class="comment">// æ›´æ–°å½“å¤©å’Œå½“æœˆçš„æ´»è·ƒåº¦æ’è¡Œæ¦œ</span></span><br><span class="line">            <span class="type">Double</span> <span class="variable">newAns</span> <span class="operator">=</span> RedisClient.zIncrBy(todayRankKey, String.valueOf(userId), score);</span><br><span class="line">            RedisClient.zIncrBy(monthRankKey, String.valueOf(userId), score);</span><br><span class="line">            <span class="keyword">if</span> (log.isDebugEnabled()) &#123;</span><br><span class="line">                log.info(<span class="string">&quot;æ´»è·ƒåº¦æ›´æ–°åŠ åˆ†! key#field = &#123;&#125;#&#123;&#125;, add = &#123;&#125;, newScore = &#123;&#125;&quot;</span>, todayRankKey, userId, score, newAns);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> (newAns &lt;= score) &#123;</span><br><span class="line">                <span class="comment">// ç”±äºä¸Šé¢åªå®ç°äº†æ—¥/æœˆæ´»è·ƒåº¦çš„å¢åŠ ï¼Œä½†æ˜¯æ²¡æœ‰è®¾ç½®å¯¹åº”çš„æœ‰æ•ˆæœŸï¼›ä¸ºäº†é¿å…æŒä¹…ä¿å­˜å¯¼è‡´rediså ç”¨è¾ƒé«˜ï¼›å› æ­¤è¿™é‡Œè®¾å®šäº†ç¼“å­˜çš„æœ‰æ•ˆæœŸ</span></span><br><span class="line">                <span class="comment">// æ—¥æ´»è·ƒæ¦œå•ï¼Œä¿å­˜31å¤©ï¼›æœˆæ´»è·ƒæ¦œå•ï¼Œä¿å­˜1å¹´</span></span><br><span class="line">                <span class="comment">// ä¸ºä»€ä¹ˆæ˜¯ newAns &lt;= score æ‰è®¾ç½®æœ‰æ•ˆæœŸå‘¢ï¼Ÿ</span></span><br><span class="line">                <span class="comment">// å› ä¸º newAns æ˜¯ç”¨æˆ·å½“å¤©çš„æ´»è·ƒåº¦ï¼Œå¦‚æœå‘ç°å’Œéœ€è¦å¢åŠ çš„æ´»è·ƒåº¦ scopre ç›¸ç­‰ï¼Œåˆ™è¡¨æ˜æ˜¯ä»Šå¤©çš„é¦–æ¬¡æ·»åŠ è®°å½•ï¼Œæ­¤æ—¶è®¾ç½®æœ‰æ•ˆæœŸå°±æ¯”è¾ƒç¬¦åˆé¢„æœŸäº†</span></span><br><span class="line">                <span class="comment">// ä½†æ˜¯è¯·æ³¨æ„ï¼Œä¸‹é¢çš„å®ç°æœ‰ä¸¤ä¸ªç¼ºé™·ï¼š</span></span><br><span class="line">                <span class="comment">//  1. å¯¹äºæœˆçš„æœ‰æ•ˆæœŸï¼Œå°±å˜æˆäº†æœ¬æœˆï¼Œæ¯å¤©çš„é¦–æ¬¡å¢åŠ æ´»è·ƒåº¦æ—¶ï¼Œéƒ½ä¼šé‡æ–°åˆ·ä¸€ä¸‹å®ƒçš„æœ‰æ•ˆæœŸï¼Œè¿™æ ·å°±å’Œé¢„æœŸä¸­çš„é¦–æ¬¡æ·»åŠ ç¼“å­˜æ—¶ï¼Œè®¾ç½®æœ‰æ•ˆæœŸä¸ç¬¦</span></span><br><span class="line">                <span class="comment">//  2. è‹¥å…ˆå¢åŠ æ´»è·ƒåº¦1ï¼Œå†å‡å°‘æ´»è·ƒåº¦1ï¼Œç„¶åå†åŠ æ´»è·ƒåº¦1ï¼ŒåŒæ ·ä¼šå¯¼è‡´é‡æ–°ç®—äº†æœ‰æ•ˆæœŸ</span></span><br><span class="line">                <span class="comment">// ä¸¥è°¨ä¸€äº›çš„å†™æ³•ï¼Œåº”è¯¥æ˜¯ å…ˆåˆ¤æ–­ key çš„ ttlï¼Œ å¯¹äºæ²¡æœ‰è®¾ç½®çš„æ‰è¿›è¡Œè®¾ç½®æœ‰æ•ˆæœŸï¼Œå¦‚ä¸‹</span></span><br><span class="line">                <span class="type">Long</span> <span class="variable">ttl</span> <span class="operator">=</span> RedisClient.ttl(todayRankKey);</span><br><span class="line">                <span class="keyword">if</span> (!NumUtil.upZero(ttl)) &#123;</span><br><span class="line">                    RedisClient.expire(todayRankKey, <span class="number">31</span> * DateUtil.ONE_DAY_SECONDS);</span><br><span class="line">                &#125;</span><br><span class="line">                ttl = RedisClient.ttl(monthRankKey);</span><br><span class="line">                <span class="keyword">if</span> (!NumUtil.upZero(ttl)) &#123;</span><br><span class="line">                    RedisClient.expire(monthRankKey, <span class="number">12</span> * DateUtil.ONE_MONTH_SECONDS);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (ans &gt; <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="comment">// 2.2 ä¹‹å‰å·²ç»åŠ è¿‡åˆ†ï¼Œå› æ­¤è¿™æ¬¡å‡åˆ†å¯ä»¥æ‰§è¡Œ</span></span><br><span class="line">        <span class="keyword">if</span> (score &lt; <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="comment">// ç§»é™¤ç”¨æˆ·çš„æ´»è·ƒæ‰§è¡Œè®°å½• --&gt; å³ç§»é™¤ç”¨æ¥åšé˜²é‡å¤æ·»åŠ æ´»è·ƒåº¦çš„å¹‚ç­‰é”®</span></span><br><span class="line">            <span class="type">Boolean</span> <span class="variable">oldHave</span> <span class="operator">=</span> RedisClient.hDel(userActionKey, field);</span><br><span class="line">            <span class="keyword">if</span> (BooleanUtils.isTrue(oldHave)) &#123;</span><br><span class="line">                <span class="type">Double</span> <span class="variable">newAns</span> <span class="operator">=</span> RedisClient.zIncrBy(todayRankKey, String.valueOf(userId), score);</span><br><span class="line">                RedisClient.zIncrBy(monthRankKey, String.valueOf(userId), score);</span><br><span class="line">                <span class="keyword">if</span> (log.isDebugEnabled()) &#123;</span><br><span class="line">                    log.info(<span class="string">&quot;æ´»è·ƒåº¦æ›´æ–°å‡åˆ†! key#field = &#123;&#125;#&#123;&#125;, add = &#123;&#125;, newScore = &#123;&#125;&quot;</span>, todayRankKey, userId, score, newAns);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="323è§¦å‘æ´»è·ƒåº¦æ›´æ–°"><a class="markdownIt-Anchor" href="#323è§¦å‘æ´»è·ƒåº¦æ›´æ–°"></a> 3.2.3è§¦å‘æ´»è·ƒåº¦æ›´æ–°</h4><p>æˆ‘ä»¬å€ŸåŠ©ç›‘å¬å™¨ï¼Œç›‘å¬ç”¨æˆ·çš„æ“ä½œäº‹ä»¶ï¼Œå¹¶æ›´æ–°å¯¹åº”çš„æ´»è·ƒåº¦</p><p><img src="https://haipeng-lin.oss-cn-shenzhen.aliyuncs.com/202410291111807.png" alt="image-20241029111122341" /></p><ul><li>ç”¨æˆ·è®¿é—®é¡µé¢</li></ul><p><img src="https://haipeng-lin.oss-cn-shenzhen.aliyuncs.com/202410291114090.png" alt="image-20241029111430840" /></p><h3 id="33æŸ¥è¯¢ç”¨æˆ·æ’è¡Œæ¦œ"><a class="markdownIt-Anchor" href="#33æŸ¥è¯¢ç”¨æˆ·æ’è¡Œæ¦œ"></a> 3.3æŸ¥è¯¢ç”¨æˆ·æ’è¡Œæ¦œ</h3><p>åŸºæœ¬æµç¨‹å¦‚ä¸‹ï¼š</p><ul><li>ä»redisä¸­è·å–TopNçš„ç”¨æˆ·+è¯„åˆ†</li><li>æŸ¥è¯¢ç”¨æˆ·ä¿¡æ¯</li><li>æ ¹æ®ç”¨æˆ·è¯„åˆ†è¿›è¡Œæ’åºï¼Œè¿”å›ç»™å‰ç«¯</li></ul><p>æ ¸å¿ƒçš„rediså®ç°</p><ul><li>**åŸç”ŸæŸ¥è¯¢å‘½ä»¤ï¼š**zrange key start end withscoreså‘½ä»¤ï¼ˆä¸‹æ ‡ä»startåˆ°endï¼‰å¦‚ï¼šè·å–å‰äºŒåçš„æ™¯ç‚¹æ’è¡Œæ¦œï¼ˆzrange key -20 -1 withscoresï¼‰è¡¨ç¤ºä»å€’æ•°ç¬¬äºŒåä¸ªå…ƒç´ åˆ°å€’æ•°ç¬¬ä¸€ä¸ªå…ƒç´ </li><li>redisClientå‘½ä»¤ï¼š</li></ul><p><img src="https://haipeng-lin.oss-cn-shenzhen.aliyuncs.com/202410291121105.png" alt="image-20241029112116973" /></p><p><img src="https://haipeng-lin.oss-cn-shenzhen.aliyuncs.com/202410291121193.png" alt="image-20241029112133108" /></p><h2 id="4zsetåº•å±‚æ•°æ®ç»“æ„"><a class="markdownIt-Anchor" href="#4zsetåº•å±‚æ•°æ®ç»“æ„"></a> 4.Zsetåº•å±‚æ•°æ®ç»“æ„</h2><p>åœ¨ Redis ä¸­ï¼Œ<code>ZSET</code>ï¼ˆæœ‰åºé›†åˆï¼‰æ˜¯ä¸€ç§éå¸¸å¼ºå¤§çš„æ•°æ®ç»“æ„ï¼Œå®ƒç»“åˆäº†é›†åˆå’Œæœ‰åºåˆ—è¡¨çš„ç‰¹æ€§ã€‚<code>ZSET</code> çš„åº•å±‚å®ç°ä¸»è¦ä¾èµ–äºä¸€ç§æ•°æ®ç»“æ„ï¼šè·³è·ƒè¡¨ï¼ˆSkip Listï¼‰</p><h3 id="41ä½•ä¸ºè·³è·ƒè¡¨"><a class="markdownIt-Anchor" href="#41ä½•ä¸ºè·³è·ƒè¡¨"></a> 4.1ä½•ä¸ºè·³è·ƒè¡¨</h3><p>è·³è·ƒè¡¨æ˜¯ä¸€ç§æ¦‚ç‡æ€§æ•°æ®ç»“æ„ï¼Œå®ƒå…è®¸åœ¨å¹³å‡ O(log N) æ—¶é—´å¤æ‚åº¦å†…å®ŒæˆæŸ¥æ‰¾ã€æ’å…¥å’Œåˆ é™¤æ“ä½œã€‚è·³è·ƒè¡¨ç”±**å¤šä¸ªå±‚ï¼ˆlevelï¼‰**ç»„æˆï¼Œ<strong>æ¯ä¸€å±‚éƒ½æ˜¯ä¸€ä¸ªæœ‰åºé“¾è¡¨</strong>ï¼Œ<strong>æœ€åº•å±‚ï¼ˆlevel 1ï¼‰åŒ…å«æ‰€æœ‰çš„å…ƒç´ </strong>ï¼Œè€Œä¸Šå±‚çš„é“¾è¡¨æ˜¯ä¸‹å±‚é“¾è¡¨çš„å­é›†ã€‚é€šè¿‡è¿™ç§æ–¹å¼ï¼Œè·³è·ƒè¡¨å¯ä»¥åœ¨ O(log N) æ—¶é—´å†…å®ŒæˆæŸ¥æ‰¾æ“ä½œã€‚</p><p>è·³è·ƒè¡¨çš„ä¸»è¦ä¼˜ç‚¹æ˜¯å®ƒå®ç°ç®€å•ï¼Œå¹¶ä¸”æ’å…¥å’Œåˆ é™¤æ“ä½œçš„æ—¶é—´å¤æ‚åº¦è¾ƒä½ã€‚æ­¤å¤–ï¼Œè·³è·ƒè¡¨è¿˜æ”¯æŒèŒƒå›´æŸ¥è¯¢ï¼Œè¿™åœ¨æŸäº›åº”ç”¨åœºæ™¯ä¸­éå¸¸æœ‰ç”¨ã€‚</p><h3 id="42æ’å…¥æ•°æ®"><a class="markdownIt-Anchor" href="#42æ’å…¥æ•°æ®"></a> 4.2æ’å…¥æ•°æ®</h3><p>å¦‚å›¾ä¸ºredisæ’å…¥æ•°æ®çš„è¿‡ç¨‹ï¼š</p><p><img src="https://haipeng-lin.oss-cn-shenzhen.aliyuncs.com/202410291140208.png" alt="[å¤–é“¾å›¾ç‰‡è½¬å­˜å¤±è´¥,æºç«™å¯èƒ½æœ‰é˜²ç›—é“¾æœºåˆ¶,å»ºè®®å°†å›¾ç‰‡ä¿å­˜ä¸‹æ¥ç›´æ¥ä¸Šä¼ (img-BEsQQOmU-1602665796129)(/img/bVcHoEl)]" /></p><p>ä»ä¸Šé¢skiplistçš„åˆ›å»ºå’Œæ’å…¥è¿‡ç¨‹å¯ä»¥çœ‹å‡ºï¼Œæ¯ä¸€ä¸ªèŠ‚ç‚¹çš„å±‚æ•°ï¼ˆlevelï¼‰æ˜¯éšæœºå‡ºæ¥çš„ï¼Œè€Œä¸”<strong>æ–°æ’å…¥ä¸€ä¸ªèŠ‚ç‚¹ä¸ä¼šå½±å“å…¶å®ƒèŠ‚ç‚¹çš„å±‚æ•°</strong>ã€‚å› æ­¤ï¼Œæ’å…¥æ“ä½œåªéœ€è¦ä¿®æ”¹æ’å…¥èŠ‚ç‚¹å‰åçš„æŒ‡é’ˆï¼Œè€Œä¸éœ€è¦å¯¹å¾ˆå¤šèŠ‚ç‚¹éƒ½è¿›è¡Œè°ƒæ•´ã€‚è¿™å°±é™ä½äº†æ’å…¥æ“ä½œçš„å¤æ‚åº¦ã€‚å®é™…ä¸Šï¼Œè¿™æ˜¯skiplistçš„ä¸€ä¸ªå¾ˆé‡è¦çš„ç‰¹æ€§ï¼Œè¿™è®©å®ƒåœ¨æ’å…¥æ€§èƒ½ä¸Šæ˜æ˜¾ä¼˜äºå¹³è¡¡æ ‘çš„æ–¹æ¡ˆã€‚è¿™åœ¨åé¢æˆ‘ä»¬è¿˜ä¼šæåˆ°ã€‚</p><h3 id="43ä¸ºä»€ä¹ˆé‡‡ç”¨è·³è¡¨ä¸ä½¿ç”¨å“ˆå¸Œæ ‡æˆ–å¹³è¡¡æ ‘å®ç°"><a class="markdownIt-Anchor" href="#43ä¸ºä»€ä¹ˆé‡‡ç”¨è·³è¡¨ä¸ä½¿ç”¨å“ˆå¸Œæ ‡æˆ–å¹³è¡¡æ ‘å®ç°"></a> 4.3ä¸ºä»€ä¹ˆé‡‡ç”¨è·³è¡¨ï¼Œä¸ä½¿ç”¨å“ˆå¸Œæ ‡æˆ–å¹³è¡¡æ ‘å®ç°</h3><ol><li>skiplistå’Œå„ç§å¹³è¡¡æ ‘ï¼ˆå¦‚AVLã€çº¢é»‘æ ‘ç­‰ï¼‰çš„å…ƒç´ æ˜¯æœ‰åºæ’åˆ—çš„ï¼Œè€Œå“ˆå¸Œè¡¨ä¸æ˜¯æœ‰åºçš„ã€‚å› æ­¤ï¼Œåœ¨<strong>å“ˆå¸Œè¡¨ä¸Šåªèƒ½åšå•ä¸ªkeyçš„æŸ¥æ‰¾ï¼Œä¸é€‚å®œåšèŒƒå›´æŸ¥æ‰¾</strong>ã€‚æ‰€è°“èŒƒå›´æŸ¥æ‰¾ï¼ŒæŒ‡çš„æ˜¯æŸ¥æ‰¾é‚£äº›å¤§å°åœ¨æŒ‡å®šçš„ä¸¤ä¸ªå€¼ä¹‹é—´çš„æ‰€æœ‰èŠ‚ç‚¹ã€‚</li><li>åœ¨åšèŒƒå›´æŸ¥æ‰¾çš„æ—¶å€™ï¼Œ<strong>å¹³è¡¡æ ‘æ¯”skiplistæ“ä½œè¦å¤æ‚</strong>ã€‚åœ¨å¹³è¡¡æ ‘ä¸Šï¼Œæˆ‘ä»¬æ‰¾åˆ°æŒ‡å®šèŒƒå›´çš„å°å€¼ä¹‹åï¼Œè¿˜éœ€è¦ä»¥ä¸­åºéå†çš„é¡ºåºç»§ç»­å¯»æ‰¾å…¶å®ƒä¸è¶…è¿‡å¤§å€¼çš„èŠ‚ç‚¹ã€‚å¦‚æœä¸å¯¹å¹³è¡¡æ ‘è¿›è¡Œä¸€å®šçš„æ”¹é€ ï¼Œè¿™é‡Œçš„ä¸­åºéå†å¹¶ä¸å®¹æ˜“å®ç°ã€‚è€Œåœ¨skiplistä¸Šè¿›è¡ŒèŒƒå›´æŸ¥æ‰¾å°±éå¸¸ç®€å•ï¼Œåªéœ€è¦åœ¨æ‰¾åˆ°å°å€¼ä¹‹åï¼Œå¯¹ç¬¬1å±‚é“¾è¡¨è¿›è¡Œè‹¥å¹²æ­¥çš„éå†å°±å¯ä»¥å®ç°ã€‚</li><li>å¹³è¡¡æ ‘çš„æ’å…¥å’Œåˆ é™¤æ“ä½œå¯èƒ½å¼•å‘å­æ ‘çš„è°ƒæ•´ï¼Œé€»è¾‘å¤æ‚ï¼Œè€Œskiplistçš„æ’å…¥å’Œåˆ é™¤åªéœ€è¦ä¿®æ”¹ç›¸é‚»èŠ‚ç‚¹çš„æŒ‡é’ˆï¼Œæ“ä½œç®€å•åˆå¿«é€Ÿã€‚</li></ol>]]></content>
    
    
      
      
    <summary type="html">&lt;link rel=&quot;stylesheet&quot; class=&quot;aplayer-secondary-style-marker&quot; href=&quot;&#92;assets&#92;css&#92;APlayer.min.css&quot;&gt;&lt;script src=&quot;&#92;assets&#92;js&#92;APlayer.min.js&quot; cla</summary>
      
    
    
    
    <category term="ã€çŸ¥è¯†æµã€‘" scheme="https://www.haipeng-lin.cn/categories/%E3%80%90%E7%9F%A5%E8%AF%86%E6%B5%81%E3%80%91/"/>
    
    
  </entry>
  
  <entry>
    <title>åŸºäºå¾®ä¿¡å…¬ä¼—å·+éªŒè¯ç å®ç°å¾®ä¿¡ç™»å½•</title>
    <link href="https://www.haipeng-lin.cn/posts/8239deef.html"/>
    <id>https://www.haipeng-lin.cn/posts/8239deef.html</id>
    <published>2024-10-28T13:05:25.000Z</published>
    <updated>2024-10-28T13:10:41.621Z</updated>
    
    <content type="html"><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="\assets\css\APlayer.min.css"><script src="\assets\js\APlayer.min.js" class="aplayer-secondary-script-marker"></script><h2 id="1å®ç°æ–¹æ¡ˆé€‰æ‹©"><a class="markdownIt-Anchor" href="#1å®ç°æ–¹æ¡ˆé€‰æ‹©"></a> 1.å®ç°æ–¹æ¡ˆé€‰æ‹©</h2><p>â€‹æˆ‘ä»¬åœ¨ç”Ÿæ´»ä¸­ï¼Œéšå¤„å¯è§åŸºäºå¾®ä¿¡æ‰«ç ç™»å½•çš„åœºæ™¯ï¼Œä¾‹å¦‚ä¸€äº›æ‹›è˜ç½‘ç«™ã€ç‰›å®¢ç½‘ã€åŠ›æ‰£ç­‰ç­‰ã€‚ä½†æ˜¯è¿™ç§å¾®ä¿¡æ‰«ç ç™»å½•æ–¹å¼ï¼Œéœ€è¦å¾®ä¿¡å…¬ä¼—å·æ˜¯å¾®ä¿¡è®¤è¯çš„ï¼Œä¸ªäººå…¬ä¼—å·æ²¡æœ‰è¿™ä¸ªæƒé™ã€‚æˆ‘ä»¬ä¾¿é‡‡ç”¨äº†å¦ä¸€ç§æ–¹å¼ï¼šåŸºäºå¾®ä¿¡å…¬ä¼—å·+éªŒè¯ç ç™»å½•</p><h2 id="2å¿…å¤‡çŸ¥è¯†"><a class="markdownIt-Anchor" href="#2å¿…å¤‡çŸ¥è¯†"></a> 2.å¿…å¤‡çŸ¥è¯†</h2><h3 id="21ä½•ä¸ºåŠé•¿è¿æ¥"><a class="markdownIt-Anchor" href="#21ä½•ä¸ºåŠé•¿è¿æ¥"></a> 2.1ä½•ä¸ºåŠé•¿è¿æ¥</h3><p>â€‹åŠé•¿è¿æ¥ï¼Œå¯ä»¥åˆ†æˆä¸¤ä¸ªéƒ¨åˆ†ç†è§£ï¼Œä¸€ä¸ªæ˜¯åŠè¿æ¥ï¼Œä¸€ä¸ªæ˜¯é•¿è¿æ¥ã€‚</p><p>â€‹å…¶ä¸­é•¿è¿æ¥ï¼Œæˆ‘ä»¬ä½¿ç”¨äº†SSEåè®®ï¼ŒæœåŠ¡ç«¯å‘é€äº‹ä»¶ï¼Œå•åŒå·¥é€šä¿¡ï¼Œå³æœåŠ¡ç«¯å¯ä»¥ä¸»åŠ¨å‘å®¢æˆ·ç«¯æ¨é€ä¿¡æ¯ï¼Œä½†æ˜¯å®¢æˆ·ç«¯ä¸å¯ä»¥ä¸»åŠ¨æ¨é€ä¿¡æ¯</p><p>â€‹å…¶ä¸­åŠè¿æ¥ï¼Œç±»ä¼¼äº<strong>TCPåŠè¿æ¥</strong>ï¼ŒTCPåŠè¿æ¥æ˜¯æŒ‡åœ¨TCPä¸‰æ¬¡æ¡æ‰‹è¿‡ç¨‹ä¸­ï¼ŒæœåŠ¡ç«¯å¼€å¯ç¬¬äºŒæ¬¡æ¡æ‰‹æ—¶å€™çš„çŠ¶æ€ï¼ŒåŠè¿æ¥çŠ¶æ€ã€‚æ­¤æ—¶ï¼ŒæœåŠ¡å™¨å·²æ¥æ”¶åˆ°å®¢æˆ·ç«¯çš„è¿æ¥è¯·æ±‚ï¼Œå¹¶å‘é€äº†ç¡®è®¤ï¼Œä½†<strong>ä¸å¯ä»¥ç¡®è®¤æœåŠ¡ç«¯å‘é€çš„æ¶ˆæ¯æ˜¯å¦èƒ½åˆ°è¾¾å®¢æˆ·ç«¯</strong>ï¼Œéœ€è¦ç­‰å¾…å®¢æˆ·ç«¯å‘å›ç¡®è®¤åŒ…ï¼Œæ‰å¯ä»¥å»ºç«‹å¯é çš„è¿æ¥ï¼Œæ‰€ä»¥æ­¤æ—¶ç§°ä¸ºåŠè¿æ¥çŠ¶æ€ã€‚</p><p>â€ƒâ€ƒè€Œä¸è¿™ä¸ªè¡Œä¸ºç±»ä¼¼çš„ï¼Œåœ¨ç”¨æˆ·ç‚¹å‡»ç™»å½•æŒ‰é’®åï¼Œè§†ä¸ºå‘å‡ºç™»å½•è¯·æ±‚ï¼Œè§†ä½œç¬¬ä¸€æ¬¡æ¡æ‰‹ï¼Œæ­¤æ—¶<strong>æœåŠ¡ç«¯æ ¹æ®è®¾å¤‡idæä¾›éªŒè¯ç ï¼Œè§†ä½œç¬¬äºŒæ¬¡æ¡æ‰‹</strong>ï¼Œè€Œå°†éªŒè¯ç å’ŒSSEåè®®å…±åŒç»´æŠ¤åœ¨cacheä¸­ï¼Œç­‰åŒ<strong>å°†socketç»´æŠ¤åœ¨åŠè¿æ¥é˜Ÿåˆ—ä¸­</strong>ï¼Œæœ€åç”¨æˆ·åœ¨å¾®ä¿¡ç«¯è¾“å…¥éªŒè¯ç ï¼Œåˆ™æ˜¯ç¬¬ä¸‰æ¬¡æ¡æ‰‹äº†ï¼Œä¸»è¦æ˜¯ åº”ç”¨å±‚è¿æ¥è¿™ä¸ªæ¦‚å¿µå’Œä¼ è¾“å±‚è¿æ¥æ¦‚å¿µçš„ç›¸ä¼¼æ€§</p><h3 id="22ç™»å½•æµç¨‹"><a class="markdownIt-Anchor" href="#22ç™»å½•æµç¨‹"></a> 2.2ç™»å½•æµç¨‹</h3><p>â€‹å¦‚å›¾ï¼Œä¸ºçŸ¥è¯†æµå¹³å°çš„åŸºäºå¾®ä¿¡å…¬ä¼—å·+éªŒè¯ç çš„å¾®ä¿¡ç™»å½•æµç¨‹</p><img src="https://gitee.com/linhaipengg/md_-picture/raw/master/çŸ¥è¯†æµâ€”â€”åŸºäºå¾®ä¿¡å…¬ä¼—å·+éªŒè¯ç å®ç°ç™»å½•.drawio.png" alt="çŸ¥è¯†æµâ€”â€”åŸºäºå¾®ä¿¡å…¬ä¼—å·+éªŒè¯ç å®ç°ç™»å½•.drawio" style="zoom: 30%;" /><h2 id="3é¡¹ç›®å®æˆ˜"><a class="markdownIt-Anchor" href="#3é¡¹ç›®å®æˆ˜"></a> 3.é¡¹ç›®å®æˆ˜</h2><h3 id="31å¾®ä¿¡å…¬ä¼—å·è®¾ç½®"><a class="markdownIt-Anchor" href="#31å¾®ä¿¡å…¬ä¼—å·è®¾ç½®"></a> 3.1å¾®ä¿¡å…¬ä¼—å·è®¾ç½®</h3><p>â€‹è¦é…ç½®çš„å†…å®¹ä¸»è¦æœ‰ä¸‰é¡¹ï¼šæœåŠ¡å™¨åœ°å€ã€ä»¤ç‰Œã€æ¶ˆæ¯åŠ è§£å¯†å¯†é’¥ï¼ŒæœåŠ¡å™¨åœ°å€å¡«æœåŠ¡ç«¯ç»‘å®šå…¬ä¼—å·çš„å›è°ƒæ¥å£ï¼Œä»¤ç‰Œç”¨äºè®¤è¯è¯·æ±‚æ˜¯å¦åˆæ³•ï¼ˆå¯éšä¾¿é…ç½®ï¼Œçœ‹æœåŠ¡ç«¯æ˜¯å¦æœ‰è¦æ±‚ï¼‰</p><p><img src="https://haipeng-lin.oss-cn-shenzhen.aliyuncs.com/202410282110525.png" alt="image-20241028192947512" /></p><h3 id="32æœåŠ¡ç«¯é…ç½®"><a class="markdownIt-Anchor" href="#32æœåŠ¡ç«¯é…ç½®"></a> 3.2æœåŠ¡ç«¯é…ç½®</h3><h4 id="321æœåŠ¡ç«¯tokenéªŒè¯-æ¶ˆæ¯å›è°ƒ"><a class="markdownIt-Anchor" href="#321æœåŠ¡ç«¯tokenéªŒè¯-æ¶ˆæ¯å›è°ƒ"></a> 3.2.1æœåŠ¡ç«¯tokenéªŒè¯ã€æ¶ˆæ¯å›è°ƒ</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RequestMapping(path = &quot;wx&quot;)</span></span><br><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">WxCallbackRestController</span> &#123;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment"> * å¾®ä¿¡çš„å…¬ä¼—å·æ¥å…¥ token éªŒè¯ï¼Œå³è¿”å›echostrçš„å‚æ•°å€¼</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment">* <span class="doctag">@param</span> request</span></span><br><span class="line"><span class="comment">* <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line">    <span class="meta">@GetMapping(path = &quot;callback&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">check</span><span class="params">(HttpServletRequest request)</span> &#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">echoStr</span> <span class="operator">=</span> request.getParameter(<span class="string">&quot;echostr&quot;</span>);</span><br><span class="line">        <span class="keyword">if</span> (StringUtils.isNoneEmpty(echoStr)) &#123;</span><br><span class="line">            <span class="keyword">return</span> echoStr;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * fixme: éœ€è¦åšé˜²åˆ·æ ¡éªŒ</span></span><br><span class="line"><span class="comment">     * å¾®ä¿¡çš„å“åº”è¿”å›</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> msg</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@PostMapping(path = &quot;callback&quot;,</span></span><br><span class="line"><span class="meta">            consumes = &#123;&quot;application/xml&quot;, &quot;text/xml&quot;&#125;,</span></span><br><span class="line"><span class="meta">            produces = &quot;application/xml;charset=utf-8&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> BaseWxMsgResVo <span class="title function_">callBack</span><span class="params">(<span class="meta">@RequestBody</span> WxTxtMsgReqVo msg)</span> &#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">content</span> <span class="operator">=</span> msg.getContent();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (<span class="string">&quot;subscribe&quot;</span>.equals(msg.getEvent()) || <span class="string">&quot;scan&quot;</span>.equalsIgnoreCase(msg.getEvent())) &#123;</span><br><span class="line">            <span class="type">String</span> <span class="variable">key</span> <span class="operator">=</span> msg.getEventKey();</span><br><span class="line">            <span class="keyword">if</span> (StringUtils.isNotBlank(key) || key.startsWith(<span class="string">&quot;qrscene_&quot;</span>)) &#123;</span><br><span class="line">                <span class="comment">// å¸¦å‚æ•°çš„äºŒç»´ç ï¼Œæ‰«æã€å…³æ³¨äº‹ä»¶æ‹¿åˆ°ä¹‹åï¼Œç›´æ¥ç™»å½•ï¼Œçœå´è¾“å…¥éªŒè¯ç è¿™ä¸€æ­¥</span></span><br><span class="line">                <span class="comment">// fixme å¸¦å‚æ•°äºŒç»´ç éœ€è¦ å¾®ä¿¡è®¤è¯ï¼Œä¸ªäººå…¬ä¼—å·æ— æƒé™</span></span><br><span class="line">                <span class="type">String</span> <span class="variable">code</span> <span class="operator">=</span> key.substring(<span class="string">&quot;qrscene_&quot;</span>.length());</span><br><span class="line">                sessionService.autoRegisterWxUserInfo(msg.getFromUserName());</span><br><span class="line">                qrLoginHelper.login(code);</span><br><span class="line">                <span class="type">WxTxtMsgResVo</span> <span class="variable">res</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">WxTxtMsgResVo</span>();</span><br><span class="line">                res.setContent(<span class="string">&quot;ç™»å½•æˆåŠŸ&quot;</span>);</span><br><span class="line">                fillResVo(res, msg);</span><br><span class="line">                <span class="keyword">return</span> res;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="type">BaseWxMsgResVo</span> <span class="variable">res</span> <span class="operator">=</span> wxHelper.buildResponseBody(msg.getEvent(), content, msg.getFromUserName());</span><br><span class="line">        fillResVo(res, msg);</span><br><span class="line">        <span class="keyword">return</span> res;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="322å»ºç«‹åŠé•¿è¿æ¥"><a class="markdownIt-Anchor" href="#322å»ºç«‹åŠé•¿è¿æ¥"></a> 3.2.2å»ºç«‹åŠé•¿è¿æ¥</h4><p>â€‹å½“ç”¨æˆ·ç‚¹å‡»ç™»å½•ï¼Œå‰å°ä¼šå±•ç¤ºä¸€ä¸ªå…¬ä¼—å·äºŒç»´ç å›¾ç‰‡å’ŒéªŒè¯ç ï¼Œæ­¤æ—¶æœåŠ¡ç«¯å·²ç»å»ºç«‹äº†è¯¥éªŒè¯ç å’ŒåŠé•¿è¿æ¥ä¹‹é—´çš„æ˜ å°„ï¼Œè¿™æ—¶æœåŠ¡ç«¯ä¼šç­‰å¾…ç”¨æˆ·åˆ°å…¬ä¼—å·å¹³å°å‘é€éªŒè¯ç </p><ul><li>åç«¯è®¾è®¡ï¼š<ul><li>verifyCodeCacheï¼šç¼“å­˜ <strong>éªŒè¯ç </strong> å’Œ <strong>åŠé•¿è¿æ¥</strong> çš„æ˜ å°„</li><li>deviceCodeCacheï¼šç¼“å­˜ <strong>è®¾å¤‡ID</strong> å’Œ <strong>éªŒè¯ç </strong> çš„æ˜ å°„ï¼Œç¡®ä¿åŒä¸€å°è®¾å¤‡å¤šæ¬¡è®¿é—®å‰å°ç™»å½•é¡µé¢ï¼Œå±•ç¤ºçš„éªŒè¯ç åªæœ‰ä¸€ä¸ªï¼Œç”¨æˆ·åˆ·æ–°éªŒè¯ç åŠ¨ä½œé™¤å¤–</li></ul></li></ul><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">* key = éªŒè¯ç , value = åŠé•¿è¿æ¥</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="keyword">private</span> LoadingCache&lt;String, SseEmitter&gt; verifyCodeCache;</span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">* key = è®¾å¤‡ID value = éªŒè¯ç </span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="keyword">private</span> LoadingCache&lt;String, String&gt; deviceCodeCache;</span><br></pre></td></tr></table></figure><ul><li>ç”¨æˆ·æ¯æ¬¡è®¿é—®å‰å°å±•ç¤ºéªŒè¯ç é¡µé¢ï¼Œéƒ½ä¼š<strong>é‡æ–°ç”ŸæˆéªŒè¯ç å’ŒåŠé•¿è¿æ¥çš„æ˜ å°„</strong></li></ul><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * å»ºç«‹éªŒè¯ç ä¸åŠé•¿è¿æ¥çš„æ˜ å°„ï¼ŒåŸºäºè®¾å¤‡IDå’ŒéªŒè¯ç çš„æ˜ å°„è·å–éªŒè¯ç </span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment"> * <span class="doctag">@throws</span> IOException</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> SseEmitter <span class="title function_">subscribe</span><span class="params">()</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">    <span class="type">String</span> <span class="variable">deviceId</span> <span class="operator">=</span> ReqInfoContext.getReqInfo().getDeviceId();</span><br><span class="line">    <span class="comment">// åŸºäºè®¾å¤‡è·å–éªŒè¯ç </span></span><br><span class="line">    <span class="type">String</span> <span class="variable">realCode</span> <span class="operator">=</span> deviceCodeCache.getUnchecked(deviceId) ;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// fixme è®¾ç½®15minçš„è¶…æ—¶æ—¶é—´, è¶…æ—¶æ—¶é—´ä¸€æ—¦è®¾ç½®ä¸èƒ½ä¿®æ”¹ï¼›å› æ­¤å¯¼è‡´åˆ·æ–°éªŒè¯ç å¹¶ä¸ä¼šå¢åŠ è¿æ¥çš„æœ‰æ•ˆæœŸ</span></span><br><span class="line">    <span class="type">SseEmitter</span> <span class="variable">sseEmitter</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">SseEmitter</span>(SSE_EXPIRE_TIME);</span><br><span class="line">    <span class="type">SseEmitter</span> <span class="variable">oldSse</span> <span class="operator">=</span> verifyCodeCache.getIfPresent(realCode);</span><br><span class="line">    <span class="keyword">if</span> (oldSse != <span class="literal">null</span>) &#123;</span><br><span class="line">        oldSse.complete();</span><br><span class="line">    &#125;</span><br><span class="line">    verifyCodeCache.put(realCode, sseEmitter);</span><br><span class="line">    sseEmitter.onTimeout(() -&gt; &#123;</span><br><span class="line">        log.info(<span class="string">&quot;sse è¶…æ—¶ä¸­æ–­ --&gt; &#123;&#125;&quot;</span>, realCode);</span><br><span class="line">        verifyCodeCache.invalidate(realCode);</span><br><span class="line">        sseEmitter.complete();</span><br><span class="line">    &#125;);</span><br><span class="line">    sseEmitter.onError((e) -&gt; &#123;</span><br><span class="line">        log.warn(<span class="string">&quot;sse error! --&gt; &#123;&#125;&quot;</span>, realCode, e);</span><br><span class="line">        verifyCodeCache.invalidate(realCode);</span><br><span class="line">        sseEmitter.complete();</span><br><span class="line">    &#125;);</span><br><span class="line">    <span class="comment">// è‹¥å®é™…çš„éªŒè¯ç ä¸å‰ç«¯æ˜¾ç¤ºçš„ä¸åŒï¼Œåˆ™é€šçŸ¥å‰ç«¯æ›´æ–°</span></span><br><span class="line">    sseEmitter.send(<span class="string">&quot;initCode!&quot;</span>);</span><br><span class="line">    sseEmitter.send(<span class="string">&quot;init#&quot;</span> + realCode);</span><br><span class="line">    <span class="keyword">return</span> sseEmitter;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="323å…¬ä¼—å·æ¶ˆæ¯å›è°ƒ"><a class="markdownIt-Anchor" href="#323å…¬ä¼—å·æ¶ˆæ¯å›è°ƒ"></a> 3.2.3å…¬ä¼—å·æ¶ˆæ¯å›è°ƒ</h4><p>â€‹å½“ç”¨æˆ·æ‰«ç å…³æ³¨å…¬ä¼—å·å¹¶è¾“å…¥éªŒè¯ç åï¼Œå…¬ä¼—å·ä¼šå‘èµ·å›è°ƒï¼Œç³»ç»Ÿæ ¹æ®éªŒè¯ç æ‰¾åˆ°è¯¥åŠé•¿è¿æ¥ï¼Œæ‰¾åˆ°è¯¥è®¾å¤‡ï¼Œå¹¶è¯†åˆ«å¾®ä¿¡å·æ‰¾åˆ°ç”¨æˆ·ï¼Œè¿™æ—¶æœåŠ¡ç«¯å‘å®¢æˆ·ç«¯æ¨é€ç™»å½•æˆåŠŸæ¶ˆæ¯ï¼Œå®ç°ç™»å½•</p><img src="https://haipeng-lin.oss-cn-shenzhen.aliyuncs.com/202410282002366.png" alt="image-20241028195945260" style="zoom:67%;" /><ul><li>è¾“å…¥çš„å†…å®¹ä¸ºéªŒè¯ç </li></ul><p><img src="https://haipeng-lin.oss-cn-shenzhen.aliyuncs.com/202410282004493.png" alt="image-20241028200245042" /></p><ul><li>å¾®ä¿¡å…¬ä¼—å·ç™»å½•</li></ul><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * å¾®ä¿¡å…¬ä¼—å·ç™»å½•</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> verifyCode ç”¨æˆ·è¾“å…¥çš„ç™»å½•éªŒè¯ç </span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">login</span><span class="params">(String verifyCode)</span> &#123;</span><br><span class="line">    <span class="comment">// é€šè¿‡éªŒè¯ç æ‰¾åˆ°å¯¹åº”çš„é•¿è¿æ¥</span></span><br><span class="line">    <span class="type">SseEmitter</span> <span class="variable">sseEmitter</span> <span class="operator">=</span> verifyCodeCache.getIfPresent(verifyCode);</span><br><span class="line">    <span class="keyword">if</span> (sseEmitter == <span class="literal">null</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="type">String</span> <span class="variable">session</span> <span class="operator">=</span> sessionService.loginByWx(ReqInfoContext.getReqInfo().getUserId());</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="comment">// ç™»å½•æˆåŠŸï¼Œå†™å…¥session</span></span><br><span class="line">        sseEmitter.send(session);</span><br><span class="line">        <span class="comment">// è®¾ç½®cookieçš„è·¯å¾„</span></span><br><span class="line">        sseEmitter.send(<span class="string">&quot;login#&quot;</span> + LoginService.SESSION_KEY + <span class="string">&quot;=&quot;</span> + session + <span class="string">&quot;;path=/;&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">    &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">        log.error(<span class="string">&quot;ç™»å½•å¼‚å¸¸: &#123;&#125;&quot;</span>, verifyCode, e);</span><br><span class="line">    &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">        sseEmitter.complete();</span><br><span class="line">        verifyCodeCache.invalidate(verifyCode);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="33æµ‹è¯•"><a class="markdownIt-Anchor" href="#33æµ‹è¯•"></a> 3.3æµ‹è¯•</h3><ul><li>å‰å°é¡µé¢</li></ul><p><img src="https://haipeng-lin.oss-cn-shenzhen.aliyuncs.com/202410282037716.png" alt="image-20241028203719799" /></p><ul><li>å…¬ä¼—å·å¹³å°</li></ul><p><img src="https://haipeng-lin.oss-cn-shenzhen.aliyuncs.com/202410282039965.png" alt="image-20241028203947882" /></p><h2 id="4æ€»ç»“"><a class="markdownIt-Anchor" href="#4æ€»ç»“"></a> 4.æ€»ç»“</h2><p>â€‹æˆ‘ä»¬åœ¨æœ¬ç¯‡ä¸­ï¼Œå®ç°äº†åŸºäºå¾®ä¿¡å…¬ä¼—å·å’ŒéªŒè¯ç çš„ç™»å½•æ–¹å¼ï¼Œä½¿ç”¨äº†SSEä½œä¸ºéªŒè¯ç å’Œå‰ç«¯ä¿æŒè¿æ¥çš„æ–¹å¼ï¼ŒåŒæ—¶å­¦ä¹ äº†åŠè¿æ¥ã€é•¿è¿æ¥ã€åŠé•¿è¿æ¥çš„å®šä¹‰ã€åŒºåˆ«ã€ä»¥åŠè”ç³»</p>]]></content>
    
    
      
      
    <summary type="html">&lt;link rel=&quot;stylesheet&quot; class=&quot;aplayer-secondary-style-marker&quot; href=&quot;&#92;assets&#92;css&#92;APlayer.min.css&quot;&gt;&lt;script src=&quot;&#92;assets&#92;js&#92;APlayer.min.js&quot; cla</summary>
      
    
    
    
    <category term="ã€çŸ¥è¯†æµã€‘" scheme="https://www.haipeng-lin.cn/categories/%E3%80%90%E7%9F%A5%E8%AF%86%E6%B5%81%E3%80%91/"/>
    
    
  </entry>
  
  <entry>
    <title>ElasticSearchå­¦ä¹ ç¬”è®°</title>
    <link href="https://www.haipeng-lin.cn/posts/172c1a2d.html"/>
    <id>https://www.haipeng-lin.cn/posts/172c1a2d.html</id>
    <published>2024-10-16T03:36:17.000Z</published>
    <updated>2024-10-16T03:39:14.951Z</updated>
    
    <content type="html"><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="\assets\css\APlayer.min.css"><script src="\assets\js\APlayer.min.js" class="aplayer-secondary-script-marker"></script><h1 id="1elasticsearchæ˜¯ä»€ä¹ˆ"><a class="markdownIt-Anchor" href="#1elasticsearchæ˜¯ä»€ä¹ˆ"></a> 1.ElasticSearchæ˜¯ä»€ä¹ˆ</h1><h2 id="11elasticsearchç®€ä»‹"><a class="markdownIt-Anchor" href="#11elasticsearchç®€ä»‹"></a> 1.1ElasticSearchç®€ä»‹</h2><p>â€ƒâ€ƒElasticsearch æ˜¯ä¸€ä¸ªåˆ†å¸ƒå¼ã€RESTful é£æ ¼çš„æœç´¢å’Œæ•°æ®åˆ†æå¼•æ“</p><ol><li><p><strong>ElasticSearchç‰¹ç‚¹ï¼š</strong></p><ol><li>åˆ†å¸ƒå¼çš„æ–‡ä»¶å­˜å‚¨ï¼Œ<strong>æ¯ä¸ªå­—æ®µéƒ½è¢«ç´¢å¼•</strong>ä¸”å¯ç”¨äºæœç´¢ã€‚</li><li><strong>åˆ†å¸ƒå¼</strong>çš„å®æ—¶åˆ†ææœç´¢å¼•æ“ï¼Œ<strong>æµ·é‡æ•°æ®</strong>ä¸‹è¿‘å®æ—¶ç§’çº§å“åº”ã€‚</li><li>ç®€å•çš„<strong>restful api</strong>ï¼Œå¤©ç”Ÿçš„å…¼å®¹å¤šè¯­è¨€å¼€å‘ã€‚</li><li><strong>æ˜“æ‰©å±•</strong>ï¼Œå¤„ç†PBçº§ç»“æ„åŒ–æˆ–éç»“æ„åŒ–æ•°æ®</li></ol></li><li><p><strong>ElasticSearchç¼ºç‚¹ï¼š</strong></p><ol><li>ç”±äº Elasticsearch éœ€è¦å¤„ç†å¤§é‡çš„æ•°æ®ï¼Œå› æ­¤éœ€è¦<strong>è¾ƒé«˜çš„ç¡¬ä»¶æ€§èƒ½</strong>å’Œå­˜å‚¨ç©ºé—´ã€‚</li><li>ç”±äº Elasticsearch æ˜¯ä¸€ä¸ªåˆ†å¸ƒå¼ç³»ç»Ÿï¼Œå¯èƒ½å­˜åœ¨<strong>æ•°æ®ä¸€è‡´æ€§</strong>é—®é¢˜</li></ol></li><li><p><strong>é€‚ç”¨åœºæ™¯ï¼š</strong></p><ol><li>æ—¥å¿—åˆ†æï¼šElasticsearch å¯ä»¥å¿«é€Ÿåœ°æœç´¢å’Œåˆ†æå¤§é‡çš„æ—¥å¿—æ•°æ®ã€‚</li><li>æœç´¢å¼•æ“ï¼šElasticsearch å¯ä»¥ä½œä¸ºæœç´¢å¼•æ“ç”¨äºæœç´¢å’Œæ’åºæ•°æ®ã€‚</li><li>æ•°æ®åˆ†æï¼šElasticsearch å¯ä»¥ç”¨äºæ•°æ®åˆ†æï¼Œæ”¯æŒèšåˆå’Œåˆ†ææ•°æ®ã€‚</li><li>åœ°ç†ä½ç½®æœç´¢ï¼šElasticsearch æ”¯æŒåœ°ç†ä½ç½®æœç´¢ï¼Œå¯ä»¥ç”¨äºåœ°å›¾åº”ç”¨ç­‰ã€‚</li></ol></li></ol><h2 id="12esä¸solrå¯¹æ¯”"><a class="markdownIt-Anchor" href="#12esä¸solrå¯¹æ¯”"></a> 1.2ESä¸Solrå¯¹æ¯”</h2><ol><li>Solræ˜¯Apache Luceneé¡¹ç›®çš„å¼€æº<strong>ä¼ä¸šæœç´¢å¹³å°</strong>ã€‚å…¶ä¸»è¦åŠŸèƒ½åŒ…æ‹¬<strong>å…¨æ–‡æ£€ç´¢</strong>ã€å‘½ä¸­æ ‡ç¤ºã€åˆ†é¢æœç´¢ã€åŠ¨æ€èšç±»ã€æ•°æ®åº“é›†æˆï¼Œä»¥åŠå¯Œæ–‡æœ¬ï¼ˆå¦‚Wordã€PDFï¼‰çš„å¤„ç†ï¼›Solræ˜¯é«˜åº¦å¯æ‰©å±•çš„ï¼Œå¹¶æä¾›äº†åˆ†å¸ƒå¼æœç´¢å’Œç´¢å¼•å¤åˆ¶åŠŸèƒ½</li><li>å½“å•çº¯çš„å¯¹<strong>å·²æœ‰æ•°æ®</strong>è¿›è¡Œæœç´¢æ—¶ï¼ŒSolræ›´å¿«ï¼›å½“å®æ—¶å»ºç«‹ç´¢å¼•æ—¶ï¼ŒSolrä¼šäº§ç”Ÿioé˜»å¡ï¼ŒæŸ¥è¯¢æ€§èƒ½è¾ƒå·®</li><li>éšç€<strong>æ•°æ®é‡çš„å¢åŠ </strong>ï¼ŒSolrçš„æœç´¢æ•ˆç‡ä¼šå˜å¾—æ›´<strong>ä½</strong>ï¼Œè€ŒElasticsearchå´æ²¡æœ‰æ˜æ˜¾çš„å˜åŒ–ã€‚</li></ol><h2 id="13esä¸mysqlå¯¹æ¯”"><a class="markdownIt-Anchor" href="#13esä¸mysqlå¯¹æ¯”"></a> 1.3ESä¸MySQLå¯¹æ¯”</h2><ol><li>ç»“è®ºï¼šElasticSearchæ¯”MySQLæŸ¥è¯¢å¿«ï¼ŒåŸå› å¦‚ä¸‹ï¼š</li><li><strong>åŸºäºåˆ†è¯åçš„å…¨æ–‡æ£€ç´¢ï¼š</strong><ol><li>ä¾‹å¦‚select * from test where name like â€˜%å¼ ä¸‰%â€™ï¼Œå¯¹äºmysqlæ¥è¯´ï¼Œå› ä¸ºç´¢å¼•å¤±æ•ˆï¼Œä¼šè¿›è¡Œå…¨è¡¨æ£€ç´¢ï¼›</li><li>å¯¹esè€Œè¨€åˆ†è¯åï¼Œæ¯ä¸ªå­—éƒ½å¯ä»¥åˆ©ç”¨FSTé«˜é€Ÿæ‰¾åˆ°å€’æ’ç´¢å¼•çš„ä½ç½®ï¼Œå¹¶è¿…é€Ÿè·å–æ–‡æ¡£idåˆ—è¡¨ï¼Œå¤§å¤§çš„æå‡äº†æ€§èƒ½ï¼Œå‡å°‘äº†ç£ç›˜IO</li></ol></li><li><strong>ç²¾ç¡®æ£€ç´¢ï¼š</strong><ol><li>è¿›è¡Œç²¾ç¡®æ£€ç´¢ï¼Œæœ‰äº›æ—¶å€™å¯èƒ½mysqlè¦å¿«ä¸€äº›ï¼Œå½“mysqlçš„éèšåˆç´¢å¼•å¼•ç”¨ä¸Šäº†èšåˆç´¢å¼•ï¼Œæ— éœ€å›è¡¨ï¼Œåˆ™é€Ÿåº¦ä¸Šå¯èƒ½æ›´å¿«ï¼›</li><li>esè¿˜æ˜¯é€šè¿‡FSTæ‰¾åˆ°å€’æ’ç´¢å¼•çš„ä½ç½®æ¯”è·å–æ–‡æ¡£idåˆ—è¡¨ï¼Œå†æ ¹æ®æ–‡æ¡£idè·å–æ–‡æ¡£å¹¶æ ¹æ®ç›¸å…³åº¦è¿›è¡Œæ’åº</li><li>ä½†æ˜¯esè¿˜æœ‰ä¸ªä¼˜åŠ¿ï¼Œå°±æ˜¯eså³å¤©ç„¶çš„åˆ†å¸ƒå¼èƒ½å¤Ÿåœ¨å¤§é‡æ•°æ®æœç´¢æ—¶å¯ä»¥é€šè¿‡åˆ†ç‰‡é™ä½æ£€ç´¢è§„æ¨¡ï¼Œå¹¶ä¸”å¯ä»¥é€šè¿‡å¹¶è¡Œæ£€ç´¢æå‡æ•ˆç‡ï¼Œç”¨filteræ—¶ï¼Œæ›´æ˜¯å¯ä»¥ç›´æ¥è·³è¿‡æ£€ç´¢ç›´æ¥èµ°ç¼“å­˜</li></ol></li></ol><h2 id="14esåŸºæœ¬æ¦‚å¿µ"><a class="markdownIt-Anchor" href="#14esåŸºæœ¬æ¦‚å¿µ"></a> 1.4ESåŸºæœ¬æ¦‚å¿µ</h2><p><img src="https://haipeng-lin.oss-cn-shenzhen.aliyuncs.com/202410161110837.jpeg" alt="img" /></p><h3 id="141index-ç´¢å¼•"><a class="markdownIt-Anchor" href="#141index-ç´¢å¼•"></a> 1.4.1Index-ç´¢å¼•</h3><p>Indexï¼Œå³ç´¢å¼•ï¼Œå…³é”®è¯æœ‰ä¸¤ç§ç”¨æ³•ï¼Œå¯ç”¨ä½œåŠ¨è¯ã€æˆ–è€…åè¯</p><ol><li>åŠ¨è¯,ç›¸å½“äºMySQLä¸­çš„insertã€æ’å…¥</li><li>åè¯,ç›¸å½“äºMySQLä¸­çš„Databaseã€æ•°æ®åº“</li></ol><h3 id="142type-ç±»å‹"><a class="markdownIt-Anchor" href="#142type-ç±»å‹"></a> 1.4.2Type-ç±»å‹</h3><ol><li>åœ¨Indexï¼ˆç´¢å¼•ï¼‰ä¸­,å¯ä»¥å®šä¹‰ä¸€ä¸ªæˆ–å¤šä¸ªç±»å‹,æ¯ç§ç±»å‹çš„æ•°æ®æ”¾ä¸€èµ·ï¼›ç±»ä¼¼äºMySQLä¸­æ•°æ®åº“ä¸­å¯ä»¥å®šä¹‰ä¸€ä¸ªæˆ–å¤šä¸ªè¡¨ï¼ˆTableï¼‰;</li><li>ES7ã€8ç‰ˆæœ¬å·®å¼‚ï¼š<ol><li>Elasticsearch 7. X URLä¸­<strong>çš„typeå‚æ•°ä¸ºå¯é€‰</strong>ã€‚æ¯”å¦‚ï¼Œç´¢å¼•ä¸€ä¸ªæ–‡æ¡£ä¸å†è¦æ±‚æä¾›æ–‡æ¡£ç±»å‹ã€‚</li><li>Elasticsearch 8.X ä¸å†æ”¯æŒURLä¸­çš„typeå‚æ•°ã€‚ElasticSearch8å¼€å§‹ï¼Œå°†ç´¢å¼•ä»å¤šç±»å‹è¿ç§»åˆ°å•ç±»å‹ï¼Œæ¯ç§ç±»å‹æ–‡æ¡£ä¸€ä¸ªç‹¬ç«‹ç´¢å¼•</li><li><strong>åŸå› ï¼š<strong>Elasticsearchæ˜¯åŸºäºLuceneå¼€å‘çš„æœç´¢å¼•æ“ï¼Œè€Œ</strong><mark>ESä¸­ä¸åŒtypeä¸‹åç§°ç›¸åŒçš„filedæœ€ç»ˆåœ¨Luceneä¸­çš„å¤„ç†æ–¹å¼æ˜¯ä¸€æ ·çš„</mark></strong>ã€‚ä¸åŒtypeä¸­çš„ç›¸åŒå­—æ®µåç§°å°±ä¼šåœ¨å¤„ç†ä¸­å‡ºç°å†²çªçš„æƒ…å†µï¼Œ<strong>å¯¼è‡´Luceneå¤„ç†æ•ˆç‡ä¸‹é™</strong>ï¼Œå»æ‰typeå°±æ˜¯ä¸ºäº†æé«˜ESå¤„ç†æ•°æ®çš„æ•ˆç‡ã€‚</li></ol></li></ol><h3 id="143document-æ–‡æ¡£"><a class="markdownIt-Anchor" href="#143document-æ–‡æ¡£"></a> 1.4.3Document-æ–‡æ¡£</h3><ol><li>ä¿å­˜åˆ°æŸä¸ªç´¢å¼•(Index)ä¸‹,æŸç§ç±»å‹(Type)çš„ä¸€ä¸ªæ•°æ®(Document)ï¼Œæ–‡æ¡£æ˜¯JSONæ ¼å¼çš„</li><li>ä¸€ä¸ªDocumentå°±åƒæ˜¯MySQLä¸­æŸä¸ªè¡¨çš„ä¸€æ¡è®°å½•.</li></ol><h3 id="144å€’æ’ç´¢å¼•"><a class="markdownIt-Anchor" href="#144å€’æ’ç´¢å¼•"></a> 1.4.4å€’æ’ç´¢å¼•</h3><p>ç”±äºä¸æ˜¯ç”±è®°å½•æ¥ç¡®å®šå±æ€§å€¼ï¼Œè€Œæ˜¯ç”±å±æ€§å€¼æ¥ç¡®å®šè®°å½•çš„ä½ç½®ï¼Œå› è€Œç§°ä¸ºå€’æ’ç´¢å¼•(inverted index)</p><ul><li>ç´¢å¼•å­˜å‚¨ç¤ºä¾‹</li></ul><p>å°†æ•´å¥æ‹†åˆ†ä¸ºå•è¯,å°†å•è¯çš„å€¼ä¸ç´¢å¼•å­˜å‚¨èµ·æ¥,å°±å¯ä»¥æ ¹æ®å•è¯æŸ¥è¯¢ç´¢å¼•ä½ç½®,ç„¶åæ ¹æ®æ£€ç´¢æ¡ä»¶çš„ç›¸å…³æ€§å¾—åˆ†è¿›è¡Œæ’åº</p><p><img src="https://gitee.com/linhaipengg/md_-picture/raw/master/image-20231125161941142.png" alt="image-20231125161941142" /></p><h1 id="2å®‰è£…elasticsearch"><a class="markdownIt-Anchor" href="#2å®‰è£…elasticsearch"></a> 2.å®‰è£…ElasticSearch</h1><h2 id="21åŸºäºdockerå®‰è£…esä¸kibana"><a class="markdownIt-Anchor" href="#21åŸºäºdockerå®‰è£…esä¸kibana"></a> 2.1åŸºäºDockerå®‰è£…ESä¸Kibana</h2><h3 id="211ä¸‹è½½é•œåƒæ–‡ä»¶"><a class="markdownIt-Anchor" href="#211ä¸‹è½½é•œåƒæ–‡ä»¶"></a> 2.1.1ä¸‹è½½é•œåƒæ–‡ä»¶</h3><p>elasticsearchä¸kibanaç‰ˆæœ¬æ˜¯åŒæ­¥çš„</p><figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">docker</span> <span class="string">pull</span> <span class="string">elasticsearch:7.4.2</span> <span class="comment">#å­˜å‚¨å’Œæ£€ç´¢æ•°æ®</span></span><br><span class="line"><span class="string">docker</span> <span class="string">pull</span> <span class="string">kibana:7.4.2</span> <span class="comment">#å¯è§†åŒ–æ£€ç´¢æ•°æ®</span></span><br></pre></td></tr></table></figure><h3 id="212åˆ›å»ºå®ä¾‹"><a class="markdownIt-Anchor" href="#212åˆ›å»ºå®ä¾‹"></a> 2.1.2åˆ›å»ºå®ä¾‹</h3><h4 id="1åˆ›å»ºelasticsearchå®ä¾‹"><a class="markdownIt-Anchor" href="#1åˆ›å»ºelasticsearchå®ä¾‹"></a> ï¼ˆ1ï¼‰åˆ›å»ºElasticSearchå®ä¾‹</h4><figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#å…ˆå°†esçš„æ•°æ®ä¸é…ç½®ä¸éœ€è¦æ˜ å°„çš„æ–‡ä»¶å¤¹åˆ›å»ºå¥½</span></span><br><span class="line"><span class="string">mkdir</span> <span class="string">-p</span> <span class="string">/mydata/elasticsearch/config</span></span><br><span class="line"><span class="string">mkdir</span> <span class="string">-p</span> <span class="string">/mydata/elasticsearch/data</span></span><br><span class="line"><span class="comment">#é…ç½®esåœ°å€</span></span><br><span class="line"><span class="string">echo</span> <span class="string">&quot;http.host: 0.0.0.0&quot;</span> <span class="string">&gt;&gt;</span> <span class="string">/mydata/elasticsearch/config/elasticsearch.yml</span></span><br><span class="line"><span class="comment">#ä¿è¯æƒé™</span></span><br><span class="line"><span class="string">chmod</span> <span class="string">-R</span> <span class="number">777</span> <span class="string">/mydata/elasticsearch/</span> </span><br><span class="line"><span class="comment">#åˆ›å»ºå¹¶å¯åŠ¨å®ä¾‹</span></span><br><span class="line"><span class="string">docker</span> <span class="string">run</span> <span class="string">--name</span> <span class="string">elasticsearch</span> <span class="string">-p</span> <span class="number">9200</span><span class="string">:9200</span> <span class="string">-p</span> <span class="number">9300</span><span class="string">:9300</span> <span class="string">\</span></span><br><span class="line"><span class="string">-e</span> <span class="string">&quot;discovery.type=single-node&quot;</span> <span class="string">\-e</span> <span class="string">ES_JAVA_OPTS=&quot;-Xms64m</span> <span class="string">-Xmx512m&quot;</span> <span class="string">\</span></span><br><span class="line"><span class="string">-v</span> <span class="string">/mydata/elasticsearch/config/elasticsearch.yml:/usr/share/elasticsearch/config/elasticsearch.yml</span> <span class="string">\</span></span><br><span class="line"><span class="string">-v</span> <span class="string">/mydata/elasticsearch/data:/usr/share/elasticsearch/data</span> <span class="string">\</span></span><br><span class="line"><span class="string">-v</span> <span class="string">/mydata/elasticsearch/plugins:/usr/share/elasticsearch/plugins</span> <span class="string">\</span></span><br><span class="line"><span class="string">-d</span> <span class="string">elasticsearch:7.4.2</span></span><br></pre></td></tr></table></figure><ul><li><p>æ³¨æ„ï¼š-e ES_JAVA_OPTS=&quot;-Xms64m -Xmx256m&quot; \ æµ‹è¯•ç¯å¢ƒä¸‹ï¼Œ è®¾ç½® ES çš„åˆå§‹å†…å­˜å’Œæœ€å¤§å†…å­˜ï¼Œ å¦åˆ™ä¼šå¯¼è‡´å ç”¨å†…å­˜è¿‡å¤š</p></li><li><p>æ•ˆæœï¼š</p></li></ul><p><img src="https://gitee.com/linhaipengg/md_-picture/raw/master/image-20231125163451134.png" alt="image-20231125163451134" /></p><ul><li><p>ESçš„9200å’Œ9300ç«¯å£åŒºåˆ«</p><ul><li><p>9200ä½œä¸ºHttpåè®®ï¼Œä¸»è¦ç”¨äºå¤–éƒ¨é€šè®¯</p></li><li><p>9300ä½œä¸ºTcpåè®®ï¼Œjarä¹‹é—´å°±æ˜¯é€šè¿‡tcpåè®®é€šè®¯ .ESé›†ç¾¤ä¹‹é—´æ˜¯é€šè¿‡9300è¿›è¡Œé€šè®¯</p></li></ul></li></ul><blockquote><p>æµ‹è¯•æ˜¯å¦åˆ›å»ºæˆåŠŸ</p><p>192.168.234.128:9200 è™šæ‹Ÿæœºåœ°å€+9200</p><p>è®°å¾—é˜²ç«å¢™å¼€æ”¾9200ç«¯å£</p></blockquote><p><img src="https://gitee.com/linhaipengg/md_-picture/raw/master/image-20231125163328991.png" alt="image-20231125163328991" /></p><h4 id="2åˆ›å»ºkibanaå®ä¾‹"><a class="markdownIt-Anchor" href="#2åˆ›å»ºkibanaå®ä¾‹"></a> ï¼ˆ2ï¼‰åˆ›å»ºKibanaå®ä¾‹</h4><figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">docker</span> <span class="string">run</span> <span class="string">--name</span> <span class="string">kibana</span> <span class="string">-e</span> <span class="string">ELASTICSEARCH_HOSTS=http://192.168.234.128:9200</span> <span class="string">-p</span> <span class="number">5601</span><span class="string">:5601</span> <span class="string">\</span></span><br><span class="line"><span class="string">-d</span> <span class="string">kibana:7.4.2</span></span><br></pre></td></tr></table></figure><blockquote><p>æµ‹è¯•æ˜¯å¦åˆ›å»ºæˆåŠŸ</p><p>192.168.234.128:5601</p></blockquote><img src="https://gitee.com/linhaipengg/md_-picture/raw/master/image-20231125164601714.png" alt="image-20231125164601714" style="zoom: 33%;" /><h3 id="213è®¾ç½®eså’Œkibanaè‡ªå¯åŠ¨"><a class="markdownIt-Anchor" href="#213è®¾ç½®eså’Œkibanaè‡ªå¯åŠ¨"></a> 2.1.3è®¾ç½®eså’Œkibanaè‡ªå¯åŠ¨</h3><blockquote><p>å…ˆä¸è®¾ç½®ï¼Œæ‹…å¿ƒå†…å­˜ä¸å¤Ÿ</p></blockquote><figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># è®¾ç½®esåœ¨dockerå¼€å¯çš„æ—¶å€™å¯åŠ¨</span></span><br><span class="line"><span class="string">docker</span> <span class="string">update</span> <span class="string">elasticsearch</span> <span class="string">--restart=always</span></span><br><span class="line"><span class="comment"># è®¾ç½®Kibanaåœ¨dockerå¼€å¯çš„æ—¶å€™å¯åŠ¨</span></span><br><span class="line"><span class="string">docker</span> <span class="string">update</span> <span class="string">kibana</span> <span class="string">--restart=always</span></span><br></pre></td></tr></table></figure><h2 id="22åŸºäºwindowså®‰è£…esä¸kibana"><a class="markdownIt-Anchor" href="#22åŸºäºwindowså®‰è£…esä¸kibana"></a> 2.2åŸºäºWindowså®‰è£…ESä¸Kibana</h2><blockquote><p>å¾…å†™</p></blockquote><h1 id="3åˆçº§æ£€ç´¢"><a class="markdownIt-Anchor" href="#3åˆçº§æ£€ç´¢"></a> 3.åˆçº§æ£€ç´¢</h1><h2 id="31æŸ¥çœ‹èŠ‚ç‚¹ç´¢å¼•"><a class="markdownIt-Anchor" href="#31æŸ¥çœ‹èŠ‚ç‚¹ç´¢å¼•"></a> 3.1æŸ¥çœ‹èŠ‚ç‚¹/ç´¢å¼•</h2><figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#æŸ¥çœ‹æ‰€æœ‰èŠ‚ç‚¹</span></span><br><span class="line"><span class="string">GET</span> <span class="string">/_cat/nodes</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#æŸ¥çœ‹æ‰€æœ‰èŠ‚ç‚¹</span></span><br><span class="line"><span class="string">GET</span> <span class="string">/_cat/health</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#æŸ¥çœ‹ä¸»èŠ‚ç‚¹</span></span><br><span class="line"><span class="string">GET</span> <span class="string">/_cat/master</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#æŸ¥çœ‹æ‰€æœ‰ç´¢å¼•â€”â€”show databases;</span></span><br><span class="line"><span class="string">GET</span> <span class="string">/_cat/indices</span></span><br></pre></td></tr></table></figure><h2 id="32ç´¢å¼•ä¿å­˜æ–‡æ¡£"><a class="markdownIt-Anchor" href="#32ç´¢å¼•ä¿å­˜æ–‡æ¡£"></a> 3.2ç´¢å¼•ï¼ˆä¿å­˜ï¼‰æ–‡æ¡£</h2><h3 id="321putæ–¹æ³•"><a class="markdownIt-Anchor" href="#321putæ–¹æ³•"></a> 3.2.1PUTæ–¹æ³•</h3><p><strong>ä¿å­˜ä¸€ä¸ªæ•°æ®ï¼Œ ä¿å­˜åœ¨å“ªä¸ªç´¢å¼•çš„å“ªä¸ªç±»å‹ä¸‹ï¼Œ æŒ‡å®šç”¨å“ªä¸ªå”¯ä¸€æ ‡è¯†</strong></p><p><img src="https://gitee.com/linhaipengg/md_-picture/raw/master/image-20231125170734843.png" alt="image-20231125170734843" /></p><h3 id="322postæ–¹æ³•"><a class="markdownIt-Anchor" href="#322postæ–¹æ³•"></a> 3.2.2POSTæ–¹æ³•</h3><p><img src="https://gitee.com/linhaipengg/md_-picture/raw/master/image-20231125171504137.png" alt="image-20231125171504137" /></p><h3 id="323putå’Œpostçš„åŒºåˆ«"><a class="markdownIt-Anchor" href="#323putå’Œpostçš„åŒºåˆ«"></a> 3.2.3PUTå’ŒPOSTçš„åŒºåˆ«</h3><ul><li><p>ç›¸åŒ</p><ul><li><p>PUTä¸POSTéƒ½å¯ä»¥æ–°å¢ä¸ä¿®æ”¹æ–‡æ¡£</p></li><li><p>PUTä¸POSTä¿®æ”¹æ–‡æ¡£éƒ½æ˜¯æŒ‡å®šidå†ç´¢å¼•ä¸€æ¬¡</p></li></ul></li><li><p>ä¸åŒâ€”<strong>æ–°å¢ä¸Š</strong></p><ul><li><strong>PUTæ–°å¢åªèƒ½è‡ªå®šä¹‰id</strong>ï¼Œä¸èƒ½è‡ªåŠ¨ç”Ÿæˆï¼ˆPUTæœ¬å°±æ˜¯è®¾å®šç”¨æ¥ä¿®æ”¹çš„ï¼‰</li><li><strong>POSTæ–°å¢å¯ä»¥ä¸å¸¦idï¼ˆè‡ªåŠ¨ç”Ÿæˆï¼‰ï¼Œä¹Ÿå¯ä»¥è‡ªå®šä¹‰id</strong></li></ul></li><li><p>è¡¥å……</p><ul><li>PUTä¿®æ”¹å¿…é¡»æŒ‡å®šæ–‡æ¡£idã€å¦åˆ™æŠ¥é”™</li><li>POSTä¿®æ”¹è‹¥æŒ‡å®šå­˜åœ¨çš„æ–‡æ¡£idï¼Œåˆ™ä¸ºä¿®æ”¹ï¼›è‹¥æŒ‡å®šä¸å­˜åœ¨æˆ–è€…æ²¡æœ‰æ¥ä¸Šæ–‡æ¡£idï¼Œåˆ™ä¸ºæ–°å¢</li></ul></li></ul><h2 id="33æŸ¥è¯¢æŒ‡å®šidæ–‡æ¡£"><a class="markdownIt-Anchor" href="#33æŸ¥è¯¢æŒ‡å®šidæ–‡æ¡£"></a> 3.3æŸ¥è¯¢æŒ‡å®šidæ–‡æ¡£</h2><p><img src="https://gitee.com/linhaipengg/md_-picture/raw/master/image-20231125172846736.png" alt="image-20231125172846736" /></p><h2 id="34æ›´æ–°æ–‡æ¡£"><a class="markdownIt-Anchor" href="#34æ›´æ–°æ–‡æ¡£"></a> 3.4æ›´æ–°æ–‡æ¡£</h2><figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># ä¹‹å‰å°±æ˜¯è¿™ç§å†™æ³•ï¼šç‰ˆæœ¬ç›´æ¥åŠ </span></span><br><span class="line"><span class="string">POST</span> <span class="string">customer/external/1</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="attr">&quot;name&quot;:</span> <span class="string">&quot;John Doe2&quot;</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"># ä¼šå¯¹æ¯”ä¹‹å‰çš„å†…å®¹ï¼Œç›¸åŒåˆ™ç‰ˆæœ¬ä¸å˜</span></span><br><span class="line"><span class="string">POST</span> <span class="string">customer/external/1/_update</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="attr">&quot;doc&quot;:</span> &#123;</span><br><span class="line">    <span class="attr">&quot;name&quot;:</span> <span class="string">&quot;John Doe2&quot;</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"># æ›´æ–°åŒæ—¶å¢åŠ å±æ€§</span></span><br><span class="line"><span class="string">PUT</span> <span class="string">customer/external/1</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="attr">&quot;name&quot;:</span> <span class="string">&quot;John Doe3&quot;</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"># æ›´æ–°åŒæ—¶å¢åŠ å±æ€§</span></span><br><span class="line"><span class="string">POST</span> <span class="string">customer/external/1/_update</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="attr">&quot;doc&quot;:</span> &#123;</span><br><span class="line">    <span class="attr">&quot;name&quot;:</span> <span class="string">&quot;Jane Doe&quot;</span>,</span><br><span class="line">    <span class="attr">&quot;age&quot;:</span> <span class="number">20</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>POSTæ–¹å¼ä¸€ä¸æ–¹å¼äºŒçš„åŒºåˆ«æ˜¯å¦å¸¦update</p><ul><li><p><strong>å¸¦_updateçš„POSTæ›´æ–°ï¼šä¼šå¯¹æ¯”æºæ–‡æ¡£æ•°æ®</strong>ï¼Œ å¦‚æœç›¸åŒä¸ä¼šæœ‰ä»€ä¹ˆæ“ä½œï¼Œ æ–‡æ¡£ version ä¸å¢åŠ </p></li><li><p>ä¸å¸¦_updateçš„POSTï¼šæ€»ä¼šå°†æ•°æ®é‡æ–°ä¿å­˜å¹¶å¢åŠ  version ç‰ˆæœ¬</p></li><li><p>PUT æ“ä½œæ€»ä¼šå°†æ•°æ®é‡æ–°ä¿å­˜å¹¶å¢åŠ  version ç‰ˆæœ¬ï¼›</p></li></ul><h2 id="35åˆ é™¤ç´¢å¼•"><a class="markdownIt-Anchor" href="#35åˆ é™¤ç´¢å¼•"></a> 3.5åˆ é™¤ç´¢å¼•</h2><figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#åˆ é™¤æ–‡æ¡£</span></span><br><span class="line"><span class="string">DELETE</span> <span class="string">customer/external/1</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#åˆ é™¤ç´¢å¼•</span></span><br><span class="line"><span class="string">DELETE</span> <span class="string">customer</span></span><br></pre></td></tr></table></figure><h2 id="36bulkæ‰¹é‡api"><a class="markdownIt-Anchor" href="#36bulkæ‰¹é‡api"></a> 3.6bulkæ‰¹é‡API</h2><p>åœ¨å•ä¸ª API è°ƒç”¨ä¸­æ‰§è¡Œ<mark>å¤šä¸ªç´¢å¼•æˆ–åˆ é™¤æ“ä½œ</mark>ã€‚è¿™å‡å°‘äº†å¼€é”€å¹¶ä¸”å¯ä»¥å¤§å¤§æé«˜ç´¢å¼•é€Ÿåº¦ã€‚</p><h3 id="361è¯­æ³•æ ¼å¼"><a class="markdownIt-Anchor" href="#361è¯­æ³•æ ¼å¼"></a> 3.6.1è¯­æ³•æ ¼å¼</h3><blockquote><p>{ action: { metadata }} //action: æ“ä½œ; metadata:å¯¹å“ªä¸€ä¸ªæ•°æ®è¿›è¡Œæ“ä½œ</p><p>{ request body } //æ“ä½œçš„å†…å®¹</p><p>{ action: { metadata }}</p><p>{ request body }</p><p>ä¸¤ä¸ªä¸€ç»„</p></blockquote><p><img src="https://gitee.com/linhaipengg/md_-picture/raw/master/image-20231125223007146.png" alt="image-20231125223007146" /></p><h3 id="362å¤æ‚bulk"><a class="markdownIt-Anchor" href="#362å¤æ‚bulk"></a> 3.6.2å¤æ‚bulk</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">POST /_bulk</span><br><span class="line">&#123; <span class="string">&quot;delete&quot;</span>: &#123; <span class="string">&quot;_index&quot;</span>: <span class="string">&quot;website&quot;</span>, <span class="string">&quot;_type&quot;</span>: <span class="string">&quot;blog&quot;</span>, <span class="string">&quot;_id&quot;</span>: <span class="string">&quot;123&quot;</span> &#125;&#125;</span><br><span class="line">&#123; <span class="string">&quot;create&quot;</span>: &#123; <span class="string">&quot;_index&quot;</span>: <span class="string">&quot;website&quot;</span>, <span class="string">&quot;_type&quot;</span>: <span class="string">&quot;blog&quot;</span>, <span class="string">&quot;_id&quot;</span>: <span class="string">&quot;123&quot;</span> &#125;&#125;</span><br><span class="line">&#123; <span class="string">&quot;title&quot;</span>: <span class="string">&quot;My first blog post&quot;</span> &#125;</span><br><span class="line">&#123; <span class="string">&quot;index&quot;</span>: &#123; <span class="string">&quot;_index&quot;</span>: <span class="string">&quot;website&quot;</span>, <span class="string">&quot;_type&quot;</span>: <span class="string">&quot;blog&quot;</span> &#125;&#125;  </span><br><span class="line">&#123; <span class="string">&quot;title&quot;</span>: <span class="string">&quot;My second blog post&quot;</span> &#125;</span><br><span class="line">&#123; <span class="string">&quot;update&quot;</span>: &#123; <span class="string">&quot;_index&quot;</span>: <span class="string">&quot;website&quot;</span>, <span class="string">&quot;_type&quot;</span>: <span class="string">&quot;blog&quot;</span>, <span class="string">&quot;_id&quot;</span>: <span class="string">&quot;123&quot;</span>&#125;&#125;</span><br><span class="line">&#123; <span class="string">&quot;doc&quot;</span> : &#123;<span class="string">&quot;title&quot;</span> : <span class="string">&quot;My updated blog post&quot;</span>&#125; &#125;</span><br></pre></td></tr></table></figure><blockquote><p>bulk API ä»¥æ­¤æŒ‰é¡ºåºæ‰§è¡Œæ‰€æœ‰çš„ actionï¼ˆåŠ¨ä½œï¼‰ ã€‚ å¦‚æœä¸€ä¸ªå•ä¸ªçš„åŠ¨ä½œå› ä»»ä½•åŸå› è€Œå¤±è´¥ï¼Œå®ƒå°†ç»§ç»­å¤„ç†å®ƒåé¢å‰©ä½™çš„åŠ¨ä½œã€‚ å½“ bulk API è¿”å›æ—¶ï¼Œ å®ƒå°†æä¾›æ¯ä¸ªåŠ¨ä½œçš„çŠ¶æ€ï¼ˆä¸å‘é€çš„é¡ºåºç›¸åŒï¼‰ ï¼Œ æ‰€ä»¥æ‚¨å¯ä»¥æ£€æŸ¥æ˜¯å¦ä¸€ä¸ªæŒ‡å®šçš„åŠ¨ä½œæ˜¯ä¸æ˜¯å¤±è´¥äº†ã€‚</p></blockquote><h1 id="4è¿›é˜¶æ£€ç´¢"><a class="markdownIt-Anchor" href="#4è¿›é˜¶æ£€ç´¢"></a> 4.è¿›é˜¶æ£€ç´¢</h1><h2 id="41å¯¼å…¥æ•°æ®"><a class="markdownIt-Anchor" href="#41å¯¼å…¥æ•°æ®"></a> 4.1å¯¼å…¥æ•°æ®</h2><p>æ•°æ®é“¾æ¥ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">https://gitee.com/zhourui815/gulimall/blob/master/doc/es%E6%B5%8B%E8%AF%95%E6%95%B0%E6%8D%AE.json#</span><br></pre></td></tr></table></figure><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">POST bank/account/_bulk</span><br><span class="line">æµ‹è¯•æ•°æ®</span><br></pre></td></tr></table></figure><h2 id="42searchapi"><a class="markdownIt-Anchor" href="#42searchapi"></a> 4.2SearchAPI</h2><p>ES æ”¯æŒä¸¤ç§åŸºæœ¬æ–¹å¼æ£€ç´¢ :</p><ul><li>ä¸€ä¸ªæ˜¯é€šè¿‡ä½¿ç”¨ REST request URI å‘é€æœç´¢å‚æ•°ï¼ˆuri+æ£€ç´¢å‚æ•°ï¼‰</li><li>å¦ä¸€ä¸ªæ˜¯é€šè¿‡ä½¿ç”¨ REST request body æ¥å‘é€å®ƒä»¬ï¼ˆuri+è¯·æ±‚ä½“</li></ul><h3 id="421æ£€ç´¢ä¿¡æ¯"><a class="markdownIt-Anchor" href="#421æ£€ç´¢ä¿¡æ¯"></a> 4.2.1æ£€ç´¢ä¿¡æ¯</h3><p>**ä¸€åˆ‡æ£€ç´¢ä»_search å¼€å§‹ **</p><p><img src="https://gitee.com/linhaipengg/md_-picture/raw/master/image-20231125224553112.png" alt="image-20231125224553112" /></p><h3 id="422è¯·æ±‚å‚æ•°æ–¹å¼æ£€ç´¢"><a class="markdownIt-Anchor" href="#422è¯·æ±‚å‚æ•°æ–¹å¼æ£€ç´¢"></a> 4.2.2è¯·æ±‚å‚æ•°æ–¹å¼æ£€ç´¢</h3><figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#è¯·æ±‚å‚æ•°æ–¹å¼æ£€ç´¢</span></span><br><span class="line"><span class="string">q=*</span>  <span class="string">ä»£è¡¨è¦æŸ¥è¯¢çš„å­—æ®µç±»ä¼¼äºselect</span> <span class="string">*</span></span><br><span class="line"><span class="string">sort=account_number:asc</span>  <span class="string">ä»£è¡¨æŒ‰ç…§account_numberå­—æ®µæ’åº,å‡åº</span></span><br><span class="line"><span class="string">GET</span> <span class="string">bank/_search?q=*&amp;sort=account_number:asc</span></span><br></pre></td></tr></table></figure><h3 id="423uriè¯·æ±‚ä½“è¿›è¡Œæ£€ç´¢"><a class="markdownIt-Anchor" href="#423uriè¯·æ±‚ä½“è¿›è¡Œæ£€ç´¢"></a> 4.2.3uri+è¯·æ±‚ä½“è¿›è¡Œæ£€ç´¢</h3><figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#uri+è¯·æ±‚ä½“è¿›è¡Œæ£€ç´¢  </span></span><br><span class="line"><span class="string">GET</span> <span class="string">bank/_search</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="attr">&quot;query&quot;:</span> &#123;</span><br><span class="line">    <span class="attr">&quot;match_all&quot;:</span> &#123;&#125;</span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="attr">&quot;sort&quot;:</span> [</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="attr">&quot;account_number&quot;:</span> &#123;</span><br><span class="line">        <span class="attr">&quot;order&quot;:</span> <span class="string">&quot;desc&quot;</span></span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  ]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="43query-dsl"><a class="markdownIt-Anchor" href="#43query-dsl"></a> 4.3Query DSL</h2><p>url+è¯·æ±‚ä½“</p><p>Elasticsearch æä¾›äº†ä¸€ä¸ªå¯ä»¥æ‰§è¡ŒæŸ¥è¯¢çš„ Json é£æ ¼çš„ DSLï¼ˆ domain-specific language é¢†åŸŸç‰¹å®šè¯­è¨€ï¼‰ ã€‚ è¿™ä¸ªè¢«ç§°ä¸º Query DSLã€‚ è¯¥æŸ¥è¯¢è¯­è¨€éå¸¸å…¨é¢ï¼Œ å¹¶ä¸”åˆšå¼€å§‹çš„æ—¶å€™æ„Ÿè§‰æœ‰ç‚¹å¤æ‚ï¼ŒçœŸæ­£å­¦å¥½å®ƒçš„æ–¹æ³•æ˜¯ä»ä¸€äº›åŸºç¡€çš„ç¤ºä¾‹å¼€å§‹çš„ã€‚</p><h3 id="431è¯­æ³•æ ¼å¼"><a class="markdownIt-Anchor" href="#431è¯­æ³•æ ¼å¼"></a> 4.3.1è¯­æ³•æ ¼å¼</h3><figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># ä¸€ä¸ªæŸ¥è¯¢è¯­å¥ çš„å…¸å‹ç»“æ„</span></span><br><span class="line">&#123;</span><br><span class="line"><span class="attr">QUERY_NAME:</span> &#123;</span><br><span class="line"><span class="attr">ARGUMENT:</span> <span class="string">VALUE</span>,</span><br><span class="line"><span class="attr">ARGUMENT:</span> <span class="string">VALUE</span>,<span class="string">...</span></span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment"># å¦‚æœæ˜¯é’ˆå¯¹æŸä¸ªå­—æ®µï¼Œ é‚£ä¹ˆå®ƒçš„ç»“æ„å¦‚ä¸‹ï¼š</span></span><br><span class="line">&#123;</span><br><span class="line"><span class="attr">QUERY_NAME:</span> &#123;</span><br><span class="line"><span class="attr">FIELD_NAME:</span> &#123;</span><br><span class="line"><span class="attr">ARGUMENT:</span> <span class="string">VALUE</span>,</span><br><span class="line"><span class="attr">ARGUMENT:</span> <span class="string">VALUE</span>,<span class="string">...</span></span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="432æŸ¥è¯¢ç¤ºä¾‹"><a class="markdownIt-Anchor" href="#432æŸ¥è¯¢ç¤ºä¾‹"></a> 4.3.2æŸ¥è¯¢ç¤ºä¾‹</h3><blockquote><p>æŸ¥è¯¢bankç´¢å¼•å¹¶æŒ‰ç…§account_numberå­—æ®µé™åºæ’åº,åˆ†é¡µå¤§å°ä¸º5</p></blockquote><figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#åŸºæœ¬æŸ¥è¯¢ç¤ºä¾‹</span></span><br><span class="line"><span class="string">GET</span> <span class="string">bank/_search</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="attr">&quot;query&quot;:</span> &#123;</span><br><span class="line">    <span class="attr">&quot;match_all&quot;:</span> &#123;&#125;</span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="attr">&quot;from&quot;:</span> <span class="number">0</span>,</span><br><span class="line">  <span class="attr">&quot;size&quot;:</span> <span class="number">5</span>,</span><br><span class="line">  <span class="attr">&quot;sort&quot;:</span> [</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="attr">&quot;account_number&quot;:</span> &#123;</span><br><span class="line">        <span class="attr">&quot;order&quot;:</span> <span class="string">&quot;desc&quot;</span></span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  ]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><blockquote><ul><li>query å®šä¹‰å¦‚ä½•æŸ¥è¯¢ï¼Œ</li><li>match_all æŸ¥è¯¢ç±»å‹ã€ä»£è¡¨æŸ¥è¯¢æ‰€æœ‰çš„æ‰€æœ‰ã€‘ ï¼Œ</li><li>es ä¸­å¯ä»¥åœ¨ query ä¸­ç»„åˆéå¸¸å¤šçš„æŸ¥ è¯¢ç±»å‹å®Œæˆå¤æ‚æŸ¥è¯¢</li><li>é™¤äº† query å‚æ•°ä¹‹å¤–ï¼Œ æˆ‘ä»¬ä¹Ÿå¯ä»¥ä¼ é€’å…¶å®ƒçš„å‚æ•°ä»¥æ”¹å˜æŸ¥è¯¢ç»“æœã€‚ å¦‚ sortï¼Œ size</li><li>from+size é™å®šï¼Œ å®Œæˆåˆ†é¡µåŠŸèƒ½</li><li>sort æ’åºï¼Œ å¤šå­—æ®µæ’åºï¼Œ ä¼šåœ¨å‰åºå­—æ®µç›¸ç­‰æ—¶åç»­å­—æ®µå†…éƒ¨æ’åºï¼Œ å¦åˆ™ä»¥å‰åºä¸ºå‡†</li></ul></blockquote><h3 id="433matchåŒ¹é…"><a class="markdownIt-Anchor" href="#433matchåŒ¹é…"></a> 4.3.3matchåŒ¹é…</h3><blockquote><p>match è¿”å› account_number=20 çš„</p></blockquote><figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#match åŸºæœ¬ç±»å‹(éå­—ç¬¦ä¸²ç±»å‹),ç²¾ç¡®åŒ¹é…  </span></span><br><span class="line"><span class="string">GET</span> <span class="string">bank/_search</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="attr">&quot;query&quot;:</span> &#123;</span><br><span class="line">    <span class="attr">&quot;match&quot;:</span> &#123;</span><br><span class="line">      <span class="attr">&quot;account_number&quot;:</span> <span class="string">&quot;20&quot;</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><blockquote><p>æœ€ç»ˆæŸ¥è¯¢å‡º address ä¸­åŒ…å« mill å•è¯çš„æ‰€æœ‰è®°å½• match å½“æœç´¢å­—ç¬¦ä¸²ç±»å‹çš„æ—¶å€™ï¼Œ ä¼šè¿›è¡Œå…¨æ–‡æ£€ç´¢ï¼Œ å¹¶ä¸”æ¯æ¡è®°å½•æœ‰ç›¸å…³æ€§å¾—åˆ†ã€‚</p></blockquote><figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#match å­—ç¬¦ä¸²ç±»å‹,å…¨æ–‡æ£€ç´¢ï¼Œæ¨¡ç³ŠåŒ¹é…</span></span><br><span class="line"><span class="string">GET</span> <span class="string">bank/_search</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="attr">&quot;query&quot;:</span> &#123;</span><br><span class="line">    <span class="attr">&quot;match&quot;:</span> &#123;</span><br><span class="line">      <span class="attr">&quot;address&quot;:</span> <span class="string">&quot;mill&quot;</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><blockquote><p>æœ€ç»ˆæŸ¥è¯¢å‡º address ä¸­åŒ…å« mill æˆ–è€… road æˆ–è€… mill road çš„æ‰€æœ‰è®°å½•ï¼Œ å¹¶ç»™å‡ºç›¸å…³æ€§å¾—åˆ†</p></blockquote><figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#match å­—ç¬¦ä¸²ï¼Œ å¤šä¸ªå•è¯ï¼ˆ åˆ†è¯+å…¨æ–‡æ£€ç´¢ï¼‰</span></span><br><span class="line"><span class="string">GET</span> <span class="string">bank/_search</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="attr">&quot;query&quot;:</span> &#123;</span><br><span class="line">    <span class="attr">&quot;match&quot;:</span> &#123;</span><br><span class="line">      <span class="attr">&quot;address&quot;:</span> <span class="string">&quot;mill road&quot;</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="434match_phraseçŸ­è¯­åŒ¹é…"><a class="markdownIt-Anchor" href="#434match_phraseçŸ­è¯­åŒ¹é…"></a> 4.3.4match_phraseçŸ­è¯­åŒ¹é…</h3><blockquote><p>çŸ­è¯­åŒ¹é…ï¼šå°†éœ€è¦åŒ¹é…çš„å€¼å½“æˆä¸€ä¸ªæ•´ä½“å•è¯ï¼ˆ ä¸åˆ†è¯ï¼‰ è¿›è¡Œæ£€ç´¢</p><p>æŸ¥å‡º address ä¸­åŒ…å« mill road çš„æ‰€æœ‰è®°å½•ï¼Œ å¹¶ç»™å‡ºç›¸å…³æ€§å¾—åˆ†</p></blockquote><figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#match_phrase çŸ­è¯­åŒ¹é…</span></span><br><span class="line"><span class="string">GET</span> <span class="string">bank/_search</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="attr">&quot;query&quot;:</span> &#123;</span><br><span class="line">    <span class="attr">&quot;match_phrase&quot;:</span> &#123;</span><br><span class="line">      <span class="attr">&quot;address&quot;:</span> <span class="string">&quot;mill road&quot;</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="435multi_match-å¤šå­—æ®µåŒ¹é…"><a class="markdownIt-Anchor" href="#435multi_match-å¤šå­—æ®µåŒ¹é…"></a> 4.3.5multi_match å¤šå­—æ®µåŒ¹é…</h3><blockquote><p>æŸ¥è¯¢ state æˆ–è€… addresså­—æ®µ åŒ…å« mill</p></blockquote><figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#multi_match å¤šå­—æ®µåŒ¹é…</span></span><br><span class="line"><span class="string">GET</span> <span class="string">bank/_search</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="attr">&quot;query&quot;:</span> &#123;</span><br><span class="line">    <span class="attr">&quot;multi_match&quot;:</span> &#123;</span><br><span class="line">      <span class="attr">&quot;query&quot;:</span> <span class="string">&quot;mill&quot;</span>,</span><br><span class="line">      <span class="attr">&quot;fields&quot;:</span> [<span class="string">&quot;address&quot;</span>,<span class="string">&quot;state&quot;</span>]</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="436boolå¤åˆæŸ¥è¯¢"><a class="markdownIt-Anchor" href="#436boolå¤åˆæŸ¥è¯¢"></a> 4.3.6boolå¤åˆæŸ¥è¯¢</h3><blockquote><p>bool ç”¨æ¥åšå¤åˆæŸ¥è¯¢ï¼š<br />å¤åˆè¯­å¥å¯ä»¥åˆå¹¶ ä»»ä½• å…¶å®ƒæŸ¥è¯¢è¯­å¥ï¼Œ åŒ…æ‹¬å¤åˆè¯­å¥ï¼Œ  å¤åˆè¯­å¥ä¹‹é—´å¯ä»¥äº’ç›¸åµŒå¥—ï¼Œ å¯ä»¥è¡¨è¾¾éå¸¸å¤æ‚çš„é€»è¾‘ã€‚</p></blockquote><h4 id="1must"><a class="markdownIt-Anchor" href="#1must"></a> ï¼ˆ1ï¼‰must</h4><blockquote><p>å¿…é¡»è¾¾åˆ° must åˆ—ä¸¾çš„æ‰€æœ‰æ¡ä»¶</p></blockquote><figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># must å¿…é¡»è¾¾åˆ° must åˆ—ä¸¾çš„æ‰€æœ‰æ¡ä»¶</span></span><br><span class="line"><span class="string">GET</span> <span class="string">bank/_search</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="attr">&quot;query&quot;:</span> &#123;</span><br><span class="line">    <span class="attr">&quot;bool&quot;:</span> &#123;</span><br><span class="line">      <span class="attr">&quot;must&quot;:</span> [</span><br><span class="line">        &#123;</span><br><span class="line">          <span class="attr">&quot;match&quot;:</span> &#123;</span><br><span class="line">            <span class="attr">&quot;address&quot;:</span> <span class="string">&quot;Mill&quot;</span></span><br><span class="line">          &#125;</span><br><span class="line">        &#125;,</span><br><span class="line">        &#123;</span><br><span class="line">          <span class="attr">&quot;match&quot;:</span> &#123;</span><br><span class="line">            <span class="attr">&quot;gender&quot;:</span> <span class="string">&quot;M&quot;</span></span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">      ]</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="2should"><a class="markdownIt-Anchor" href="#2should"></a> ï¼ˆ2ï¼‰should</h4><blockquote><p>åº”è¯¥è¾¾åˆ° should åˆ—ä¸¾çš„æ¡ä»¶ï¼Œ å¦‚æœè¾¾åˆ°ä¼šå¢åŠ ç›¸å…³æ–‡æ¡£çš„è¯„åˆ†ï¼Œ å¹¶ä¸ä¼šæ”¹å˜æŸ¥è¯¢çš„ç»“æœã€‚</p><p>å¦‚æœ query ä¸­åªæœ‰ should ä¸”åªæœ‰ä¸€ç§åŒ¹é…è§„åˆ™ï¼Œ é‚£ä¹ˆ should çš„æ¡ä»¶å°±ä¼šè¢«ä½œä¸ºé»˜è®¤åŒ¹é…æ¡ä»¶è€Œå»æ”¹å˜æŸ¥è¯¢ç»“æœ</p></blockquote><figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># åº”è¯¥è¾¾åˆ° shouldåˆ—ä¸¾çš„æ¡ä»¶ï¼Œå¦‚æœè¾¾åˆ°ä¼šå¢åŠ ç›¸å…³æ–‡æ¡£çš„è¯„åˆ†ï¼Œå¹¶ä¸ä¼šæ”¹å˜æŸ¥è¯¢çš„ç»“æœã€‚</span></span><br><span class="line"><span class="string">GET</span> <span class="string">bank/_search</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="attr">&quot;query&quot;:</span> &#123;</span><br><span class="line">    <span class="attr">&quot;bool&quot;:</span> &#123;</span><br><span class="line">      <span class="attr">&quot;must&quot;:</span> [</span><br><span class="line">        &#123;</span><br><span class="line">          <span class="attr">&quot;match&quot;:</span> &#123;</span><br><span class="line">            <span class="attr">&quot;address&quot;:</span> <span class="string">&quot;mill&quot;</span></span><br><span class="line">          &#125;</span><br><span class="line">        &#125;,</span><br><span class="line">        &#123;</span><br><span class="line">          <span class="attr">&quot;match&quot;:</span> &#123;</span><br><span class="line">            <span class="attr">&quot;gender&quot;:</span> <span class="string">&quot;M&quot;</span></span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">      ],</span><br><span class="line">      <span class="attr">&quot;should&quot;:</span> [</span><br><span class="line">        &#123;</span><br><span class="line">          <span class="attr">&quot;match&quot;:</span> &#123;</span><br><span class="line">            <span class="attr">&quot;address&quot;:</span> <span class="string">&quot;lane&quot;</span></span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">      ]</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="3must_not"><a class="markdownIt-Anchor" href="#3must_not"></a> ï¼ˆ3ï¼‰must_not</h4><blockquote><p>å¿…é¡»ä¸æ˜¯æŒ‡å®šçš„æƒ…å†µ</p><p>address åŒ…å« millï¼Œ å¹¶ä¸” gender æ˜¯ Mï¼Œ å¦‚æœ address é‡Œé¢æœ‰ lane æœ€å¥½ä¸è¿‡ï¼Œ ä½†æ˜¯åŒ¹é…çš„å­—æ®µå¿…é¡»ä¸æ˜¯æ–‡æœ¬ç±»å‹</p></blockquote><figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#must_not å¿…é¡»ä¸æ˜¯æŒ‡å®šçš„æƒ…å†µ  </span></span><br><span class="line"><span class="string">GET</span> <span class="string">bank/_search</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="attr">&quot;query&quot;:</span> &#123;</span><br><span class="line">    <span class="attr">&quot;bool&quot;:</span> &#123;</span><br><span class="line">      <span class="attr">&quot;must&quot;:</span> [</span><br><span class="line">        &#123;</span><br><span class="line">          <span class="attr">&quot;match&quot;:</span> &#123;</span><br><span class="line">            <span class="attr">&quot;address&quot;:</span> <span class="string">&quot;mill&quot;</span></span><br><span class="line">          &#125;</span><br><span class="line">        &#125;,</span><br><span class="line">        &#123;</span><br><span class="line">          <span class="attr">&quot;match&quot;:</span> &#123;</span><br><span class="line">            <span class="attr">&quot;gender&quot;:</span> <span class="string">&quot;M&quot;</span></span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">      ],</span><br><span class="line">      <span class="attr">&quot;should&quot;:</span> [</span><br><span class="line">        &#123;</span><br><span class="line">          <span class="attr">&quot;match&quot;:</span> &#123;</span><br><span class="line">            <span class="attr">&quot;address&quot;:</span> <span class="string">&quot;lane&quot;</span></span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">      ],</span><br><span class="line">      <span class="attr">&quot;must_not&quot;:</span> [</span><br><span class="line">        &#123;<span class="attr">&quot;match&quot;:</span> &#123;</span><br><span class="line">          <span class="attr">&quot;FIELD&quot;:</span> <span class="string">&quot;TEXT&quot;</span></span><br><span class="line">        &#125;&#125;</span><br><span class="line">      ]</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="4filterç»“æœè¿‡æ»¤"><a class="markdownIt-Anchor" href="#4filterç»“æœè¿‡æ»¤"></a> ï¼ˆ4ï¼‰filterç»“æœè¿‡æ»¤</h4><blockquote><p>å¹¶ä¸æ˜¯æ‰€æœ‰çš„æŸ¥è¯¢éƒ½éœ€è¦äº§ç”Ÿåˆ†æ•°ï¼Œ ç‰¹åˆ«æ˜¯é‚£äº›ä»…ç”¨äº â€œfilteringâ€ï¼ˆè¿‡æ»¤ï¼‰ çš„æ–‡æ¡£ã€‚ **ä¸ºäº†ä¸è®¡ç®—åˆ†æ•° **Elasticsearch ä¼šè‡ªåŠ¨æ£€æŸ¥åœºæ™¯å¹¶ä¸”ä¼˜åŒ–æŸ¥è¯¢çš„æ‰§è¡Œã€‚</p></blockquote><p><img src="https://gitee.com/linhaipengg/md_-picture/raw/master/image-20231125233601072.png" alt="image-20231125233601072" /></p><h4 id="5å°ç»“"><a class="markdownIt-Anchor" href="#5å°ç»“"></a> ï¼ˆ5ï¼‰å°ç»“</h4><p><img src="https://gitee.com/linhaipengg/md_-picture/raw/master/image-20231125233651828.png" alt="image-20231125233651828" /></p><h3 id="437termétextå­—æ®µæ£€ç´¢"><a class="markdownIt-Anchor" href="#437termétextå­—æ®µæ£€ç´¢"></a> 4.3.7termâ€”étextå­—æ®µæ£€ç´¢</h3><blockquote><p>å’Œ match ä¸€æ ·ã€‚ åŒ¹é…æŸä¸ªå±æ€§çš„å€¼ã€‚ å…¨æ–‡æ£€ç´¢å­—æ®µç”¨ matchï¼Œ å…¶ä»–<strong>é text å­—æ®µ</strong>åŒ¹é…ç”¨ termã€‚</p></blockquote><figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#term å…¶ä»–é text å­—æ®µæ£€ç´¢</span></span><br><span class="line"><span class="string">GET</span> <span class="string">bank/_search</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="attr">&quot;query&quot;:</span> &#123;</span><br><span class="line">    <span class="attr">&quot;bool&quot;:</span> &#123;</span><br><span class="line">      <span class="attr">&quot;must&quot;:</span> [</span><br><span class="line">        &#123;</span><br><span class="line">          <span class="attr">&quot;term&quot;:</span> &#123;</span><br><span class="line">            <span class="attr">&quot;account_number&quot;:</span> &#123;</span><br><span class="line">              <span class="attr">&quot;value&quot;:</span> <span class="string">&quot;970&quot;</span></span><br><span class="line">            &#125;</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;,</span><br><span class="line">        &#123;</span><br><span class="line">          <span class="attr">&quot;match&quot;:</span> &#123;</span><br><span class="line">            <span class="attr">&quot;address&quot;:</span> <span class="string">&quot;Mill&quot;</span></span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">      ]</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="438aggregationsèšåˆæ£€ç´¢"><a class="markdownIt-Anchor" href="#438aggregationsèšåˆæ£€ç´¢"></a> 4.3.8aggregationsèšåˆæ£€ç´¢</h3><ol><li>æœ€ç®€å•çš„èšåˆæ–¹æ³•å¤§è‡´ç­‰äº SQL GROUP BY å’Œ SQL èšåˆå‡½æ•°ã€‚</li><li>åœ¨ Elasticsearch ä¸­ï¼Œ æ‚¨æœ‰æ‰§è¡Œæœç´¢è¿”å› hitsï¼ˆ å‘½ä¸­ç»“æœï¼‰ï¼Œå¹¶ä¸”åŒæ—¶è¿”å›èšåˆç»“æœï¼Œ æŠŠä¸€ä¸ªå“åº”ä¸­çš„æ‰€æœ‰ hitsï¼ˆ å‘½ä¸­ç»“æœï¼‰ åˆ†éš”å¼€çš„èƒ½åŠ›ã€‚</li><li>å¯ä»¥æ‰§è¡ŒæŸ¥è¯¢å’Œå¤šä¸ªèšåˆï¼Œ å¹¶ä¸”åœ¨ä¸€æ¬¡ä½¿ç”¨ä¸­å¾—åˆ°å„è‡ªçš„ï¼ˆ ä»»ä½•ä¸€ä¸ªçš„ï¼‰ è¿”å›ç»“æœï¼Œ ä½¿ç”¨ä¸€æ¬¡ç®€æ´å’Œç®€åŒ–çš„ API æ¥é¿å…ç½‘ç»œå¾€è¿”ã€‚</li></ol><blockquote><p>å†™åœ¨å‰é¢ï¼šæœ‰å¾ˆå¤šç§èšåˆæ–¹å¼ï¼štermsã€avgsèšåˆ</p></blockquote><img src="https://gitee.com/linhaipengg/md_-picture/raw/master/image-20231126091812312.png" alt="image-20231126091812312" style="zoom:50%;" /><h4 id="1å¹´é¾„åˆ†å¸ƒ-å¹¶æ±‚å‡ºå¹´é¾„çš„å¹³å‡å€¼"><a class="markdownIt-Anchor" href="#1å¹´é¾„åˆ†å¸ƒ-å¹¶æ±‚å‡ºå¹´é¾„çš„å¹³å‡å€¼"></a> ï¼ˆ1ï¼‰å¹´é¾„åˆ†å¸ƒã€å¹¶æ±‚å‡ºå¹´é¾„çš„å¹³å‡å€¼</h4><blockquote><p>æœç´¢ address ä¸­åŒ…å« mill çš„æ‰€æœ‰äººçš„å¹´é¾„åˆ†å¸ƒä»¥åŠå¹³å‡å¹´é¾„ï¼Œ ä½†ä¸æ˜¾ç¤ºè¿™äº›äººçš„è¯¦æƒ…ï¼ˆsize=0ï¼‰</p></blockquote><img src="https://gitee.com/linhaipengg/md_-picture/raw/master/image-20231126092304394.png" alt="image-20231126092304394" style="zoom: 50%;" /><h4 id="2æ±‚å‡ºå¹´é¾„åˆ†å¸ƒå¹¶åœ¨æ¯ä¸ªå¹´é¾„æ±‚å¹³å‡è–ªèµ„"><a class="markdownIt-Anchor" href="#2æ±‚å‡ºå¹´é¾„åˆ†å¸ƒå¹¶åœ¨æ¯ä¸ªå¹´é¾„æ±‚å¹³å‡è–ªèµ„"></a> ï¼ˆ2ï¼‰æ±‚å‡ºå¹´é¾„åˆ†å¸ƒ,å¹¶åœ¨æ¯ä¸ªå¹´é¾„æ±‚å¹³å‡è–ªèµ„</h4><p><img src="https://gitee.com/linhaipengg/md_-picture/raw/master/image-20231126092648463.png" alt="image-20231126092648463" /></p><h2 id="44mapping"><a class="markdownIt-Anchor" href="#44mapping"></a> 4.4Mapping</h2><h3 id="441å­—æ®µç±»å‹"><a class="markdownIt-Anchor" href="#441å­—æ®µç±»å‹"></a> 4.4.1å­—æ®µç±»å‹</h3><ol><li>å­—æ®µç±»å‹æœ‰æ ¸å¿ƒç±»å‹ã€å¤åˆç±»å‹ã€åœ°ç†ç±»å‹ã€ç‰¹å®šç±»å‹ä»¥åŠå¤šå­—æ®µç±»å‹å…±5ç§</li><li><strong>æ ¸å¿ƒç±»å‹ï¼š</strong><ol><li>å­—ç¬¦ä¸²ï¼šstringã€textã€keyword</li><li>æ•°å­—ç±»å‹ï¼šlongã€integerã€shortã€byteã€doubleã€float</li><li>æ—¥æœŸç±»å‹ï¼šdate</li><li>å¸ƒå°”ç±»å‹ï¼šboolean</li><li>äºŒè¿›åˆ¶ç±»å‹ï¼šbinary</li></ol></li><li>**å¤åˆç±»å‹ï¼š**æ•°ç»„ç±»å‹ï¼ˆArrayï¼‰ã€å¯¹è±¡ç±»å‹ï¼ˆObjectï¼‰ã€åµŒå¥—ç±»å‹ï¼ˆNestedï¼‰</li><li>**åœ°ç†ç±»å‹ï¼š**åœ°ç†åæ ‡ï¼ˆGeo-pointsï¼‰ã€åœ°ç†å›¾å½¢ï¼ˆGeo-Shapeï¼‰</li><li>**ç‰¹å®šç±»å‹ï¼š**IPç±»å‹ï¼ˆipï¼‰ã€è¡¥å…¨ç±»å‹ï¼ˆCompletionï¼‰ã€ä»¤ç‰Œè®¡æ•°ç±»å‹ï¼ˆToken countï¼‰ã€é™„ä»¶ç±»å‹ï¼ˆattachmentï¼‰</li><li>**å¤šå­—æ®µç±»å‹ï¼š**é€šå¸¸ç”¨äºä¸ºä¸åŒç›®çš„ç”¨ä¸åŒçš„æ–¹æ³•ç´¢IåŒä¸€ä¸ªå­—æ®µã€‚ä¾‹å¦‚ï¼Œ<strong>stringå­—æ®µ</strong>å¯ä»¥æ˜ å°„ä¸ºä¸€ä¸ªtextå­—æ®µç”¨äºå…¨æ–‡æ£€ç´¢ï¼ŒåŒæ ·å¯ä»¥æ˜ å°„ä¸ºä¸€ä¸ªkeywordå­—æ®µç”¨äºæ’åºå’Œèšåˆ</li></ol><h3 id="442æ˜ å°„ç®€ä»‹"><a class="markdownIt-Anchor" href="#442æ˜ å°„ç®€ä»‹"></a> 4.4.2æ˜ å°„ç®€ä»‹</h3><ol><li>å®šä¹‰ï¼šMapping æ˜¯ç”¨æ¥å®šä¹‰ä¸€ä¸ªæ–‡æ¡£ï¼ˆ documentï¼‰ ï¼Œ ä»¥åŠå®ƒæ‰€åŒ…å«çš„å±æ€§ï¼ˆ fieldï¼‰ æ˜¯å¦‚ä½•å­˜å‚¨å’Œç´¢å¼•çš„ã€‚ æ¯”å¦‚ï¼Œ ä½¿ç”¨ mapping æ¥å®šä¹‰ï¼š<ol><li>å“ªäº›å­—ç¬¦ä¸²å±æ€§åº”è¯¥è¢«çœ‹åšå…¨æ–‡æœ¬å±æ€§ï¼ˆfull text fieldsï¼‰</li><li>å“ªäº›å±æ€§åŒ…å«æ•°å­—ï¼Œ æ—¥æœŸæˆ–è€…åœ°ç†ä½ç½®ã€‚</li><li>æ–‡æ¡£ä¸­çš„æ‰€æœ‰å±æ€§æ˜¯å¦éƒ½èƒ½è¢«ç´¢å¼•</li></ol></li></ol><figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#æŸ¥çœ‹mappingä¿¡æ¯</span></span><br><span class="line"><span class="string">GET</span> <span class="string">bank/_mapping</span></span><br></pre></td></tr></table></figure><img src="https://gitee.com/linhaipengg/md_-picture/raw/master/image-20231126093413138.png" alt="image-20231126093413138" style="zoom:50%;" /><ul><li>é—®é¢˜ï¼šæˆ‘ä»¬åœ¨åˆ›å»ºç´¢å¼•æ˜¯æ²¡æœ‰æŒ‡å®šç±»å‹ï¼Œä¸ºä»€ä¹ˆä¼šæŸ¥è¯¢å‡ºæ¥å‘¢?</li><li>ç­”æ¡ˆï¼šesä¼šæ ¹æ®æ•°æ®è‡ªåŠ¨çŒœæµ‹çš„æ˜ å°„ç±»å‹ï¼Œè‡ªåŠ¨çŒœæµ‹çš„æ˜ å°„ç±»å‹æœ‰ï¼š<ul><li>å¸ƒå°”å‹ï¼štrueæˆ–è€…falseï¼ŒçŒœæµ‹çš„æ˜ å°„ç±»å‹ä¸ºboolean</li><li>æ•´æ•°ï¼š123ï¼ŒçŒœæµ‹çš„æ˜ å°„ç±»å‹ä¸ºlong</li><li>æµ®ç‚¹æ•°ï¼š123.45ï¼ŒçŒœæµ‹çš„æ˜ å°„ç±»å‹ä¸ºdouble</li><li>å­—ç¬¦ä¸²ï¼Œæœ‰æ•ˆæ—¥æœŸï¼š2024-10-10ï¼ŒçŒœæµ‹çš„æ˜ å°„ç±»å‹ä¸ºdate</li><li>å­—ç¬¦ä¸²ï¼šfoo barï¼ŒçŒœæµ‹çš„æ˜ å°„ç±»å‹ä¸ºstring</li></ul></li></ul><h3 id="443åˆ›å»ºæ˜ å°„"><a class="markdownIt-Anchor" href="#443åˆ›å»ºæ˜ å°„"></a> 4.4.3åˆ›å»ºæ˜ å°„</h3><p><img src="https://gitee.com/linhaipengg/md_-picture/raw/master/image-20231126094141793.png" alt="image-20231126094141793" /></p><h3 id="444æ›´æ–°æ˜ å°„"><a class="markdownIt-Anchor" href="#444æ›´æ–°æ˜ å°„"></a> 4.4.4æ›´æ–°æ˜ å°„</h3><p>å¯¹äºå·²ç»å­˜åœ¨çš„æ˜ å°„å­—æ®µï¼Œ æˆ‘ä»¬ä¸èƒ½æ›´æ–°ã€‚ æ›´æ–°å¿…é¡»åˆ›å»ºæ–°çš„ç´¢å¼•è¿›è¡Œæ•°æ®è¿ç§»</p><h3 id="445æ•°æ®è¿ç§»"><a class="markdownIt-Anchor" href="#445æ•°æ®è¿ç§»"></a> 4.4.5æ•°æ®è¿ç§»</h3><h4 id="1æŸ¥è¯¢ä¹‹å‰çš„æ˜ å°„"><a class="markdownIt-Anchor" href="#1æŸ¥è¯¢ä¹‹å‰çš„æ˜ å°„"></a> ï¼ˆ1ï¼‰æŸ¥è¯¢ä¹‹å‰çš„æ˜ å°„</h4><figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">GET</span> <span class="string">bank/_mapping</span></span><br></pre></td></tr></table></figure><ul><li>å°†æŸ¥è¯¢çš„å­—æ®µæ˜ å°„å¤åˆ¶å‡ºæ¥</li><li>å‡è®¾ageå­—æ®µç±»å‹ä¸ºlongï¼Œæƒ³æ¢æˆintegerç±»å‹</li></ul><p><img src="https://gitee.com/linhaipengg/md_-picture/raw/master/image-20231126100102484.png" alt="image-20231126100102484" /></p><h4 id="2æ–°å¢ä¸€ä¸ªæ–°ç´¢å¼•"><a class="markdownIt-Anchor" href="#2æ–°å¢ä¸€ä¸ªæ–°ç´¢å¼•"></a> ï¼ˆ2ï¼‰æ–°å¢ä¸€ä¸ªæ–°ç´¢å¼•</h4><p>å°†å¤åˆ¶çš„å±æ€§ç²˜è´´åˆ°å±æ€§ä¸­ï¼Œå…ˆä¸æ‰§è¡Œ</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">&quot;account_number&quot;</span> <span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;type&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;long&quot;</span></span><br><span class="line"><span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line"><span class="attr">&quot;address&quot;</span> <span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;type&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;text&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;fields&quot;</span> <span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;keyword&quot;</span> <span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">            <span class="attr">&quot;type&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;keyword&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;ignore_above&quot;</span> <span class="punctuation">:</span> <span class="number">256</span></span><br><span class="line">        <span class="punctuation">&#125;</span></span><br><span class="line">    <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line"><span class="attr">&quot;age&quot;</span> <span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;type&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;long&quot;</span></span><br><span class="line"><span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line"><span class="attr">&quot;balance&quot;</span> <span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;type&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;long&quot;</span></span><br><span class="line"><span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line"><span class="attr">&quot;city&quot;</span> <span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;type&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;text&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;fields&quot;</span> <span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;keyword&quot;</span> <span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">            <span class="attr">&quot;type&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;keyword&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;ignore_above&quot;</span> <span class="punctuation">:</span> <span class="number">256</span></span><br><span class="line">        <span class="punctuation">&#125;</span></span><br><span class="line">    <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line"><span class="attr">&quot;email&quot;</span> <span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;type&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;text&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;fields&quot;</span> <span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;keyword&quot;</span> <span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">            <span class="attr">&quot;type&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;keyword&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;ignore_above&quot;</span> <span class="punctuation">:</span> <span class="number">256</span></span><br><span class="line">        <span class="punctuation">&#125;</span></span><br><span class="line">    <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line"><span class="attr">&quot;employer&quot;</span> <span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;type&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;text&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;fields&quot;</span> <span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;keyword&quot;</span> <span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">            <span class="attr">&quot;type&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;keyword&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;ignore_above&quot;</span> <span class="punctuation">:</span> <span class="number">256</span></span><br><span class="line">        <span class="punctuation">&#125;</span></span><br><span class="line">    <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line"><span class="attr">&quot;firstname&quot;</span> <span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;type&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;text&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;fields&quot;</span> <span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;keyword&quot;</span> <span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">            <span class="attr">&quot;type&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;keyword&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;ignore_above&quot;</span> <span class="punctuation">:</span> <span class="number">256</span></span><br><span class="line">        <span class="punctuation">&#125;</span></span><br><span class="line">    <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line"><span class="attr">&quot;gender&quot;</span> <span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;type&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;text&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;fields&quot;</span> <span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;keyword&quot;</span> <span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">            <span class="attr">&quot;type&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;keyword&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;ignore_above&quot;</span> <span class="punctuation">:</span> <span class="number">256</span></span><br><span class="line">        <span class="punctuation">&#125;</span></span><br><span class="line">    <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line"><span class="attr">&quot;lastname&quot;</span> <span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;type&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;text&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;fields&quot;</span> <span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;keyword&quot;</span> <span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">            <span class="attr">&quot;type&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;keyword&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;ignore_above&quot;</span> <span class="punctuation">:</span> <span class="number">256</span></span><br><span class="line">        <span class="punctuation">&#125;</span></span><br><span class="line">    <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line"><span class="attr">&quot;state&quot;</span> <span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;type&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;text&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;fields&quot;</span> <span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;keyword&quot;</span> <span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">            <span class="attr">&quot;type&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;keyword&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;ignore_above&quot;</span> <span class="punctuation">:</span> <span class="number">256</span></span><br><span class="line">        <span class="punctuation">&#125;</span></span><br><span class="line">    <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure><h4 id="3ä¿®æ”¹æ˜ å°„"><a class="markdownIt-Anchor" href="#3ä¿®æ”¹æ˜ å°„"></a> ï¼ˆ3ï¼‰ä¿®æ”¹æ˜ å°„</h4><figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># åˆ›å»ºä¸€ä¸ªæ–°ç´¢å¼•</span></span><br><span class="line"><span class="string">PUT</span> <span class="string">newbank2</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">&quot;mappings&quot;</span><span class="string">:</span>&#123;</span><br><span class="line">    <span class="attr">&quot;properties&quot;:</span> &#123;</span><br><span class="line">    <span class="attr">&quot;account_number&quot;:</span> &#123;</span><br><span class="line">      <span class="attr">&quot;type&quot;:</span> <span class="string">&quot;long&quot;</span></span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="attr">&quot;address&quot;:</span> &#123;</span><br><span class="line">      <span class="attr">&quot;type&quot;:</span> <span class="string">&quot;text&quot;</span></span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="attr">&quot;age&quot;:</span> &#123;</span><br><span class="line">      <span class="attr">&quot;type&quot;:</span> <span class="string">&quot;integer&quot;</span></span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="attr">&quot;balance&quot;:</span> &#123;</span><br><span class="line">      <span class="attr">&quot;type&quot;:</span> <span class="string">&quot;long&quot;</span></span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="attr">&quot;city&quot;:</span> &#123;</span><br><span class="line">      <span class="attr">&quot;type&quot;:</span> <span class="string">&quot;text&quot;</span>,</span><br><span class="line">      <span class="attr">&quot;fields&quot;:</span> &#123;</span><br><span class="line">        <span class="attr">&quot;keyword&quot;:</span> &#123;</span><br><span class="line">          <span class="attr">&quot;type&quot;:</span> <span class="string">&quot;keyword&quot;</span>,</span><br><span class="line">          <span class="attr">&quot;ignore_above&quot;:</span> <span class="number">256</span></span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="attr">&quot;email&quot;:</span> &#123;</span><br><span class="line">      <span class="attr">&quot;type&quot;:</span> <span class="string">&quot;text&quot;</span>,</span><br><span class="line">      <span class="attr">&quot;fields&quot;:</span> &#123;</span><br><span class="line">        <span class="attr">&quot;keyword&quot;:</span> &#123;</span><br><span class="line">          <span class="attr">&quot;type&quot;:</span> <span class="string">&quot;keyword&quot;</span>,</span><br><span class="line">          <span class="attr">&quot;ignore_above&quot;:</span> <span class="number">256</span></span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="attr">&quot;employer&quot;:</span> &#123;</span><br><span class="line">      <span class="attr">&quot;type&quot;:</span> <span class="string">&quot;text&quot;</span>,</span><br><span class="line">      <span class="attr">&quot;fields&quot;:</span> &#123;</span><br><span class="line">        <span class="attr">&quot;keyword&quot;:</span> &#123;</span><br><span class="line">          <span class="attr">&quot;type&quot;:</span> <span class="string">&quot;keyword&quot;</span>,</span><br><span class="line">          <span class="attr">&quot;ignore_above&quot;:</span> <span class="number">256</span></span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="attr">&quot;firstname&quot;:</span> &#123;</span><br><span class="line">      <span class="attr">&quot;type&quot;:</span> <span class="string">&quot;text&quot;</span>,</span><br><span class="line">      <span class="attr">&quot;fields&quot;:</span> &#123;</span><br><span class="line">        <span class="attr">&quot;keyword&quot;:</span> &#123;</span><br><span class="line">          <span class="attr">&quot;type&quot;:</span> <span class="string">&quot;keyword&quot;</span>,</span><br><span class="line">          <span class="attr">&quot;ignore_above&quot;:</span> <span class="number">256</span></span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="attr">&quot;gender&quot;:</span> &#123;</span><br><span class="line">      <span class="attr">&quot;type&quot;:</span> <span class="string">&quot;text&quot;</span>,</span><br><span class="line">      <span class="attr">&quot;fields&quot;:</span> &#123;</span><br><span class="line">        <span class="attr">&quot;keyword&quot;:</span> &#123;</span><br><span class="line">          <span class="attr">&quot;type&quot;:</span> <span class="string">&quot;keyword&quot;</span>,</span><br><span class="line">          <span class="attr">&quot;ignore_above&quot;:</span> <span class="number">256</span></span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="attr">&quot;lastname&quot;:</span> &#123;</span><br><span class="line">      <span class="attr">&quot;type&quot;:</span> <span class="string">&quot;text&quot;</span>,</span><br><span class="line">      <span class="attr">&quot;fields&quot;:</span> &#123;</span><br><span class="line">        <span class="attr">&quot;keyword&quot;:</span> &#123;</span><br><span class="line">          <span class="attr">&quot;type&quot;:</span> <span class="string">&quot;keyword&quot;</span>,</span><br><span class="line">          <span class="attr">&quot;ignore_above&quot;:</span> <span class="number">256</span></span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="attr">&quot;state&quot;:</span> &#123;</span><br><span class="line">      <span class="attr">&quot;type&quot;:</span> <span class="string">&quot;text&quot;</span>,</span><br><span class="line">      <span class="attr">&quot;fields&quot;:</span> &#123;</span><br><span class="line">        <span class="attr">&quot;keyword&quot;:</span> &#123;</span><br><span class="line">          <span class="attr">&quot;type&quot;:</span> <span class="string">&quot;keyword&quot;</span>,</span><br><span class="line">          <span class="attr">&quot;ignore_above&quot;:</span> <span class="number">256</span></span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="4æ•°æ®è¿ç§»"><a class="markdownIt-Anchor" href="#4æ•°æ®è¿ç§»"></a> ï¼ˆ4ï¼‰æ•°æ®è¿ç§»</h4><figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#æ•°æ®è¿ç§»</span></span><br><span class="line"><span class="string">POST</span> <span class="string">_reindex</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="attr">&quot;source&quot;:</span> &#123;</span><br><span class="line">    <span class="attr">&quot;index&quot;:</span> <span class="string">&quot;bank&quot;</span></span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="attr">&quot;dest&quot;:</span> &#123;</span><br><span class="line">    <span class="attr">&quot;index&quot;:</span> <span class="string">&quot;newbank2&quot;</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><blockquote><p>è¿ç§»æˆåŠŸ</p></blockquote><p><img src="https://gitee.com/linhaipengg/md_-picture/raw/master/image-20231126101222331.png" alt="image-20231126101222331" /></p><h2 id="45åˆ†è¯å¾…é‡å†™"><a class="markdownIt-Anchor" href="#45åˆ†è¯å¾…é‡å†™"></a> <mark>4.5åˆ†è¯ï¼ˆå¾…é‡å†™ï¼‰</mark></h2><ol><li><p>åœ¨ESä¸­ï¼Œä¸€ä¸ª tokenizerï¼ˆ åˆ†è¯å™¨ï¼‰ æ¥æ”¶ä¸€ä¸ªå­—ç¬¦æµï¼Œ å°†ä¹‹åˆ†å‰²ä¸ºç‹¬ç«‹çš„ tokensï¼ˆ è¯å…ƒï¼Œ é€šå¸¸æ˜¯ç‹¬ç«‹çš„å•è¯ï¼‰ ï¼Œ ç„¶åè¾“å‡º tokens æµã€‚</p><ol><li>ä¾‹å¦‚ï¼Œ whitespace tokenizer é‡åˆ°ç©ºç™½å­—ç¬¦æ—¶åˆ†å‰²æ–‡æœ¬ã€‚ å®ƒä¼šå°†æ–‡æœ¬ â€œQuick brown fox!â€ åˆ†å‰²ä¸º [Quick, brown, fox!]ã€‚</li><li>è¯¥ tokenizerï¼ˆåˆ†è¯å™¨ï¼‰ è¿˜è´Ÿè´£è®°å½•å„ä¸ª termï¼ˆè¯æ¡ï¼‰ çš„é¡ºåºæˆ– position ä½ç½®ï¼ˆç”¨äº phrase çŸ­è¯­å’Œ word proximity è¯è¿‘é‚»æŸ¥è¯¢ï¼‰ ï¼Œ ä»¥åŠ termï¼ˆè¯æ¡ï¼‰ æ‰€ä»£è¡¨çš„åŸå§‹ wordï¼ˆå•è¯ï¼‰ çš„ startï¼ˆèµ·å§‹ï¼‰ å’Œ endï¼ˆç»“æŸï¼‰ çš„ character offsetsï¼ˆå­—ç¬¦åç§»é‡ï¼‰ ï¼ˆç”¨äºé«˜äº®æ˜¾ç¤ºæœç´¢çš„å†…å®¹ï¼‰ ã€‚</li></ol></li><li><p>Elasticsearch æä¾›äº†å¾ˆå¤šå†…ç½®çš„åˆ†è¯å™¨ï¼Œ å¯ä»¥ç”¨æ¥æ„å»º custom analyzersï¼ˆè‡ªå®šä¹‰åˆ†è¯å™¨ï¼‰ ã€‚</p></li></ol><h3 id="451å®‰è£…ikåˆ†è¯å™¨"><a class="markdownIt-Anchor" href="#451å®‰è£…ikåˆ†è¯å™¨"></a> 4.5.1å®‰è£…ikåˆ†è¯å™¨</h3><p>æ²¡æœ‰å®‰è£…åˆ†è¯å™¨ä¹‹å‰çš„æ•ˆæœ</p><img src="https://gitee.com/linhaipengg/md_-picture/raw/master/image-20231126102404692.png" alt="image-20231126102404692" style="zoom:50%;" /><p>**æ³¨æ„ï¼š ä¸èƒ½ç”¨é»˜è®¤ elasticsearch-plugin install xxx.zip è¿›è¡Œè‡ªåŠ¨å®‰è£… **</p><blockquote><p>ç”±äºä¹‹å‰æ˜ å°„äº†pluginsç›®å½•,æ‰€ä»¥åœ¨/mydata/elasticsearch/plugins/ä¸‹è½½elasticsearch-analysis-ik-7.4.2.zip</p></blockquote><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">wget https://github.com/medcl/elasticsearch-analysis-ik/releases/download/v7.4.2/elasticsearch-analysis-ik-7.4.2.zip</span><br></pre></td></tr></table></figure><blockquote><p>è§£å‹</p></blockquote><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">unzip elasticsearch-analysis-ik-7.4.2.zip</span><br></pre></td></tr></table></figure><blockquote><p>åˆ é™¤zipæ–‡ä»¶</p></blockquote><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">rm â€“rf *.zip</span><br></pre></td></tr></table></figure><blockquote><p>å°†elasticsearchæ–‡ä»¶å¤¹ä¸‹çš„æ‰€æœ‰æ–‡ä»¶ ç§»åŠ¨è‡³ikç›®å½•ä¸‹(è‡ªå»ºç›®å½•)</p></blockquote><p><mark><strong>ä½¿ç”¨xftpè¿›è¡Œç§»åŠ¨</strong></mark></p><p><img src="https://gitee.com/linhaipengg/md_-picture/raw/master/image-20231126110523062.png" alt="image-20231126110523062" /></p><blockquote><p>ä¿®æ”¹ikæ–‡ä»¶å¤¹æƒé™</p></blockquote><figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">chmod</span> <span class="string">-R</span> <span class="number">777</span> <span class="string">ik</span></span><br></pre></td></tr></table></figure><blockquote><p>ç¡®è®¤æ˜¯å¦å®‰è£…å¥½äº†åˆ†è¯å™¨</p></blockquote><figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#è¿›å…¥å®¹å™¨å†…éƒ¨</span></span><br><span class="line"><span class="string">docker</span> <span class="string">exec</span> <span class="string">-it</span> <span class="string">å®¹å™¨</span> <span class="string">id</span> <span class="string">/bin/bash</span></span><br><span class="line"><span class="comment">#åˆ‡æ¢ç›®å½•</span></span><br><span class="line"><span class="string">cd</span> <span class="string">bin</span></span><br><span class="line"><span class="comment">#åˆ—å‡ºå®‰è£…çš„plugin</span></span><br><span class="line"><span class="string">elasticsearch</span> <span class="string">plugin</span> <span class="string">list</span></span><br></pre></td></tr></table></figure><blockquote><p>å‘ç°ikåé‡å¯å®¹å™¨</p></blockquote><figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">docker</span> <span class="string">restart</span> <span class="string">elasticsearch</span></span><br></pre></td></tr></table></figure><h3 id="452æµ‹è¯•åˆ†è¯å™¨"><a class="markdownIt-Anchor" href="#452æµ‹è¯•åˆ†è¯å™¨"></a> 4.5.2æµ‹è¯•åˆ†è¯å™¨</h3><h4 id="1ä½¿ç”¨é»˜è®¤åˆ†è¯å™¨"><a class="markdownIt-Anchor" href="#1ä½¿ç”¨é»˜è®¤åˆ†è¯å™¨"></a> ï¼ˆ1ï¼‰ä½¿ç”¨é»˜è®¤åˆ†è¯å™¨</h4><p><img src="https://gitee.com/linhaipengg/md_-picture/raw/master/image-20231126110748326.png" alt="image-20231126110748326" /></p><h4 id="2ä½¿ç”¨ik_smartåˆ†è¯å™¨"><a class="markdownIt-Anchor" href="#2ä½¿ç”¨ik_smartåˆ†è¯å™¨"></a> ï¼ˆ2ï¼‰ä½¿ç”¨ik_smartåˆ†è¯å™¨</h4><p><img src="https://gitee.com/linhaipengg/md_-picture/raw/master/image-20231126110816338.png" alt="image-20231126110816338" /></p><h4 id="3ä½¿ç”¨ik_max_word-åˆ†è¯å™¨"><a class="markdownIt-Anchor" href="#3ä½¿ç”¨ik_max_word-åˆ†è¯å™¨"></a> ï¼ˆ3ï¼‰ä½¿ç”¨ik_max_word åˆ†è¯å™¨</h4><p><img src="https://gitee.com/linhaipengg/md_-picture/raw/master/image-20231126110900124.png" alt="image-20231126110900124" /></p><h4 id="4æ€»ç»“"><a class="markdownIt-Anchor" href="#4æ€»ç»“"></a> ï¼ˆ4ï¼‰æ€»ç»“</h4><p>èƒ½å¤Ÿçœ‹å‡ºä¸åŒçš„åˆ†è¯å™¨ï¼Œ åˆ†è¯æœ‰æ˜æ˜¾çš„åŒºåˆ«ï¼Œ æ‰€ä»¥ä»¥åå®šä¹‰ä¸€ä¸ªç´¢å¼•ä¸èƒ½å†ä½¿ç”¨é»˜è®¤çš„ mapping äº†ï¼Œ è¦æ‰‹å·¥å»ºç«‹ mapping, å› ä¸ºè¦é€‰æ‹©åˆ†è¯å™¨ã€‚</p><h3 id="453è‡ªå®šä¹‰è¯åº“"><a class="markdownIt-Anchor" href="#453è‡ªå®šä¹‰è¯åº“"></a> 4.5.3è‡ªå®šä¹‰è¯åº“</h3><h3 id="454æœªè‡ªå®šä¹‰è¯åº“"><a class="markdownIt-Anchor" href="#454æœªè‡ªå®šä¹‰è¯åº“"></a> 4.5.4æœªè‡ªå®šä¹‰è¯åº“</h3><p><img src="https://gitee.com/linhaipengg/md_-picture/raw/master/image-20231126111345748.png" alt="image-20231126111345748" /></p><p>è‡ªå®šä¹‰è¯åº“æµ‹è¯•</p><ul><li>åˆ›å»ºè¯åº“</li></ul><blockquote><p><strong>åœ¨4.6ï¼šæ­å»ºå¥½nginxçš„åŸºç¡€ä¸Š,æ­å»ºnginxåœ¨8.xç« èŠ‚</strong></p></blockquote><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">cd /mydata/nginx/html/</span><br><span class="line">#åˆ›å»ºè‡ªå®šä¹‰è¯åº“</span><br><span class="line">vim fenci.txt</span><br></pre></td></tr></table></figure><p>æ·»åŠ æ–°è¯</p><p><img src="https://gitee.com/linhaipengg/md_-picture/raw/master/image-20231126114652319.png" alt="image-20231126114652319" /></p><ul><li>ä¿®æ”¹åˆ†è¯å™¨é…ç½®æ–‡ä»¶</li></ul><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">vim /mydata/elasticsearch/plugins/ik/config/IKAnalyzer.cfg.xml</span><br></pre></td></tr></table></figure><p><img src="https://gitee.com/linhaipengg/md_-picture/raw/master/image-20231126120129228.png" alt="image-20231126120129228" /></p><ul><li>é‡å¯es</li></ul><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker restart elasticsearch</span><br></pre></td></tr></table></figure><ul><li>æ•ˆæœ</li></ul><p><img src="https://gitee.com/linhaipengg/md_-picture/raw/master/image-20231126120246793.png" alt="image-20231126120246793" /></p><h1 id="5springbootæ•´åˆes"><a class="markdownIt-Anchor" href="#5springbootæ•´åˆes"></a> 5.SpringBootæ•´åˆES</h1><h2 id="51xmlé…ç½®"><a class="markdownIt-Anchor" href="#51xmlé…ç½®"></a> 5.1xmlé…ç½®</h2><p>SpringBootæƒ³å’ŒESè¿›è¡Œé€šä¿¡ä¼ é€’æ¶ˆæ¯çš„æ–¹å¼æœ‰ä¸¤ç§ï¼štcpã€http</p><ol><li><p>9300ï¼š TCP</p><ol><li>éœ€è¦çš„jaråŒ…ï¼šspring-data-elasticsearch:transport-api.jarï¼›</li><li>springboot ç‰ˆæœ¬ä¸åŒï¼Œ transport-api.jar ä¸åŒï¼Œ ä¸èƒ½é€‚é… es ç‰ˆæœ¬</li><li>7.x å·²ç»ä¸å»ºè®®ä½¿ç”¨ï¼Œ 8 ä»¥åå°±è¦åºŸå¼ƒ</li></ol></li><li><p>9200ï¼š HTTPï¼Œæœ‰ä»¥ä¸‹å››ç§é€šä¿¡æ–¹å¼</p><ol><li>JestClientï¼š éå®˜æ–¹ï¼Œ æ›´æ–°æ…¢</li><li>RestTemplateï¼š æ¨¡æ‹Ÿå‘ HTTP è¯·æ±‚ï¼Œ ES å¾ˆå¤šæ“ä½œéœ€è¦è‡ªå·±å°è£…ï¼Œ éº»çƒ¦</li><li>HttpClientï¼š åŒä¸Š</li><li>Elasticsearch-Rest-Clientï¼š å®˜æ–¹ RestClientï¼Œ å°è£…äº† ES æ“ä½œï¼Œ API å±‚æ¬¡åˆ†æ˜ï¼Œ ä¸Šæ‰‹ç®€å•</li></ol></li></ol><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.elasticsearch.client<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>elasticsearch-rest-high-level-client<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>7.4.2<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line">å¯èƒ½å‡ºç°bugï¼Œæ¢æˆä»¥ä¸‹ä¾èµ–</span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.elasticsearch.client<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>elasticsearch-rest-high-level-client<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>7.4.2<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">exclusions</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">exclusion</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.elasticsearch<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>elasticsearch<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">exclusion</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">exclusion</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.elasticsearch.client<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>elasticsearch-rest-client<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">exclusion</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">exclusions</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.elasticsearch.client<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>elasticsearch-rest-client<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>7.4.2<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.elasticsearch<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>elasticsearch<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>7.4.2<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure><h2 id="52é…ç½®ç±»"><a class="markdownIt-Anchor" href="#52é…ç½®ç±»"></a> 5.2é…ç½®ç±»</h2><p>ä¸»å¯åŠ¨ç±»æ·»åŠ æ³¨è§£ï¼š@EnableDiscoverClient</p><img src="https://gitee.com/linhaipengg/md_-picture/raw/master/image-20231126171800066.png" alt="image-20231126171800066" style="zoom: 67%;" /><p>æ·»åŠ ï¼šé…ç½®ç±»</p><img src="https://gitee.com/linhaipengg/md_-picture/raw/master/image-20231126171821397.png" alt="image-20231126171821397" style="zoom: 50%;" /><h2 id="53æµ‹è¯•è¿æ¥"><a class="markdownIt-Anchor" href="#53æµ‹è¯•è¿æ¥"></a> 5.3æµ‹è¯•è¿æ¥</h2><img src="https://gitee.com/linhaipengg/md_-picture/raw/master/image-20231126171840588.png" alt="image-20231126171840588" style="zoom: 50%;" /><p>æµ‹è¯•ç»“æœï¼š</p><img src="https://gitee.com/linhaipengg/md_-picture/raw/master/image-20231126171738371.png" alt="image-20231126171738371" style="zoom: 50%;" /><h2 id="54æµ‹è¯•ä½¿ç”¨"><a class="markdownIt-Anchor" href="#54æµ‹è¯•ä½¿ç”¨"></a> 5.4æµ‹è¯•ä½¿ç”¨</h2><h3 id="541ç´¢å¼•æ–°å¢è®°å½•"><a class="markdownIt-Anchor" href="#541ç´¢å¼•æ–°å¢è®°å½•"></a> 5.4.1ç´¢å¼•(æ–°å¢)è®°å½•</h3><img src="https://gitee.com/linhaipengg/md_-picture/raw/master/image-20231126223459965.png" alt="image-20231126223459965" style="zoom: 50%;" /><ul><li>æµ‹è¯•ç»“æœ</li></ul><img src="https://gitee.com/linhaipengg/md_-picture/raw/master/image-20231126181349680.png" alt="image-20231126181349680" style="zoom: 50%;" /><h3 id="542è·å–æ•°æ®"><a class="markdownIt-Anchor" href="#542è·å–æ•°æ®"></a> 5.4.2è·å–æ•°æ®</h3><img src="https://gitee.com/linhaipengg/md_-picture/raw/master/image-20231126223642236.png" alt="image-20231126223642236" style="zoom: 50%;" /><figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#match å­—ç¬¦ä¸²ç±»å‹å…¨æ–‡æ£€ç´¢</span></span><br><span class="line"><span class="string">GET</span> <span class="string">bank/_search</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="attr">&quot;query&quot;:</span> &#123;</span><br><span class="line">    <span class="attr">&quot;match&quot;:</span> &#123;</span><br><span class="line">      <span class="attr">&quot;address&quot;:</span> <span class="string">&quot;mill&quot;</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><blockquote><p>ä¸¤ä¸ªæŸ¥è¯¢ç»“æœç›¸åŒ</p></blockquote><h3 id="543èšåˆæŸ¥è¯¢"><a class="markdownIt-Anchor" href="#543èšåˆæŸ¥è¯¢"></a> 5.4.3èšåˆæŸ¥è¯¢</h3><img src="https://gitee.com/linhaipengg/md_-picture/raw/master/image-20231126224123565.png" alt="image-20231126224123565" style="zoom:50%;" /><img src="https://gitee.com/linhaipengg/md_-picture/raw/master/image-20231126224024399.png" alt="image-20231126224024399" style="zoom:50%;" /><h3 id="544ç»“æœè½¬ä¸ºå¯¹è±¡"><a class="markdownIt-Anchor" href="#544ç»“æœè½¬ä¸ºå¯¹è±¡"></a> 5.4.4ç»“æœè½¬ä¸ºå¯¹è±¡</h3><blockquote><p>å…·ä½“ç»“æœåœ¨ä¸‹é¢é‚£ä¸ªhitsé‡Œ</p></blockquote><img src="https://gitee.com/linhaipengg/md_-picture/raw/master/image-20231126224247804.png" alt="image-20231126224247804" style="zoom:50%;" /><blockquote><p>åˆ©ç”¨jsonç”Ÿæˆjavabean,å¹¶ä½¿ç”¨lombok</p></blockquote><img src="https://gitee.com/linhaipengg/md_-picture/raw/master/image-20231126224421195.png" alt="image-20231126224421195" style="zoom:50%;" /><ul><li>æµ‹è¯•</li></ul><img src="https://gitee.com/linhaipengg/md_-picture/raw/master/image-20231126224706454.png" alt="image-20231126224706454" style="zoom: 67%;" /><ul><li>ç»“æœ</li></ul><p><img src="https://gitee.com/linhaipengg/md_-picture/raw/master/image-20231126224630489.png" alt="image-20231126224630489" /></p>]]></content>
    
    
      
      
    <summary type="html">&lt;link rel=&quot;stylesheet&quot; class=&quot;aplayer-secondary-style-marker&quot; href=&quot;&#92;assets&#92;css&#92;APlayer.min.css&quot;&gt;&lt;script src=&quot;&#92;assets&#92;js&#92;APlayer.min.js&quot; cla</summary>
      
    
    
    
    <category term="ã€æŠ€æœ¯æ ˆå­¦ä¹ ã€‘" scheme="https://www.haipeng-lin.cn/categories/%E3%80%90%E6%8A%80%E6%9C%AF%E6%A0%88%E5%AD%A6%E4%B9%A0%E3%80%91/"/>
    
    
    <category term="SpringBoot" scheme="https://www.haipeng-lin.cn/tags/SpringBoot/"/>
    
  </entry>
  
  <entry>
    <title>RocketMQå­¦ä¹ ç¬”è®°</title>
    <link href="https://www.haipeng-lin.cn/posts/6982816f.html"/>
    <id>https://www.haipeng-lin.cn/posts/6982816f.html</id>
    <published>2024-10-13T09:17:30.000Z</published>
    <updated>2024-10-14T06:44:07.399Z</updated>
    
    <content type="html"><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="\assets\css\APlayer.min.css"><script src="\assets\js\APlayer.min.js" class="aplayer-secondary-script-marker"></script><h2 id="1rocketmqæ˜¯ä»€ä¹ˆ"><a class="markdownIt-Anchor" href="#1rocketmqæ˜¯ä»€ä¹ˆ"></a> 1.RocketMQæ˜¯ä»€ä¹ˆï¼Ÿ</h2><p>â€‹â€ƒâ€ƒé˜¿é‡Œå¼€æºçš„ä¸€æ¬¾çš„æ¶ˆæ¯ä¸­é—´ä»¶ï¼Œçº¯Javaå¼€å‘ï¼Œå…·æœ‰<strong>é«˜ååé‡ã€é«˜å¯ç”¨æ€§</strong>ã€é€‚åˆ<strong>å¤§è§„æ¨¡åˆ†å¸ƒå¼ç³»ç»Ÿ</strong>åº”ç”¨çš„ç‰¹ç‚¹ï¼Œæ€§èƒ½å¼ºåŠ²(é›¶æ‹·è´æŠ€æœ¯)ï¼Œæ”¯æŒæµ·é‡å †ç§¯ï¼Œæ”¯æŒæŒ‡å®šæ¬¡æ•°å’Œæ—¶é—´é—´éš”çš„å¤±è´¥ï¼Œæ¶ˆæ¯é‡å‘,æ”¯æŒconsumerç«¯tagè¿‡æ»¤ã€å»¶è¿Ÿæ¶ˆæ¯ç­‰ï¼Œåœ¨é˜¿é‡Œå†…éƒ¨è¿›è¡Œå¤§è§„æ¨¡ä½¿ç”¨ï¼Œé€‚åˆåœ¨<strong>ç”µå•†ï¼Œäº’è”ç½‘é‡‘è</strong>ç­‰é¢†åŸŸä½¿ç”¨</p><h2 id="2rocketmqæ¶æ„è®¾è®¡"><a class="markdownIt-Anchor" href="#2rocketmqæ¶æ„è®¾è®¡"></a> 2.RocketMQæ¶æ„è®¾è®¡</h2><h3 id="21æŠ€æœ¯æ¶æ„"><a class="markdownIt-Anchor" href="#21æŠ€æœ¯æ¶æ„"></a> 2.1æŠ€æœ¯æ¶æ„</h3><p>RocketMQæ¶æ„ä¸»è¦ç”±å››éƒ¨åˆ†ç»„æˆï¼Œå¯åœ¨2.2éƒ¨ç½²æ¶æ„è§RocketMQé›†ç¾¤éƒ¨ç½²å›¾</p><ul><li><strong>Producerï¼šæ¶ˆæ¯ç”Ÿäº§è€…</strong>ï¼Œå¯é›†ç¾¤éƒ¨ç½²ã€‚ä¼šå…ˆå’Œ NameServer é›†ç¾¤ä¸­çš„éšæœºä¸€å°å»ºç«‹é•¿è¿æ¥ï¼Œå¾—çŸ¥å½“å‰è¦å‘é€çš„ Topic å­˜åœ¨å“ªå° Broker Masterä¸Šï¼Œç„¶åå†ä¸å…¶å»ºç«‹é•¿è¿æ¥ï¼Œå®šæ—¶å‘Brokerå‘é€å¿ƒè·³ã€‚åŒæ—¶æ”¯æŒå¤šç§è´Ÿè½½å¹³è¡¡æ¨¡å¼å‘é€æ¶ˆæ¯ã€‚</li><li><strong>Consumerï¼šæ¶ˆæ¯æ¶ˆè´¹è€…</strong>ï¼Œå¯ä»¥é›†ç¾¤éƒ¨ç½²ã€‚ä¼šå…ˆå’Œ NameServer é›†ç¾¤ä¸­çš„éšæœºä¸€å°å»ºç«‹é•¿è¿æ¥ï¼Œå¾—çŸ¥å½“å‰è¦æ¶ˆæ¯çš„ Topic å­˜åœ¨å“ªå° Broker Masterã€Slaveä¸Šï¼Œç„¶åå®ƒä»¬å»ºç«‹é•¿è¿æ¥ï¼Œå®šæ—¶å‘Brokerå‘é€å¿ƒè·³ã€‚åŒæ—¶æ”¯æŒé›†ç¾¤æ¶ˆè´¹å’Œå¹¿æ’­æ¶ˆè´¹æ¶ˆæ¯ã€‚</li><li><strong>Brokerï¼šä¸»è¦è´Ÿè´£æ¶ˆæ¯çš„å­˜å‚¨ã€æŸ¥è¯¢æ¶ˆè´¹</strong>ï¼Œæ”¯æŒä¸»ä»éƒ¨ç½²ï¼Œä¸€ä¸ª Master å¯ä»¥å¯¹åº”å¤šä¸ª Slaveã€‚Master æ”¯æŒè¯»å†™ï¼ŒSlave åªæ”¯æŒè¯»ã€‚Broker ä¼šå‘é›†ç¾¤ä¸­çš„æ¯ä¸€å° NameServer æ³¨å†Œè‡ªå·±çš„è·¯ç”±ä¿¡æ¯ã€‚å®šæœŸ30så‘NameServerä¸ŠæŠ¥Topicè·¯ç”±ä¿¡æ¯ã€‚</li><li><strong>NameServerï¼šæ˜¯Topic è·¯ç”±æ³¨å†Œä¸­å¿ƒ</strong>ï¼Œæ”¯æŒ Broker çš„åŠ¨æ€æ³¨å†Œå’Œå‘ç°ï¼Œä¿å­˜ Topic å’Œ Borker ä¹‹é—´çš„å…³ç³»ã€‚ä¹Ÿæ˜¯é›†ç¾¤éƒ¨ç½²ï¼Œä½†æ˜¯å„ NameServer ä¹‹é—´ä¸ä¼šäº’ç›¸é€šä¿¡ï¼Œ å„ NameServer éƒ½æœ‰å®Œæ•´çš„è·¯ç”±ä¿¡æ¯ï¼Œå³æ— çŠ¶æ€ã€‚</li></ul><p>RocketMQçš„Brokerã€Topicã€Queueçš„å¯¹åº”å…³ç³»ï¼š</p><ul><li>ä¸€ä¸ªTopicä¸»é¢˜å¯ä»¥å­˜å‚¨äºå¤šä¸ªBrokerä¸­</li><li>ä¸€ä¸ªTopicä¸»é¢˜ç”±å¤šä¸ªQueueé˜Ÿåˆ—ç»„æˆã€‚æ¯ä¸ªTopicåˆ†ç‰‡ç­‰åˆ†çš„Queueçš„æ•°é‡å¯ä»¥ä¸åŒï¼Œç”±ç”¨æˆ·åœ¨åˆ›å»ºTopicæ—¶æŒ‡å®šï¼›</li></ul><img src="https://haipeng-lin.oss-cn-shenzhen.aliyuncs.com/202410131634180.png" alt="RocketMQçš„Brokerç»„ç»‡å›¾.drawio" style="zoom:33%;" /><h3 id="22éƒ¨ç½²æ¶æ„"><a class="markdownIt-Anchor" href="#22éƒ¨ç½²æ¶æ„"></a> 2.2éƒ¨ç½²æ¶æ„</h3><p>RocketMQçš„Brokeræœ‰ä¸‰ç§éƒ¨ç½²æ–¹å¼ï¼š</p><ul><li>å•å°Masteréƒ¨ç½²ï¼›</li><li>å¤šå°Masteréƒ¨ç½²ï¼›</li><li>å¤šMasterå¤šSlaveéƒ¨ç½²ï¼Œåˆå¯åˆ†ä¸ºä»¥ä¸‹ä¸¤ç§æ¨¡å¼ï¼ˆåŒæ­¥æ–¹å¼ï¼šåŒæ­¥å¤åˆ¶å’Œå¼‚æ­¥å¤åˆ¶ï¼ˆæŒ‡çš„ä¸€ç»„ master å’Œ slave ä¹‹é—´æ•°æ®çš„åŒæ­¥ï¼‰<ul><li>å¤š master å¤š slave <strong>å¼‚æ­¥</strong>å¤åˆ¶æ¨¡å¼</li><li>å¤š master å¤š slave <strong>åŒæ­¥</strong>å¤åˆ¶æ¨¡å¼</li></ul></li></ul><p>åŸºç¡€çš„Rocketé«˜å¯ç”¨ï¼Œä¸»è¦é‡‡ç”¨ç¬¬3ç§éƒ¨ç½²æ–¹å¼ï¼Œå¦‚å›¾æ‰€ç¤º</p><p><img src="https://haipeng-lin.oss-cn-shenzhen.aliyuncs.com/202410131146937.jpeg" alt="img" /></p><h3 id="23å·¥ä½œæµç¨‹"><a class="markdownIt-Anchor" href="#23å·¥ä½œæµç¨‹"></a> 2.3å·¥ä½œæµç¨‹</h3><p>ç»“åˆéƒ¨ç½²æ¶æ„å›¾ï¼Œæè¿°é›†ç¾¤å·¥ä½œæµç¨‹ï¼š</p><ol><li>å¯åŠ¨NameServerï¼ŒNameServerèµ·æ¥åç›‘å¬ç«¯å£ï¼Œç­‰å¾…Brokerã€Producerã€Consumerè¿ä¸Šæ¥ï¼Œç›¸å½“äºä¸€ä¸ªè·¯ç”±æ§åˆ¶ä¸­å¿ƒã€‚</li><li>Brokerå¯åŠ¨ï¼Œè·Ÿæ‰€æœ‰çš„NameServerä¿æŒé•¿è¿æ¥ï¼Œå®šæ—¶å‘é€å¿ƒè·³åŒ…ã€‚å¿ƒè·³åŒ…ä¸­åŒ…å«å½“å‰Brokerä¿¡æ¯(IP+ç«¯å£ç­‰)ä»¥åŠå­˜å‚¨æ‰€æœ‰Topicä¿¡æ¯ã€‚æ³¨å†ŒæˆåŠŸåï¼ŒNameServeré›†ç¾¤ä¸­å°±æœ‰Topicè·ŸBrokerçš„æ˜ å°„å…³ç³»ã€‚</li><li>æ”¶å‘æ¶ˆæ¯å‰ï¼Œå…ˆ<strong>åˆ›å»ºTopicï¼ˆä¸»é¢˜åå­—ï¼Œä¸€ä¸ªTopicç”±è‹¥å¹²Queueç»„æˆï¼‰</strong>ï¼Œåˆ›å»ºTopicæ—¶éœ€è¦<strong>æŒ‡å®šè¯¥Topicè¦å­˜å‚¨åœ¨å“ªäº›Broker</strong>ä¸Šï¼Œä¹Ÿå¯ä»¥åœ¨å‘é€æ¶ˆæ¯æ—¶è‡ªåŠ¨åˆ›å»ºTopicã€‚</li><li>Producerå‘é€æ¶ˆæ¯ï¼Œå¯åŠ¨æ—¶å…ˆè·ŸNameServeré›†ç¾¤ä¸­çš„å…¶ä¸­ä¸€å°å»ºç«‹é•¿è¿æ¥ï¼Œå¹¶<strong>ä»NameServerä¸­è·å–å½“å‰å‘é€çš„Topicå­˜åœ¨å“ªäº›Brokerä¸Š</strong>ï¼Œè½®è¯¢ä»é˜Ÿåˆ—åˆ—è¡¨ä¸­é€‰æ‹©ä¸€ä¸ªé˜Ÿåˆ—ï¼Œç„¶åä¸é˜Ÿåˆ—æ‰€åœ¨çš„Brokerå»ºç«‹é•¿è¿æ¥ä»è€Œå‘Brokerå‘æ¶ˆæ¯ã€‚</li><li>Consumerè·ŸProducerç±»ä¼¼ï¼Œè·Ÿå…¶ä¸­ä¸€å°NameServerå»ºç«‹é•¿è¿æ¥ï¼Œè·å–<strong>å½“å‰è®¢é˜…Topicå­˜åœ¨å“ªäº›Brokerä¸Š</strong>ï¼Œç„¶åç›´æ¥è·ŸBrokerå»ºç«‹è¿æ¥é€šé“ï¼Œå¼€å§‹æ¶ˆè´¹æ¶ˆæ¯ã€‚</li></ol><h2 id="3rocketmqæ”¯æŒé«˜å¯ç”¨"><a class="markdownIt-Anchor" href="#3rocketmqæ”¯æŒé«˜å¯ç”¨"></a> 3.RocketMQæ”¯æŒé«˜å¯ç”¨</h2><p>å¯åˆ†ä¸ºNameServeré«˜å¯ç”¨ã€BrokerServeré«˜å¯ç”¨ã€Produceré«˜å¯ç”¨ã€Consumeré«˜å¯ç”¨</p><h3 id="31nameserveré«˜å¯ç”¨"><a class="markdownIt-Anchor" href="#31nameserveré«˜å¯ç”¨"></a> 3.1NameServeré«˜å¯ç”¨</h3><p>â€ƒâ€ƒç”±äº NameServer èŠ‚ç‚¹æ˜¯<strong>æ— çŠ¶æ€</strong>çš„ï¼Œä¸”å„ä¸ªèŠ‚ç‚¹ç›´æ¥çš„<strong>æ•°æ®æ˜¯ä¸€è‡´</strong>çš„ï¼Œæ•…å­˜åœ¨å¤šä¸ª NameServer èŠ‚ç‚¹çš„æƒ…å†µä¸‹ï¼Œéƒ¨åˆ† NameServer ä¸å¯ç”¨ä¹Ÿå¯ä»¥ä¿è¯ MQ æœåŠ¡æ­£å¸¸è¿è¡Œ</p><h3 id="32brokerserveré«˜å¯ç”¨"><a class="markdownIt-Anchor" href="#32brokerserveré«˜å¯ç”¨"></a> 3.2BrokerServeré«˜å¯ç”¨</h3><p>â€ƒâ€ƒRocketMQæ˜¯é€šè¿‡ <strong>Master å’Œ Slave çš„é…åˆ</strong>è¾¾åˆ° BrokerServer æ¨¡å—çš„é«˜å¯ç”¨æ€§çš„</p><p>ä¸€ä¸ª Master å¯ä»¥é…ç½®å¤šä¸ª Slaveï¼ŒåŒæ—¶ä¹Ÿæ”¯æŒé…ç½®å¤šä¸ª Master-Slave ç»„ã€‚</p><h3 id="33produceré«˜å¯ç”¨"><a class="markdownIt-Anchor" href="#33produceré«˜å¯ç”¨"></a> 3.3Produceré«˜å¯ç”¨</h3><p>â€‹åœ¨åˆ›å»ºTopicçš„æ—¶å€™ï¼ŒæŠŠ<strong>Topicçš„å¤šä¸ªMessage Queueåˆ›å»ºåœ¨å¤šä¸ªBrokerç»„ä¸Š</strong>ï¼ˆç›¸åŒBrokeråç§°ï¼Œä¸åŒ brokerIdçš„æœºå™¨ç»„æˆä¸€ä¸ªBrokerç»„ï¼‰</p><p>â€‹è¿™æ ·å½“ä¸€ä¸ªBrokerç»„çš„Masterä¸å¯ç”¨åï¼Œå…¶ä»–ç»„çš„Masterä»ç„¶å¯ç”¨ï¼ŒProducerä»ç„¶å¯ä»¥å‘é€æ¶ˆæ¯ã€‚</p><h3 id="34consumeré«˜å¯ç”¨"><a class="markdownIt-Anchor" href="#34consumeré«˜å¯ç”¨"></a> 3.4Consumeré«˜å¯ç”¨</h3><p>â€ƒâ€ƒConsumer çš„é«˜å¯ç”¨æ˜¯ä¾èµ–äº Master-Slave é…ç½®çš„ï¼Œç”±äº Master èƒ½å¤Ÿæ”¯æŒè¯»å†™æ¶ˆæ¯ï¼ŒSlave æ”¯æŒè¯»æ¶ˆæ¯ï¼Œå½“ Master ä¸å¯ç”¨æˆ–ç¹å¿™æ—¶ï¼Œ Consumer ä¼šè¢«è‡ªåŠ¨åˆ‡æ¢åˆ°ä» Slave è¯»å–(è‡ªåŠ¨åˆ‡æ¢ï¼Œæ— éœ€é…ç½®)ã€‚</p><p>â€ƒâ€ƒæ•…å½“ Master çš„æœºå™¨æ•…éšœåï¼Œæ¶ˆæ¯ä»å¯ä» Slave ä¸­è¢«æ¶ˆè´¹</p><h2 id="4äº”ç§æ¶ˆæ¯ç±»å‹"><a class="markdownIt-Anchor" href="#4äº”ç§æ¶ˆæ¯ç±»å‹"></a> 4.äº”ç§æ¶ˆæ¯ç±»å‹</h2><ol><li><strong>æ™®é€šæ¶ˆæ¯ï¼š</strong> æ™®é€šæ¶ˆæ¯ä¹Ÿç§°ä¸ºå¹¶å‘æ¶ˆæ¯ï¼Œå’Œä¼ ç»Ÿçš„é˜Ÿåˆ—ç›¸æ¯”ï¼Œå¹¶å‘æ¶ˆæ¯æ²¡æœ‰é¡ºåºï¼Œ ä½†æ˜¯ç”Ÿäº§æ¶ˆè´¹éƒ½æ˜¯å¹¶è¡Œè¿›è¡Œçš„ï¼Œå•æœºæ€§èƒ½å¯è¾¾åä¸‡çº§åˆ«çš„TPSã€‚</li><li><strong>åˆ†åŒºæœ‰åºæ¶ˆæ¯ï¼š</strong> ä¸Kafkaä¸­çš„åˆ†åŒºç±»ä¼¼ï¼ŒæŠŠä¸€ä¸ªTopicæ¶ˆæ¯åˆ†ä¸ºå¤šä¸ªåˆ†åŒºâ€œä¿ å­˜â€å’Œæ¶ˆè´¹ï¼Œåœ¨ä¸€ä¸ªåˆ†åŒºå†…çš„æ¶ˆæ¯å°±æ˜¯ä¼ ç»Ÿçš„é˜Ÿåˆ—ï¼Œéµå¾ªFIFOï¼ˆå…ˆè¿›å…ˆå‡ºï¼‰åŸåˆ™ã€‚</li><li><strong>å…¨å±€æœ‰åºæ¶ˆæ¯ï¼š</strong> å¦‚æœæŠŠä¸€ä¸ª Topic çš„åˆ†åŒºæ•°è®¾ç½®ä¸º 1ï¼Œé‚£ä¹ˆè¯¥ Topic ä¸­çš„æ¶ˆæ¯ å°±æ˜¯å•åˆ†åŒºï¼Œæ‰€æœ‰æ¶ˆæ¯éƒ½éµå¾ªFIFOï¼ˆå…ˆè¿›å…ˆå‡ºï¼‰çš„åŸåˆ™ã€‚</li><li><strong>å»¶è¿Ÿæ¶ˆæ¯ï¼š</strong> æ¶ˆæ¯å‘é€åï¼Œæ¶ˆè´¹è€…è¦åœ¨ä¸€å®šæ—¶é—´åï¼Œæˆ–è€…æŒ‡å®šæŸä¸ªæ—¶é—´ç‚¹æ‰å¯ä»¥æ¶ˆ è´¹ã€‚åœ¨æ²¡æœ‰å»¶è¿Ÿæ¶ˆæ¯æ—¶ï¼ŒåŸºæœ¬çš„åšæ³•æ˜¯åŸºäºå®šæ—¶è®¡åˆ’ä»»åŠ¡è°ƒåº¦ï¼Œå®šæ—¶å‘é€æ¶ˆæ¯ã€‚åœ¨ RocketMQä¸­åªéœ€è¦åœ¨å‘é€æ¶ˆæ¯æ—¶è®¾ç½®å»¶è¿Ÿçº§åˆ«å³å¯å®ç°ã€‚</li><li><strong>äº‹åŠ¡æ¶ˆæ¯ï¼š</strong> ä¸»è¦æ¶‰åŠåˆ†å¸ƒå¼äº‹åŠ¡ï¼Œå³éœ€è¦ä¿è¯åœ¨å¤šä¸ªæ“ä½œåŒæ—¶æˆåŠŸæˆ–è€…åŒæ—¶å¤±è´¥ æ—¶ï¼Œæ¶ˆè´¹è€…æ‰èƒ½æ¶ˆè´¹æ¶ˆæ¯ã€‚RocketMQé€šè¿‡å‘é€Halfæ¶ˆæ¯ã€å¤„ç†æœ¬åœ°äº‹åŠ¡ã€æäº¤ ï¼ˆCommitï¼‰æ¶ˆæ¯æˆ–è€…å›æ»šï¼ˆRollbackï¼‰æ¶ˆæ¯ä¼˜é›…åœ°å®ç°åˆ†å¸ƒå¼äº‹åŠ¡</li></ol><h2 id="5å®‰è£…rocketmq"><a class="markdownIt-Anchor" href="#5å®‰è£…rocketmq"></a> 5.å®‰è£…RocketMQ</h2><p>è§ç¯å¢ƒé…ç½®æ€»ç»“ç¯‡çš„RocketMQ</p><h2 id="6springbootæ•´åˆrocketmq"><a class="markdownIt-Anchor" href="#6springbootæ•´åˆrocketmq"></a> 6.SpringBootæ•´åˆRocketMQ</h2><h3 id="61xmlé…ç½®"><a class="markdownIt-Anchor" href="#61xmlé…ç½®"></a> 6.1xmlé…ç½®</h3><p>åœ¨pom.xmlå¼•å…¥ä¾èµ–</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.apache.rocketmq<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>rocketmq-spring-boot-starter<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>2.0.4<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"> <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure><h3 id="62ymlé…ç½®"><a class="markdownIt-Anchor" href="#62ymlé…ç½®"></a> 6.2ymlé…ç½®</h3><figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">rocketmq:</span></span><br><span class="line">  <span class="attr">name-server:</span> <span class="number">192.168</span><span class="number">.1</span><span class="number">.224</span><span class="string">:9876</span> <span class="comment"># è®¿é—®åœ°å€</span></span><br><span class="line">  <span class="attr">producer:</span></span><br><span class="line">    <span class="attr">group:</span> <span class="string">Pro_Group</span> <span class="comment"># å¿…é¡»æŒ‡å®šgroup</span></span><br><span class="line">    <span class="attr">send-message-timeout:</span> <span class="number">3000</span> <span class="comment"># æ¶ˆæ¯å‘é€è¶…æ—¶æ—¶é•¿ï¼Œé»˜è®¤3s</span></span><br><span class="line">    <span class="attr">retry-times-when-send-failed:</span> <span class="number">3</span> <span class="comment"># åŒæ­¥å‘é€æ¶ˆæ¯å¤±è´¥é‡è¯•æ¬¡æ•°ï¼Œé»˜è®¤2</span></span><br><span class="line">    <span class="attr">retry-times-when-send-async-failed:</span> <span class="number">3</span> <span class="comment"># å¼‚æ­¥å‘é€æ¶ˆæ¯å¤±è´¥é‡è¯•æ¬¡æ•°ï¼Œé»˜è®¤2</span></span><br></pre></td></tr></table></figure><h3 id="63ç¼–å†™ç”Ÿäº§è€…"><a class="markdownIt-Anchor" href="#63ç¼–å†™ç”Ÿäº§è€…"></a> 6.3ç¼–å†™ç”Ÿäº§è€…</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Slf4j</span></span><br><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MQProducerService</span> &#123;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Value(&quot;$&#123;rocketmq.producer.send-message-timeout&#125;&quot;)</span></span><br><span class="line">    <span class="keyword">private</span> Integer messageTimeOut;</span><br><span class="line"></span><br><span class="line"><span class="comment">// å»ºè®®æ­£å¸¸è§„æ¨¡é¡¹ç›®ç»Ÿä¸€ç”¨ä¸€ä¸ªTOPIC</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">topic</span> <span class="operator">=</span> <span class="string">&quot;RLT_TEST_TOPIC&quot;</span>;</span><br><span class="line">    </span><br><span class="line"><span class="comment">// ç›´æ¥æ³¨å…¥ä½¿ç”¨ï¼Œç”¨äºå‘é€æ¶ˆæ¯åˆ°brokeræœåŠ¡å™¨</span></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> RocketMQTemplate rocketMQTemplate;</span><br><span class="line">    </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><blockquote><p>æ™®é€šå‘é€</p></blockquote><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">* æ™®é€šå‘é€ï¼ˆä¸»é¢˜Topic+Messageæ¶ˆæ¯ï¼‰</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">send</span><span class="params">(User user)</span> &#123;</span><br><span class="line">rocketMQTemplate.convertAndSend(topic, user);</span><br><span class="line"><span class="comment">//  rocketMQTemplate.send(topic, MessageBuilder.withPayload(user).build()); // ç­‰ä»·äºä¸Šé¢ä¸€è¡Œ</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><blockquote><p>å‘é€åŒæ­¥æ¶ˆæ¯</p></blockquote><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">* å‘é€åŒæ­¥æ¶ˆæ¯ï¼ˆé˜»å¡å½“å‰çº¿ç¨‹ï¼Œç­‰å¾…brokerå“åº”å‘é€ç»“æœï¼Œè¿™æ ·ä¸å¤ªå®¹æ˜“ä¸¢å¤±æ¶ˆæ¯ï¼‰</span></span><br><span class="line"><span class="comment">* ï¼ˆmsgBodyä¹Ÿå¯ä»¥æ˜¯å¯¹è±¡ï¼ŒsendResultä¸ºè¿”å›çš„å‘é€ç»“æœï¼‰</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="keyword">public</span> SendResult <span class="title function_">sendMsg</span><span class="params">(String msgBody)</span> &#123;</span><br><span class="line">    <span class="type">SendResult</span> <span class="variable">sendResult</span> <span class="operator">=</span> rocketMQTemplate.syncSend(topic, MessageBuilder.withPayload(msgBody).build());</span><br><span class="line">    log.info(<span class="string">&quot;ã€sendMsgã€‘sendResult=&#123;&#125;&quot;</span>, JSON.toJSONString(sendResult));</span><br><span class="line">    <span class="keyword">return</span> sendResult;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><blockquote><p>å‘é€å¼‚æ­¥æ¶ˆæ¯</p></blockquote><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">  * å‘é€å¼‚æ­¥æ¶ˆæ¯ï¼ˆé€šè¿‡çº¿ç¨‹æ± æ‰§è¡Œå‘é€åˆ°brokerçš„æ¶ˆæ¯ä»»åŠ¡ï¼Œæ‰§è¡Œå®Œåå›è°ƒï¼šåœ¨SendCallbackä¸­å¯å¤„ç†ç›¸å…³æˆåŠŸå¤±è´¥æ—¶çš„é€»è¾‘ï¼‰</span></span><br><span class="line"><span class="comment">  * ï¼ˆé€‚åˆå¯¹å“åº”æ—¶é—´æ•æ„Ÿçš„ä¸šåŠ¡åœºæ™¯ï¼‰</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">sendAsyncMsg</span><span class="params">(String msgBody)</span> &#123;</span><br><span class="line">    rocketMQTemplate.asyncSend(topic, MessageBuilder.withPayload(msgBody).build(), <span class="keyword">new</span> <span class="title class_">SendCallback</span>() &#123;</span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onSuccess</span><span class="params">(SendResult sendResult)</span> &#123;</span><br><span class="line">            <span class="comment">// å¤„ç†æ¶ˆæ¯å‘é€æˆåŠŸé€»è¾‘</span></span><br><span class="line">        &#125;</span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onException</span><span class="params">(Throwable throwable)</span> &#123;</span><br><span class="line">            <span class="comment">// å¤„ç†æ¶ˆæ¯å‘é€å¼‚å¸¸é€»è¾‘</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><blockquote><p>å‘é€å»¶æ—¶æ¶ˆæ¯</p></blockquote><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">* å‘é€å»¶æ—¶æ¶ˆæ¯ï¼ˆä¸Šé¢çš„å‘é€åŒæ­¥æ¶ˆæ¯ï¼ŒdelayLevelçš„å€¼å°±ä¸º0ï¼Œå› ä¸ºä¸å»¶æ—¶ï¼‰</span></span><br><span class="line"><span class="comment">* åœ¨startç‰ˆæœ¬ä¸­ å»¶æ—¶æ¶ˆæ¯ä¸€å…±åˆ†ä¸º18ä¸ªç­‰çº§åˆ†åˆ«ä¸ºï¼š1s 5s 10s 30s 1m 2m 3m 4m 5m 6m 7m 8m 9m 10m 20m 30m 1h 2h</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">sendDelayMsg</span><span class="params">(String msgBody, <span class="type">int</span> delayLevel)</span> &#123;</span><br><span class="line">    rocketMQTemplate.syncSend(topic, MessageBuilder.withPayload(msgBody).build(), messageTimeOut, delayLevel);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><blockquote><p>å‘é€å•å‘æ¶ˆæ¯</p></blockquote><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">  * å‘é€å•å‘æ¶ˆæ¯ï¼ˆåªè´Ÿè´£å‘é€æ¶ˆæ¯ï¼Œä¸ç­‰å¾…åº”ç­”ï¼Œä¸å…³å¿ƒå‘é€ç»“æœï¼Œå¦‚æ—¥å¿—ï¼‰</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">sendOneWayMsg</span><span class="params">(String msgBody)</span> &#123;</span><br><span class="line">    rocketMQTemplate.sendOneWay(topic, MessageBuilder.withPayload(msgBody).build());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><blockquote><p>å‘é€å¸¦æ ‡ç­¾æ¶ˆæ¯</p></blockquote><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">  * å‘é€å¸¦tagçš„æ¶ˆæ¯ï¼Œç›´æ¥åœ¨topicåé¢åŠ ä¸Š&quot;:tag&quot;</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="keyword">public</span> SendResult <span class="title function_">sendTagMsg</span><span class="params">(String msgBody)</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> rocketMQTemplate.syncSend(topic + <span class="string">&quot;:tag2&quot;</span>, MessageBuilder.withPayload(msgBody).build());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="64ç¼–å†™æ¶ˆè´¹è€…"><a class="markdownIt-Anchor" href="#64ç¼–å†™æ¶ˆè´¹è€…"></a> 6.4ç¼–å†™æ¶ˆè´¹è€…</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Slf4j</span></span><br><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MQConsumerService</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// topicéœ€è¦å’Œç”Ÿäº§è€…çš„topicä¸€è‡´ï¼ŒconsumerGroupå±æ€§æ˜¯å¿…é¡»æŒ‡å®šçš„ï¼Œå†…å®¹å¯ä»¥éšæ„</span></span><br><span class="line">    <span class="comment">// selectorExpressionçš„æ„æ€æŒ‡çš„å°±æ˜¯tagï¼Œé»˜è®¤ä¸ºâ€œ*â€ï¼Œä¸è®¾ç½®çš„è¯ä¼šç›‘å¬æ‰€æœ‰æ¶ˆæ¯</span></span><br><span class="line">    <span class="meta">@Service</span></span><br><span class="line">    <span class="meta">@RocketMQMessageListener(topic = &quot;RLT_TEST_TOPIC&quot;, selectorExpression = &quot;tag1&quot;, consumerGroup = &quot;Con_Group_One&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ConsumerSend</span> <span class="keyword">implements</span> <span class="title class_">RocketMQListener</span>&lt;User&gt; &#123;</span><br><span class="line">        <span class="comment">// ç›‘å¬åˆ°æ¶ˆæ¯å°±ä¼šæ‰§è¡Œæ­¤æ–¹æ³•</span></span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onMessage</span><span class="params">(User user)</span> &#123;</span><br><span class="line">            log.info(<span class="string">&quot;ç›‘å¬åˆ°æ¶ˆæ¯ï¼šuser=&#123;&#125;&quot;</span>, JSON.toJSONString(user));</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// æ³¨æ„ï¼šè¿™ä¸ªConsumerSend2å’Œä¸Šé¢ConsumerSendåœ¨æ²¡æœ‰æ·»åŠ tagåšåŒºåˆ†æ—¶ï¼Œä¸èƒ½å…±å­˜ï¼Œ</span></span><br><span class="line">    <span class="comment">// ä¸ç„¶ç”Ÿäº§è€…å‘é€ä¸€æ¡æ¶ˆæ¯ï¼Œè¿™ä¸¤ä¸ªéƒ½ä¼šå»æ¶ˆè´¹ï¼Œå¦‚æœç±»å‹ä¸åŒä¼šæœ‰ä¸€ä¸ªæŠ¥é”™ï¼Œæ‰€ä»¥å®é™…è¿ç”¨ä¸­æœ€å¥½åŠ ä¸Štagï¼Œå†™è¿™åªæ˜¯è®©ä½ çœ‹çŸ¥é“å°±è¡Œ</span></span><br><span class="line">    <span class="meta">@Service</span></span><br><span class="line">    <span class="meta">@RocketMQMessageListener(topic = &quot;RLT_TEST_TOPIC&quot;, consumerGroup = &quot;Con_Group_Two&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ConsumerSend2</span> <span class="keyword">implements</span> <span class="title class_">RocketMQListener</span>&lt;String&gt; &#123;</span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onMessage</span><span class="params">(String str)</span> &#123;</span><br><span class="line">            log.info(<span class="string">&quot;ç›‘å¬åˆ°æ¶ˆæ¯ï¼šstr=&#123;&#125;&quot;</span>, str);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// MessageExtï¼šæ˜¯ä¸€ä¸ªæ¶ˆæ¯æ¥æ”¶é€šé…ç¬¦ï¼Œä¸ç®¡å‘é€çš„æ˜¯Stringè¿˜æ˜¯å¯¹è±¡ï¼Œéƒ½å¯æ¥æ”¶ï¼Œå½“ç„¶ä¹Ÿå¯ä»¥åƒä¸Šé¢æ˜ç¡®æŒ‡å®šç±»å‹ï¼ˆæˆ‘å»ºè®®è¿˜æ˜¯æŒ‡å®šç±»å‹è¾ƒæ–¹ä¾¿ï¼‰</span></span><br><span class="line">    <span class="meta">@Service</span></span><br><span class="line">    <span class="meta">@RocketMQMessageListener(topic = &quot;RLT_TEST_TOPIC&quot;, selectorExpression = &quot;tag2&quot;, consumerGroup = &quot;Con_Group_Three&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Consumer</span> <span class="keyword">implements</span> <span class="title class_">RocketMQListener</span>&lt;MessageExt&gt; &#123;</span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onMessage</span><span class="params">(MessageExt messageExt)</span> &#123;</span><br><span class="line">            <span class="type">byte</span>[] body = messageExt.getBody();</span><br><span class="line">            <span class="type">String</span> <span class="variable">msg</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">String</span>(body);</span><br><span class="line">            log.info(<span class="string">&quot;ç›‘å¬åˆ°æ¶ˆæ¯ï¼šmsg=&#123;&#125;&quot;</span>, msg);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="65æµ‹è¯•"><a class="markdownIt-Anchor" href="#65æµ‹è¯•"></a> 6.5æµ‹è¯•</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="meta">@RequestMapping(&quot;/rocketmq&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">RocketMQController</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> MQProducerService mqProducerService;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@GetMapping(&quot;/send&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">send</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="type">User</span> <span class="variable">user</span> <span class="operator">=</span> User.getUser();</span><br><span class="line">        mqProducerService.send(user);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@GetMapping(&quot;/sendTag&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> Result&lt;SendResult&gt; <span class="title function_">sendTag</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="type">SendResult</span> <span class="variable">sendResult</span> <span class="operator">=</span> mqProducerService.sendTagMsg(<span class="string">&quot;å¸¦æœ‰tagçš„å­—ç¬¦æ¶ˆæ¯&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> Result.success(sendResult);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>]]></content>
    
    
      
      
    <summary type="html">&lt;link rel=&quot;stylesheet&quot; class=&quot;aplayer-secondary-style-marker&quot; href=&quot;&#92;assets&#92;css&#92;APlayer.min.css&quot;&gt;&lt;script src=&quot;&#92;assets&#92;js&#92;APlayer.min.js&quot; cla</summary>
      
    
    
    
    <category term="ã€æ¶ˆæ¯é˜Ÿåˆ—ã€‘" scheme="https://www.haipeng-lin.cn/categories/%E3%80%90%E6%B6%88%E6%81%AF%E9%98%9F%E5%88%97%E3%80%91/"/>
    
    
  </entry>
  
  <entry>
    <title>æ”¶é›† | æœ‰æƒ…æ€€çš„ç½‘ç«™</title>
    <link href="https://www.haipeng-lin.cn/posts/d1f540b5.html"/>
    <id>https://www.haipeng-lin.cn/posts/d1f540b5.html</id>
    <published>2024-10-10T12:21:25.000Z</published>
    <updated>2024-10-13T09:22:54.018Z</updated>
    
    <content type="html"><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="\assets\css\APlayer.min.css"><script src="\assets\js\APlayer.min.js" class="aplayer-secondary-script-marker"></script><h1 id="1å‰è¨€"><a class="markdownIt-Anchor" href="#1å‰è¨€"></a> 1.å‰è¨€</h1><p>â€ƒâ€ƒæ­¤æ–‡ç”¨äºæ”¶è—æœ‰æƒ…æ€€çš„ç½‘ç«™ï¼Œå¦‚åŠå…¬ã€ç¼–ç¨‹ã€ä¼‘é—²ã€èµ„æºç­‰èµ„æº</p><h1 id="2åŠå…¬"><a class="markdownIt-Anchor" href="#2åŠå…¬"></a> 2.åŠå…¬</h1><ul><li><p>ğŸ¥‡ <a href="https://www.ypppt.com/">ä¼˜å“ppt</a></p></li><li><p>ğŸ¥ˆ <a href="https://www.ttfont.com/">å…è´¹å¤©å¤©å­—ä½“</a></p></li><li><p>ğŸ¥‰ <a href="https://xpdf.cn/pdf-to-word">pdfè½¬word</a></p></li><li><p>ğŸ§¡ <a href="https://app.diagrams.net/">DrawIOï¼šæµç¨‹å›¾</a></p></li><li><p>ğŸ’› <a href="https://js.design/workspace">å³æ—¶è®¾è®¡ï¼šå°é¢å›¾</a></p></li><li><p>ğŸ’š <a href="https://editor.ibaotu.com/complex/index">åŒ…å›¾è®¾è®¡ï¼šæµ·æŠ¥å›¾</a></p></li><li><p>ğŸ“• <a href="https://chat.chat826.com/#/home">Chat8</a></p></li><li><p>ğŸ“– <a href="https://chat18.aichatos68.com/#/chat/1728735290903">Chat18</a></p></li><li><p>ğŸ“— <a href="https://chat.openai.com/">ChatGPT</a></p></li><li><p>ğŸ“— <a href="https://xinghuo.xfyun.cn/">è®¯é£æ˜Ÿç«</a></p></li></ul><h1 id="3ç¼–ç¨‹"><a class="markdownIt-Anchor" href="#3ç¼–ç¨‹"></a> 3.ç¼–ç¨‹</h1><ul><li><p>ğŸ <a href="https://gitee.com/y_project/RuoYi">è‹¥ä¾æ¡†æ¶</a></p></li><li><p>ğŸ³ï¸â€ğŸŒˆ <a href="https://gitee.com/opentiny/tiny-vue">OpenTiny</a></p></li><li><p><a href="https://programmercarl.com/">ä»£ç éšæƒ³å½•</a></p></li><li><p><a href="https://leetcode.cn/">Leetcode</a></p></li></ul><h1 id="4ä¼‘é—²"><a class="markdownIt-Anchor" href="#4ä¼‘é—²"></a> 4.ä¼‘é—²</h1><ul><li><p>ğŸ“½ï¸ <a href="https://vidhub1.cc/">vidhub1</a></p></li><li><p>ğŸï¸ <a href="https://www.4ksj.com/4k-uhd-1.html">4kä¸–ç•Œ</a></p></li><li><p>ğŸ¥ <a href="https://www.meijutt.net/">ç¾å‰§å¤©å ‚</a></p></li><li><p>ğŸ¥° <a href="https://emoji6.com/emojiall/">emojy1</a></p></li><li><p>ğŸ˜ <a href="https:/lll/www.emojiall.com/zh-hans">enojy2</a></p></li></ul>]]></content>
    
    
      
      
    <summary type="html">&lt;link rel=&quot;stylesheet&quot; class=&quot;aplayer-secondary-style-marker&quot; href=&quot;&#92;assets&#92;css&#92;APlayer.min.css&quot;&gt;&lt;script src=&quot;&#92;assets&#92;js&#92;APlayer.min.js&quot; cla</summary>
      
    
    
    
    <category term="ã€éšç¬”ã€‘" scheme="https://www.haipeng-lin.cn/categories/%E3%80%90%E9%9A%8F%E7%AC%94%E3%80%91/"/>
    
    
  </entry>
  
  <entry>
    <title>ä¸ºä»€ä¹ˆHashMapçº¿ç¨‹ä¸å®‰å…¨</title>
    <link href="https://www.haipeng-lin.cn/posts/d0dd6ec8.html"/>
    <id>https://www.haipeng-lin.cn/posts/d0dd6ec8.html</id>
    <published>2024-10-10T04:24:58.000Z</published>
    <updated>2024-10-10T04:28:59.695Z</updated>
    
    <content type="html"><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="\assets\css\APlayer.min.css"><script src="\assets\js\APlayer.min.js" class="aplayer-secondary-script-marker"></script><h2 id="1å‰è¨€"><a class="markdownIt-Anchor" href="#1å‰è¨€"></a> 1.å‰è¨€</h2><p>é¦–å…ˆç»™å‡ºç»“è®ºï¼ŒHashMapåœ¨JDK1.7ã€1.8ä¸‹ï¼Œæ‰©å®¹å‡ä¼šå‡ºç°çº¿ç¨‹ä¸å®‰å…¨é—®é¢˜</p><ol><li><p>åœ¨JDK1.7ä¸­ï¼ŒHashMapä¼šå‡ºç°ä»¥ä¸‹ä¸‰ä¸ªé—®é¢˜ï¼š</p><ol><li>å¤šçº¿ç¨‹æ‰©å®¹ï¼Œå¤´æ’æ³•æ‰©å®¹ï¼Œå¼•èµ·çš„<strong>æ­»å¾ªç¯</strong>é—®é¢˜</li><li><strong>å¤šçº¿ç¨‹putçš„æ—¶å€™å¯èƒ½å¯¼è‡´å…ƒç´ ä¸¢å¤±</strong></li><li><strong>puténullå…ƒç´ ågetå‡ºæ¥çš„å´æ˜¯null</strong></li></ol></li><li><p>åœ¨JDK1.8ï¼Œæ”¹ç”¨å°¾æ’æ³•ï¼Œé¿å…äº§ç”Ÿæ­»å¾ªç¯é—®é¢˜ï¼Œä½†æ˜¯å¯èƒ½ä¼šå‡ºç°æ•°æ®è¦†ç›–é—®é¢˜</p></li></ol><h2 id="2jdk17æ‰©å®¹å¼•å‘çš„æ­»å¾ªç¯å’Œæ•°æ®ä¸¢å¤±"><a class="markdownIt-Anchor" href="#2jdk17æ‰©å®¹å¼•å‘çš„æ­»å¾ªç¯å’Œæ•°æ®ä¸¢å¤±"></a> 2.JDK1.7æ‰©å®¹å¼•å‘çš„æ­»å¾ªç¯å’Œæ•°æ®ä¸¢å¤±</h2><p>å½“å‰jdk1.7ç‰ˆæœ¬çš„HashMapçº¿ç¨‹ä¸å®‰å…¨ä¸»è¦æ˜¯å‘ç”Ÿåœ¨<strong>æ‰©å®¹å‡½æ•°</strong>ä¸­ï¼Œå…¶ä¸­è°ƒç”¨äº†HshMapçš„transfer()æ–¹æ³•</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//jdk 1.7çš„transferæ–¹æ³•ï¼ŒHashMapçš„æ‰©å®¹æ“ä½œ</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">transfer</span><span class="params">(Entry[] newTable, <span class="type">boolean</span> rehash)</span> &#123;</span><br><span class="line">    <span class="type">int</span> <span class="variable">newCapacity</span> <span class="operator">=</span> newTable.length;</span><br><span class="line">    <span class="keyword">for</span> (Entry&lt;K,V&gt; e : table) &#123;</span><br><span class="line">        <span class="keyword">while</span>(<span class="literal">null</span> != e) &#123;</span><br><span class="line">            Entry&lt;K,V&gt; next = e.next;<span class="comment">// ä¿å­˜ä¸‹ä¸€ä¸ªèŠ‚ç‚¹</span></span><br><span class="line">            <span class="keyword">if</span> (rehash) &#123;</span><br><span class="line">                e.hash = <span class="literal">null</span> == e.key ? <span class="number">0</span> : hash(e.key);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> indexFor(e.hash, newCapacity);<span class="comment">// å¾—åˆ°æ–°ä½ç½®ä¸‹æ ‡</span></span><br><span class="line">            e.next = newTable[i];<span class="comment">// å¾…æ’å…¥èŠ‚ç‚¹è¿æ¥è¯¥ä½ç½®çš„åé¢èŠ‚ç‚¹</span></span><br><span class="line">            newTable[i] = e;<span class="comment">// æ’å…¥è¯¥ä½ç½®</span></span><br><span class="line">            e = next;<span class="comment">// å¾—åˆ°ä¸‹ä¸€ä¸ªèŠ‚ç‚¹</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ul><li>ä¸¾ä¾‹ï¼š<ul><li>å‡è®¾ç°åœ¨æœ‰ä¸¤ä¸ªçº¿ç¨‹Aã€BåŒæ—¶å¯¹ä¸‹é¢è¿™ä¸ªHashMapè¿›è¡Œæ‰©å®¹æ“ä½œ</li><li>å‡è®¾HashMapçš„å¯»å€å‡½æ•°ä¸ºï¼ˆ key%æ•°ç»„é•¿åº¦ ï¼‰</li></ul></li></ul><p><img src="https://haipeng-lin.oss-cn-shenzhen.aliyuncs.com/202410091651000.png" alt="image-20241009164819797" /></p><blockquote><p>æ­£å¸¸æ‰©å®¹åç»“æœ</p></blockquote><img src="https://haipeng-lin.oss-cn-shenzhen.aliyuncs.com/202410091651319.png" alt="image-20241009165129150" style="zoom:80%;" /><blockquote><p>å‡è®¾å½“çº¿ç¨‹Aæ‰§è¡Œåˆ°ä¸Šé¢transferå‡½æ•°çš„ç¬¬11è¡Œä»£ç æ—¶ï¼ŒCPUæ—¶é—´ç‰‡è€—å°½ï¼Œçº¿ç¨‹Aè¢«æŒ‚èµ·ã€‚å³å¦‚ä¸‹å›¾ä¸­ä½ç½®æ‰€ç¤ºï¼š</p></blockquote><img src="https://haipeng-lin.oss-cn-shenzhen.aliyuncs.com/202410091659591.png" alt="image-20241009165927092" style="zoom:80%;" /><blockquote><p>æ­¤æ—¶çº¿ç¨‹Aä¸­ï¼š<strong>e=3ã€e.next=nullã€next=7</strong></p></blockquote><p><img src="https://haipeng-lin.oss-cn-shenzhen.aliyuncs.com/202410091704705.png" alt="image-20241009170427755" /></p><blockquote><p>å½“çº¿ç¨‹Açš„æ—¶é—´ç‰‡è€—å°½åï¼ŒCPUå¼€å§‹æ‰§è¡Œçº¿ç¨‹Bï¼Œå¹¶åœ¨<strong>çº¿ç¨‹Bä¸­æˆåŠŸçš„å®Œæˆäº†æ•°æ®è¿ç§»</strong></p></blockquote><p><img src="https://haipeng-lin.oss-cn-shenzhen.aliyuncs.com/202410091705729.png" alt="image-20241009170539713" /></p><blockquote><p>æ ¹æ® JMM å¾—å‡ºï¼Œçº¿ç¨‹Bæ‰§è¡Œå®Œæ•°æ®è¿ç§»åï¼Œæ­¤æ—¶ä¸»å†…å­˜ä¸­newTableå’Œtableéƒ½æ˜¯æœ€æ–°çš„ï¼Œä¹Ÿå°±æ˜¯è¯´ï¼š<mark>7.next=3ã€3.next=nullï¼ˆæ”¹å˜äº†çº¿ç¨‹Aä¸­çš„çŠ¶æ€ï¼‰</mark></p><p>éšåçº¿ç¨‹Aå†æ¬¡è·å¾—CPUæ—¶é—´ç‰‡ç»§ç»­æ‰§è¡ŒnewTable[i] = eï¼Œå°†3æ”¾å…¥æ–°æ•°ç»„å¯¹åº”çš„ä½ç½®</p><p>æ‰§è¡Œç¬¬ä¸€è½®å¾ªç¯åçº¿ç¨‹Açš„æƒ…å†µå¦‚ä¸‹ï¼š</p></blockquote><p><img src="https://haipeng-lin.oss-cn-shenzhen.aliyuncs.com/202410101228269.png" alt="image-20241009171049905" /></p><blockquote><p>æ¥ç€ç»§ç»­æ‰§è¡Œä¸‹ä¸€è½®å¾ªç¯ï¼Œæ­¤æ—¶e=7ï¼Œä»ä¸»å†…å­˜ä¸­è¯»å–e.nextæ—¶å‘ç°ä¸»å†…å­˜ä¸­7.next=3ï¼Œæ­¤æ—¶ next=3</p><p>å¹¶å°†7é‡‡ç”¨å¤´æ’æ³•çš„æ–¹å¼æ”¾å…¥æ–°æ•°ç»„ä¸­ï¼Œå¹¶ç»§ç»­æ‰§è¡Œç¬¬äºŒè½®å¾ªç¯ï¼Œç»“æœå¦‚ä¸‹ï¼š</p></blockquote><p><img src="https://haipeng-lin.oss-cn-shenzhen.aliyuncs.com/202410091713800.png" alt="image-20241009171340574" /></p><blockquote><p>æ‰§è¡Œç¬¬ä¸‰æ¬¡å¾ªç¯ï¼Œæ’å…¥æ•°æ®3ï¼Œäº§ç”Ÿæ­»é”é—®é¢˜å’Œæ•°æ®ä¸¢å¤±é—®é¢˜</p></blockquote><p><img src="https://haipeng-lin.oss-cn-shenzhen.aliyuncs.com/202410091717575.png" alt="image-20241009171725347" /></p><h2 id="3jdk18æ‰©å®¹å¼•å‘çš„æ•°æ®è¦†ç›–é—®é¢˜"><a class="markdownIt-Anchor" href="#3jdk18æ‰©å®¹å¼•å‘çš„æ•°æ®è¦†ç›–é—®é¢˜"></a> 3.JDK1.8æ‰©å®¹å¼•å‘çš„æ•°æ®è¦†ç›–é—®é¢˜</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">final</span> V <span class="title function_">putVal</span><span class="params">(<span class="type">int</span> hash, K key, V value, <span class="type">boolean</span> onlyIfAbsent,</span></span><br><span class="line"><span class="params">               <span class="type">boolean</span> evict)</span> &#123;</span><br><span class="line">    Node&lt;K,V&gt;[] tab; Node&lt;K,V&gt; p; <span class="type">int</span> n, i;</span><br><span class="line">    <span class="keyword">if</span> ((tab = table) == <span class="literal">null</span> || (n = tab.length) == <span class="number">0</span>)</span><br><span class="line">        n = (tab = resize()).length;</span><br><span class="line">    <span class="keyword">if</span> ((p = tab[i = (n - <span class="number">1</span>) &amp; hash]) == <span class="literal">null</span>)     <span class="comment">// å¦‚æœæ²¡æœ‰ hash ç¢°æ’ï¼Œåˆ™ç›´æ¥æ’å…¥</span></span><br><span class="line">        tab[i] = newNode(hash, key, value, <span class="literal">null</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æºç åªæ˜¯åˆ¤æ–­äº† hash æ˜¯å¦æœ‰ç¢°æ’ï¼Œå¦‚æœæ²¡æœ‰å°±ä¸å†åšåˆ«çš„æ£€æŸ¥è¿›è¡Œæ’å…¥æ“ä½œ</p><p>åœ¨å¤šçº¿ç¨‹ç¯å¢ƒä¸‹ï¼Œå¦‚æœçº¿ç¨‹ 1 æ£€æŸ¥å®Œäº† hash æ²¡æœ‰ç¢°æ’ï¼Œè¦è¿›è¡Œæ’å…¥æ—¶ï¼Œ CPU æ—¶é—´ç‰‡ä½¿ç”¨å®Œæ¯•ï¼Œæ­¤æ—¶å®ƒè¢«æŒ‚èµ·</p><p>çº¿ç¨‹ 2 å¼€å§‹è·‘ï¼Œæ— å·§ä¸æˆä¹¦å˜›ï¼Œæ­¤æ—¶çº¿ç¨‹ 2 ç»è¿‡ hash ä¹‹åå¾—åˆ°çš„å€¼å’Œçº¿ç¨‹ 1 çš„ hash å€¼ä¸€æ ·ï¼Œçº¿ç¨‹ 2 å°†å€¼æ’å…¥è¿›å»ï¼Œ<mark>çº¿ç¨‹ 1 æ¢å¤è¿è¡Œï¼Œå› ä¸ºå‰é¢æ£€æŸ¥äº† hash ç¢°æ’ï¼Œæ­¤æ—¶æ’å…¥æ—¶ä¸å†åšä»»ä½•æ£€æŸ¥</mark>ï¼Œç›´æ¥å°†å€¼æ’å…¥</p><p>é‚£ä¹ˆçº¿ç¨‹ 2 æ’å…¥çš„å€¼å°±è¢«è¦†ç›–æ‰äº†</p><p>HashMap ä¹‹æ‰€ä»¥å‘ç”Ÿæ•°æ®è¦†ç›–çš„é—®é¢˜ï¼Œæœ€ä¸»è¦çš„åŸå› åœ¨äºå®ƒæ²¡æœ‰åŠ é”ï¼Œæ‰€ä»¥åœ¨å¤šçº¿ç¨‹ç¯å¢ƒä¸‹ä¼šå‘ç”Ÿæ•°æ®è¦†ç›–é—®é¢˜</p><h2 id="4è§£å†³hashmapçº¿ç¨‹ä¸å®‰å…¨çš„æ–¹æ¡ˆ"><a class="markdownIt-Anchor" href="#4è§£å†³hashmapçº¿ç¨‹ä¸å®‰å…¨çš„æ–¹æ¡ˆ"></a> 4.è§£å†³HashMapçº¿ç¨‹ä¸å®‰å…¨çš„æ–¹æ¡ˆ</h2><h3 id="41hashtable"><a class="markdownIt-Anchor" href="#41hashtable"></a> 4.1HashTable</h3><blockquote><p>å·²åºŸå¼ƒï¼Œå®˜æ–¹å»ºè®®åœ¨å¤šçº¿ç¨‹ç¯å¢ƒä¸‹ä½¿ç”¨ConcurrentHashMapç±»ã€‚</p></blockquote><p>HashTableçš„æ“ä½œå‡ ä¹å’ŒHashMapä¸€è‡´ï¼Œä¸»è¦çš„åŒºåˆ«åœ¨äºHashTableä¸ºäº†å®ç°å¤šçº¿ç¨‹å®‰å…¨ï¼Œåœ¨å‡ ä¹æ‰€æœ‰çš„<strong>æ–¹æ³•ä¸Šéƒ½åŠ ä¸Šäº†synchronizedé”</strong>ï¼ˆé”çš„æ˜¯ç±»çš„å®ä¾‹,ä¹Ÿå°±æ˜¯æ•´ä¸ªmapç»“æ„ï¼‰</p><p>å½“ä¸€ä¸ªçº¿ç¨‹è®¿é—® Hashtable çš„åŒæ­¥æ–¹æ³•æ—¶ï¼Œå…¶ä»–çº¿ç¨‹å¦‚æœä¹Ÿè¦è®¿é—®åŒæ­¥æ–¹æ³•ï¼Œä¼šè¢«é˜»å¡ä½ã€‚ä¸¾ä¸ªä¾‹å­ï¼Œå½“ä¸€ä¸ªçº¿ç¨‹ä½¿ç”¨ put æ–¹æ³•æ—¶ï¼Œå¦ä¸€ä¸ªçº¿ç¨‹ä¸ä½†ä¸å¯ä»¥ä½¿ç”¨ put æ–¹æ³•ï¼Œè¿ get æ–¹æ³•éƒ½ä¸å¯ä»¥ï¼Œè€ŒåŠ é”çš„ç»“æœå°±æ˜¯HashTableæ“ä½œçš„æ•ˆç‡ååˆ†ä½ä¸‹ã€‚</p><h3 id="42concurrenthashmap"><a class="markdownIt-Anchor" href="#42concurrenthashmap"></a> 4.2ConcurrentHashMap</h3><h4 id="421jdk17"><a class="markdownIt-Anchor" href="#421jdk17"></a> 4.2.1JDK1.7</h4><ol><li><p>åœ¨ JDK 1.7 ä¸­ï¼Œåº•å±‚<strong>ä½¿ç”¨åˆ†æ®µæ•°ç»„+é“¾è¡¨</strong>ï¼ˆReentrantLock + Segment + HashEntryï¼‰æœºåˆ¶ã€‚åŸç†ï¼šæŠŠä¸€ä¸ª HashMap åˆ†æˆå¤šä¸ªæ®µï¼Œæ¯æ®µåˆ†é…ä¸€æŠŠé”ï¼Œä¿è¯å½“å‰çº¿ç¨‹æ‰§è¡Œè¯¥æ®µæ—¶ï¼Œä¸å½±å“å…¶ä»–çº¿ç¨‹æ“ä½œå…¶ä»–æ®µçš„æ•°æ®ï¼ˆé”ç²’åº¦ï¼šåŸºäº Segmentï¼ŒåŒ…å«å¤šä¸ª HashEntryï¼‰</p></li><li><p>ConcurrentHashMap å®šä½ä¸€ä¸ªå…ƒç´ çš„è¿‡ç¨‹éœ€è¦è¿›è¡Œ<strong>ä¸¤æ¬¡Hashæ“ä½œ</strong>ï¼Œç¬¬ä¸€æ¬¡ Hash å®šä½åˆ° Segmentï¼Œç¬¬äºŒæ¬¡ Hash å®šä½åˆ°å…ƒç´ æ‰€åœ¨çš„é“¾è¡¨çš„å¤´éƒ¨ï¼Œå› æ­¤ï¼Œè¿™ä¸€ç§ç»“æ„çš„å¸¦æ¥çš„å‰¯ä½œç”¨æ˜¯ Hash çš„è¿‡ç¨‹è¦æ¯”æ™®é€šçš„ HashMap è¦é•¿ï¼Œä½†æ˜¯å¸¦æ¥çš„å¥½å¤„æ˜¯å†™æ“ä½œçš„æ—¶å€™å¯ä»¥<strong>åªå¯¹å…ƒç´ æ‰€åœ¨çš„ Segment è¿›è¡Œæ“ä½œå³å¯</strong>ï¼Œä¸ä¼šå½±å“åˆ°å…¶ä»–çš„ Segment</p></li><li><p>å¦‚å›¾ä¸ºConcurrentHashMapåœ¨ JDK1.7çš„æ•°æ®ç»“æ„å›¾ï¼ŒSegment ç»§æ‰¿äº† ReeentrantLockç±»ï¼Œç”¨äºä¿è¯çº¿ç¨‹å®‰å…¨</p> <img src="https://haipeng-lin.oss-cn-shenzhen.aliyuncs.com/202410101113136.png" alt="image-20241010111332095" style="zoom:67%;" /></li></ol><h4 id="422jdk18"><a class="markdownIt-Anchor" href="#422jdk18"></a> 4.2.2JDK1.8</h4><ol><li>åœ¨ JDK 1.8 ä¸­ï¼Œåº•å±‚<strong>Nodeæ•°ç»„ + é“¾è¡¨ + çº¢é»‘æ ‘</strong>æ•°æ®ç»“æ„ï¼Œå¹¶ä½¿ç”¨ <strong>CASä¹è§‚é” + synchronizedé”</strong> ä¿è¯çº¿ç¨‹å®‰å…¨</li><li>é”ç²’åº¦ï¼šNodeæ•°ç»„çš„ä¸€ä¸ªNodeï¼Œå®ç° Map.Entryï¼Œé”ç²’åº¦é™ä½äº†</li><li>å¦‚å›¾ä¸ºConcurrentHashMapåœ¨ JDK1.8çš„æ•°æ®ç»“æ„å›¾</li></ol><img src="https://haipeng-lin.oss-cn-shenzhen.aliyuncs.com/202410101147282.png" alt="image-20241010114739254" style="zoom:80%;" /><h4 id="423é¢è¯•é¢˜"><a class="markdownIt-Anchor" href="#423é¢è¯•é¢˜"></a> 4.2.3é¢è¯•é¢˜</h4><blockquote><p>ï¼ˆ1ï¼‰ConcurrentHashMapåœ¨JDK 7å’Œ8ä¹‹é—´çš„åŒºåˆ«</p></blockquote><ol><li><strong>JDK1.8çš„å®ç°é™ä½é”çš„ç²’åº¦</strong>ï¼ŒJDK1.7ç‰ˆæœ¬é”çš„ç²’åº¦æ˜¯åŸºäºSegmentçš„ï¼ŒåŒ…å«å¤šä¸ªHashEntryï¼Œè€ŒJDK1.8é”çš„ç²’åº¦å°±æ˜¯NodeèŠ‚ç‚¹</li><li>JDK1.8ç‰ˆæœ¬çš„<strong>æ•°æ®ç»“æ„å˜å¾—æ›´åŠ ç®€å•</strong>ï¼Œä½¿å¾—æ“ä½œä¹Ÿæ›´åŠ æ¸…æ™°æµç•…ï¼Œå› ä¸ºå·²ç»ä½¿ç”¨synchronizedæ¥è¿›è¡ŒåŒæ­¥ï¼Œæ‰€ä»¥ä¸éœ€è¦åˆ†æ®µé”çš„æ¦‚å¿µï¼Œä¹Ÿå°±ä¸éœ€è¦Segmentè¿™ç§æ•°æ®ç»“æ„äº†ï¼Œç”±äºç²’åº¦çš„é™ä½ï¼Œå®ç°çš„å¤æ‚åº¦ä¹Ÿå¢åŠ </li><li>JDK1.8<strong>ä½¿ç”¨çº¢é»‘æ ‘æ¥ä¼˜åŒ–é“¾è¡¨</strong>ï¼ŒåŸºäºé•¿åº¦å¾ˆé•¿çš„é“¾è¡¨çš„éå†æ˜¯ä¸€ä¸ªå¾ˆæ¼«é•¿çš„è¿‡ç¨‹ï¼Œè€Œçº¢é»‘æ ‘çš„éå†æ•ˆç‡æ˜¯å¾ˆå¿«çš„ï¼Œä»£æ›¿ä¸€å®šé˜ˆå€¼çš„é“¾è¡¨ï¼Œè¿™æ ·å½¢æˆä¸€ä¸ªæœ€ä½³æ‹æ¡£</li></ol><blockquote><p>ï¼ˆ2ï¼‰ConcurentHashMapåœ¨JDK1.7å’ŒJDK1.8åˆ†åˆ«å¦‚ä½•ä¿è¯çº¿ç¨‹å®‰å…¨çš„ï¼Ÿ</p></blockquote><ol><li>åœ¨ JDK 1.7 ä¸­ï¼Œåº•å±‚<strong>ä½¿ç”¨åˆ†æ®µæ•°ç»„+é“¾è¡¨</strong>ï¼ˆReentrantLock + Segment + HashEntryï¼‰æœºåˆ¶ã€‚åŸç†ï¼šæŠŠä¸€ä¸ª HashMap åˆ†æˆå¤šä¸ªæ®µï¼Œæ¯æ®µåˆ†é…ä¸€æŠŠé”ï¼Œä¿è¯å½“å‰çº¿ç¨‹æ‰§è¡Œè¯¥æ®µæ—¶ï¼Œä¸å½±å“å…¶ä»–çº¿ç¨‹æ“ä½œå…¶ä»–æ®µçš„æ•°æ®ï¼ˆé”ç²’åº¦ï¼šåŸºäº Segmentï¼ŒåŒ…å«å¤šä¸ª HashEntryï¼‰</li><li>åœ¨ JDK 1.8 ä¸­ï¼Œåº•å±‚<strong>Nodeæ•°ç»„ + é“¾è¡¨ + çº¢é»‘æ ‘</strong>æ•°æ®ç»“æ„ï¼Œå¹¶ä½¿ç”¨ <strong>CASä¹è§‚é” + synchronizedé”</strong> ä¿è¯çº¿ç¨‹å®‰å…¨ã€‚å…¶ä¸­CASä¹è§‚é”ç”¨äºå‘ä¸ºç©ºçš„ä½ç½®èµ‹å€¼ï¼Œsynchronizedé”ç”¨äºä¸ä¸ºç©ºçš„ä½ç½®ï¼Œé“¾è¡¨orçº¢é»‘æ ‘ï¼Œæ’å…¥èŠ‚ç‚¹</li></ol><blockquote><p>ï¼ˆ3ï¼‰åœ¨JDK1.8ä¸­ï¼ŒConcurrentHashMap putä¸€ä¸ªå…ƒç´ çš„æµç¨‹</p></blockquote><ol><li><p>é¦–å…ˆæ ¹æ®keyè®¡ç®—å¯¹åº”çš„æ•°ç»„ä¸‹æ ‡ï¼Œå¦‚æœè¯¥ä½ç½®æ²¡æœ‰å…ƒç´ ï¼Œåˆ™é€šè¿‡CASä¹è§‚é”è‡ªæ—‹çš„æ–¹æ³•å»å‘è¯¥ä½ç½®èµ‹å€¼ã€‚</p></li><li><p>å¦‚æœè¯¥ä½ç½®æœ‰å…ƒç´ ï¼Œåˆ™synchronizedä¼šåŠ é”</p></li><li><p>åŠ é”æˆåŠŸä¹‹åï¼Œåœ¨åˆ¤æ–­è¯¥å…ƒç´ çš„ç±»å‹</p><ol><li>å¦‚æœæ˜¯é“¾è¡¨èŠ‚ç‚¹åˆ™è¿›è¡Œæ·»åŠ èŠ‚ç‚¹åˆ°é“¾è¡¨ä¸­</li><li>å¦‚æœæ˜¯çº¢é»‘æ ‘åˆ™æ·»åŠ èŠ‚ç‚¹åˆ°çº¢é»‘æ ‘</li></ol></li><li><p>æ·»åŠ æˆåŠŸåï¼Œåˆ¤æ–­æ˜¯å¦éœ€è¦è¿›è¡Œæ ‘åŒ–</p></li><li><p>æ‰§è¡Œ addCount æ–¹æ³•ï¼Œå°†ConcurrentHashMapçš„å…ƒç´ ä¸ªæ•°åŠ 1ï¼Œä½†æ˜¯è¿™ä¸ªæ“ä½œä¹Ÿæ˜¯éœ€è¦å¹¶å‘å®‰å…¨çš„ï¼Œå¹¶ä¸”å…ƒç´ ä¸ªæ•°åŠ 1æˆåŠŸåï¼Œä¼š<strong>ç»§ç»­åˆ¤æ–­æ˜¯å¦è¦è¿›è¡Œæ‰©å®¹</strong>ï¼Œå¦‚æœéœ€è¦ï¼Œåˆ™ä¼šè¿›è¡Œæ‰©å®¹ï¼Œæ‰€ä»¥è¿™ä¸ªæ–¹æ³•å¾ˆé‡è¦ã€‚</p></li><li><p>åŒæ—¶ä¸€ä¸ªçº¿ç¨‹åœ¨putæ—¶å¦‚æœå‘ç°å½“å‰ConcurrentHashMapæ­£åœ¨è¿›è¡Œæ‰©å®¹ï¼Œåˆ™ä¼šå»å¸®åŠ©æ‰©å®¹</p></li></ol><blockquote><p>ï¼ˆ4ï¼‰ConcurrentHashMap å’ŒHashMapçš„æ‰©å®¹æœ‰ä»€ä¹ˆä¸åŒï¼Ÿ</p></blockquote><ol><li>HashMapçš„æ‰©å®¹æ˜¯åˆ›å»ºä¸€ä¸ªæ–°æ•°ç»„ï¼Œå°†å€¼ç›´æ¥æ”¾å…¥æ–°æ•°ç»„ä¸­ï¼ŒJDK7é‡‡ç”¨å¤´é“¾æ¥æ³•ï¼Œä¼šå‡ºç°æ­»å¾ªç¯ï¼ŒJDK8é‡‡ç”¨å°¾é“¾æ¥æ³•ï¼Œä¸ä¼šé€ æˆæ­»å¾ªç¯</li><li>ConcurrentHashMap æ‰©å®¹æ˜¯ä»æ•°ç»„é˜Ÿå°¾å¼€å§‹æ‹·è´ï¼Œ<strong>æ‹·è´æ§½ç‚¹æ—¶ä¼šé”ä½æ§½ç‚¹</strong>ï¼Œæ‹·è´å®Œæˆåå°†æ§½ç‚¹è®¾ç½®ä¸ºè½¬ç§»èŠ‚ç‚¹ã€‚æ‰€ä»¥æ§½ç‚¹æ‹·è´å®Œæˆåå°†æ–°æ•°ç»„èµ‹å€¼ç»™å®¹å™¨</li></ol><blockquote><p>ï¼ˆ5ï¼‰ CAS ç®—æ³•åœ¨ ConcurrentHashMap ä¸­çš„åº”ç”¨</p></blockquote><ol><li>CASæ˜¯ä¸€ç§ä¹è§‚é”ï¼Œåœ¨æ‰§è¡Œæ“ä½œæ—¶ä¼šåˆ¤æ–­<strong>å†…å­˜ä¸­çš„å€¼æ˜¯å¦å’Œå‡†å¤‡ä¿®æ”¹å‰è·å–çš„å€¼ç›¸åŒ</strong>ï¼Œå¦‚æœç›¸åŒï¼ŒæŠŠæ–°å€¼èµ‹å€¼ç»™å¯¹è±¡ï¼Œå¦åˆ™èµ‹å€¼å¤±è´¥ï¼Œæ•´ä¸ªè¿‡ç¨‹éƒ½æ˜¯åŸå­æ€§æ“ä½œï¼Œæ— çº¿ç¨‹å®‰å…¨é—®é¢˜</li><li>ConcurrentHashMap çš„putæ“ä½œæ˜¯ç»“åˆè‡ªæ—‹ç”¨åˆ°äº†CASï¼Œå¦‚æœhashè®¡ç®—å‡ºçš„ä½ç½®çš„æ§½ç‚¹å€¼ä¸ºç©ºï¼Œå°±é‡‡ç”¨CAS+è‡ªæ—‹è¿›è¡Œèµ‹å€¼ï¼Œå¦‚æœæ£€æŸ¥å€¼ä¸ºç©ºï¼Œå°±èµ‹å€¼ï¼Œå¦‚æœä¸ä¸ºç©ºè¯´æ˜æœ‰å…¶ä»–çº¿ç¨‹å…ˆèµ‹å€¼äº†ï¼Œæ”¾å¼ƒæœ¬æ¬¡æ“ä½œï¼Œè¿›å…¥ä¸‹ä¸€è½®å¾ªç¯</li></ol>]]></content>
    
    
      
      
    <summary type="html">&lt;link rel=&quot;stylesheet&quot; class=&quot;aplayer-secondary-style-marker&quot; href=&quot;&#92;assets&#92;css&#92;APlayer.min.css&quot;&gt;&lt;script src=&quot;&#92;assets&#92;js&#92;APlayer.min.js&quot; cla</summary>
      
    
    
    
    <category term="ã€JavaåŸºç¡€ã€‘" scheme="https://www.haipeng-lin.cn/categories/%E3%80%90Java%E5%9F%BA%E7%A1%80%E3%80%91/"/>
    
    
  </entry>
  
  <entry>
    <title>RabbitMQå­¦ä¹ ç¬”è®°</title>
    <link href="https://www.haipeng-lin.cn/posts/d439760d.html"/>
    <id>https://www.haipeng-lin.cn/posts/d439760d.html</id>
    <published>2024-10-07T09:40:13.000Z</published>
    <updated>2024-10-07T15:01:09.765Z</updated>
    
    <content type="html"><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="\assets\css\APlayer.min.css"><script src="\assets\js\APlayer.min.js" class="aplayer-secondary-script-marker"></script><h1 id="1rabbitmqæ˜¯ä»€ä¹ˆ"><a class="markdownIt-Anchor" href="#1rabbitmqæ˜¯ä»€ä¹ˆ"></a> 1.RabbitMQæ˜¯ä»€ä¹ˆï¼Ÿ</h1><ol><li>RabbitMQ æ˜¯ä¸€ä¸ªåœ¨ AMQPï¼ˆAdvanced Message Queuing Protocol ï¼Œé«˜çº§æ¶ˆæ¯é˜Ÿåˆ—ï¼‰åŸºç¡€ä¸Šå®ç°çš„ï¼Œå¯å¤ç”¨çš„ä¼ä¸šæ¶ˆæ¯ç³»ç»Ÿã€‚å®ƒå¯ä»¥ç”¨äºå¤§å‹è½¯ä»¶ç³»ç»Ÿå„ä¸ªæ¨¡å—ä¹‹é—´çš„é«˜æ•ˆé€šä¿¡ï¼Œ<mark>æ”¯æŒé«˜å¹¶å‘ï¼Œæ”¯æŒå¯æ‰©å±•</mark>ã€‚å®ƒæ”¯æŒå¤šç§å®¢æˆ·ç«¯å¦‚ï¼šPythonã€Rubyã€.NETã€Javaã€JMSã€Cã€PHPã€ActionScriptã€XMPPã€STOMP ç­‰ï¼Œæ”¯æŒ AJAXï¼ŒæŒä¹…åŒ–ï¼Œç”¨äºåœ¨åˆ†å¸ƒå¼ç³»ç»Ÿä¸­å­˜å‚¨è½¬å‘æ¶ˆæ¯ï¼Œåœ¨æ˜“ç”¨æ€§ã€æ‰©å±•æ€§ã€é«˜å¯ç”¨æ€§ç­‰æ–¹é¢è¡¨ç°ä¸ä¿—ã€‚</li><li>RabbitMQ æ˜¯<mark>ä½¿ç”¨ Erlang</mark> ç¼–å†™çš„ä¸€ä¸ªå¼€æºçš„æ¶ˆæ¯é˜Ÿåˆ—ï¼Œæœ¬èº«æ”¯æŒå¾ˆå¤šçš„åè®®ï¼šAMQPï¼ŒXMPP, SMTP, STOMPï¼Œä¹Ÿæ­£æ˜¯å¦‚æ­¤ï¼Œä½¿çš„å®ƒå˜çš„éå¸¸é‡é‡çº§ï¼Œæ›´é€‚åˆäºä¼ä¸šçº§çš„å¼€å‘ã€‚å®ƒåŒæ—¶å®ç°äº†ä¸€ä¸ª Broker æ„æ¶ï¼Œè¿™æ„å‘³ç€æ¶ˆæ¯åœ¨å‘é€ç»™å®¢æˆ·ç«¯æ—¶å…ˆåœ¨ä¸­å¿ƒé˜Ÿåˆ—æ’é˜Ÿï¼Œå¯¹è·¯ç”±(Routing)ã€è´Ÿè½½å‡è¡¡(Load balance)æˆ–è€…æ•°æ®æŒä¹…åŒ–éƒ½æœ‰å¾ˆå¥½çš„æ”¯æŒã€‚</li></ol><h1 id="2ç‰¹ç‚¹"><a class="markdownIt-Anchor" href="#2ç‰¹ç‚¹"></a> 2.ç‰¹ç‚¹</h1><ol><li><strong><mark>å¯é æ€§</mark></strong>: RabbitMQ ä½¿ç”¨ä¸€äº›æœºåˆ¶æ¥ä¿è¯å¯é æ€§ï¼Œ å¦‚æŒä¹…åŒ–ã€ä¼ è¾“ç¡®è®¤åŠå‘å¸ƒç¡®è®¤ç­‰ã€‚</li><li><strong><mark>çµæ´»çš„è·¯ç”±</mark></strong> : åœ¨æ¶ˆæ¯è¿›å…¥é˜Ÿåˆ—ä¹‹å‰ï¼Œ<mark>é€šè¿‡äº¤æ¢å™¨æ¥è·¯ç”±æ¶ˆæ¯</mark>ã€‚å¯¹äºå…¸å‹çš„è·¯ç”±åŠŸèƒ½ï¼Œ RabbitMQ å·±ç»æä¾›äº†ä¸€äº›å†…ç½®çš„äº¤æ¢å™¨æ¥å®ç°ã€‚é’ˆå¯¹æ›´å¤æ‚çš„è·¯ç”±åŠŸèƒ½ï¼Œå¯ä»¥å°†å¤šä¸ªäº¤æ¢å™¨ç»‘å®šåœ¨ä¸€èµ·ï¼Œ ä¹Ÿå¯ä»¥é€šè¿‡æ’ä»¶æœºåˆ¶æ¥å®ç°è‡ªå·±çš„äº¤æ¢å™¨ã€‚</li><li><strong><mark>æ‰©å±•æ€§</mark></strong>: å¤šä¸ª RabbitMQ èŠ‚ç‚¹å¯ä»¥ç»„æˆä¸€ä¸ªé›†ç¾¤ï¼Œä¹Ÿå¯ä»¥æ ¹æ®å®é™…ä¸šåŠ¡æƒ…å†µåŠ¨æ€åœ°æ‰©å±• é›†ç¾¤ä¸­èŠ‚ç‚¹ã€‚</li><li><strong><mark>é«˜å¯ç”¨æ€§</mark></strong> : é˜Ÿåˆ—å¯ä»¥åœ¨é›†ç¾¤ä¸­çš„æœºå™¨ä¸Šè®¾ç½®é•œåƒï¼Œä½¿å¾—åœ¨éƒ¨åˆ†èŠ‚ç‚¹å‡ºç°é—®é¢˜çš„æƒ…å†µä¸‹é˜Ÿ åˆ—ä»ç„¶å¯ç”¨ã€‚</li><li><strong>å¤šç§åè®®</strong>: RabbitMQ é™¤äº†åŸç”Ÿæ”¯æŒ AMQP åè®®ï¼Œè¿˜æ”¯æŒ STOMPï¼Œ MQTT ç­‰å¤šç§æ¶ˆæ¯ ä¸­é—´ä»¶åè®®ã€‚</li><li><strong>å¤šè¯­è¨€å®¢æˆ·ç«¯</strong> :RabbitMQ å‡ ä¹æ”¯æŒæ‰€æœ‰å¸¸ç”¨è¯­è¨€ï¼Œæ¯”å¦‚ Javaã€ Pythonã€ Rubyã€ PHPã€ C#ã€ JavaScript ç­‰ã€‚</li><li><strong>ç®¡ç†ç•Œé¢</strong> : RabbitMQ æä¾›äº†ä¸€ä¸ªæ˜“ç”¨çš„ç”¨æˆ·ç•Œé¢ï¼Œä½¿å¾—ç”¨æˆ·å¯ä»¥ç›‘æ§å’Œç®¡ç†æ¶ˆæ¯ã€é›† ç¾¤ä¸­çš„èŠ‚ç‚¹ç­‰ã€‚</li><li><strong>æ’ä»¶æœºåˆ¶</strong> : RabbitMQ æä¾›äº†è®¸å¤šæ’ä»¶ ï¼Œ ä»¥å®ç°ä»å¤šæ–¹é¢è¿›è¡Œæ‰©å±•ï¼Œå½“ç„¶ä¹Ÿå¯ä»¥ç¼–å†™è‡ª å·±çš„æ’ä»¶</li></ol><h1 id="3rabbitæ ¸å¿ƒæ¦‚å¿µ"><a class="markdownIt-Anchor" href="#3rabbitæ ¸å¿ƒæ¦‚å¿µ"></a> 3.Rabbitæ ¸å¿ƒæ¦‚å¿µ</h1><p>RabbitMQ æ•´ä½“ä¸Šæ˜¯ä¸€ä¸ªç”Ÿäº§è€…ä¸æ¶ˆè´¹è€…æ¨¡å‹ï¼Œä¸»è¦è´Ÿè´£æ¥æ”¶ã€å­˜å‚¨å’Œè½¬å‘æ¶ˆæ¯ã€‚å¯ä»¥æŠŠæ¶ˆæ¯ä¼ é€’çš„è¿‡ç¨‹æƒ³è±¡æˆï¼šå½“ä½ å°†ä¸€ä¸ªåŒ…è£¹é€åˆ°é‚®å±€ï¼Œé‚®å±€ä¼šæš‚å­˜å¹¶æœ€ç»ˆå°†é‚®ä»¶é€šè¿‡é‚®é€’å‘˜é€åˆ°æ”¶ä»¶äººçš„æ‰‹ä¸Šï¼ŒRabbitMQ å°±å¥½æ¯”ç”±é‚®å±€ã€é‚®ç®±å’Œé‚®é€’å‘˜ç»„æˆçš„ä¸€ä¸ªç³»ç»Ÿã€‚ä»è®¡ç®—æœºæœ¯è¯­å±‚é¢æ¥è¯´ï¼ŒRabbitMQ æ¨¡å‹æ›´åƒæ˜¯ä¸€ç§äº¤æ¢æœºæ¨¡å‹ã€‚</p><p>RabbitMQ çš„æ•´ä½“æ¨¡å‹æ¶æ„å¦‚ä¸‹ï¼š</p><p><img src="https://oss.javaguide.cn/github/javaguide/rabbitmq/96388546.jpg" alt="å›¾1-RabbitMQ çš„æ•´ä½“æ¨¡å‹æ¶æ„" /></p><h2 id="31-producerå’Œconsumer"><a class="markdownIt-Anchor" href="#31-producerå’Œconsumer"></a> 3.1 Producerå’ŒConsumer</h2><ul><li><strong>Producer(ç”Ÿäº§è€…)</strong> :ç”Ÿäº§æ¶ˆæ¯çš„ä¸€æ–¹ï¼ˆé‚®ä»¶æŠ•é€’è€…ï¼‰</li><li><strong>Consumer(æ¶ˆè´¹è€…)</strong> :æ¶ˆè´¹æ¶ˆæ¯çš„ä¸€æ–¹ï¼ˆé‚®ä»¶æ”¶ä»¶äººï¼‰</li></ul><ol><li>æ¶ˆæ¯ä¸€èˆ¬ç”± 2 éƒ¨åˆ†ç»„æˆï¼š<strong>æ¶ˆæ¯å¤´</strong>ï¼ˆæˆ–è€…è¯´æ˜¯æ ‡ç­¾ Labelï¼‰å’Œ <strong>æ¶ˆæ¯ä½“</strong>ã€‚</li><li><mark><strong>æ¶ˆæ¯ä½“</strong></mark> ä¹Ÿå¯ä»¥ç§°ä¸º payLoad ,<mark>æ¶ˆæ¯ä½“æ˜¯ä¸é€æ˜çš„</mark></li><li><mark><strong>æ¶ˆæ¯å¤´</strong></mark> åˆ™ç”±ä¸€ç³»åˆ—çš„å¯é€‰å±æ€§ç»„æˆï¼Œè¿™äº›å±æ€§åŒ…æ‹¬ <mark>routing-keyï¼ˆè·¯ç”±é”®ï¼‰ã€priorityï¼ˆç›¸å¯¹äºå…¶ä»–æ¶ˆæ¯çš„ä¼˜å…ˆæƒï¼‰ã€delivery-modeï¼ˆæŒ‡å‡ºè¯¥æ¶ˆæ¯å¯èƒ½éœ€è¦æŒä¹…æ€§å­˜å‚¨ï¼‰</mark> ç­‰ã€‚ç”Ÿäº§è€…æŠŠæ¶ˆæ¯äº¤ç”± RabbitMQ åï¼ŒRabbitMQ ä¼šæ ¹æ®æ¶ˆæ¯å¤´æŠŠæ¶ˆæ¯å‘é€ç»™æ„Ÿå…´è¶£çš„ Consumer(æ¶ˆè´¹è€…)ã€‚</li></ol><h2 id="32-exchange"><a class="markdownIt-Anchor" href="#32-exchange"></a> 3.2 Exchange</h2><p>åœ¨ RabbitMQ ä¸­ï¼Œæ¶ˆæ¯å¹¶ä¸æ˜¯ç›´æ¥è¢«æŠ•é€’åˆ° <strong>Queue(æ¶ˆæ¯é˜Ÿåˆ—)</strong> ä¸­çš„ï¼Œä¸­é—´è¿˜å¿…é¡»ç»è¿‡ <strong>Exchange(äº¤æ¢å™¨)</strong> è¿™ä¸€å±‚ï¼Œ<mark><strong>Exchange(äº¤æ¢å™¨)</strong> ä¼šæŠŠæˆ‘ä»¬çš„æ¶ˆæ¯åˆ†é…åˆ°å¯¹åº”çš„ <strong>Queue(æ¶ˆæ¯é˜Ÿåˆ—)</strong></mark> ä¸­ã€‚</p><p><strong>Exchange(äº¤æ¢å™¨)</strong> ç”¨æ¥æ¥æ”¶ç”Ÿäº§è€…å‘é€çš„æ¶ˆæ¯å¹¶å°†è¿™äº›æ¶ˆæ¯è·¯ç”±ç»™æœåŠ¡å™¨ä¸­çš„é˜Ÿåˆ—ä¸­ï¼Œå¦‚æœè·¯ç”±ä¸åˆ°ï¼Œæˆ–è®¸ä¼šè¿”å›ç»™ <strong>Producer(ç”Ÿäº§è€…)</strong> ï¼Œæˆ–è®¸ä¼šè¢«ç›´æ¥ä¸¢å¼ƒæ‰ ã€‚è¿™é‡Œå¯ä»¥å°† RabbitMQ ä¸­çš„äº¤æ¢å™¨çœ‹ä½œä¸€ä¸ªç®€å•çš„å®ä½“ã€‚</p><p><strong>RabbitMQ çš„ Exchange(äº¤æ¢å™¨) æœ‰ 4 ç§ç±»å‹ï¼Œä¸åŒçš„ç±»å‹å¯¹åº”ç€ä¸åŒçš„è·¯ç”±ç­–ç•¥</strong>ï¼š<mark><strong>direct(é»˜è®¤)</strong>ï¼Œ<strong>fanout</strong>, <strong>topic</strong>, å’Œ <strong>headers</strong></mark>ï¼Œä¸åŒç±»å‹çš„ Exchange è½¬å‘æ¶ˆæ¯çš„ç­–ç•¥æœ‰æ‰€åŒºåˆ«ã€‚è¿™ä¸ªä¼šåœ¨ä»‹ç» <strong>Exchange Types(äº¤æ¢å™¨ç±»å‹)</strong> çš„æ—¶å€™ä»‹ç»åˆ°ã€‚</p><p>Exchange(äº¤æ¢å™¨) ç¤ºæ„å›¾å¦‚ä¸‹ï¼š</p><p><img src="https://oss.javaguide.cn/github/javaguide/rabbitmq/24007899.jpg" alt="Exchange(äº¤æ¢å™¨) ç¤ºæ„å›¾" /></p><ol><li>RabbitMQ ä¸­é€šè¿‡ <mark><strong>Binding(ç»‘å®š)</strong></mark> å°† <strong>Exchange(äº¤æ¢å™¨)</strong> ä¸ <strong>Queue(æ¶ˆæ¯é˜Ÿåˆ—)</strong> å…³è”èµ·æ¥ï¼Œåœ¨ç»‘å®šçš„æ—¶å€™ä¸€èˆ¬ä¼šæŒ‡å®šä¸€ä¸ª <strong><mark>BindingKey(ç»‘å®šå»º)</mark></strong> ,è¿™æ · RabbitMQ å°±çŸ¥é“å¦‚ä½•æ­£ç¡®å°†æ¶ˆæ¯è·¯ç”±åˆ°é˜Ÿåˆ—äº†,å¦‚ä¸‹å›¾æ‰€ç¤ºã€‚ä¸€ä¸ªç»‘å®šå°±æ˜¯åŸºäºè·¯ç”±é”®å°†äº¤æ¢å™¨å’Œæ¶ˆæ¯é˜Ÿåˆ—è¿æ¥èµ·æ¥çš„è·¯ç”±è§„åˆ™ï¼Œæ‰€ä»¥å¯ä»¥å°†äº¤æ¢å™¨ç†è§£æˆä¸€ä¸ªç”±ç»‘å®šæ„æˆçš„è·¯ç”±è¡¨ã€‚Exchange å’Œ Queue çš„ç»‘å®šå¯ä»¥æ˜¯å¤šå¯¹å¤šçš„å…³ç³»ã€‚</li><li>ç”Ÿäº§è€…å°†<mark>æ¶ˆæ¯å‘ç»™äº¤æ¢å™¨</mark>çš„æ—¶å€™ï¼Œä¸€èˆ¬ä¼šæŒ‡å®šä¸€ä¸ª ==<strong>RoutingKey(è·¯ç”±é”®)</strong>ï¼Œ==ç”¨æ¥æŒ‡å®šè¿™ä¸ªæ¶ˆæ¯çš„è·¯ç”±è§„åˆ™ï¼Œè€Œè¿™ä¸ª <strong>RoutingKey éœ€è¦ä¸äº¤æ¢å™¨ç±»å‹å’Œç»‘å®šé”®(BindingKey)è”åˆä½¿ç”¨æ‰èƒ½æœ€ç»ˆç”Ÿæ•ˆ</strong>ã€‚</li></ol><p><img src="https://oss.javaguide.cn/github/javaguide/rabbitmq/70553134.jpg" alt="Binding(ç»‘å®š) ç¤ºæ„å›¾" /></p><h2 id="33-queue"><a class="markdownIt-Anchor" href="#33-queue"></a> 3.3 Queue</h2><ol><li><strong>Queue(æ¶ˆæ¯é˜Ÿåˆ—)</strong> ç”¨æ¥<mark>ä¿å­˜æ¶ˆæ¯ç›´åˆ°å‘é€ç»™æ¶ˆè´¹è€…</mark>ã€‚å®ƒæ˜¯æ¶ˆæ¯çš„å®¹å™¨ï¼Œä¹Ÿæ˜¯æ¶ˆæ¯çš„ç»ˆç‚¹ã€‚ä¸€ä¸ªæ¶ˆæ¯å¯æŠ•å…¥ä¸€ä¸ªæˆ–å¤šä¸ªé˜Ÿåˆ—ã€‚æ¶ˆæ¯ä¸€ç›´åœ¨é˜Ÿåˆ—é‡Œé¢ï¼Œç­‰å¾…æ¶ˆè´¹è€…è¿æ¥åˆ°è¿™ä¸ªé˜Ÿåˆ—å°†å…¶å–èµ°ã€‚</li><li><strong>RabbitMQ</strong> ä¸­æ¶ˆæ¯åªèƒ½å­˜å‚¨åœ¨ <strong>é˜Ÿåˆ—</strong> ä¸­ï¼Œè¿™ä¸€ç‚¹å’Œ <strong>Kafka</strong> è¿™ç§æ¶ˆæ¯ä¸­é—´ä»¶ç›¸åã€‚<mark>Kafka å°†æ¶ˆæ¯å­˜å‚¨åœ¨ <strong>topicï¼ˆä¸»é¢˜ï¼‰</strong></mark> è¿™ä¸ªé€»è¾‘å±‚é¢ï¼Œè€Œç›¸å¯¹åº”çš„é˜Ÿåˆ—é€»è¾‘åªæ˜¯ topic å®é™…å­˜å‚¨æ–‡ä»¶ä¸­çš„ä½ç§»æ ‡è¯†ã€‚ RabbitMQ çš„ç”Ÿäº§è€…ç”Ÿäº§æ¶ˆæ¯å¹¶æœ€ç»ˆæŠ•é€’åˆ°é˜Ÿåˆ—ä¸­ï¼Œæ¶ˆè´¹è€…å¯ä»¥ä»é˜Ÿåˆ—ä¸­è·å–æ¶ˆæ¯å¹¶æ¶ˆè´¹ã€‚</li><li><strong><mark>å¤šä¸ªæ¶ˆè´¹è€…å¯ä»¥è®¢é˜…åŒä¸€ä¸ªé˜Ÿåˆ—</mark></strong>ï¼Œè¿™æ—¶é˜Ÿåˆ—ä¸­çš„æ¶ˆæ¯ä¼šè¢«å¹³å‡åˆ†æ‘Šï¼ˆRound-Robinï¼Œå³è½®è¯¢ï¼‰ç»™å¤šä¸ªæ¶ˆè´¹è€…è¿›è¡Œå¤„ç†ï¼Œè€Œä¸æ˜¯æ¯ä¸ªæ¶ˆè´¹è€…éƒ½æ”¶åˆ°æ‰€æœ‰çš„æ¶ˆæ¯å¹¶å¤„ç†ï¼Œè¿™æ ·é¿å…æ¶ˆæ¯è¢«é‡å¤æ¶ˆè´¹ã€‚</li></ol><h2 id="34-broker"><a class="markdownIt-Anchor" href="#34-broker"></a> 3.4 Broker</h2><p>å¯¹äº RabbitMQ æ¥è¯´ï¼Œ<mark>ä¸€ä¸ª RabbitMQ Broker å¯ä»¥ç®€å•åœ°çœ‹ä½œä¸€ä¸ª RabbitMQ æœåŠ¡èŠ‚ç‚¹</mark>ï¼Œæˆ–è€… RabbitMQ æœåŠ¡å®ä¾‹ã€‚å¤§å¤šæ•°æƒ…å†µä¸‹ä¹Ÿå¯ä»¥å°†ä¸€ä¸ª RabbitMQ Broker çœ‹ä½œä¸€å° RabbitMQ æœåŠ¡å™¨ã€‚</p><p>ä¸‹å›¾å±•ç¤ºäº†ç”Ÿäº§è€…å°†æ¶ˆæ¯å­˜å…¥ RabbitMQ Broker,ä»¥åŠæ¶ˆè´¹è€…ä» Broker ä¸­æ¶ˆè´¹æ•°æ®çš„æ•´ä¸ªæµç¨‹ã€‚</p><p><img src="https://oss.javaguide.cn/github/javaguide/rabbitmq/67952922.jpg" alt="æ¶ˆæ¯é˜Ÿåˆ—çš„è¿è½¬è¿‡ç¨‹" /></p><h2 id="35-exchange-types"><a class="markdownIt-Anchor" href="#35-exchange-types"></a> 3.5 Exchange Types</h2><p>RabbitMQ å¸¸ç”¨çš„ Exchange Type æœ‰ <strong>fanout</strong>ã€<strong>direct</strong>ã€<strong>topic</strong>ã€<strong>headers</strong> è¿™å››ç§ï¼ˆAMQP è§„èŒƒé‡Œè¿˜æåˆ°ä¸¤ç§ Exchange Typeï¼Œåˆ†åˆ«ä¸º system ä¸ è‡ªå®šä¹‰ï¼Œè¿™é‡Œä¸äºˆä»¥æè¿°ï¼‰ã€‚</p><h3 id="351fanout"><a class="markdownIt-Anchor" href="#351fanout"></a> 3.5.1fanout</h3><p>fanout ç±»å‹çš„ Exchange è·¯ç”±è§„åˆ™éå¸¸ç®€å•ï¼Œå®ƒ<mark>ä¼šæŠŠæ‰€æœ‰å‘é€åˆ°è¯¥ Exchange çš„æ¶ˆæ¯è·¯ç”±åˆ°æ‰€æœ‰ä¸å®ƒç»‘å®šçš„ Queue</mark> ä¸­ï¼Œä¸éœ€è¦åšä»»ä½•åˆ¤æ–­æ“ä½œï¼Œæ‰€ä»¥ fanout ç±»å‹æ˜¯æ‰€æœ‰çš„äº¤æ¢æœºç±»å‹é‡Œé¢é€Ÿåº¦æœ€å¿«çš„ã€‚fanout ç±»å‹å¸¸ç”¨æ¥<mark>å¹¿æ’­æ¶ˆæ¯</mark>ã€‚</p><h3 id="352direct"><a class="markdownIt-Anchor" href="#352direct"></a> 3.5.2direct</h3><p>direct ç±»å‹çš„ Exchange è·¯ç”±è§„åˆ™ä¹Ÿå¾ˆç®€å•ï¼Œå®ƒä¼šæŠŠæ¶ˆæ¯è·¯ç”±åˆ°<mark>é‚£äº› Bindingkey ä¸ RoutingKey å®Œå…¨åŒ¹é…çš„ Queue ä¸­</mark>ã€‚</p><p><img src="https://oss.javaguide.cn/github/javaguide/rabbitmq/37008021.jpg" alt="direct ç±»å‹äº¤æ¢å™¨" /></p><p>ä»¥ä¸Šå›¾ä¸ºä¾‹ï¼Œå¦‚æœå‘é€æ¶ˆæ¯çš„æ—¶å€™è®¾ç½®è·¯ç”±é”®ä¸ºâ€œwarningâ€,é‚£ä¹ˆæ¶ˆæ¯ä¼šè·¯ç”±åˆ° Queue1 å’Œ Queue2ã€‚å¦‚æœåœ¨å‘é€æ¶ˆæ¯çš„æ—¶å€™è®¾ç½®è·¯ç”±é”®ä¸º&quot;Infoâ€æˆ–è€…&quot;debugâ€ï¼Œæ¶ˆæ¯åªä¼šè·¯ç”±åˆ° Queue2ã€‚å¦‚æœä»¥å…¶ä»–çš„è·¯ç”±é”®å‘é€æ¶ˆæ¯ï¼Œåˆ™æ¶ˆæ¯ä¸ä¼šè·¯ç”±åˆ°è¿™ä¸¤ä¸ªé˜Ÿåˆ—ä¸­ã€‚</p><h3 id="353topic"><a class="markdownIt-Anchor" href="#353topic"></a> 3.5.3topic</h3><p>topic ç±»å‹çš„äº¤æ¢å™¨åœ¨directçš„åŒ¹é…è§„åˆ™åŸºç¡€ä¸Šè¿›è¡Œäº†æ‰©å±•ï¼Œå®ƒä¸ direct ç±»å‹çš„äº¤æ¢å™¨ç›¸ä¼¼ï¼Œä¹Ÿæ˜¯å°†æ¶ˆæ¯è·¯ç”±åˆ° BindingKey å’Œ RoutingKey ç›¸åŒ¹é…çš„é˜Ÿåˆ—ä¸­ï¼Œä½†è¿™é‡Œçš„<mark>åŒ¹é…è§„åˆ™æœ‰äº›ä¸åŒ</mark>ï¼Œå®ƒçº¦å®šï¼š</p><ul><li>RoutingKey ä¸ºä¸€ä¸ªç‚¹å·â€œï¼â€åˆ†éš”çš„å­—ç¬¦ä¸²ï¼ˆè¢«ç‚¹å·â€œï¼â€åˆ†éš”å¼€çš„æ¯ä¸€æ®µç‹¬ç«‹çš„å­—ç¬¦ä¸²ç§°ä¸ºä¸€ä¸ªå•è¯ï¼‰ï¼Œå¦‚ â€œcom.rabbitmq.clientâ€ã€â€œjava.util.concurrentâ€ã€â€œcom.hidden.clientâ€;</li><li>BindingKey å’Œ RoutingKey ä¸€æ ·ä¹Ÿæ˜¯ç‚¹å·â€œï¼â€åˆ†éš”çš„å­—ç¬¦ä¸²ï¼›</li><li>BindingKey ä¸­å¯ä»¥å­˜åœ¨ä¸¤ç§ç‰¹æ®Šå­—ç¬¦ä¸²â€œ<em>â€å’Œâ€œ#â€ï¼Œç”¨äºåšæ¨¡ç³ŠåŒ¹é…ï¼Œå…¶ä¸­â€œ</em><mark>â€ç”¨äºåŒ¹é…ä¸€ä¸ªå•è¯</mark>ï¼Œ<mark>â€œ#â€ç”¨äºåŒ¹é…å¤šä¸ªå•è¯(å¯ä»¥æ˜¯é›¶ä¸ª)</mark>ã€‚</li></ul><p><img src="https://oss.javaguide.cn/github/javaguide/rabbitmq/73843.jpg" alt="topic ç±»å‹äº¤æ¢å™¨" /></p><ul><li>è·¯ç”±é”®ä¸º â€œcom.rabbitmq.clientâ€ çš„æ¶ˆæ¯ä¼šåŒæ—¶è·¯ç”±åˆ° Queue1 å’Œ Queue2;</li><li>è·¯ç”±é”®ä¸º â€œcom.hidden.clientâ€ çš„æ¶ˆæ¯åªä¼šè·¯ç”±åˆ° Queue2 ä¸­ï¼›</li><li>è·¯ç”±é”®ä¸º â€œcom.hidden.demoâ€ çš„æ¶ˆæ¯åªä¼šè·¯ç”±åˆ° Queue2 ä¸­ï¼›</li><li>è·¯ç”±é”®ä¸º â€œjava.rabbitmq.demoâ€ çš„æ¶ˆæ¯åªä¼šè·¯ç”±åˆ° Queue1 ä¸­ï¼›</li><li>è·¯ç”±é”®ä¸º â€œjava.util.concurrentâ€ çš„æ¶ˆæ¯å°†ä¼šè¢«ä¸¢å¼ƒæˆ–è€…è¿”å›ç»™ç”Ÿäº§è€…ï¼ˆéœ€è¦è®¾ç½® mandatory å‚æ•°ï¼‰ï¼Œå› ä¸ºå®ƒæ²¡æœ‰åŒ¹é…ä»»ä½•è·¯ç”±é”®ã€‚</li></ul><h3 id="354headersä¸æ¨è"><a class="markdownIt-Anchor" href="#354headersä¸æ¨è"></a> 3.5.4headersï¼ˆä¸æ¨èï¼‰</h3><p>headers ç±»å‹çš„äº¤æ¢å™¨ä¸ä¾èµ–äºè·¯ç”±é”®çš„åŒ¹é…è§„åˆ™æ¥è·¯ç”±æ¶ˆæ¯ï¼Œè€Œæ˜¯æ ¹æ®å‘é€çš„æ¶ˆæ¯å†…å®¹ä¸­çš„ headers å±æ€§è¿›è¡ŒåŒ¹é…ã€‚åœ¨ç»‘å®šé˜Ÿåˆ—å’Œäº¤æ¢å™¨æ—¶æŒ‡å®šä¸€ç»„é”®å€¼å¯¹ï¼Œå½“å‘é€æ¶ˆæ¯åˆ°äº¤æ¢å™¨æ—¶ï¼ŒRabbitMQ ä¼šè·å–åˆ°è¯¥æ¶ˆæ¯çš„ headersï¼ˆä¹Ÿæ˜¯ä¸€ä¸ªé”®å€¼å¯¹çš„å½¢å¼)ï¼Œå¯¹æ¯”å…¶ä¸­çš„é”®å€¼å¯¹æ˜¯å¦å®Œå…¨åŒ¹é…é˜Ÿåˆ—å’Œäº¤æ¢å™¨ç»‘å®šæ—¶æŒ‡å®šçš„é”®å€¼å¯¹ï¼Œå¦‚æœå®Œå…¨åŒ¹é…åˆ™æ¶ˆæ¯ä¼šè·¯ç”±åˆ°è¯¥é˜Ÿåˆ—ï¼Œå¦åˆ™ä¸ä¼šè·¯ç”±åˆ°è¯¥é˜Ÿåˆ—ã€‚headers ç±»å‹çš„äº¤æ¢å™¨æ€§èƒ½ä¼šå¾ˆå·®ï¼Œè€Œä¸”ä¹Ÿä¸å®ç”¨ï¼ŒåŸºæœ¬ä¸Šä¸ä¼šçœ‹åˆ°å®ƒçš„å­˜åœ¨ã€‚</p><h1 id="4springbootæ•´åˆrabbitmq"><a class="markdownIt-Anchor" href="#4springbootæ•´åˆrabbitmq"></a> 4.Springbootæ•´åˆRabbitMQ</h1><blockquote><ul><li>å¼•å…¥amqpä¾èµ–åœºæ™¯;RabbitAutoCon&gt;figurationå°±ä¼šè‡ªåŠ¨ç”Ÿ</li><li>ç»™å®¹å™¨ä¸­è‡ªåŠ¨é…ç½®äº†RabbitTemplateã€AmqpAdminã€CachingConnectionFactoryã€RabbitMessagingTemplate</li><li>@EnableRabbit:(åœ¨åˆ›å»ºäº¤æ¢æœº,é˜Ÿåˆ—æ—¶å¯ä»¥ä¸éœ€è¦,å‘é€æ¶ˆæ¯å¯ä»¥ä¸éœ€è¦è¿™ä¸ªæ³¨è§£ï¼Œç›‘å¬æ¶ˆæ¯å¿…é¡»ä½¿ç”¨è¿™ä¸ªæ³¨è§£)</li></ul></blockquote><h2 id="41å¯¼å…¥ä¾èµ–"><a class="markdownIt-Anchor" href="#41å¯¼å…¥ä¾èµ–"></a> 4.1å¯¼å…¥ä¾èµ–</h2><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!--rabbitmq--&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-amqp<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure><h2 id="42xmlé…ç½®"><a class="markdownIt-Anchor" href="#42xmlé…ç½®"></a> 4.2xmlé…ç½®</h2><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">rabbitmq:</span></span><br><span class="line">    <span class="attr">host:</span> <span class="number">192.168</span><span class="number">.234</span><span class="number">.133</span></span><br><span class="line">    <span class="attr">port:</span> <span class="number">5672</span></span><br><span class="line">    <span class="attr">virtual-host:</span> <span class="string">/</span></span><br></pre></td></tr></table></figure><h2 id="43å¼€å¯rabbitmqç›¸å…³åŠŸèƒ½"><a class="markdownIt-Anchor" href="#43å¼€å¯rabbitmqç›¸å…³åŠŸèƒ½"></a> 4.3å¼€å¯rabbitmqç›¸å…³åŠŸèƒ½</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">@EnableRabbit</span><br></pre></td></tr></table></figure><h2 id="44æ•´åˆæµ‹è¯•"><a class="markdownIt-Anchor" href="#44æ•´åˆæµ‹è¯•"></a> 4.4æ•´åˆæµ‹è¯•</h2><h3 id="441è®¤è¯†rabbitmqautoconfiguration"><a class="markdownIt-Anchor" href="#441è®¤è¯†rabbitmqautoconfiguration"></a> 4.4.1è®¤è¯†RabbitmqAutoConfiguration</h3><p>é‡Œé¢è‡ªåŠ¨æ³¨å…¥çš„ç»„ä»¶</p><p>RabbitTeamplateï¼šç”¨äºå‘é€æ¶ˆæ¯<br />AmqpAdminï¼šéœ€è¦ä¸€ä¸ªè¿æ¥å¯¹è±¡<br />CachingConnectionFactoryï¼šè¿æ¥åˆ›å»ºå·¥å‚<br />RabbitMessagingTemplateï¼šæ“ä½œæ¶ˆæ¯çš„ç±»<br />é¦–å…ˆå°±æ˜¯åˆ›å»ºAmqpAdminï¼Œå¹¶ä¸”è¿™ä¸ªæ—¶å€™éœ€è¦é…ç½®ä¸€ä¸‹è¿æ¥å·¥å‚çš„é…ç½®ä¿¡æ¯ï¼Œä¸»è¦å°±æ˜¯hostã€portå’Œvirtual-hostè™šæ‹Ÿä¸»æœº</p><h3 id="442åˆ›å»ºexchange-queue-binding"><a class="markdownIt-Anchor" href="#442åˆ›å»ºexchange-queue-binding"></a> 4.4.2åˆ›å»ºexchangeã€queueã€binding</h3><blockquote><p>å‚æ•°</p><ul><li>exchange:nameã€durableï¼ˆæŒä¹…åŒ–ï¼‰ã€autodeleteï¼ˆè‡ªåŠ¨åˆ é™¤ï¼‰</li><li>queueï¼šnameã€durableã€excusiveï¼ˆæ’ä»–ï¼Œå…¶å®ƒè¿æ¥æ˜¯å¦èƒ½å¤Ÿä¼ è¾“ä¿¡æ¯è¿›æ¥ï¼‰ã€autodelete</li></ul></blockquote><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="keyword">void</span> <span class="title function_">exchange</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="comment">//æ³¨æ„ï¼Œåˆ›å»ºäº¤æ¢æœºå°±æŒ‡å®šäº†äº¤æ¢æœºçš„ç±»å‹ä¸ºdirect</span></span><br><span class="line">    <span class="type">DirectExchange</span> <span class="variable">directExchange</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">DirectExchange</span>(<span class="string">&quot;hello.java.exchange&quot;</span>,<span class="literal">true</span>,<span class="literal">false</span>);</span><br><span class="line">    amqpAdmin.declareExchange(directExchange);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="keyword">void</span> <span class="title function_">queue</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="type">Queue</span> <span class="variable">queue</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Queue</span>(<span class="string">&quot;hello.java.queue&quot;</span>,<span class="literal">true</span>,<span class="literal">false</span>,<span class="literal">true</span>);</span><br><span class="line">    amqpAdmin.declareQueue(queue);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="keyword">void</span> <span class="title function_">binding</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="type">Binding</span> <span class="variable">binding</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Binding</span>(<span class="string">&quot;hello.java.queue&quot;</span>, Binding.DestinationType.QUEUE,<span class="string">&quot;hello.java.exchange&quot;</span>,<span class="string">&quot;hello&quot;</span>,<span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;());</span><br><span class="line">    amqpAdmin.declareBinding(binding);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="443å‘é€æ¶ˆæ¯"><a class="markdownIt-Anchor" href="#443å‘é€æ¶ˆæ¯"></a> 4.4.3å‘é€æ¶ˆæ¯</h3><blockquote><p>æ€è·¯</p><p>â‘ ç¬¬ä¸€ä¸ªå°±æ˜¯è¦çŸ¥é“åœ¨ä¼ é€æ¶ˆæ¯çš„æ—¶å€™æ˜¯éœ€è¦ä¾é æ¨¡æ¿rabbitTemplateï¼Œå®ƒé‡Œé¢æœ‰ä¸€ä¸ªmessageConverterï¼Œè¿™ä¸ªè½¬æ¢å™¨ä¸»è¦å°±æ˜¯èƒ½å¤ŸæŠŠæ¶ˆæ¯å˜æˆå¯¹åº”çš„å½¢å¼ã€‚é€š<mark>å¸¸ç”¨çš„æ˜¯simpleï¼Œè¿™ä¸ªè½¬æ¢å™¨å°±æ˜¯åºåˆ—åŒ–è½¬æ¢æˆbyteæ•°ç»„æ¥ä¼ è¾“</mark>ï¼Œä½†æ˜¯æˆ‘ä»¬å¯ä»¥å¢åŠ è‡ªå·±é…ç½®ä¸€ä¸ªJsonçš„Configè½¬æ¢å™¨ã€‚å‘é€æ¶ˆæ¯ç”¨çš„æ˜¯jsonçŠ¶æ€</p><p>â‘¡æ¥ç€å°±æ˜¯é€šè¿‡æ¨¡æ¿æ¥å‘é€</p></blockquote><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MyRabbitConfig</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> MessageConverter <span class="title function_">messageConverter</span><span class="params">()</span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">Jackson2JsonMessageConverter</span>();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><blockquote><p>å‘é€æ¶ˆæ¯ç”¨ä¾‹ï¼š</p></blockquote><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Autowired</span></span><br><span class="line">RabbitTemplate rabbitTemplate;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">sendMessage</span><span class="params">()</span>&#123;</span><br><span class="line">    <span class="type">MemberResVo</span> <span class="variable">memberResVo</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">MemberResVo</span>();</span><br><span class="line">    memberResVo.setCity(<span class="string">&quot;sss&quot;</span>);</span><br><span class="line">    memberResVo.setId(<span class="number">123L</span>);</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">        * å‚æ•°å¦‚ä¸‹ï¼šäº¤æ¢æœºåç§°ã€æ¶ˆæ¯çš„è·¯ç”±é”®ã€æ¶ˆæ¯å†…å®¹ã€ï¼ˆæ¶ˆæ¯çš„å”¯ä¸€idï¼šnew CorrelationData(UUID.randomUUID().toString)ï¼‰</span></span><br><span class="line"><span class="comment">        */</span></span><br><span class="line">    rabbitTemplate.convertAndSend(<span class="string">&quot;hello.java.exchange&quot;</span>,<span class="string">&quot;hello&quot;</span>,memberResVo);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="444æ¥æ”¶æ¶ˆæ¯"><a class="markdownIt-Anchor" href="#444æ¥æ”¶æ¶ˆæ¯"></a> 4.4.4æ¥æ”¶æ¶ˆæ¯</h3><blockquote><p>æ€è·¯</p><p>â‘ å¼€å¯æ³¨è§£EnableRabbitæ‰èƒ½å¤Ÿä½¿ç”¨@RabbitListeneræ¥ç›‘å¬ï¼Œå¹¶ä¸”æŒ‡å®šç›‘å¬é˜Ÿåˆ—å¯ä»¥æ˜¯å¤šä¸ªã€‚</p><p>â‘¡ç„¶åå°±å‘é€æ¶ˆæ¯è¿›è¡Œæµ‹è¯•</p><p>â‘¢<mark>RabbitHandlerä¸»è¦åªèƒ½å¯¹æ–¹æ³•èµ·ä½œç”¨ï¼Œ@RabbitListenerç±»å’Œæ–¹æ³•éƒ½å¯ä»¥</mark>ï¼Œä½†æ˜¯handleræœ‰åˆ©äºæ–¹æ³•çš„é‡è½½ï¼šç”¨äºæ¥æ”¶ä¸åŒç±»å‹çš„æ¶ˆæ¯</p></blockquote><p><img src="https://img-blog.csdnimg.cn/direct/b7e031601b6b4b5b984f38739722e814.jpeg#pic_center" alt="åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°" /></p><h1 id="5rabbitmqå®ç°æ¶ˆæ¯çš„å¯é æŠµè¾¾"><a class="markdownIt-Anchor" href="#5rabbitmqå®ç°æ¶ˆæ¯çš„å¯é æŠµè¾¾"></a> 5.RabbitMQå®ç°æ¶ˆæ¯çš„å¯é æŠµè¾¾</h1><h2 id="51å¼•å…¥èƒŒæ™¯"><a class="markdownIt-Anchor" href="#51å¼•å…¥èƒŒæ™¯"></a> 5.1å¼•å…¥èƒŒæ™¯</h2><p>ä¸ºä¿è¯æ¶ˆæ¯ä¸ä¸¢å¤±ï¼Œå¯é æŠµè¾¾ï¼Œå¯ä»¥ä½¿ç”¨äº‹åŠ¡æ¶ˆæ¯ï¼Œä½†æ˜¯æ€§èƒ½ä¸‹é™<strong>250å€</strong>ï¼Œä¸ºæ­¤å¼•å…¥ç¡®è®¤æœºåˆ¶ï¼Œæ¥å®ç°æ¶ˆæ¯çš„å¯é æŠµè¾¾</p><h2 id="52ç¡®è®¤æœºåˆ¶åˆ†ç±»"><a class="markdownIt-Anchor" href="#52ç¡®è®¤æœºåˆ¶åˆ†ç±»"></a> 5.2ç¡®è®¤æœºåˆ¶åˆ†ç±»</h2><p>RabbitMQ æ¶ˆæ¯ç¡®è®¤æœºåˆ¶åˆ†ä¸ºä¸¤å¤§ç±»ï¼š<mark><strong>å‘é€æ–¹ç¡®è®¤ã€æ¥æ”¶æ–¹ç¡®è®¤</strong></mark>ã€‚</p><p>å…¶ä¸­å‘é€æ–¹ç¡®è®¤åˆåˆ†ä¸ºï¼š<mark>ç”Ÿäº§è€…åˆ°äº¤æ¢å™¨åˆ°ç¡®è®¤ã€äº¤æ¢å™¨åˆ°é˜Ÿåˆ—çš„ç¡®è®¤</mark>ã€‚å¦‚ä¸‹å›¾</p><p><img src="https://gitee.com/linhaipengg/md_-picture/raw/master/image-20240319101439936.png" alt="image-20240319095647841" /></p><ul><li><mark>confirmCallback ç¡®è®¤æ¨¡å¼</mark>ï¼šç¡®è®¤æ¶ˆæ¯æ˜¯å¦åˆ°è¾¾æ¶ˆæ¯ä»£ç†</li><li><mark>returnCallbacké€€å›æ¨¡å¼</mark>ï¼šè‹¥æ¶ˆæ¯æ²¡æœ‰ä¼ é€’ç»™æŒ‡å®šé˜Ÿåˆ—ï¼Œå°±è§¦å‘è¿™ä¸ªå¤±è´¥å›è°ƒ</li><li><mark>ackæœºåˆ¶ï¼šæ¶ˆè´¹è€…ç¡®è®¤æ¨¡å¼</mark><ul><li>CKæœºåˆ¶æ˜¯æ¶ˆè´¹è€…ä»RabbitMQæ”¶åˆ°æ¶ˆæ¯å¹¶å¤„ç†å®Œæˆåï¼Œåé¦ˆç»™RabbitMQï¼Œ<mark>RabbitMQæ”¶åˆ°åé¦ˆåæ‰å°†æ­¤æ¶ˆæ¯ä»é˜Ÿåˆ—ä¸­åˆ é™¤</mark>ã€‚</li><li>å¦‚æœä¸€ä¸ªæ¶ˆè´¹è€…åœ¨å¤„ç†æ¶ˆæ¯å‡ºç°äº†ç½‘ç»œä¸ç¨³å®šã€æœåŠ¡å™¨å¼‚å¸¸ç­‰ç°è±¡ï¼Œé‚£ä¹ˆå°±ä¸ä¼šæœ‰ACKåé¦ˆï¼ŒRabbitMQä¼šè®¤ä¸ºè¿™ä¸ªæ¶ˆæ¯æ²¡æœ‰æ­£å¸¸æ¶ˆè´¹ï¼Œä¼šå°†æ¶ˆæ¯é‡æ–°æ”¾å…¥é˜Ÿåˆ—ä¸­</li></ul></li></ul><h3 id="521confirmcallback-ç¡®è®¤æ¨¡å¼æ¶ˆæ¯ç”Ÿäº§è€…ç¡®è®¤"><a class="markdownIt-Anchor" href="#521confirmcallback-ç¡®è®¤æ¨¡å¼æ¶ˆæ¯ç”Ÿäº§è€…ç¡®è®¤"></a> 5.2.1ConfirmCallback (ç¡®è®¤æ¨¡å¼ï¼šæ¶ˆæ¯ç”Ÿäº§è€…ç¡®è®¤)</h3><h4 id="1å¼€å¯ç¡®è®¤é…ç½®"><a class="markdownIt-Anchor" href="#1å¼€å¯ç¡®è®¤é…ç½®"></a> ï¼ˆ1ï¼‰å¼€å¯ç¡®è®¤é…ç½®</h4><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#è€ç‰ˆæœ¬</span></span><br><span class="line"><span class="attr">spring:</span></span><br><span class="line"><span class="attr">rabbitmq:</span></span><br><span class="line"><span class="attr">publisher-confirms:</span> <span class="literal">true</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#æ–°ç‰ˆæœ¬</span></span><br><span class="line"><span class="attr">spring:</span></span><br><span class="line"><span class="attr">rabbitmq:</span></span><br><span class="line"><span class="attr">publisher-confirms-type:</span> <span class="string">correlated</span></span><br></pre></td></tr></table></figure><h4 id="2å®ç°confirmcallbackå›è°ƒæ¥å£"><a class="markdownIt-Anchor" href="#2å®ç°confirmcallbackå›è°ƒæ¥å£"></a> ï¼ˆ2ï¼‰å®ç°ConfirmCallbackå›è°ƒæ¥å£</h4><ul><li>ConfirmCallback æ˜¯ä¸€ä¸ª<mark>å›è°ƒæ¥å£</mark>ï¼Œæ¶ˆæ¯å‘é€åˆ° Broker åè§¦å‘å›è°ƒï¼Œç¡®è®¤æ¶ˆæ¯æ˜¯å¦åˆ°è¾¾ Broker æœåŠ¡å™¨ï¼Œ<strong>ä¹Ÿå°±æ˜¯<mark>åªç¡®è®¤æ˜¯å¦æ­£ç¡®åˆ°è¾¾ Exchange ä¸­</mark>ã€‚</strong></li></ul><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MyRabbitConfig</span> &#123;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    RabbitTemplate rabbitTemplate;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> MessageConverter <span class="title function_">messageConverter</span><span class="params">()</span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">Jackson2JsonMessageConverter</span>();</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">//æ¶ˆæ¯åªè¦è¢« broker æ¥æ”¶åˆ°å°±ä¼šæ‰§è¡Œ confirmCallbackï¼Œå¦‚æœæ˜¯ cluster æ¨¡å¼ï¼Œéœ€è¦æ‰€æœ‰broker æ¥æ”¶åˆ°æ‰ä¼šè°ƒç”¨ confirmCallbackã€‚</span></span><br><span class="line">    <span class="comment">//ç¡®è®¤æ¶ˆæ¯é€åˆ°äº¤æ¢æœº(Exchange)å›è°ƒ</span></span><br><span class="line">    <span class="meta">@PostConstruct</span><span class="comment">//åˆ›å»ºMyBabbiConfigå¯¹è±¡åï¼Œæ‰§è¡Œè¯¥æ–¹æ³•</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">initRabbitTemplate</span><span class="params">()</span>&#123;</span><br><span class="line">        <span class="comment">//ç¡®è®¤æ¶ˆæ¯é€åˆ°é˜Ÿåˆ—(Queue)å›è°ƒ</span></span><br><span class="line">        rabbitTemplate.setReturnsCallback(<span class="keyword">new</span> <span class="title class_">RabbitTemplate</span>.ReturnsCallback()</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">returnedMessage</span><span class="params">(ReturnedMessage returnedMessage)</span></span><br><span class="line">            &#123;</span><br><span class="line">                System.out.println(<span class="string">&quot;\nç¡®è®¤æ¶ˆæ¯é€åˆ°é˜Ÿåˆ—(Queue)ç»“æœï¼š&quot;</span>);</span><br><span class="line">                System.out.println(<span class="string">&quot;å‘ç”Ÿæ¶ˆæ¯ï¼š&quot;</span> + returnedMessage.getMessage());</span><br><span class="line">                System.out.println(<span class="string">&quot;å›åº”ç ï¼š&quot;</span> + returnedMessage.getReplyCode());</span><br><span class="line">                System.out.println(<span class="string">&quot;å›åº”ä¿¡æ¯ï¼š&quot;</span> + returnedMessage.getReplyText());</span><br><span class="line">                System.out.println(<span class="string">&quot;äº¤æ¢æœºï¼š&quot;</span> + returnedMessage.getExchange());</span><br><span class="line">                System.out.println(<span class="string">&quot;è·¯ç”±é”®ï¼š&quot;</span> + returnedMessage.getRoutingKey());</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><blockquote><p>è¢« broker æ¥æ”¶åˆ°åªèƒ½<mark>è¡¨ç¤º message å·²ç»åˆ°è¾¾äº¤æ¢æœº</mark>ï¼Œå¹¶ä¸èƒ½ä¿è¯æ¶ˆæ¯ä¸€å®šä¼šè¢«æŠ•é€’åˆ°ç›®æ ‡ queue é‡Œã€‚æ‰€ä»¥éœ€è¦ç”¨åˆ°<mark>æ¥ä¸‹æ¥çš„ returnCallback</mark></p></blockquote><h3 id="522returncallbackå›é€€æ¨¡å¼äº¤æ¢æœºç¡®è®¤"><a class="markdownIt-Anchor" href="#522returncallbackå›é€€æ¨¡å¼äº¤æ¢æœºç¡®è®¤"></a> 5.2.2ReturnCallbackï¼ˆå›é€€æ¨¡å¼ï¼šäº¤æ¢æœºç¡®è®¤ï¼‰</h3><ul><li>é€š<mark>è¿‡å®ç° ReturnCallback æ¥å£</mark>ï¼Œå¯åŠ¨æ¶ˆæ¯å¤±è´¥è¿”å›ï¼Œæ­¤æ¥å£<mark>æ˜¯åœ¨äº¤æ¢å™¨è·¯ç”±ä¸åˆ°é˜Ÿåˆ—æ—¶è§¦å‘å›è°ƒ</mark></li><li>è¯¥æ–¹æ³•å¯ä»¥ä¸ä½¿ç”¨ï¼Œå› ä¸ºäº¤æ¢å™¨å’Œé˜Ÿåˆ—æ˜¯åœ¨ä»£ç é‡Œç»‘å®šçš„ï¼Œ<mark>å¦‚æœæ¶ˆæ¯æˆåŠŸæŠ•é€’åˆ° Broker åå‡ ä¹ä¸å­˜åœ¨ç»‘å®šé˜Ÿåˆ—å¤±è´¥ï¼Œé™¤éä½ ä»£ç å†™é”™äº†ã€‚</mark></li></ul><h4 id="1å¼€å¯å›é€€é…ç½®"><a class="markdownIt-Anchor" href="#1å¼€å¯å›é€€é…ç½®"></a> ï¼ˆ1ï¼‰å¼€å¯å›é€€é…ç½®</h4><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">spring:</span></span><br><span class="line"><span class="attr">rabbit:</span></span><br><span class="line"><span class="comment">#å¼€å¯å‘é€ç«¯æ¶ˆæ¯æŠµè¾¾Queueç¡®è®¤</span></span><br><span class="line"><span class="attr">publisher-returns:</span> <span class="literal">true</span></span><br><span class="line"><span class="comment">#åªè¦æ¶ˆæ¯ä¸èƒ½æŠµè¾¾queueæ—¶ï¼Œè¯¥æ¶ˆæ¯ä¸ä¼šè¢«ä¸¢å¼ƒï¼Œè€Œæ˜¯ä¼šè¢«è¿”å›ç»™ç”Ÿäº§è€…ï¼šå¯ä»¥è®°å½•ä¸‹è¯¦ç»†åˆ°æŠ•é€’æ•°æ®ï¼Œå®šæœŸçš„å·¡æ£€æˆ–è€…è‡ªåŠ¨çº é”™éƒ½éœ€è¦è¿™äº›æ•°æ®</span></span><br><span class="line"><span class="attr">template:</span></span><br><span class="line"><span class="attr">mandatory:</span> <span class="literal">true</span></span><br></pre></td></tr></table></figure><h4 id="2å®ç°returncallbackå›è°ƒæ¥å£"><a class="markdownIt-Anchor" href="#2å®ç°returncallbackå›è°ƒæ¥å£"></a> ï¼ˆ2ï¼‰å®ç°ReturnCallbackå›è°ƒæ¥å£</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MyRabbitConfig</span> &#123;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    RabbitTemplate rabbitTemplate;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> MessageConverter <span class="title function_">messageConverter</span><span class="params">()</span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">Jackson2JsonMessageConverter</span>();</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@PostConstruct</span><span class="comment">//åˆ›å»ºMyBabbiConfigå¯¹è±¡åï¼Œæ‰§è¡Œè¯¥æ–¹æ³•</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">initRabbitTemplate</span><span class="params">()</span>&#123;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">//ç¡®è®¤æ¶ˆæ¯é€åˆ°é˜Ÿåˆ—(Queue)å¤±è´¥å›è°ƒï¼šæ³¨æ„æ˜¯å¤±è´¥</span></span><br><span class="line">        rabbitTemplate.setReturnsCallback(<span class="keyword">new</span> <span class="title class_">RabbitTemplate</span>.ReturnsCallback()</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">returnedMessage</span><span class="params">(ReturnedMessage returnedMessage)</span></span><br><span class="line">            &#123;</span><br><span class="line">                System.out.println(<span class="string">&quot;\nç¡®è®¤æ¶ˆæ¯é€åˆ°é˜Ÿåˆ—(Queue)ç»“æœï¼š&quot;</span>);</span><br><span class="line">                System.out.println(<span class="string">&quot;å‘ç”Ÿæ¶ˆæ¯ï¼š&quot;</span> + returnedMessage.getMessage());</span><br><span class="line">                System.out.println(<span class="string">&quot;å›åº”ç ï¼š&quot;</span> + returnedMessage.getReplyCode());</span><br><span class="line">                System.out.println(<span class="string">&quot;å›åº”ä¿¡æ¯ï¼š&quot;</span> + returnedMessage.getReplyText());</span><br><span class="line">                System.out.println(<span class="string">&quot;äº¤æ¢æœºï¼š&quot;</span> + returnedMessage.getExchange());</span><br><span class="line">                System.out.println(<span class="string">&quot;è·¯ç”±é”®ï¼š&quot;</span> + returnedMessage.getRoutingKey());</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line">        </span><br><span class="line">        <span class="comment">//ç¡®è®¤æ¶ˆæ¯é€åˆ°é˜Ÿåˆ—(Queue)å›è°ƒ</span></span><br><span class="line">        rabbitTemplate.setReturnsCallback(<span class="keyword">new</span> <span class="title class_">RabbitTemplate</span>.ReturnsCallback()</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">returnedMessage</span><span class="params">(ReturnedMessage returnedMessage)</span></span><br><span class="line">            &#123;</span><br><span class="line">                System.out.println(<span class="string">&quot;\nç¡®è®¤æ¶ˆæ¯é€åˆ°é˜Ÿåˆ—(Queue)ç»“æœï¼š&quot;</span>);</span><br><span class="line">                System.out.println(<span class="string">&quot;å‘ç”Ÿæ¶ˆæ¯ï¼š&quot;</span> + returnedMessage.getMessage());</span><br><span class="line">                System.out.println(<span class="string">&quot;å›åº”ç ï¼š&quot;</span> + returnedMessage.getReplyCode());</span><br><span class="line">                System.out.println(<span class="string">&quot;å›åº”ä¿¡æ¯ï¼š&quot;</span> + returnedMessage.getReplyText());</span><br><span class="line">                System.out.println(<span class="string">&quot;äº¤æ¢æœºï¼š&quot;</span> + returnedMessage.getExchange());</span><br><span class="line">                System.out.println(<span class="string">&quot;è·¯ç”±é”®ï¼š&quot;</span> + returnedMessage.getRoutingKey());</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="523ackæœºåˆ¶ç¡®è®¤æ¨¡å¼æ¶ˆè´¹è€…ç¡®è®¤"><a class="markdownIt-Anchor" href="#523ackæœºåˆ¶ç¡®è®¤æ¨¡å¼æ¶ˆè´¹è€…ç¡®è®¤"></a> 5.2.3ACKæœºåˆ¶ï¼ˆç¡®è®¤æ¨¡å¼ï¼šæ¶ˆè´¹è€…ç¡®è®¤ï¼‰</h3><ol><li>æ¶ˆè´¹è€…ç¡®è®¤å‘ç”Ÿåœ¨ç›‘å¬é˜Ÿåˆ—çš„æ¶ˆè´¹è€…å¤„ç†ä¸šåŠ¡å¤±è´¥ï¼Œå¦‚ï¼šå‘ç”Ÿäº†å¼‚å¸¸ï¼Œä¸ç¬¦åˆè¦æ±‚çš„æ•°æ®ç­‰ï¼Œè¿™äº›åœºæ™¯æˆ‘ä»¬å°±éœ€è¦æ‰‹åŠ¨å¤„ç†æ¶ˆæ¯ï¼Œæ¯”å¦‚é‡æ–°å‘é€æˆ–è€…ä¸¢å¼ƒã€‚</li><li>RabbitMQ æ¶ˆæ¯ç¡®è®¤æœºåˆ¶ï¼ˆACKï¼‰é»˜è®¤æ˜¯è‡ªåŠ¨ç¡®è®¤çš„ï¼Œè‡ªåŠ¨ç¡®è®¤ä¼šåœ¨æ¶ˆæ¯å‘é€ç»™æ¶ˆè´¹è€…åç«‹å³ç¡®è®¤ï¼Œä½†<mark>å­˜åœ¨ä¸¢å¤±æ¶ˆæ¯</mark>çš„å¯èƒ½ï¼Œå¦‚æœæ¶ˆè´¹ç«¯æ¶ˆè´¹é€»è¾‘æŠ›å‡ºå¼‚å¸¸ï¼Œå‡å¦‚ä½ ç”¨å›æ»šäº†ä¹Ÿåªæ˜¯ä¿è¯äº†æ•°æ®çš„ä¸€è‡´æ€§ï¼Œä½†æ˜¯æ¶ˆæ¯è¿˜æ˜¯ä¸¢äº†ï¼Œä¹Ÿå°±æ˜¯æ¶ˆè´¹ç«¯æ²¡æœ‰å¤„ç†æˆåŠŸè¿™æ¡æ¶ˆæ¯ï¼Œé‚£ä¹ˆå°±ç›¸å½“äºä¸¢å¤±äº†æ¶ˆæ¯ã€‚</li></ol><h4 id="1æ¶ˆæ¯æ¥æ”¶ç¡®è®¤æ¨¡å¼ç±»å‹"><a class="markdownIt-Anchor" href="#1æ¶ˆæ¯æ¥æ”¶ç¡®è®¤æ¨¡å¼ç±»å‹"></a> ï¼ˆ1ï¼‰æ¶ˆæ¯æ¥æ”¶ç¡®è®¤æ¨¡å¼ç±»å‹</h4><ol><li><p>AcknowledgeMode.NONEï¼š<mark>è‡ªåŠ¨ç¡®è®¤</mark>ã€‚</p><ul><li>é»˜è®¤è‡ªåŠ¨ackï¼Œ<mark>æ¶ˆæ¯è¢«æ¶ˆè´¹è€…æ”¶åˆ°ï¼ˆæ³¨æ„ï¼šåªæ˜¯æ”¶åˆ°ï¼‰ï¼Œå°±ä¼šä»brokerçš„queueä¸­ç§»é™¤</mark></li><li>ä½†<mark>å­˜åœ¨ä¸¢å¤±æ¶ˆæ¯</mark>çš„å¯èƒ½ï¼Œå¦‚æœ<mark>æ¶ˆè´¹ç«¯æ¶ˆè´¹é€»è¾‘æŠ›å‡ºå¼‚å¸¸</mark>ï¼Œå‡å¦‚ä½ ç”¨å›æ»šäº†ä¹Ÿåªæ˜¯ä¿è¯äº†æ•°æ®çš„ä¸€è‡´æ€§ï¼Œä½†æ˜¯æ¶ˆæ¯è¿˜æ˜¯ä¸¢äº†</li></ul></li><li><p>AcknowledgeMode.AUTOï¼šæ ¹æ®æƒ…å†µç¡®è®¤ã€‚</p></li><li><p>AcknowledgeMode.MANUALï¼š<mark>æ‰‹åŠ¨ç¡®è®¤</mark>ã€‚</p><p>ç¡®è®¤è¿‡ç¨‹ï¼šå°±ç®—æ¶ˆè´¹è€…å·²ç»æ‹¿åˆ°äº†æ¶ˆæ¯,<mark>ä½†æ˜¯æ²¡æœ‰ç¡®è®¤</mark>,é˜Ÿåˆ—ä¸­çš„æ¶ˆæ¯ä»ç„¶ä¸èƒ½ç§»é™¤,<mark>åªä¸è¿‡çŠ¶æ€ç”±readyå˜ä¸ºunacked</mark>ï¼Œæ¶ˆæ¯å¤„ç†åˆ†ä¸ºä»¥ä¸‹ä¸‰ç§æƒ…å†µï¼š</p><ol><li><mark><strong>æ¶ˆæ¯å¤„ç†æˆåŠŸ</strong></mark>ï¼Œ<mark>ack()ï¼Œæ¥å—ä¸‹ä¸€ä¸ªæ¶ˆæ¯ï¼Œæ­¤æ¶ˆæ¯brokerå°±ä¼šç§»é™¤</mark></li><li><mark><strong>æ¶ˆæ¯å¤„ç†å¤±è´¥</strong></mark>ï¼Œnack()/reject()ï¼Œé‡æ–°å‘é€ç»™å…¶ä»–äººè¿›è¡Œå¤„ç†ï¼Œæˆ–è€…å®¹é”™å¤„ç†åack</li><li>æ¶ˆæ¯ä¸€ç›´<mark>æ²¡æœ‰è°ƒç”¨ack/nack</mark>æ–¹æ³•ï¼Œ<mark>brokerè®¤ä¸ºæ­¤æ¶ˆæ¯æ­£åœ¨è¢«å¤„ç†ï¼Œä¸ä¼šæŠ•é€’ç»™åˆ«äºº</mark>ï¼Œæ­¤æ—¶å®¢æˆ·ç«¯æ–­å¼€ï¼Œæ¶ˆæ¯ä¸ä¼šè¢«brokerç§»é™¤ï¼Œä¼šæŠ•é€’ç»™åˆ«äºº</li></ol><p><img src="https://img-blog.csdnimg.cn/20210121164244709.jpg" alt="img" /></p></li></ol><h4 id="2æ‰‹åŠ¨ç¡®è®¤å›å¤æ–¹æ³•"><a class="markdownIt-Anchor" href="#2æ‰‹åŠ¨ç¡®è®¤å›å¤æ–¹æ³•"></a> ï¼ˆ2ï¼‰æ‰‹åŠ¨ç¡®è®¤å›å¤æ–¹æ³•</h4><ul><li>æ¶ˆè´¹è€…è·å–åˆ°æ¶ˆæ¯ï¼ŒæˆåŠŸå¤„ç†ï¼Œå¯ä»¥å›å¤Ackç»™Broker<ul><li>basic.ackï¼šç”¨äº<mark>è‚¯å®šç¡®è®¤</mark>ï¼›<mark>brokerå°†ç§»é™¤æ­¤æ¶ˆæ¯</mark></li><li>basic.nackï¼šç”¨äº<mark>å¦å®šç¡®è®¤</mark>ï¼›<mark><strong>å¯ä»¥æŒ‡å®šbrokeræ˜¯å¦ä¸¢å¼ƒæ­¤æ¶ˆæ¯</strong></mark>ï¼Œå¯ä»¥æ‰¹é‡</li><li>basic.rejectï¼šç”¨äº<mark>å¦å®šç¡®è®¤å½“å‰æ¶ˆæ¯</mark>ï¼›åŒä¸Šï¼Œä½†<mark>ä¸èƒ½æ‰¹é‡</mark></li></ul></li></ul><h4 id="3basicackæ–¹æ³•"><a class="markdownIt-Anchor" href="#3basicackæ–¹æ³•"></a> ï¼ˆ3ï¼‰basicAckæ–¹æ³•</h4><p>basicAck æ–¹æ³•ç”¨äºç¡®è®¤å½“å‰æ¶ˆæ¯ï¼ŒChannel ç±»ä¸­çš„ basicAck æ–¹æ³•å®šä¹‰å¦‚ä¸‹ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">void</span> <span class="title function_">basicAck</span><span class="params">(<span class="type">long</span> deliveryTag, <span class="type">boolean</span> multiple)</span> <span class="keyword">throws</span> IOException;</span><br></pre></td></tr></table></figure><p><strong>å‚æ•°è¯´æ˜ï¼š</strong></p><ol><li><mark><strong>long deliveryTag</strong></mark>ï¼š<mark>å”¯ä¸€æ ‡è¯† ID</mark>ï¼Œå½“ä¸€ä¸ªæ¶ˆè´¹è€…å‘ RabbitMQ æ³¨å†Œåï¼Œä¼šå»ºç«‹èµ·ä¸€ä¸ª Channel ï¼ŒRabbitMQ ä¼šç”¨ basic.deliver æ–¹æ³•å‘æ¶ˆè´¹è€…æ¨é€æ¶ˆæ¯ï¼Œè¿™ä¸ªæ–¹æ³•æºå¸¦äº†ä¸€ä¸ª delivery tagï¼Œ å®ƒä»£è¡¨äº† <mark>RabbitMQ å‘è¯¥ Channel æŠ•é€’çš„è¿™æ¡æ¶ˆæ¯çš„å”¯ä¸€æ ‡è¯† ID</mark>ï¼Œæ˜¯ä¸€ä¸ªå•è°ƒé€’å¢çš„æ­£æ•´æ•°ï¼Œdelivery tag çš„èŒƒå›´ä»…é™äº Channel</li><li>**<mark>boolean multiple</mark>ï¼š**æ˜¯å¦<mark>æ‰¹å¤„ç†</mark>ï¼Œå½“è¯¥å‚æ•°ä¸º true æ—¶ï¼Œåˆ™å¯ä»¥ä¸€æ¬¡æ€§ç¡®è®¤ delivery_tag å°äºç­‰äºä¼ å…¥å€¼çš„æ‰€æœ‰æ¶ˆæ¯ã€‚</li></ol><h4 id="4basicnackæ–¹æ³•"><a class="markdownIt-Anchor" href="#4basicnackæ–¹æ³•"></a> ï¼ˆ4ï¼‰basicNackæ–¹æ³•</h4><ol><li>basicNack æ–¹æ³•<mark>ç”¨äºå¦å®šå½“å‰æ¶ˆæ¯</mark>ã€‚</li><li>basicReject æ–¹æ³•ä¸€æ¬¡åªèƒ½æ‹’ç»ä¸€æ¡æ¶ˆæ¯</li><li>å¦‚æœæƒ³æ‰¹é‡æ‹’ç»æ¶ˆæ¯ï¼Œåˆ™å¯ä»¥ä½¿ç”¨ basicNack æ–¹æ³•ã€‚<mark>æ¶ˆè´¹è€…å®¢æˆ·ç«¯å¯ä»¥ä½¿ç”¨ channel.basicNack æ–¹æ³•</mark>æ¥å®ç°ï¼Œæ–¹æ³•å®šä¹‰å¦‚ä¸‹ï¼š</li></ol><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">void</span> <span class="title function_">basicNack</span><span class="params">(<span class="type">long</span> deliveryTag, <span class="type">boolean</span> multiple, <span class="type">boolean</span> requeue)</span> <span class="keyword">throws</span> IOException;</span><br></pre></td></tr></table></figure><p><strong>å‚æ•°è¯´æ˜ï¼š</strong></p><ol><li>**long deliveryTagï¼š**å”¯ä¸€æ ‡è¯† IDã€‚</li><li>**boolean multipleï¼š**ä¸Šé¢å·²ç»è§£é‡Šã€‚</li><li>**boolean requeueï¼š**å¦‚æœ <mark>requeue å‚æ•°è®¾ç½®ä¸º true</mark>ï¼Œåˆ™ <mark>RabbitMQ ä¼šé‡æ–°å°†è¿™æ¡æ¶ˆæ¯å­˜å…¥é˜Ÿåˆ—</mark>ï¼Œä»¥ä¾¿å‘é€ç»™ä¸‹ä¸€ä¸ªè®¢é˜…çš„æ¶ˆè´¹è€…ï¼› å¦‚æœ requeue å‚æ•°è®¾ç½®ä¸º falseï¼Œåˆ™ RabbitMQ ç«‹å³ä¼šè¿˜æŠŠæ¶ˆæ¯ä»é˜Ÿåˆ—ä¸­ç§»é™¤ï¼Œè€Œä¸ä¼šæŠŠå®ƒå‘é€ç»™æ–°çš„æ¶ˆè´¹è€…ã€‚</li></ol><h4 id="5basicrejectæ–¹æ³•"><a class="markdownIt-Anchor" href="#5basicrejectæ–¹æ³•"></a> ï¼ˆ5ï¼‰basicRejectæ–¹æ³•</h4><p>basicReject æ–¹æ³•ç”¨äºæ˜ç¡®æ‹’ç»å½“å‰çš„æ¶ˆæ¯è€Œä¸æ˜¯ç¡®è®¤ã€‚</p><p>Channel ç±»ä¸­çš„basicReject æ–¹æ³•å®šä¹‰å¦‚ä¸‹ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">void</span> <span class="title function_">basicReject</span><span class="params">(<span class="type">long</span> deliveryTag, <span class="type">boolean</span> requeue)</span> <span class="keyword">throws</span> IOException;</span><br></pre></td></tr></table></figure><p><strong>å‚æ•°è¯´æ˜ï¼š</strong></p><ol><li>**long deliveryTagï¼š**å”¯ä¸€æ ‡è¯† IDã€‚</li><li>**boolean requeueï¼š**ä¸Šé¢å·²ç»è§£é‡Šã€‚</li></ol><blockquote><p>æµ‹è¯•åœºæ™¯ï¼š</p><ul><li>å‘é€äº”ä¸ªæ¶ˆæ¯æµ‹è¯•,</li><li>æ­¤æ—¶å…³é—­æœåŠ¡æœåŠ¡,æ¶ˆæ¯çš„çŠ¶æ€ç”±unackedå˜ä¸ºready,ä¸‹æ¬¡å®¢æˆ·ç«¯æœåŠ¡å¯åŠ¨åˆä¼šæ¥æ”¶åˆ°æ¶ˆæ¯readyå˜ä¸ºunacked</li><li>é™¤éæ‰‹åŠ¨ç¡®è®¤</li></ul></blockquote><h4 id="6å¼€å¯æ‰‹åŠ¨ackæœºåˆ¶"><a class="markdownIt-Anchor" href="#6å¼€å¯æ‰‹åŠ¨ackæœºåˆ¶"></a> ï¼ˆ6ï¼‰å¼€å¯æ‰‹åŠ¨ackæœºåˆ¶</h4><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">spring:</span></span><br><span class="line"><span class="attr">listener:</span></span><br><span class="line"><span class="attr">simple:</span></span><br><span class="line"><span class="attr">acknowledge-mode:</span> <span class="string">manual</span></span><br></pre></td></tr></table></figure><h4 id="7æ¶ˆè´¹è€…æ¶ˆè´¹æ¶ˆæ¯å¹¶æ‰‹åŠ¨ç¡®è®¤"><a class="markdownIt-Anchor" href="#7æ¶ˆè´¹è€…æ¶ˆè´¹æ¶ˆæ¯å¹¶æ‰‹åŠ¨ç¡®è®¤"></a> ï¼ˆ7ï¼‰æ¶ˆè´¹è€…æ¶ˆè´¹æ¶ˆæ¯å¹¶æ‰‹åŠ¨ç¡®è®¤</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.pjb.receiver;</span><br><span class="line"> </span><br><span class="line"><span class="keyword">import</span> com.rabbitmq.client.Channel;</span><br><span class="line"><span class="keyword">import</span> org.springframework.amqp.core.Message;</span><br><span class="line"><span class="keyword">import</span> org.springframework.amqp.rabbit.listener.api.ChannelAwareMessageListener;</span><br><span class="line"><span class="keyword">import</span> org.springframework.stereotype.Component;</span><br><span class="line"> </span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * æ¥æ”¶è€…</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> pan_junbiao</span></span><br><span class="line"><span class="comment"> **/</span></span><br><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Receiver</span> <span class="keyword">implements</span> <span class="title class_">ChannelAwareMessageListener</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onMessage</span><span class="params">(Message message, Channel channel)</span> <span class="keyword">throws</span> Exception</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="type">long</span> <span class="variable">deliveryTag</span> <span class="operator">=</span> message.getMessageProperties().getDeliveryTag();</span><br><span class="line">        <span class="keyword">try</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">if</span> (<span class="string">&quot;queue_name&quot;</span>.equals(message.getMessageProperties().getConsumerQueue()))</span><br><span class="line">            &#123;</span><br><span class="line">                System.out.println(<span class="string">&quot;æ¶ˆè´¹çš„æ¶ˆæ¯æ¥è‡ªçš„é˜Ÿåˆ—åä¸ºï¼š&quot;</span>+message.getMessageProperties().getConsumerQueue());</span><br><span class="line">                System.out.println(<span class="string">&quot;æ¥æ”¶æ¶ˆæ¯: &quot;</span> + <span class="keyword">new</span> <span class="title class_">String</span>(message.getBody(), <span class="string">&quot;UTF-8&quot;</span>));</span><br><span class="line">                System.out.println(<span class="string">&quot;æ‰§è¡Œqueue_nameä¸­çš„æ¶ˆæ¯çš„ä¸šåŠ¡å¤„ç†æµç¨‹......&quot;</span>);</span><br><span class="line">            &#125;</span><br><span class="line"> </span><br><span class="line">            <span class="keyword">if</span> (<span class="string">&quot;fanout.A&quot;</span>.equals(message.getMessageProperties().getConsumerQueue()))</span><br><span class="line">            &#123;</span><br><span class="line">                System.out.println(<span class="string">&quot;æ¶ˆè´¹çš„æ¶ˆæ¯æ¥è‡ªçš„é˜Ÿåˆ—åä¸ºï¼š&quot;</span> + message.getMessageProperties().getConsumerQueue());</span><br><span class="line">                System.out.println(<span class="string">&quot;æ¥æ”¶æ¶ˆæ¯: &quot;</span> + <span class="keyword">new</span> <span class="title class_">String</span>(message.getBody(), <span class="string">&quot;UTF-8&quot;</span>));</span><br><span class="line">                System.out.println(<span class="string">&quot;æ‰§è¡Œfanout.Aä¸­çš„æ¶ˆæ¯çš„ä¸šåŠ¡å¤„ç†æµç¨‹......&quot;</span>);</span><br><span class="line">            &#125;</span><br><span class="line"> </span><br><span class="line">            <span class="comment">/**</span></span><br><span class="line"><span class="comment">             * ç¡®è®¤æ¶ˆæ¯ï¼Œå‚æ•°è¯´æ˜ï¼š</span></span><br><span class="line"><span class="comment">             * long deliveryTagï¼šå”¯ä¸€æ ‡è¯† IDã€‚</span></span><br><span class="line"><span class="comment">             * boolean multipleï¼šæ˜¯å¦æ‰¹å¤„ç†ï¼Œå½“è¯¥å‚æ•°ä¸º true æ—¶ï¼Œ</span></span><br><span class="line"><span class="comment">             * åˆ™å¯ä»¥ä¸€æ¬¡æ€§ç¡®è®¤ deliveryTag å°äºç­‰äºä¼ å…¥å€¼çš„æ‰€æœ‰æ¶ˆæ¯ã€‚</span></span><br><span class="line"><span class="comment">             */</span></span><br><span class="line">            channel.basicAck(deliveryTag, <span class="literal">true</span>);</span><br><span class="line"> </span><br><span class="line">            <span class="comment">/**</span></span><br><span class="line"><span class="comment">             * å¦å®šæ¶ˆæ¯ï¼Œå‚æ•°è¯´æ˜ï¼š</span></span><br><span class="line"><span class="comment">             * long deliveryTagï¼šå”¯ä¸€æ ‡è¯† IDã€‚</span></span><br><span class="line"><span class="comment">             * boolean multipleï¼šæ˜¯å¦æ‰¹å¤„ç†ï¼Œå½“è¯¥å‚æ•°ä¸º true æ—¶ï¼Œ</span></span><br><span class="line"><span class="comment">             * åˆ™å¯ä»¥ä¸€æ¬¡æ€§ç¡®è®¤ deliveryTag å°äºç­‰äºä¼ å…¥å€¼çš„æ‰€æœ‰æ¶ˆæ¯ã€‚</span></span><br><span class="line"><span class="comment">             * boolean requeueï¼šå¦‚æœ requeue å‚æ•°è®¾ç½®ä¸º trueï¼Œ</span></span><br><span class="line"><span class="comment">             * åˆ™ RabbitMQ ä¼šé‡æ–°å°†è¿™æ¡æ¶ˆæ¯å­˜å…¥é˜Ÿåˆ—ï¼Œä»¥ä¾¿å‘é€ç»™ä¸‹ä¸€ä¸ªè®¢é˜…çš„æ¶ˆè´¹è€…ï¼›</span></span><br><span class="line"><span class="comment">             * å¦‚æœ requeue å‚æ•°è®¾ç½®ä¸º falseï¼Œåˆ™ RabbitMQ ç«‹å³ä¼šè¿˜æŠŠæ¶ˆæ¯ä»é˜Ÿåˆ—ä¸­ç§»é™¤ï¼Œ</span></span><br><span class="line"><span class="comment">             * è€Œä¸ä¼šæŠŠå®ƒå‘é€ç»™æ–°çš„æ¶ˆè´¹è€…ã€‚</span></span><br><span class="line"><span class="comment">             */</span></span><br><span class="line">            <span class="comment">//channel.basicNack(deliveryTag, true, false);</span></span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">catch</span> (Exception e)</span><br><span class="line">        &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line"> </span><br><span class="line">            <span class="comment">/**</span></span><br><span class="line"><span class="comment">             * æ‹’ç»æ¶ˆæ¯ï¼Œå‚æ•°è¯´æ˜ï¼š</span></span><br><span class="line"><span class="comment">             * long deliveryTagï¼šå”¯ä¸€æ ‡è¯† IDã€‚</span></span><br><span class="line"><span class="comment">             * boolean requeueï¼šå¦‚æœ requeue å‚æ•°è®¾ç½®ä¸º trueï¼Œ</span></span><br><span class="line"><span class="comment">             * åˆ™ RabbitMQ ä¼šé‡æ–°å°†è¿™æ¡æ¶ˆæ¯å­˜å…¥é˜Ÿåˆ—ï¼Œä»¥ä¾¿å‘é€ç»™ä¸‹ä¸€ä¸ªè®¢é˜…çš„æ¶ˆè´¹è€…ï¼›</span></span><br><span class="line"><span class="comment">             * å¦‚æœ requeue å‚æ•°è®¾ç½®ä¸º falseï¼Œåˆ™ RabbitMQ ç«‹å³ä¼šè¿˜æŠŠæ¶ˆæ¯ä»é˜Ÿåˆ—ä¸­ç§»é™¤ï¼Œ</span></span><br><span class="line"><span class="comment">             * è€Œä¸ä¼šæŠŠå®ƒå‘é€ç»™æ–°çš„æ¶ˆè´¹è€…ã€‚</span></span><br><span class="line"><span class="comment">             */</span></span><br><span class="line">            channel.basicReject(deliveryTag, <span class="literal">true</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="53æ€»ç»“"><a class="markdownIt-Anchor" href="#53æ€»ç»“"></a> 5.3æ€»ç»“</h2><p>â€‹RabbitMQç³»åˆ—ç¬¬äº”ç¯‡ä»‹ç»äº†å®ç°æ¶ˆæ¯çš„å¯é æŠµè¾¾çš„ä¸¤å¤§æ¨¡å¼ï¼šå‘é€è€…ç¡®è®¤ã€æ¶ˆè´¹è€…ç¡®è®¤ï¼›å…¶ä¸­å‘é€ç¡®è®¤åˆå¯ä»¥åˆ†ä¸ºæ¶ˆæ¯ç”Ÿäº§è€…åˆ°äº¤æ¢æœºçš„ç¡®è®¤ï¼ˆconfirmcallbackæ¥å£ï¼šæ¶ˆæ¯åˆ°è¾¾äº¤æ¢æœºå›è°ƒï¼‰ã€äº¤æ¢æœºåˆ°é˜Ÿåˆ—çš„ç¡®è®¤ï¼ˆreturncallbackæ¥å£ï¼šæ¶ˆæ¯åˆ°è¾¾ä¸äº†é˜Ÿåˆ—å›è°ƒï¼‰ï¼›è€Œæ¶ˆè´¹è€…å›è°ƒACKæœºåˆ¶å¯åˆ†ä¸ºè‡ªåŠ¨ç¡®è®¤ã€æ‰‹åŠ¨ç¡®è®¤ã€æ ¹æ®æƒ…å†µç¡®è®¤ä¸‰ç§ç±»å‹ï¼›è‡ªåŠ¨ç¡®è®¤å¯èƒ½ä¼šå‡ºç°æ¶ˆæ¯ä¸¢å¤±é—®é¢˜ï¼ˆæ¶ˆæ¯åˆ°è¾¾æ¶ˆè´¹è€…åï¼Œé˜Ÿåˆ—ç«‹åˆ»åˆ é™¤è¯¥æ¶ˆæ¯ï¼Œä½†æ˜¯æ­¤æ—¶æ¶ˆè´¹è€…æ¬¡æ­¤æ—¶å‡ºç°å¼‚å¸¸æˆ–è€…å®•æœºï¼‰ï¼Œæ‰‹åŠ¨ç¡®è®¤çš„ä¸‰ä¸ªæ–¹æ³•ï¼ˆbasicAckã€basicNackã€basicRejectï¼‰</p><h1 id="6æ¶ˆæ¯é‡å¤æ¶ˆè´¹é—®é¢˜"><a class="markdownIt-Anchor" href="#6æ¶ˆæ¯é‡å¤æ¶ˆè´¹é—®é¢˜"></a> 6.æ¶ˆæ¯é‡å¤æ¶ˆè´¹é—®é¢˜</h1><h2 id="61é—®é¢˜ä»‹ç»"><a class="markdownIt-Anchor" href="#61é—®é¢˜ä»‹ç»"></a> 6.1é—®é¢˜ä»‹ç»</h2><p>ä»€ä¹ˆæ˜¯<mark>æ¶ˆæ¯é‡å¤æ¶ˆè´¹</mark>ï¼Ÿé¦–å…ˆæˆ‘ä»¬æ¥çœ‹ä¸€ä¸‹æ¶ˆæ¯çš„ä¼ è¾“æµç¨‹ã€‚æ¶ˆæ¯ç”Ÿäº§è€…â€“&gt;MQâ€“&gt;æ¶ˆæ¯æ¶ˆè´¹è€…ï¼›æ¶ˆæ¯ç”Ÿäº§è€…å‘é€æ¶ˆæ¯åˆ°MQæœåŠ¡å™¨ï¼ŒMQæœåŠ¡å™¨å­˜å‚¨æ¶ˆæ¯ï¼Œæ¶ˆæ¯æ¶ˆè´¹è€…ç›‘å¬MQçš„æ¶ˆæ¯ï¼Œå‘ç°æœ‰æ¶ˆæ¯å°±æ¶ˆè´¹æ¶ˆæ¯ã€‚</p><p>æ‰€ä»¥æ¶ˆæ¯é‡å¤ä¹Ÿå°±å‡ºç°åœ¨**<mark>ä¸¤ä¸ªé˜¶æ®µ</mark>**</p><p>1**ï¼šç”Ÿäº§è€…å¤šå‘é€äº†æ¶ˆæ¯ç»™MQï¼›**</p><p>2**ï¼šMQçš„ä¸€æ¡æ¶ˆæ¯è¢«æ¶ˆè´¹è€…æ¶ˆè´¹äº†å¤šæ¬¡**ã€‚</p><p>å…·ä½“åœºæ™¯å¦‚ä¸‹ï¼š</p><ol><li><mark><strong>ç”Ÿäº§è€…å‘é€æ¶ˆæ¯ç»™MQ</strong></mark>ï¼Œ<mark>åœ¨MQç¡®è®¤çš„æ—¶å€™å‡ºç°äº†ç½‘ç»œæ³¢åŠ¨</mark>ï¼Œç”Ÿäº§è€…æ²¡æœ‰æ”¶åˆ°ç¡®è®¤ï¼Œè¿™æ—¶å€™ç”Ÿäº§è€…å°±ä¼šé‡æ–°å‘é€è¿™æ¡æ¶ˆæ¯ï¼Œå¯¼è‡´MQä¼šæ¥æ”¶åˆ°é‡å¤æ¶ˆæ¯ã€‚</li><li><mark>æ¶ˆè´¹è€…æ¶ˆè´¹æˆåŠŸå</mark>ï¼Œç»™MQç¡®è®¤çš„æ—¶å€™å‡ºç°äº†ç½‘ç»œæ³¢åŠ¨ï¼Œ<mark>MQæ²¡æœ‰æ¥æ”¶åˆ°ç¡®è®¤</mark>ï¼Œä¸ºäº†ä¿è¯æ¶ˆæ¯ä¸ä¸¢å¤±ï¼ŒMQå°±ä¼šç»§ç»­ç»™æ¶ˆè´¹è€…æŠ•é€’ä¹‹å‰çš„æ¶ˆæ¯ã€‚è¿™æ—¶å€™æ¶ˆè´¹è€…å°±æ¥æ”¶åˆ°äº†ä¸¤æ¡ä¸€æ ·çš„æ¶ˆæ¯ã€‚ç”±äºé‡å¤æ¶ˆæ¯æ˜¯ç”±äºç½‘ç»œåŸå› é€ æˆçš„ï¼Œæ— æ³•é¿å…ã€‚</li></ol><h2 id="62è§£å†³æ€è·¯"><a class="markdownIt-Anchor" href="#62è§£å†³æ€è·¯"></a> 6.2è§£å†³æ€è·¯</h2><ol><li><mark>å‘é€æ¶ˆæ¯æ—¶è®©æ¯ä¸ªæ¶ˆæ¯æºå¸¦ä¸€ä¸ªå…¨å±€çš„å”¯ä¸€ID</mark></li><li>åœ¨æ¶ˆè´¹æ¶ˆæ¯æ—¶å…ˆåˆ¤æ–­æ¶ˆæ¯æ˜¯å¦å·²ç»è¢«æ¶ˆè´¹è¿‡ï¼Œä¿è¯æ¶ˆæ¯æ¶ˆè´¹é€»è¾‘çš„å¹‚ç­‰æ€§ã€‚å…·ä½“æ¶ˆè´¹è¿‡ç¨‹ä¸ºï¼š<ul><li>æ¶ˆè´¹è€…è·å–åˆ°æ¶ˆæ¯åå…ˆ<mark>æ ¹æ®idå»æŸ¥è¯¢redis/dbæ˜¯å¦å­˜åœ¨è¯¥æ¶ˆæ¯</mark></li><li>å¦‚æœä¸å­˜åœ¨ï¼Œåˆ™æ­£å¸¸æ¶ˆè´¹ï¼Œæ¶ˆè´¹å®Œæ¯•åå†™å…¥redis/db</li><li>å¦‚æœå­˜åœ¨ï¼Œåˆ™è¯æ˜æ¶ˆæ¯è¢«æ¶ˆè´¹è¿‡ï¼Œç›´æ¥ä¸¢å¼ƒ</li></ul></li></ol><h2 id="63å°†è¯¥æ¶ˆæ¯å­˜å‚¨åˆ°redis"><a class="markdownIt-Anchor" href="#63å°†è¯¥æ¶ˆæ¯å­˜å‚¨åˆ°redis"></a> 6.3å°†è¯¥æ¶ˆæ¯å­˜å‚¨åˆ°Redis</h2><h3 id="631å°†idå­˜å…¥stringå•æ¶ˆè´¹è€…åœºæ™¯"><a class="markdownIt-Anchor" href="#631å°†idå­˜å…¥stringå•æ¶ˆè´¹è€…åœºæ™¯"></a> 6.3.1å°†idå­˜å…¥stringï¼ˆå•æ¶ˆè´¹è€…åœºæ™¯ï¼‰</h3><h4 id="1å®ç°æ€è·¯"><a class="markdownIt-Anchor" href="#1å®ç°æ€è·¯"></a> ï¼ˆ1ï¼‰å®ç°æ€è·¯</h4><ul><li>å°†idå·å­˜å…¥valueä¸­ï¼Œå¹¶ä¸”valueç±»å‹ä¸ºstring</li><li>å³ä»¥é˜Ÿåˆ—åç§°ä¸ºkeyï¼Œä»¥æ¶ˆæ¯idä¸ºå€¼</li><li><mark>æ¯æ¬¡æ¶ˆæ¯è¿‡æ¥éƒ½è¦†ç›–ä¹‹å‰çš„æ¶ˆæ¯</mark></li></ul><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RabbitListener(queues = &quot;queueName4&quot;)</span><span class="comment">//å‘é€çš„é˜Ÿåˆ—åç§°     @RabbitListeneræ³¨è§£åˆ°ç±»å’Œæ–¹æ³•éƒ½å¯ä»¥</span></span><br><span class="line"><span class="meta">@RabbitHandler</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">receiveMessage1</span><span class="params">(Message message)</span> <span class="keyword">throws</span> UnsupportedEncodingException &#123;</span><br><span class="line">    <span class="comment">//è·å–å”¯ä¸€id</span></span><br><span class="line">    <span class="type">String</span> <span class="variable">messageId</span> <span class="operator">=</span> message.getMessageProperties().getMessageId();</span><br><span class="line">    <span class="type">String</span> <span class="variable">msg</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">String</span>(message.getBody(),<span class="string">&quot;utf-8&quot;</span>);</span><br><span class="line"> </span><br><span class="line">    <span class="comment">//è·å–redisä¸­è¯¥é˜Ÿåˆ—åç§°å¯¹åº”çš„valueå€¼</span></span><br><span class="line">    <span class="type">String</span> <span class="variable">messageRedisValue</span> <span class="operator">=</span> redisUtil.get(<span class="string">&quot;queueName4&quot;</span>,<span class="string">&quot;&quot;</span>);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">//æ£€éªŒå”¯ä¸€idæ˜¯å¦å­˜åœ¨</span></span><br><span class="line">    <span class="keyword">if</span> (messageRedisValue.equals(messageId)) &#123;</span><br><span class="line">        <span class="comment">//å­˜åœ¨</span></span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    System.out.println(<span class="string">&quot;æ¶ˆæ¯ï¼š&quot;</span>+msg+<span class="string">&quot;, id:&quot;</span>+messageId);</span><br><span class="line"> </span><br><span class="line">    <span class="comment">//ä»¥é˜Ÿåˆ—ä¸ºkeyï¼Œidä¸ºvalue</span></span><br><span class="line">    redisUtil.set(<span class="string">&quot;queueName4&quot;</span>,messageId);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="2é—®é¢˜"><a class="markdownIt-Anchor" href="#2é—®é¢˜"></a> ï¼ˆ2ï¼‰é—®é¢˜</h4><ol><li><mark><strong>å¹¶å‘å†²çª</strong></mark>ï¼šå¦‚æœ<mark>å¤šä¸ªæ¶ˆè´¹è€…</mark>åŒæ—¶æ“ä½œ Redis ä¸­çš„å·²æ¶ˆè´¹æ¶ˆæ¯åˆ—è¡¨ï¼Œç”±äº Redis æ˜¯<mark>å•çº¿ç¨‹</mark>å¤„ç†å‘½ä»¤ï¼Œå¯èƒ½ä¼šå‡ºç°å¹¶å‘å†²çªå¯¼è‡´æ•°æ®ä¸ä¸€è‡´æˆ–ä¸¢å¤±é—®é¢˜ã€‚ç‰¹åˆ«æ˜¯åœ¨é«˜å¹¶å‘æƒ…å†µä¸‹ï¼Œä½¿ç”¨å­—ç¬¦ä¸²ç±»å‹çš„ ID å¯èƒ½ä¼šå¢åŠ å¹¶å‘å†²çªçš„é£é™©</li><li><strong>å†…å­˜å ç”¨</strong>ï¼šå­—ç¬¦ä¸²ç±»å‹çš„ ID åœ¨å†…å­˜ä¸­å ç”¨ç©ºé—´ç›¸å¯¹è¾ƒå¤§ï¼Œå°¤å…¶æ˜¯å¯¹äºå¤§é‡æ¶ˆæ¯çš„æƒ…å†µä¸‹ï¼Œä¼šå¢åŠ  Redis çš„å†…å­˜å ç”¨ã€‚</li><li><strong>æ¯”è¾ƒæ•ˆç‡</strong>ï¼šå­—ç¬¦ä¸²ç±»å‹çš„ ID æ¯”è¾ƒèµ·æ¥ç›¸å¯¹å¤æ‚ï¼Œéœ€è¦è¿›è¡Œå­—ç¬¦ä¸²æ¯”è¾ƒæ“ä½œã€‚</li></ol><h3 id="632å°†idå­˜å…¥listä¸­å¤šæ¶ˆè´¹åœºæ™¯"><a class="markdownIt-Anchor" href="#632å°†idå­˜å…¥listä¸­å¤šæ¶ˆè´¹åœºæ™¯"></a> 6.3.2å°†idå­˜å…¥listä¸­ï¼ˆå¤šæ¶ˆè´¹åœºæ™¯ï¼‰</h3><h4 id="1å®ç°æ€è·¯-2"><a class="markdownIt-Anchor" href="#1å®ç°æ€è·¯-2"></a> ï¼ˆ1ï¼‰å®ç°æ€è·¯</h4><ul><li>ä»¥è¯¥é˜Ÿåˆ—åç§°ä¸ºkeyï¼Œidä¸ºvalue</li><li>é€‚åˆå¤šæ¶ˆè´¹åœºæ™¯çš„åŸå› ï¼š<ul><li><strong><mark>é¡ºåºæ€§</mark></strong>ï¼šList æ˜¯ä¸€ä¸ªæœ‰åºé›†åˆï¼Œå¯ä»¥<mark>æŒ‰ç…§æ¶ˆæ¯çš„é¡ºåºå­˜å‚¨æ¶ˆæ¯ ID</mark>ã€‚åœ¨å¤šæ¶ˆè´¹è€…åœºæ™¯ä¸‹ï¼Œä¿æŒæ¶ˆæ¯çš„é¡ºåºé€šå¸¸æ˜¯å¾ˆé‡è¦çš„ï¼Œä»¥ç¡®ä¿æ¶ˆæ¯æŒ‰ç…§æ­£ç¡®çš„é¡ºåºè¢«æ¶ˆè´¹ã€‚</li><li><strong><mark>åŸå­æ€§æ“ä½œ</mark></strong>ï¼šRedis çš„ List æä¾›äº†å¤šä¸ªåŸå­æ€§æ“ä½œï¼Œæ¯”å¦‚ä»åˆ—è¡¨ä¸¤ç«¯æ¨å…¥/å¼¹å‡ºå…ƒç´ ï¼Œè¿™äº›æ“ä½œå¯ä»¥ç¡®ä¿å¤šä¸ªæ¶ˆè´¹è€…åŒæ—¶è®¿é—®åˆ—è¡¨æ—¶ä¸ä¼šå‡ºç°æ•°æ®ç«äº‰å’Œå¹¶å‘é—®é¢˜ã€‚</li><li><strong><mark>æ”¯æŒé˜»å¡æ“ä½œ</mark></strong>ï¼šList æä¾›äº†é˜»å¡å¼çš„å¼¹å‡ºæ“ä½œï¼ˆå¦‚ BLPOPã€BRPOPï¼‰ï¼Œå¯ä»¥åœ¨æ²¡æœ‰æ¶ˆæ¯æ—¶é˜»å¡ç­‰å¾…æ–°æ¶ˆæ¯çš„åˆ°æ¥ï¼Œè¿™å¯¹äºå®ç°æ¶ˆè´¹è€…è½®è¯¢æœºåˆ¶éå¸¸æœ‰ç”¨ã€‚</li></ul></li></ul><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RabbitListener(queues = &quot;queueName4&quot;)</span><span class="comment">//å‘é€çš„é˜Ÿåˆ—åç§°     @RabbitListeneræ³¨è§£åˆ°ç±»å’Œæ–¹æ³•éƒ½å¯ä»¥</span></span><br><span class="line"><span class="meta">@RabbitHandler</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">receiveMessage2</span><span class="params">(Message message)</span> <span class="keyword">throws</span> UnsupportedEncodingException &#123;</span><br><span class="line">    <span class="type">String</span> <span class="variable">messageId</span> <span class="operator">=</span> message.getMessageProperties().getMessageId();</span><br><span class="line">    <span class="type">String</span> <span class="variable">msg</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">String</span>(message.getBody(),<span class="string">&quot;utf-8&quot;</span>);</span><br><span class="line"> </span><br><span class="line">    <span class="comment">//è·å–</span></span><br><span class="line">    List&lt;String&gt; messageRedisValue = redisUtil.lrange(<span class="string">&quot;queueName4&quot;</span>);</span><br><span class="line">    <span class="keyword">if</span> (messageRedisValue.contains(messageId)) &#123;</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    System.out.println(<span class="string">&quot;æ¶ˆæ¯ï¼š&quot;</span>+msg+<span class="string">&quot;, id:&quot;</span>+messageId);</span><br><span class="line"> </span><br><span class="line">    redisUtil.lpush(<span class="string">&quot;queueName4&quot;</span>,messageId);<span class="comment">//å­˜å…¥list</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="633å°†idä»¥keyå¢é‡å­˜å…¥stringä¸­å¹¶è®¾ç½®è¿‡æœŸæ—¶é—´"><a class="markdownIt-Anchor" href="#633å°†idä»¥keyå¢é‡å­˜å…¥stringä¸­å¹¶è®¾ç½®è¿‡æœŸæ—¶é—´"></a> 6.3.3å°†idä»¥keyå¢é‡å­˜å…¥stringä¸­å¹¶è®¾ç½®è¿‡æœŸæ—¶é—´</h3><h4 id="1å®ç°æ€è·¯-3"><a class="markdownIt-Anchor" href="#1å®ç°æ€è·¯-3"></a> ï¼ˆ1ï¼‰å®ç°æ€è·¯</h4><p>ä»¥<mark>æ¶ˆæ¯idä¸ºkey</mark>ï¼Œ<mark>æ¶ˆæ¯å†…å®¹ä¸ºvalue</mark>å­˜å…¥stringä¸­ï¼Œ==è®¾ç½®è¿‡æœŸæ—¶é—´ï¼ˆ==å¯æ‰¿å—çš„redisæœåŠ¡å™¨å¼‚å¸¸æ—¶é—´ï¼Œæ¯”å¦‚è®¾ç½®è¿‡æœŸæ—¶é—´ä¸º10åˆ†é’Ÿï¼Œå¦‚æœredisæœåŠ¡å™¨æ–­äº†20åˆ†é’Ÿï¼Œé‚£ä¹ˆæœªæ¶ˆè´¹çš„æ•°æ®éƒ½ä¼šä¸¢äº†ï¼‰</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RabbitListener(queues = &quot;queueName4&quot;)</span><span class="comment">//å‘é€çš„é˜Ÿåˆ—åç§°     @RabbitListeneræ³¨è§£åˆ°ç±»å’Œæ–¹æ³•éƒ½å¯ä»¥</span></span><br><span class="line"><span class="meta">@RabbitHandler</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">receiveMessage2</span><span class="params">(Message message)</span> <span class="keyword">throws</span> UnsupportedEncodingException &#123;</span><br><span class="line">    <span class="type">String</span> <span class="variable">messageId</span> <span class="operator">=</span> message.getMessageProperties().getMessageId();</span><br><span class="line">    <span class="type">String</span> <span class="variable">msg</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">String</span>(message.getBody(),<span class="string">&quot;utf-8&quot;</span>);</span><br><span class="line"> </span><br><span class="line">    <span class="type">String</span> <span class="variable">messageRedisValue</span> <span class="operator">=</span> redisUtil.get(messageId,<span class="string">&quot;&quot;</span>);</span><br><span class="line">    <span class="keyword">if</span> (msg.equals(messageRedisValue)) &#123;</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    System.out.println(<span class="string">&quot;æ¶ˆæ¯ï¼š&quot;</span>+msg+<span class="string">&quot;, id:&quot;</span>+messageId);</span><br><span class="line"> </span><br><span class="line">    <span class="comment">//ä»¥idä¸ºkeyï¼Œæ¶ˆæ¯å†…å®¹ä¸ºvalueï¼Œè¿‡æœŸæ—¶é—´10åˆ†é’Ÿ</span></span><br><span class="line">    redisUtil.set(messageId,msg,<span class="number">10L</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="64æ€»ç»“"><a class="markdownIt-Anchor" href="#64æ€»ç»“"></a> 6.4æ€»ç»“</h2><p>è¯¥ç¯‡æ–‡ç« ä»‹ç»äº†æ¶ˆæ¯é‡å¤æ¶ˆè´¹é—®é¢˜åŠè§£å†³æ–¹æ¡ˆï¼Œé—®é¢˜å¯èƒ½äº§ç”Ÿçš„ä¸¤ä¸ªé˜¶æ®µï¼ˆç”Ÿäº§æ¶ˆæ¯å¤šå‘ã€æ¶ˆè´¹è€…é‡å¤æ¶ˆæ¯ï¼‰ï¼›è§£å†³æ–¹æ¡ˆï¼šå°†æ¶ˆæ¯å‘é€æ—¶æºå¸¦ä¸€ä¸ªå”¯ä¸€idï¼Œæ¶ˆè´¹æ–¹æ‹¿åˆ°æ¶ˆæ¯æ—¶å…ˆå»reids/dbä¸­æœ‰æ²¡æœ‰è¯¥æ•°æ®ï¼Œè‹¥æ²¡æœ‰åˆ™å¯ä»¥æ¶ˆè´¹ï¼Œå¦åˆ™ä¸å¯ä»¥æ¶ˆè´¹ï¼›å¹¶ä»‹ç»äº†åŸºäºRedsiè§£å†³æ¶ˆæ¯é‡å¤æ¶ˆè´¹é—®é¢˜ï¼Œâ‘ ä»¥é˜Ÿåˆ—åç§°ä¸ºkeyï¼Œæ¶ˆæ¯idä¸ºvalueï¼Œä¸”valueä¸ºstringç±»å‹ï¼ˆé€‚åˆåªæœ‰ä¸€ä¸ªæ¶ˆè´¹æ–¹ï¼‰â‘¡ä»¥é˜Ÿåˆ—åç§°ä¸ºkeyï¼Œæ¶ˆæ¯idä¸ºvalueï¼Œä¸”valueä¸ºlistç±»å‹ï¼ˆé€‚åˆæœ‰å¤šä¸ªæ¶ˆè´¹æ–¹åœºæ™¯ï¼‰â‘¢ä»¥æ¶ˆæ¯idä¸ºkeyï¼Œå†…å®¹ä¸ºvalueï¼Œå¹¶è®¾ç½®è¿‡æœŸæ—¶é—´</p><h1 id="7rabbitmqå®ç°json-mapæ ¼å¼æ•°æ®çš„å‘é€ä¸æ¥æ”¶"><a class="markdownIt-Anchor" href="#7rabbitmqå®ç°json-mapæ ¼å¼æ•°æ®çš„å‘é€ä¸æ¥æ”¶"></a> 7.RabbitMQå®ç°JSONã€Mapæ ¼å¼æ•°æ®çš„å‘é€ä¸æ¥æ”¶</h1><p>åœ¨å®ç°çš„é¡¹ç›®å¼€å‘ä¸­ï¼Œç»å¸¸ä½¿ç”¨Jsonã€Mapæ ¼å¼æ•°æ®ã€‚ä¸‹é¢å°†ä»‹ç»RabbitMQå®ç°Jsonã€Mapæ ¼å¼æ•°æ®çš„å‘é€ä¸æ¥æ”¶ã€‚</p><h2 id="71æ¶ˆæ¯å‘é€ç«¯"><a class="markdownIt-Anchor" href="#71æ¶ˆæ¯å‘é€ç«¯"></a> 7.1æ¶ˆæ¯å‘é€ç«¯</h2><p>åœ¨æ¶ˆæ¯å‘é€ç«¯æœåŠ¡å¼•å…¥ä¾èµ–ã€ymlé…ç½®ã€RabbitMQé…ç½®ç±»ã€æ¶ˆæ¯å‘é€ç±»</p><h3 id="711å¼•å…¥ä¾èµ–"><a class="markdownIt-Anchor" href="#711å¼•å…¥ä¾èµ–"></a> 7.1.1å¼•å…¥ä¾èµ–</h3><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!-- AMQPå®¢æˆ·ç«¯ --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-amqp<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure><h3 id="712ymlé…ç½®"><a class="markdownIt-Anchor" href="#712ymlé…ç½®"></a> 7.1.2ymlé…ç½®</h3><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">application:</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">rabbitmq-provider</span></span><br><span class="line">  <span class="attr">rabbitmq:</span></span><br><span class="line">    <span class="attr">host:</span> <span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span></span><br><span class="line">    <span class="attr">port:</span> <span class="number">5672</span></span><br><span class="line">    <span class="attr">username:</span> <span class="string">guest</span></span><br><span class="line">    <span class="attr">password:</span> <span class="string">guest</span></span><br><span class="line">    <span class="attr">publisher-confirm-type:</span> <span class="string">correlated</span> </span><br><span class="line">    <span class="attr">publisher-returns:</span> <span class="literal">true</span> </span><br></pre></td></tr></table></figure><h3 id="713rabbitmqconfigé…ç½®ç±»éå¸¸é‡è¦"><a class="markdownIt-Anchor" href="#713rabbitmqconfigé…ç½®ç±»éå¸¸é‡è¦"></a> 7.1.3RabbitMQConfigé…ç½®ç±»â€”â€”ï¼ˆéå¸¸é‡è¦ï¼‰</h3><p>åœ¨é¡¹ç›®ä¸­ï¼Œåˆ›å»º<mark>é…ç½®ç±»</mark>ï¼Œé…ç½®==<strong>æ¶ˆæ¯ç¡®è®¤</strong><mark>ï¼Œ<strong><mark>Jsonè½¬æ¢å™¨</mark></strong>ï¼Œ</mark><strong>é˜Ÿåˆ—åç§°</strong>==ç­‰ï¼Œå¹¶å°†é˜Ÿåˆ—äº¤ç”± IoC ç®¡ç†ã€‚ä»£ç å¦‚ä¸‹ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.pjb.config;</span><br><span class="line"> </span><br><span class="line"><span class="keyword">import</span> org.springframework.amqp.core.*;</span><br><span class="line"><span class="keyword">import</span> org.springframework.amqp.rabbit.connection.CachingConnectionFactory;</span><br><span class="line"><span class="keyword">import</span> org.springframework.amqp.rabbit.connection.ConnectionFactory;</span><br><span class="line"><span class="keyword">import</span> org.springframework.amqp.rabbit.connection.CorrelationData;</span><br><span class="line"><span class="keyword">import</span> org.springframework.amqp.rabbit.core.RabbitTemplate;</span><br><span class="line"><span class="keyword">import</span> org.springframework.amqp.support.converter.Jackson2JsonMessageConverter;</span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.annotation.Autowired;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.Bean;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.Configuration;</span><br><span class="line"> </span><br><span class="line"><span class="keyword">import</span> java.util.HashMap;</span><br><span class="line"><span class="keyword">import</span> java.util.Map;</span><br><span class="line"> </span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * RabbitMQé…ç½®ç±»</span></span><br><span class="line"><span class="comment"> **/</span></span><br><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">RabbitMqConfig</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">DIRECT_QUEUE</span> <span class="operator">=</span> <span class="string">&quot;direct_queue&quot;</span>; <span class="comment">//Directé˜Ÿåˆ—åç§°</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">DIRECT_EXCHANGE</span> <span class="operator">=</span> <span class="string">&quot;direct_exchange&quot;</span>; <span class="comment">//äº¤æ¢å™¨åç§°</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">DIRECT_ROUTING_KEY</span> <span class="operator">=</span> <span class="string">&quot;direct_routing_key&quot;</span>; <span class="comment">//è·¯ç”±é”®</span></span><br><span class="line"> </span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">DELAY_QUEUE</span> <span class="operator">=</span> <span class="string">&quot;delay_queue&quot;</span>; <span class="comment">//å»¶æ—¶é˜Ÿåˆ—åç§°</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">DELAY_EXCHANGE</span> <span class="operator">=</span> <span class="string">&quot;delay_exchange&quot;</span>; <span class="comment">//äº¤æ¢å™¨åç§°</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">DELAY_ROUTING_KEY</span> <span class="operator">=</span> <span class="string">&quot;delay_routing_key&quot;</span>; <span class="comment">//è·¯ç”±é”®</span></span><br><span class="line"> </span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> CachingConnectionFactory connectionFactory;</span><br><span class="line"> </span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> RabbitTemplate <span class="title function_">createRabbitTemplate</span><span class="params">(ConnectionFactory connectionFactory)</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="type">RabbitTemplate</span> <span class="variable">rabbitTemplate</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">RabbitTemplate</span>();</span><br><span class="line">        rabbitTemplate.setConnectionFactory(connectionFactory);</span><br><span class="line"> </span><br><span class="line">        <span class="comment">//è®¾ç½®Jsonè½¬æ¢å™¨</span></span><br><span class="line">        rabbitTemplate.setMessageConverter(jsonMessageConverter());</span><br><span class="line"> </span><br><span class="line">        <span class="comment">//è®¾ç½®å¼€å¯Mandatory,æ‰èƒ½è§¦å‘å›è°ƒå‡½æ•°,æ— è®ºæ¶ˆæ¯æ¨é€ç»“æœæ€ä¹ˆæ ·éƒ½å¼ºåˆ¶è°ƒç”¨å›è°ƒå‡½æ•°</span></span><br><span class="line">        rabbitTemplate.setMandatory(<span class="literal">true</span>);</span><br><span class="line"> </span><br><span class="line">        <span class="comment">//ç¡®è®¤æ¶ˆæ¯é€åˆ°äº¤æ¢æœº(Exchange)å›è°ƒ</span></span><br><span class="line">        rabbitTemplate.setConfirmCallback(<span class="keyword">new</span> <span class="title class_">RabbitTemplate</span>.ConfirmCallback()</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">confirm</span><span class="params">(CorrelationData correlationData, <span class="type">boolean</span> ack, String cause)</span></span><br><span class="line">            &#123;</span><br><span class="line">                System.out.println(<span class="string">&quot;\nç¡®è®¤æ¶ˆæ¯é€åˆ°äº¤æ¢æœº(Exchange)ç»“æœï¼š&quot;</span>);</span><br><span class="line">                System.out.println(<span class="string">&quot;ç›¸å…³æ•°æ®ï¼š&quot;</span> + correlationData);</span><br><span class="line">                System.out.println(<span class="string">&quot;æ˜¯å¦æˆåŠŸï¼š&quot;</span> + ack);</span><br><span class="line">                System.out.println(<span class="string">&quot;é”™è¯¯åŸå› ï¼š&quot;</span> + cause);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line"> </span><br><span class="line">        <span class="comment">//ç¡®è®¤æ¶ˆæ¯é€åˆ°é˜Ÿåˆ—(Queue)å›è°ƒ</span></span><br><span class="line">        rabbitTemplate.setReturnsCallback(<span class="keyword">new</span> <span class="title class_">RabbitTemplate</span>.ReturnsCallback()</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">returnedMessage</span><span class="params">(ReturnedMessage returnedMessage)</span></span><br><span class="line">            &#123;</span><br><span class="line">                System.out.println(<span class="string">&quot;\nç¡®è®¤æ¶ˆæ¯é€åˆ°é˜Ÿåˆ—(Queue)ç»“æœï¼š&quot;</span>);</span><br><span class="line">                System.out.println(<span class="string">&quot;å‘ç”Ÿæ¶ˆæ¯ï¼š&quot;</span> + returnedMessage.getMessage());</span><br><span class="line">                System.out.println(<span class="string">&quot;å›åº”ç ï¼š&quot;</span> + returnedMessage.getReplyCode());</span><br><span class="line">                System.out.println(<span class="string">&quot;å›åº”ä¿¡æ¯ï¼š&quot;</span> + returnedMessage.getReplyText());</span><br><span class="line">                System.out.println(<span class="string">&quot;äº¤æ¢æœºï¼š&quot;</span> + returnedMessage.getExchange());</span><br><span class="line">                System.out.println(<span class="string">&quot;è·¯ç”±é”®ï¼š&quot;</span> + returnedMessage.getRoutingKey());</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line">        <span class="keyword">return</span> rabbitTemplate;</span><br><span class="line">    &#125;</span><br><span class="line"> </span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Jsonè½¬æ¢å™¨</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> Jackson2JsonMessageConverter <span class="title function_">jsonMessageConverter</span><span class="params">()</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">Jackson2JsonMessageConverter</span>();</span><br><span class="line">    &#125;</span><br><span class="line"> </span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Directäº¤æ¢å™¨</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> DirectExchange <span class="title function_">directExchange</span><span class="params">()</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">DirectExchange</span>(DIRECT_EXCHANGE, <span class="literal">true</span>, <span class="literal">false</span>);</span><br><span class="line">    &#125;</span><br><span class="line"> </span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * é˜Ÿåˆ—</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> Queue <span class="title function_">directQueue</span><span class="params">()</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">Queue</span>(DIRECT_QUEUE, <span class="literal">true</span>, <span class="literal">false</span>, <span class="literal">false</span>, <span class="literal">null</span>);</span><br><span class="line">    &#125;</span><br><span class="line"> </span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * ç»‘å®š</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    Binding <span class="title function_">directBinding</span><span class="params">(DirectExchange directExchange, Queue directQueue)</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment">//å°†é˜Ÿåˆ—å’Œäº¤æ¢æœºç»‘å®š, å¹¶è®¾ç½®ç”¨äºåŒ¹é…é”®ï¼šroutingKeyè·¯ç”±é”®</span></span><br><span class="line">        <span class="keyword">return</span> BindingBuilder.bind(directQueue).to(directExchange).with(DIRECT_ROUTING_KEY);</span><br><span class="line">    &#125;</span><br><span class="line"> </span><br><span class="line">    <span class="comment">/******************************å»¶æ—¶é˜Ÿåˆ—******************************/</span></span><br><span class="line"> </span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> CustomExchange <span class="title function_">delayExchange</span><span class="params">()</span></span><br><span class="line">    &#123;</span><br><span class="line">        Map&lt;String, Object&gt; args = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;();</span><br><span class="line">        args.put(<span class="string">&quot;x-delayed-type&quot;</span>, <span class="string">&quot;direct&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">CustomExchange</span>(DELAY_EXCHANGE, <span class="string">&quot;x-delayed-message&quot;</span>, <span class="literal">true</span>, <span class="literal">false</span>, args);</span><br><span class="line">    &#125;</span><br><span class="line"> </span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> Queue <span class="title function_">delayQueue</span><span class="params">()</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="type">Queue</span> <span class="variable">queue</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Queue</span>(DELAY_QUEUE, <span class="literal">true</span>);</span><br><span class="line">        <span class="keyword">return</span> queue;</span><br><span class="line">    &#125;</span><br><span class="line"> </span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> Binding <span class="title function_">delaybinding</span><span class="params">(Queue delayQueue, CustomExchange delayExchange)</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">return</span> BindingBuilder.bind(delayQueue).to(delayExchange).with(DELAY_ROUTING_KEY).noargs();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ä¸‹é¢å°†è®²è¿°åˆ›å»ºäº¤æ¢å™¨ã€åˆ›å»ºé˜Ÿåˆ—ã€å°†äº¤æ¢å™¨å’Œé˜Ÿåˆ—è¿›è¡Œç»‘å®šå„ç§æ–¹æ³•</p><h4 id="1åˆ›å»ºäº¤æ¢å™¨æ–¹æ³•"><a class="markdownIt-Anchor" href="#1åˆ›å»ºäº¤æ¢å™¨æ–¹æ³•"></a> ï¼ˆ1ï¼‰åˆ›å»ºäº¤æ¢å™¨æ–¹æ³•</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">    * Directäº¤æ¢å™¨</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">   <span class="meta">@Bean</span></span><br><span class="line">   <span class="keyword">public</span> DirectExchange <span class="title function_">directExchange</span><span class="params">()</span></span><br><span class="line">   &#123;</span><br><span class="line">       <span class="comment">/**</span></span><br><span class="line"><span class="comment">        * åˆ›å»ºäº¤æ¢å™¨ï¼Œå‚æ•°è¯´æ˜ï¼š</span></span><br><span class="line"><span class="comment">        * String nameï¼šäº¤æ¢å™¨åç§°</span></span><br><span class="line"><span class="comment">        * boolean durableï¼šè®¾ç½®æ˜¯å¦æŒä¹…åŒ–ï¼Œé»˜è®¤æ˜¯ falseã€‚durable è®¾ç½®ä¸º true è¡¨ç¤ºæŒä¹…åŒ–ï¼Œåä¹‹æ˜¯éæŒä¹…åŒ–ã€‚</span></span><br><span class="line"><span class="comment">        * æŒä¹…åŒ–å¯ä»¥å°†äº¤æ¢å™¨å­˜ç›˜ï¼Œåœ¨æœåŠ¡å™¨é‡å¯çš„æ—¶å€™ä¸ä¼šä¸¢å¤±ç›¸å…³ä¿¡æ¯ã€‚</span></span><br><span class="line"><span class="comment">        * boolean autoDeleteï¼šè®¾ç½®æ˜¯å¦è‡ªåŠ¨åˆ é™¤ï¼Œä¸º true åˆ™è®¾ç½®é˜Ÿåˆ—ä¸ºè‡ªåŠ¨åˆ é™¤ï¼Œ</span></span><br><span class="line"><span class="comment">        */</span></span><br><span class="line">       <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">DirectExchange</span>(DIRECT_EXCHANGE, <span class="literal">true</span>, <span class="literal">false</span>);</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure><h4 id="2åˆ›å»ºé˜Ÿåˆ—æ–¹æ³•"><a class="markdownIt-Anchor" href="#2åˆ›å»ºé˜Ÿåˆ—æ–¹æ³•"></a> ï¼ˆ2ï¼‰åˆ›å»ºé˜Ÿåˆ—æ–¹æ³•</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">   * é˜Ÿåˆ—</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  <span class="meta">@Bean</span></span><br><span class="line">  <span class="keyword">public</span> Queue <span class="title function_">directQueue</span><span class="params">()</span></span><br><span class="line">  &#123;</span><br><span class="line">      <span class="comment">/**</span></span><br><span class="line"><span class="comment">       * åˆ›å»ºé˜Ÿåˆ—ï¼Œå‚æ•°è¯´æ˜ï¼š</span></span><br><span class="line"><span class="comment">       * String nameï¼šé˜Ÿåˆ—åç§°ã€‚</span></span><br><span class="line"><span class="comment">       * boolean durableï¼šè®¾ç½®æ˜¯å¦æŒä¹…åŒ–ï¼Œé»˜è®¤æ˜¯ falseã€‚durable è®¾ç½®ä¸º true è¡¨ç¤ºæŒä¹…åŒ–ï¼Œåä¹‹æ˜¯éæŒä¹…åŒ–ã€‚</span></span><br><span class="line"><span class="comment">       * æŒä¹…åŒ–çš„é˜Ÿåˆ—ä¼šå­˜ç›˜ï¼Œåœ¨æœåŠ¡å™¨é‡å¯çš„æ—¶å€™ä¸ä¼šä¸¢å¤±ç›¸å…³ä¿¡æ¯ã€‚</span></span><br><span class="line"><span class="comment">       * boolean exclusiveï¼šè®¾ç½®æ˜¯å¦æ’ä»–ï¼Œé»˜è®¤ä¹Ÿæ˜¯ falseã€‚ä¸º true åˆ™è®¾ç½®é˜Ÿåˆ—ä¸ºæ’ä»–ã€‚</span></span><br><span class="line"><span class="comment">       * boolean autoDeleteï¼šè®¾ç½®æ˜¯å¦è‡ªåŠ¨åˆ é™¤ï¼Œä¸º true åˆ™è®¾ç½®é˜Ÿåˆ—ä¸ºè‡ªåŠ¨åˆ é™¤ï¼Œ</span></span><br><span class="line"><span class="comment">       * å½“æ²¡æœ‰ç”Ÿäº§è€…æˆ–è€…æ¶ˆè´¹è€…ä½¿ç”¨æ­¤é˜Ÿåˆ—ï¼Œè¯¥é˜Ÿåˆ—ä¼šè‡ªåŠ¨åˆ é™¤ã€‚</span></span><br><span class="line"><span class="comment">       * Map&lt;String, Object&gt; argumentsï¼šè®¾ç½®é˜Ÿåˆ—çš„å…¶ä»–ä¸€äº›å‚æ•°ã€‚</span></span><br><span class="line"><span class="comment">       */</span></span><br><span class="line">      <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">Queue</span>(DIRECT_QUEUE, <span class="literal">true</span>, <span class="literal">false</span>, <span class="literal">false</span>, <span class="literal">null</span>);</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure><h4 id="3ç»‘å®šæ–¹æ³•"><a class="markdownIt-Anchor" href="#3ç»‘å®šæ–¹æ³•"></a> ï¼ˆ3ï¼‰ç»‘å®šæ–¹æ³•</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">    * ç»‘å®š</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">   <span class="meta">@Bean</span></span><br><span class="line">   Binding <span class="title function_">directBinding</span><span class="params">(DirectExchange directExchange, Queue directQueue)</span></span><br><span class="line">   &#123;</span><br><span class="line">       <span class="comment">//å°†é˜Ÿåˆ—å’Œäº¤æ¢æœºç»‘å®š, å¹¶è®¾ç½®ç”¨äºåŒ¹é…é”®ï¼šroutingKeyè·¯ç”±é”®</span></span><br><span class="line">       <span class="keyword">return</span> BindingBuilder.bind(directQueue).to(directExchange).with(DIRECT_ROUTING_KEY);</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure><h4 id="4åˆ›å»ºæ­»ä¿¡äº¤æ¢å™¨-æ­»ä¿¡é˜Ÿåˆ—-ç»‘å®šå…³ç³»"><a class="markdownIt-Anchor" href="#4åˆ›å»ºæ­»ä¿¡äº¤æ¢å™¨-æ­»ä¿¡é˜Ÿåˆ—-ç»‘å®šå…³ç³»"></a> ï¼ˆ4ï¼‰åˆ›å»ºæ­»ä¿¡äº¤æ¢å™¨ã€æ­»ä¿¡é˜Ÿåˆ—ã€ç»‘å®šå…³ç³»</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Bean</span></span><br><span class="line">   <span class="keyword">public</span> CustomExchange <span class="title function_">delayExchange</span><span class="params">()</span></span><br><span class="line">   &#123;</span><br><span class="line">       Map&lt;String, Object&gt; args = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;();</span><br><span class="line">       args.put(<span class="string">&quot;x-delayed-type&quot;</span>, <span class="string">&quot;direct&quot;</span>);</span><br><span class="line">       <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">CustomExchange</span>(DELAY_EXCHANGE, <span class="string">&quot;x-delayed-message&quot;</span>, <span class="literal">true</span>, <span class="literal">false</span>, args);</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">   <span class="meta">@Bean</span></span><br><span class="line">   <span class="keyword">public</span> Queue <span class="title function_">delayQueue</span><span class="params">()</span></span><br><span class="line">   &#123;</span><br><span class="line">       <span class="type">Queue</span> <span class="variable">queue</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Queue</span>(DELAY_QUEUE, <span class="literal">true</span>);</span><br><span class="line">       <span class="keyword">return</span> queue;</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">   <span class="meta">@Bean</span></span><br><span class="line">   <span class="keyword">public</span> Binding <span class="title function_">delaybinding</span><span class="params">(Queue delayQueue, CustomExchange delayExchange)</span></span><br><span class="line">   &#123;</span><br><span class="line">       <span class="keyword">return</span> BindingBuilder.bind(delayQueue).to(delayExchange).with(DELAY_ROUTING_KEY).noargs();</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure><h4 id="5å‘é€æ¶ˆæ¯æ–¹ç«‹å³å‘é€jsonæ ¼å¼æ•°æ®å»¶è¿Ÿå‘é€mapæ ¼å¼æ•°æ®"><a class="markdownIt-Anchor" href="#5å‘é€æ¶ˆæ¯æ–¹ç«‹å³å‘é€jsonæ ¼å¼æ•°æ®å»¶è¿Ÿå‘é€mapæ ¼å¼æ•°æ®"></a> ï¼ˆ5ï¼‰å‘é€æ¶ˆæ¯æ–¹ï¼ˆç«‹å³å‘é€JSONæ ¼å¼æ•°æ®/å»¶è¿Ÿå‘é€Mapæ ¼å¼æ•°æ®ï¼‰</h4><h5 id="1å®ä½“ç±»"><a class="markdownIt-Anchor" href="#1å®ä½“ç±»"></a> â‘ å®ä½“ç±»</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.pjb.entity;</span><br><span class="line"> </span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * ç”¨æˆ·ä¿¡æ¯å®ä½“ç±»</span></span><br><span class="line"><span class="comment"> **/</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">UserInfo</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="type">int</span> userId; <span class="comment">//ç”¨æˆ·ç¼–å·</span></span><br><span class="line">    <span class="keyword">private</span> String userName; <span class="comment">//ç”¨æˆ·å§“å</span></span><br><span class="line">    <span class="keyword">private</span> String blogUrl; <span class="comment">//åšå®¢åœ°å€</span></span><br><span class="line">    <span class="keyword">private</span> String blogRemark; <span class="comment">//åšå®¢ä¿¡æ¯</span></span><br><span class="line"> </span><br><span class="line">    <span class="comment">//çœç•¥getterä¸setteræ–¹æ³•...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h5 id="2serviceå±‚"><a class="markdownIt-Anchor" href="#2serviceå±‚"></a> â‘¡serviceå±‚</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.pjb.sender;</span><br><span class="line"> </span><br><span class="line"><span class="keyword">import</span> com.pjb.entity.UserInfo;</span><br><span class="line"> </span><br><span class="line"><span class="keyword">import</span> java.util.Map;</span><br><span class="line"> </span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * ç”¨æˆ·æ¶ˆæ¯å‘é€æœåŠ¡æ¥å£</span></span><br><span class="line"><span class="comment"> **/</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">UserSender</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * å‘é€ç”¨æˆ·ä¿¡æ¯Jsonæ ¼å¼æ•°æ®</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> userInfo ç”¨æˆ·ä¿¡æ¯å®ä½“ç±»</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">sendUserJson</span><span class="params">(UserInfo userInfo)</span>;</span><br><span class="line"> </span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * å»¶æ—¶å‘é€ç”¨æˆ·ä¿¡æ¯Mapæ ¼å¼æ•°æ®</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> userMap ç”¨æˆ·ä¿¡æ¯Map</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">sendDelayUserMap</span><span class="params">(Map userMap)</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h5 id="3serviceimplç±»"><a class="markdownIt-Anchor" href="#3serviceimplç±»"></a> â‘¢serviceImplç±»</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.pjb.sender.impl;</span><br><span class="line"> </span><br><span class="line"><span class="keyword">import</span> com.pjb.config.RabbitMqConfig;</span><br><span class="line"><span class="keyword">import</span> com.pjb.entity.UserInfo;</span><br><span class="line"><span class="keyword">import</span> com.pjb.sender.UserSender;</span><br><span class="line"><span class="keyword">import</span> org.springframework.amqp.AmqpException;</span><br><span class="line"><span class="keyword">import</span> org.springframework.amqp.core.Message;</span><br><span class="line"><span class="keyword">import</span> org.springframework.amqp.core.MessagePostProcessor;</span><br><span class="line"><span class="keyword">import</span> org.springframework.amqp.rabbit.core.RabbitTemplate;</span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.annotation.Autowired;</span><br><span class="line"><span class="keyword">import</span> org.springframework.stereotype.Service;</span><br><span class="line"> </span><br><span class="line"><span class="keyword">import</span> java.text.SimpleDateFormat;</span><br><span class="line"><span class="keyword">import</span> java.util.Date;</span><br><span class="line"><span class="keyword">import</span> java.util.Map;</span><br><span class="line"> </span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * ç”¨æˆ·æ¶ˆæ¯å‘é€æœåŠ¡ç±»</span></span><br><span class="line"><span class="comment"> **/</span></span><br><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">UserSenderImpl</span> <span class="keyword">implements</span> <span class="title class_">UserSender</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    RabbitTemplate rabbitTemplate;</span><br><span class="line"> </span><br><span class="line">    <span class="comment">//æ—¶é—´æ ¼å¼</span></span><br><span class="line">    <span class="type">SimpleDateFormat</span> <span class="variable">dateFormat</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">SimpleDateFormat</span>(<span class="string">&quot;yyyy-MM-dd HH:mm:ss&quot;</span>);</span><br><span class="line"> </span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * å‘é€ç”¨æˆ·ä¿¡æ¯Jsonæ ¼å¼æ•°æ®</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> userInfo ç”¨æˆ·ä¿¡æ¯å®ä½“ç±»</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">sendUserJson</span><span class="params">(UserInfo userInfo)</span></span><br><span class="line">    &#123;</span><br><span class="line">        rabbitTemplate.convertAndSend(RabbitMqConfig.DIRECT_EXCHANGE, RabbitMqConfig.DIRECT_ROUTING_KEY, userInfo);</span><br><span class="line"> </span><br><span class="line">        System.out.println(<span class="string">&quot;Jsonæ ¼å¼æ•°æ®æ¶ˆæ¯å‘é€æˆåŠŸï¼Œå‘é€æ—¶é—´ï¼š&quot;</span> + dateFormat.format(<span class="keyword">new</span> <span class="title class_">Date</span>()));</span><br><span class="line">    &#125;</span><br><span class="line"> </span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * å»¶æ—¶å‘é€ç”¨æˆ·ä¿¡æ¯Mapæ ¼å¼æ•°æ®</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> userMap ç”¨æˆ·ä¿¡æ¯Map</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">sendDelayUserMap</span><span class="params">(Map userMap)</span></span><br><span class="line">    &#123;</span><br><span class="line">        rabbitTemplate.convertAndSend(RabbitMqConfig.DELAY_EXCHANGE, RabbitMqConfig.DELAY_ROUTING_KEY, userMap, <span class="keyword">new</span> <span class="title class_">MessagePostProcessor</span>()</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="keyword">public</span> Message <span class="title function_">postProcessMessage</span><span class="params">(Message message)</span> <span class="keyword">throws</span> AmqpException</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="comment">//æ¶ˆæ¯å»¶è¿Ÿ5ç§’</span></span><br><span class="line">                message.getMessageProperties().setHeader(<span class="string">&quot;x-delay&quot;</span>, <span class="number">5000</span>);</span><br><span class="line">                <span class="keyword">return</span> message;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line"> </span><br><span class="line">        System.out.println(<span class="string">&quot;Mapæ ¼å¼æ•°æ®æ¶ˆæ¯å‘é€æˆåŠŸï¼Œå‘é€æ—¶é—´ï¼š&quot;</span> + dateFormat.format(<span class="keyword">new</span> <span class="title class_">Date</span>()));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ul><li>å‘é€æ¶ˆæ¯æ ¸å¿ƒæ–¹æ³•ï¼š</li></ul><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">       * å‘é€æ¶ˆæ¯ï¼Œå‚æ•°è¯´æ˜ï¼š</span></span><br><span class="line"><span class="comment">       * String exchangeï¼šäº¤æ¢å™¨åç§°ã€‚</span></span><br><span class="line"><span class="comment">       * String routingKeyï¼šè·¯ç”±é”®ã€‚</span></span><br><span class="line"><span class="comment">       * Object objectï¼šå‘é€å†…å®¹ã€‚</span></span><br><span class="line"><span class="comment">       */</span></span><br><span class="line">      rabbitTemplate.convertAndSend(RabbitMqConfig.DIRECT_EXCHANGE, RabbitMqConfig.DIRECT_ROUTING_KEY, userInfo);</span><br></pre></td></tr></table></figure><h2 id="72æ¶ˆæ¯æ¥æ”¶ç«¯"><a class="markdownIt-Anchor" href="#72æ¶ˆæ¯æ¥æ”¶ç«¯"></a> 7.2æ¶ˆæ¯æ¥æ”¶ç«¯</h2><h3 id="721å¼•å…¥ä¾èµ–"><a class="markdownIt-Anchor" href="#721å¼•å…¥ä¾èµ–"></a> 7.2.1å¼•å…¥ä¾èµ–</h3><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!-- AMQPå®¢æˆ·ç«¯ --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-amqp<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure><h3 id="722ymlé…ç½®"><a class="markdownIt-Anchor" href="#722ymlé…ç½®"></a> 7.2.2ymlé…ç½®</h3><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="comment"># é¡¹ç›®åç§°</span></span><br><span class="line">  <span class="attr">application:</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">rabbitmq-consumer</span></span><br><span class="line">  <span class="comment"># RabbitMQæœåŠ¡é…ç½®</span></span><br><span class="line">  <span class="attr">rabbitmq:</span></span><br><span class="line">    <span class="attr">host:</span> <span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span></span><br><span class="line">    <span class="attr">port:</span> <span class="number">5672</span></span><br><span class="line">    <span class="attr">username:</span> <span class="string">guest</span></span><br><span class="line">    <span class="attr">password:</span> <span class="string">guest</span></span><br><span class="line">    <span class="attr">listener:</span></span><br><span class="line">      <span class="attr">simple:</span></span><br><span class="line">        <span class="comment"># é‡è¯•æœºåˆ¶</span></span><br><span class="line">        <span class="attr">retry:</span></span><br><span class="line">          <span class="attr">enabled:</span> <span class="literal">true</span> <span class="comment">#æ˜¯å¦å¼€å¯æ¶ˆè´¹è€…é‡è¯•</span></span><br><span class="line">          <span class="attr">max-attempts:</span> <span class="number">5</span> <span class="comment">#æœ€å¤§é‡è¯•æ¬¡æ•°</span></span><br><span class="line">          <span class="attr">initial-interval:</span> <span class="string">5000ms</span> <span class="comment">#é‡è¯•é—´éš”æ—¶é—´ï¼ˆå•ä½æ¯«ç§’ï¼‰</span></span><br><span class="line">          <span class="attr">max-interval:</span> <span class="string">1200000ms</span> <span class="comment">#é‡è¯•æœ€å¤§æ—¶é—´é—´éš”ï¼ˆå•ä½æ¯«ç§’ï¼‰</span></span><br><span class="line">          <span class="attr">multiplier:</span> <span class="number">2</span> <span class="comment">#é—´éš”æ—¶é—´ä¹˜å­ï¼Œé—´éš”æ—¶é—´*ä¹˜å­=ä¸‹ä¸€æ¬¡çš„é—´éš”æ—¶é—´ï¼Œæœ€å¤§ä¸èƒ½è¶…è¿‡è®¾ç½®çš„æœ€å¤§é—´éš”æ—¶é—´</span></span><br></pre></td></tr></table></figure><h3 id="723rabbitmqconfigé…ç½®ç±»éå¸¸é‡è¦"><a class="markdownIt-Anchor" href="#723rabbitmqconfigé…ç½®ç±»éå¸¸é‡è¦"></a> 7.2.3RabbitMQConfigé…ç½®ç±»â€”â€”ï¼ˆéå¸¸é‡è¦ï¼‰</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.pjb.config;</span><br><span class="line"> </span><br><span class="line"><span class="keyword">import</span> com.pjb.receiver.impl.AckReceiver;</span><br><span class="line"><span class="keyword">import</span> org.springframework.amqp.core.AcknowledgeMode;</span><br><span class="line"><span class="keyword">import</span> org.springframework.amqp.core.Queue;</span><br><span class="line"><span class="keyword">import</span> org.springframework.amqp.rabbit.connection.CachingConnectionFactory;</span><br><span class="line"><span class="keyword">import</span> org.springframework.amqp.rabbit.listener.SimpleMessageListenerContainer;</span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.annotation.Autowired;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.Bean;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.Configuration;</span><br><span class="line"> </span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * RabbitMQé…ç½®ç±»</span></span><br><span class="line"><span class="comment"> **/</span></span><br><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">RabbitMqConfig</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">DIRECT_QUEUE</span> <span class="operator">=</span> <span class="string">&quot;direct_queue&quot;</span>; <span class="comment">//Directé˜Ÿåˆ—åç§°</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">DELAY_QUEUE</span> <span class="operator">=</span> <span class="string">&quot;delay_queue&quot;</span>; <span class="comment">//å»¶æ—¶é˜Ÿåˆ—åç§°</span></span><br><span class="line"> </span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * æ¶ˆæ¯æ¥æ”¶ç¡®è®¤å¤„ç†ç±»</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> AckReceiver ackReceiver;</span><br><span class="line"> </span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> CachingConnectionFactory connectionFactory;</span><br><span class="line"> </span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * å®¢æˆ·ç«¯é…ç½®</span></span><br><span class="line"><span class="comment">     * é…ç½®æ‰‹åŠ¨ç¡®è®¤æ¶ˆæ¯ã€æ¶ˆæ¯æ¥æ”¶ç¡®è®¤</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> SimpleMessageListenerContainer <span class="title function_">simpleMessageListenerContainer</span><span class="params">()</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment">//æ¶ˆè´¹è€…æ•°é‡ï¼Œé»˜è®¤10</span></span><br><span class="line">        <span class="type">int</span> <span class="variable">DEFAULT_CONCURRENT</span> <span class="operator">=</span> <span class="number">10</span>;</span><br><span class="line"> </span><br><span class="line">        <span class="comment">//æ¯ä¸ªæ¶ˆè´¹è€…è·å–æœ€å¤§æŠ•é€’æ•°é‡ é»˜è®¤50</span></span><br><span class="line">        <span class="type">int</span> <span class="variable">DEFAULT_PREFETCH_COUNT</span> <span class="operator">=</span> <span class="number">50</span>;</span><br><span class="line"> </span><br><span class="line">        <span class="type">SimpleMessageListenerContainer</span> <span class="variable">container</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">SimpleMessageListenerContainer</span>(connectionFactory);</span><br><span class="line">        container.setConcurrentConsumers(DEFAULT_CONCURRENT);</span><br><span class="line">        container.setMaxConcurrentConsumers(DEFAULT_PREFETCH_COUNT);</span><br><span class="line"> </span><br><span class="line">        <span class="comment">// RabbitMQé»˜è®¤æ˜¯è‡ªåŠ¨ç¡®è®¤ï¼Œè¿™é‡Œæ”¹ä¸ºæ‰‹åŠ¨ç¡®è®¤æ¶ˆæ¯</span></span><br><span class="line">        container.setAcknowledgeMode(AcknowledgeMode.MANUAL);</span><br><span class="line"> </span><br><span class="line">        <span class="comment">//æ·»åŠ é˜Ÿåˆ—ï¼Œå¯æ·»åŠ å¤šä¸ªé˜Ÿåˆ—</span></span><br><span class="line">        container.addQueues(<span class="keyword">new</span> <span class="title class_">Queue</span>(DIRECT_QUEUE,<span class="literal">true</span>));</span><br><span class="line">        container.addQueues(<span class="keyword">new</span> <span class="title class_">Queue</span>(DELAY_QUEUE,<span class="literal">true</span>));</span><br><span class="line"> </span><br><span class="line">        <span class="comment">//è®¾ç½®æ¶ˆæ¯å¤„ç†ç±»</span></span><br><span class="line">        container.setMessageListener(ackReceiver);</span><br><span class="line"> </span><br><span class="line">        <span class="keyword">return</span> container;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="724ç»Ÿä¸€æ¶ˆæ¯å¤„ç†ç±»ackreceiver"><a class="markdownIt-Anchor" href="#724ç»Ÿä¸€æ¶ˆæ¯å¤„ç†ç±»ackreceiver"></a> 7.2.4ç»Ÿä¸€æ¶ˆæ¯å¤„ç†ç±»â€”â€”AckReceiver</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.pjb.receiver.impl;</span><br><span class="line"> </span><br><span class="line"><span class="keyword">import</span> com.pjb.config.RabbitMqConfig;</span><br><span class="line"><span class="keyword">import</span> com.pjb.receiver.UserReceiver;</span><br><span class="line"><span class="keyword">import</span> com.rabbitmq.client.Channel;</span><br><span class="line"><span class="keyword">import</span> org.springframework.amqp.core.Message;</span><br><span class="line"><span class="keyword">import</span> org.springframework.amqp.rabbit.listener.api.ChannelAwareMessageListener;</span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.annotation.Autowired;</span><br><span class="line"><span class="keyword">import</span> org.springframework.stereotype.Service;</span><br><span class="line"> </span><br><span class="line"><span class="keyword">import</span> java.text.SimpleDateFormat;</span><br><span class="line"><span class="keyword">import</span> java.util.Date;</span><br><span class="line"> </span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * æ¶ˆæ¯æ¥æ”¶ç¡®è®¤å¤„ç†ç±»</span></span><br><span class="line"><span class="comment"> * æ‰€æœ‰çš„æ¶ˆæ¯ï¼Œéƒ½ç”±è¯¥ç±»æ¥æ”¶</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> pan_junbiao</span></span><br><span class="line"><span class="comment"> **/</span></span><br><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">AckReceiver</span> <span class="keyword">implements</span> <span class="title class_">ChannelAwareMessageListener</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * ç”¨æˆ·æ¶ˆæ¯æ¥æ”¶ç±»</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> UserReceiver userReceiver;</span><br><span class="line"> </span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onMessage</span><span class="params">(Message message, Channel channel)</span> <span class="keyword">throws</span> Exception</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment">//æ—¶é—´æ ¼å¼</span></span><br><span class="line">        <span class="type">SimpleDateFormat</span> <span class="variable">dateFormat</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">SimpleDateFormat</span>(<span class="string">&quot;yyyy-MM-dd HH:mm:ss&quot;</span>);</span><br><span class="line">        System.out.println(<span class="string">&quot;æ¶ˆæ¯æ¥æ”¶æˆåŠŸï¼Œæ¥æ”¶æ—¶é—´ï¼š&quot;</span> + dateFormat.format(<span class="keyword">new</span> <span class="title class_">Date</span>()) + <span class="string">&quot;\n&quot;</span>);</span><br><span class="line"> </span><br><span class="line">        <span class="comment">//è·å–é˜Ÿåˆ—åç§°</span></span><br><span class="line">        <span class="type">String</span> <span class="variable">queueName</span> <span class="operator">=</span> message.getMessageProperties().getConsumerQueue();</span><br><span class="line"> </span><br><span class="line">        <span class="comment">//æ¥æ”¶ç”¨æˆ·ä¿¡æ¯Jsonæ ¼å¼æ•°æ®</span></span><br><span class="line">        <span class="keyword">if</span> (queueName.equals(RabbitMqConfig.DIRECT_QUEUE))</span><br><span class="line">        &#123;</span><br><span class="line">            userReceiver.receiverUserJson(message, channel);</span><br><span class="line">        &#125;</span><br><span class="line"> </span><br><span class="line">        <span class="comment">//å»¶æ—¶æ¥æ”¶ç”¨æˆ·ä¿¡æ¯Mapæ ¼å¼æ•°æ®</span></span><br><span class="line">        <span class="keyword">if</span> (queueName.equals(RabbitMqConfig.DELAY_QUEUE))</span><br><span class="line">        &#123;</span><br><span class="line">            userReceiver.receiverDelayUserMap(message, channel);</span><br><span class="line">        &#125;</span><br><span class="line"> </span><br><span class="line">        <span class="comment">//å¤šä¸ªé˜Ÿåˆ—çš„å¤„ç†ï¼Œåˆ™å¦‚ä¸Šè¿°ä»£ç ï¼Œç»§ç»­æ·»åŠ æ–¹æ³•....</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="725æ¥æ”¶æ¶ˆæ¯"><a class="markdownIt-Anchor" href="#725æ¥æ”¶æ¶ˆæ¯"></a> 7.2.5æ¥æ”¶æ¶ˆæ¯</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.pjb.receiver;</span><br><span class="line"> </span><br><span class="line"><span class="keyword">import</span> com.rabbitmq.client.Channel;</span><br><span class="line"><span class="keyword">import</span> org.springframework.amqp.core.Message;</span><br><span class="line"> </span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * ç”¨æˆ·æ¶ˆæ¯æ¥æ”¶æ¥å£</span></span><br><span class="line"><span class="comment"> **/</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">UserReceiver</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * æ¥æ”¶ç”¨æˆ·ä¿¡æ¯Jsonæ ¼å¼æ•°æ®</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">receiverUserJson</span><span class="params">(Message message, Channel channel)</span> <span class="keyword">throws</span> Exception;</span><br><span class="line"> </span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * å»¶æ—¶æ¥æ”¶ç”¨æˆ·ä¿¡æ¯Mapæ ¼å¼æ•°æ®</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">receiverDelayUserMap</span><span class="params">(Message message, Channel channel)</span> <span class="keyword">throws</span> Exception;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="1æ¥æ”¶jsonæ•°æ®"><a class="markdownIt-Anchor" href="#1æ¥æ”¶jsonæ•°æ®"></a> ï¼ˆ1ï¼‰æ¥æ”¶JSONæ•°æ®</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">    * æ¥æ”¶ç”¨æˆ·ä¿¡æ¯Jsonæ ¼å¼æ•°æ®</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">   <span class="meta">@Override</span></span><br><span class="line">   <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">receiverUserJson</span><span class="params">(Message message, Channel channel)</span> <span class="keyword">throws</span> Exception</span><br><span class="line">   &#123;</span><br><span class="line">       <span class="comment">//è·å–æ¶ˆæ¯å”¯ä¸€id</span></span><br><span class="line">       <span class="type">long</span> <span class="variable">deliveryTag</span> <span class="operator">=</span> message.getMessageProperties().getDeliveryTag();</span><br><span class="line">       <span class="keyword">try</span></span><br><span class="line">       &#123;</span><br><span class="line">           <span class="comment">//å°†JSONæ ¼å¼æ•°æ®è½¬æ¢ä¸ºå®ä½“å¯¹è±¡â€”â€”éå¸¸é‡è¦ã€é‡è¦ã€é‡è¦</span></span><br><span class="line">           <span class="type">ObjectMapper</span> <span class="variable">mapper</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectMapper</span>();</span><br><span class="line">           <span class="type">UserInfo</span> <span class="variable">userInfo</span> <span class="operator">=</span> mapper.readValue(message.getBody(), UserInfo.class);</span><br><span class="line"></span><br><span class="line">           System.out.println(<span class="string">&quot;æ¥æ”¶è€…æ”¶åˆ°JSONæ ¼å¼æ¶ˆæ¯ï¼š&quot;</span>);</span><br><span class="line">           System.out.println(<span class="string">&quot;ç”¨æˆ·ç¼–å·ï¼š&quot;</span> + userInfo.getUserId());</span><br><span class="line">           System.out.println(<span class="string">&quot;ç”¨æˆ·åç§°ï¼š&quot;</span> + userInfo.getUserName());</span><br><span class="line">           System.out.println(<span class="string">&quot;åšå®¢åœ°å€ï¼š&quot;</span> + userInfo.getBlogUrl());</span><br><span class="line">           System.out.println(<span class="string">&quot;åšå®¢ä¿¡æ¯ï¼š&quot;</span> + userInfo.getBlogRemark());</span><br><span class="line"></span><br><span class="line">           <span class="comment">//ç¡®è®¤æ¶ˆæ¯</span></span><br><span class="line">           channel.basicAck(deliveryTag, <span class="literal">true</span>);</span><br><span class="line"></span><br><span class="line">           <span class="comment">/**</span></span><br><span class="line"><span class="comment">            * å¦å®šæ¶ˆæ¯ï¼Œå‚æ•°è¯´æ˜ï¼š</span></span><br><span class="line"><span class="comment">            * long deliveryTagï¼šå”¯ä¸€æ ‡è¯† IDã€‚</span></span><br><span class="line"><span class="comment">            * boolean multipleï¼šæ˜¯å¦æ‰¹å¤„ç†ï¼Œå½“è¯¥å‚æ•°ä¸º true æ—¶ï¼Œ</span></span><br><span class="line"><span class="comment">            * åˆ™å¯ä»¥ä¸€æ¬¡æ€§ç¡®è®¤ deliveryTag å°äºç­‰äºä¼ å…¥å€¼çš„æ‰€æœ‰æ¶ˆæ¯ã€‚</span></span><br><span class="line"><span class="comment">            * boolean requeueï¼šå¦‚æœ requeue å‚æ•°è®¾ç½®ä¸º trueï¼Œ</span></span><br><span class="line"><span class="comment">            * åˆ™ RabbitMQ ä¼šé‡æ–°å°†è¿™æ¡æ¶ˆæ¯å­˜å…¥é˜Ÿåˆ—ï¼Œä»¥ä¾¿å‘é€ç»™ä¸‹ä¸€ä¸ªè®¢é˜…çš„æ¶ˆè´¹è€…ï¼›</span></span><br><span class="line"><span class="comment">            * å¦‚æœ requeue å‚æ•°è®¾ç½®ä¸º falseï¼Œåˆ™ RabbitMQ ç«‹å³ä¼šè¿˜æŠŠæ¶ˆæ¯ä»é˜Ÿåˆ—ä¸­ç§»é™¤ï¼Œ</span></span><br><span class="line"><span class="comment">            * è€Œä¸ä¼šæŠŠå®ƒå‘é€ç»™æ–°çš„æ¶ˆè´¹è€…ã€‚</span></span><br><span class="line"><span class="comment">            */</span></span><br><span class="line">           <span class="comment">//channel.basicNack(deliveryTag, true, false);</span></span><br><span class="line">       &#125;</span><br><span class="line">       <span class="keyword">catch</span> (Exception e)</span><br><span class="line">       &#123;</span><br><span class="line">           <span class="comment">/**</span></span><br><span class="line"><span class="comment">            * æ‹’ç»æ¶ˆæ¯ï¼Œå‚æ•°è¯´æ˜ï¼š</span></span><br><span class="line"><span class="comment">            * long deliveryTagï¼šå”¯ä¸€æ ‡è¯† IDã€‚</span></span><br><span class="line"><span class="comment">            * boolean requeueï¼šå¦‚æœ requeue å‚æ•°è®¾ç½®ä¸º trueï¼Œ</span></span><br><span class="line"><span class="comment">            * åˆ™ RabbitMQ ä¼šé‡æ–°å°†è¿™æ¡æ¶ˆæ¯å­˜å…¥é˜Ÿåˆ—ï¼Œä»¥ä¾¿å‘é€ç»™ä¸‹ä¸€ä¸ªè®¢é˜…çš„æ¶ˆè´¹è€…ï¼›</span></span><br><span class="line"><span class="comment">            * å¦‚æœ requeue å‚æ•°è®¾ç½®ä¸º falseï¼Œåˆ™ RabbitMQ ç«‹å³ä¼šè¿˜æŠŠæ¶ˆæ¯ä»é˜Ÿåˆ—ä¸­ç§»é™¤ï¼Œ</span></span><br><span class="line"><span class="comment">            * è€Œä¸ä¼šæŠŠå®ƒå‘é€ç»™æ–°çš„æ¶ˆè´¹è€…ã€‚</span></span><br><span class="line"><span class="comment">            */</span></span><br><span class="line">           channel.basicReject(deliveryTag, <span class="literal">false</span>);</span><br><span class="line"></span><br><span class="line">           e.printStackTrace();</span><br><span class="line">       &#125;</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure><h4 id="2æ¥æ”¶mapæ•°æ®"><a class="markdownIt-Anchor" href="#2æ¥æ”¶mapæ•°æ®"></a> ï¼ˆ2ï¼‰æ¥æ”¶mapæ•°æ®</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">   * å»¶æ—¶æ¥æ”¶ç”¨æˆ·ä¿¡æ¯Mapæ ¼å¼æ•°æ®</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  <span class="meta">@Override</span></span><br><span class="line">  <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">receiverDelayUserMap</span><span class="params">(Message message, Channel channel)</span> <span class="keyword">throws</span> Exception</span><br><span class="line">  &#123;</span><br><span class="line">      <span class="type">long</span> <span class="variable">deliveryTag</span> <span class="operator">=</span> message.getMessageProperties().getDeliveryTag();</span><br><span class="line">      <span class="keyword">try</span></span><br><span class="line">      &#123;</span><br><span class="line">          <span class="comment">//å°†JSONæ ¼å¼æ•°æ®è½¬æ¢ä¸ºMapå¯¹è±¡</span></span><br><span class="line">          <span class="type">ObjectMapper</span> <span class="variable">mapper</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectMapper</span>();</span><br><span class="line">          <span class="type">JavaType</span> <span class="variable">javaType</span> <span class="operator">=</span> mapper.getTypeFactory().constructMapType(Map.class, String.class, Object.class);</span><br><span class="line">          Map&lt;String, Object&gt; resultMap = mapper.readValue(message.getBody(),javaType);</span><br><span class="line"> </span><br><span class="line">          System.out.println(<span class="string">&quot;æ¥æ”¶è€…æ”¶åˆ°Mapæ ¼å¼æ¶ˆæ¯ï¼š&quot;</span>);</span><br><span class="line">          System.out.println(<span class="string">&quot;ç”¨æˆ·ç¼–å·ï¼š&quot;</span> + resultMap.get(<span class="string">&quot;userId&quot;</span>));</span><br><span class="line">          System.out.println(<span class="string">&quot;ç”¨æˆ·åç§°ï¼š&quot;</span> + resultMap.get(<span class="string">&quot;userName&quot;</span>));</span><br><span class="line">          System.out.println(<span class="string">&quot;åšå®¢åœ°å€ï¼š&quot;</span> + resultMap.get(<span class="string">&quot;blogUrl&quot;</span>));</span><br><span class="line">          System.out.println(<span class="string">&quot;åšå®¢ä¿¡æ¯ï¼š&quot;</span> + resultMap.get(<span class="string">&quot;userRemark&quot;</span>));</span><br><span class="line"> </span><br><span class="line">          <span class="comment">//ç¡®è®¤æ¶ˆæ¯</span></span><br><span class="line">          channel.basicAck(deliveryTag, <span class="literal">true</span>);</span><br><span class="line"> </span><br><span class="line">          <span class="comment">//å¦å®šæ¶ˆæ¯</span></span><br><span class="line">          <span class="comment">//channel.basicNack(deliveryTag, true, false);</span></span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">catch</span> (Exception e)</span><br><span class="line">      &#123;</span><br><span class="line">          <span class="comment">//æ‹’ç»æ¶ˆæ¯</span></span><br><span class="line">          channel.basicReject(deliveryTag, <span class="literal">false</span>);</span><br><span class="line"> </span><br><span class="line">          e.printStackTrace();</span><br><span class="line">      &#125;</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure><h2 id="73æ€»ç»“"><a class="markdownIt-Anchor" href="#73æ€»ç»“"></a> 7.3æ€»ç»“</h2><ol><li>RabbitMQç³»åˆ—ç¬¬ä¸ƒç¯‡æ–‡ç« ä¸»è¦ä»‹ç»äº†å¦‚ä½•å®ç°JSONã€Mapæ ¼å¼æ•°æ®çš„å‘é€ä¸æ¥æ”¶ï¼›</li><li>åœ¨å‘é€æœåŠ¡ç«¯ä¸­ï¼Œæ ¸å¿ƒä¸ºRabbitMQçš„é…ç½®æ–‡ä»¶ï¼ˆé…ç½®jsonè½¬æ¢å™¨ã€è®¾ç½®äº¤æ¢æœºã€é˜Ÿåˆ—ã€ç»‘å®šäº¤æ¢æœºä¸é˜Ÿåˆ—ï¼‰å‘é€æ¶ˆæ¯çš„æ ¸å¿ƒæ–¹æ³•ä¸ºRabbitTemplate.convertAndSendæ–¹æ³•ï¼Œä¼ å…¥æŒ‡å®šäº¤æ¢æœºã€è·¯ç”±é”®ã€ä»¥åŠè¦å‘é€çš„æ¶ˆæ¯å†…å®¹ï¼›</li><li>åœ¨æ¥æ”¶æœåŠ¡ç«¯ä¸­ï¼Œæ ¸å¿ƒä¾ç„¶ä¸ºé…ç½®æ–‡ä»¶ä¸­çš„å®¢æˆ·ç«¯é…ç½®ï¼šâ‘ æ‰‹åŠ¨ç¡®è®¤ä¿¡æ¯ï¼›â‘¡æ·»åŠ ç›‘å¬é˜Ÿåˆ—ï¼›â‘¢è®¾ç½®ç»Ÿä¸€æ¶ˆæ¯å¤„ç†ç±»ï¼Œæ¥ç€åœ¨æ¶ˆæ¯å¤„ç†ç±»ä¸­è·å–æ¶ˆæ¯çš„é˜Ÿåˆ—åç§°ï¼Œæ ¹æ®ä¸åŒçš„é˜Ÿåˆ—åç§°è°ƒç”¨ä¸åŒçš„æ¶ˆæ¯å¤„ç†ç±»ï¼›</li><li>åœ¨æ¥æ”¶jsonæ ¼å¼çš„å¤„ç†ç±»ä¸­ï¼Œé€šè¿‡ObjectMapperå¯¹è±¡çš„readValueæ–¹æ³•ï¼Œå°†messageä¸­çš„bodyå†…å®¹ï¼Œè½¬æˆæƒ³è¦çš„å¯¹è±¡ï¼›</li><li>åœ¨æ¥æ”¶mapæ ¼å¼çš„å¤„ç†ä¸­ï¼Œå…ˆé€šè¿‡ObjectMapperå¯¹è±¡çš„getTypeFactroy()çš„constructMapType()ï¼Œæ„é€ å‡ºJavaTypeå¯¹è±¡ï¼Œæ¥ç€ä½¿ç”¨ObjectMapperå¯¹è±¡çš„readValueæ–¹æ³•å’ŒJavaTypeå¯¹è±¡ï¼Œå°†messageä¸­çš„bodyå†…å®¹è½¬æˆmapæ ¼å¼</li></ol>]]></content>
    
    
      
      
    <summary type="html">&lt;link rel=&quot;stylesheet&quot; class=&quot;aplayer-secondary-style-marker&quot; href=&quot;&#92;assets&#92;css&#92;APlayer.min.css&quot;&gt;&lt;script src=&quot;&#92;assets&#92;js&#92;APlayer.min.js&quot; cla</summary>
      
    
    
    
    <category term="ã€æ¶ˆæ¯é˜Ÿåˆ—ã€‘" scheme="https://www.haipeng-lin.cn/categories/%E3%80%90%E6%B6%88%E6%81%AF%E9%98%9F%E5%88%97%E3%80%91/"/>
    
    
  </entry>
  
  <entry>
    <title>æ¶ˆæ¯é˜Ÿåˆ—åŸºç¡€çŸ¥è¯†</title>
    <link href="https://www.haipeng-lin.cn/posts/f0fb6932.html"/>
    <id>https://www.haipeng-lin.cn/posts/f0fb6932.html</id>
    <published>2024-10-07T09:39:33.000Z</published>
    <updated>2024-10-07T14:59:38.760Z</updated>
    
    <content type="html"><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="\assets\css\APlayer.min.css"><script src="\assets\js\APlayer.min.js" class="aplayer-secondary-script-marker"></script><h1 id="1ä»€ä¹ˆæ˜¯æ¶ˆæ¯é˜Ÿåˆ—"><a class="markdownIt-Anchor" href="#1ä»€ä¹ˆæ˜¯æ¶ˆæ¯é˜Ÿåˆ—"></a> 1.ä»€ä¹ˆæ˜¯æ¶ˆæ¯é˜Ÿåˆ—ï¼Ÿ</h1><p>â€‹æ¶ˆæ¯é˜Ÿåˆ—æ˜¯ä¸€ç§å…ˆè¿›å…ˆå‡ºï¼ˆFIFOï¼‰çš„æ•°æ®ç»“æ„ï¼Œç”¨äºåœ¨åº”ç”¨ç¨‹åºä¹‹é—´ä¼ é€’æ¶ˆæ¯ã€‚å®ƒæä¾›äº†ä¸€ç§è§£è€¦ã€å¼‚æ­¥å’Œå¯é çš„æ¶ˆæ¯ä¼ é€’æœºåˆ¶ï¼Œä½¿å¾—åº”ç”¨ç¨‹åºå¯ä»¥ç‹¬ç«‹åœ°è¿è¡Œï¼Œå¹¶é€šè¿‡æ¶ˆæ¯é˜Ÿåˆ—è¿›è¡Œé€šä¿¡ã€‚</p><p>â€‹å‚ä¸æ¶ˆæ¯ä¼ é€’çš„åŒæ–¹ç§°ä¸º <strong>ç”Ÿäº§è€…</strong> å’Œ <strong>æ¶ˆè´¹è€…</strong> ï¼Œç”Ÿäº§è€…è´Ÿè´£å‘é€æ¶ˆæ¯ï¼Œæ¶ˆè´¹è€…è´Ÿè´£å¤„ç†æ¶ˆæ¯ã€‚</p><img src="https://haipeng-lin.oss-cn-shenzhen.aliyuncs.com/202410071729898.png" alt="img" style="zoom: 67%;" /><h1 id="2æ¶ˆæ¯é˜Ÿåˆ—ä½œç”¨"><a class="markdownIt-Anchor" href="#2æ¶ˆæ¯é˜Ÿåˆ—ä½œç”¨"></a> 2.æ¶ˆæ¯é˜Ÿåˆ—ä½œç”¨</h1><ol><li>é€šè¿‡<mark>å¼‚æ­¥å¤„ç†</mark>æé«˜ç³»ç»Ÿæ€§èƒ½ï¼Œå‡å°‘å“åº”æ‰€éœ€æ—¶é—´</li><li>å‰Šå³°ï¼Œé™æµï¼ˆå…ˆå°†çŸ­æ—¶é—´é«˜å¹¶å‘äº§ç”Ÿçš„äº‹åŠ¡æ¶ˆæ¯å­˜å‚¨åœ¨æ¶ˆæ¯é˜Ÿåˆ—ä¸­ï¼Œç„¶ååç«¯æœåŠ¡å†æ…¢æ…¢æ ¹æ®è‡ªå·±çš„èƒ½åŠ›å»æ¶ˆè´¹è¿™äº›æ¶ˆæ¯ï¼‰</li><li>é™ä½ç³»ç»Ÿè€¦åˆæ€§ï¼Œæˆ‘ä»¬çŸ¥é“<mark>å¦‚æœæ¨¡å—ä¹‹é—´ä¸å­˜åœ¨ç›´æ¥è°ƒç”¨</mark>ï¼Œé‚£ä¹ˆæ–°å¢æ¨¡å—æˆ–è€…ä¿®æ”¹æ¨¡å—å°±å¯¹å…¶ä»–æ¨¡å—å½±å“è¾ƒå°ï¼Œè¿™æ ·ç³»ç»Ÿçš„å¯æ‰©å±•æ€§æ— ç–‘æ›´å¥½ä¸€äº›ã€‚è¿˜æ˜¯ç›´æ¥ä¸Šå›¾å§ï¼š</li></ol><p><img src="https://oss.javaguide.cn/github/javaguide/high-performance/message-queue/%E6%B6%88%E6%81%AF%E9%98%9F%E5%88%97-%E8%A7%A3%E8%80%A6.png" alt="è§£è€¦" /></p><p><strong>æ¶ˆæ¯é˜Ÿåˆ—ä½¿ç”¨å‘å¸ƒ-è®¢é˜…æ¨¡å¼å·¥ä½œï¼Œæ¶ˆæ¯å‘é€è€…ï¼ˆç”Ÿäº§è€…ï¼‰å‘å¸ƒæ¶ˆæ¯ï¼Œä¸€ä¸ªæˆ–å¤šä¸ªæ¶ˆæ¯æ¥å—è€…ï¼ˆæ¶ˆè´¹è€…ï¼‰è®¢é˜…æ¶ˆæ¯ã€‚</strong> ä»ä¸Šå›¾å¯ä»¥çœ‹åˆ°<strong>æ¶ˆæ¯å‘é€è€…ï¼ˆç”Ÿäº§è€…ï¼‰å’Œæ¶ˆæ¯æ¥å—è€…ï¼ˆæ¶ˆè´¹è€…ï¼‰ä¹‹é—´æ²¡æœ‰ç›´æ¥è€¦åˆ</strong>ï¼Œæ¶ˆæ¯å‘é€è€…å°†æ¶ˆæ¯å‘é€è‡³åˆ†å¸ƒå¼æ¶ˆæ¯é˜Ÿåˆ—å³ç»“æŸå¯¹æ¶ˆæ¯çš„å¤„ç†ï¼Œæ¶ˆæ¯æ¥å—è€…ä»åˆ†å¸ƒå¼æ¶ˆæ¯é˜Ÿåˆ—è·å–è¯¥æ¶ˆæ¯åè¿›è¡Œåç»­å¤„ç†ï¼Œå¹¶ä¸éœ€è¦çŸ¥é“è¯¥æ¶ˆæ¯ä»ä½•è€Œæ¥ã€‚<strong>å¯¹æ–°å¢ä¸šåŠ¡ï¼Œåªè¦å¯¹è¯¥ç±»æ¶ˆæ¯æ„Ÿå…´è¶£ï¼Œå³å¯è®¢é˜…è¯¥æ¶ˆæ¯ï¼Œå¯¹åŸæœ‰ç³»ç»Ÿå’Œä¸šåŠ¡æ²¡æœ‰ä»»ä½•å½±å“ï¼Œä»è€Œå®ç°ç½‘ç«™ä¸šåŠ¡çš„å¯æ‰©å±•æ€§è®¾è®¡</strong>ã€‚</p><h1 id="3æ¶ˆæ¯é˜Ÿåˆ—çš„ç¼ºç‚¹"><a class="markdownIt-Anchor" href="#3æ¶ˆæ¯é˜Ÿåˆ—çš„ç¼ºç‚¹"></a> 3.æ¶ˆæ¯é˜Ÿåˆ—çš„ç¼ºç‚¹</h1><ol><li><strong>ç³»ç»Ÿå¯ç”¨æ€§é™ä½ï¼š</strong> ç³»ç»Ÿå¯ç”¨æ€§åœ¨æŸç§ç¨‹åº¦ä¸Šé™ä½ï¼Œä¸ºä»€ä¹ˆè¿™æ ·è¯´å‘¢ï¼Ÿåœ¨åŠ å…¥ MQ ä¹‹å‰ï¼Œä½ ä¸ç”¨è€ƒè™‘æ¶ˆæ¯ä¸¢å¤±æˆ–è€…è¯´ MQ æŒ‚æ‰ç­‰ç­‰çš„æƒ…å†µï¼Œä½†æ˜¯ï¼Œå¼•å…¥ MQ ä¹‹åä½ å°±éœ€è¦å»è€ƒè™‘äº†ï¼</li><li><strong>ç³»ç»Ÿå¤æ‚æ€§æé«˜ï¼š</strong> åŠ å…¥ MQ ä¹‹åï¼Œä½ éœ€è¦ä¿è¯æ¶ˆæ¯æ²¡æœ‰è¢«é‡å¤æ¶ˆè´¹ã€å¤„ç†æ¶ˆæ¯ä¸¢å¤±çš„æƒ…å†µã€ä¿è¯æ¶ˆæ¯ä¼ é€’çš„é¡ºåºæ€§ç­‰ç­‰é—®é¢˜ï¼</li><li><strong><mark>ä¸€è‡´æ€§é—®é¢˜</mark>ï¼š</strong> æˆ‘ä¸Šé¢è®²äº†æ¶ˆæ¯é˜Ÿåˆ—å¯ä»¥å®ç°å¼‚æ­¥ï¼Œæ¶ˆæ¯é˜Ÿåˆ—å¸¦æ¥çš„å¼‚æ­¥ç¡®å®å¯ä»¥æé«˜ç³»ç»Ÿå“åº”é€Ÿåº¦ã€‚ä½†æ˜¯ï¼Œä¸‡ä¸€æ¶ˆæ¯çš„çœŸæ­£æ¶ˆè´¹è€…å¹¶æ²¡æœ‰æ­£ç¡®æ¶ˆè´¹æ¶ˆæ¯æ€ä¹ˆåŠï¼Ÿè¿™æ ·å°±ä¼šå¯¼è‡´æ•°æ®ä¸ä¸€è‡´çš„æƒ…å†µäº†</li></ol><h1 id="4jmså’Œamqp"><a class="markdownIt-Anchor" href="#4jmså’Œamqp"></a> 4.JMSå’ŒAMQP</h1><ul><li><p><mark>JMS</mark>ï¼ˆjava message serviceï¼‰ï¼šjavaæ¶ˆæ¯æœåŠ¡</p><p>æ”¯æŒjavaå¹³å°ï¼Œä¸è·¨è¯­è¨€ï¼Œæœ¬è´¨å°±æ˜¯javaAPIï¼Œç›¸å½“äºå°±æ˜¯ä¸€ä¸ªè§„èŒƒã€‚æä¾›å¤§é‡çš„messageç»“æ„</p></li><li><p><mark>AMQP</mark>ï¼ˆadvanced message queuing protocolï¼‰ï¼šé«˜çº§æ¶ˆæ¯é˜Ÿåˆ—åè®®</p><ul><li>è·¨è¯­è¨€è·¨å¹³å°ï¼Œæ˜¯ä¸€ä¸ªç½‘ç»œçº¿çº§åè®®ã€‚<mark>åªæä¾›byteæ•°ç»„ä¼ è¾“</mark>ã€‚</li><li>RabbitMQæ˜¯AMQPçš„å®ç°</li></ul></li></ul><p>å¯¹æ¯”å¦‚ä¸‹ï¼š</p><img src="https://gitee.com/linhaipengg/md_-picture/raw/master/image-20240113171522233.png" alt="image-20240113171522233" style="zoom: 67%;" /><h2 id="41-jmsçš„ä¸¤ç§æ¶ˆæ¯æ¨¡å‹"><a class="markdownIt-Anchor" href="#41-jmsçš„ä¸¤ç§æ¶ˆæ¯æ¨¡å‹"></a> 4.1 JMSçš„ä¸¤ç§æ¶ˆæ¯æ¨¡å‹</h2><h3 id="411ç‚¹å¯¹ç‚¹p2pæ¨¡å‹"><a class="markdownIt-Anchor" href="#411ç‚¹å¯¹ç‚¹p2pæ¨¡å‹"></a> 4.1.1ç‚¹å¯¹ç‚¹ï¼ˆP2Pï¼‰æ¨¡å‹</h3><p>ä½¿ç”¨**é˜Ÿåˆ—ï¼ˆQueueï¼‰*<em>ä½œä¸ºæ¶ˆæ¯é€šä¿¡è½½ä½“ï¼›æ»¡è¶³*<em>ç”Ÿäº§è€…ä¸æ¶ˆè´¹è€…æ¨¡å¼</em></em>ï¼Œä¸€æ¡æ¶ˆæ¯åªèƒ½è¢«ä¸€ä¸ªæ¶ˆè´¹è€…ä½¿ç”¨ï¼Œæœªè¢«æ¶ˆè´¹çš„æ¶ˆæ¯åœ¨é˜Ÿåˆ—ä¸­ä¿ç•™ç›´åˆ°è¢«æ¶ˆè´¹æˆ–è¶…æ—¶ã€‚æ¯”å¦‚ï¼šæˆ‘ä»¬ç”Ÿäº§è€…å‘é€ 100 æ¡æ¶ˆæ¯çš„è¯ï¼Œä¸¤ä¸ªæ¶ˆè´¹è€…æ¥æ¶ˆè´¹ä¸€èˆ¬æƒ…å†µä¸‹ä¸¤ä¸ªæ¶ˆè´¹è€…ä¼šæŒ‰ç…§æ¶ˆæ¯å‘é€çš„é¡ºåºå„è‡ªæ¶ˆè´¹ä¸€åŠï¼ˆä¹Ÿå°±æ˜¯ä½ ä¸€ä¸ªæˆ‘ä¸€ä¸ªçš„æ¶ˆè´¹ã€‚ï¼‰</p><h3 id="412å‘å¸ƒè®¢é˜…pubsubæ¨¡å‹"><a class="markdownIt-Anchor" href="#412å‘å¸ƒè®¢é˜…pubsubæ¨¡å‹"></a> 4.1.2å‘å¸ƒ/è®¢é˜…ï¼ˆPub/Subï¼‰æ¨¡å‹</h3><p>ï¼ˆTopic)*<em>ä½œä¸ºæ¶ˆæ¯é€šä¿¡è½½ä½“ï¼Œç±»ä¼¼äº*<em>å¹¿æ’­æ¨¡å¼</em></em>ï¼›å‘å¸ƒè€…å‘å¸ƒä¸€æ¡æ¶ˆæ¯ï¼Œè¯¥æ¶ˆæ¯é€šè¿‡ä¸»é¢˜ä¼ é€’ç»™æ‰€æœ‰çš„è®¢é˜…è€…</p><h1 id="5æ¶ˆæ¯é˜Ÿåˆ—æŠ€æœ¯é€‰å‹"><a class="markdownIt-Anchor" href="#5æ¶ˆæ¯é˜Ÿåˆ—æŠ€æœ¯é€‰å‹"></a> 5.æ¶ˆæ¯é˜Ÿåˆ—æŠ€æœ¯é€‰å‹</h1><h2 id="51-kafka"><a class="markdownIt-Anchor" href="#51-kafka"></a> 5.1 Kafka</h2><p>Kafka æ˜¯ LinkedIn å¼€æºçš„ä¸€ä¸ªåˆ†å¸ƒå¼æµå¼å¤„ç†å¹³å°ï¼Œå·²ç»æˆä¸º Apache é¡¶çº§é¡¹ç›®ï¼Œæ—©æœŸè¢«ç”¨æ¥ç”¨äºå¤„ç†æµ·é‡çš„æ—¥å¿—ï¼Œåé¢æ‰æ…¢æ…¢å‘å±•æˆäº†ä¸€æ¬¾åŠŸèƒ½å…¨é¢çš„é«˜æ€§èƒ½æ¶ˆæ¯é˜Ÿåˆ—ã€‚</p><ol><li><strong><mark>æ¶ˆæ¯é˜Ÿåˆ—</mark></strong>ï¼š<mark>å‘å¸ƒå’Œè®¢é˜…æ¶ˆæ¯æµ</mark>ï¼Œè¿™ä¸ªåŠŸèƒ½ç±»ä¼¼äºæ¶ˆæ¯é˜Ÿåˆ—ï¼Œè¿™ä¹Ÿæ˜¯ Kafka ä¹Ÿè¢«å½’ç±»ä¸ºæ¶ˆæ¯é˜Ÿåˆ—çš„åŸå› ã€‚</li><li><strong><mark>å®¹é”™çš„æŒä¹…æ–¹å¼å­˜å‚¨è®°å½•æ¶ˆæ¯æµ</mark></strong>ï¼šKafka ä¼šæŠŠæ¶ˆæ¯æŒä¹…åŒ–åˆ°ç£ç›˜ï¼Œæœ‰æ•ˆé¿å…äº†æ¶ˆæ¯ä¸¢å¤±çš„é£é™©ã€‚</li><li><strong>æµå¼å¤„ç†å¹³å°ï¼š</strong> åœ¨æ¶ˆæ¯å‘å¸ƒçš„æ—¶å€™è¿›è¡Œå¤„ç†ï¼ŒKafka æä¾›äº†ä¸€ä¸ªå®Œæ•´çš„æµå¼å¤„ç†ç±»åº“ã€‚</li></ol><p>Kafka æ˜¯ä¸€ä¸ªåˆ†å¸ƒå¼ç³»ç»Ÿï¼Œç”±é€šè¿‡é«˜æ€§èƒ½ TCP ç½‘ç»œåè®®è¿›è¡Œé€šä¿¡çš„æœåŠ¡å™¨å’Œå®¢æˆ·ç«¯ç»„æˆï¼Œå¯ä»¥éƒ¨ç½²åœ¨åœ¨æœ¬åœ°å’Œäº‘ç¯å¢ƒä¸­çš„è£¸æœºç¡¬ä»¶ã€è™šæ‹Ÿæœºå’Œå®¹å™¨ä¸Šã€‚</p><h2 id="52-rocketmq"><a class="markdownIt-Anchor" href="#52-rocketmq"></a> 5.2 RocketMQ</h2><p>RocketMQ æ˜¯é˜¿é‡Œå¼€æºçš„ä¸€æ¬¾äº‘åŸç”Ÿâ€œæ¶ˆæ¯ã€äº‹ä»¶ã€æµâ€å®æ—¶æ•°æ®å¤„ç†å¹³å°ï¼Œå€Ÿé‰´äº† Kafkaï¼Œå·²ç»æˆä¸º Apache é¡¶çº§é¡¹ç›®ã€‚</p><ol><li><mark><strong>äº‘åŸç”Ÿ</strong></mark>ï¼šç”Ÿä¸äº‘ï¼Œé•¿ä¸äº‘ï¼Œæ— é™å¼¹æ€§æ‰©ç¼©ï¼ŒK8s å‹å¥½</li><li><mark><strong>é«˜åå</strong></mark>ï¼šä¸‡äº¿çº§ååä¿è¯ï¼ŒåŒæ—¶æ»¡è¶³å¾®æœåŠ¡ä¸å¤§æ•°æ®åœºæ™¯ã€‚</li><li>æµå¤„ç†ï¼šæä¾›è½»é‡ã€é«˜æ‰©å±•ã€é«˜æ€§èƒ½å’Œä¸°å¯ŒåŠŸèƒ½çš„æµè®¡ç®—å¼•æ“ã€‚</li><li>é‡‘èçº§ï¼šé‡‘èçº§çš„ç¨³å®šæ€§ï¼Œå¹¿æ³›ç”¨äºäº¤æ˜“æ ¸å¿ƒé“¾è·¯ã€‚</li><li>æ¶æ„æç®€ï¼šé›¶å¤–éƒ¨ä¾èµ–ï¼ŒShared-nothing æ¶æ„ã€‚</li><li><mark><strong>ç”Ÿæ€å‹å¥½</strong></mark>ï¼šæ— ç¼å¯¹æ¥å¾®æœåŠ¡ã€å®æ—¶è®¡ç®—ã€æ•°æ®æ¹–ç­‰å‘¨è¾¹ç”Ÿæ€ã€‚</li></ol><h2 id="53-rabbitmq"><a class="markdownIt-Anchor" href="#53-rabbitmq"></a> 5.3 RabbitMQ</h2><p>RabbitMQ æ˜¯é‡‡ç”¨ Erlang è¯­è¨€å®ç° AMQP(Advanced Message Queuing Protocolï¼Œé«˜çº§æ¶ˆæ¯é˜Ÿåˆ—åè®®ï¼‰çš„æ¶ˆæ¯ä¸­é—´ä»¶ï¼Œå®ƒæœ€åˆèµ·æºäºé‡‘èç³»ç»Ÿï¼Œç”¨äºåœ¨åˆ†å¸ƒå¼ç³»ç»Ÿä¸­å­˜å‚¨è½¬å‘æ¶ˆæ¯ã€‚</p><ol><li><strong><mark>å¯é æ€§</mark>ï¼š</strong> RabbitMQ ä½¿ç”¨ä¸€äº›æœºåˆ¶æ¥ä¿è¯æ¶ˆæ¯çš„å¯é æ€§ï¼Œå¦‚æŒä¹…åŒ–ã€ä¼ è¾“ç¡®è®¤åŠå‘å¸ƒç¡®è®¤ç­‰ã€‚</li><li><strong><mark>çµæ´»çš„è·¯ç”±</mark>ï¼š</strong> åœ¨æ¶ˆæ¯è¿›å…¥é˜Ÿåˆ—ä¹‹å‰ï¼Œé€šè¿‡äº¤æ¢å™¨æ¥è·¯ç”±æ¶ˆæ¯ã€‚å¯¹äºå…¸å‹çš„è·¯ç”±åŠŸèƒ½ï¼ŒRabbitMQ å·±ç»æä¾›äº†ä¸€äº›å†…ç½®çš„äº¤æ¢å™¨æ¥å®ç°ã€‚é’ˆå¯¹æ›´å¤æ‚çš„è·¯ç”±åŠŸèƒ½ï¼Œå¯ä»¥å°†å¤šä¸ªäº¤æ¢å™¨ç»‘å®šåœ¨ä¸€èµ·ï¼Œä¹Ÿå¯ä»¥é€šè¿‡æ’ä»¶æœºåˆ¶æ¥å®ç°è‡ªå·±çš„äº¤æ¢å™¨ã€‚è¿™ä¸ªåé¢ä¼šåœ¨æˆ‘ä»¬è®² RabbitMQ æ ¸å¿ƒæ¦‚å¿µçš„æ—¶å€™è¯¦ç»†ä»‹ç»åˆ°ã€‚</li><li><strong>æ‰©å±•æ€§ï¼š</strong> å¤šä¸ª RabbitMQ èŠ‚ç‚¹å¯ä»¥ç»„æˆä¸€ä¸ªé›†ç¾¤ï¼Œä¹Ÿå¯ä»¥æ ¹æ®å®é™…ä¸šåŠ¡æƒ…å†µåŠ¨æ€åœ°æ‰©å±•é›†ç¾¤ä¸­èŠ‚ç‚¹ã€‚</li><li><strong>é«˜å¯ç”¨æ€§ï¼š</strong> é˜Ÿåˆ—å¯ä»¥åœ¨é›†ç¾¤ä¸­çš„æœºå™¨ä¸Šè®¾ç½®é•œåƒï¼Œä½¿å¾—åœ¨éƒ¨åˆ†èŠ‚ç‚¹å‡ºç°é—®é¢˜çš„æƒ…å†µä¸‹é˜Ÿåˆ—ä»ç„¶å¯ç”¨ã€‚</li><li><strong>æ”¯æŒå¤šç§åè®®ï¼š</strong> RabbitMQ é™¤äº†åŸç”Ÿæ”¯æŒ AMQP åè®®ï¼Œè¿˜æ”¯æŒ STOMPã€MQTT ç­‰å¤šç§æ¶ˆæ¯ä¸­é—´ä»¶åè®®ã€‚</li><li><strong>å¤šè¯­è¨€å®¢æˆ·ç«¯ï¼š</strong> RabbitMQ å‡ ä¹æ”¯æŒæ‰€æœ‰å¸¸ç”¨è¯­è¨€ï¼Œæ¯”å¦‚ Javaã€Pythonã€Rubyã€PHPã€C#ã€JavaScript ç­‰ã€‚</li><li><strong>æ˜“ç”¨çš„ç®¡ç†ç•Œé¢ï¼š</strong> RabbitMQ æä¾›äº†ä¸€ä¸ªæ˜“ç”¨çš„ç”¨æˆ·ç•Œé¢ï¼Œä½¿å¾—ç”¨æˆ·å¯ä»¥ç›‘æ§å’Œç®¡ç†æ¶ˆæ¯ã€é›†ç¾¤ä¸­çš„èŠ‚ç‚¹ç­‰ã€‚åœ¨å®‰è£… RabbitMQ çš„æ—¶å€™ä¼šä»‹ç»åˆ°ï¼Œå®‰è£…å¥½ RabbitMQ å°±è‡ªå¸¦ç®¡ç†ç•Œé¢ã€‚</li><li><strong>æ’ä»¶æœºåˆ¶ï¼š</strong> RabbitMQ æä¾›äº†è®¸å¤šæ’ä»¶ï¼Œä»¥å®ç°ä»å¤šæ–¹é¢è¿›è¡Œæ‰©å±•ï¼Œå½“ç„¶ä¹Ÿå¯ä»¥ç¼–å†™è‡ªå·±çš„æ’ä»¶ã€‚æ„Ÿè§‰è¿™ä¸ªæœ‰ç‚¹ç±»ä¼¼ Dubbo çš„ SPI æœº</li></ol><h2 id="54æŠ€æœ¯é€‰å‹"><a class="markdownIt-Anchor" href="#54æŠ€æœ¯é€‰å‹"></a> 5.4æŠ€æœ¯é€‰å‹</h2><table><thead><tr><th>ç‰¹æ€§</th><th>Kafka</th><th>RocketMQ</th><th>RabbitMQ</th><th>ActiveMQ</th></tr></thead><tbody><tr><td><strong>å•æœºååé‡</strong></td><td>10ä¸‡çº§</td><td>10ä¸‡çº§</td><td>ä¸‡çº§</td><td>10ä¸‡çº§</td></tr><tr><td><strong>å¼€å‘è¯­è¨€</strong></td><td>Scala</td><td>Java</td><td>Erlang</td><td>Java</td></tr><tr><td><strong>é«˜å¯ç”¨</strong></td><td>åˆ†å¸ƒå¼</td><td>åˆ†å¸ƒå¼</td><td>ä¸»ä»</td><td>åˆ†å¸ƒå¼</td></tr><tr><td><strong>æ¶ˆæ¯å»¶è¿Ÿ</strong></td><td>msçº§</td><td>msçº§</td><td>usçº§</td><td>msçº§</td></tr><tr><td><strong>æ¶ˆæ¯ä¸¢å¤±</strong></td><td>ç†è®ºä¸Šä¸ä¼šä¸¢å¤±</td><td>ç†è®ºä¸Šä¸ä¼šä¸¢å¤±</td><td>ä½</td><td>ä½</td></tr><tr><td><strong>æ¶ˆè´¹æ¨¡å¼</strong></td><td>æ‹‰å–</td><td>æ¨æ‹‰</td><td>æ¨æ‹‰</td><td></td></tr><tr><td><strong>æŒä¹…åŒ–</strong></td><td></td><td>æ–‡ä»¶</td><td>å†…å­˜ï¼Œæ–‡ä»¶</td><td>å†…å­˜ï¼Œæ–‡ä»¶ï¼Œæ•°æ®åº“</td></tr><tr><td><strong>æ”¯æŒåè®®</strong></td><td>è‡ªå®šä¹‰åè®®</td><td>è‡ªå®šä¹‰åè®®</td><td>AMQPï¼ŒXMPP, SMTP,STOMP</td><td>AMQP,MQTT,OpenWire,STOMP</td></tr><tr><td><strong>ç¤¾åŒºæ´»è·ƒåº¦</strong></td><td>é«˜</td><td>ä¸­</td><td>é«˜</td><td>é«˜</td></tr><tr><td><strong>ç®¡ç†ç•Œé¢</strong></td><td></td><td>web console</td><td>å¥½</td><td>ä¸€èˆ¬</td></tr><tr><td><strong>éƒ¨ç½²éš¾åº¦</strong></td><td>ä¸­</td><td></td><td>ä½</td><td></td></tr><tr><td><strong>éƒ¨ç½²æ–¹å¼</strong></td><td>ç‹¬ç«‹</td><td>ç‹¬ç«‹</td><td>ç‹¬ç«‹</td><td>ç‹¬ç«‹ï¼ŒåµŒå…¥</td></tr><tr><td><strong>æˆç†Ÿåº¦</strong></td><td>æˆç†Ÿ</td><td>æ¯”è¾ƒæˆç†Ÿ</td><td>æˆç†Ÿ</td><td>æˆç†Ÿ</td></tr><tr><td><strong>ç»¼åˆè¯„ä»·       ç»¼åˆè¯„ä»·       ç»¼åˆè¯„ä»·       ç»¼åˆè¯„ä»·     ç»¼åˆè¯„ä»·       ç»¼åˆè¯„ä»·</strong></td><td>ä¼˜ç‚¹ï¼šæ‹¥æœ‰å¼ºå¤§çš„æ€§èƒ½åŠååé‡ï¼Œå…¼å®¹æ€§å¾ˆå¥½ã€‚ </br>ç¼ºç‚¹ï¼šç”±äºæ”¯æŒæ¶ˆæ¯å †ç§¯ï¼Œå¯¼è‡´å»¶è¿Ÿæ¯”è¾ƒé«˜ã€‚</td><td>ä¼˜ç‚¹ï¼šæ€§èƒ½å¥½ï¼Œç¨³å®šå¯é ï¼Œæœ‰æ´»è·ƒçš„ä¸­æ–‡ç¤¾åŒºï¼Œç‰¹ç‚¹å“åº”å¿«ã€‚  </br>ç¼ºç‚¹ï¼šå…¼å®¹æ€§è¾ƒå·®ï¼Œä½†éšç€å½±å“åŠ›çš„æ‰©å¤§ï¼Œè¯¥é—®é¢˜ä¼šæœ‰æ”¹å–„ã€‚</td><td>ä¼˜ç‚¹ï¼šäº§å“æˆç†Ÿï¼Œå®¹æ˜“éƒ¨ç½²å’Œä½¿ç”¨ï¼Œæ‹¥æœ‰çµæ´»çš„è·¯ç”±é…ç½®ã€‚  </br>ç¼ºç‚¹ï¼šæ€§èƒ½å’Œååé‡è¾ƒå·®ï¼Œä¸æ˜“è¿›è¡ŒäºŒæ¬¡å¼€å‘ã€‚</td><td>ä¼˜ç‚¹ï¼šäº§å“æˆç†Ÿï¼Œæ”¯æŒåè®®å¤šï¼Œæ”¯æŒå¤šç§è¯­è¨€çš„å®¢æˆ·ç«¯ã€‚  </br>ç¼ºç‚¹ï¼šç¤¾åŒºä¸æ´»è·ƒï¼Œå­˜åœ¨æ¶ˆæ¯ä¸¢å¤±çš„å¯èƒ½ã€‚</td></tr></tbody></table><p>æ€»ç»“èµ·æ¥ï¼Œç”µå•†ã€é‡‘èç­‰å¯¹äº‹åŠ¡æ€§è¦æ±‚å¾ˆé«˜çš„ï¼Œå¯ä»¥è€ƒè™‘RocketMQï¼›æŠ€æœ¯æŒ‘æˆ˜ä¸æ˜¯ç‰¹åˆ«é«˜ï¼Œç”¨ RabbitMQ æ˜¯ä¸é”™çš„é€‰æ‹©ï¼›å¦‚æœæ˜¯å¤§æ•°æ®é¢†åŸŸçš„å®æ—¶è®¡ç®—ã€æ—¥å¿—é‡‡é›†ç­‰åœºæ™¯å¯ä»¥è€ƒè™‘ Kafkaã€‚</p>]]></content>
    
    
      
      
    <summary type="html">&lt;link rel=&quot;stylesheet&quot; class=&quot;aplayer-secondary-style-marker&quot; href=&quot;&#92;assets&#92;css&#92;APlayer.min.css&quot;&gt;&lt;script src=&quot;&#92;assets&#92;js&#92;APlayer.min.js&quot; cla</summary>
      
    
    
    
    <category term="ã€æ¶ˆæ¯é˜Ÿåˆ—ã€‘" scheme="https://www.haipeng-lin.cn/categories/%E3%80%90%E6%B6%88%E6%81%AF%E9%98%9F%E5%88%97%E3%80%91/"/>
    
    
  </entry>
  
  <entry>
    <title>MySQLé”æœºåˆ¶</title>
    <link href="https://www.haipeng-lin.cn/posts/a7a1030b.html"/>
    <id>https://www.haipeng-lin.cn/posts/a7a1030b.html</id>
    <published>2024-09-26T06:58:22.000Z</published>
    <updated>2024-09-26T07:54:33.879Z</updated>
    
    <content type="html"><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="\assets\css\APlayer.min.css"><script src="\assets\js\APlayer.min.js" class="aplayer-secondary-script-marker"></script><h1 id="mysqlé”æœºåˆ¶"><a class="markdownIt-Anchor" href="#mysqlé”æœºåˆ¶"></a> MySQLé”æœºåˆ¶</h1><h2 id="1ä½œç”¨"><a class="markdownIt-Anchor" href="#1ä½œç”¨"></a> 1.ä½œç”¨</h2><p>MySQLçš„é”æœºåˆ¶ï¼Œç”¨äºä¿è¯æ•°æ®ä¸€è‡´æ€§å’Œå®Œæ•´æ€§</p><h2 id="2åˆ†ç±»"><a class="markdownIt-Anchor" href="#2åˆ†ç±»"></a> 2.åˆ†ç±»</h2><blockquote><p>ä»å››ä¸ªè§’åº¦åˆ†ç±»</p></blockquote><ul><li><p>é”çš„ç²’åº¦ï¼šå…¨å±€é”ã€è¡¨çº§é”ã€è¡Œçº§é”ã€é¡µçº§é”</p></li><li><p>é”çš„åŒºé—´ï¼šé—´éš™é”ã€ä¸´å»ºé”</p></li><li><p>é”çš„æ€§èƒ½ï¼šä¹è§‚é”ã€æ‚²è§‚é”</p></li><li><p>é”çš„çº§åˆ«ï¼šå…±äº«é”ï¼ˆè¯»é”ï¼‰ã€æ’ä»–é”ï¼ˆå†™é”/ç‹¬å é”ï¼‰</p></li></ul><h2 id="3æŒ‰é”çš„ç²’åº¦åˆ†"><a class="markdownIt-Anchor" href="#3æŒ‰é”çš„ç²’åº¦åˆ†"></a> 3.æŒ‰é”çš„ç²’åº¦åˆ†</h2><h3 id="31è¡Œçº§é”"><a class="markdownIt-Anchor" href="#31è¡Œçº§é”"></a> 3.1è¡Œçº§é”</h3><ul><li><p>è¡Œçº§é”æ˜¯æŒ‡å¯¹æ•°æ®åº“è¡¨ä¸­çš„<mark>æŸä¸€è¡Œæ•°æ®</mark>è¿›è¡Œé”å®šï¼Œå…¶ä»–äº‹åŠ¡å¯ä»¥è®¿é—®è¯¥è¡¨çš„å…¶ä»–è¡Œã€‚</p></li><li><p>MySQLåœ¨æ”¯æŒè¡Œçº§é”çš„å­˜å‚¨å¼•æ“ä¸­ï¼ˆå¦‚InnoDBï¼‰ä½¿ç”¨ä»¥ä¸‹å‡ ç§æ–¹å¼ï¼š</p><ul><li><p><strong>å…±äº«é”ï¼ˆSé”ï¼‰</strong>ï¼šå…è®¸å¤šä¸ªäº‹åŠ¡<mark>è¯»å–æ•°æ®</mark>ï¼Œä½†ä¸å…è®¸ä¿®æ”¹ã€‚</p></li><li><p><strong>æ’ä»–é”ï¼ˆXé”ï¼‰</strong>ï¼šå…è®¸ä¸€ä¸ªäº‹åŠ¡å¯¹æ•°æ®è¿›è¡Œä¿®æ”¹ï¼Œå…¶ä»–äº‹åŠ¡<mark>ä¸å…è®¸è¯»å–æˆ–ä¿®æ”¹</mark></p></li></ul></li><li><p>è¡Œé”ä¸»è¦é€šè¿‡ <code>SELECT ... FOR UPDATE</code> å’Œ <code>SELECT ... LOCK IN SHARE MODE</code> æ¥å®ç°</p>  <figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- å¼€å¯ä¸€ä¸ªäº‹åŠ¡</span></span><br><span class="line"><span class="keyword">START</span> TRANSACTION;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- è·å–è¡Œçº§æ’ä»–é”</span></span><br><span class="line"><span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> your_table <span class="keyword">WHERE</span> id <span class="operator">=</span> <span class="number">1</span> <span class="keyword">FOR</span> <span class="keyword">UPDATE</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- æ­¤æ—¶ï¼Œå…¶ä»–äº‹åŠ¡æ— æ³•ä¿®æ”¹å’Œè¯»å–idä¸º1çš„è¡Œ</span></span><br><span class="line"></span><br><span class="line"><span class="comment">-- æäº¤äº‹åŠ¡</span></span><br><span class="line"><span class="keyword">COMMIT</span>;</span><br></pre></td></tr></table></figure>  <figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- å¼€å¯ä¸€ä¸ªäº‹åŠ¡</span></span><br><span class="line"><span class="keyword">START</span> TRANSACTION;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- è·å–è¡Œçº§å…±äº«é”ï¼Œå…è®¸å…¶ä»–äº‹åŠ¡è¯»å–è¯¥è¡Œï¼Œä½†ä¸å…è®¸ä¿®æ”¹</span></span><br><span class="line"><span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> your_table <span class="keyword">WHERE</span> id <span class="operator">=</span> <span class="number">1</span> <span class="keyword">FOR</span> LOCK <span class="keyword">IN</span> SHARE MODE;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- æ­¤æ—¶ï¼Œå…¶ä»–äº‹åŠ¡æ— æ³•ä¿®æ”¹idä¸º1çš„è¡Œæ•°æ®ï¼Œä½†æ˜¯å¯ä»¥è¯»å–</span></span><br><span class="line"></span><br><span class="line"><span class="comment">--- æäº¤äº‹åŠ¡</span></span><br><span class="line"><span class="keyword">COMMIT</span>;</span><br></pre></td></tr></table></figure></li></ul><h3 id="32è¡¨çº§é”"><a class="markdownIt-Anchor" href="#32è¡¨çº§é”"></a> 3.2è¡¨çº§é”</h3><ul><li><p>è¡¨çº§é”åˆ™æ˜¯å¯¹æ•´ä¸ªè¡¨è¿›è¡Œé”å®šã€‚å½“ä¸€ä¸ªäº‹åŠ¡é”å®šäº†è¡¨ï¼Œå…¶ä»–äº‹åŠ¡æ— æ³•å¯¹è¯¥è¡¨è¿›è¡Œä»»ä½•æ“ä½œ</p></li><li><p>åˆ†ç±»ï¼š</p><ul><li><strong>è¯»é”</strong>ï¼šå…¶ä»–äº‹åŠ¡å¯ä»¥è¯»ï¼Œä½†ä¸èƒ½å†™ã€‚</li><li><strong>å†™é”</strong>ï¼šå…¶ä»–äº‹åŠ¡ä¸èƒ½è¯»ä¹Ÿä¸èƒ½å†™ã€‚</li></ul></li><li><p>å®ç°å§¿åŠ¿ï¼šè¡¨é”å¯ä»¥é€šè¿‡ <code>LOCK TABLES</code> å‘½ä»¤æ˜¾å¼åœ°é”å®šæ•´ä¸ªè¡¨ã€‚</p><ul><li><p>å†™é”ï¼š</p>  <figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- å¼€å¯ä¸€ä¸ªäº‹åŠ¡</span></span><br><span class="line"><span class="keyword">START</span> TRANSACTION;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- é”å®šæ•´ä¸ªè¡¨ä¸ºå†™é”</span></span><br><span class="line">LOCK TABLES your_table WRITE;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- æ‰§è¡Œä¸€äº›æ“ä½œ</span></span><br><span class="line"><span class="keyword">UPDATE</span> your_table <span class="keyword">SET</span> column_name <span class="operator">=</span> <span class="string">&#x27;value&#x27;</span> <span class="keyword">WHERE</span> <span class="keyword">condition</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- è§£é”è¡¨</span></span><br><span class="line">UNLOCK TABLES;</span><br></pre></td></tr></table></figure></li><li><p>è¯»é”ï¼š</p>  <figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- å¼€å¯ä¸€ä¸ªäº‹åŠ¡</span></span><br><span class="line"><span class="keyword">START</span> TRANSACTION;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- é”å®šæ•´ä¸ªè¡¨ä¸ºè¯»é”</span></span><br><span class="line">LOCK TABLES your_table READ;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- æ‰§è¡Œä¸€äº›è¯»å–æ“ä½œ</span></span><br><span class="line"><span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> your_table <span class="keyword">WHERE</span> <span class="keyword">condition</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- è§£é”è¡¨</span></span><br><span class="line">UNLOCK TABLES;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- æäº¤äº‹åŠ¡</span></span><br><span class="line"><span class="keyword">COMMIT</span>;</span><br></pre></td></tr></table></figure></li></ul></li></ul><h2 id="4æŒ‰é”çš„åŒºé—´åˆ†"><a class="markdownIt-Anchor" href="#4æŒ‰é”çš„åŒºé—´åˆ†"></a> 4.æŒ‰é”çš„åŒºé—´åˆ†</h2><ul><li><p>é—´éš™é”</p><ul><li>å®šä¹‰ï¼šé—´éš™é”ç”¨äº==é”å®šä¸€ä¸ªèŒƒå›´ï¼ˆå¼€åŒºé—´ï¼‰==è€Œä¸æ˜¯å•ä¸ªè¡Œã€‚å½“äº‹åŠ¡åœ¨èŒƒå›´å†…çš„ä¸€è¡Œä¸ŠæŒæœ‰é”æ—¶ï¼Œ<mark>å…¶ä»–äº‹åŠ¡æ— æ³•åœ¨è¿™ä¸ªèŒƒå›´å†…æ’å…¥æ–°çš„æ•°æ®</mark>ï¼Œä½†æ˜¯å¯ä»¥åœ¨èŒƒå›´ä¹‹å¤–æ’å…¥æ–°çš„æ•°æ®ã€‚</li><li>ä¸¾ä¾‹ï¼šå‡è®¾ä¸€ä¸ªè¡¨ä¸­çš„ç´¢å¼•åˆ—æœ‰åºä¸”ä¸é‡å¤ï¼Œäº‹åŠ¡AæŒæœ‰äº†æŸä¸ªèŒƒå›´å†…çš„é—´éš™é”ï¼Œè¿™ä¸ªèŒƒå›´å¯èƒ½æ˜¯ä¸€æ®µç´¢å¼•èŒƒå›´ï¼Œæ¯”å¦‚(10,20)ï¼Œè¿™æ—¶å…¶ä»–äº‹åŠ¡æ— æ³•åœ¨è¿™ä¸ªèŒƒå›´å†…æ’å…¥æ–°çš„è¡Œã€‚</li></ul></li><li><p>ä¸´å»ºé”</p><ul><li>å®šä¹‰ï¼šï¼šä¸´å»ºé”æ˜¯ä¸€ç§<mark>ç»“åˆäº†è¡Œé”å’Œé—´éš™é”çš„é”ç±»å‹</mark>ï¼Œå®ƒåœ¨é”å®šä¸€ä¸ªèŒƒå›´æ—¶åŒæ—¶é”å®šäº†<mark>è¯¥èŒƒå›´å†…çš„è¡Œä»¥åŠèŒƒå›´ä¹‹é—´çš„é—´éš™</mark>ã€‚</li><li>ä¸¾ä¾‹ï¼šè€ƒè™‘ä¸€ä¸ªèŒƒå›´æŸ¥è¯¢ï¼Œæ¯”å¦‚æŸ¥è¯¢ç´¢å¼•åˆ—å€¼åœ¨(10,20)ä¹‹é—´çš„è¡Œï¼Œä¸´å»ºé”ä¼šé”å®šè¿™ä¸ªèŒƒå›´å†…çš„è¡Œï¼ŒåŒæ—¶é”å®šèŒƒå›´ä¹‹é—´çš„é—´éš™ï¼Œé˜²æ­¢å…¶ä»–äº‹åŠ¡åœ¨è¿™ä¸ªèŒƒå›´å†…æ’å…¥æ–°çš„è¡Œæˆ–è€…æ”¹å˜å·²æœ‰è¡Œçš„å€¼ã€‚</li></ul></li></ul><h2 id="5æŒ‰é”çš„æ€§èƒ½åˆ†"><a class="markdownIt-Anchor" href="#5æŒ‰é”çš„æ€§èƒ½åˆ†"></a> 5.æŒ‰é”çš„æ€§èƒ½åˆ†</h2><ul><li><p>ä¹è§‚é”ï¼š</p><ul><li><p>å®šä¹‰ï¼šä¹è§‚é”è®¤ä¸ºæ•°æ®åœ¨è¢«æ“ä½œæ—¶å¾ˆå°‘å‘ç”Ÿå†²çªï¼Œå› æ­¤åœ¨è®¿é—®æ•°æ®æ—¶ä¸ä¼šç«‹å³åŠ é”ï¼Œ<mark>è€Œæ˜¯åœ¨æ›´æ–°æ•°æ®æ—¶æ£€æŸ¥æ•°æ®æ˜¯å¦è¢«å…¶ä»–äº‹åŠ¡ä¿®æ”¹è¿‡</mark>ï¼Œå¦‚æœæ²¡æœ‰åˆ™æ›´æ–°æˆåŠŸï¼Œå¦åˆ™è¿›è¡Œå›æ»šæˆ–è€…é‡è¯•ã€‚</p></li><li><p>ä¸¾ä¾‹ï¼šåœ¨MySQLä¸­ï¼Œå¯ä»¥ä½¿ç”¨ä¹è§‚é”çš„æ–¹å¼æ˜¯åœ¨æ›´æ–°æ•°æ®æ—¶<mark>æ£€æŸ¥æ•°æ®çš„ç‰ˆæœ¬å·æˆ–è€…æ—¶é—´æˆ³</mark>æ˜¯å¦ä¸å½“å‰æ“ä½œä¸€è‡´</p>  <figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">UPDATE</span> table_name </span><br><span class="line"><span class="keyword">SET</span> column1 <span class="operator">=</span> value1, version <span class="operator">=</span> new_version <span class="keyword">WHERE</span> id <span class="operator">=</span> x <span class="keyword">AND</span> version <span class="operator">=</span> old_version;</span><br></pre></td></tr></table></figure></li></ul></li><li><p>æ‚²è§‚é”ï¼š</p><ul><li><p>å®šä¹‰ï¼šæ‚²è§‚é”è®¤ä¸ºæ•°æ®åœ¨è¢«æ“ä½œæ—¶ä¼šå‘ç”Ÿå†²çªï¼Œå› æ­¤<mark>åœ¨è®¿é—®æ•°æ®ä¹‹å‰ä¼šå…ˆåŠ é”ï¼Œç¡®ä¿å…¶ä»–äº‹åŠ¡æ— æ³•ä¿®æ”¹è¯¥æ•°æ®</mark>ï¼Œç›´åˆ°å½“å‰äº‹åŠ¡å®Œæˆæ“ä½œå¹¶é‡Šæ”¾é”ã€‚</p></li><li><p>ä¸¾ä¾‹ï¼šåœ¨MySQLä¸­ï¼Œå¯ä»¥ä½¿ç”¨SELECT â€¦ FOR UPDATEè¯­å¥æ¥è·å–æ‚²è§‚é”ï¼Œä¾‹å¦‚</p>  <figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> <span class="operator">*</span> </span><br><span class="line"><span class="keyword">FROM</span> table_name </span><br><span class="line"><span class="keyword">WHERE</span> <span class="keyword">condition</span> </span><br><span class="line"><span class="keyword">FOR</span> <span class="keyword">UPDATE</span>;</span><br></pre></td></tr></table></figure></li></ul></li></ul><h2 id="6æŒ‰é”çš„çº§åˆ«åˆ†"><a class="markdownIt-Anchor" href="#6æŒ‰é”çš„çº§åˆ«åˆ†"></a> 6.æŒ‰é”çš„çº§åˆ«åˆ†</h2><ul><li><p>å…±äº«é”ï¼š</p><ul><li><p>å®šä¹‰ï¼šå…±äº«é”å…è®¸<mark>å¤šä¸ªäº‹åŠ¡åŒæ—¶è¯»å–åŒä¸€è¡Œæ•°æ®</mark>ï¼Œä½†é˜»æ­¢å…¶ä»–äº‹åŠ¡åœ¨è¯¥è¡Œä¸Šè·å–æ’ä»–é”ï¼›</p></li><li><p>ä¸¾ä¾‹ï¼šåœ¨ MySQL ä¸­ï¼Œå¯ä»¥ä½¿ç”¨ <code>SELECT ... LOCK IN SHARE MODE</code> æˆ–è€… <code>SELECT ... FOR SHARE</code> æ¥è·å–å…±äº«é”ï¼Œä¾‹å¦‚</p>  <figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> <span class="operator">*</span> </span><br><span class="line"><span class="keyword">FROM</span> table_name </span><br><span class="line"><span class="keyword">WHERE</span> <span class="keyword">condition</span> </span><br><span class="line">LOCK <span class="keyword">IN</span> SHARE MODE;</span><br></pre></td></tr></table></figure></li></ul></li><li><p>æ’ä»–é”ï¼š</p><ul><li><p>å®šä¹‰ï¼šæ’ä»–é”ï¼ˆä¹Ÿç§°ä¸ºå†™é”ï¼‰<mark>é˜»æ­¢å…¶ä»–äº‹åŠ¡å¯¹åŒä¸€è¡Œæ•°æ®è¿›è¡Œè¯»å–æˆ–å†™å…¥æ“ä½œ</mark>ï¼Œåªæœ‰<mark>è·å–äº†æ’ä»–é”çš„äº‹åŠ¡æ‰èƒ½å¯¹æ•°æ®è¿›è¡Œä¿®æ”¹</mark>ã€‚</p></li><li><p>ä¸¾ä¾‹ï¼šåœ¨ MySQL ä¸­ï¼Œå¯ä»¥ä½¿ç”¨ <code>SELECT ... FOR UPDATE</code> æ¥è·å–æ’ä»–é”ï¼Œä¾‹å¦‚</p>  <figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> <span class="operator">*</span> </span><br><span class="line"><span class="keyword">FROM</span> table_name </span><br><span class="line"><span class="keyword">WHERE</span> <span class="keyword">condition</span> </span><br><span class="line"><span class="keyword">FOR</span> <span class="keyword">UPDATE</span>;</span><br></pre></td></tr></table></figure></li></ul></li></ul><h2 id="7æ‹“å±•æ„å‘é”"><a class="markdownIt-Anchor" href="#7æ‹“å±•æ„å‘é”"></a> 7.æ‹“å±•ï¼šæ„å‘é”</h2><h3 id="71æ„å‘é”æ¦‚è¿°"><a class="markdownIt-Anchor" href="#71æ„å‘é”æ¦‚è¿°"></a> 7.1æ„å‘é”æ¦‚è¿°</h3><p>MySQL ä¸­çš„æ„å‘é”ï¼ˆIntention Lockï¼‰æ˜¯ä¸€ç§ç”¨äº<mark>ç®¡ç†è¡¨çº§é”çš„é”æœºåˆ¶</mark>ï¼Œç”¨äº<mark>åœ¨è¡¨çº§åˆ«ä¸ŠæŒ‡ç¤ºäº‹åŠ¡å°†è¦åœ¨è¡¨çš„å“ªäº›è¡Œä¸Šè·å–é”</mark>ã€‚</p><p>æ„å‘é”å¹¶ä¸æ˜¯å®é™…çš„é”ï¼Œè€Œæ˜¯ä¸€ç§æŒ‡ç¤ºï¼Œé€šå¸¸ç”¨äºåè°ƒäº‹åŠ¡å¯¹è¡¨çº§é”çš„è·å–ï¼Œä»¥æé«˜å¹¶å‘æ€§èƒ½å’Œé™ä½æ­»é”çš„é£é™©ã€‚</p><h3 id="72æ„å‘é”åˆ†ç±»"><a class="markdownIt-Anchor" href="#72æ„å‘é”åˆ†ç±»"></a> 7.2æ„å‘é”åˆ†ç±»</h3><p>å¯åˆ†ä¸ºä¸¤ç§ç±»å‹ï¼šæ„å‘å…±äº«é”å’Œæ„å‘æ’ä»–é”</p><ul><li><p>æ„å‘å…±äº«é”ï¼ˆIntention Share Lockï¼‰ï¼š</p><ul><li>ç‰¹ç‚¹ï¼šè¡¨æ˜äº‹åŠ¡å°†è¦åœ¨è¡¨çš„æŸäº›è¡Œä¸Šè·å–å…±äº«é”ã€‚å½“ä¸€ä¸ªäº‹åŠ¡æ‰“ç®—è·å–æŸè¡Œçš„å…±äº«é”æ—¶ï¼Œä¼š<mark>åœ¨è¡¨çº§åˆ«è¯·æ±‚æ„å‘å…±äº«é”</mark>ã€‚</li><li>ä½œç”¨ï¼šæ„å‘å…±äº«é”æ˜¯ä¸ºäº†åè°ƒå¤šä¸ªäº‹åŠ¡åŒæ—¶è·å–å…±äº«é”è€Œå¼•å…¥çš„ï¼Œåœ¨è·å–å…±äº«é”ä¹‹å‰ï¼Œ<mark>éœ€è¦å…ˆæ£€æŸ¥æ˜¯å¦å­˜åœ¨æ’ä»–é”ï¼Œä»¥é˜²æ­¢ä¸å…¶ä»–äº‹åŠ¡çš„æ’ä»–é”å†²çª</mark>ã€‚</li></ul></li><li><p>æ„å‘æ’ä»–é”ï¼ˆIntention Exclusive Lockï¼‰ï¼š</p><ul><li>ç‰¹ç‚¹ï¼šè¡¨æ˜äº‹åŠ¡å°†è¦åœ¨è¡¨çš„æŸäº›è¡Œä¸Šè·å–æ’ä»–é”ã€‚å½“ä¸€ä¸ªäº‹åŠ¡æ‰“ç®—è·å–æŸè¡Œçš„æ’ä»–é”æ—¶ï¼Œä¼š<mark>åœ¨è¡¨çº§åˆ«è¯·æ±‚æ„å‘æ’ä»–é”</mark>ã€‚</li><li>ä½œç”¨ï¼šæ„å‘æ’ä»–é”æ˜¯ä¸ºäº†åè°ƒå¤šä¸ªäº‹åŠ¡åŒæ—¶è·å–æ’ä»–é”è€Œå¼•å…¥çš„ï¼Œåœ¨è·å–æ’ä»–é”ä¹‹å‰ï¼Œ<mark>éœ€è¦å…ˆæ£€æŸ¥æ˜¯å¦å­˜åœ¨å…±äº«é”æˆ–å…¶ä»–äº‹åŠ¡çš„æ’ä»–é”ï¼Œä»¥é˜²æ­¢ä¸å…¶ä»–äº‹åŠ¡çš„å…±äº«é”æˆ–æ’ä»–é”å†²çª</mark>ã€‚</li></ul></li></ul><h3 id="73æ„å‘é”ä½œç”¨"><a class="markdownIt-Anchor" href="#73æ„å‘é”ä½œç”¨"></a> 7.3æ„å‘é”ä½œç”¨</h3><p>æ²¡æœ‰æ„å‘é”æ—¶ï¼Œ<mark>äº‹åŠ¡åœ¨è·å–è¡¨çº§é”/è¡Œçº§é”ä¹‹å‰å¯èƒ½éœ€è¦é¢‘ç¹åœ°æ£€æŸ¥æ•´ä¸ªè¡¨</mark>ï¼Œä»¥ç¡®å®šæ˜¯å¦æœ‰å…¶ä»–äº‹åŠ¡å·²ç»æŒæœ‰äº†æ’ä»–é”æˆ–å…±äº«é”ã€‚è¿™ä¼šå¢åŠ ç³»ç»Ÿçš„å¼€é”€ï¼Œé™ä½å¹¶å‘æ€§èƒ½ã€‚</p><p>ä¸¾ä¾‹ï¼š</p><p>äº‹åŠ¡ A è·å–äº†æŸä¸€è¡Œçš„æ’ä»–é”ï¼Œå¹¶æœªæäº¤ï¼š</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> users <span class="keyword">WHERE</span> id <span class="operator">=</span> <span class="number">6</span> <span class="keyword">FOR</span> <span class="keyword">UPDATE</span>;</span><br></pre></td></tr></table></figure><p>äº‹åŠ¡ B æƒ³è¦è·å– <code>users</code> è¡¨çš„è¡¨é”ï¼ˆå…±äº«é”ï¼‰/è¡Œçº§é”ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">LOCK TABLES users READ;</span><br></pre></td></tr></table></figure><p>å› ä¸ºå…±äº«é”ä¸æ’ä»–é”<code>äº’æ–¥</code>ï¼Œæ‰€ä»¥äº‹åŠ¡ B åœ¨è§†å›¾å¯¹ <code>users</code> è¡¨åŠ å…±äº«é”çš„æ—¶å€™ï¼Œå¿…é¡»ä¿è¯ï¼š</p><ul><li>å½“å‰æ²¡æœ‰å…¶ä»–äº‹åŠ¡æŒæœ‰ users è¡¨çš„æ’ä»–é”ã€‚</li><li><mark>å½“å‰æ²¡æœ‰å…¶ä»–äº‹åŠ¡æŒæœ‰ users è¡¨ä¸­ä»»æ„ä¸€è¡Œçš„æ’ä»–é”</mark> ã€‚</li></ul><p>ä¸ºäº†æ£€æµ‹æ˜¯å¦æ»¡è¶³ç¬¬äºŒä¸ªæ¡ä»¶ï¼Œäº‹åŠ¡ B å¿…é¡»åœ¨ç¡®ä¿ <code>users</code>è¡¨ä¸å­˜åœ¨ä»»ä½•æ’ä»–é”çš„å‰æä¸‹ï¼Œ<mark>å»æ£€æµ‹è¡¨ä¸­çš„æ¯ä¸€è¡Œæ˜¯å¦å­˜åœ¨æ’ä»–é”</mark>ã€‚</p><p>å¾ˆæ˜æ˜¾è¿™æ˜¯ä¸€ä¸ªæ•ˆç‡å¾ˆå·®çš„åšæ³•ï¼Œä½†æ˜¯æœ‰äº†<strong>æ„å‘é”</strong>ä¹‹åï¼Œæƒ…å†µå°±ä¸ä¸€æ ·äº†ï¼š</p><h4 id="731æ„å‘é”çš„å…¼å®¹äº’æ–¥æ€§"><a class="markdownIt-Anchor" href="#731æ„å‘é”çš„å…¼å®¹äº’æ–¥æ€§"></a> 7.3.1æ„å‘é”çš„å…¼å®¹äº’æ–¥æ€§</h4><blockquote><p>ç‰¹ç‚¹ï¼š<mark>å¤šä¸ªäº‹åŠ¡å¯ä»¥å¯¹åŒä¸€å¼ è¡¨å¤šä¸ªæ„å‘æ’ä»–é”</mark></p></blockquote><table><thead><tr><th style="text-align:center"></th><th style="text-align:center">æ„å‘å…±äº«é”ï¼ˆISï¼‰</th><th style="text-align:center">æ„å‘æ’ä»–é”ï¼ˆIXï¼‰</th></tr></thead><tbody><tr><td style="text-align:center"><strong>æ„å‘å…±äº«é”ï¼ˆISï¼‰</strong></td><td style="text-align:center">å…¼å®¹</td><td style="text-align:center">å…¼å®¹</td></tr><tr><td style="text-align:center"><strong>æ„å‘æ’ä»–é”ï¼ˆIXï¼‰</strong></td><td style="text-align:center">å…¼å®¹</td><td style="text-align:center">å…¼å®¹</td></tr></tbody></table><p>å³<strong>æ„å‘é”ä¹‹é—´æ˜¯äº’ç›¸å…¼å®¹çš„</strong>ï¼Œè™½ç„¶æ„å‘é”å’Œè‡ªå®¶å…„å¼Ÿäº’ç›¸å…¼å®¹ï¼Œ<mark>ä½†æ˜¯å®ƒä¼šä¸æ™®é€šçš„<strong>æ’ä»– / å…±äº«é”</strong>äº’æ–¥</mark>ï¼š</p><table><thead><tr><th style="text-align:center"></th><th style="text-align:center">æ„å‘å…±äº«é”ï¼ˆISï¼‰</th><th style="text-align:center">æ„å‘æ’ä»–é”ï¼ˆIXï¼‰</th></tr></thead><tbody><tr><td style="text-align:center"><strong>å…±äº«é”ï¼ˆSï¼‰</strong></td><td style="text-align:center"><mark>å…¼å®¹</mark></td><td style="text-align:center">äº’æ–¥</td></tr><tr><td style="text-align:center"><strong>æ’ä»–é”ï¼ˆXï¼‰</strong></td><td style="text-align:center">äº’æ–¥</td><td style="text-align:center">äº’æ–¥</td></tr></tbody></table><p><strong>æ³¨æ„ï¼š<mark>è¿™é‡Œçš„æ’ä»– / å…±äº«é”æŒ‡çš„éƒ½æ˜¯è¡¨é”ï¼ï¼ï¼</mark></strong></p><p><strong>æ„å‘é”ä¸ä¼šä¸è¡Œçº§çš„å…±äº« / æ’ä»–é”äº’æ–¥ï¼ï¼ï¼</strong></p><h4 id="732ä¾‹å­1æ„å‘é”å’Œè¡¨çº§çš„å…±äº«æ’ä»–é”äº’æ–¥"><a class="markdownIt-Anchor" href="#732ä¾‹å­1æ„å‘é”å’Œè¡¨çº§çš„å…±äº«æ’ä»–é”äº’æ–¥"></a> 7.3.2ä¾‹å­1ï¼ˆæ„å‘é”å’Œè¡¨çº§çš„å…±äº«/æ’ä»–é”äº’æ–¥ï¼‰</h4><p>å›åˆ°åˆšæ‰ <code>users</code> è¡¨çš„ä¾‹å­ï¼š</p><p>äº‹åŠ¡ A è·å–äº†æŸä¸€è¡Œçš„æ’ä»–é”ï¼Œå¹¶æœªæäº¤ï¼š</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> users <span class="keyword">WHERE</span> id <span class="operator">=</span> <span class="number">6</span> <span class="keyword">FOR</span> <span class="keyword">UPDATE</span>;</span><br></pre></td></tr></table></figure><ul><li>æ­¤æ—¶ <code>users</code> è¡¨å­˜åœ¨ä¸¤æŠŠé”ï¼š<mark><code>users</code> è¡¨ä¸Šçš„<strong>æ„å‘æ’ä»–é”</strong>ä¸ id ä¸º 6 çš„æ•°æ®è¡Œä¸Šçš„<strong>æ’ä»–é”</strong></mark>ã€‚</li></ul><p>äº‹åŠ¡ B æƒ³è¦è·å– <code>users</code> è¡¨çš„è¡¨é”ï¼ˆå…±äº«é”ï¼‰ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">LOCK TABLES users READ;</span><br></pre></td></tr></table></figure><ul><li>æ­¤æ—¶<code>äº‹åŠ¡ B</code> æ£€æµ‹äº‹åŠ¡ A æŒæœ‰ <code>users</code> è¡¨çš„<strong>æ„å‘æ’ä»–é”</strong>ï¼Œå°±å¯ä»¥<mark>å¾—çŸ¥<code>äº‹åŠ¡ A</code> å¿…ç„¶æŒæœ‰è¯¥è¡¨ä¸­æŸäº›æ•°æ®è¡Œçš„<strong>æ’ä»–é”</strong></mark>ï¼Œ</li><li>ä¹ˆ<code>äº‹åŠ¡ B</code> å¯¹ <code>users</code> è¡¨çš„åŠ é”è¯·æ±‚å°±ä¼šè¢«æ’æ–¥ï¼ˆé˜»å¡ï¼‰ï¼Œè€Œ<mark>æ— éœ€å»æ£€æµ‹è¡¨ä¸­çš„æ¯ä¸€è¡Œæ•°æ®æ˜¯å¦å­˜åœ¨æ’ä»–é”</mark>ã€‚</li></ul><h4 id="733ä¾‹å­2æ„å‘é”å’Œè¡Œçº§çš„å…±äº«é”æ’ä»–é”å…¼å®¹"><a class="markdownIt-Anchor" href="#733ä¾‹å­2æ„å‘é”å’Œè¡Œçº§çš„å…±äº«é”æ’ä»–é”å…¼å®¹"></a> 7.3.3ä¾‹å­2ï¼ˆæ„å‘é”å’Œè¡Œçº§çš„å…±äº«é”/æ’ä»–é”å…¼å®¹ï¼‰</h4><ul><li>æ„å‘é”å¹¶ä¸ä¼šå½±å“åˆ°å¤šä¸ªäº‹åŠ¡å¯¹ä¸åŒæ•°æ®è¡ŒåŠ æ’ä»–é”æ—¶çš„å¹¶å‘æ€§</li></ul><p>äº‹åŠ¡ A è·å–äº†æŸä¸€è¡Œçš„æ’ä»–é”ï¼Œå¹¶æœªæäº¤ï¼š</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> users <span class="keyword">WHERE</span> id <span class="operator">=</span> <span class="number">6</span> <span class="keyword">FOR</span> <span class="keyword">UPDATE</span>;</span><br></pre></td></tr></table></figure><ul><li>æ­¤æ—¶ <code>users</code> è¡¨å­˜åœ¨ä¸¤æŠŠé”ï¼š<ul><li><mark><code>users</code> è¡¨ä¸Šçš„<strong>æ„å‘æ’ä»–é”</strong></mark></li><li><mark>id ä¸º 6 çš„æ•°æ®è¡Œä¸Šçš„<strong>æ’ä»–é”</strong></mark>ã€‚</li></ul></li></ul><p>äº‹åŠ¡ B æƒ³è¦è·å– <code>users</code> è¡¨çš„è¡¨é”ï¼ˆå…±äº«é”ï¼‰ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">LOCK TABLES users READ;</span><br></pre></td></tr></table></figure><ul><li>æ­¤æ—¶<code>äº‹åŠ¡ B</code> æ£€æµ‹äº‹åŠ¡ A æŒæœ‰ <code>users</code> è¡¨çš„<strong>æ„å‘æ’ä»–é”</strong>ï¼Œå°±å¯ä»¥<mark>å¾—çŸ¥<code>äº‹åŠ¡ A</code> å¿…ç„¶æŒæœ‰è¯¥è¡¨ä¸­æŸäº›æ•°æ®è¡Œçš„<strong>æ’ä»–é”</strong></mark>ï¼Œ</li><li>ä¹ˆ<code>äº‹åŠ¡ B</code> å¯¹ <code>users</code> è¡¨çš„åŠ é”è¯·æ±‚å°±ä¼šè¢«æ’æ–¥ï¼ˆé˜»å¡ï¼‰ï¼Œè€Œ<mark>æ— éœ€å»æ£€æµ‹è¡¨ä¸­çš„æ¯ä¸€è¡Œæ•°æ®æ˜¯å¦å­˜åœ¨æ’ä»–é”</mark>ã€‚</li></ul><p>æœ€å<code>äº‹åŠ¡ C</code> ä¹Ÿæƒ³è·å– <code>users</code> è¡¨ä¸­æŸä¸€è¡Œçš„<strong>æ’ä»–é”</strong>ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">SELECT * FROM users WHERE id = 5 FOR UPDATE;</span><br></pre></td></tr></table></figure><ol><li><code>äº‹åŠ¡ C</code> ç”³è¯· <code>users</code> è¡¨çš„<strong>æ„å‘æ’ä»–é”</strong>ã€‚</li><li><code>äº‹åŠ¡ C</code> æ£€æµ‹åˆ°<code>äº‹åŠ¡ A</code> æŒæœ‰ <code>users</code> è¡¨çš„<strong>æ„å‘æ’ä»–é”</strong>ã€‚</li><li>å› ä¸ºæ„å‘é”ä¹‹é—´å¹¶ä¸äº’æ–¥ï¼Œæ‰€ä»¥==<code>äº‹åŠ¡ C</code> è·å–åˆ°äº† <code>users</code> è¡¨çš„<strong>æ„å‘æ’ä»–é”</strong>==ã€‚</li><li>å› ä¸ºid ä¸º 5 çš„æ•°æ®è¡Œä¸Šä¸å­˜åœ¨ä»»ä½•<strong>æ’ä»–é”</strong>ï¼Œæœ€ç»ˆ<code>äº‹åŠ¡ C</code> æˆåŠŸè·å–åˆ°äº†è¯¥æ•°æ®è¡Œä¸Šçš„<strong>æ’ä»–é”</strong>ã€‚</li></ol><h3 id="74å°ç»“"><a class="markdownIt-Anchor" href="#74å°ç»“"></a> 7.4å°ç»“</h3><blockquote><p>æ„å‘é”çš„å¼•å…¥ä¸»è¦æ˜¯ä¸ºäº†æé«˜å¹¶å‘æ€§èƒ½ã€‚<strong>é€šè¿‡å¼•å…¥æ„å‘é”ï¼ŒMySQL å¯ä»¥<mark>æ›´æœ‰æ•ˆåœ°ç®¡ç†è¡¨çº§é”</mark>ï¼Œå‡<mark>å°‘äº†åœ¨å¹¶å‘ç¯å¢ƒä¸‹çš„é”å†²çª</mark>ï¼Œä»è€Œæé«˜äº†ç³»ç»Ÿçš„å¹¶å‘å¤„ç†èƒ½åŠ›ã€‚</strong></p><p>åœ¨æ²¡æœ‰æ„å‘é”ä¹‹å‰ï¼Œ<mark>å¦‚æœä¸€å¼ è¡¨é‡Œé¢å·²ç»æœ‰è¡Œé”äº†</mark>ï¼Œ<mark>æ­¤æ—¶æˆ‘ä»¬å†æ·»åŠ è¡¨é”</mark>ï¼Œä¸ºäº†é˜²æ­¢è¡¨é”å’Œè¡Œé”å‘ç”Ÿå†²çªï¼Œ<mark>è¡¨é”å°±éœ€è¦éå†æ•´ä¸ªè¡¨ä¸­çš„æ•°æ®æ£€æŸ¥æ˜¯å¦æœ‰è¡Œé”</mark>ã€‚ä¸ºäº†ä¼˜åŒ–è¡¨é”æ£€ç´¢è¡Œé”çš„è¿‡ç¨‹ï¼Œæˆ‘ä»¬å¼•å…¥æ„å‘é”ã€‚</p></blockquote>]]></content>
    
    
      
      
    <summary type="html">&lt;link rel=&quot;stylesheet&quot; class=&quot;aplayer-secondary-style-marker&quot; href=&quot;&#92;assets&#92;css&#92;APlayer.min.css&quot;&gt;&lt;script src=&quot;&#92;assets&#92;js&#92;APlayer.min.js&quot; cla</summary>
      
    
    
    
    <category term="ã€MySQLã€‘" scheme="https://www.haipeng-lin.cn/categories/%E3%80%90MySQL%E3%80%91/"/>
    
    
  </entry>
  
  <entry>
    <title>MySQLä¸‰å¤§æ—¥å¿—æ–‡ä»¶</title>
    <link href="https://www.haipeng-lin.cn/posts/f8d0a55c.html"/>
    <id>https://www.haipeng-lin.cn/posts/f8d0a55c.html</id>
    <published>2024-09-21T08:42:03.000Z</published>
    <updated>2024-09-21T08:53:19.990Z</updated>
    
    <content type="html"><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="\assets\css\APlayer.min.css"><script src="\assets\js\APlayer.min.js" class="aplayer-secondary-script-marker"></script><h1 id="2mysqlä¸‰å¤§æ—¥å¿—æ–‡ä»¶"><a class="markdownIt-Anchor" href="#2mysqlä¸‰å¤§æ—¥å¿—æ–‡ä»¶"></a> 2.MySQLä¸‰å¤§æ—¥å¿—æ–‡ä»¶</h1><h2 id="21æ—¥å¿—æ–‡ä»¶åˆ—è¡¨"><a class="markdownIt-Anchor" href="#21æ—¥å¿—æ–‡ä»¶åˆ—è¡¨"></a> 2.1æ—¥å¿—æ–‡ä»¶åˆ—è¡¨</h2><ol><li><mark><strong>redo logï¼šé‡åšæ—¥å¿—</strong></mark>ï¼Œè®°å½•äº†å¯¹äº InnoDB è¡¨çš„æ¯ä¸ªå†™æ“ä½œï¼Œä¸æ˜¯ SQL çº§åˆ«çš„ï¼Œè€Œæ˜¯ç‰©ç†çº§åˆ«çš„ï¼Œä¸»è¦ç”¨äºå´©æºƒæ¢å¤</li><li><mark><strong>undo logï¼šå›æ»šæ—¥å¿—</strong></mark>ï¼Œè®°å½•æ•°æ®è¢«ä¿®æ”¹å‰çš„å€¼ï¼Œç”¨äºäº‹åŠ¡çš„å›æ»š</li><li><mark><strong>bin logï¼šäºŒè¿›åˆ¶æ—¥å¿—</strong></mark>ï¼Œè®°å½•äº†æ‰€æœ‰ä¿®æ”¹æ•°æ®åº“çŠ¶æ€çš„ SQL è¯­å¥ï¼Œä»¥åŠæ¯ä¸ªè¯­å¥çš„æ‰§è¡Œæ—¶é—´ï¼Œå¦‚ INSERTã€UPDATEã€DELETE ç­‰ï¼Œä½†ä¸åŒ…æ‹¬ SELECT å’Œ SHOW è¿™ç±»çš„æ“ä½œ</li><li><mark><strong>slow query logï¼šæ…¢æŸ¥è¯¢æ—¥å¿—</strong></mark>ï¼Œè®°å½•æ‰§è¡Œæ—¶é—´è¶…è¿‡ long_query_time å€¼çš„æ‰€æœ‰ SQL è¯­å¥ã€‚è¿™ä¸ªæ—¶é—´å€¼æ˜¯å¯é…ç½®çš„ï¼Œé»˜è®¤æƒ…å†µä¸‹ï¼Œæ…¢æŸ¥è¯¢æ—¥å¿—åŠŸèƒ½æ˜¯å…³é—­çš„ã€‚å¯ä»¥ç”¨æ¥è¯†åˆ«å’Œä¼˜åŒ–æ…¢ SQL</li><li><mark><strong>error logï¼šé”™è¯¯æ—¥å¿—</strong></mark>ï¼Œè®°å½• MySQL æœåŠ¡å™¨å¯åŠ¨ã€è¿è¡Œæˆ–åœæ­¢æ—¶å‡ºç°çš„é—®é¢˜</li></ol><h3 id="211-redo-log"><a class="markdownIt-Anchor" href="#211-redo-log"></a> 2.1.1 redo log</h3><ol><li>redo logï¼Œé‡åšæ—¥å¿—</li><li><strong>å†…å®¹ï¼š</strong> ç‰©ç†æ ¼å¼çš„æ—¥å¿—ï¼Œè®°å½•çš„æ˜¯ç‰©ç†æ•°æ®é¡µé¢çš„ä¿®æ”¹çš„ä¿¡æ¯ï¼Œå…¶ redo log æ˜¯é¡ºåºå†™å…¥ redo log file çš„ç‰©ç†æ–‡ä»¶ä¸­å»çš„</li><li><strong>ä½œç”¨ï¼š</strong> ç¡®ä¿äº‹åŠ¡çš„æŒä¹…æ€§ã€‚é˜²æ­¢åœ¨å‘ç”Ÿæ•…éšœçš„æ—¶é—´ç‚¹ï¼Œå°šæœ‰è„é¡µæœªå†™å…¥ç£ç›˜ï¼Œåœ¨é‡å¯ mysql æœåŠ¡çš„æ—¶å€™ï¼Œæ ¹æ® redo log è¿›è¡Œé‡åšï¼Œä»è€Œè¾¾åˆ°äº‹åŠ¡çš„æŒä¹…æ€§è¿™ä¸€ç‰¹æ€§</li></ol><h3 id="212-bin-log"><a class="markdownIt-Anchor" href="#212-bin-log"></a> 2.1.2 bin log</h3><ol><li>bin logï¼ŒäºŒè¿›åˆ¶æ—¥å¿—</li><li><strong>å†…å®¹ï¼š</strong> æ‰€æœ‰æ‰§è¡Œå¢åˆ æ”¹çš„SQL è¯­å¥ï¼Œä»¥åŠæ¯ä¸ªè¯­å¥çš„æ‰§è¡Œæ—¶é—´ï¼Œä»¥ä¾¿è¿›è¡Œæ•°æ®æ¢å¤å’Œä¸»ä»å¤åˆ¶</li><li><strong>ä½œç”¨ï¼š</strong> ç”¨äºå¤åˆ¶ï¼Œåœ¨ä¸»ä»å¤åˆ¶ä¸­ï¼Œä»åº“åˆ©ç”¨ä¸»åº“ä¸Šçš„ binlog è¿›è¡Œé‡æ’­ï¼Œå®ç°ä¸»ä»åŒæ­¥ã€‚ ç”¨äºæ•°æ®åº“çš„åŸºäºæ—¶é—´ç‚¹çš„è¿˜åŸ</li></ol><h3 id="213-undo-log"><a class="markdownIt-Anchor" href="#213-undo-log"></a> 2.1.3 undo log</h3><ol><li>undo logï¼Œå›æ»šæ—¥å¿—</li><li><strong>å†…å®¹ï¼š</strong> é€»è¾‘æ ¼å¼çš„æ—¥å¿—ï¼Œåœ¨æ‰§è¡Œ undo çš„æ—¶å€™ï¼Œä»…ä»…æ˜¯å°†æ•°æ®ä»é€»è¾‘ä¸Šæ¢å¤è‡³äº‹åŠ¡ä¹‹å‰çš„çŠ¶æ€ï¼Œè€Œä¸æ˜¯ä»ç‰©ç†é¡µé¢ä¸Šæ“ä½œå®ç°çš„ï¼Œè¿™ä¸€ç‚¹æ˜¯ä¸åŒäº redo log çš„</li><li><strong>ä½œç”¨ï¼š</strong> ä¿å­˜äº†äº‹åŠ¡å‘ç”Ÿä¹‹å‰çš„æ•°æ®çš„ä¸€ä¸ªç‰ˆæœ¬ï¼Œå¯ä»¥ç”¨äºå›æ»šï¼ŒåŒæ—¶å¯ä»¥æä¾›å¤šç‰ˆæœ¬å¹¶å‘æ§åˆ¶ä¸‹çš„è¯»ï¼ˆMVCCï¼‰ï¼Œä¹Ÿå³éé”å®šè¯»</li></ol><h2 id="22redo-logæ—¥å¿—è¯¦è®²"><a class="markdownIt-Anchor" href="#22redo-logæ—¥å¿—è¯¦è®²"></a> 2.2redo logæ—¥å¿—è¯¦è®²</h2><ol><li>åŸå› ï¼šmysqlï¼Œå¦‚æœæ¯æ¬¡æ›´æ–°æ“ä½œéƒ½è¦å†™è¿›ç£ç›˜ï¼Œç„¶åç£ç›˜è¦æ‰¾åˆ°å¯¹åº”è®°å½•ï¼Œç„¶åå†æ›´ç»†ï¼Œæ•´ä¸ªè¿‡ç¨‹ io æˆæœ¬ã€æŸ¥æ‰¾æˆæœ¬éƒ½å¾ˆé«˜</li><li>è§£å†³æ–¹æ¡ˆï¼šWAL æŠ€æœ¯ï¼ˆWrite-Ahead Loggingï¼‰ã€‚å…ˆå†™æ—¥å¿—ï¼Œå†å†™ç£ç›˜</li><li>å…·ä½“è¿‡ç¨‹ï¼š<ol><li>å½“æœ‰ä¸€æ¡è®°å½•éœ€è¦æ›´æ–°çš„æ—¶å€™ï¼ŒInnoDB å¼•æ“å°±ä¼šå…ˆæŠŠè®°å½•å†™åˆ° redo log é‡Œé¢ï¼Œå¹¶æ›´æ–°å†…å­˜ï¼Œè¿™ä¸ªæ—¶å€™æ›´æ–°å°±ç®—å®Œæˆäº†ã€‚</li><li>åŒæ—¶ï¼ŒInnoDB å¼•æ“ä¼šåœ¨é€‚å½“çš„æ—¶å€™ï¼Œå°†è¿™ä¸ªæ“ä½œè®°å½•æ›´æ–°åˆ°ç£ç›˜é‡Œé¢ï¼Œè€Œè¿™ä¸ªæ›´æ–°å¾€å¾€æ˜¯åœ¨ç³»ç»Ÿæ¯”è¾ƒç©ºé—²çš„æ—¶å€™åšã€‚</li><li>InnoDB çš„ redo log æ˜¯å›ºå®šå¤§å°çš„ï¼Œæ¯”å¦‚å¯ä»¥é…ç½®ä¸ºä¸€ç»„ 4 ä¸ªæ–‡ä»¶ï¼Œæ¯ä¸ªæ–‡ä»¶çš„å¤§å°æ˜¯ 1GBï¼Œé‚£ä¹ˆæ€»å…±å°±å¯ä»¥è®°å½• 4GB çš„æ“ä½œã€‚ä»å¤´å¼€å§‹å†™ï¼Œå†™åˆ°æœ«å°¾å°±åˆå›åˆ°å¼€å¤´å¾ªç¯å†™</li></ol></li></ol><h2 id="23-binglogå’Œredo-logæœ‰ä»€ä¹ˆåŒºåˆ«"><a class="markdownIt-Anchor" href="#23-binglogå’Œredo-logæœ‰ä»€ä¹ˆåŒºåˆ«"></a> 2.3 binglogå’Œredo logæœ‰ä»€ä¹ˆåŒºåˆ«ï¼Ÿ</h2><ol><li><strong><mark>æ–‡ä»¶çº§åˆ«ä¸åŒï¼š</mark></strong><ol><li>redo log æ˜¯ InnoDB å¼•æ“ç‰¹æœ‰çš„</li><li>binlog æ˜¯ MySQL çš„ Server å±‚å®ç°çš„ï¼Œæ‰€æœ‰å¼•æ“éƒ½å¯ä»¥ä½¿ç”¨</li></ol></li><li><strong><mark>æ–‡ä»¶å†…å®¹ä¸åŒï¼š</mark></strong><ol><li>redo log æ˜¯ç‰©ç†æ—¥å¿—ï¼Œè®°å½•çš„æ˜¯ â€œåœ¨æŸä¸ªæ•°æ®é¡µä¸Šåšäº†ä»€ä¹ˆä¿®æ”¹â€</li><li>binlog æ˜¯é€»è¾‘æ—¥å¿—ï¼Œè®°å½•çš„æ˜¯è¿™ä¸ªè¯­å¥çš„åŸå§‹é€»è¾‘ï¼Œæ¯”å¦‚ â€œç»™ ID=2 è¿™ä¸€è¡Œçš„ c å­—æ®µåŠ  1</li></ol></li><li><mark><strong>æ–‡ä»¶å†™å…¥ä¸åŒï¼š</strong></mark><ol><li>redo log æ˜¯å¾ªç¯å†™çš„ï¼Œç©ºé—´å›ºå®šä¼šç”¨å®Œï¼›</li><li>binlog æ˜¯å¯ä»¥è¿½åŠ å†™å…¥çš„ã€‚â€œè¿½åŠ å†™â€ æ˜¯æŒ‡ binlog æ–‡ä»¶å†™åˆ°ä¸€å®šå¤§å°åä¼šåˆ‡æ¢åˆ°ä¸‹ä¸€ä¸ªï¼Œå¹¶ä¸ä¼šè¦†ç›–ä»¥å‰çš„æ—¥å¿—</li></ol></li></ol><h2 id="24ä¸€æ¡æ›´æ–°è¯­å¥çš„æ‰§è¡Œè¿‡ç¨‹"><a class="markdownIt-Anchor" href="#24ä¸€æ¡æ›´æ–°è¯­å¥çš„æ‰§è¡Œè¿‡ç¨‹"></a> 2.4ä¸€æ¡æ›´æ–°è¯­å¥çš„æ‰§è¡Œè¿‡ç¨‹</h2><ol><li>æ‰§è¡Œå™¨å…ˆæ‰¾å¼•æ“å– ID=2 è¿™ä¸€è¡Œã€‚ID æ˜¯ä¸»é”®ï¼Œå¼•æ“ç›´æ¥ç”¨æ ‘æœç´¢æ‰¾åˆ°è¿™ä¸€è¡Œã€‚å¦‚æœ ID=2 è¿™ä¸€è¡Œæ‰€åœ¨çš„æ•°æ®é¡µæœ¬æ¥å°±åœ¨å†…å­˜ä¸­ï¼Œå°±ç›´æ¥è¿”å›ç»™æ‰§è¡Œå™¨ï¼›å¦åˆ™ï¼Œéœ€è¦å…ˆä»ç£ç›˜è¯»å…¥å†…å­˜ï¼Œç„¶åå†è¿”å›ã€‚</li><li>æ‰§è¡Œå™¨æ‹¿åˆ°å¼•æ“ç»™çš„è¡Œæ•°æ®ï¼ŒæŠŠè¿™ä¸ªå€¼åŠ ä¸Š 1ï¼Œæ¯”å¦‚åŸæ¥æ˜¯ Nï¼Œç°åœ¨å°±æ˜¯ N+1ï¼Œå¾—åˆ°æ–°çš„ä¸€è¡Œæ•°æ®ï¼Œå†è°ƒç”¨å¼•æ“æ¥å£å†™å…¥è¿™è¡Œæ–°æ•°æ®ã€‚</li><li>å¼•æ“å°†è¿™è¡Œæ–°æ•°æ®æ›´æ–°åˆ°å†…å­˜ä¸­ï¼ŒåŒæ—¶å°†è¿™ä¸ªæ›´æ–°æ“ä½œè®°å½•åˆ° redo log é‡Œé¢ï¼Œæ­¤æ—¶ redo log å¤„äº prepare çŠ¶æ€ã€‚ç„¶åå‘ŠçŸ¥æ‰§è¡Œå™¨æ‰§è¡Œå®Œæˆäº†ï¼Œéšæ—¶å¯ä»¥æäº¤äº‹åŠ¡ã€‚</li><li>æ‰§è¡Œå™¨ç”Ÿæˆè¿™ä¸ªæ“ä½œçš„ binlogï¼Œå¹¶æŠŠ binlog å†™å…¥ç£ç›˜ã€‚ã€</li><li>æ‰§è¡Œå™¨è°ƒç”¨å¼•æ“çš„æäº¤äº‹åŠ¡æ¥å£ï¼Œå¼•æ“æŠŠåˆšåˆšå†™å…¥çš„ redo log æ”¹æˆæäº¤ï¼ˆcommitï¼‰çŠ¶æ€ï¼Œæ›´æ–°å®Œæˆ</li></ol>]]></content>
    
    
      
      
    <summary type="html">&lt;link rel=&quot;stylesheet&quot; class=&quot;aplayer-secondary-style-marker&quot; href=&quot;&#92;assets&#92;css&#92;APlayer.min.css&quot;&gt;&lt;script src=&quot;&#92;assets&#92;js&#92;APlayer.min.js&quot; cla</summary>
      
    
    
    
    <category term="ã€MySQLã€‘" scheme="https://www.haipeng-lin.cn/categories/%E3%80%90MySQL%E3%80%91/"/>
    
    
  </entry>
  
  <entry>
    <title>MVCC-å¤šç‰ˆæœ¬å¹¶å‘æ§åˆ¶</title>
    <link href="https://www.haipeng-lin.cn/posts/8b489829.html"/>
    <id>https://www.haipeng-lin.cn/posts/8b489829.html</id>
    <published>2024-09-21T08:40:58.000Z</published>
    <updated>2024-09-21T08:50:09.248Z</updated>
    
    <content type="html"><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="\assets\css\APlayer.min.css"><script src="\assets\js\APlayer.min.js" class="aplayer-secondary-script-marker"></script><h1 id="3mysqlä¸­çš„mvccæœºåˆ¶"><a class="markdownIt-Anchor" href="#3mysqlä¸­çš„mvccæœºåˆ¶"></a> 3.MySQLä¸­çš„MVCCæœºåˆ¶</h1><h2 id="31å‰è¨€"><a class="markdownIt-Anchor" href="#31å‰è¨€"></a> 3.1å‰è¨€</h2><ol><li>MVCCï¼Œå…¨åå«åšå¤šç‰ˆæœ¬å¹¶å‘æ§åˆ¶ï¼Œå…è®¸<mark>å¤šä¸ªäº‹åŠ¡</mark>åŒæ—¶å¯¹æ•°æ®åº“<mark>è¿›è¡Œè¯»å†™æ“ä½œ</mark>ï¼Œè§£å†³äº†ä¸€ä¸ªæ•°æ®çš„å¤šç‰ˆæœ¬è¯»å†™å†²çªï¼›ä¼ ç»Ÿçš„é”æœºåˆ¶å¯ä»¥å®ç°å¹¶å‘æ§åˆ¶ï¼Œä½†<mark>ä¼šå¯¼è‡´é˜»å¡å’Œæ­»é”ç­‰é—®é¢˜</mark></li><li>æ ¸å¿ƒæ€æƒ³ï¼šåœ¨æ•°æ®åº“ä¸­ï¼Œé€šè¿‡undo logç»´æŠ¤å¤šä¸ªæ•°æ®ç‰ˆæœ¬ï¼Œå¹¶æ ¹æ®äº‹åŠ¡çš„éš”ç¦»çº§åˆ«æ¥å†³å®šå“ªä¸ªç‰ˆæœ¬æ•°æ®å¯¹ç‰¹å®šäº‹åŠ¡æ˜¯å¯è§çš„</li><li>å®ç°çš„ä¸‰ä¸ªé‡è¦éƒ¨åˆ†ï¼š<ol><li>éšè—å­—æ®µ</li><li>undo logç‰ˆæœ¬é“¾</li><li>readViewå¿«ç…§</li></ol></li></ol><h2 id="32undo-logæ—¥å¿—"><a class="markdownIt-Anchor" href="#32undo-logæ—¥å¿—"></a> 3.2undo logæ—¥å¿—</h2><ol><li>undo logï¼ˆå›æ»šæ—¥å¿—ï¼‰ä¸­è®°å½•äº†ä¿®æ”¹å‰çš„æ•°æ®å€¼ï¼Œä»¥åŠæ’¤é”€æ“ä½œæ‰€éœ€çš„ä¿¡æ¯ï¼Œä»¥ä¾¿åœ¨äº‹åŠ¡å›æ»šæˆ– MVCC ä¸­ä½¿ç”¨</li></ol><h2 id="33ä¸‰ä¸ªéšè—å­—æ®µ"><a class="markdownIt-Anchor" href="#33ä¸‰ä¸ªéšè—å­—æ®µ"></a> 3.3ä¸‰ä¸ªéšè—å­—æ®µ</h2><ol><li>InnoDBä¼šè‡ªåŠ¨ä¸ºæ¯ä¸ªundo log å›æ»šæ—¥å¿—åŠ ä¸Šä¸‰ä¸ªå­—æ®µï¼š<ol><li>DB_ROW_IDï¼šéšè—ä¸»é”®</li><li><mark>DB_TRX_ID</mark>ï¼šåˆ›å»ºè¯¥undo log æ•°æ®çš„äº‹åŠ¡ID</li><li><mark>DB_ROLL_PTR</mark>ï¼šå›æ»šæŒ‡é’ˆï¼ŒæŒ‡å‘è¿™ä¸ªäº‹åŠ¡ä¹‹å‰çš„ undo log</li></ol></li></ol><p><img src="https://gitee.com/linhaipengg/md_-picture/raw/master/image-20240804142639223.png" alt="image-20240804142639223" /></p><h2 id="34undo-logç‰ˆæœ¬é“¾"><a class="markdownIt-Anchor" href="#34undo-logç‰ˆæœ¬é“¾"></a> 3.4undo logç‰ˆæœ¬é“¾</h2><ol><li>undo log ç‰ˆæœ¬é“¾ï¼šåŸºäºundo log å›æ»šæ—¥å¿—å®ç°ï¼Œç»´æŠ¤äº†ä¸€æ¡æ•°æ®çš„å¤šä¸ªç‰ˆæœ¬</li></ol><p><img src="https://gitee.com/linhaipengg/md_-picture/raw/master/image-20240804144543255.png" alt="image-20240804144543255" /></p><h2 id="35å½“å‰è¯»vså¿«ç…§è¯»"><a class="markdownIt-Anchor" href="#35å½“å‰è¯»vså¿«ç…§è¯»"></a> 3.5å½“å‰è¯»VSå¿«ç…§è¯»</h2><ol><li><p><strong>å½“å‰è¯»</strong></p><ol><li><mark>è¯»å–çš„æ˜¯å½“å‰è®°å½•çš„æœ€æ–°ç‰ˆæœ¬</mark>ï¼Œè¯»å–çš„æ—¶å€™éœ€è¦ä¿è¯å…¶ä»–å¹¶å‘äº‹åŠ¡ä¸èƒ½ä¿®æ”¹å½“å‰è®°å½•ï¼Œå¯¹å½“å‰è®°å½•åŠ é”</li><li>ä¾‹å­ï¼šInsertã€Updateã€Deleteã€Selectâ€¦ for updateï¼ˆå†™é”ï¼‰ã€Selectâ€¦ lock in share modeï¼ˆè¯»é”ï¼‰</li></ol></li><li><p><strong>å¿«ç…§è¯»ï¼š</strong></p><ol><li>æœ€æ™®é€šçš„SelectæŸ¥è¯¢SQLè¯­å¥</li><li>è¯»å–çš„æ˜¯æ•°æ®çš„å¯è§ç‰ˆæœ¬ï¼Œæœ‰å¯èƒ½æ˜¯å†å²æ•°æ®ã€å½“å‰ç‰ˆæœ¬ï¼Œ<mark>ä¸åŠ é”ï¼Œæ˜¯éé˜»å¡è¯»</mark></li><li>åº•å±‚ä¾èµ–ï¼šå½“æ‰§è¡Œâ€œå¿«ç…§è¯»â€SQLè¯­å¥æ—¶ï¼Œä¾æ®==ReadViewï¼ˆå¿«ç…§ï¼‰==æ¥æå–æ•°æ®</li></ol></li></ol><h2 id="36readview"><a class="markdownIt-Anchor" href="#36readview"></a> 3.6ReadView</h2><ol><li>ReadViewï¼Œä¸€ä¸ªä¿å­˜äº‹åŠ¡IDçš„liståˆ—è¡¨ã€‚è®°å½•çš„æ˜¯<mark>æœ¬äº‹åŠ¡æ‰§è¡Œæ—¶ï¼ŒMySQLè¿˜æœ‰å“ªäº›äº‹åŠ¡åœ¨æ‰§è¡Œ</mark>ï¼Œä¸”è¿˜æ²¡æœ‰æäº¤</li><li><strong>ä¸€ç§æ•°æ®ç»“æ„ï¼ŒåŒ…å«å››ä¸ªå­—æ®µï¼š</strong><ol><li>m_idsï¼šå½“å‰<mark>æ´»è·ƒ</mark>çš„äº‹åŠ¡ç¼–å·é›†åˆ</li><li>min_trx_idï¼šæœ€å°æ´»è·ƒäº‹åŠ¡ç¼–å·</li><li>max_trx_idï¼šé¢„åˆ†é…äº‹åŠ¡ç¼–å·ï¼Œå³å½“å‰æœ€å¤§äº‹åŠ¡ç¼–å·+1</li><li><mark>creator_trx_idï¼šReadViewåˆ›å»ºè€…çš„äº‹åŠ¡ç¼–å·</mark></li></ol></li><li><strong>ä¸åŒéš”ç¦»çº§åˆ«ä¸‹å¿«ç…§ç”Ÿæˆçš„æ—¶æœºï¼š</strong><ol><li>RCï¼ˆè¯»å·²æäº¤ï¼‰ï¼šæ¯ä¸€æ¬¡selectï¼Œéƒ½ç”Ÿæˆä¸€ä¸ª ReadView</li><li>RRï¼ˆå¯é‡å¤è¯»ï¼‰ï¼šå¼€å¯ä¸€ä¸ªäº‹åŠ¡ä¹‹åï¼Œåªæœ‰ç¬¬ä¸€ä¸ªselectè¯­å¥æ‰ä¼šç”Ÿæˆä¸€å¼ å¿«ç…§ï¼Œæ­¤åè¯»çš„éƒ½æ˜¯å¿«ç…§ä¸­çš„æ•°æ®ï¼Œç›´åˆ°äº‹åŠ¡æäº¤</li><li>Serializableï¼ˆå¯åºåˆ—åŒ–ï¼‰ï¼šå¿«ç…§è¯»é€€åŒ–æˆå½“å‰è¯»ï¼ˆåŠ é”ï¼Œé˜»å¡ï¼Œè¯»å–åˆ°çš„æ˜¯æœ€æ–°çš„æ•°æ®ï¼‰</li></ol></li><li><strong>æ ¹æ®ReadViewå¿«ç…§è®¿é—®undo log ç‰ˆæœ¬é“¾æ•°æ®çš„è§„åˆ™ï¼š</strong><ol><li>è‹¥ è¯¥ç‰ˆæœ¬çš„åˆ›å»ºäº‹åŠ¡id <mark>ç­‰äº</mark> å½“å‰äº‹åŠ¡id  ï¼Ÿå¯ä»¥è®¿é—®è¯¥ç‰ˆæœ¬ï¼Œå› ä¸ºæ•°æ®æ˜¯å½“å‰è¿™ä¸ªäº‹åŠ¡æ›´æ”¹çš„ï¼›</li><li>è‹¥ è¯¥ç‰ˆæœ¬çš„åˆ›å»ºäº‹åŠ¡id <mark>å°äº</mark> å¿«ç…§ä¸­ æœ€å°æ´»è·ƒäº‹åŠ¡ç¼–å·ï¼Ÿå¯ä»¥è®¿é—®è¯¥ç‰ˆæœ¬ï¼Œå› ä¸ºæ•°æ®å·²ç»æäº¤äº†ï¼›</li><li>è‹¥ è¯¥ç‰ˆæœ¬çš„åˆ›å»ºäº‹åŠ¡id <mark>å¤§äº</mark> å¿«ç…§ä¸­ é¢„åˆ†é…äº‹åŠ¡idï¼Ÿ<mark>ä¸å¯ä»¥è®¿é—®è¯¥ç‰ˆæœ¬</mark>ï¼Œå› ä¸ºè¯¥äº‹åŠ¡ä¿®æ”¹çš„æ•°æ®æ˜¯åœ¨ ReadViewç”Ÿæˆåæ‰å¼€å¯çš„ï¼›</li><li>è‹¥ å¿«ç…§ä¸­æœ€å°æ´»è·ƒäº‹åŠ¡ç¼–å· &lt;=  è¯¥ç‰ˆæœ¬çš„åˆ›å»ºäº‹åŠ¡id &lt;= é¢„åˆ†é…äº‹åŠ¡id å¹¶ä¸” <mark>è¯¥ç‰ˆæœ¬çš„åˆ›å»ºäº‹åŠ¡idä¸åœ¨æ´»è·ƒäº‹åŠ¡ç¼–å·é›†åˆä¸­</mark>ï¼Œå¯ä»¥è®¿é—®è¯¥ç‰ˆæœ¬ï¼Œå› ä¸ºè¯¥æ•°æ®å·²ç»æäº¤ï¼›</li></ol></li></ol><h2 id="37ä¸¾ä¾‹"><a class="markdownIt-Anchor" href="#37ä¸¾ä¾‹"></a> 3.7ä¸¾ä¾‹</h2><h3 id="371rcè¯»å·²æäº¤"><a class="markdownIt-Anchor" href="#371rcè¯»å·²æäº¤"></a> 3.7.1RCï¼ˆè¯»å·²æäº¤ï¼‰</h3><ol><li><strong>å…¶ä¸­äº‹åŠ¡4çš„ä¸¤æ¬¡å¿«ç…§è¯»å‡ä¼šäº§ç”ŸReadViewï¼Œå¦‚ä¸‹ï¼š</strong></li></ol><p><img src="https://gitee.com/linhaipengg/md_-picture/raw/master/image-20240416111607748.png" alt="image-20240416111607748" /></p><ol start="2"><li><strong>åˆ†æç¬¬ä¸€ä¸ªReadViewï¼š</strong></li></ol><p><img src="https://gitee.com/linhaipengg/md_-picture/raw/master/image-20240416112044314.png" alt="image-20240416112044314" /></p><ol start="3"><li><strong>åˆ†æç¬¬äºŒä¸ªReadViewï¼š</strong></li></ol><p><img src="https://gitee.com/linhaipengg/md_-picture/raw/master/image-20240416112809451.png" alt="image-20240416112809451" /></p><ol start="4"><li><p>å°ç»“ï¼š</p><ol><li>åœ¨RCï¼ˆè¯»å·²æäº¤ï¼‰çš„äº‹åŠ¡éš”ç¦»çº§åˆ«ä¸‹ï¼ŒåŒä¸€äº‹åŠ¡çš„ä¸¤æ¬¡å¿«ç…§è¯»å‡ä¼šäº§ç”Ÿä¸¤ä¸ªå¿«ç…§ï¼ˆReadViewï¼‰ï¼›</li><li>ç¬¬ä¸€ä¸ªå¿«ç…§è¯»è¯»å–çš„æ•°æ®æ˜¯ äº‹åŠ¡ä¸€ä¿®æ”¹å¹¶æäº¤çš„æ•°æ®ï¼šå¼ ä¸‰</li><li>ç¬¬äºŒä¸ªå¿«ç…§è¯»è¯»å–çš„æ•°æ®æ˜¯ äº‹åŠ¡äºŒä¿®æ”¹å¹¶æäº¤çš„æ•°æ®ï¼šå¼ å°ä¸‰</li><li>åŒä¸€äº‹åŠ¡çš„<mark>ä¸¤ä¸ªä¸åŒselectï¼ˆå¿«ç…§è¯»ï¼‰è¯»å–çš„æ•°æ®ä¸ä¸€æ ·ï¼Œäº§ç”Ÿä¸å¯é‡å¤è¯»ç°è±¡</mark></li></ol></li><li><p>æ€è€ƒï¼šåº”è¯¥æ€ä¹ˆè§£å†³ï¼Ÿ</p></li><li><p>è§£å†³ï¼šè®¾ç½®éš”ç¦»çº§åˆ«ä¸º RRï¼ˆå¯é‡å¤è¯»ï¼‰ï¼Œ<mark>åŒä¸€äº‹åŠ¡ä»å§‹è‡³ç»ˆåªä¼šç”Ÿæˆä¸€ä¸ªå¿«ç…§</mark></p></li></ol><h3 id="372rrå¯é‡å¤è¯»"><a class="markdownIt-Anchor" href="#372rrå¯é‡å¤è¯»"></a> 3.7.2RRï¼ˆå¯é‡å¤è¯»ï¼‰</h3><ol><li>éš”ç¦»çº§åˆ«ä¸º RRï¼ˆå¯é‡å¤è¯»ï¼‰ï¼Œ<mark>åŒä¸€äº‹åŠ¡ä»å§‹è‡³ç»ˆåªä¼šç”Ÿæˆä¸€ä¸ªå¿«ç…§</mark>ï¼Œå³ä¸ä¼šäº§ç”Ÿ ä¸å¯é‡å¤è¯»é—®é¢˜</li></ol><p><img src="https://gitee.com/linhaipengg/md_-picture/raw/master/image-20240416113413125.png" alt="image-20240416113413125" /></p><h2 id="38æ‰©å±•rrèƒ½è§£å†³å¹»è¯»é—®é¢˜å—"><a class="markdownIt-Anchor" href="#38æ‰©å±•rrèƒ½è§£å†³å¹»è¯»é—®é¢˜å—"></a> 3.8æ‰©å±•ï¼šRRèƒ½è§£å†³å¹»è¯»é—®é¢˜å—ï¼Ÿ</h2><ol><li><p>ç»“è®ºï¼šRRï¼ˆå¯é‡å¤è¯»ï¼‰å¯ä»¥è§£å†³<mark>ä¸€éƒ¨åˆ†å¹»è¯»é—®é¢˜</mark></p></li><li><p>åŸå› ï¼š</p><ol><li><p>åŒä¸€äº‹åŠ¡çš„è¿ç»­å¤šæ¬¡å¿«ç…§è¯»ï¼ŒReadViewä¼šäº§ç”Ÿå¤ç”¨ï¼Œæ²¡æœ‰å¹»è¯»é—®é¢˜</p></li><li><p>ç‰¹ä¾‹ï¼šå½“ä¸¤æ¬¡å¿«ç…§è¯»ä¹‹é—´å­˜åœ¨å½“å‰è¯»ï¼ŒReadViewä¼šé‡æ–°ç”Ÿæˆï¼Œå¯¼è‡´å¹»è¯»é—®é¢˜</p><p><img src="https://gitee.com/linhaipengg/md_-picture/raw/master/image-20240416115328840.png" alt="image-20240416115328840" /></p></li></ol></li></ol>]]></content>
    
    
      
      
    <summary type="html">&lt;link rel=&quot;stylesheet&quot; class=&quot;aplayer-secondary-style-marker&quot; href=&quot;&#92;assets&#92;css&#92;APlayer.min.css&quot;&gt;&lt;script src=&quot;&#92;assets&#92;js&#92;APlayer.min.js&quot; cla</summary>
      
    
    
    
    <category term="ã€MySQLã€‘" scheme="https://www.haipeng-lin.cn/categories/%E3%80%90MySQL%E3%80%91/"/>
    
    
  </entry>
  
  <entry>
    <title>ç”µè„‘ç»„ä»¶</title>
    <link href="https://www.haipeng-lin.cn/posts/dc5c111d.html"/>
    <id>https://www.haipeng-lin.cn/posts/dc5c111d.html</id>
    <published>2024-09-19T03:12:37.000Z</published>
    <updated>2024-09-19T08:28:14.595Z</updated>
    
    <content type="html"><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="\assets\css\APlayer.min.css"><script src="\assets\js\APlayer.min.js" class="aplayer-secondary-script-marker"></script><h1 id="å‰è¨€"><a class="markdownIt-Anchor" href="#å‰è¨€"></a> å‰è¨€</h1><p>â€‹è¿™ç¯‡æ–‡ç« ç”¨äºè®°å½•æ–°æ‰‹å°ç™½å¯¹ç”µè„‘ç»„ä»¶çš„è®¤è¯†è¿‡ç¨‹ï¼Œå¢å¼ºè‡ªèº«çš„çŸ¥è¯†å‚¨å¤‡ï¼ŒåŒæ—¶å¸Œæœ›ç”¨ç®€æ´æ˜“æ‡‚çš„æ–‡å­—å¸®åŠ©å°ç™½ä¹Ÿèƒ½çœ‹å¾—æ‡‚ç”µè„‘é…ç½®ã€‚</p><ul><li>æ¨èBç«™upä¸»</li></ul><div calss='anzhiyu-tag-link'><a class="tag-Link" target="_blank" href="https://space.bilibili.com/1488429768">    <div class="tag-link-tips">å¼•ç”¨ç«™å¤–åœ°å€</div>    <div class="tag-link-bottom">        <div class="tag-link-left" style="background-image: url(https://api.iowen.cn/favicon/space.bilibili.com/1488429768.png);"></div>        <div class="tag-link-right">            <div class="tag-link-title">å¤ä¸€ææœºç ”ç©¶æ‰€</div>            <div class="tag-link-sitename"></div>        </div>        <i class="fa-solid fa-angle-right"></i>    </div>    </a></div><div calss='anzhiyu-tag-link'><a class="tag-Link" target="_blank" href="https://space.bilibili.com/14871346">    <div class="tag-link-tips">å¼•ç”¨ç«™å¤–åœ°å€</div>    <div class="tag-link-bottom">        <div class="tag-link-left" style="background-image: url(https://api.iowen.cn/favicon/space.bilibili.com/14871346.png);"></div>        <div class="tag-link-right">            <div class="tag-link-title">ç¡¬ä»¶èŒ¶è°ˆ</div>            <div class="tag-link-sitename"></div>        </div>        <i class="fa-solid fa-angle-right"></i>    </div>    </a></div><details class="folding-tag" ><summary> ç¡¬ä»¶èŒ¶è°ˆ234243 </summary>              <div class='content'>              <p>ç¡¬ä»¶èŒ¶è°ˆ234243</p>              </div>            </details><h1 id="ç”µè„‘ç»„ä»¶"><a class="markdownIt-Anchor" href="#ç”µè„‘ç»„ä»¶"></a> ç”µè„‘ç»„ä»¶</h1><blockquote><p>ç”µè„‘ç»„ä»¶æœ‰CPUã€æ˜¾å¡ã€å†…å­˜ã€å›ºæ€ã€ä¸»æ¿ã€ç”µæºã€æœºç®±ã€æ•£çƒ­ï¼ˆé£æ‰‡ï¼‰</p></blockquote><ul><li>CPUï¼šä¸­å¤®å¤„ç†å•å…ƒï¼ˆCentral Processing Unitï¼‰çš„ç¼©å†™ï¼Œä¹Ÿå«å¤„ç†å™¨ï¼Œæ˜¯<mark>è®¡ç®—æœºçš„è¿ç®—æ ¸å¿ƒå’Œæ§åˆ¶æ ¸å¿ƒ</mark>ã€‚äººé å¤§è„‘æ€è€ƒï¼Œç”µè„‘é CPUæ¥è¿ç®—ã€æ§åˆ¶ã€‚è®©ç”µè„‘çš„å„ä¸ªéƒ¨ä»¶é¡ºåˆ©å·¥ä½œï¼Œèµ·åˆ°åè°ƒå’Œæ§åˆ¶ä½œç”¨</li><li>æ˜¾å¡ï¼ˆGPUï¼‰ï¼š<mark>è´Ÿè´£åœ¨æ˜¾ç¤ºå±ä¸Šæ˜¾ç¤ºä¸€åˆ‡ä¿¡æ¯</mark>ã€‚æ‰“ä¸ªæ¯”æ–¹ï¼Œå®ƒå°±åƒæ˜¯äººçš„çœ¼ç›ï¼Œæ²¡æœ‰äº†å®ƒï¼Œç”µè„‘å°±æ— æ³•é©±åŠ¨å½¢æˆå›¾åƒäº†ã€‚æ˜¾å¡æ€§èƒ½å¥½ï¼Œç”µè„‘çš„å›¾å½¢å¤„ç†èƒ½åŠ›å°±é«˜ï¼Œå°¤å…¶åœ¨ç©æ¸¸æˆæ—¶æ›´èƒ½å‘ç°è¿™ä¸ªï¼ˆæ‰€ä»¥å¾ˆå¤šæ¸¸æˆä¼šè¦æ±‚æ˜¾å¡æ€§èƒ½ï¼‰<ul><li>â€œé›†æˆæ˜¾å¡â€ ä¸ â€œç‹¬ç«‹æ˜¾å¡â€çš„åŒºåˆ«</li><li>é›†æˆæ˜¾å¡æ˜¯é›†æˆåœ¨ä¸»æ¿æˆ–CPUé‡Œé¢çš„æ˜¾å¡ï¼Œé›†æˆåœ¨CPUé‡Œé¢çš„æ˜¾å¡åˆå«åšæ ¸å¿ƒæ˜¾å¡ã€‚</li><li>ç‹¬ç«‹æ˜¾å¡æ˜¯ä»¥ç‹¬ç«‹æ¿å¡å½¢å¼å­˜åœ¨ï¼Œå¯åœ¨å…·å¤‡æ˜¾å¡æ¥å£çš„ä¸»æ¿ä¸Šè‡ªç”±æ’æ‹”çš„æ˜¾å¡ã€‚</li></ul></li><li>å†…å­˜ï¼šè´Ÿè´£ç¡¬ç›˜ç­‰ç¡¬ä»¶ä¸Šçš„æ•°æ®ä¸CPUä¹‹é—´æ•°æ®äº¤æ¢å¤„ç†ï¼›ç¼“å­˜ç³»ç»Ÿä¸­çš„ä¸´æ—¶æ•°æ®ï¼›æ–­ç”µåæ•°æ®ä¸¢å¤±</li><li>å›ºæ€ï¼šå›ºæ€ç¡¬ç›˜ï¼ˆSSDï¼‰æ˜¯ä¸€ç§ç”¨äºå­˜å‚¨æ•°æ®çš„è®¾å¤‡ï¼Œå®ƒä½¿ç”¨é—ªå­˜æŠ€æœ¯æ¥å­˜å‚¨ä¿¡æ¯</li><li>ä¸»æ¿ï¼š<mark>è¿æ¥æ‰€æœ‰å…¶ä»–è®¾å¤‡çš„è®¾å¤‡</mark>ï¼Œæ˜¯å…¶ä»–è®¾å¤‡çš„è½½ä½“ï¼Œä¸»æ¿ä¸»è¦æ˜¯ä¸ºCPUã€å†…å­˜ã€æ˜¾å¡ã€ç¡¬ç›˜ç­‰æä¾›å¹³å°ï¼Œç›¸å½“äºäººä½“çš„èº¯å¹²ï¼Œå…³è”ç€å„ä¸ªå™¨å®˜</li><li>ç”µæºï¼šç”¨äºä¾›ç”µ</li><li>æœºç®±ï¼šæ”¾ç½®å’Œå›ºå®šå„ç”µè„‘é…ä»¶ï¼Œèµ·åˆ°ä¸€ä¸ªæ‰¿æ‰˜å’Œä¿æŠ¤ä½œç”¨ã€‚</li><li>æ•£çƒ­ï¼ˆé£æ‰‡ï¼‰ï¼šç”¨äºé™æ¸©</li></ul><h2 id="1cpu"><a class="markdownIt-Anchor" href="#1cpu"></a> 1.CPU</h2><ul><li><p>CPUç›®å‰ä¸»è¦æœ‰ä¸¤å¤§å“ç‰Œï¼šIntelï¼ˆè‹±ç‰¹å°”ï¼‰ã€AMDï¼ˆè¶…å¾®åŠå¯¼ä½“ï¼‰</p></li><li><p>åŒºåˆ†å¥½åè¦çœ‹<mark>æ ¸å¿ƒæ•°é‡è¶Šå¤šï¼Œçº¿ç¨‹è¶Šå¤š</mark>ï¼ŒCPUç¼“å­˜è¶Šå¤§ï¼ŒCPUä¸»é¢‘è¶Šé«˜å…¶<mark>æ€§èƒ½è¶Šå¥½</mark>ï¼Œä»·æ ¼ä¹Ÿè¦æ›´é«˜</p><blockquote><p>CPUæ€§èƒ½å¤©æ¢¯å›¾ï¼š<a href="https://www.mydrivers.com/zhuanti/tianti/cpu/">https://www.mydrivers.com/zhuanti/tianti/cpu/</a></p></blockquote></li><li><p>CPUçš„æ ¸å¿ƒæˆ‘ä»¬æ¯”å–»æˆå¨å¸ˆåšèœ</p><ul><li>å•æ ¸å¿ƒå•çº¿ç¨‹å°±æ˜¯ä¸€ä¸ªå¨å¸ˆä¸€ä¸ªç¶å°</li><li>å•æ ¸å¿ƒåŒçº¿ç¨‹å°±æ˜¯ä¸€ä¸ªå¨å¸ˆä¸¤ä¸ªç¶å°</li><li>å››æ ¸å¿ƒå››çº¿ç¨‹å°±æ˜¯å››ä¸ªå¨å¸ˆå››ä¸ªç¶å°</li></ul></li><li><p>å¦‚ä½•è¾¨åˆ«è‹±ç‰¹å°”å‹å·ï¼Ÿ</p>  <img src="https://haipeng-lin.oss-cn-shenzhen.aliyuncs.com/202409182308624.png" alt="image-20240918230832446" style="zoom: 50%;" /><ul><li>Intelå®¶æ—ç³»åˆ—æœ‰ï¼šCoreï¼ˆé…·ç¿ï¼‰ã€Pentiumï¼ˆå¥”è…¾ï¼‰ã€Celeronï¼ˆèµ›æ‰¬ï¼‰ã€Xeonï¼ˆè‡³å¼ºï¼‰ã€Atomï¼ˆå‡ŒåŠ¨ï¼‰ç­‰</li><li><mark>Intelåç¼€å‘½åï¼ˆæ¡Œé¢ç‰ˆï¼‰</mark>ï¼š<ul><li><strong>Kï¼š</strong> è¡¨ç¤ºæ”¯æŒè¶…é¢‘ä¸”å†…ç½®æ ¸æ˜¾çš„CPUå‹å·ï¼Œä¾‹å¦‚å‹å·ï¼ši5-12600Kã€i7-12700Kï¼›</li><li><strong>Fï¼š</strong> è¡¨ç¤ºæ— å†…ç½®æ ¸æ˜¾ï¼Œä¾‹å¦‚å‹å·ï¼ši5-12400Fã€i7-12700Fï¼›</li><li><strong>KFï¼š</strong> è¡¨ç¤ºæ”¯æŒè¶…é¢‘ä¸”æ— å†…ç½®æ ¸æ˜¾çš„CPUå‹å·ï¼Œä¾‹å¦‚å‹å·ï¼ši5-12600KFï¼Œi7-12700KFã€‚</li><li><strong>Tï¼š</strong> è¡¨ç¤ºä½åŠŸè€—ç‰ˆï¼Œç›¸åŒå‹å·ä¸‹åŠŸè€—æ›´ä½ï¼Œæ€§èƒ½ä¹Ÿå·®ä¸€äº›ï¼Œä¾‹å¦‚å‹å·ï¼ši7-10700Tï¼›</li><li><strong>X/XEï¼š</strong> è¡¨ç¤ºè‡³å°Šæ——èˆ°çº§ï¼Œä¾‹å¦‚å‹å·ï¼ši9-10980XEã€‚</li><li><strong>KSï¼š</strong> å¯ä»¥ç†è§£ä¸ºå®˜æ–¹è¶…é¢‘ç‰ˆï¼Œæå‡äº†ä¸»é¢‘çš„ç‰ˆæœ¬ï¼Œä¾‹å¦‚i9-9900Kå’Œi9-9900KSï¼Œi9-9900KSå‡ºå‚çš„ä¸»é¢‘è¦é«˜äºKï¼Œä¾‹å¦‚å‹å·ï¼ši9-9900KSã€‚</li></ul></li><li><mark>Intelåç¼€å‘½åï¼ˆç§»åŠ¨ç‰ˆï¼‰</mark>ï¼š<ul><li><strong>Uï¼š</strong> ä½ç”µå‹ï¼Œæ€§èƒ½å¼±äº›ä½†åŠŸè€—ä½ï¼Œé€šå¸¸å‡ºç°åœ¨<strong>è½»è–„æœ¬</strong>ä¸­ï¼Œä¸¾ä¾‹å‹å·ï¼ši7 10510Uï¼›</li><li><strong>Hï¼š</strong> æ ‡å‹ï¼Œæ€§èƒ½å¼ºï¼Œé€šå¸¸å‡ºç°åœ¨<strong>æ¸¸æˆæœ¬</strong>ä¸­ï¼Œä¸¾ä¾‹å‹å·ï¼ši5-11300H</li><li><strong>Yï¼š</strong> è¶…ä½ç”µå‹ï¼Œæ€§èƒ½å¾ˆå¼±åŠŸè€—éå¸¸ä½ï¼Œé€šå¸¸å‡ºç°åœ¨è½»è–„æœ¬ä¸­ï¼Œä¸¾ä¾‹å‹å·ï¼ši3-10110Yï¼›</li><li><strong>HKï¼š</strong> ä¸€èˆ¬ä½¿ç”¨åœ¨intelé«˜ç«¯å‘çƒ§çº§CPUä¸Šï¼Œå¯è¶…é¢‘ï¼Œä¸¾ä¾‹å‹å·ï¼ši9-11980HKï¼›</li><li><strong>Gï¼š</strong> G1ã€G4ä»¥åŠG7ç­‰ï¼ŒGåé¢çš„æ•°å­—è¡¨ç¤º[æ ¸æ˜¾æ€§èƒ½]å¼ºå¼±ï¼Œæ•°å­—è¶Šå¤§ä»£è¡¨æ ¸æ˜¾æ€§èƒ½è¶Šå¼ºï¼Œé€šå¸¸æ•°å­—å°äº4çš„æ˜¯é›†æˆçš„æ™®é€šè¶…é«˜æ¸…(UHD)æ ¸æ˜¾ï¼Œå¤§äºç­‰äº4çš„æ˜¯é›†æˆçš„é«˜æ€§èƒ½é”ç‚¬(Iris)æ ¸æ˜¾ã€‚intelç§»åŠ¨ç‰ˆCPUåç¼€ï¼Œä¸¾ä¾‹å‹å·ï¼ši5-1155G7ã€i3-1115G4ã€i3-1005G1ï¼›</li><li><strong>HQï¼š</strong> æ ‡å‡†ç”µå‹ï¼ŒQæ¿è½½å››æ ¸ï¼Œæ—©æœŸçš„è€åç¼€ï¼Œä¸¾ä¾‹å‹å·ï¼ši7-7700HQï¼›</li><li><strong>MQï¼š</strong> æ ‡å‡†ç”µå‹ï¼ŒQæ’æ‹”å››æ ¸ï¼Œæ—©æœŸçš„è€åç¼€ï¼Œä¸¾ä¾‹å‹å·ï¼ši7-4810MQï¼›</li><li><strong>Mï¼š</strong> æ—©æœŸåç¼€Må°±æ˜¯ç§»åŠ¨ç«¯CPUï¼Œåªæ˜¯ä¸ºäº†ä¸å°å¼æœºåŒºåˆ«å¼€ï¼Œä¸¾ä¾‹å‹å·ï¼ši7-2620M</li></ul></li></ul></li><li><p>å¦‚ä½•è¾¨åˆ«AMD CPUï¼Ÿ</p>  <img src="https://pic4.zhimg.com/80/v2-8353f2c538af6e53c26c63be22180a03_1440w.webp" alt="img" style="zoom: 67%;" /><ul><li><strong>â€œé”é¾™â€</strong> ä»£è¡¨AMDå“ç‰Œä¸‹é¢å‘æ™®é€šæ¶ˆè´¹è€…çš„ä¸€ä¸ªCPUç³»åˆ—ï¼ŒæŒ‰ç…§ç³»åˆ—åˆ’åˆ†ï¼Œæœ‰Ryzenï¼ˆé”é¾™ï¼‰ã€Ryzen Proï¼ˆé”é¾™Proï¼‰ã€Ryzen Threadripperï¼ˆé”é¾™çº¿ç¨‹æ’•è£‚è€…ï¼‰ã€EPYCï¼ˆéœ„é¾™ï¼‰ï¼Œé™¤äº†EPYCéœ„é¾™éš¶å±äºæœåŠ¡å™¨CPUå¤–ï¼ŒRyzené”é¾™ç³»åˆ—éƒ½æ˜¯æœ‰æ¶ˆè´¹çº§æ¡Œé¢ã€ç§»åŠ¨äº§å“ã€‚</li><li><strong>â€œR5â€</strong> ä»£è¡¨è¿™æ¬¾CPUå®šä½ä¸­ç«¯ï¼Œåœ¨å…¶ä¸‹é¢è¿˜æœ‰R3ï¼Œåœ¨å…¶ä¸Šé¢è¿˜æœ‰R7å’ŒR9ï¼ŒåŒä¸€ä»£ä¸­ï¼Œæ•°å­—è¶Šå¤§ï¼Œæ€§èƒ½è¶Šå¼ºï¼›ä½†æ˜¯ä¸åŒä»£æ•°ä¹‹é—´ï¼Œæ€§èƒ½ä¸èƒ½ç›´æ¥ç›¸æ¯”ï¼Œæ¯”å¦‚5ä»£çš„R5åœ¨ç†è®ºæ€§èƒ½ä¸Šæ˜¯å¼ºäº3ä»£R7çš„ã€‚</li><li><strong>â€œ5â€</strong> ä»£è¡¨è¿™æ¬¾CPUçš„ä»£æ•°ï¼Œè¯´æ˜å…¶å·²ç»å‘å±•åˆ°ç¬¬5ä»£äº†ï¼Œæ•°å­—è¶Šå¤§è¶Šæ–°ï¼›</li><li><strong>â€œ600â€</strong> è¿™ä¸‰ä½æ•°å­—ä»£è¡¨<strong>AMD SKUå‹å·åˆ’åˆ†</strong>ï¼ŒRyzen 7æœ‰800/700ï¼ŒRyzen 5æœ‰600/500/400ï¼ŒRyzen 3æœ‰300/200ã€‚åŒæ ·åœ°ï¼Œæ•°å­—è¶Šå¤§ï¼Œé¢‘ç‡è¶Šé«˜ï¼Œåœ¨Ryzen 5é‡Œé¢ç”šè‡³ä¼šæœ‰æ›´å¤šæ ¸å¿ƒå’Œçº¿ç¨‹ï¼›</li><li><strong>â€œXâ€</strong> å¸¦Xçš„è¡¨ç¤ºæ”¯æŒXFRæŠ€æœ¯ï¼Œè‡ªé€‚åº”åŠ¨æ€æ‰©é¢‘ï¼Œé™¤äº†ç¿é¢‘ä»¥å¤–ï¼Œè¿˜èƒ½å¤Ÿè®©CPUåšå·¥åœ¨é«˜äºç¿é¢‘é¢‘ç‡çš„å·¥ä½œçŠ¶æ€ï¼Œè€Œé¢‘ç‡çš„æœ€å¤§å€¼å—åˆ°æ•£çƒ­å™¨æ•£çƒ­æ•ˆæœè€Œå˜åŒ–ï¼Œç®€å•æ¥è¯´å°±æ˜¯ï¼Œæ•£çƒ­å™¨è¶Šå¼ºï¼Œé¢‘ç‡è¶Šé«˜</li></ul></li><li><p>AMDåç¼€ï¼ˆæ¡Œé¢ç‰ˆï¼‰ï¼š</p><ul><li><strong>Gï¼š</strong> è¡¨ç¤ºå±äºAPUï¼Œå†…ç½®å¼ºå¤§çš„æ ¸æ˜¾ï¼Œä¸¾ä¾‹å‹å·ï¼šR5 5600Gã€R7 5700Gã€‚</li><li><strong>Xï¼š</strong> ä¸åŒäºintel CPUçš„Xåç¼€ï¼Œå¸¦Xç»“å°¾æ˜¯æŒ‡æ”¯æŒ<strong>XFRæŠ€æœ¯</strong>çš„å¤„ç†å™¨ï¼ŒXFRæ˜¯ä¸€ç§<strong>è¶…é¢‘æŠ€æœ¯</strong>ï¼Œæ˜¯åœ¨<a href="https://zhida.zhihu.com/search?q=Boost&amp;zhida_source=entity&amp;is_preview=1">Boost</a>åŠ é€Ÿé¢‘ç‡çš„åŸºç¡€ä¸Šå…è®¸å†æ¬¡è¶…é¢‘è¿è¡Œçš„ä¸€ç§æŠ€æœ¯ï¼Œè¿™ä¸ªæŠ€æœ¯èƒ½è®©é¢‘ç‡éšä¸åŒæ•£çƒ­è§£å†³æ–¹æ¡ˆ(é£å†·/æ°´å†·/æ¶²æ°®)è€Œå‡é™ï¼Œæ•£çƒ­è¶Šç‰›é€¼è¶…é¢‘è¶Šå¼ºæ‚ã€‚</li><li><strong>XTï¼š</strong> ç›¸å½“äºXçš„åŠ å¼ºç‰ˆï¼Œä¹Ÿå¯ä»¥è¯´æ˜¯ç‰¹æŒ‘ä½“è´¨ç‰ˆï¼Œç›¸åŒå‹å·ä¸‹XTæ¯”Xæ€§èƒ½ç•¥æœ‰æå‡ï¼Œä¸¾ä¾‹å‹å·R9 3900XTã€R7 3800XTã€R5 3600XTï¼›</li></ul></li><li><p>AMDåç¼€ï¼ˆç§»åŠ¨ç‰ˆï¼‰ï¼š</p><ul><li><strong>Uï¼š</strong> ä½ç”µå‹ï¼Œæ€§èƒ½å¼±äº›ä½†åŠŸè€—ä½ï¼Œé€šå¸¸å‡ºç°åœ¨è½»è–„æœ¬ä¸­ï¼Œä¸¾ä¾‹å‹å·ï¼šR7-5700Uï¼›</li><li><strong>Hï¼š</strong> æ ‡å‹ï¼Œæ€§èƒ½å¼ºï¼Œé€šå¸¸å‡ºç°åœ¨æ¸¸æˆæœ¬ä¸­ï¼Œä¸¾ä¾‹å‹å·ï¼šR5-5600Hï¼›</li><li><strong>HXï¼š</strong> ä¸€èˆ¬ä½¿ç”¨åœ¨AMDé«˜ç«¯å‘çƒ§çº§CPUä¸Šï¼Œè‡³å°Šç‰ˆï¼Œä¸¾ä¾‹å‹å·ï¼šR9-5980HXï¼›</li><li><strong>HSï¼š</strong> ç›¸å½“äºHåŠŸè€—ç•¥ä½ï¼Œé€šå¸¸å‡ºç°åœ¨è½»è–„å…¨èƒ½æœ¬ï¼Œæ€§èƒ½è¾ƒå¼ºï¼Œä¸¾ä¾‹å‹å·ï¼šR7 5800HSã€R5 5600HS</li></ul></li></ul><h2 id="2æ˜¾å¡"><a class="markdownIt-Anchor" href="#2æ˜¾å¡"></a> 2.æ˜¾å¡</h2><ul><li>ä¸»æµçš„æ˜¾å¡å“ç‰Œæœ‰ NVIDIAï¼ˆè‹±ä¼Ÿè¾¾ï¼‰å’ŒAMDï¼ŒIntelçš„æ˜¾å¡ç§ç±»æ¯”è¾ƒå°‘</li><li>å›½å†…å°è£…å¥½çš„å“ç‰Œæœ‰ï¼šä¸ƒå½©è™¹ï¼ˆèŠ¯ç‰‡ç³»åˆ—ï¼š<a href="https://www.colorful.cn/home/productlist?mid=102%EF%BC%89%E3%80%81">https://www.colorful.cn/home/productlist?mid=102ï¼‰ã€</a></li><li>æ˜¾å¡æ€§èƒ½å¤©æ¢¯å›¾ï¼š<a href="https://www.mydrivers.com/zhuanti/tianti/gpu/">https://www.mydrivers.com/zhuanti/tianti/gpu/</a></li></ul><h1 id="å¿ƒä»ªæ­é…"><a class="markdownIt-Anchor" href="#å¿ƒä»ªæ­é…"></a> å¿ƒä»ªæ­é…</h1><ul><li>è´­ä¹°é“¾æ¥ï¼š<a href="https://mall.bilibili.com/neul-next/detailuniversal/detail.html?isMerchant=1&amp;page=detailuniversal_detail&amp;saleType=0&amp;itemsId=10177304&amp;loadingShow=1&amp;noTitleBar=1&amp;msource=cps_comments_1488429768&amp;track_id=na_522511996_BV1GM4m117Pj_A&amp;from=&amp;from_spmid=__SPMID__">bç«™</a></li><li><img src="https://haipeng-lin.oss-cn-shenzhen.aliyuncs.com/202409191105847.png" alt="image-20240919110518565" style="zoom: 67%;" /></li></ul>]]></content>
    
    
      
      
    <summary type="html">&lt;link rel=&quot;stylesheet&quot; class=&quot;aplayer-secondary-style-marker&quot; href=&quot;&#92;assets&#92;css&#92;APlayer.min.css&quot;&gt;&lt;script src=&quot;&#92;assets&#92;js&#92;APlayer.min.js&quot; cla</summary>
      
    
    
    
    <category term="ã€æ•°ç ã€‘" scheme="https://www.haipeng-lin.cn/categories/%E3%80%90%E6%95%B0%E7%A0%81%E3%80%91/"/>
    
    
    <category term="è£…æœº" scheme="https://www.haipeng-lin.cn/tags/%E8%A3%85%E6%9C%BA/"/>
    
  </entry>
  
  <entry>
    <title>ç»¼åˆçŸ¥è¯†</title>
    <link href="https://www.haipeng-lin.cn/posts/e3771f5f.html"/>
    <id>https://www.haipeng-lin.cn/posts/e3771f5f.html</id>
    <published>2024-09-16T15:27:49.000Z</published>
    <updated>2024-09-16T15:29:26.413Z</updated>
    
    <content type="html"><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="\assets\css\APlayer.min.css"><script src="\assets\js\APlayer.min.js" class="aplayer-secondary-script-marker"></script><h1 id="è®¡ç®—æœºç½‘ç»œ"><a class="markdownIt-Anchor" href="#è®¡ç®—æœºç½‘ç»œ"></a> è®¡ç®—æœºç½‘ç»œ</h1><h2 id="1è®¡ç®—æœºç½‘ç»œåŸºç¡€"><a class="markdownIt-Anchor" href="#1è®¡ç®—æœºç½‘ç»œåŸºç¡€"></a> 1.è®¡ç®—æœºç½‘ç»œåŸºç¡€</h2><h3 id="11ä¸ƒå±‚æ¨¡å‹"><a class="markdownIt-Anchor" href="#11ä¸ƒå±‚æ¨¡å‹"></a> 1.1ä¸ƒå±‚æ¨¡å‹</h3><p><strong><mark>OSI ä¸ƒå±‚æ¨¡å‹</mark></strong> æ˜¯å›½é™…æ ‡å‡†åŒ–ç»„ç»‡æå‡ºä¸€ä¸ªç½‘ç»œåˆ†å±‚æ¨¡å‹ï¼Œå…¶å¤§ä½“ç»“æ„ä»¥åŠæ¯ä¸€å±‚æä¾›çš„åŠŸèƒ½å¦‚ä¸‹å›¾æ‰€ç¤ºï¼š</p><img src="https://haipeng-lin.oss-cn-shenzhen.aliyuncs.com/202409162242806.png" alt="image-20240916085205640" style="zoom: 67%;" /><p>æ¯ä¸€å±‚éƒ½ä¸“æ³¨åšä¸€ä»¶äº‹æƒ…ï¼Œå¹¶ä¸”æ¯ä¸€å±‚éƒ½éœ€è¦ä½¿ç”¨ä¸‹ä¸€å±‚æä¾›çš„åŠŸèƒ½æ¯”å¦‚ä¼ è¾“å±‚éœ€è¦ä½¿ç”¨ç½‘ç»œå±‚æä¾›çš„è·¯ç”±å’Œå¯»å€åŠŸèƒ½ï¼Œè¿™æ ·ä¼ è¾“å±‚æ‰çŸ¥é“æŠŠæ•°æ®ä¼ è¾“åˆ°å“ªé‡Œå»ã€‚</p><h3 id="12tcpipå››å±‚æ¨¡å‹"><a class="markdownIt-Anchor" href="#12tcpipå››å±‚æ¨¡å‹"></a> 1.2TCP/IPå››å±‚æ¨¡å‹</h3><p><strong>TCP/IP å››å±‚æ¨¡å‹</strong> æ˜¯ç›®å‰è¢«å¹¿æ³›é‡‡ç”¨çš„ä¸€ç§æ¨¡å‹,æˆ‘ä»¬å¯ä»¥å°† TCP / IP æ¨¡å‹çœ‹ä½œæ˜¯ OSI ä¸ƒå±‚æ¨¡å‹çš„ç²¾ç®€ç‰ˆæœ¬ï¼Œç”±ä»¥ä¸‹ 4 å±‚ç»„æˆï¼š</p><ol><li>åº”ç”¨å±‚</li><li>ä¼ è¾“å±‚</li><li>ç½‘ç»œå±‚</li><li>ç½‘ç»œæ¥å£å±‚</li></ol><p>éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œæˆ‘ä»¬å¹¶ä¸èƒ½å°† TCP/IP å››å±‚æ¨¡å‹ å’Œ OSI ä¸ƒå±‚æ¨¡å‹å®Œå…¨ç²¾ç¡®åœ°åŒ¹é…èµ·æ¥ï¼Œä¸è¿‡å¯ä»¥ç®€å•å°†ä¸¤è€…å¯¹åº”èµ·æ¥ï¼Œå¦‚ä¸‹å›¾æ‰€ç¤ºï¼š</p><img src="https://haipeng-lin.oss-cn-shenzhen.aliyuncs.com/202409162242432.png" alt="image-20240916224055514" style="zoom: 50%;" /><blockquote><p>ä¸ºä»€ä¹ˆç½‘ç»œè¦åˆ†å±‚ï¼Ÿ</p></blockquote><ul><li><p><strong>å„å±‚ä¹‹é—´ç›¸äº’ç‹¬ç«‹</strong>ï¼šå„å±‚ä¹‹é—´ç›¸äº’ç‹¬ç«‹ï¼Œå„å±‚ä¹‹é—´ä¸éœ€è¦å…³å¿ƒå…¶ä»–å±‚æ˜¯å¦‚ä½•å®ç°çš„ï¼Œåªéœ€è¦çŸ¥é“è‡ªå·±å¦‚ä½•è°ƒç”¨ä¸‹å±‚æä¾›å¥½çš„åŠŸèƒ½å°±å¯ä»¥äº†ï¼ˆå¯ä»¥ç®€å•ç†è§£ä¸ºæ¥å£è°ƒç”¨ï¼‰<strong>ã€‚è¿™ä¸ªå’Œæˆ‘ä»¬å¯¹å¼€å‘æ—¶ç³»ç»Ÿè¿›è¡Œåˆ†å±‚æ˜¯ä¸€ä¸ªé“ç†ã€‚</strong></p></li><li><p><strong>æé«˜äº†çµæ´»æ€§å’Œå¯æ›¿æ¢æ€§</strong>ï¼šæ¯ä¸€å±‚éƒ½å¯ä»¥ä½¿ç”¨æœ€é€‚åˆçš„æŠ€æœ¯æ¥å®ç°ï¼Œä½ åªéœ€è¦ä¿è¯ä½ æä¾›çš„åŠŸèƒ½ä»¥åŠæš´éœ²çš„æ¥å£çš„è§„åˆ™æ²¡æœ‰æ”¹å˜å°±è¡Œäº†ã€‚å¹¶ä¸”ï¼Œæ¯ä¸€å±‚éƒ½å¯ä»¥æ ¹æ®éœ€è¦è¿›è¡Œä¿®æ”¹æˆ–æ›¿æ¢ï¼Œè€Œä¸ä¼šå½±å“åˆ°æ•´ä¸ªç½‘ç»œçš„ç»“æ„ã€‚<strong>è¿™ä¸ªå’Œæˆ‘ä»¬å¹³æ—¶å¼€å‘ç³»ç»Ÿçš„æ—¶å€™è¦æ±‚çš„é«˜å†…èšã€ä½è€¦åˆçš„åŸåˆ™ä¹Ÿæ˜¯å¯ä»¥å¯¹åº”ä¸Šçš„ã€‚</strong></p></li><li><p><strong>å¤§é—®é¢˜åŒ–å°</strong>ï¼šåˆ†å±‚å¯ä»¥å°†å¤æ‚çš„ç½‘ç»œé—®é¢˜åˆ†è§£ä¸ºè®¸å¤šæ¯”è¾ƒå°çš„ã€ç•Œçº¿æ¯”è¾ƒæ¸…æ™°ç®€å•çš„å°é—®é¢˜æ¥å¤„ç†å’Œè§£å†³ã€‚è¿™æ ·ä½¿å¾—å¤æ‚çš„è®¡ç®—æœºç½‘ç»œç³»ç»Ÿå˜å¾—æ˜“äºè®¾è®¡ï¼Œå®ç°å’Œæ ‡å‡†åŒ–ã€‚ <strong>è¿™ä¸ªå’Œæˆ‘ä»¬å¹³æ—¶å¼€å‘çš„æ—¶å€™ï¼Œä¸€èˆ¬ä¼šå°†ç³»ç»ŸåŠŸèƒ½åˆ†è§£ï¼Œç„¶åå°†å¤æ‚çš„é—®é¢˜åˆ†è§£ä¸ºå®¹æ˜“ç†è§£çš„æ›´å°çš„é—®é¢˜æ˜¯ç›¸å¯¹åº”çš„ï¼Œè¿™äº›è¾ƒå°çš„é—®é¢˜å…·æœ‰æ›´å¥½çš„è¾¹ç•Œï¼ˆç›®æ ‡å’Œæ¥å£ï¼‰å®šä¹‰ã€‚</strong></p></li></ul><h3 id="13åº”ç”¨å±‚å¸¸è§çš„åè®®"><a class="markdownIt-Anchor" href="#13åº”ç”¨å±‚å¸¸è§çš„åè®®"></a> 1.3åº”ç”¨å±‚å¸¸è§çš„åè®®</h3><p><img src="https://haipeng-lin.oss-cn-shenzhen.aliyuncs.com/202409162242285.png" alt="image-20240319183654966" /></p><ul><li><strong>HTTPï¼ˆHypertext Transfer Protocolï¼Œè¶…æ–‡æœ¬ä¼ è¾“åè®®ï¼‰</strong>ï¼šåŸºäº TCP åè®®ï¼Œæ˜¯ä¸€ç§ç”¨äºä¼ è¾“è¶…æ–‡æœ¬å’Œå¤šåª’ä½“å†…å®¹çš„åè®®ï¼Œä¸»è¦æ˜¯ä¸º Web æµè§ˆå™¨ä¸ Web æœåŠ¡å™¨ä¹‹é—´çš„é€šä¿¡è€Œè®¾è®¡çš„ã€‚å½“æˆ‘ä»¬ä½¿ç”¨æµè§ˆå™¨æµè§ˆç½‘é¡µçš„æ—¶å€™ï¼Œæˆ‘ä»¬ç½‘é¡µå°±æ˜¯é€šè¿‡ HTTP è¯·æ±‚è¿›è¡ŒåŠ è½½çš„ã€‚</li><li><strong>SMTPï¼ˆSimple Mail Transfer Protocolï¼Œç®€å•é‚®ä»¶å‘é€åè®®ï¼‰</strong>ï¼šåŸºäº TCP åè®®ï¼Œæ˜¯ä¸€ç§ç”¨äºå‘é€ç”µå­é‚®ä»¶çš„åè®®ã€‚æ³¨æ„ âš ï¸ï¼šSMTP åè®®åªè´Ÿè´£é‚®ä»¶çš„å‘é€ï¼Œè€Œä¸æ˜¯æ¥æ”¶ã€‚è¦ä»é‚®ä»¶æœåŠ¡å™¨æ¥æ”¶é‚®ä»¶ï¼Œéœ€è¦ä½¿ç”¨ POP3 æˆ– IMAP åè®®ã€‚</li><li><strong>POP3/IMAPï¼ˆé‚®ä»¶æ¥æ”¶åè®®ï¼‰</strong>ï¼šåŸºäº TCP åè®®ï¼Œä¸¤è€…éƒ½æ˜¯è´Ÿè´£é‚®ä»¶æ¥æ”¶çš„åè®®ã€‚IMAP åè®®æ˜¯æ¯” POP3 æ›´æ–°çš„åè®®ï¼Œå®ƒåœ¨åŠŸèƒ½å’Œæ€§èƒ½ä¸Šéƒ½æ›´åŠ å¼ºå¤§ã€‚IMAP æ”¯æŒé‚®ä»¶æœç´¢ã€æ ‡è®°ã€åˆ†ç±»ã€å½’æ¡£ç­‰é«˜çº§åŠŸèƒ½ï¼Œè€Œä¸”å¯ä»¥åœ¨å¤šä¸ªè®¾å¤‡ä¹‹é—´åŒæ­¥é‚®ä»¶çŠ¶æ€ã€‚å‡ ä¹æ‰€æœ‰ç°ä»£ç”µå­é‚®ä»¶å®¢æˆ·ç«¯å’ŒæœåŠ¡å™¨éƒ½æ”¯æŒ IMAPã€‚</li><li><strong>FTPï¼ˆFile Transfer Protocolï¼Œæ–‡ä»¶ä¼ è¾“åè®®ï¼‰</strong> : åŸºäº TCP åè®®ï¼Œæ˜¯ä¸€ç§ç”¨äºåœ¨è®¡ç®—æœºä¹‹é—´ä¼ è¾“æ–‡ä»¶çš„åè®®ï¼Œå¯ä»¥å±è”½æ“ä½œç³»ç»Ÿå’Œæ–‡ä»¶å­˜å‚¨æ–¹å¼ã€‚æ³¨æ„ âš ï¸ï¼šFTP æ˜¯ä¸€ç§ä¸å®‰å…¨çš„åè®®ï¼Œå› ä¸ºå®ƒåœ¨ä¼ è¾“è¿‡ç¨‹ä¸­ä¸ä¼šå¯¹æ•°æ®è¿›è¡ŒåŠ å¯†ã€‚å»ºè®®åœ¨ä¼ è¾“æ•æ„Ÿæ•°æ®æ—¶ä½¿ç”¨æ›´å®‰å…¨çš„åè®®ï¼Œå¦‚ SFTPã€‚</li><li><strong>Telnetï¼ˆè¿œç¨‹ç™»é™†åè®®ï¼‰</strong>ï¼šåŸºäº TCP åè®®ï¼Œç”¨äºé€šè¿‡ä¸€ä¸ªç»ˆç«¯ç™»é™†åˆ°å…¶ä»–æœåŠ¡å™¨ã€‚Telnet åè®®çš„æœ€å¤§ç¼ºç‚¹ä¹‹ä¸€æ˜¯æ‰€æœ‰æ•°æ®ï¼ˆåŒ…æ‹¬ç”¨æˆ·åå’Œå¯†ç ï¼‰å‡ä»¥æ˜æ–‡å½¢å¼å‘é€ï¼Œè¿™æœ‰æ½œåœ¨çš„å®‰å…¨é£é™©ã€‚è¿™å°±æ˜¯ä¸ºä»€ä¹ˆå¦‚ä»Šå¾ˆå°‘ä½¿ç”¨ Telnetï¼Œè€Œæ˜¯ä½¿ç”¨ä¸€ç§ç§°ä¸º SSH çš„éå¸¸å®‰å…¨çš„ç½‘ç»œä¼ è¾“åè®®çš„ä¸»è¦åŸå› ã€‚</li><li><strong>SSHï¼ˆSecure Shell Protocolï¼Œå®‰å…¨çš„ç½‘ç»œä¼ è¾“åè®®ï¼‰</strong>ï¼šåŸºäº TCP åè®®ï¼Œé€šè¿‡åŠ å¯†å’Œè®¤è¯æœºåˆ¶å®ç°å®‰å…¨çš„è®¿é—®å’Œæ–‡ä»¶ä¼ è¾“ç­‰ä¸šåŠ¡</li><li><strong>RTPï¼ˆReal-time Transport Protocolï¼Œå®æ—¶ä¼ è¾“åè®®ï¼‰</strong>ï¼šé€šå¸¸åŸºäº UDP åè®®ï¼Œä½†ä¹Ÿæ”¯æŒ TCP åè®®ã€‚å®ƒæä¾›äº†ç«¯åˆ°ç«¯çš„å®æ—¶ä¼ è¾“æ•°æ®çš„åŠŸèƒ½ï¼Œä½†ä¸åŒ…å«èµ„æºé¢„ç•™å­˜ã€ä¸ä¿è¯å®æ—¶ä¼ è¾“è´¨é‡ï¼Œè¿™äº›åŠŸèƒ½ç”± WebRTC å®ç°ã€‚</li><li><strong>DNSï¼ˆDomain Name Systemï¼ŒåŸŸåç®¡ç†ç³»ç»Ÿï¼‰</strong>: åŸºäº UDP åè®®ï¼Œç”¨äºè§£å†³åŸŸåå’Œ IP åœ°å€çš„æ˜ å°„é—®é¢˜ã€‚</li></ul><h3 id="14ç½‘ç»œå±‚å¸¸è§çš„åè®®"><a class="markdownIt-Anchor" href="#14ç½‘ç»œå±‚å¸¸è§çš„åè®®"></a> 1.4ç½‘ç»œå±‚å¸¸è§çš„åè®®</h3><ul><li><strong>IPï¼ˆInternet Protocolï¼Œç½‘é™…åè®®ï¼‰</strong>ï¼šTCP/IP åè®®ä¸­æœ€é‡è¦çš„åè®®ä¹‹ä¸€ï¼Œå±äºç½‘ç»œå±‚çš„åè®®ï¼Œä¸»è¦ä½œç”¨æ˜¯å®šä¹‰æ•°æ®åŒ…çš„æ ¼å¼ã€å¯¹æ•°æ®åŒ…è¿›è¡Œè·¯ç”±å’Œå¯»å€ï¼Œä»¥ä¾¿å®ƒä»¬å¯ä»¥è·¨ç½‘ç»œä¼ æ’­å¹¶åˆ°è¾¾æ­£ç¡®çš„ç›®çš„åœ°ã€‚ç›®å‰ IP åè®®ä¸»è¦åˆ†ä¸ºä¸¤ç§ï¼Œä¸€ç§æ˜¯è¿‡å»çš„ IPv4ï¼Œå¦ä¸€ç§æ˜¯è¾ƒæ–°çš„ IPv6ï¼Œç›®å‰è¿™ä¸¤ç§åè®®éƒ½åœ¨ä½¿ç”¨ï¼Œä½†åè€…å·²ç»è¢«æè®®æ¥å–ä»£å‰è€…ã€‚</li><li><strong>ARPï¼ˆAddress Resolution Protocolï¼Œåœ°å€è§£æåè®®ï¼‰</strong>ï¼šARP åè®®è§£å†³çš„æ˜¯ç½‘ç»œå±‚åœ°å€å’Œé“¾è·¯å±‚åœ°å€ä¹‹é—´çš„è½¬æ¢é—®é¢˜ã€‚å› ä¸ºä¸€ä¸ª IP æ•°æ®æŠ¥åœ¨ç‰©ç†ä¸Šä¼ è¾“çš„è¿‡ç¨‹ä¸­ï¼Œæ€»æ˜¯éœ€è¦çŸ¥é“ä¸‹ä¸€è·³ï¼ˆç‰©ç†ä¸Šçš„ä¸‹ä¸€ä¸ªç›®çš„åœ°ï¼‰è¯¥å»å¾€ä½•å¤„ï¼Œä½† IP åœ°å€å±äºé€»è¾‘åœ°å€ï¼Œè€Œ MAC åœ°å€æ‰æ˜¯ç‰©ç†åœ°å€ï¼ŒARP åè®®è§£å†³äº† IP åœ°å€è½¬ MAC åœ°å€çš„ä¸€äº›é—®é¢˜ã€‚</li><li><strong>ICMPï¼ˆInternet Control Message Protocolï¼Œäº’è”ç½‘æ§åˆ¶æŠ¥æ–‡åè®®ï¼‰</strong>ï¼šä¸€ç§ç”¨äºä¼ è¾“ç½‘ç»œçŠ¶æ€å’Œé”™è¯¯æ¶ˆæ¯çš„åè®®ï¼Œå¸¸ç”¨äºç½‘ç»œè¯Šæ–­å’Œæ•…éšœæ’é™¤ã€‚ä¾‹å¦‚ï¼ŒPing å·¥å…·å°±ä½¿ç”¨äº† ICMP åè®®æ¥æµ‹è¯•ç½‘ç»œè¿é€šæ€§ã€‚</li><li><strong>NATï¼ˆNetwork Address Translationï¼Œç½‘ç»œåœ°å€è½¬æ¢åè®®ï¼‰</strong>ï¼šNAT åè®®çš„åº”ç”¨åœºæ™¯å¦‚åŒå®ƒçš„åç§°â€”â€”ç½‘ç»œåœ°å€è½¬æ¢ï¼Œåº”ç”¨äºå†…éƒ¨ç½‘åˆ°å¤–éƒ¨ç½‘çš„åœ°å€è½¬æ¢è¿‡ç¨‹ä¸­ã€‚å…·ä½“åœ°è¯´ï¼Œåœ¨ä¸€ä¸ªå°çš„å­ç½‘ï¼ˆå±€åŸŸç½‘ï¼ŒLANï¼‰å†…ï¼Œå„ä¸»æœºä½¿ç”¨çš„æ˜¯åŒä¸€ä¸ª LAN ä¸‹çš„ IP åœ°å€ï¼Œä½†åœ¨è¯¥ LAN ä»¥å¤–ï¼Œåœ¨å¹¿åŸŸç½‘ï¼ˆWANï¼‰ä¸­ï¼Œéœ€è¦ä¸€ä¸ªç»Ÿä¸€çš„ IP åœ°å€æ¥æ ‡è¯†è¯¥ LAN åœ¨æ•´ä¸ª Internet ä¸Šçš„ä½ç½®ã€‚</li><li><strong>OSPFï¼ˆOpen Shortest Path Firstï¼Œå¼€æ”¾å¼æœ€çŸ­è·¯å¾„ä¼˜å…ˆï¼‰</strong> ï¼‰ï¼šä¸€ç§å†…éƒ¨ç½‘å…³åè®®ï¼ˆInterior Gateway Protocolï¼ŒIGPï¼‰ï¼Œä¹Ÿæ˜¯å¹¿æ³›ä½¿ç”¨çš„ä¸€ç§åŠ¨æ€è·¯ç”±åè®®ï¼ŒåŸºäºé“¾è·¯çŠ¶æ€ç®—æ³•ï¼Œè€ƒè™‘äº†é“¾è·¯çš„å¸¦å®½ã€å»¶è¿Ÿç­‰å› ç´ æ¥é€‰æ‹©æœ€ä½³è·¯å¾„ã€‚</li><li><strong>RIP(Routing Information Protocolï¼Œè·¯ç”±ä¿¡æ¯åè®®ï¼‰</strong>ï¼šä¸€ç§å†…éƒ¨ç½‘å…³åè®®ï¼ˆInterior Gateway Protocolï¼ŒIGPï¼‰ï¼Œä¹Ÿæ˜¯ä¸€ç§åŠ¨æ€è·¯ç”±åè®®ï¼ŒåŸºäºè·ç¦»å‘é‡ç®—æ³•ï¼Œä½¿ç”¨å›ºå®šçš„è·³æ•°ä½œä¸ºåº¦é‡æ ‡å‡†ï¼Œé€‰æ‹©è·³æ•°æœ€å°‘çš„è·¯å¾„ä½œä¸ºæœ€ä½³è·¯å¾„ã€‚</li><li><strong>BGPï¼ˆBorder Gateway Protocolï¼Œè¾¹ç•Œç½‘å…³åè®®ï¼‰</strong>ï¼šä¸€ç§ç”¨æ¥åœ¨è·¯ç”±é€‰æ‹©åŸŸä¹‹é—´äº¤æ¢ç½‘ç»œå±‚å¯è¾¾æ€§ä¿¡æ¯ï¼ˆNetwork Layer Reachability Informationï¼ŒNLRIï¼‰çš„è·¯ç”±é€‰æ‹©åè®®ï¼Œå…·æœ‰é«˜åº¦çš„çµæ´»æ€§å’Œå¯æ‰©å±•æ€§</li></ul><h2 id="2http"><a class="markdownIt-Anchor" href="#2http"></a> 2.HTTP</h2><h3 id="21ç”¨æˆ·ä»æµè§ˆå™¨è¾“å…¥urlåˆ°é¡µé¢çš„å›½è¿‡ç¨‹"><a class="markdownIt-Anchor" href="#21ç”¨æˆ·ä»æµè§ˆå™¨è¾“å…¥urlåˆ°é¡µé¢çš„å›½è¿‡ç¨‹"></a> 2.1ç”¨æˆ·ä»æµè§ˆå™¨è¾“å…¥URLåˆ°é¡µé¢çš„å›½è¿‡ç¨‹</h3><p>æ€»ä½“æ¥è¯´åˆ†ä¸ºä»¥ä¸‹å‡ ä¸ªæ­¥éª¤:</p><ol><li>åœ¨æµè§ˆå™¨ä¸­è¾“å…¥æŒ‡å®šç½‘é¡µçš„ URLã€‚</li><li>æµè§ˆå™¨<mark>é€šè¿‡ DNS åè®®ï¼Œè·å–åŸŸåå¯¹åº”çš„ IP åœ°å€</mark>ã€‚</li><li>æµè§ˆå™¨æ ¹æ® IP åœ°å€å’Œç«¯å£å·ï¼Œå‘<mark>ç›®æ ‡æœåŠ¡å™¨å‘èµ·ä¸€ä¸ª TCP è¿æ¥è¯·</mark>æ±‚ã€‚</li><li>æµè§ˆå™¨åœ¨ TCP è¿æ¥ä¸Šï¼Œå‘æœåŠ¡å™¨<mark>å‘é€ä¸€ä¸ª HTTP è¯·æ±‚æŠ¥æ–‡</mark>ï¼Œè¯·æ±‚è·å–ç½‘é¡µçš„å†…å®¹ã€‚</li><li>æœåŠ¡å™¨æ”¶åˆ° HTTP è¯·æ±‚æŠ¥æ–‡åï¼Œå¤„ç†è¯·æ±‚ï¼Œå¹¶<mark>è¿”å› HTTP å“åº”æŠ¥æ–‡</mark>ç»™æµè§ˆå™¨ã€‚</li><li>æµè§ˆå™¨æ”¶åˆ° HTTP å“åº”æŠ¥æ–‡åï¼Œ<mark>è§£æå“åº”ä½“ä¸­çš„ HTML ä»£ç </mark>ï¼Œæ¸²æŸ“ç½‘é¡µçš„ç»“æ„å’Œæ ·å¼ï¼ŒåŒæ—¶æ ¹æ® HTML ä¸­çš„å…¶ä»–èµ„æºçš„ URLï¼ˆå¦‚å›¾ç‰‡ã€CSSã€JS ç­‰ï¼‰ï¼Œå†æ¬¡å‘èµ· HTTP è¯·æ±‚ï¼Œè·å–è¿™äº›èµ„æºçš„å†…å®¹ï¼Œç›´åˆ°ç½‘é¡µå®Œå…¨åŠ è½½æ˜¾ç¤ºã€‚</li><li>æµè§ˆå™¨åœ¨ä¸éœ€è¦å’ŒæœåŠ¡å™¨é€šä¿¡æ—¶ï¼Œ<mark>å¯ä»¥ä¸»åŠ¨å…³é—­ TCP è¿æ¥</mark>ï¼Œæˆ–è€…ç­‰å¾…æœåŠ¡å™¨çš„å…³é—­è¯·æ±‚</li></ol><h3 id="22httpå’Œhttpsçš„åŒºåˆ«"><a class="markdownIt-Anchor" href="#22httpå’Œhttpsçš„åŒºåˆ«"></a> 2.2HTTPå’ŒHTTPSçš„åŒºåˆ«</h3><p><img src="https://haipeng-lin.oss-cn-shenzhen.aliyuncs.com/202409162245862.png" alt="HTTP å’Œ HTTPS å¯¹æ¯”" /></p><ul><li><mark>ç«¯å£å·</mark>ï¼šHTTP é»˜è®¤æ˜¯ 80ï¼ŒHTTPS é»˜è®¤æ˜¯ 443ã€‚</li><li><mark>URL å‰ç¼€</mark>ï¼šHTTP çš„ URL å‰ç¼€æ˜¯ <code>http://</code>ï¼ŒHTTPS çš„ URL å‰ç¼€æ˜¯ <code>https://</code>ã€‚</li><li><mark>å®‰å…¨æ€§å’Œèµ„æºæ¶ˆè€—</mark>ï¼šHTTP åè®®è¿è¡Œåœ¨ TCP ä¹‹ä¸Šï¼Œæ‰€æœ‰ä¼ è¾“çš„å†…å®¹éƒ½æ˜¯æ˜æ–‡ï¼Œå®¢æˆ·ç«¯å’ŒæœåŠ¡å™¨ç«¯éƒ½æ— æ³•éªŒè¯å¯¹æ–¹çš„èº«ä»½ã€‚HTTPS æ˜¯è¿è¡Œåœ¨ SSL/TLS ä¹‹ä¸Šçš„ HTTP åè®®ï¼ŒSSL/TLS è¿è¡Œåœ¨ TCP ä¹‹ä¸Šã€‚æ‰€æœ‰ä¼ è¾“çš„å†…å®¹éƒ½ç»è¿‡åŠ å¯†ï¼ŒåŠ å¯†é‡‡ç”¨å¯¹ç§°åŠ å¯†ï¼Œä½†å¯¹ç§°åŠ å¯†çš„å¯†é’¥ç”¨æœåŠ¡å™¨æ–¹çš„è¯ä¹¦è¿›è¡Œäº†éå¯¹ç§°åŠ å¯†ã€‚æ‰€ä»¥è¯´ï¼ŒHTTP å®‰å…¨æ€§æ²¡æœ‰ HTTPS é«˜ï¼Œä½†æ˜¯ HTTPS æ¯” HTTP è€—è´¹æ›´å¤šæœåŠ¡å™¨èµ„æºã€‚</li><li><mark>SEOï¼ˆæœç´¢å¼•æ“ä¼˜åŒ–ï¼‰</mark>ï¼šæœç´¢å¼•æ“é€šå¸¸ä¼šæ›´é’çä½¿ç”¨ HTTPS åè®®çš„ç½‘ç«™ï¼Œå› ä¸º HTTPS èƒ½å¤Ÿæä¾›æ›´é«˜çš„å®‰å…¨æ€§å’Œç”¨æˆ·éšç§ä¿æŠ¤ã€‚ä½¿ç”¨ HTTPS åè®®çš„ç½‘ç«™åœ¨æœç´¢ç»“æœä¸­å¯èƒ½ä¼šè¢«ä¼˜å…ˆæ˜¾ç¤ºï¼Œä»è€Œå¯¹ SEO äº§ç”Ÿå½±å“ã€‚</li></ul><h3 id="23uriå’Œurlçš„åŒºåˆ«"><a class="markdownIt-Anchor" href="#23uriå’Œurlçš„åŒºåˆ«"></a> 2.3URIå’ŒURLçš„åŒºåˆ«</h3><ul><li>URI(Uniform Resource Identifier) æ˜¯<mark>ç»Ÿä¸€èµ„æºæ ‡å¿—ç¬¦</mark>ï¼Œå¯ä»¥<mark>å”¯ä¸€æ ‡è¯†ä¸€ä¸ªèµ„æº</mark>ã€‚</li><li>URL(Uniform Resource Locator) æ˜¯<mark>ç»Ÿä¸€èµ„æºå®šä½ç¬¦</mark>ï¼Œå¯ä»¥<mark>æä¾›è¯¥èµ„æºçš„è·¯å¾„</mark>ã€‚å®ƒæ˜¯ä¸€ç§å…·ä½“çš„ URIï¼Œå³ URL å¯ä»¥ç”¨æ¥æ ‡è¯†ä¸€ä¸ªèµ„æºï¼Œè€Œä¸”è¿˜æŒ‡æ˜äº†å¦‚ä½• locate è¿™ä¸ªèµ„æºã€‚</li></ul><p><mark>URI çš„ä½œç”¨åƒèº«ä»½è¯å·ä¸€æ ·</mark>ï¼Œ<mark>URL çš„ä½œç”¨æ›´åƒå®¶åº­ä½å€ä¸€æ ·</mark>ã€‚URL æ˜¯ä¸€ç§å…·ä½“çš„ URIï¼Œå®ƒä¸ä»…å”¯ä¸€æ ‡è¯†èµ„æºï¼Œè€Œä¸”è¿˜æä¾›äº†å®šä½è¯¥èµ„æºçš„ä¿¡æ¯ã€‚</p><h3 id="24getå’Œpostçš„åŒºåˆ«"><a class="markdownIt-Anchor" href="#24getå’Œpostçš„åŒºåˆ«"></a> 2.4GETå’ŒPOSTçš„åŒºåˆ«</h3><p>GET å’Œ POST æ˜¯ HTTP åè®®ä¸­ä¸¤ç§å¸¸ç”¨çš„è¯·æ±‚æ–¹æ³•ï¼Œå®ƒä»¬åœ¨ä¸åŒçš„åœºæ™¯å’Œç›®çš„ä¸‹æœ‰ä¸åŒçš„ç‰¹ç‚¹å’Œç”¨æ³•ã€‚ä¸€èˆ¬æ¥è¯´ï¼Œå¯ä»¥ä»ä»¥ä¸‹å‡ ä¸ªæ–¹é¢æ¥åŒºåˆ†äºŒè€…ï¼ˆé‡ç‚¹ææ¸…ä¸¤è€…åœ¨è¯­ä¹‰ä¸Šçš„åŒºåˆ«å³å¯ï¼‰ï¼š</p><ol><li><mark>è¯­ä¹‰ï¼ˆä¸»è¦åŒºåˆ«ï¼‰</mark><ul><li>GET é€šå¸¸ç”¨äºè·å–æˆ–æŸ¥è¯¢èµ„æº</li><li>POST é€šå¸¸ç”¨äºåˆ›å»ºæˆ–ä¿®æ”¹èµ„æºã€‚</li></ul></li><li><mark>è¯·æ±‚å‚æ•°æ ¼å¼</mark><ul><li>GET è¯·æ±‚çš„å‚æ•°é€šå¸¸æ”¾åœ¨ URL ä¸­ï¼Œå½¢æˆæŸ¥è¯¢å­—ç¬¦ä¸²ï¼ˆquerystringï¼‰ï¼ŒGET è¯·æ±‚çš„ URL é•¿åº¦å—åˆ°æµè§ˆå™¨å’ŒæœåŠ¡å™¨çš„é™åˆ¶</li><li>POST è¯·æ±‚çš„å‚æ•°é€šå¸¸æ”¾åœ¨è¯·æ±‚ä½“ï¼ˆbodyï¼‰ä¸­ï¼Œ<mark>å¯ä»¥æœ‰å¤šç§ç¼–ç æ ¼å¼ï¼Œå¦‚ application/x-www-form-urlencodedã€multipart/form-dataã€application/json</mark> ç­‰ã€‚è€Œ POST è¯·æ±‚çš„ body å¤§å°åˆ™æ²¡æœ‰æ˜ç¡®çš„é™åˆ¶ã€‚</li></ul></li><li><mark>ç¼“å­˜</mark><ul><li>ç”±äº GET è¯·æ±‚æ˜¯å¹‚ç­‰çš„ï¼Œå®ƒå¯ä»¥è¢«æµè§ˆå™¨æˆ–å…¶ä»–ä¸­é—´èŠ‚ç‚¹ï¼ˆå¦‚ä»£ç†ã€ç½‘å…³ï¼‰ç¼“å­˜èµ·æ¥ï¼Œä»¥æé«˜æ€§èƒ½å’Œæ•ˆç‡</li><li>POST è¯·æ±‚åˆ™ä¸é€‚åˆè¢«ç¼“å­˜ï¼Œå› ä¸ºå®ƒå¯èƒ½æœ‰å‰¯ä½œç”¨ï¼Œæ¯æ¬¡æ‰§è¡Œå¯èƒ½éœ€è¦å®æ—¶çš„å“åº”ã€‚</li></ul></li><li><mark>å®‰å…¨æ€§</mark><ul><li>GET è¯·æ±‚å’Œ POST è¯·æ±‚å¦‚æœä½¿ç”¨ HTTP åè®®çš„è¯ï¼Œé‚£éƒ½ä¸å®‰å…¨ï¼Œå› ä¸º <mark>HTTP åè®®æœ¬èº«æ˜¯æ˜æ–‡ä¼ è¾“</mark>çš„ï¼Œ</li><li><mark>ä¸¤è€…å¿…é¡»ä½¿ç”¨ HTTPS åè®®æ¥åŠ å¯†ä¼ è¾“æ•°æ®</mark>ã€‚å¦å¤–ï¼ŒGET è¯·æ±‚ç›¸æ¯” POST è¯·æ±‚æ›´å®¹æ˜“æ³„éœ²æ•æ„Ÿæ•°æ®ï¼Œå› ä¸º GET è¯·æ±‚çš„å‚æ•°é€šå¸¸æ”¾åœ¨ URL ä¸­ã€‚</li></ul></li></ol><h2 id="3dns"><a class="markdownIt-Anchor" href="#3dns"></a> 3.DNS</h2><h3 id="31dnsçš„ä½œç”¨"><a class="markdownIt-Anchor" href="#31dnsçš„ä½œç”¨"></a> 3.1DNSçš„ä½œç”¨</h3><p>DNSï¼ˆDomain Name Systemï¼‰åŸŸåç®¡ç†ç³»ç»Ÿï¼Œæ˜¯å½“ç”¨æˆ·ä½¿ç”¨æµè§ˆå™¨è®¿é—®ç½‘å€ä¹‹åï¼Œä½¿ç”¨çš„ç¬¬ä¸€ä¸ªé‡è¦åè®®ã€‚DNS è¦è§£å†³çš„æ˜¯**<mark>åŸŸåå’Œ IP åœ°å€çš„æ˜ å°„é—®é¢˜</mark>**ã€‚</p><p><img src="https://haipeng-lin.oss-cn-shenzhen.aliyuncs.com/202409162254907.png" alt="DNS:åŸŸåç³»ç»Ÿ" /></p><p>åœ¨ä¸€å°ç”µè„‘ä¸Šï¼Œå¯èƒ½å­˜åœ¨æµè§ˆå™¨ DNS ç¼“å­˜ï¼Œæ“ä½œç³»ç»Ÿ DNS ç¼“å­˜ï¼Œè·¯ç”±å™¨ DNS ç¼“å­˜ã€‚å¦‚æœä»¥ä¸Šç¼“å­˜éƒ½æŸ¥è¯¢ä¸åˆ°ï¼Œé‚£ä¹ˆ DNS å°±é—ªäº®ç™»åœºäº†ã€‚</p><p>ç›®å‰ DNS çš„è®¾è®¡é‡‡ç”¨çš„æ˜¯åˆ†å¸ƒå¼ã€å±‚æ¬¡æ•°æ®åº“ç»“æ„ï¼Œ<strong>DNS æ˜¯<mark>åº”ç”¨å±‚åè®®</mark>ï¼Œå®ƒå¯ä»¥åœ¨ UDP æˆ– TCP åè®®ä¹‹ä¸Šè¿è¡Œï¼Œç«¯å£ä¸º 53</strong> ã€‚</p><h3 id="32dnsæœåŠ¡å™¨çš„ç±»å‹"><a class="markdownIt-Anchor" href="#32dnsæœåŠ¡å™¨çš„ç±»å‹"></a> 3.2DNSæœåŠ¡å™¨çš„ç±»å‹</h3><p>DNS æœåŠ¡å™¨è‡ªåº•å‘ä¸Šå¯ä»¥ä¾æ¬¡åˆ†ä¸ºä»¥ä¸‹å‡ ä¸ªå±‚çº§(æ‰€æœ‰ DNS æœåŠ¡å™¨éƒ½å±äºä»¥ä¸‹å››ä¸ªç±»åˆ«ä¹‹ä¸€):</p><ol><li><mark><strong>æ ¹ DNS æœåŠ¡å™¨</strong></mark>ã€‚æ ¹ DNS æœåŠ¡å™¨æä¾› TLD æœåŠ¡å™¨çš„ IP åœ°å€ã€‚ç›®å‰ä¸–ç•Œä¸Šåªæœ‰ 13 ç»„æ ¹æœåŠ¡å™¨ï¼Œæˆ‘å›½å¢ƒå†…ç›®å‰ä»æ²¡æœ‰æ ¹æœåŠ¡å™¨ã€‚</li><li><mark>é¡¶çº§åŸŸ DNS æœåŠ¡å™¨ï¼ˆTLD æœåŠ¡å™¨ï¼‰</mark>ã€‚é¡¶çº§åŸŸæ˜¯æŒ‡åŸŸåçš„åç¼€ï¼Œå¦‚<code>com</code>ã€<code>org</code>ã€<code>net</code>å’Œ<code>edu</code>ç­‰ã€‚å›½å®¶ä¹Ÿæœ‰è‡ªå·±çš„é¡¶çº§åŸŸï¼Œå¦‚<code>uk</code>ã€<code>fr</code>å’Œ<code>ca</code>ã€‚TLD æœåŠ¡å™¨æä¾›äº†æƒå¨ DNS æœåŠ¡å™¨çš„ IP åœ°å€ã€‚</li><li><mark>æƒå¨ DNS æœåŠ¡å™¨</mark>ã€‚åœ¨å› ç‰¹ç½‘ä¸Šå…·æœ‰å…¬å…±å¯è®¿é—®ä¸»æœºçš„æ¯ä¸ªç»„ç»‡æœºæ„å¿…é¡»æä¾›å…¬å…±å¯è®¿é—®çš„ DNS è®°å½•ï¼Œè¿™äº›è®°å½•å°†è¿™äº›ä¸»æœºçš„åå­—æ˜ å°„ä¸º IP åœ°å€ã€‚</li><li><mark>æœ¬åœ° DNS æœåŠ¡å™¨</mark>ã€‚æ¯ä¸ª ISPï¼ˆäº’è”ç½‘æœåŠ¡æä¾›å•†ï¼‰éƒ½æœ‰ä¸€ä¸ªè‡ªå·±çš„æœ¬åœ° DNS æœåŠ¡å™¨ã€‚å½“ä¸»æœºå‘å‡º DNS è¯·æ±‚æ—¶ï¼Œè¯¥è¯·æ±‚è¢«å‘å¾€æœ¬åœ° DNS æœåŠ¡å™¨ï¼Œå®ƒèµ·ç€ä»£ç†çš„ä½œç”¨ï¼Œå¹¶å°†è¯¥è¯·æ±‚è½¬å‘åˆ° DNS å±‚æ¬¡ç»“æ„ä¸­ã€‚ä¸¥æ ¼è¯´æ¥ï¼Œä¸å±äº DNS å±‚çº§ç»“æ„</li></ol><h2 id="4tcpä¸udp"><a class="markdownIt-Anchor" href="#4tcpä¸udp"></a> 4.TCPä¸UDP</h2><h3 id="41tcpä¸udpçš„åŒºåˆ«"><a class="markdownIt-Anchor" href="#41tcpä¸udpçš„åŒºåˆ«"></a> 4.1TCPä¸UDPçš„åŒºåˆ«</h3><ol><li><p><mark>æ˜¯å¦é¢å‘è¿æ¥</mark>ï¼š</p><ul><li>UDP åœ¨ä¼ é€æ•°æ®ä¹‹å‰ä¸éœ€è¦å…ˆå»ºç«‹è¿æ¥ã€‚</li><li>TCP æä¾›é¢å‘è¿æ¥çš„æœåŠ¡ï¼Œåœ¨ä¼ é€æ•°æ®ä¹‹å‰å¿…é¡»å…ˆå»ºç«‹è¿æ¥ï¼Œæ•°æ®ä¼ é€ç»“æŸåè¦é‡Šæ”¾è¿æ¥ã€‚</li></ul></li><li><p><mark>æ˜¯å¦æ˜¯å¯é ä¼ è¾“</mark>ï¼šè¿œçš„ä¸»æœºåœ¨æ”¶åˆ° UDP æŠ¥æ–‡åï¼Œä¸éœ€è¦ç»™å‡ºä»»ä½•ç¡®è®¤ï¼Œå¹¶ä¸”ä¸ä¿è¯æ•°æ®ä¸ä¸¢å¤±ï¼Œä¸ä¿è¯æ˜¯å¦é¡ºåºåˆ°è¾¾ã€‚TCP æä¾›å¯é çš„ä¼ è¾“æœåŠ¡ï¼ŒTCP åœ¨ä¼ é€’æ•°æ®ä¹‹å‰ï¼Œä¼šæœ‰ä¸‰æ¬¡æ¡æ‰‹æ¥å»ºç«‹è¿æ¥ï¼Œè€Œä¸”åœ¨æ•°æ®ä¼ é€’æ—¶ï¼Œæœ‰ç¡®è®¤ã€çª—å£ã€é‡ä¼ ã€æ‹¥å¡æ§åˆ¶æœºåˆ¶ã€‚é€šè¿‡ TCP è¿æ¥ä¼ è¾“çš„æ•°æ®ï¼Œæ— å·®é”™ã€ä¸ä¸¢å¤±ã€ä¸é‡å¤ã€å¹¶ä¸”æŒ‰åºåˆ°è¾¾ã€‚</p></li><li><p><mark>æ˜¯å¦æœ‰çŠ¶æ€</mark>ï¼šè¿™ä¸ªå’Œä¸Šé¢çš„â€œæ˜¯å¦å¯é ä¼ è¾“â€ç›¸å¯¹åº”ã€‚TCP ä¼ è¾“æ˜¯æœ‰çŠ¶æ€çš„ï¼Œè¿™ä¸ªæœ‰çŠ¶æ€è¯´çš„æ˜¯ TCP ä¼šå»è®°å½•è‡ªå·±å‘é€æ¶ˆæ¯çš„çŠ¶æ€æ¯”å¦‚æ¶ˆæ¯æ˜¯å¦å‘é€äº†ã€æ˜¯å¦è¢«æ¥æ”¶äº†ç­‰ç­‰ã€‚ä¸ºæ­¤ ï¼ŒTCP éœ€è¦ç»´æŒå¤æ‚çš„è¿æ¥çŠ¶æ€è¡¨ã€‚è€Œ UDP æ˜¯æ— çŠ¶æ€æœåŠ¡ï¼Œç®€å•æ¥è¯´å°±æ˜¯ä¸ç®¡å‘å‡ºå»ä¹‹åçš„äº‹æƒ…äº†ï¼ˆ<strong>è¿™å¾ˆæ¸£ç”·ï¼</strong>ï¼‰ã€‚</p></li><li><p><mark>ä¼ è¾“æ•ˆç‡</mark>ï¼šç”±äºä½¿ç”¨ TCP è¿›è¡Œä¼ è¾“çš„æ—¶å€™å¤šäº†è¿æ¥ã€ç¡®è®¤ã€é‡ä¼ ç­‰æœºåˆ¶ï¼Œæ‰€ä»¥ TCP çš„ä¼ è¾“æ•ˆç‡è¦æ¯” UDP ä½å¾ˆå¤šã€‚</p></li><li><p><mark>ä¼ è¾“å½¢å¼</mark>ï¼šTCP æ˜¯é¢å‘å­—èŠ‚æµçš„ï¼ŒUDP æ˜¯é¢å‘æŠ¥æ–‡çš„ã€‚</p></li><li><p><mark>é¦–éƒ¨å¼€é”€</mark>ï¼šTCP é¦–éƒ¨å¼€é”€ï¼ˆ20 ï½ 60 å­—èŠ‚ï¼‰æ¯” UDP é¦–éƒ¨å¼€é”€ï¼ˆ8 å­—èŠ‚ï¼‰è¦å¤§ã€‚</p></li><li><p><mark>æ˜¯å¦æä¾›å¹¿æ’­æˆ–å¤šæ’­æœåŠ¡</mark>ï¼šTCP åªæ”¯æŒç‚¹å¯¹ç‚¹é€šä¿¡ï¼ŒUDP æ”¯æŒä¸€å¯¹ä¸€ã€ä¸€å¯¹å¤šã€å¤šå¯¹ä¸€ã€å¤šå¯¹å¤šï¼›</p></li></ol><table><thead><tr><th style="text-align:center"></th><th style="text-align:center">TCP</th><th style="text-align:center">UDP</th></tr></thead><tbody><tr><td style="text-align:center">æ˜¯å¦é¢å‘è¿æ¥</td><td style="text-align:center">æ˜¯</td><td style="text-align:center">å¦</td></tr><tr><td style="text-align:center">æ˜¯å¦å¯é </td><td style="text-align:center">æ˜¯</td><td style="text-align:center">å¦</td></tr><tr><td style="text-align:center">æ˜¯å¦æœ‰çŠ¶æ€</td><td style="text-align:center">æ˜¯</td><td style="text-align:center">å¦</td></tr><tr><td style="text-align:center">ä¼ è¾“æ•ˆç‡</td><td style="text-align:center">è¾ƒæ…¢</td><td style="text-align:center">è¾ƒå¿«</td></tr><tr><td style="text-align:center">ä¼ è¾“å½¢å¼</td><td style="text-align:center">å­—èŠ‚æµ</td><td style="text-align:center">æ•°æ®æŠ¥æ–‡æ®µ</td></tr><tr><td style="text-align:center">é¦–éƒ¨å¼€é”€</td><td style="text-align:center">20 ï½ 60 bytes</td><td style="text-align:center">8 bytes</td></tr><tr><td style="text-align:center">æ˜¯å¦æä¾›å¹¿æ’­æˆ–å¤šæ’­æœåŠ¡</td><td style="text-align:center">å¦</td><td style="text-align:center">æ˜¯</td></tr></tbody></table><h3 id="42tcpä¸‰æ¬¡æ¡æ‰‹"><a class="markdownIt-Anchor" href="#42tcpä¸‰æ¬¡æ¡æ‰‹"></a> 4.2TCPä¸‰æ¬¡æ¡æ‰‹</h3><p>å»ºç«‹ä¸€ä¸ª TCP è¿æ¥éœ€è¦â€œä¸‰æ¬¡æ¡æ‰‹â€ï¼Œç¼ºä¸€ä¸å¯ï¼š</p><ol><li><strong><mark>ä¸€æ¬¡æ¡æ‰‹</mark></strong>:å®¢æˆ·ç«¯å‘é€å¸¦æœ‰ <mark>SYNï¼ˆSEQ=xï¼‰ æ ‡å¿—</mark>çš„æ•°æ®åŒ… -&gt; æœåŠ¡ç«¯ï¼Œç„¶åå®¢æˆ·ç«¯è¿›å…¥ <strong>SYN_SEND</strong> çŠ¶æ€ï¼Œç­‰å¾…æœåŠ¡å™¨çš„ç¡®è®¤ï¼›ï¼ˆxä¸ºå®¢æˆ·ç«¯çš„åºåˆ—å·ï¼‰</li><li><strong><mark>äºŒæ¬¡æ¡æ‰‹</mark></strong>:æœåŠ¡ç«¯å‘é€å¸¦æœ‰ <mark>SYN+ACK(SEQ=y,ACK=x+1) æ ‡å¿—</mark>çš„æ•°æ®åŒ… â€“&gt; å®¢æˆ·ç«¯,ç„¶åæœåŠ¡ç«¯è¿›å…¥ <strong>SYN_RECV</strong> çŠ¶æ€ï¼ˆACKå³æœåŠ¡å™¨ç¡®è®¤æ”¶åˆ°å®¢æˆ·ç«¯çš„åºåˆ—å·ï¼ŒååŠ ä¸€è¿”å›ï¼‰</li><li><strong><mark>ä¸‰æ¬¡æ¡æ‰‹</mark></strong>:å®¢æˆ·ç«¯å‘é€å¸¦æœ‰ <mark>ACK(ACK=y+1)</mark> æ ‡å¿—çš„æ•°æ®åŒ… â€“&gt; æœåŠ¡ç«¯ï¼Œç„¶åå®¢æˆ·ç«¯å’ŒæœåŠ¡å™¨ç«¯éƒ½è¿›å…¥<strong>ESTABLISHED</strong> çŠ¶æ€ï¼Œå®Œæˆ TCP ä¸‰æ¬¡æ¡æ‰‹ã€‚</li></ol><h3 id="43ä¸ºä»€ä¹ˆè¦ä¸‰æ¬¡æ¡æ‰‹"><a class="markdownIt-Anchor" href="#43ä¸ºä»€ä¹ˆè¦ä¸‰æ¬¡æ¡æ‰‹"></a> 4.3ä¸ºä»€ä¹ˆè¦ä¸‰æ¬¡æ¡æ‰‹ï¼Ÿ</h3><p>ä¸‰æ¬¡æ¡æ‰‹çš„ç›®çš„æ˜¯<mark>å»ºç«‹å¯é çš„é€šä¿¡ä¿¡é“</mark>ï¼Œè¯´åˆ°é€šè®¯ï¼Œç®€å•æ¥è¯´å°±æ˜¯æ•°æ®çš„å‘é€ä¸æ¥æ”¶ï¼Œè€Œä¸‰æ¬¡æ¡æ‰‹æœ€ä¸»è¦çš„ç›®çš„å°±æ˜¯<mark>åŒæ–¹ç¡®è®¤<strong>è‡ªå·±ä¸å¯¹æ–¹çš„å‘é€ä¸æ¥æ”¶</strong>æ˜¯æ­£å¸¸çš„</mark>ã€‚</p><ol><li><strong><mark>ç¬¬ä¸€æ¬¡æ¡æ‰‹</mark></strong>ï¼šClient ä»€ä¹ˆéƒ½ä¸èƒ½ç¡®è®¤ï¼›<mark>Server ç¡®è®¤äº†å¯¹æ–¹å‘é€æ­£å¸¸</mark>ï¼Œ<mark>è‡ªå·±æ¥æ”¶æ­£å¸¸</mark></li><li><strong><mark>ç¬¬äºŒæ¬¡æ¡æ‰‹</mark></strong>ï¼šClient ç¡®è®¤äº†ï¼šè‡ªå·±å‘é€ã€æ¥æ”¶æ­£å¸¸ï¼Œå¯¹æ–¹å‘é€ã€æ¥æ”¶æ­£å¸¸ï¼›Server ç¡®è®¤äº†ï¼šå¯¹æ–¹å‘é€æ­£å¸¸ï¼Œè‡ªå·±æ¥æ”¶æ­£å¸¸ï¼ˆ<mark><strong>è¿˜å·®ç¡®è®¤è‡ªå·±å‘é€ã€å¯¹æ–¹æ¥é€æ­£å¸¸</strong></mark>ï¼‰</li><li><strong>ç¬¬ä¸‰æ¬¡æ¡æ‰‹</strong>ï¼šClient ç¡®è®¤äº†ï¼šè‡ªå·±å‘é€ã€æ¥æ”¶æ­£å¸¸ï¼Œå¯¹æ–¹å‘é€ã€æ¥æ”¶æ­£å¸¸ï¼›Server ç¡®è®¤äº†ï¼š<mark><strong>è‡ªå·±å‘é€</strong></mark>ã€æ¥æ”¶æ­£å¸¸ï¼Œå¯¹æ–¹å‘é€ã€<mark><strong>æ¥æ”¶æ­£å¸¸</strong></mark></li></ol><table><thead><tr><th style="text-align:center">Clientè§’åº¦</th><th style="text-align:center">ç¬¬ä¸€æ¬¡æ¡æ‰‹</th><th style="text-align:center">ç¬¬äºŒæ¬¡æ¡æ‰‹</th><th style="text-align:center">ç¬¬ä¸‰æ¬¡æ¡æ‰‹</th></tr></thead><tbody><tr><td style="text-align:center">Client è‡ªå·±å‘é€æ­£å¸¸</td><td style="text-align:center"></td><td style="text-align:center">âˆš</td><td style="text-align:center"></td></tr><tr><td style="text-align:center">Server å¯¹æ–¹æ¥æ”¶æ­£å¸¸</td><td style="text-align:center"></td><td style="text-align:center">âˆš</td><td style="text-align:center"></td></tr><tr><td style="text-align:center">Serverå¯¹æ–¹å‘é€æ­£å¸¸</td><td style="text-align:center"></td><td style="text-align:center">âˆš</td><td style="text-align:center"></td></tr><tr><td style="text-align:center">Clientè‡ªå·±æ¥æ”¶æ­£å¸¸</td><td style="text-align:center"></td><td style="text-align:center">âˆš</td><td style="text-align:center"></td></tr></tbody></table><table><thead><tr><th style="text-align:center">Serverè§’åº¦</th><th style="text-align:center">ç¬¬ä¸€æ¬¡æ¡æ‰‹</th><th style="text-align:center">ç¬¬äºŒæ¬¡æ¡æ‰‹</th><th style="text-align:center">ç¬¬ä¸‰æ¬¡æ¡æ‰‹</th></tr></thead><tbody><tr><td style="text-align:center">Client å¯¹æ–¹å‘é€æ­£å¸¸</td><td style="text-align:center">âˆš</td><td style="text-align:center"></td><td style="text-align:center"></td></tr><tr><td style="text-align:center">Server è‡ªå·±æ¥æ”¶æ­£å¸¸</td><td style="text-align:center">âˆš</td><td style="text-align:center"></td><td style="text-align:center"></td></tr><tr><td style="text-align:center">Serverå¯¹æ–¹å‘é€æ­£å¸¸</td><td style="text-align:center"></td><td style="text-align:center"></td><td style="text-align:center"><strong><mark>âˆš</mark></strong></td></tr><tr><td style="text-align:center">Clientè‡ªå·±æ¥æ”¶æ­£å¸¸</td><td style="text-align:center"></td><td style="text-align:center"></td><td style="text-align:center"><strong><mark>âˆš</mark></strong></td></tr></tbody></table><h3 id="44tcpå››æ¬¡æŒ¥æ‰‹"><a class="markdownIt-Anchor" href="#44tcpå››æ¬¡æŒ¥æ‰‹"></a> 4.4TCPå››æ¬¡æŒ¥æ‰‹</h3><p><img src="https://oss.javaguide.cn/github/javaguide/cs-basics/network/tcp-waves-four-times.png" alt="TCP å››æ¬¡æŒ¥æ‰‹å›¾è§£" /></p><p>æ–­å¼€ä¸€ä¸ª TCP è¿æ¥åˆ™éœ€è¦â€œå››æ¬¡æŒ¥æ‰‹â€ï¼Œç¼ºä¸€ä¸å¯ï¼š</p><ol><li><strong>ç¬¬ä¸€æ¬¡æŒ¥æ‰‹</strong>ï¼šå®¢æˆ·ç«¯å‘é€ä¸€ä¸ª FINï¼ˆSEQ=xï¼‰ æ ‡å¿—çš„æ•°æ®åŒ…-&gt;æœåŠ¡ç«¯ï¼Œç”¨æ¥<mark>å…³é—­å®¢æˆ·ç«¯åˆ°æœåŠ¡å™¨çš„æ•°æ®ä¼ é€</mark>ã€‚ç„¶åå®¢æˆ·ç«¯è¿›å…¥ <strong>FIN-WAIT-1</strong> çŠ¶æ€ã€‚</li><li><strong>ç¬¬äºŒæ¬¡æŒ¥æ‰‹</strong>ï¼šæœåŠ¡å™¨æ”¶åˆ°è¿™ä¸ª FINï¼ˆSEQ=Xï¼‰ æ ‡å¿—çš„æ•°æ®åŒ…ï¼Œå®ƒå‘é€ä¸€ä¸ª ACK ï¼ˆACK=x+1ï¼‰æ ‡å¿—çš„æ•°æ®åŒ…-&gt;å®¢æˆ·ç«¯ ã€‚ç„¶å<mark>æœåŠ¡ç«¯è¿›å…¥ <strong>CLOSE-WAIT</strong> çŠ¶æ€</mark>ï¼Œå®¢æˆ·ç«¯è¿›å…¥ <strong>FIN-WAIT-2</strong> çŠ¶æ€ã€‚</li><li><strong>ç¬¬ä¸‰æ¬¡æŒ¥æ‰‹</strong>ï¼šæœåŠ¡ç«¯å‘é€ä¸€ä¸ª FIN (SEQ=y)æ ‡å¿—çš„æ•°æ®åŒ…-&gt;å®¢æˆ·ç«¯ï¼Œ<mark>è¯·æ±‚å…³é—­è¿æ¥</mark>ï¼Œç„¶åæœåŠ¡ç«¯è¿›å…¥ <strong>LAST-ACK</strong> çŠ¶æ€ã€‚</li><li><strong>ç¬¬å››æ¬¡æŒ¥æ‰‹</strong>ï¼šå®¢æˆ·ç«¯å‘é€ ACK (ACK=y+1)æ ‡å¿—çš„æ•°æ®åŒ…-&gt;æœåŠ¡ç«¯ï¼Œç„¶åå®¢æˆ·ç«¯è¿›å…¥<strong>TIME-WAIT</strong>çŠ¶æ€ï¼ŒæœåŠ¡ç«¯åœ¨æ”¶åˆ° ACK (ACK=y+1)æ ‡å¿—çš„æ•°æ®åŒ…åè¿›å…¥ CLOSE çŠ¶æ€ã€‚æ­¤æ—¶å¦‚æœå®¢æˆ·ç«¯ç­‰å¾… <strong>2MSL</strong> åä¾ç„¶æ²¡æœ‰æ”¶åˆ°å›å¤ï¼Œå°±è¯æ˜æœåŠ¡ç«¯å·²æ­£å¸¸å…³é—­ï¼Œéšåå®¢æˆ·ç«¯ä¹Ÿå¯ä»¥å…³é—­è¿æ¥äº†ã€‚</li></ol><p><strong>åªè¦å››æ¬¡æŒ¥æ‰‹æ²¡æœ‰ç»“æŸï¼Œå®¢æˆ·ç«¯å’ŒæœåŠ¡ç«¯å°±å¯ä»¥ç»§ç»­ä¼ è¾“æ•°æ®ï¼</strong></p><h3 id="45ä¸ºä»€ä¹ˆè¦å››æ¬¡æŒ¥æ‰‹"><a class="markdownIt-Anchor" href="#45ä¸ºä»€ä¹ˆè¦å››æ¬¡æŒ¥æ‰‹"></a> 4.5ä¸ºä»€ä¹ˆè¦å››æ¬¡æŒ¥æ‰‹ï¼Ÿ</h3><p>TCP æ˜¯å…¨åŒå·¥é€šä¿¡ï¼Œå¯ä»¥åŒå‘ä¼ è¾“æ•°æ®ã€‚<mark>ä»»ä½•ä¸€æ–¹éƒ½å¯ä»¥åœ¨æ•°æ®ä¼ é€ç»“æŸåå‘å‡ºè¿æ¥é‡Šæ”¾çš„é€šçŸ¥</mark>ï¼Œå¾…å¯¹æ–¹ç¡®è®¤åè¿›å…¥==<strong>åŠå…³é—­çŠ¶æ€</strong>==ã€‚å½“å¦ä¸€æ–¹ä¹Ÿæ²¡æœ‰æ•°æ®å†å‘é€çš„æ—¶å€™ï¼Œåˆ™å‘å‡ºè¿æ¥é‡Šæ”¾é€šçŸ¥ï¼Œå¯¹æ–¹ç¡®è®¤åå°±å®Œå…¨å…³é—­äº† TCP è¿æ¥ã€‚</p><p>ä¸¾ä¸ªä¾‹å­ï¼šA å’Œ B æ‰“ç”µè¯ï¼Œé€šè¯å³å°†ç»“æŸåã€‚</p><ol><li><strong>ç¬¬ä¸€æ¬¡æŒ¥æ‰‹</strong>ï¼šA è¯´â€œæˆ‘æ²¡å•¥è¦è¯´çš„äº†â€</li><li><strong>ç¬¬äºŒæ¬¡æŒ¥æ‰‹</strong>ï¼šB å›ç­”â€œæˆ‘çŸ¥é“äº†â€ï¼Œä½†æ˜¯ <mark>B å¯èƒ½è¿˜ä¼šæœ‰è¦è¯´çš„è¯</mark>ï¼ŒA ä¸èƒ½è¦æ±‚ B è·Ÿç€è‡ªå·±çš„èŠ‚å¥ç»“æŸé€šè¯</li><li><strong>ç¬¬ä¸‰æ¬¡æŒ¥æ‰‹</strong>ï¼šäºæ˜¯ B å¯èƒ½åˆå·´æ‹‰å·´æ‹‰è¯´äº†ä¸€é€šï¼Œæœ€å B è¯´â€œæˆ‘è¯´å®Œäº†â€</li><li><strong>ç¬¬å››æ¬¡æŒ¥æ‰‹</strong>ï¼šA å›ç­”â€œçŸ¥é“äº†â€ï¼Œè¿™æ ·é€šè¯æ‰ç®—ç»“æŸã€‚</li></ol><h3 id="46ä¸ºä»€ä¹ˆä¸èƒ½æŠŠæœåŠ¡å™¨å‘é€çš„ackå’Œfinåˆå¹¶èµ·æ¥å˜æˆä¸‰æ¬¡æŒ¥æ‰‹"><a class="markdownIt-Anchor" href="#46ä¸ºä»€ä¹ˆä¸èƒ½æŠŠæœåŠ¡å™¨å‘é€çš„ackå’Œfinåˆå¹¶èµ·æ¥å˜æˆä¸‰æ¬¡æŒ¥æ‰‹"></a> 4.6ä¸ºä»€ä¹ˆä¸èƒ½æŠŠæœåŠ¡å™¨å‘é€çš„ACKå’ŒFINåˆå¹¶èµ·æ¥ï¼Œå˜æˆä¸‰æ¬¡æŒ¥æ‰‹ï¼Ÿ</h3><p>å› ä¸ºæœåŠ¡å™¨æ”¶åˆ°å®¢æˆ·ç«¯æ–­å¼€è¿æ¥çš„è¯·æ±‚æ—¶ï¼Œ<mark><strong>å¯èƒ½è¿˜æœ‰ä¸€äº›æ•°æ®æ²¡æœ‰å‘å®Œ</strong></mark>ï¼Œè¿™æ—¶<mark>å…ˆå›å¤ ACKï¼Œè¡¨ç¤ºæ¥æ”¶åˆ°äº†æ–­å¼€è¿æ¥çš„è¯·æ±‚</mark>ã€‚ç­‰åˆ°æ•°æ®å‘å®Œä¹‹åå†å‘ FINï¼Œ<mark>æ–­å¼€æœåŠ¡å™¨åˆ°å®¢æˆ·ç«¯çš„æ•°æ®ä¼ é€</mark>ã€‚</p><h3 id="47è‹¥ç¬¬äºŒæ¬¡æŒ¥æ‰‹æ—¶æœåŠ¡å™¨çš„ackæ²¡æœ‰é€è¾¾å®¢æˆ·ç«¯ä¼šæ€ä¹ˆæ ·"><a class="markdownIt-Anchor" href="#47è‹¥ç¬¬äºŒæ¬¡æŒ¥æ‰‹æ—¶æœåŠ¡å™¨çš„ackæ²¡æœ‰é€è¾¾å®¢æˆ·ç«¯ä¼šæ€ä¹ˆæ ·"></a> 4.7è‹¥ç¬¬äºŒæ¬¡æŒ¥æ‰‹æ—¶æœåŠ¡å™¨çš„ACKæ²¡æœ‰é€è¾¾å®¢æˆ·ç«¯ï¼Œä¼šæ€ä¹ˆæ ·ï¼Ÿ</h3><p>å®¢æˆ·ç«¯æ²¡æœ‰æ”¶åˆ° ACK ç¡®è®¤ï¼Œ<mark>ä¼šé‡æ–°å‘é€ FIN è¯·æ±‚</mark>ã€‚</p><h1 id="æ“ä½œç³»ç»Ÿ"><a class="markdownIt-Anchor" href="#æ“ä½œç³»ç»Ÿ"></a> æ“ä½œç³»ç»Ÿ</h1><h2 id="1è¿›ç¨‹çº¿ç¨‹åç¨‹"><a class="markdownIt-Anchor" href="#1è¿›ç¨‹çº¿ç¨‹åç¨‹"></a> 1.è¿›ç¨‹/çº¿ç¨‹/åç¨‹</h2><h3 id="11è¿›ç¨‹å’Œçº¿ç¨‹çš„å¼‚åŒ"><a class="markdownIt-Anchor" href="#11è¿›ç¨‹å’Œçº¿ç¨‹çš„å¼‚åŒ"></a> 1.1è¿›ç¨‹å’Œçº¿ç¨‹çš„å¼‚åŒ</h3><p>è¿›ç¨‹å’Œçº¿ç¨‹ä¹‹é—´çš„åŒºåˆ«å¯ä»¥ä»æœ¬è´¨åŒºåˆ«ã€å¼€é”€æ–¹é¢ã€ç¨³å®šæ€§æ–¹é¢ã€å†…å­˜åˆ†é…æ–¹é¢ã€åŒ…å«å…³ç³»å…±äº”ä¸ªè§’åº¦å»åˆ†æï¼š</p><ol><li><mark>æœ¬è´¨åŒºåˆ«</mark>ï¼š<ul><li>è¿›ç¨‹æ˜¯<mark>æ“ä½œç³»ç»Ÿèµ„æºåˆ†é…</mark>çš„åŸºæœ¬å•ä½ï¼Œæ˜¯ç¨‹åºçš„ä¸€æ¬¡æ‰§è¡Œï¼Œæ¯”å¦‚æˆ‘ä»¬åœ¨ç”µè„‘ä¸Šæ¯å¼€å¯çš„ä¸€æ¬¡å¾®ä¿¡çª—å£</li><li>çº¿ç¨‹æ˜¯<mark>ä»»åŠ¡è°ƒåº¦å’Œæ‰§è¡Œ</mark>çš„åŸºæœ¬å•ä½ï¼Œæ˜¯è¿›ç¨‹çš„ä¸€ä¸ªå®ä½“ï¼Œæ˜¯CPUè°ƒåº¦å’Œåˆ†æ´¾çš„åŸºæœ¬å•ä½</li></ul></li><li><mark>å¼€é”€æ–¹é¢</mark>ï¼š<ul><li>æ¯ä¸ªè¿›ç¨‹éƒ½æœ‰ç‹¬ç«‹çš„ä»£ç å’Œæ•°æ®ç©ºé—´ï¼ˆç¨‹åºä¸Šä¸‹æ–‡ï¼‰ï¼Œ<mark>ç¨‹åºä¹‹é—´çš„åˆ‡æ¢ä¼šæœ‰è¾ƒå¤§çš„å¼€é”€</mark>ï¼›</li><li>çº¿ç¨‹å¯ä»¥çœ‹åšè½»é‡çº§çš„è¿›ç¨‹ï¼ŒåŒä¸€ç±»çº¿ç¨‹å…±äº«ä»£ç å’Œæ•°æ®ç©ºé—´ï¼Œæ¯ä¸ªçº¿ç¨‹éƒ½æœ‰è‡ªå·±ç‹¬ç«‹çš„è¿è¡Œæ ˆå’Œç¨‹åºè®¡æ•°å™¨ï¼ˆPCï¼‰ï¼Œ<mark>çº¿ç¨‹ä¹‹é—´åˆ‡æ¢çš„å¼€é”€å°</mark></li></ul></li><li><mark>å†…å­˜åˆ†é…æ–¹é¢</mark>ï¼š<ul><li>ç³»ç»Ÿåœ¨è¿è¡Œçš„æ—¶å€™<mark>ä¼šä¸ºæ¯ä¸ªè¿›ç¨‹åˆ†é…ä¸åŒçš„å†…å­˜ç©ºé—´</mark></li><li>è€Œå¯¹çº¿ç¨‹è€Œè¨€ï¼Œé™¤äº†CPUå¤–ï¼Œ<mark>ç³»ç»Ÿä¸ä¼šä¸ºçº¿ç¨‹åˆ†é…å†…å­˜</mark>ï¼ˆçº¿ç¨‹æ‰€ä½¿ç”¨çš„èµ„æºæ¥è‡ªå…¶æ‰€å±è¿›ç¨‹çš„èµ„æºï¼‰ï¼Œ<mark>çº¿ç¨‹ç»„ä¹‹é—´åªèƒ½å…±äº«èµ„æº</mark></li></ul></li><li><strong><mark>åŒ…å«å…³ç³»</mark></strong>ï¼š<ul><li>æ²¡æœ‰çº¿ç¨‹çš„è¿›ç¨‹å¯ä»¥çœ‹åšæ˜¯å•çº¿ç¨‹çš„</li><li>å¦‚æœä¸€ä¸ªè¿›ç¨‹å†…æœ‰å¤šä¸ªçº¿ç¨‹ï¼Œåˆ™æ‰§è¡Œè¿‡ç¨‹ä¸æ˜¯ä¸€æ¡çº¿çš„ï¼Œè€Œæ˜¯å¤šæ¡çº¿ï¼ˆçº¿ç¨‹ï¼‰å…±åŒå®Œæˆçš„ï¼›</li><li><mark>çº¿ç¨‹æ˜¯è¿›ç¨‹çš„ä¸€éƒ¨åˆ†</mark>ï¼Œæ‰€ä»¥çº¿ç¨‹ä¹Ÿè¢«ç§°ä¸ºè½»æƒè¿›ç¨‹æˆ–è€…è½»é‡çº§è¿›ç¨‹</li></ul></li></ol><h3 id="12è¿›ç¨‹çº¿ç¨‹ä¼˜ç¼ºç‚¹"><a class="markdownIt-Anchor" href="#12è¿›ç¨‹çº¿ç¨‹ä¼˜ç¼ºç‚¹"></a> 1.2è¿›ç¨‹/çº¿ç¨‹ä¼˜ç¼ºç‚¹</h3><ul><li><p>è¿›ç¨‹ä¼˜ç‚¹ï¼š</p><ul><li>é¡ºåºç¨‹åºçš„ç‰¹ç‚¹ï¼šå…·æœ‰å°é—­æ€§å’Œå¯å†ç°æ€§ï¼›</li><li>ç¨‹åºçš„å¹¶å‘æ‰§è¡Œå’Œèµ„æºå…±äº«ã€‚å¤šé“ç¨‹åºè®¾è®¡å‡ºç°åï¼Œå®ç°äº†ç¨‹åºçš„å¹¶å‘æ‰§è¡Œå’Œèµ„æºå…±äº«ï¼Œæé«˜äº†ç³»ç»Ÿçš„èµ„æºåˆ©ç”¨ç‡</li></ul></li><li><p>è¿›ç¨‹ç¼ºç‚¹ï¼š</p><ul><li>æ“ä½œç³»ç»Ÿè°ƒåº¦<mark>åˆ‡æ¢å¤šä¸ªçº¿ç¨‹è¦æ¯”åˆ‡æ¢è°ƒåº¦è¿›ç¨‹åœ¨é€Ÿåº¦ä¸Šå¿«çš„å¤š</mark>ã€‚</li><li>è€Œä¸”<mark>è¿›ç¨‹é—´å†…å­˜æ— æ³•å…±äº«ï¼Œé€šè®¯ä¹Ÿæ¯”è¾ƒéº»çƒ¦</mark>ã€‚</li></ul></li><li><p>çº¿ç¨‹ä¼˜ç‚¹ï¼š</p><ul><li>çº¿ç¨‹ä¹‹é—´åˆ‡æ¢é€Ÿåº¦å¿«</li><li>çº¿ç¨‹é—´å†…å­˜å…±äº«ï¼Œèµ„æºå…±äº«</li></ul></li><li><p>çº¿ç¨‹ç¼ºç‚¹ï¼š</p><ul><li>è°ƒåº¦æ—¶, è¦ä¿å­˜çº¿ç¨‹çŠ¶æ€ï¼Œé¢‘ç¹è°ƒåº¦, éœ€è¦å ç”¨å¤§é‡çš„æœºæ—¶ï¼›</li><li>ç¨‹åºè®¾è®¡ä¸Šå®¹æ˜“å‡ºé”™ï¼ˆçº¿ç¨‹åŒæ­¥é—®é¢˜ï¼‰</li></ul></li></ul><h3 id="13è¿›ç¨‹ä¹‹é—´é€šä¿¡çš„æ–¹æ³•"><a class="markdownIt-Anchor" href="#13è¿›ç¨‹ä¹‹é—´é€šä¿¡çš„æ–¹æ³•"></a> 1.3è¿›ç¨‹ä¹‹é—´é€šä¿¡çš„æ–¹æ³•</h3><ol><li>ç”±äºæ¯ä¸ª<mark>è¿›ç¨‹çš„ç”¨æˆ·ç©ºé—´éƒ½æ˜¯ç‹¬ç«‹çš„</mark>ï¼Œä¸èƒ½ç›¸äº’è®¿é—®ï¼Œè¿™æ—¶å°±éœ€è¦å€ŸåŠ©å†…æ ¸ç©ºé—´æ¥å®ç°è¿›ç¨‹é—´é€šä¿¡ï¼ŒåŸå› å¾ˆç®€å•ï¼Œæ¯ä¸ªè¿›ç¨‹éƒ½æ˜¯å…±äº«ä¸€ä¸ªå†…æ ¸ç©ºé—´ã€‚</li><li>Linux å†…æ ¸æä¾›äº†ä¸å°‘è¿›ç¨‹é—´é€šä¿¡çš„æ–¹å¼ï¼Œå…¶ä¸­æœ€ç®€å•çš„æ–¹å¼å°±æ˜¯<mark>ç®¡é“ï¼Œç®¡é“åˆ†ä¸ºã€ŒåŒ¿åç®¡é“ã€å’Œã€Œå‘½åç®¡é“ã€</mark>ã€‚<ul><li><strong><mark>åŒ¿åç®¡é“</mark></strong>ï¼šé¡¾åæ€ä¹‰ï¼Œå®ƒæ²¡æœ‰åå­—æ ‡è¯†ï¼ŒåŒ¿åç®¡é“æ˜¯ç‰¹æ®Šæ–‡ä»¶åªå­˜åœ¨äºå†…å­˜ï¼Œæ²¡æœ‰å­˜åœ¨äºæ–‡ä»¶ç³»ç»Ÿä¸­ï¼Œshell å‘½ä»¤ä¸­çš„ã€Œ|ã€ç«–çº¿å°±æ˜¯åŒ¿åç®¡é“ï¼Œé€šä¿¡çš„æ•°æ®æ˜¯<strong>æ— æ ¼å¼çš„æµå¹¶ä¸”å¤§å°å—é™</strong>ï¼Œé€šä¿¡çš„æ–¹å¼æ˜¯<strong>å•å‘</strong>çš„ï¼Œæ•°æ®åªèƒ½åœ¨ä¸€ä¸ªæ–¹å‘ä¸ŠæµåŠ¨ï¼Œå¦‚æœè¦åŒå‘é€šä¿¡ï¼Œéœ€è¦åˆ›å»ºä¸¤ä¸ªç®¡é“ï¼ŒåŒ¿åç®¡é“æ˜¯åªèƒ½**<mark>ç”¨äºå­˜åœ¨çˆ¶å­å…³ç³»</mark>çš„è¿›ç¨‹é—´é€šä¿¡**ï¼ŒåŒ¿åç®¡é“çš„ç”Ÿå‘½å‘¨æœŸéšç€è¿›ç¨‹åˆ›å»ºè€Œå»ºç«‹ï¼Œéšç€è¿›ç¨‹ç»ˆæ­¢è€Œæ¶ˆå¤±ã€‚</li><li><mark><strong>å‘½åç®¡é“</strong></mark>ï¼šçªç ´äº†åŒ¿åç®¡é“åªèƒ½åœ¨äº²ç¼˜å…³ç³»è¿›ç¨‹é—´çš„é€šä¿¡é™åˆ¶ï¼Œå› ä¸ºä½¿ç”¨å‘½åç®¡é“çš„å‰æï¼Œéœ€è¦åœ¨æ–‡ä»¶ç³»ç»Ÿåˆ›å»ºä¸€ä¸ªç±»å‹ä¸º p çš„è®¾å¤‡æ–‡ä»¶ï¼Œé‚£ä¹ˆ<strong>æ¯«æ— å…³ç³»çš„è¿›ç¨‹å°±å¯ä»¥é€šè¿‡è¿™ä¸ªè®¾å¤‡æ–‡ä»¶è¿›è¡Œé€šä¿¡</strong>ã€‚å¦å¤–ï¼Œä¸ç®¡æ˜¯åŒ¿åç®¡é“è¿˜æ˜¯å‘½åç®¡é“ï¼Œè¿›ç¨‹å†™å…¥çš„æ•°æ®éƒ½æ˜¯<strong>ç¼“å­˜åœ¨å†…æ ¸</strong>ä¸­ï¼Œå¦ä¸€ä¸ªè¿›ç¨‹è¯»å–æ•°æ®æ—¶å€™è‡ªç„¶ä¹Ÿæ˜¯ä»å†…æ ¸ä¸­è·å–ï¼ŒåŒæ—¶é€šä¿¡æ•°æ®éƒ½éµå¾ª<strong>å…ˆè¿›å…ˆå‡º</strong>åŸåˆ™ï¼Œä¸æ”¯æŒ lseek ä¹‹ç±»çš„æ–‡ä»¶å®šä½æ“ä½œã€‚</li><li><strong><mark>æ¶ˆæ¯é˜Ÿåˆ—</mark></strong>ï¼šå…‹æœäº†ç®¡é“é€šä¿¡çš„æ•°æ®æ˜¯<strong>æ— æ ¼å¼çš„å­—èŠ‚æµçš„é—®é¢˜</strong>ï¼Œæ¶ˆæ¯é˜Ÿåˆ—å®é™…ä¸Šæ˜¯ä¿å­˜åœ¨å†…æ ¸çš„ã€Œæ¶ˆæ¯é“¾è¡¨ã€ï¼Œæ¶ˆæ¯é˜Ÿåˆ—çš„æ¶ˆæ¯ä½“æ˜¯å¯ä»¥ç”¨æˆ·è‡ªå®šä¹‰çš„æ•°æ®ç±»å‹ï¼Œå‘é€æ•°æ®æ—¶ï¼Œä¼šè¢«åˆ†æˆä¸€ä¸ªä¸€ä¸ªç‹¬ç«‹çš„æ¶ˆæ¯ä½“ï¼Œå½“ç„¶æ¥æ”¶æ•°æ®æ—¶ï¼Œä¹Ÿè¦ä¸å‘é€æ–¹å‘é€çš„æ¶ˆæ¯ä½“çš„æ•°æ®ç±»å‹ä¿æŒä¸€è‡´ï¼Œè¿™æ ·æ‰èƒ½ä¿è¯è¯»å–çš„æ•°æ®æ˜¯æ­£ç¡®çš„ã€‚æ¶ˆæ¯é˜Ÿåˆ—é€šä¿¡çš„é€Ÿåº¦ä¸æ˜¯æœ€åŠæ—¶çš„ï¼Œæ¯•ç«Ÿ<strong>æ¯æ¬¡æ•°æ®çš„å†™å…¥å’Œè¯»å–éƒ½éœ€è¦ç»è¿‡ç”¨æˆ·æ€ä¸å†…æ ¸æ€ä¹‹é—´çš„æ‹·è´è¿‡ç¨‹</strong>ã€‚</li><li><strong><mark>å…±äº«å†…å­˜</mark></strong>ï¼šä»¥è§£å†³æ¶ˆæ¯é˜Ÿåˆ—é€šä¿¡ä¸­ç”¨æˆ·æ€ä¸å†…æ ¸æ€ä¹‹é—´æ•°æ®æ‹·è´è¿‡ç¨‹å¸¦æ¥çš„å¼€é”€ï¼Œå®ƒ<strong>ç›´æ¥åˆ†é…ä¸€ä¸ªå…±äº«ç©ºé—´ï¼Œæ¯ä¸ªè¿›ç¨‹éƒ½å¯ä»¥ç›´æ¥è®¿é—®</strong>ï¼Œå°±åƒè®¿é—®è¿›ç¨‹è‡ªå·±çš„ç©ºé—´ä¸€æ ·å¿«æ·æ–¹ä¾¿ï¼Œä¸éœ€è¦é™·å…¥å†…æ ¸æ€æˆ–è€…ç³»ç»Ÿè°ƒç”¨ï¼Œå¤§å¤§æé«˜äº†é€šä¿¡çš„é€Ÿåº¦ï¼Œäº«æœ‰æœ€å¿«çš„è¿›ç¨‹é—´é€šä¿¡æ–¹å¼ä¹‹åã€‚ä½†æ˜¯ä¾¿æ·é«˜æ•ˆçš„å…±äº«å†…å­˜é€šä¿¡ï¼Œ<strong>å¸¦æ¥æ–°çš„é—®é¢˜ï¼Œå¤šè¿›ç¨‹ç«äº‰åŒä¸ªå…±äº«èµ„æºä¼šé€ æˆæ•°æ®çš„é”™ä¹±</strong>ã€‚</li><li>éœ€è¦**<mark>ä¿¡å·é‡</mark><strong>æ¥ä¿æŠ¤å…±äº«èµ„æºï¼Œä»¥ç¡®ä¿ä»»ä½•æ—¶åˆ»åªèƒ½æœ‰ä¸€ä¸ªè¿›ç¨‹è®¿é—®å…±äº«èµ„æºï¼Œè¿™ç§æ–¹å¼å°±æ˜¯äº’æ–¥è®¿é—®ã€‚</strong><mark>ä¿¡å·é‡ä¸ä»…å¯ä»¥å®ç°è®¿é—®çš„äº’æ–¥æ€§ï¼Œè¿˜å¯ä»¥å®ç°è¿›ç¨‹é—´çš„åŒæ­¥</mark>**ï¼Œä¿¡å·é‡å…¶å®æ˜¯ä¸€ä¸ªè®¡æ•°å™¨ï¼Œè¡¨ç¤ºçš„æ˜¯èµ„æºä¸ªæ•°ï¼Œå…¶å€¼å¯ä»¥é€šè¿‡ä¸¤ä¸ªåŸå­æ“ä½œæ¥æ§åˆ¶ï¼Œåˆ†åˆ«æ˜¯ <strong>P æ“ä½œå’Œ V æ“ä½œ</strong>ã€‚</li></ul></li></ol><h3 id="14çº¿ç¨‹ä¹‹é—´é€šä¿¡çš„æ–¹æ³•"><a class="markdownIt-Anchor" href="#14çº¿ç¨‹ä¹‹é—´é€šä¿¡çš„æ–¹æ³•"></a> 1.4çº¿ç¨‹ä¹‹é—´é€šä¿¡çš„æ–¹æ³•</h3><p>åœ¨Linuxç³»ç»Ÿä¸­ï¼Œçº¿ç¨‹é—´é€šä¿¡çš„æ–¹å¼åŒ…æ‹¬ï¼š</p><ul><li><strong><mark>äº’æ–¥é”ï¼ˆMutexï¼‰</mark></strong>ï¼šçº¿ç¨‹å¯ä»¥ä½¿ç”¨äº’æ–¥é”æ¥ä¿æŠ¤å…±äº«èµ„æºï¼Œç¡®ä¿åŒæ—¶åªæœ‰ä¸€ä¸ªçº¿ç¨‹å¯ä»¥è®¿é—®è¯¥èµ„æºã€‚</li><li><strong><mark>æ¡ä»¶å˜é‡</mark></strong>ï¼šçº¿ç¨‹å¯ä»¥ä½¿ç”¨æ¡ä»¶å˜é‡æ¥ç­‰å¾…ç‰¹å®šæ¡ä»¶çš„å‘ç”Ÿï¼Œä»¥å®ç°çº¿ç¨‹é—´çš„åè°ƒå’Œé€šçŸ¥ã€‚</li><li><strong><mark>ä¿¡å·é‡</mark></strong>ï¼šçº¿ç¨‹å¯ä»¥ä½¿ç”¨ä¿¡å·é‡æ¥æ§åˆ¶å¯¹å…±äº«èµ„æºçš„è®¿é—®ï¼Œå®ç°çº¿ç¨‹é—´çš„åŒæ­¥å’Œäº’æ–¥ã€‚</li><li><strong><mark>è¯»å†™é”</mark></strong>ï¼šå…è®¸å¤šä¸ªçº¿ç¨‹åŒæ—¶è¯»å–å…±äº«èµ„æºï¼Œä½†åªå…è®¸ä¸€ä¸ªçº¿ç¨‹å†™å…¥å…±äº«èµ„æºã€‚</li></ul><h3 id="15ä»€ä¹ˆæ˜¯çº¿ç¨‹ä¸Šä¸‹æ–‡åˆ‡æ¢"><a class="markdownIt-Anchor" href="#15ä»€ä¹ˆæ˜¯çº¿ç¨‹ä¸Šä¸‹æ–‡åˆ‡æ¢"></a> 1.5ä»€ä¹ˆæ˜¯çº¿ç¨‹ä¸Šä¸‹æ–‡åˆ‡æ¢</h3><p>çº¿ç¨‹åœ¨æ‰§è¡Œè¿‡ç¨‹ä¸­ä¼šæœ‰<mark>è‡ªå·±çš„è¿è¡Œæ¡ä»¶å’ŒçŠ¶æ€ï¼ˆä¹Ÿç§°ä¸Šä¸‹æ–‡ï¼‰</mark>ï¼Œæ¯”å¦‚<mark>ç¨‹åºè®¡æ•°å™¨ï¼Œè™šæ‹Ÿæœºæ ˆå’Œæœ¬åœ°æ–¹æ³•æ ˆ</mark>ç­‰ã€‚</p><p>å½“å‡ºç°å¦‚ä¸‹æƒ…å†µçš„æ—¶å€™ï¼Œä¼šå‘ç”Ÿçº¿ç¨‹åˆ‡æ¢ã€‚</p><ul><li>ä¸»åŠ¨è®©å‡º CPUï¼Œæ¯”å¦‚è°ƒç”¨äº† <code>sleep()</code>, <code>wait()</code> ç­‰ã€‚</li><li>æ—¶é—´ç‰‡ç”¨å®Œï¼Œå› ä¸ºæ“ä½œç³»ç»Ÿè¦é˜²æ­¢ä¸€ä¸ªçº¿ç¨‹æˆ–è€…è¿›ç¨‹é•¿æ—¶é—´å ç”¨ CPU å¯¼è‡´å…¶ä»–çº¿ç¨‹æˆ–è€…è¿›ç¨‹é¥¿æ­»ã€‚</li><li>è°ƒç”¨äº†é˜»å¡ç±»å‹çš„ç³»ç»Ÿä¸­æ–­ï¼Œæ¯”å¦‚è¯·æ±‚ IOï¼Œçº¿ç¨‹è¢«é˜»å¡ã€‚</li></ul><p>çº¿ç¨‹åˆ‡æ¢æ„å‘³ç€éœ€è¦ä¿å­˜å½“å‰<strong>çº¿ç¨‹çš„ä¸Šä¸‹æ–‡ï¼ˆæ¯”å¦‚ç¨‹åºè®¡æ•°å™¨ï¼Œè™šæ‹Ÿæœºæ ˆå’Œæœ¬åœ°æ–¹æ³•æ ˆï¼‰</strong>ï¼Œ<mark>ç•™å¾…çº¿ç¨‹ä¸‹æ¬¡å ç”¨ CPU çš„æ—¶å€™<strong>æ¢å¤ç°åœº</strong></mark>ã€‚å¹¶<strong>åŠ è½½ä¸‹ä¸€ä¸ª</strong>å°†è¦å ç”¨ CPU çš„<strong>çº¿ç¨‹ä¸Šä¸‹æ–‡</strong>ã€‚è¿™å°±æ˜¯æ‰€è°“çš„ <strong>ä¸Šä¸‹æ–‡åˆ‡æ¢</strong>ã€‚é¢‘ç¹ä¸Šä¸‹æ–‡åˆ‡æ¢å°±ä¼šé€ æˆæ•´ä½“æ•ˆç‡ä½ä¸‹ã€‚</p><h3 id="16ä»€ä¹ˆæ˜¯çº¿ç¨‹æ­»é”å¦‚ä½•é¿å…"><a class="markdownIt-Anchor" href="#16ä»€ä¹ˆæ˜¯çº¿ç¨‹æ­»é”å¦‚ä½•é¿å…"></a> 1.6ä»€ä¹ˆæ˜¯çº¿ç¨‹æ­»é”ï¼Ÿå¦‚ä½•é¿å…ï¼Ÿ</h3><ul><li><p>æ­»é”ï¼ˆDeadlockï¼‰æè¿°çš„æ˜¯è¿™æ ·ä¸€ç§æƒ…å†µï¼šå¤šä¸ªè¿›ç¨‹/çº¿ç¨‹<strong>åŒæ—¶è¢«é˜»å¡</strong>ï¼Œå®ƒä»¬ä¸­çš„**<mark>ä¸€ä¸ªæˆ–è€…å…¨éƒ¨</mark><strong>éƒ½åœ¨ç­‰å¾…==æŸä¸ª</strong>èµ„æºè¢«é‡Šæ”¾**==ã€‚ç”±äºè¿›ç¨‹/çº¿ç¨‹è¢«æ— é™æœŸåœ°é˜»å¡ï¼Œå› æ­¤ç¨‹åºä¸å¯èƒ½æ­£å¸¸ç»ˆæ­¢ã€‚</p></li><li><p>å››ä¸ªå¿…è¦æ¡ä»¶</p><ul><li><mark>äº’æ–¥</mark>ï¼ˆxï¼‰ï¼šèµ„æºæ˜¯ç‹¬å çš„ä¸”æ’ä»–ä½¿ç”¨ï¼Œ<mark>è¿›ç¨‹äº’æ–¥ä½¿ç”¨èµ„æº</mark>ï¼Œå³ä»»æ„æ—¶åˆ»ä¸€ä¸ªèµ„æºåªèƒ½ç»™ä¸€ä¸ªè¿›ç¨‹ä½¿ç”¨ï¼Œå…¶ä»–è¿›ç¨‹è‹¥ç”³è¯·ä¸€ä¸ªèµ„æºï¼Œè€Œè¯¥èµ„æºè¢«å¦ä¸€è¿›ç¨‹å æœ‰æ—¶ï¼Œåˆ™ç”³è¯·è€…ç­‰å¾…ç›´åˆ°èµ„æºè¢«å æœ‰è€…é‡Šæ”¾ã€‚</li><li><mark>è¯·æ±‚å¹¶ä¿æŒ</mark>ï¼šè¿›ç¨‹æ¯æ¬¡ç”³è¯·å®ƒæ‰€éœ€è¦çš„ä¸€éƒ¨åˆ†èµ„æºï¼Œ<mark>åœ¨ç”³è¯·æ–°çš„èµ„æºçš„åŒæ—¶ï¼Œç»§ç»­å ç”¨å·²åˆ†é…åˆ°çš„èµ„æº</mark>ã€‚</li><li><mark>éæŠ¢å </mark>ï¼šè¿›ç¨‹æ‰€è·å¾—çš„èµ„æºåœ¨æœªä½¿ç”¨å®Œæ¯•ä¹‹å‰ï¼Œä¸è¢«å…¶ä»–è¿›ç¨‹å¼ºè¡Œå‰¥å¤ºï¼Œè€Œåªèƒ½ç”±è·å¾—è¯¥èµ„æºçš„è¿›ç¨‹èµ„æºé‡Šæ”¾</li><li><mark>å¾ªç¯ç­‰å¾…</mark>ï¼ˆèµ„æºæœ‰åºåˆ†é…ï¼Œå³æ ‡åºå·ï¼‰ï¼šåœ¨å‘ç”Ÿæ­»é”æ—¶å¿…ç„¶å­˜åœ¨ä¸€ä¸ªè¿›ç¨‹ç­‰å¾…é˜Ÿåˆ—{P1,P2,â€¦,Pn},å…¶ä¸­P1ç­‰å¾…P2å æœ‰çš„èµ„æºï¼ŒP2ç­‰å¾…P3å æœ‰çš„èµ„æºï¼Œâ€¦ï¼ŒPnç­‰å¾…P1å æœ‰çš„èµ„æºï¼Œå½¢æˆä¸€ä¸ªè¿›ç¨‹ç­‰å¾…ç¯è·¯ï¼Œç¯è·¯ä¸­æ¯ä¸€ä¸ªè¿›ç¨‹æ‰€å æœ‰çš„èµ„æºåŒæ—¶è¢«å¦ä¸€ä¸ªç”³è¯·ï¼Œä¹Ÿå°±æ˜¯å‰ä¸€ä¸ªè¿›ç¨‹å æœ‰åä¸€ä¸ªè¿›ç¨‹æ‰€æ·±æƒ…åœ°èµ„æºã€‚</li></ul></li><li><p>ç ´åæ­»é”ï¼šé‚£ä¹ˆé¿å…æ­»é”é—®é¢˜å°±åªéœ€è¦ç ´ç¯å…¶ä¸­ä¸€ä¸ªæ¡ä»¶å°±å¯ä»¥ï¼Œæœ€å¸¸è§çš„å¹¶ä¸”å¯è¡Œçš„å°±æ˜¯**<mark>ä½¿ç”¨èµ„æºæœ‰åºåˆ†é…æ³•</mark>ï¼Œæ¥ç ´ç¯ç¯è·¯ç­‰å¾…æ¡ä»¶**ã€‚</p><ul><li>ä¾‹å¦‚ï¼šè¿›ç¨‹PAï¼Œä½¿ç”¨èµ„æºçš„é¡ºåºæ˜¯R1ï¼ŒR2ï¼›<br />è¿›ç¨‹PBï¼Œä½¿ç”¨èµ„æºçš„é¡ºåºæ˜¯R2ï¼ŒR1ï¼›<br />è‹¥<mark>é‡‡ç”¨åŠ¨æ€åˆ†é…æœ‰å¯èƒ½å½¢æˆç¯è·¯æ¡ä»¶ï¼Œé€ æˆæ­»é”</mark>ã€‚<br />é‡‡ç”¨æœ‰åºèµ„æºåˆ†é…æ³•ï¼šR1çš„ç¼–å·ä¸º1ï¼ŒR2çš„ç¼–å·ä¸º2ï¼›<br />PAï¼šç”³è¯·æ¬¡åºåº”æ˜¯ï¼šR1ï¼ŒR2<br />PBï¼šç”³è¯·æ¬¡åºåº”æ˜¯ï¼šR1ï¼ŒR2</li></ul></li></ul><h3 id="17æ€æ­»è¿›ç¨‹çš„æ–¹æ³•"><a class="markdownIt-Anchor" href="#17æ€æ­»è¿›ç¨‹çš„æ–¹æ³•"></a> 1.7æ€æ­»è¿›ç¨‹çš„æ–¹æ³•</h3><ul><li>linux</li></ul><p>é¦–å…ˆï¼Œä½¿ç”¨pså‘½ä»¤æŸ¥æ‰¾è¿›ç¨‹çš„PIDï¼ˆè¿›ç¨‹IDï¼‰ï¼Œç„¶åä½¿ç”¨killå‘½ä»¤åŠ ä¸ŠPIDæ¥ç»ˆæ­¢è¿›ç¨‹ã€‚ä¾‹å¦‚ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">ps -ef | grep &lt;è¿›ç¨‹å&gt;   // æŸ¥æ‰¾è¿›ç¨‹çš„PID</span><br><span class="line">kill &lt;PID&gt;              // ç»ˆæ­¢è¿›ç¨‹</span><br></pre></td></tr></table></figure><ul><li>windows</li></ul><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">netstat -ano | findstr &quot;1098&quot; //æŸ¥è¯¢ç«¯å£å·å¯¹åº”çš„è¿›ç¨‹id</span><br><span class="line">taskkill /T /F /PID //å¼ºåˆ¶ï¼ˆ/Få‚æ•°ï¼‰æ€æ­» PID ä¸º xxx çš„æ‰€æœ‰è¿›ç¨‹ï¼ŒåŒ…æ‹¬å­è¿›ç¨‹ï¼ˆ/Tå‚æ•°ï¼‰</span><br></pre></td></tr></table></figure><h2 id="2åç¨‹å°‘é—®"><a class="markdownIt-Anchor" href="#2åç¨‹å°‘é—®"></a> 2.åç¨‹ï¼ˆå°‘é—®ï¼‰</h2><h3 id="21åç¨‹çš„å®šä¹‰"><a class="markdownIt-Anchor" href="#21åç¨‹çš„å®šä¹‰"></a> 2.1åç¨‹çš„å®šä¹‰ï¼Ÿ</h3><ol><li>åç¨‹ï¼Œ æˆ‘ä»¬åˆç§°ä¸ºå¾®çº¿ç¨‹ï¼Œåç¨‹å®ƒä¸åƒçº¿ç¨‹å’Œè¿›ç¨‹é‚£æ ·ï¼Œéœ€è¦è¿›è¡Œç³»ç»Ÿå†…æ ¸ä¸Šçš„ä¸Šä¸‹æ–‡åˆ‡æ¢ï¼Œ<mark>åç¨‹çš„ä¸Šä¸‹æ–‡åˆ‡æ¢æ˜¯ç”±å¼€å‘äººå‘˜å†³å®šçš„</mark>ã€‚</li><li>åç¨‹æ˜¯ä¸€ç§ç”¨æˆ·çº§çš„è½»é‡çº§çº¿ç¨‹ã€‚åç¨‹<mark>æ‹¥æœ‰è‡ªå·±çš„å¯„å­˜å™¨ä¸Šä¸‹æ–‡å’Œæ ˆ</mark>ã€‚åç¨‹è°ƒåº¦åˆ‡æ¢æ—¶ï¼Œå°†å¯„å­˜å™¨ä¸Šä¸‹æ–‡å’Œæ ˆä¿å­˜åˆ°å…¶ä»–åœ°æ–¹ï¼Œåœ¨åˆ‡å›æ¥çš„æ—¶å€™ï¼Œæ¢å¤å…ˆå‰ä¿å­˜çš„å¯„å­˜å™¨ä¸Šä¸‹æ–‡å’Œæ ˆã€‚å› æ­¤ï¼šåç¨‹èƒ½ä¿ç•™ä¸Šä¸€æ¬¡è°ƒç”¨æ—¶çš„çŠ¶æ€ï¼ˆå³æ‰€æœ‰å±€éƒ¨çŠ¶æ€çš„ä¸€ä¸ªç‰¹å®šç»„åˆï¼‰ï¼Œæ¯æ¬¡è¿‡ç¨‹é‡å…¥æ—¶ï¼Œå°±ç›¸å½“äºè¿›å…¥ä¸Šä¸€æ¬¡è°ƒç”¨çš„çŠ¶æ€ï¼Œæ¢ç§è¯´æ³•ï¼šè¿›å…¥ä¸Šä¸€æ¬¡ç¦»å¼€æ—¶æ‰€å¤„é€»è¾‘æµçš„ä½ç½®ã€‚</li></ol><h3 id="22ä½¿ç”¨åç¨‹çš„åŸå› "><a class="markdownIt-Anchor" href="#22ä½¿ç”¨åç¨‹çš„åŸå› "></a> 2.2ä½¿ç”¨åç¨‹çš„åŸå› ï¼Ÿ</h3><ol><li>ä¸çº¿ç¨‹ç›¸å…³çš„æ¦‚å¿µå°±æ˜¯<mark>æŠ¢å å¼å¤šä»»åŠ¡</mark>ï¼ˆPreemptive multitaskingï¼‰ï¼Œè€Œä¸åç¨‹ç›¸å…³çš„æ˜¯<mark>åä½œå¼å¤šä»»åŠ¡</mark></li><li>ä¸ç®¡æ˜¯è¿›ç¨‹è¿˜æ˜¯çº¿ç¨‹ï¼Œæ¯æ¬¡é˜»å¡ã€åˆ‡æ¢éƒ½éœ€è¦é™·å…¥ç³»ç»Ÿè°ƒç”¨(system call)ï¼Œå…ˆè®©CPUè·‘æ“ä½œç³»ç»Ÿçš„è°ƒåº¦ç¨‹åºï¼Œç„¶åå†ç”±è°ƒåº¦ç¨‹åºå†³å®šè¯¥è·‘å“ªä¸€ä¸ªè¿›ç¨‹(çº¿ç¨‹)ã€‚ç”±äºæŠ¢å å¼è°ƒåº¦æ‰§è¡Œé¡ºåºæ— æ³•ç¡®å®šçš„ç‰¹ç‚¹ï¼Œ<mark><strong>ä½¿ç”¨çº¿ç¨‹æ—¶éœ€è¦éå¸¸å°å¿ƒåœ°å¤„ç†åŒæ­¥é—®é¢˜</strong></mark>ï¼Œè€Œåç¨‹å®Œå…¨ä¸å­˜åœ¨è¿™ä¸ªé—®é¢˜ï¼ˆäº‹ä»¶é©±åŠ¨å’Œå¼‚æ­¥ç¨‹åºä¹Ÿæœ‰åŒæ ·çš„ä¼˜ç‚¹ï¼‰ã€‚</li><li>å› ä¸ºåç¨‹æ˜¯<mark>ç”¨æˆ·è‡ªå·±æ¥ç¼–å†™è°ƒåº¦é€»è¾‘</mark>çš„ï¼Œå¯¹äºæˆ‘ä»¬çš„CPUæ¥è¯´ï¼Œåç¨‹å…¶å®æ˜¯å•çº¿ç¨‹ï¼Œæ‰€ä»¥CPUä¸ç”¨å»è€ƒè™‘æ€ä¹ˆè°ƒåº¦ã€åˆ‡æ¢ä¸Šä¸‹æ–‡ï¼Œè¿™å°±çœå»äº†CPUçš„åˆ‡æ¢å¼€é”€ï¼Œæ‰€ä»¥åç¨‹åœ¨ä¸€å®šç¨‹åº¦ä¸Šåˆå¥½äºå¤šçº¿ç¨‹ã€‚</li></ol><h3 id="23åç¨‹çš„ä¼˜ç¼ºç‚¹"><a class="markdownIt-Anchor" href="#23åç¨‹çš„ä¼˜ç¼ºç‚¹"></a> 2.3åç¨‹çš„ä¼˜ç¼ºç‚¹</h3><ul><li><p>ä¼˜ç‚¹ï¼š</p><ul><li>æ— éœ€ç³»ç»Ÿå†…æ ¸çš„ä¸Šä¸‹æ–‡åˆ‡æ¢ï¼Œå‡å°å¼€é”€ï¼›</li><li>æ— éœ€åŸå­æ“ä½œé”å®šåŠåŒæ­¥çš„å¼€é”€ï¼Œä¸ç”¨æ‹…å¿ƒèµ„æºå…±äº«çš„é—®é¢˜ï¼›</li><li>å•çº¿ç¨‹å³å¯å®ç°é«˜å¹¶å‘ï¼Œå•æ ¸ CPU å³ä¾¿æ”¯æŒä¸Šä¸‡çš„åç¨‹éƒ½ä¸æ˜¯é—®é¢˜ï¼Œæ‰€ä»¥å¾ˆé€‚åˆç”¨äºé«˜å¹¶å‘å¤„ç†ï¼Œå°¤å…¶æ˜¯åœ¨åº”ç”¨åœ¨ç½‘ç»œçˆ¬è™«ä¸­ã€‚</li></ul></li><li><p>ç¼ºç‚¹ï¼š</p><ul><li><p>æ— æ³•ä½¿ç”¨ CPU çš„å¤šæ ¸</p></li><li><p>å¤„å¤„éƒ½è¦ä½¿ç”¨éé˜»å¡ä»£ç </p></li></ul></li></ul><h2 id="3çº¿ç¨‹çš„ç”Ÿå‘½å‘¨æœŸ"><a class="markdownIt-Anchor" href="#3çº¿ç¨‹çš„ç”Ÿå‘½å‘¨æœŸ"></a> 3.çº¿ç¨‹çš„ç”Ÿå‘½å‘¨æœŸ</h2><h3 id="31çº¿ç¨‹çš„å…­ç§ç”Ÿå‘½çŠ¶æ€"><a class="markdownIt-Anchor" href="#31çº¿ç¨‹çš„å…­ç§ç”Ÿå‘½çŠ¶æ€"></a> 3.1çº¿ç¨‹çš„å…­ç§ç”Ÿå‘½çŠ¶æ€</h3><ul><li>å¦‚å›¾ï¼Œçº¿ç¨‹æœ‰å…­ç§ç”Ÿå‘½çŠ¶æ€ï¼šæ–°å»ºã€å¯æ‰§è¡Œï¼ˆå°±ç»ªã€è¿è¡Œï¼‰ã€é˜»å¡ã€ç­‰å¾…ã€è®¡æ—¶ç­‰å¾…ã€æ­»äº¡</li></ul><p><img src="https://haipeng-lin.oss-cn-shenzhen.aliyuncs.com/202409162309766.png" alt="image-20240326084258385" /></p><h3 id="32sleepæ–¹æ³•å’Œwaitçš„å¼‚åŒ"><a class="markdownIt-Anchor" href="#32sleepæ–¹æ³•å’Œwaitçš„å¼‚åŒ"></a> 3.2sleep()æ–¹æ³•å’Œwait()çš„å¼‚åŒ</h3><ul><li>ç›¸åŒç‚¹ï¼šä¸¤è€…éƒ½å¯ä»¥æš‚åœçº¿ç¨‹çš„æ‰§è¡Œ</li><li>ä¸åŒç‚¹ï¼š<ul><li><mark><strong>æ˜¯å¦æœ‰é‡Šæ”¾é”</strong></mark>ï¼š<ul><li>sleep()æ–¹æ³•æ²¡æœ‰é‡Šæ”¾é”ï¼ˆsynchronizedçš„é”ï¼‰ï¼Œç”¨äºæš‚åœæ‰§è¡Œä»»åŠ¡</li><li>wait() æ–¹æ³•é‡Šæ”¾äº†é”ï¼Œç”¨äºçº¿ç¨‹ä¹‹é—´çš„äº¤äº’</li></ul></li><li><mark><strong>æ˜¯å¦è‡ªåŠ¨è‹é†’</strong></mark>ï¼š<ul><li>sleep()æ–¹æ³•æ‰§è¡Œå®Œæˆåï¼Œçº¿ç¨‹ä¼š<strong>è‡ªåŠ¨è‹é†’</strong>ï¼Œæˆ–è€…ä¹Ÿå¯ä»¥ä½¿ç”¨ wait(long timeout) <strong>è¶…æ—¶</strong>åçº¿ç¨‹ä¼š<strong>è‡ªåŠ¨è‹é†’</strong>ã€‚</li><li>wait() æ–¹æ³•è¢«è°ƒç”¨åï¼Œçº¿ç¨‹ä¸ä¼šè‡ªåŠ¨è‹é†’ï¼Œéœ€è¦åˆ«çš„çº¿ç¨‹è°ƒç”¨<strong>åŒä¸€ä¸ªå¯¹è±¡</strong>ä¸Šçš„ <strong><code>notify()</code>æˆ–è€… <code>notifyAll()</code></strong> æ–¹æ³•ã€‚</li></ul></li><li><mark><strong>å½’å±ç±»ä¸åŒï¼š</strong></mark><ul><li>sleep()æ˜¯ <mark><strong>Thread ç±»</strong><mark>çš„é™æ€æœ¬åœ°æ–¹æ³•**ï¼ˆsleep()æ–¹æ³•æ˜¯è®©å½“å‰</mark>çº¿ç¨‹æš‚åœæ‰§è¡Œ</mark>ï¼Œ<mark>ä¸æ¶‰åŠå¯¹è±¡é”</mark>ï¼‰**</li><li>wait() åˆ™æ˜¯ ==<strong>Objectç±»çš„</strong>==æœ¬åœ°æ–¹æ³•ï¼Œ<mark>wait()æ˜¯è®©è·å¾—å¯¹è±¡é”çš„çº¿ç¨‹å®ç°ç­‰å¾…</mark>ï¼Œä¼šè‡ªåŠ¨é‡Šæ”¾å½“å‰çº¿ç¨‹å æœ‰çš„å¯¹è±¡é”ï¼‰ã€‚</li></ul></li></ul></li></ul><h3 id="33notifyå’Œnotifyallçš„åŒºåˆ«"><a class="markdownIt-Anchor" href="#33notifyå’Œnotifyallçš„åŒºåˆ«"></a> 3.3notify()å’ŒnotifyAllçš„åŒºåˆ«</h3><p>åŒæ ·æ˜¯å”¤é†’ç­‰å¾…çš„çº¿ç¨‹ï¼ŒåŒæ ·æœ€å¤šåªæœ‰ä¸€ä¸ªçº¿ç¨‹èƒ½è·å¾—é”ï¼ŒåŒæ ·ä¸èƒ½æ§åˆ¶å“ªä¸ªçº¿ç¨‹è·å¾—é”ã€‚</p><p>åŒºåˆ«åœ¨äºï¼š</p><ul><li>notifyï¼š<ul><li><mark>å”¤é†’ä¸€ä¸ªçº¿ç¨‹</mark>ï¼Œå…¶ä»–çº¿ç¨‹ä¾ç„¶å¤„äºwaitçš„ç­‰å¾…å”¤é†’çŠ¶æ€</li><li><mark>å¦‚æœè¢«å”¤é†’çš„çº¿ç¨‹ç»“æŸæ—¶æ²¡è°ƒç”¨notifyï¼Œå…¶ä»–çº¿ç¨‹å°±æ°¸è¿œæ²¡äººå»å”¤é†’</mark>ï¼Œåªèƒ½ç­‰å¾…è¶…æ—¶ï¼Œæˆ–è€…è¢«ä¸­æ–­</li></ul></li><li>notifyAllï¼š<ul><li>å”¤é†’å…¨éƒ¨çº¿ç¨‹ï¼Œ<mark>æ‰€æœ‰çº¿ç¨‹é€€å‡ºwaitçš„çŠ¶æ€ï¼Œå¼€å§‹ç«äº‰é”</mark></li><li>ä½†<mark>åªæœ‰ä¸€ä¸ªçº¿ç¨‹èƒ½æŠ¢åˆ°</mark>ï¼Œè¿™ä¸ªçº¿ç¨‹æ‰§è¡Œå®Œåï¼Œå…¶ä»–çº¿ç¨‹åˆä¼šæœ‰ä¸€ä¸ªå¹¸è¿å„¿è„±é¢–è€Œå‡ºå¾—åˆ°é”</li></ul></li></ul><h3 id="34ä¸ºä»€ä¹ˆwaitè¦åŒ…åœ¨åŒæ­¥å—ä¸­"><a class="markdownIt-Anchor" href="#34ä¸ºä»€ä¹ˆwaitè¦åŒ…åœ¨åŒæ­¥å—ä¸­"></a> 3.4ä¸ºä»€ä¹ˆwait()è¦åŒ…åœ¨åŒæ­¥å—ä¸­ï¼Ÿ</h3><ul><li><strong><mark>çº¿ç¨‹å®‰å…¨</mark></strong>ï¼šåœ¨åŒæ­¥å—ä¸­è°ƒç”¨<code>wait()</code>æ–¹æ³•å¯ä»¥ç¡®ä¿çº¿ç¨‹åœ¨è°ƒç”¨<code>wait()</code>å‰å·²ç»è·å–äº†å¯¹è±¡çš„é”ï¼Œé¿å…å¤šçº¿ç¨‹ä¹‹é—´çš„ç«äº‰å’Œæ•°æ®ä¸ä¸€è‡´æ€§é—®é¢˜ã€‚</li><li><strong><mark>å¯¹è±¡ç›‘è§†å™¨</mark></strong>ï¼š<code>wait()</code>æ–¹æ³•ä¼šé‡Šæ”¾å¯¹è±¡çš„ç›‘è§†å™¨ï¼ˆmonitorï¼‰ï¼Œå…¶ä»–çº¿ç¨‹å¯ä»¥è·å–è¯¥å¯¹è±¡çš„ç›‘è§†å™¨å¹¶æ‰§è¡ŒåŒæ­¥æ“ä½œï¼Œç¡®ä¿çº¿ç¨‹ä¹‹é—´çš„åä½œå’ŒåŒæ­¥ã€‚</li><li><strong><mark>å”¤é†’æœºåˆ¶</mark></strong>ï¼šå½“è°ƒç”¨<code>wait()</code>æ–¹æ³•åï¼Œçº¿ç¨‹ä¼šè¿›å…¥ç­‰å¾…çŠ¶æ€ï¼Œåªæœ‰åœ¨å…¶ä»–çº¿ç¨‹è°ƒç”¨<code>notify()</code>æˆ–<code>notifyAll()</code>æ–¹æ³•å”¤é†’è¯¥çº¿ç¨‹æ—¶ï¼Œçº¿ç¨‹æ‰ä¼šç»§ç»­æ‰§è¡Œã€‚åœ¨åŒæ­¥å—ä¸­è°ƒç”¨<code>wait()</code>å¯ä»¥ä¿è¯çº¿ç¨‹è¢«æ­£ç¡®å”¤é†’ã€‚</li></ul><h3 id="35å¦‚ä½•åœæ­¢ä¸€ä¸ªçº¿ç¨‹çš„è¿è¡Œ"><a class="markdownIt-Anchor" href="#35å¦‚ä½•åœæ­¢ä¸€ä¸ªçº¿ç¨‹çš„è¿è¡Œ"></a> 3.5å¦‚ä½•åœæ­¢ä¸€ä¸ªçº¿ç¨‹çš„è¿è¡Œ?</h3><p>ä¸»è¦æœ‰è¿™äº›æ–¹æ³•ï¼š</p><ul><li><strong><mark>å¼‚å¸¸æ³•åœæ­¢</mark></strong>ï¼šçº¿ç¨‹è°ƒç”¨interrupt()æ–¹æ³•åï¼Œåœ¨çº¿ç¨‹çš„runæ–¹æ³•ä¸­åˆ¤æ–­å½“å‰å¯¹è±¡çš„interrupted()çŠ¶æ€ï¼Œå¦‚æœæ˜¯ä¸­æ–­çŠ¶æ€åˆ™æŠ›å‡ºå¼‚å¸¸ï¼Œè¾¾åˆ°ä¸­æ–­çº¿ç¨‹çš„æ•ˆæœã€‚</li><li><strong><mark>åœ¨æ²‰ç¡ä¸­åœæ­¢</mark></strong>ï¼šå…ˆå°†çº¿ç¨‹sleepï¼Œç„¶åè°ƒç”¨interruptæ ‡è®°ä¸­æ–­çŠ¶æ€ï¼Œinterruptä¼šå°†é˜»å¡çŠ¶æ€çš„çº¿ç¨‹ä¸­æ–­ã€‚ä¼šæŠ›å‡ºä¸­æ–­å¼‚å¸¸ï¼Œè¾¾åˆ°åœæ­¢çº¿ç¨‹çš„æ•ˆæœ</li><li><strong><mark>stop()æš´åŠ›åœæ­¢</mark></strong>ï¼šçº¿ç¨‹è°ƒç”¨stop()æ–¹æ³•ä¼šè¢«æš´åŠ›åœæ­¢ï¼Œæ–¹æ³•å·²å¼ƒç”¨ï¼Œè¯¥æ–¹æ³•ä¼šæœ‰ä¸å¥½çš„åæœï¼šå¼ºåˆ¶è®©çº¿ç¨‹åœæ­¢æœ‰å¯èƒ½ä½¿ä¸€äº›è¯·ç†æ€§çš„å·¥ä½œå¾—ä¸åˆ°å®Œæˆã€‚</li><li><strong><mark>ä½¿ç”¨returnåœæ­¢çº¿ç¨‹</mark></strong>ï¼šè°ƒç”¨interruptæ ‡è®°ä¸ºä¸­æ–­çŠ¶æ€åï¼Œåœ¨runæ–¹æ³•ä¸­åˆ¤æ–­å½“å‰çº¿ç¨‹çŠ¶æ€ï¼Œå¦‚æœä¸ºä¸­æ–­çŠ¶æ€åˆ™returnï¼Œèƒ½è¾¾åˆ°åœæ­¢çº¿ç¨‹çš„æ•ˆæœã€‚</li></ul><h2 id="4è½¯è¿æ¥å’Œç¡¬è¿æ¥æœ‰ä»€ä¹ˆåŒºåˆ«"><a class="markdownIt-Anchor" href="#4è½¯è¿æ¥å’Œç¡¬è¿æ¥æœ‰ä»€ä¹ˆåŒºåˆ«"></a> 4.è½¯è¿æ¥å’Œç¡¬è¿æ¥æœ‰ä»€ä¹ˆåŒºåˆ«ï¼Ÿ</h2><ul><li><p><strong>è½¯è¿æ¥</strong>ï¼šå®é™…ä¸Šæ˜¯ä¸€ä¸ª<mark>æŒ‡å‘ç›®æ ‡æ–‡ä»¶çš„è·¯å¾„çš„ç¬¦å·é“¾æ¥</mark>ï¼Œç±»ä¼¼äºWindowsç³»ç»Ÿä¸­çš„å¿«æ·æ–¹å¼ï¼Œåˆ›å»ºè½¯è¿æ¥ä¸ä¼šå ç”¨ç›®æ ‡æ–‡ä»¶çš„inodeèŠ‚ç‚¹ï¼Œåªæ˜¯<mark>ç®€å•åœ°æŒ‡å‘ç›®æ ‡æ–‡ä»¶çš„è·¯å¾„</mark>ã€‚åˆ é™¤åŸå§‹æ–‡ä»¶åï¼Œè½¯è¿æ¥ä»ç„¶å­˜åœ¨ï¼Œä½†æŒ‡å‘çš„ç›®æ ‡æ–‡ä»¶å¤±æ•ˆï¼Œç§°ä¸º&quot;æ‚¬ç©ºé“¾æ¥&quot;ã€‚è½¯é“¾æ¥å¯ä»¥è·¨æ–‡ä»¶ç³»ç»Ÿåˆ›å»ºè½¯è¿æ¥ã€‚</p></li><li><p><strong>ç¡¬è¿æ¥</strong>ï¼šæ˜¯æŒ‡<mark>å¤šä¸ªæ–‡ä»¶å®é™…ä¸ŠæŒ‡å‘åŒä¸€ä¸ªinodeèŠ‚ç‚¹ï¼Œå³å¤šä¸ªæ–‡ä»¶å…±äº«åŒä¸€å—æ•°æ®å—</mark>ã€‚åˆ›å»ºç¡¬è¿æ¥ä¼šå¢åŠ ç›®æ ‡æ–‡ä»¶çš„é“¾æ¥è®¡æ•°ï¼Œåˆ é™¤ä»»ä½•ä¸€ä¸ªç¡¬è¿æ¥å¹¶ä¸ä¼šå½±å“å…¶ä»–ç¡¬è¿æ¥æŒ‡å‘çš„æ–‡ä»¶æ•°æ®ã€‚åªèƒ½åœ¨åŒä¸€æ–‡ä»¶ç³»ç»Ÿå†…åˆ›å»ºç¡¬è¿æ¥ã€‚</p></li></ul><h2 id="5å†…æ ¸æ€å’Œç”¨æˆ·æ€"><a class="markdownIt-Anchor" href="#5å†…æ ¸æ€å’Œç”¨æˆ·æ€"></a> 5.å†…æ ¸æ€å’Œç”¨æˆ·æ€</h2><p>å†…æ ¸æ€å’Œç”¨æˆ·æ€æ˜¯æ“ä½œç³»ç»Ÿä¸­çš„ä¸¤ç§è¿è¡Œæ¨¡å¼ã€‚å®ƒä»¬çš„ä¸»è¦åŒºåˆ«<mark>åœ¨äºæƒé™å’Œå¯æ‰§è¡Œçš„æ“ä½œ</mark>ï¼š</p><ol><li><mark><strong>å†…æ ¸æ€</strong></mark>ï¼ˆKernel Modeï¼‰ï¼šåœ¨å†…æ ¸æ€ä¸‹ï¼Œ<mark>CPUå¯ä»¥æ‰§è¡Œæ‰€æœ‰çš„æŒ‡ä»¤å’Œè®¿é—®æ‰€æœ‰çš„ç¡¬ä»¶èµ„æº</mark>ã€‚è¿™ç§æ¨¡å¼ä¸‹çš„æ“ä½œå…·æœ‰æ›´é«˜çš„æƒé™ï¼Œä¸»è¦ç”¨äºæ“ä½œç³»ç»Ÿå†…æ ¸çš„è¿è¡Œã€‚</li><li><mark><strong>ç”¨æˆ·æ€</strong></mark>ï¼ˆUser Modeï¼‰ï¼šåœ¨ç”¨æˆ·æ€ä¸‹ï¼Œ<mark>CPUåªèƒ½æ‰§è¡Œéƒ¨åˆ†æŒ‡ä»¤é›†ï¼Œæ— æ³•ç›´æ¥è®¿é—®ç¡¬ä»¶èµ„æº</mark>ã€‚è¿™ç§æ¨¡å¼ä¸‹çš„æ“ä½œæƒé™è¾ƒä½ï¼Œä¸»è¦ç”¨äºè¿è¡Œç”¨æˆ·ç¨‹åºã€‚</li></ol><p>å†…æ ¸æ€çš„åº•å±‚æ“ä½œä¸»è¦åŒ…æ‹¬ï¼šå†…å­˜ç®¡ç†ã€è¿›ç¨‹ç®¡ç†ã€è®¾å¤‡é©±åŠ¨ç¨‹åºæ§åˆ¶ã€ç³»ç»Ÿè°ƒç”¨ç­‰ã€‚è¿™äº›æ“ä½œæ¶‰åŠåˆ°æ“ä½œç³»ç»Ÿçš„æ ¸å¿ƒåŠŸèƒ½ï¼Œéœ€è¦è¾ƒé«˜çš„æƒé™æ¥æ‰§è¡Œã€‚</p><p>åˆ†ä¸ºå†…æ ¸æ€å’Œç”¨æˆ·æ€çš„åŸå› ä¸»è¦æœ‰ä»¥ä¸‹å‡ ç‚¹ï¼š</p><ol><li><mark><strong>å®‰å…¨æ€§</strong></mark>ï¼šé€šè¿‡å¯¹æƒé™çš„åˆ’åˆ†ï¼Œç”¨æˆ·ç¨‹åºæ— æ³•ç›´æ¥è®¿é—®ç¡¬ä»¶èµ„æºï¼Œä»è€Œé¿å…äº†æ¶æ„ç¨‹åºå¯¹ç³»ç»Ÿèµ„æºçš„ç ´åã€‚</li><li><mark><strong>ç¨³å®šæ€§</strong></mark>ï¼šç”¨æˆ·æ€ç¨‹åºå‡ºç°é—®é¢˜æ—¶ï¼Œä¸ä¼šå½±å“åˆ°æ•´ä¸ªç³»ç»Ÿï¼Œé¿å…äº†ç¨‹åºæ•…éšœå¯¼è‡´ç³»ç»Ÿå´©æºƒçš„é£é™©ã€‚</li><li><mark><strong>éš”ç¦»æ€§</strong></mark>ï¼šå†…æ ¸æ€å’Œç”¨æˆ·æ€çš„åˆ’åˆ†ä½¿å¾—æ“ä½œç³»ç»Ÿå†…æ ¸ä¸ç”¨æˆ·ç¨‹åºä¹‹é—´æœ‰äº†æ˜ç¡®çš„è¾¹ç•Œï¼Œæœ‰åˆ©äºç³»ç»Ÿçš„æ¨¡å—åŒ–å’Œç»´æŠ¤ã€‚</li></ol><p>å†…æ ¸æ€å’Œç”¨æˆ·æ€çš„åˆ’åˆ†æœ‰åŠ©äºä¿è¯æ“ä½œç³»ç»Ÿçš„å®‰å…¨æ€§ã€ç¨³å®šæ€§å’Œæ˜“ç»´æŠ¤æ€§ã€‚</p><h2 id="6æœ‰å“ªäº›è¿›ç¨‹è°ƒåº¦ç®—æ³•"><a class="markdownIt-Anchor" href="#6æœ‰å“ªäº›è¿›ç¨‹è°ƒåº¦ç®—æ³•"></a> 6.æœ‰å“ªäº›è¿›ç¨‹è°ƒåº¦ç®—æ³•</h2><h3 id="61å…ˆæ¥å…ˆæœåŠ¡è°ƒåº¦ç®—æ³•"><a class="markdownIt-Anchor" href="#61å…ˆæ¥å…ˆæœåŠ¡è°ƒåº¦ç®—æ³•"></a> 6.1å…ˆæ¥å…ˆæœåŠ¡è°ƒåº¦ç®—æ³•</h3><p>é¡¾åæ€ä¹‰ï¼Œå…ˆæ¥ååˆ°ï¼Œ<strong>æ¯æ¬¡ä»å°±ç»ªé˜Ÿåˆ—é€‰æ‹©æœ€å…ˆè¿›å…¥é˜Ÿåˆ—çš„è¿›ç¨‹ï¼Œç„¶åä¸€ç›´è¿è¡Œï¼Œç›´åˆ°è¿›ç¨‹é€€å‡ºæˆ–è¢«é˜»å¡ï¼Œæ‰ä¼šç»§ç»­ä»é˜Ÿåˆ—ä¸­é€‰æ‹©ç¬¬ä¸€ä¸ªè¿›ç¨‹æ¥ç€è¿è¡Œã€‚</strong></p><p><img src="https://img-blog.csdnimg.cn/img_convert/be03d024cb580776e7b311f15695a8f6.png" alt="å›¾ç‰‡" /></p><h3 id="62æœ€çŸ­ä½œä¸šä¼˜å…ˆè°ƒåº¦ç®—æ³•"><a class="markdownIt-Anchor" href="#62æœ€çŸ­ä½œä¸šä¼˜å…ˆè°ƒåº¦ç®—æ³•"></a> 6.2æœ€çŸ­ä½œä¸šä¼˜å…ˆè°ƒåº¦ç®—æ³•</h3><p>é¡¾åæ€ä¹‰ï¼Œå®ƒä¼š**<mark>ä¼˜å…ˆé€‰æ‹©è¿è¡Œæ—¶é—´æœ€çŸ­çš„è¿›</mark>ç¨‹æ¥è¿è¡Œ**ï¼Œè¿™æœ‰åŠ©äºæé«˜ç³»ç»Ÿçš„ååé‡ã€‚</p><h3 id="63é«˜å“åº”æ¯”ä¼˜å…ˆè°ƒåº¦ç®—æ³•"><a class="markdownIt-Anchor" href="#63é«˜å“åº”æ¯”ä¼˜å…ˆè°ƒåº¦ç®—æ³•"></a> 6.3é«˜å“åº”æ¯”ä¼˜å…ˆè°ƒåº¦ç®—æ³•</h3><p><strong>æ¯æ¬¡è¿›è¡Œè¿›ç¨‹è°ƒåº¦æ—¶ï¼Œå…ˆè®¡ç®—ã€Œå“åº”æ¯”ä¼˜å…ˆçº§ã€ï¼Œç„¶åæŠŠã€Œå“åº”æ¯”ä¼˜å…ˆçº§ã€æœ€é«˜çš„è¿›ç¨‹æŠ•å…¥è¿è¡Œ</strong></p><p>å“åº”æ¯”ä¼˜å…ˆçº§ã€çš„è®¡ç®—å…¬å¼ï¼š</p><p><img src="https://img-blog.csdnimg.cn/img_convert/1dbf64926e5650d2544d3d34e3b369fc.png" alt="å›¾ç‰‡" /></p><h3 id="64æ—¶é—´ç‰‡è½®è½¬è°ƒåº¦ç®—æ³•"><a class="markdownIt-Anchor" href="#64æ—¶é—´ç‰‡è½®è½¬è°ƒåº¦ç®—æ³•"></a> 6.4æ—¶é—´ç‰‡è½®è½¬è°ƒåº¦ç®—æ³•</h3><p><img src="https://img-blog.csdnimg.cn/img_convert/247cd863568e4914c95cf5121b2d1d12.png" alt="å›¾ç‰‡" /></p><p><strong>æ¯ä¸ªè¿›ç¨‹è¢«åˆ†é…ä¸€ä¸ªæ—¶é—´æ®µï¼Œç§°ä¸ºæ—¶é—´ç‰‡ï¼ˆ*Quantum*ï¼‰ï¼Œå³å…è®¸è¯¥è¿›ç¨‹åœ¨è¯¥æ—¶é—´æ®µä¸­è¿è¡Œã€‚</strong></p><ul><li>å¦‚æœæ—¶é—´ç‰‡ç”¨å®Œï¼Œè¿›ç¨‹è¿˜åœ¨è¿è¡Œï¼Œé‚£ä¹ˆå°†ä¼šæŠŠæ­¤è¿›ç¨‹ä» CPU é‡Šæ”¾å‡ºæ¥ï¼Œå¹¶æŠŠ CPU åˆ†é…ç»™å¦å¤–ä¸€ä¸ªè¿›ç¨‹ï¼›</li><li>å¦‚æœè¯¥è¿›ç¨‹åœ¨æ—¶é—´ç‰‡ç»“æŸå‰é˜»å¡æˆ–ç»“æŸï¼Œåˆ™ CPU ç«‹å³è¿›è¡Œåˆ‡æ¢ï¼›</li></ul>]]></content>
    
    
      
      
    <summary type="html">&lt;link rel=&quot;stylesheet&quot; class=&quot;aplayer-secondary-style-marker&quot; href=&quot;&#92;assets&#92;css&#92;APlayer.min.css&quot;&gt;&lt;script src=&quot;&#92;assets&#92;js&#92;APlayer.min.js&quot; cla</summary>
      
    
    
    
    <category term="ã€çŸ¥è¯†æ€»ç»“ã€‘" scheme="https://www.haipeng-lin.cn/categories/%E3%80%90%E7%9F%A5%E8%AF%86%E6%80%BB%E7%BB%93%E3%80%91/"/>
    
    
  </entry>
  
  <entry>
    <title>éšç¬” | å¤§å­¦å››å¹´å†ç¨‹</title>
    <link href="https://www.haipeng-lin.cn/posts/a062b9f3.html"/>
    <id>https://www.haipeng-lin.cn/posts/a062b9f3.html</id>
    <published>2024-09-12T00:31:07.000Z</published>
    <updated>2024-10-12T14:15:56.252Z</updated>
    
    <content type="html"><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="\assets\css\APlayer.min.css"><script src="\assets\js\APlayer.min.js" class="aplayer-secondary-script-marker"></script><h1 id="å‰è¨€"><a class="markdownIt-Anchor" href="#å‰è¨€"></a> å‰è¨€</h1><p>â€ƒâ€ƒå…¶å®æƒ³å†™å¤§å­¦å››å¹´å†ç¨‹è¿™ç¯‡æ–‡ç« å¾ˆä¹…äº†ï¼Œä½†ä¸€ç›´æŠ½ä¸å‡ºæ—¶é—´æ¥ã€‚æˆ‘ä¸æƒ³ç­‰åˆ°æ˜å¹´æ¯•ä¸šæ‰å†™ï¼Œæ‹…å¿ƒè®°å¿†ä¼šè¶Šæ¥è¶Šæ¨¡ç³Šï¼Œæ…¢æ…¢æ¶ˆæ•£ï¼Œå…å¾—é—æ†¾ï¼Œä¹Ÿæ˜¯ä¸ºäº†ä»¥åçœ‹æ—¶è¿˜èƒ½å›å¿†é’æ˜¥ï¼ˆç«™å¯èƒ½éƒ½å…³äº†<s>bushi</s>ï¼‰ç°åœ¨å®ä¹ ç»“æŸï¼Œåœ¨å­¦æ ¡ä¸Šè¯¾è®¾ï¼Œæ‰€ä»¥è¶è¿™ä¸ªæœºä¼šï¼Œå›é¡¾åœ¨ä»²å›­ï¼ˆä»²æºæ ¡å›­ï¼‰è¿™ä¸‰ã€å››å¹´çš„æµæ°´è´¦ã€‚</p><p><img src="https://haipeng-lin.oss-cn-shenzhen.aliyuncs.com/202409201839163.png" alt="" /></p><h1 id="åˆé‡"><a class="markdownIt-Anchor" href="#åˆé‡"></a> åˆé‡</h1><p>â€ƒâ€ƒæ—¶é—´å›åˆ°2021å¹´7æœˆä¸­æ—¬çš„æŸå¤©ä¸­åˆï¼Œè¯´å¥½çš„12ç‚¹å‡ºé«˜è€ƒæˆç»©ï¼Œæ²¡æƒ³åˆ°æå‰å‘çŸ­ä¿¡ï¼Œ533åˆ†ï¼Œæ’å9wã€‚æ‚¬ç€çš„å¿ƒç»ˆäºæ­»äº†ï¼Œå½“æ—¶æƒ³ç€æœ‰å…¬åŠæœ¬ç§‘å­¦æ ¡èƒ½æ”¶ç•™æˆ‘å°±è¡Œå“ˆå“ˆã€‚</p><p>â€ƒâ€ƒé‚£å¤©æ™šä¸Šæˆ‘å§å°±å’Œæˆ‘èŠäº†ä¸€ä¸‹ä»²æºçš„å­¦æ ¡ä¿¡æ¯å’Œç†å·¥ç§‘ä¸“ä¸šã€‚ä»²æºæµ·ç æ ¡åŒºï¼Œåˆ°è¶Šç§€ã€å¤©æ²³ã€è”æ¹¾ã€ç•ªç¦ºï¼ŒåŠä¸ªå°æ—¶æˆ–ä¸€ä¸ªå°æ—¶å°±èƒ½åˆ°ï¼Œåˆ°æ—¶å€™å¤§ä¸‰/å››æ‰¾å®ä¹ æ–¹ä¾¿ä¸€ç‚¹ï¼Œä¸ç”¨ç§Ÿæˆ¿ï¼Œå¯ä»¥ä½åœ¨å­¦æ ¡ï¼Œä»Šå¹´æ‰¾å®ä¹ å°±ä½äº†å­¦æ ¡å˜¿å˜¿ï¼›ä»²æºä¿¡ç§‘é™¢ä¸“ä¸šåœ¨æœ¬è´¨ä¸Šåˆ†ä¸ºä¸¤ç±»ï¼š<mark>è½¯ä»¶ç±»å’Œç¡¬ä»¶ç±»</mark> ï¼Œè½¯ä»¶ç±»æœ‰è®¡ç®—æœºå’Œå¤§æ•°æ®ä¸“ä¸šï¼Œç¡¬ä»¶ç±»æœ‰ç‰©è”ç½‘ã€ç”µå­ã€ç½‘ç»œç­‰ä¸“ä¸šï¼Œ9wæ’åå¯ä»¥å†²å†²è®¡ç®—æœºä¸“ä¸šã€‚<br />â€ƒâ€ƒé‚£ä¸ºä»€ä¹ˆæœ€åé€‰æ‹©è®¡ç®—æœºä¸“ä¸šå“©ï¼Œé¦–å…ˆå½“æ—¶å¯¹ç”µè„‘æœ‰å…´è¶£ï¼Œç¬¬äºŒï¼Œè½¯ä»¶ç±»æ¯”ç¡¬ä»¶ç±»å¥½å­¦ä¸€ç‚¹ï¼Œå­¦ä¹ èµ„æ–™å¤šï¼Œè€Œä¸”ä¸€å°ç”µè„‘å°±å¤Ÿå­¦äº†ï¼Œç¬¬ä¸‰ï¼Œå­¦æ ¡çš„ç¡¬ä»¶è®¾æ–½ç±»éƒ½æ˜¯20ä¸–çºªçš„ï¼Œè¿˜æ˜¯è½¯ä»¶æ–¹ä¾¿ï¼Œä»¥åŠæƒ³è¶å¹´è½»èµšå¤šä¸€ç‚¹ç‚¹é’±ï¼Œæ‰€ä»¥ç¬¬ä¸€ä¸“ä¸šå°±å¡«äº†è®¡ç®—æœºã€‚</p><p>â€ƒâ€ƒ10å‡ å¤©åï¼Œå½•å–ç»“æœå‡ºæ¥äº†ï¼Œå› ä¸º21å¹´å­¦æ ¡æ‰©æ‹›ï¼Œæˆ‘å°±è¸©çº¿å½•å–åˆ°äº†ç¬¬ä¸€å¿—æ„¿ï¼šè®¡ç®—æœºï¼Œæ¢¦å¼€å§‹çš„åœ°æ–¹ã€‚</p><p><img src="https://haipeng-lin.oss-cn-shenzhen.aliyuncs.com/202410122208915.png" alt="" /></p><h1 id="å¼€ç¯‡"><a class="markdownIt-Anchor" href="#å¼€ç¯‡"></a> å¼€ç¯‡</h1><p>â€ƒâ€ƒ2021å¹´9æœˆ16æ—¥ï¼Œé‚£å¤©åˆæ¬¡åˆ°è¾¾ä»²å›­ï¼Œæˆ‘æ˜¯ç¬¬ä¸€ä¸ªåˆ°å®¿èˆçš„ï¼Œå…­äººé—´ã€‚</p><p>â€ƒâ€ƒç¬¬ä¸€å°è±¡å°±æ˜¯å®¿èˆä¹Ÿå¤ªçƒ‚äº†å­ï¼Œè™½ç„¶å·²ç»åšäº†å¿ƒé‡Œé¢„æœŸï¼Œä½†è¿˜æ˜¯æœ‰ç‚¹å°éœ‡æƒŠï¼Œæˆ‘é«˜ä¸­æœ‰ä¸ªåŒå­¦æ˜¯è¢«ä»²æºçš„å®¿èˆå“è·‘çš„ï¼Œæœ€åå»äº†å¹¿æµ·~ã€‚å®¿èˆé—¨çª—éƒ½æ˜¯ä¸Šä¸ªä¸–çºªçš„ï¼Œå®¿èˆè¢«åæ§½æœ€å¤šçš„ä¾¿æ˜¯<mark>ç©ºè°ƒçš„å¤–æœºæ˜¯æœå‘å•æ‰€</mark>çš„ï¼Œæ¯æ¬¡åˆ°é˜³å°/å•æ‰€éƒ½å¾—ç»å†è¿‡ä¸€æ¬¡æ±—çš„æ²æµ´ï¼ˆæ€ä¹ˆä¼šæœ‰è¿™æ ·å­è®¾è®¡çš„ï¼ï¼‰</p><blockquote><p>å™åˆ©äºšå®¿èˆï¼</p></blockquote><p><img src="https://haipeng-lin.oss-cn-shenzhen.aliyuncs.com/image-20240912093722185.png" alt="" /></p><blockquote><p>å¿ä¸äº†ä¸€ç‚¹ï¼Œå½“æ—¶å†›è®­å®Œï¼Œæˆ‘ä»¬å°±åŠ¨æ‰‹è£…ä¿®å®¿èˆï¼Œé™„ä¸Šè£…ä¿®å®Œçš„æ•ˆæœ</p></blockquote><p><img src="https://haipeng-lin.oss-cn-shenzhen.aliyuncs.com/202409132344365.png" alt="" /></p><p>â€ƒâ€ƒå›åˆ°å¼€å­¦é‚£å¤©ï¼Œä¸ºæœŸ14å¤©çš„å†›è®­ç”Ÿæ´»ä¾¿å¼€å§‹äº†ï¼Œç¬¬ä¸€å¤©æ™šä¸Šä¸»è¦æ˜¯è®¤è¯†æ•™å®˜ã€æ•™å®˜è·Ÿæˆ‘ä»¬è¯´æ¯æ¬¡é›†åˆçš„åœ°ç‚¹å’Œåœ°ç‚¹ã€‚æ•´ä¸ªå†›è®­è¿‡ç¨‹ï¼Œæˆ‘è§‰å¾—å¼ºåº¦æŒºå¤§æ»´ï¼Œä½†æ˜¯ç´¯å¹¶å¿«ä¹å’Œå……å®ç€ï¼Œæ—©ä¸Š6ç‚¹åˆ°7ç‚¹æ™¨è®­ã€7ç‚¹50åˆ°12ç‚¹æ—©è®­ï¼ˆç¬¬ä¸€å¤©æœ¬æ¥æ˜¯7ç‚¹30å°±è¦é›†åˆï¼Œä½†æ˜¯é£Ÿå ‚å¤ªå¤šäººäº†ï¼Œå¾ˆå¤šè¿˜æ²¡åƒä¸Šæ—©é¤ï¼Œå°±å¾—å»é›†åˆï¼Œæ‰€ä»¥åé¢æ”¹äº†ï¼‰ã€14ç‚¹30åˆ°18ç‚¹ä¸‹åˆè®­ã€19ç‚¹åˆ°22ç‚¹æ™šè®­ã€‚</p><p>â€ƒâ€ƒæˆ‘è®°å¾—é‚£æ—¶å€™å¤©æ°”è›®çƒ­çš„ï¼Œåå››å¤©ä¸­å°±ä¸€ä¸¤å¤©æœ‰é›¨ï¼Œå…¶ä»–å‡æ˜¯å¤§å¤ªé˜³ï¼Œä¾ç¨€è®°å¾—æ—©ä¸Š5ç‚¹åŠä¸‹å»ï¼Œ7ç‚¹è®­å®Œï¼Œè¡£æœå·²ç»æ¹¿é€äº†å“ˆå“ˆå“ˆã€‚</p><p>â€ƒâ€ƒæˆ‘è®°å¾—æ—©ä¸­æ™šè®­å¼€å§‹å‰éƒ½æœ‰ä¸€ä¸ªç¯èŠ‚ï¼Œé‚£ä¾¿æ˜¯ç«™å†›å§¿ï¼Œä¼´éšç€å†›è®­æŒ‡æŒ¥å°ä¸Šæ•™å®˜åœ¨å–Šï¼šâ€œä¸¤è„šè·Ÿå¹¶æ‹¢ï¼Œä¸¤è„šå°–åˆ†å¼€çº¦å…­ååº¦ï¼Œä¸¤è…¿æŒºç›´â€ï¼Œä¸‹é¢çš„å„è¥æ•™å®˜ä¾¿å¼€å§‹äº’æŸ¥å„è¥å­¦ç”Ÿçš„å†›å§¿æƒ…å†µï¼šâ€œä½ çš„è…°å¸¦æ¾å¾—å·²ç»æ”¾å…¥ä¸€ç“¶æ°´å£¶äº†â€ï¼Œâ€œåŒæ‰‹æœ‰æ²¡æœ‰åæŒ‡åˆæ‹¢ï¼æ¥ï¼Œå¤¹ä¸Šæ‰‘å…‹ç‰Œâ€ï¼Œâ€œä½ çš„å¸½å­å‘¢ã€é‹å­å‘¢ï¼Ÿâ€ï¼Œè®°å¾—æœ‰äººæŠŠå¸½å­æ”¾åœ¨å®¿èˆæ¥¼æ¢¯çš„ä¸Šä¸‹æ¥¼æ¢¯è½¬è§’å¤„ï¼Œå¿˜è®°å¸¦ä¸Šï¼Œæ•™å®˜å‘åœ¨ç¾¤é‡Œé—®ï¼Œè¿™æ˜¯è°çš„å¸½å­ï¼Œå¿«æ¥é¢†ã€‚</p><p>â€ƒâ€ƒå†›è®­çš„å†…å®¹æœ‰æ­£æ­¥ã€é˜Ÿåˆ—ã€å†›ä½“æ‹³ã€æ•¬ç¤¼ã€è¹²ä¸‹ç­‰ç­‰å†…å®¹ï¼Œçªç„¶æ„Ÿæ…¨æ—¶é—´çœŸçš„è¿‡å¾—å¾ˆå¿«ï¼Œè¿™äº›å·²ç»è¿‡å»äº†ä¸‰å¹´äº†ï¼Œå¥½å¿«ï¼Œå¥½å¿«ã€‚</p><h1 id="å­¦ä¹ "><a class="markdownIt-Anchor" href="#å­¦ä¹ "></a> å­¦ä¹ </h1><p>â€ƒâ€ƒæˆ‘ä»¬åœ¨å¤§ä¸€ä¸Šä¾¿ä¸Šäº†Cè¯­è¨€ã€ç¦»æ•£æ•°å­¦ã€é«˜ç­‰æ•°å­¦â€¦ï¼Œç¦»æ•£æ•°å­¦å’Œå¤§ä¸‰çš„è®¡ç»„æ˜¯æ½‡å§æ•™çš„ï¼Œæ½‡å§æ˜¯æˆ‘ä»¬å¤§å­¦é‡Œæœ€å–œæ¬¢çš„è€å¸ˆä¹‹ä¸€ï¼Œäººç¾å¿ƒå–„ï¼Œè®²è¯¾è¿‡ç¨‹ä»²è‡´åŠ›äºè¿½æ±‚è®©æˆ‘ä»¬å¬å¾—æ‡‚ï¼Œå¸ƒç½®çš„ä½œä¸šåˆä¸ä¼šå¾ˆéš¾ï¼ŒæœŸæœ«æœ‰å®‰æ’å¤ä¹ ï¼ŒçœŸçš„å¾ˆå¥½ã€‚å¤§ä¸€ä¸ŠæœŸæœ«è€ƒè¯•ï¼Œåˆšåˆšè€ƒå®Œç¦»æ•£æ•°å­¦æ—¶ï¼Œæ½‡å§æ‹‰çš„ç¦»æ•£æ•°å­¦äº¤æµç¾¤çš„æ¶ˆæ¯éƒ½æ˜¯â€<mark>è€å¸ˆ  èœèœ  ææ  å‘œå‘œ</mark>â€œã€â€æ°´æœæâ€œã€â€æµ·åº•æâ€œï¼Œå“ˆå“ˆå“ˆå“ˆã€‚</p><p><img src="https://haipeng-lin.oss-cn-shenzhen.aliyuncs.com/202409132350621.png" alt="" /></p><p>â€ƒâ€ƒæˆ‘åœ¨å¤§ä¸€ä¸Šå°±ç¡®å®šäº†æˆ‘æœªæ¥çš„å°±ä¸šæ–¹å‘ï¼Œ<mark>Javaåç«¯</mark>ã€‚ä¸ºä»€ä¹ˆä¸é€‰æ‹©å…¶ä»–æ–¹å‘çš„å‘¢ï¼Ÿå‰ç«¯ï¼šéœ€è¦è°ƒé¡µé¢æ ·å¼ï¼Œä¸èƒ½æ¥è§¦åˆ°åç«¯æ ¸å¿ƒä¸šåŠ¡ï¼Œå¯æ›¿ä»£æ€§é«˜ï¼Œè¶Šæ¥è¶Šå¤šçš„åç«¯æŠŠå‰ç«¯çš„æ´»ä¹Ÿå¹²äº†ï¼›ç®—æ³•ï¼šä¸å¤ªæ„Ÿå†’ï¼Œå°±ä¸šé—¨æ§›é«˜ï¼›è¿ç»´ï¼šå‘å±•ç©ºé—´å°ã€‚</p><p>â€ƒâ€ƒå½“æ—¶å¬å¸ˆå…„è¯´ï¼Œæ¥å­¦ Java ï¼Œå­¦ä¸€æŠŠä¸ªæœˆï¼Œåšç‚¹é¡¹ç›®ï¼Œå°±å¯ä»¥æœˆå…¥è¿‡ä¸‡äº†ï¼Œä½†æ˜¯ç°åœ¨æ¥çœ‹å‡ ä¹ä¸å¯èƒ½ï¼Œå¤ªéš¾äº†ç°åœ¨ã€‚</p><p>â€ƒâ€ƒç¡®å®šå¥½äº†æ–¹å‘ä¹‹åï¼Œå¤§ä¸€ä¸Šä¾¿å¼€å§‹å­¦ä¹ ï¼ŒæŠ€èƒ½æŒæ¡å¦‚ä¸‹ï¼šJava åŸºç¡€ã€MySQL ã€Redis ã€JavaWebï¼ˆå·²è¿‡æ—¶ï¼‰ã€Spring ã€SpringMVC ã€SpringBoot ã€RabbitMQ ã€SpringCloudã€‚ä¹‹åå°±æ˜¯å¤§ä¸‰ä¸‹é¡ºåˆ©æ‰¾åˆ°äº†ä¸€ä¸ªç«‹ç™½é‡‘æ§ï¼ˆå®å‡¯é“èï¼‰çš„ Java å¼€å‘å®ä¹ ã€‚</p><p>â€ƒâ€ƒä½ é—®æˆ‘åœ¨ä»²æºå¾…å¾—æœ€ä¹…ã€æœ€å¤šçš„åœ°æ–¹æ˜¯ä»€ä¹ˆï¼Ÿæˆ‘æƒ³é™¤äº†æ´—æ¾¡ä¼‘æ¯ç¡è§‰çš„å®¿èˆä¹‹å¤–ï¼Œä¾¿æ˜¯<mark>å›¾ä¹¦é¦†</mark>ï¼Œå›¾ä¹¦é¦†ä¼´éšäº†æˆ‘çš„å¤‡è€ƒå››å…­çº§ã€ä¸“ä¸šæŠ€èƒ½å­¦ä¹ ã€æœŸæœ«å¤ä¹ ã€å‡†å¤‡é¢è¯•ã€å…«è‚¡æ–‡ç­‰ç­‰ã€‚</p><p>â€ƒâ€ƒå›¾ä¹¦é¦†ä¸€æ¥¼ï¼Œä¸¤è¾¹çš„æ˜¯ç ”ä¿®å®¤ï¼Œå¤‡è€ƒè€ƒç ”ã€è€ƒå…¬ã€è€ƒè¯ã€ä»¥åŠæœŸæœ«å¤ä¹ çš„å­¦ç”Ÿï¼Œä¸€èˆ¬ä¼šé€‰æ‹©ç ”ä¿®å®¤æ¥å­¦ä¹ ï¼›äºŒæ¥¼ï¼Œå€Ÿè¿˜ä¹¦åœ°æ–¹ï¼Œä»¥åŠä¸¤è¾¹æ¯”è¾ƒå°‘çš„åº§ä½ï¼›ä¸‰æ¥¼ï¼Œä¸¤è¾¹æ˜¯ç”µè„‘å®¤ï¼Œå……ç”µä½è¿˜æ˜¯æœ‰ç‚¹å°‘ï¼Œå¸Œæœ›ä»²æºå›¾ä¹¦é¦†ä»¥åèƒ½è£…å¤šä¸€äº›æ’åº§ï¼Œä¸ç„¶å¾ˆä¸æ–¹ä¾¿ï¼›å››æ¥¼ï¼Œå¤–é¢å­¦ä¹ æ¡Œï¼Œä»¥åŠä¸¤è¾¹çš„é˜…è§ˆä½ç½®ï¼Œæ²¡å……ç”µä½ä½ç½®è¿˜æ˜¯æŒºå¤šçš„ã€‚</p><p><img src="https://haipeng-lin.oss-cn-shenzhen.aliyuncs.com/202409132345324.png" alt="" /></p><p>â€ƒâ€ƒè¯¾æœ€å¤šçš„å­¦æœŸæ˜¯å¤§äºŒä¸Šï¼Œæ¯å¤©ä¸æ˜¯åœ¨ä¸Šè¯¾ï¼Œå°±æ˜¯åœ¨ä¸Šè¯¾çš„è·¯ä¸Šã€‚</p><img src="https://haipeng-lin.oss-cn-shenzhen.aliyuncs.com/202409132345015.png" alt="image-20240912144705169" style="zoom:25%;" /><blockquote><p>åŒæ—¶æŒ‚ä¸‰é—¨è¯¾çš„ç½‘ç»œè¯¾</p></blockquote><p><img src="https://haipeng-lin.oss-cn-shenzhen.aliyuncs.com/202409132345585.png" alt="" /></p><blockquote><p>æ•™å­¦æ¥¼</p></blockquote><p><img src="https://haipeng-lin.oss-cn-shenzhen.aliyuncs.com/202409132345197.jpeg" alt="" /></p><h1 id="ç»“æŸè¯­"><a class="markdownIt-Anchor" href="#ç»“æŸè¯­"></a> ç»“æŸè¯­</h1><p>â€‹å¤§å­¦å››å¹´å†ç¨‹æ–‡ç« ï¼Œæç¬”äº2024å¹´9æœˆ12æ—¥ï¼Œé¦–æ¬¡å®Œæˆåˆé‡ã€å¼€ç¯‡ã€å­¦ä¹ ã€ç¾é£Ÿåˆé›†ã€å¤©ç©ºåˆé›†</p><p>â€‹åé¢å†ç»­ï¼</p>]]></content>
    
    
      
      
    <summary type="html">&lt;link rel=&quot;stylesheet&quot; class=&quot;aplayer-secondary-style-marker&quot; href=&quot;&#92;assets&#92;css&#92;APlayer.min.css&quot;&gt;&lt;script src=&quot;&#92;assets&#92;js&#92;APlayer.min.js&quot; cla</summary>
      
    
    
    
    <category term="ã€éšç¬”ã€‘" scheme="https://www.haipeng-lin.cn/categories/%E3%80%90%E9%9A%8F%E7%AC%94%E3%80%91/"/>
    
    
    <category term="å¤§å­¦" scheme="https://www.haipeng-lin.cn/tags/%E5%A4%A7%E5%AD%A6/"/>
    
  </entry>
  
  <entry>
    <title>MiniDBâ€”â€”ç´¢å¼•ç®¡ç†å™¨</title>
    <link href="https://www.haipeng-lin.cn/posts/3e11dfdd.html"/>
    <id>https://www.haipeng-lin.cn/posts/3e11dfdd.html</id>
    <published>2024-09-09T09:18:34.000Z</published>
    <updated>2024-09-19T08:57:15.705Z</updated>
    
    <content type="html"><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="\assets\css\APlayer.min.css"><script src="\assets\js\APlayer.min.js" class="aplayer-secondary-script-marker"></script><h1 id="10ç´¢å¼•ç®¡ç†å™¨"><a class="markdownIt-Anchor" href="#10ç´¢å¼•ç®¡ç†å™¨"></a> 10.ç´¢å¼•ç®¡ç†å™¨</h1><blockquote><p>æ¶‰åŠä»£ç ï¼šcom.peng.minidb.backend.imåŒ…ä¸‹</p></blockquote><h2 id="101å‰è¨€"><a class="markdownIt-Anchor" href="#101å‰è¨€"></a> 10.1å‰è¨€</h2><p>â€‹ç´¢å¼•ç®¡ç†å™¨æ˜¯ MiniDB ä¸­ç”¨äºç®¡ç†B+æ ‘ç´¢å¼•çš„æ¨¡å—ï¼Œä¸ºMiniDBæä¾›äº†åŸºäºB+æ ‘çš„èšç°‡ç´¢å¼•åŠŸèƒ½</p><p>â€‹ç´¢å¼•ç®¡ç†å™¨åŸºäºæ•°æ®ç®¡ç†å™¨ï¼Œå³ç´¢å¼•æ•°æ®ç›´æ¥å­˜å‚¨åœ¨æ•°æ®åº“æ–‡ä»¶ä¸­</p><h2 id="102bæ ‘èŠ‚ç‚¹"><a class="markdownIt-Anchor" href="#102bæ ‘èŠ‚ç‚¹"></a> 10.2B+æ ‘èŠ‚ç‚¹</h2><h3 id="1021èŠ‚ç‚¹å®šä¹‰"><a class="markdownIt-Anchor" href="#1021èŠ‚ç‚¹å®šä¹‰"></a> 10.2.1èŠ‚ç‚¹å®šä¹‰</h3><p>â€‹B+ æ ‘ç”±å¤šä¸ªèŠ‚ç‚¹ï¼ˆNodeï¼‰ç»„æˆï¼Œ<mark>æ¯ä¸ªèŠ‚ç‚¹éƒ½å­˜å‚¨åœ¨ä¸€æ¡ DataItem ä¸­</mark>ã€‚å…¶æ•°æ®ç»“æ„å¦‚ä¸‹ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">[LeafFlag]</span><br><span class="line">[KeyNumber]</span><br><span class="line">[SiblingUid]</span><br><span class="line">[Son0][Key0][Son1][Key1]...[SonN][KeyN]</span><br></pre></td></tr></table></figure><ul><li><strong>LeafFlag</strong>ï¼šæ ‡è®°è¯¥èŠ‚ç‚¹æ˜¯å¦ä¸ºå¶å­èŠ‚ç‚¹</li><li><strong>KeyNumber</strong>ï¼šè¯¥èŠ‚ç‚¹ä¸­é”®çš„æ•°é‡</li><li><strong>SiblingUid</strong>ï¼šæŒ‡å‘å…„å¼ŸèŠ‚ç‚¹åœ¨ DM ä¸­çš„ UID</li><li><strong>SonN å’Œ KeyN</strong>ï¼šäº¤æ›¿å­˜å‚¨å­èŠ‚ç‚¹å’Œé”®å€¼å¯¹ã€‚æœ€åä¸€ä¸ªé”®å€¼å§‹ç»ˆä¸º <code>MAX_VALUE</code>ï¼Œä»¥ä¾¿äºæŸ¥æ‰¾</li></ul><p><img src="https://cdn.nlark.com/yuque/0/2024/png/22115500/1723887530560-08c5efc8-f75c-468d-b22e-3b40e38dc892.png#averageHue=%23ececec&amp;clientId=u2839daa5-186c-4&amp;from=paste&amp;height=271&amp;id=u30a7cafb&amp;originHeight=542&amp;originWidth=2178&amp;originalType=binary&amp;ratio=2&amp;rotation=0&amp;showTitle=false&amp;size=126303&amp;status=done&amp;style=none&amp;taskId=ua691b3ee-6cdb-4b9c-b755-4881aa26d0f&amp;title=&amp;width=1089" alt="image.png" /></p><h3 id="1022ç›¸å…³å‡½æ•°"><a class="markdownIt-Anchor" href="#1022ç›¸å…³å‡½æ•°"></a> 10.2.2ç›¸å…³å‡½æ•°</h3><h4 id="1åŸºç¡€å‡½æ•°"><a class="markdownIt-Anchor" href="#1åŸºç¡€å‡½æ•°"></a> ï¼ˆ1ï¼‰åŸºç¡€å‡½æ•°</h4><blockquote><p>setRawIsLeaf è®¾ç½®æ˜¯å¦ä¸ºå¶å­èŠ‚ç‚¹ï¼Œ1è¡¨ç¤ºæ˜¯å¶å­èŠ‚ç‚¹ï¼Œ0è¡¨ç¤ºéå¶å­èŠ‚ç‚¹</p></blockquote><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">setRawIsLeaf</span><span class="params">(SubArray raw, <span class="type">boolean</span> isLeaf)</span> &#123;</span><br><span class="line">    <span class="keyword">if</span>(isLeaf) &#123;</span><br><span class="line">        raw.raw[raw.start + IS_LEAF_OFFSET] = (<span class="type">byte</span>)<span class="number">1</span>;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        raw.raw[raw.start + IS_LEAF_OFFSET] = (<span class="type">byte</span>)<span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="2ç”Ÿæˆä¸€ä¸ªæ ¹èŠ‚ç‚¹"><a class="markdownIt-Anchor" href="#2ç”Ÿæˆä¸€ä¸ªæ ¹èŠ‚ç‚¹"></a> ï¼ˆ2ï¼‰ç”Ÿæˆä¸€ä¸ªæ ¹èŠ‚ç‚¹</h4><blockquote><p>æ ¹èŠ‚ç‚¹åŒ…å«ä¸¤ä¸ªåˆå§‹å­èŠ‚ç‚¹ <code>left</code> å’Œ <code>right</code>ï¼Œä»¥åŠä¸€ä¸ªåˆå§‹é”®å€¼ <code>key</code></p></blockquote><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> <span class="type">byte</span>[] newRootRaw(<span class="type">long</span> left, <span class="type">long</span> right, <span class="type">long</span> key)  &#123;</span><br><span class="line">    <span class="type">SubArray</span> <span class="variable">raw</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">SubArray</span>(<span class="keyword">new</span> <span class="title class_">byte</span>[NODE_SIZE], <span class="number">0</span>, NODE_SIZE);</span><br><span class="line">    setRawIsLeaf(raw, <span class="literal">false</span>);</span><br><span class="line">    setRawNoKeys(raw, <span class="number">2</span>);</span><br><span class="line">    setRawSibling(raw, <span class="number">0</span>);</span><br><span class="line">    setRawKthSon(raw, left, <span class="number">0</span>);</span><br><span class="line">    setRawKthKey(raw, key, <span class="number">0</span>);</span><br><span class="line">    setRawKthSon(raw, right, <span class="number">1</span>);</span><br><span class="line">    setRawKthKey(raw, Long.MAX_VALUE, <span class="number">1</span>);</span><br><span class="line">    <span class="keyword">return</span> raw.raw;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="3ç”Ÿæˆä¸€ä¸ªç©ºçš„æ ¹èŠ‚ç‚¹"><a class="markdownIt-Anchor" href="#3ç”Ÿæˆä¸€ä¸ªç©ºçš„æ ¹èŠ‚ç‚¹"></a> ï¼ˆ3ï¼‰ç”Ÿæˆä¸€ä¸ªç©ºçš„æ ¹èŠ‚ç‚¹</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> <span class="type">byte</span>[] newNilRootRaw()  &#123;</span><br><span class="line">    <span class="type">SubArray</span> <span class="variable">raw</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">SubArray</span>(<span class="keyword">new</span> <span class="title class_">byte</span>[NODE_SIZE], <span class="number">0</span>, NODE_SIZE);</span><br><span class="line"></span><br><span class="line">    setRawIsLeaf(raw, <span class="literal">true</span>);</span><br><span class="line">    setRawNoKeys(raw, <span class="number">0</span>);</span><br><span class="line">    setRawSibling(raw, <span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> raw.raw;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="4æœç´¢æ’å…¥èŠ‚ç‚¹ä½ç½®"><a class="markdownIt-Anchor" href="#4æœç´¢æ’å…¥èŠ‚ç‚¹ä½ç½®"></a> ï¼ˆ4ï¼‰æœç´¢æ’å…¥èŠ‚ç‚¹ä½ç½®</h4><blockquote><p>æ ¹æ®ç»™å®šçš„é”®å€¼ï¼ŒæŸ¥æ‰¾å¯¹åº”çš„ UIDã€‚å¦‚æœæœªæ‰¾åˆ°ï¼Œåˆ™è¿”å›å…„å¼ŸèŠ‚ç‚¹çš„ UID</p></blockquote><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> SearchNextRes <span class="title function_">searchNext</span><span class="params">(<span class="type">long</span> key)</span> &#123;</span><br><span class="line">    dataItem.rLock();</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="type">SearchNextRes</span> <span class="variable">res</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">SearchNextRes</span>();</span><br><span class="line">        <span class="type">int</span> <span class="variable">noKeys</span> <span class="operator">=</span> getRawNoKeys(raw);</span><br><span class="line">        <span class="keyword">for</span>(<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; noKeys; i ++) &#123;</span><br><span class="line">            <span class="type">long</span> <span class="variable">ik</span> <span class="operator">=</span> getRawKthKey(raw, i);</span><br><span class="line">            <span class="keyword">if</span>(key &lt; ik) &#123;</span><br><span class="line">                res.uid = getRawKthSon(raw, i);</span><br><span class="line">                res.siblingUid = <span class="number">0</span>;</span><br><span class="line">                <span class="keyword">return</span> res;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        res.uid = <span class="number">0</span>;</span><br><span class="line">        res.siblingUid = getRawSibling(raw);</span><br><span class="line">        <span class="keyword">return</span> res;</span><br><span class="line"></span><br><span class="line">    &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">        dataItem.rUnLock();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="5æœç´¢èŠ‚ç‚¹"><a class="markdownIt-Anchor" href="#5æœç´¢èŠ‚ç‚¹"></a> ï¼ˆ5ï¼‰æœç´¢èŠ‚ç‚¹</h4><blockquote><p><code>leafSearchRange</code><strong>æ–¹æ³•</strong>ï¼šåœ¨å½“å‰èŠ‚ç‚¹å†…è¿›è¡ŒèŒƒå›´æŸ¥æ‰¾ï¼ŒèŒƒå›´ä¸º <code>[leftKey, rightKey]</code>ã€‚å¦‚æœ <code>rightKey</code> å¤§äºç­‰äºè¯¥èŠ‚ç‚¹çš„æœ€å¤§é”®å€¼ï¼Œåˆ™è¿”å›å…„å¼ŸèŠ‚ç‚¹çš„ UIDï¼Œæ–¹ä¾¿ç»§ç»­æœç´¢ä¸‹ä¸€ä¸ªèŠ‚ç‚¹</p></blockquote><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">LeafSearchRangeRes</span> &#123;</span><br><span class="line">    List&lt;Long&gt; uids;</span><br><span class="line">    <span class="type">long</span> siblingUid;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> LeafSearchRangeRes <span class="title function_">leafSearchRange</span><span class="params">(<span class="type">long</span> leftKey, <span class="type">long</span> rightKey)</span> &#123;</span><br><span class="line">    dataItem.rLock();</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="type">int</span> <span class="variable">noKeys</span> <span class="operator">=</span> getRawNoKeys(raw);</span><br><span class="line">        <span class="type">int</span> <span class="variable">kth</span> <span class="operator">=</span> <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">while</span>(kth &lt; noKeys) &#123;</span><br><span class="line">            <span class="type">long</span> <span class="variable">ik</span> <span class="operator">=</span> getRawKthKey(raw, kth);</span><br><span class="line">            <span class="keyword">if</span>(ik &gt;= leftKey) &#123;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            kth ++;</span><br><span class="line">        &#125;</span><br><span class="line">        List&lt;Long&gt; uids = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;();</span><br><span class="line">        <span class="keyword">while</span>(kth &lt; noKeys) &#123;</span><br><span class="line">            <span class="type">long</span> <span class="variable">ik</span> <span class="operator">=</span> getRawKthKey(raw, kth);</span><br><span class="line">            <span class="keyword">if</span>(ik &lt;= rightKey) &#123;</span><br><span class="line">                uids.add(getRawKthSon(raw, kth));</span><br><span class="line">                kth ++;</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="type">long</span> <span class="variable">siblingUid</span> <span class="operator">=</span> <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">if</span>(kth == noKeys) &#123;</span><br><span class="line">            siblingUid = getRawSibling(raw);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="type">LeafSearchRangeRes</span> <span class="variable">res</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">LeafSearchRangeRes</span>();</span><br><span class="line">        res.uids = uids;</span><br><span class="line">        res.siblingUid = siblingUid;</span><br><span class="line">        <span class="keyword">return</span> res;</span><br><span class="line">    &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">        dataItem.rUnLock();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="6æ’å…¥èŠ‚ç‚¹"><a class="markdownIt-Anchor" href="#6æ’å…¥èŠ‚ç‚¹"></a> ï¼ˆ6ï¼‰æ’å…¥èŠ‚ç‚¹</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> InsertAndSplitRes <span class="title function_">insertAndSplit</span><span class="params">(<span class="type">long</span> uid, <span class="type">long</span> key)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">    <span class="type">boolean</span> <span class="variable">success</span> <span class="operator">=</span> <span class="literal">false</span>;</span><br><span class="line">    <span class="type">Exception</span> <span class="variable">err</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line">    <span class="type">InsertAndSplitRes</span> <span class="variable">res</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">InsertAndSplitRes</span>();</span><br><span class="line"></span><br><span class="line">    dataItem.before();</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        success = insert(uid, key);</span><br><span class="line">        <span class="keyword">if</span>(!success) &#123;</span><br><span class="line">            res.siblingUid = getRawSibling(raw);</span><br><span class="line">            <span class="keyword">return</span> res;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span>(needSplit()) &#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                <span class="type">SplitRes</span> <span class="variable">r</span> <span class="operator">=</span> split();</span><br><span class="line">                res.newSon = r.newSon;</span><br><span class="line">                res.newKey = r.newKey;</span><br><span class="line">                <span class="keyword">return</span> res;</span><br><span class="line">            &#125; <span class="keyword">catch</span>(Exception e) &#123;</span><br><span class="line">                err = e;</span><br><span class="line">                <span class="keyword">throw</span> e;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> res;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">        <span class="keyword">if</span>(err == <span class="literal">null</span> &amp;&amp; success) &#123;</span><br><span class="line">            dataItem.after(TransactionManagerImpl.SUPER_XID);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            dataItem.unBefore();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="103bæ ‘"><a class="markdownIt-Anchor" href="#103bæ ‘"></a> 10.3B+æ ‘</h2><h3 id="1031bæ ‘å®šä¹‰"><a class="markdownIt-Anchor" href="#1031bæ ‘å®šä¹‰"></a> 10.3.1B+æ ‘å®šä¹‰</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">DataManager dm;<span class="comment">// æ•°æ®ç®¡ç†å™¨</span></span><br><span class="line"><span class="type">long</span> bootUid;<span class="comment">// æ ¹èŠ‚ç‚¹uid</span></span><br><span class="line">DataItem bootDataItem;<span class="comment">// æ ¹èŠ‚ç‚¹æ•°æ®é¡¹</span></span><br><span class="line">Lock bootLock</span><br></pre></td></tr></table></figure><p>è¿™é‡Œçš„<code>BootUid</code>å’Œ<code>BootDataItem</code>å¯¹åº”çš„æ˜¯B+æ ‘çš„æ ¹èŠ‚ç‚¹uidå’Œæ ¹èŠ‚ç‚¹uidå¯¹åº”çš„<code>DataItem</code></p><h3 id="1032ç›¸å…³å‡½æ•°"><a class="markdownIt-Anchor" href="#1032ç›¸å…³å‡½æ•°"></a> 10.3.2ç›¸å…³å‡½æ•°</h3><h4 id="1åˆ›å»ºbæ ‘"><a class="markdownIt-Anchor" href="#1åˆ›å»ºbæ ‘"></a> ï¼ˆ1ï¼‰åˆ›å»ºB+æ ‘</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="type">long</span> <span class="title function_">create</span><span class="params">(DataManager dm)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">    <span class="comment">// ç”Ÿæˆä¸€ä¸ªç©ºçš„æ ¹èŠ‚ç‚¹</span></span><br><span class="line">    <span class="type">byte</span>[] rawRoot = Node.newNilRootRaw();</span><br><span class="line">    <span class="comment">// å¾€æ•°æ®æ–‡ä»¶æ’å…¥æ ¹èŠ‚ç‚¹æ•°æ®</span></span><br><span class="line">    <span class="type">long</span> <span class="variable">rootUid</span> <span class="operator">=</span> dm.insert(TransactionManagerImpl.SUPER_XID, rawRoot);</span><br><span class="line">    <span class="comment">// </span></span><br><span class="line">    <span class="keyword">return</span> dm.insert(TransactionManagerImpl.SUPER_XID, Parser.long2Byte(rootUid));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="2åŠ è½½bæ ‘"><a class="markdownIt-Anchor" href="#2åŠ è½½bæ ‘"></a> ï¼ˆ2ï¼‰åŠ è½½B+æ ‘</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> BPlusTree <span class="title function_">load</span><span class="params">(<span class="type">long</span> bootUid, DataManager dm)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">    <span class="type">DataItem</span> <span class="variable">bootDataItem</span> <span class="operator">=</span> dm.read(bootUid);</span><br><span class="line">    <span class="keyword">assert</span> bootDataItem != <span class="literal">null</span>;</span><br><span class="line">    <span class="type">BPlusTree</span> <span class="variable">t</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">BPlusTree</span>();</span><br><span class="line">    t.bootUid = bootUid;</span><br><span class="line">    t.dm = dm;</span><br><span class="line">    t.bootDataItem = bootDataItem;</span><br><span class="line">    t.bootLock = <span class="keyword">new</span> <span class="title class_">ReentrantLock</span>();</span><br><span class="line">    <span class="keyword">return</span> t;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="3è·å–æ ¹èŠ‚ç‚¹çš„uid"><a class="markdownIt-Anchor" href="#3è·å–æ ¹èŠ‚ç‚¹çš„uid"></a> ï¼ˆ3ï¼‰è·å–æ ¹èŠ‚ç‚¹çš„uid</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="type">long</span> <span class="title function_">rootUid</span><span class="params">()</span> &#123;</span><br><span class="line">    bootLock.lock();</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="type">SubArray</span> <span class="variable">sa</span> <span class="operator">=</span> bootDataItem.data();</span><br><span class="line">        <span class="keyword">return</span> Parser.parseLong(Arrays.copyOfRange(sa.raw, sa.start, sa.start+<span class="number">8</span>));</span><br><span class="line">    &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">        bootLock.unlock();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="4æ›´æ–°æ ¹èŠ‚ç‚¹çš„uid"><a class="markdownIt-Anchor" href="#4æ›´æ–°æ ¹èŠ‚ç‚¹çš„uid"></a> ï¼ˆ4ï¼‰æ›´æ–°æ ¹èŠ‚ç‚¹çš„uid</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">updateRootUid</span><span class="params">(<span class="type">long</span> left, <span class="type">long</span> right, <span class="type">long</span> rightKey)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">    bootLock.lock();</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="type">byte</span>[] rootRaw = Node.newRootRaw(left, right, rightKey);</span><br><span class="line">        <span class="type">long</span> <span class="variable">newRootUid</span> <span class="operator">=</span> dm.insert(TransactionManagerImpl.SUPER_XID, rootRaw);</span><br><span class="line">        bootDataItem.before();</span><br><span class="line">        <span class="type">SubArray</span> <span class="variable">diRaw</span> <span class="operator">=</span> bootDataItem.data();</span><br><span class="line">        System.arraycopy(Parser.long2Byte(newRootUid), <span class="number">0</span>, diRaw.raw, diRaw.start, <span class="number">8</span>);</span><br><span class="line">        bootDataItem.after(TransactionManagerImpl.SUPER_XID);</span><br><span class="line">    &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">        bootLock.unlock();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="5ä»ä¸€ä¸ªèŠ‚ç‚¹å¼€å§‹æœç´¢ä¸‹ä¸€ä¸ªèŠ‚ç‚¹"><a class="markdownIt-Anchor" href="#5ä»ä¸€ä¸ªèŠ‚ç‚¹å¼€å§‹æœç´¢ä¸‹ä¸€ä¸ªèŠ‚ç‚¹"></a> ï¼ˆ5ï¼‰ä»ä¸€ä¸ªèŠ‚ç‚¹å¼€å§‹æœç´¢ä¸‹ä¸€ä¸ªèŠ‚ç‚¹</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="type">long</span> <span class="title function_">searchNext</span><span class="params">(<span class="type">long</span> nodeUid, <span class="type">long</span> key)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">    <span class="keyword">while</span>(<span class="literal">true</span>) &#123;</span><br><span class="line">        <span class="type">Node</span> <span class="variable">node</span> <span class="operator">=</span> Node.loadNode(<span class="built_in">this</span>, nodeUid);</span><br><span class="line">        <span class="type">SearchNextRes</span> <span class="variable">res</span> <span class="operator">=</span> node.searchNext(key);</span><br><span class="line">        node.release();</span><br><span class="line">        <span class="keyword">if</span>(res.uid != <span class="number">0</span>) <span class="keyword">return</span> res.uid;</span><br><span class="line">        nodeUid = res.siblingUid;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="6æœç´¢èŠ‚ç‚¹"><a class="markdownIt-Anchor" href="#6æœç´¢èŠ‚ç‚¹"></a> ï¼ˆ6ï¼‰æœç´¢èŠ‚ç‚¹</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="type">long</span> <span class="title function_">searchLeaf</span><span class="params">(<span class="type">long</span> nodeUid, <span class="type">long</span> key)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">    <span class="type">Node</span> <span class="variable">node</span> <span class="operator">=</span> Node.loadNode(<span class="built_in">this</span>, nodeUid);</span><br><span class="line">    <span class="type">boolean</span> <span class="variable">isLeaf</span> <span class="operator">=</span> node.isLeaf();</span><br><span class="line">    node.release();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span>(isLeaf) &#123;</span><br><span class="line">        <span class="keyword">return</span> nodeUid;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="type">long</span> <span class="variable">next</span> <span class="operator">=</span> searchNext(nodeUid, key);</span><br><span class="line">        <span class="keyword">return</span> searchLeaf(next, key);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="7æ’å…¥æ•°æ®"><a class="markdownIt-Anchor" href="#7æ’å…¥æ•°æ®"></a> ï¼ˆ7ï¼‰æ’å…¥æ•°æ®</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">insert</span><span class="params">(<span class="type">long</span> key, <span class="type">long</span> uid)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">    <span class="type">long</span> <span class="variable">rootUid</span> <span class="operator">=</span> rootUid();</span><br><span class="line">    <span class="type">InsertRes</span> <span class="variable">res</span> <span class="operator">=</span> insert(rootUid, uid, key);</span><br><span class="line">    <span class="keyword">assert</span> res != <span class="literal">null</span>;</span><br><span class="line">    <span class="keyword">if</span>(res.newNode != <span class="number">0</span>) &#123;</span><br><span class="line">        updateRootUid(rootUid, res.newNode, res.newKey);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">private</span> InsertRes <span class="title function_">insert</span><span class="params">(<span class="type">long</span> nodeUid, <span class="type">long</span> uid, <span class="type">long</span> key)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">    <span class="type">Node</span> <span class="variable">node</span> <span class="operator">=</span> Node.loadNode(<span class="built_in">this</span>, nodeUid);</span><br><span class="line">    <span class="type">boolean</span> <span class="variable">isLeaf</span> <span class="operator">=</span> node.isLeaf();</span><br><span class="line">    node.release();</span><br><span class="line"></span><br><span class="line">    <span class="type">InsertRes</span> <span class="variable">res</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line">    <span class="keyword">if</span>(isLeaf) &#123;</span><br><span class="line">        res = insertAndSplit(nodeUid, uid, key);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="type">long</span> <span class="variable">next</span> <span class="operator">=</span> searchNext(nodeUid, key);</span><br><span class="line">        <span class="type">InsertRes</span> <span class="variable">ir</span> <span class="operator">=</span> insert(next, uid, key);</span><br><span class="line">        <span class="keyword">if</span>(ir.newNode != <span class="number">0</span>) &#123;</span><br><span class="line">            res = insertAndSplit(nodeUid, ir.newNode, ir.newKey);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            res = <span class="keyword">new</span> <span class="title class_">InsertRes</span>();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> res;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="8å…³é—­bæ ‘"><a class="markdownIt-Anchor" href="#8å…³é—­bæ ‘"></a> ï¼ˆ8ï¼‰å…³é—­B+æ ‘</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">close</span><span class="params">()</span> &#123;</span><br><span class="line">    bootDataItem.release();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>]]></content>
    
    
      
      
    <summary type="html">&lt;link rel=&quot;stylesheet&quot; class=&quot;aplayer-secondary-style-marker&quot; href=&quot;&#92;assets&#92;css&#92;APlayer.min.css&quot;&gt;&lt;script src=&quot;&#92;assets&#92;js&#92;APlayer.min.js&quot; cla</summary>
      
    
    
    
    <category term="ã€MiniDBã€‘" scheme="https://www.haipeng-lin.cn/categories/%E3%80%90MiniDB%E3%80%91/"/>
    
    
  </entry>
  
  <entry>
    <title>MiniDBâ€”â€”ç‰ˆæœ¬ç®¡ç†å™¨</title>
    <link href="https://www.haipeng-lin.cn/posts/cef83234.html"/>
    <id>https://www.haipeng-lin.cn/posts/cef83234.html</id>
    <published>2024-09-09T05:15:53.000Z</published>
    <updated>2024-09-19T08:57:07.984Z</updated>
    
    <content type="html"><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="\assets\css\APlayer.min.css"><script src="\assets\js\APlayer.min.js" class="aplayer-secondary-script-marker"></script><h1 id="9minidbç‰ˆæœ¬ç®¡ç†å™¨"><a class="markdownIt-Anchor" href="#9minidbç‰ˆæœ¬ç®¡ç†å™¨"></a> 9.MiniDBâ€”â€”ç‰ˆæœ¬ç®¡ç†å™¨</h1><h2 id="91-2plmvcc"><a class="markdownIt-Anchor" href="#91-2plmvcc"></a> 9.1 2PL/MVCC</h2><h3 id="911å†²çªæ“ä½œ"><a class="markdownIt-Anchor" href="#911å†²çªæ“ä½œ"></a> 9.1.1å†²çªæ“ä½œ</h3><p>â€‹åœ¨æ•°æ®åº“ä¸­ï¼Œå¤šä¸ªäº‹åŠ¡å¯èƒ½ä¼šåŒæ—¶æ“ä½œåŒä¸€ä¸ªæ•°æ®é¡¹ï¼Œè¿™å°±å¯èƒ½å¯¼è‡´å†²çªã€‚</p><blockquote><p>ä¸¤ä¸ªäº‹åŠ¡å¯¹åŒä¸€æ•°æ®çš„updateæ“ä½œ</p><p>ä¸¤ä¸ªäº‹åŠ¡å¯¹åŒä¸€æ•°æ®çš„updateã€readæ“ä½œ</p></blockquote><h3 id="912-2pl"><a class="markdownIt-Anchor" href="#912-2pl"></a> 9.1.2 2PL</h3><ol><li>å®šä¹‰ï¼šä¸¤é˜¶æ®µé”åœ¨äº‹åŠ¡æ‰§è¡Œè¿‡ç¨‹ä¸­åˆ†ä¸ºä¸¤ä¸ªé˜¶æ®µï¼šå¢é•¿é˜¶æ®µå’Œæ”¶ç¼©é˜¶æ®µã€‚åœ¨å¢é•¿é˜¶æ®µï¼Œäº‹åŠ¡å¯ä»¥è·å–ä»»æ„æ•°é‡çš„é”ï¼Œä½†ä¸èƒ½é‡Šæ”¾ä»»ä½•é”ï¼›åœ¨æ”¶ç¼©é˜¶æ®µï¼Œäº‹åŠ¡åªèƒ½é‡Šæ”¾é”è€Œä¸èƒ½å†è·å–æ–°çš„é”</li></ol><blockquote><ol start="2"><li>ä¸¤é˜¶æ®µé”æ€ä¹ˆè§£å†³æ•°æ®åº“çš„å†²çªæ“ä½œï¼Ÿ</li></ol><p>è¦æ±‚äº‹åŠ¡åœ¨å¢é•¿é˜¶æ®µè·å–æ‰€éœ€çš„é”ï¼Œå¹¶ä¿è¯åœ¨é‡Šæ”¾é”å‰ï¼Œå…¶ä»–äº‹åŠ¡æ— æ³•è®¿é—®å·²è¢«é”å®šçš„èµ„æºï¼Œä»è€Œé¿å…äº†æ“ä½œå†²çª</p></blockquote><ol start="3"><li>é—®é¢˜ï¼šå¯¼è‡´äº†äº‹åŠ¡çš„ç›¸äº’é˜»å¡ï¼Œæ€§èƒ½å·®</li></ol><h3 id="913mvcc"><a class="markdownIt-Anchor" href="#913mvcc"></a> 9.1.3MVCC</h3><ol><li>å®šä¹‰ï¼šå¤šç‰ˆæœ¬å¹¶å‘æ§åˆ¶ï¼Œç”¨äºè§£å†³æ•°æ®åº“ä¸­å¤šä¸ªäº‹åŠ¡å¹¶å‘æ‰§è¡Œæ—¶çš„è¯»å†™å†²çªé—®é¢˜ã€‚MVCCé€šè¿‡ç»´æŠ¤æ•°æ®çš„å¤šä¸ªç‰ˆæœ¬ï¼Œå…è®¸å¹¶å‘çš„è¯»æ“ä½œå’Œå†™æ“ä½œæ›´æœ‰æ•ˆåœ°è¿›è¡Œ</li><li>æ ¸å¿ƒæ¦‚å¿µï¼š<ol><li>ç‰ˆæœ¬æ§åˆ¶ï¼šæ¯ä¸ªæ•°æ®é¡¹éƒ½æœ‰å¤šä¸ªç‰ˆæœ¬ï¼Œå½“äº‹åŠ¡å¯¹æ•°æ®è¿›è¡Œä¿®æ”¹æ—¶ï¼Œç³»ç»Ÿä¸ä¼šç›´æ¥è¦†ç›–æ—§ç‰ˆæœ¬çš„æ•°æ®ï¼Œè€Œæ˜¯åˆ›å»ºä¸€ä¸ªæ–°ç‰ˆæœ¬</li><li>äº‹åŠ¡æ ‡è¯†ï¼šæ¯ä¸ªäº‹åŠ¡åœ¨å¼€å§‹æ—¶éƒ½ä¼šè·å¾—ä¸€ä¸ªå”¯ä¸€çš„äº‹åŠ¡IDï¼Œè¿™ä¸ªäº‹åŠ¡IDç”¨äºå†³å®šäº‹åŠ¡å¯ä»¥è®¿é—®å“ªäº›æ•°æ®ç‰ˆæœ¬ï¼Œä»è€Œç¡®ä¿æ•°æ®çš„ä¸€è‡´æ€§å’Œéš”ç¦»æ€§</li></ol></li><li>ä¼˜ç‚¹ï¼š<ol><li>å¹¶å‘æ€§é«˜ï¼šMVCCå…è®¸å¤šä¸ªäº‹åŠ¡åŒæ—¶è¯»å–æ•°æ®ï¼Œè€Œä¸éœ€è¦åŠ é”</li><li>é¿å…è¯»å†™å†²çªï¼šé€šè¿‡ç»´æŠ¤æ•°æ®çš„å¤šä¸ªç‰ˆæœ¬ï¼Œè¯»æ“ä½œä¸ä¼šè¢«å†™æ“ä½œé˜»å¡</li></ol></li><li>ç¼ºç‚¹ï¼šå­˜å‚¨å¼€é”€å¤§ã€ç‰ˆæœ¬ç®¡ç†å¤æ‚æ€§é«˜</li><li>MiniDBä¸­çš„MVCCï¼š<ol><li>ç»™VMä¹‹ä¸Šçš„æ¨¡å—æä¾›æŠ½è±¡æ•°æ®ï¼š<mark>è®°å½•(Entry)</mark></li><li>ç‰ˆæœ¬ç®¡ç†å™¨åœ¨å†…éƒ¨ï¼Œä¸ºæ¯ä¸ªè®°å½•ç»´æŠ¤äº†å¤šä¸ªç‰ˆæœ¬ã€‚å½“ä¸Šå±‚æ¨¡å—å¯¹æŸä¸ªè®°å½•ä¿®æ”¹æ—¶ï¼Œ<mark>ç‰ˆæœ¬ç®¡ç†å™¨å°±åˆ›å»ºä¸€ä¸ªæ–°çš„ç‰ˆæœ¬</mark></li></ol></li></ol><h2 id="92entry"><a class="markdownIt-Anchor" href="#92entry"></a> 9.2Entry</h2><ol><li>Entryå®šä¹‰ï¼š<ol><li>XMINï¼šåˆ›å»ºè¯¥è®°å½•çš„äº‹åŠ¡ID</li><li>XMAXï¼šåˆ é™¤è¯¥è®°å½•çš„äº‹åŠ¡ID</li><li>dataï¼šè¯¥æ¡è®°å½•æŒæœ‰çš„æ•°æ®</li><li>åˆ›å»ºä¸€ä¸ªæ–°çš„è®°å½•å¯¹è±¡ã€åŠ è½½ä¸€ä¸ªè®°å½•</li></ol></li></ol><h2 id="93äº‹åŠ¡éš”ç¦»çº§åˆ«"><a class="markdownIt-Anchor" href="#93äº‹åŠ¡éš”ç¦»çº§åˆ«"></a> 9.3äº‹åŠ¡éš”ç¦»çº§åˆ«</h2><blockquote><p>MiniDBå®ç°äº†ä¸¤ç§äº‹åŠ¡éš”ç¦»çº§åˆ«ï¼šè¯»å·²æäº¤ã€å¯é‡å¤è¯»</p></blockquote><h3 id="931è¯»å·²æäº¤"><a class="markdownIt-Anchor" href="#931è¯»å·²æäº¤"></a> 9.3.1è¯»å·²æäº¤</h3><h4 id="1å®šä¹‰"><a class="markdownIt-Anchor" href="#1å®šä¹‰"></a> ï¼ˆ1ï¼‰å®šä¹‰</h4><blockquote><p>ä¸€ä¸ªäº‹åŠ¡åªèƒ½è¯»å–å…¶ä»–äº‹åŠ¡å·²ç»æäº¤çš„æ•°æ®ï¼Œå¯èƒ½å¯¼è‡´ä¸å¯é‡å¤è¯»é—®é¢˜</p></blockquote><h4 id="2å®ç°é€»è¾‘"><a class="markdownIt-Anchor" href="#2å®ç°é€»è¾‘"></a> ï¼ˆ2ï¼‰å®ç°é€»è¾‘</h4><ul><li>å¦‚æœç‰ˆæœ¬çš„åˆ›å»ºäº‹åŠ¡IDç­‰äºå½“å‰äº‹åŠ¡IDï¼Œå¹¶ä¸”ç‰ˆæœ¬çš„æ ‡å¿—åˆ é™¤ä¸ºç©ºï¼ˆè¡¨ç¤ºæœªè¢«åˆ é™¤ï¼‰ï¼ˆ<mark>å³è¯¥ç‰ˆæœ¬ç”±å½“å‰äº‹åŠ¡åˆ›å»ºå¹¶ä¸”è¿˜æ²¡è¢«åˆ é™¤ï¼Œå¯è§</mark>ï¼‰</li><li>å¦‚æœç‰ˆæœ¬çš„åˆ›å»ºäº‹åŠ¡IDå¯¹åº”çš„äº‹åŠ¡å·²ç»æäº¤ï¼Œå¹¶ä¸”ç‰ˆæœ¬çš„æ ‡å¿—åˆ é™¤ä¸ºç©ºï¼ˆæœªè¢«åˆ é™¤ï¼‰ï¼›<br />æˆ–è€…æ ‡å¿—åˆ é™¤çš„äº‹åŠ¡IDä¸æ˜¯å½“å‰äº‹åŠ¡IDï¼Œå¹¶è¯¥äº‹åŠ¡IDè¿˜æ²¡æäº¤<br />å³ç”±<mark>ä¸€ä¸ªå·²æäº¤çš„äº‹åŠ¡åˆ›å»ºä¸”å°šæœªè¢«åˆ é™¤</mark>ï¼›æˆ–è€…ç”±<mark>ä¸€ä¸ªå·²æäº¤çš„äº‹åŠ¡åˆ›å»ºä¸”åªæ˜¯æœªè¢«æäº¤çš„äº‹åŠ¡åˆ é™¤</mark></li></ul><h3 id="932å¯é‡å¤è¯»"><a class="markdownIt-Anchor" href="#932å¯é‡å¤è¯»"></a> 9.3.2å¯é‡å¤è¯»</h3><h4 id="1å®šä¹‰-2"><a class="markdownIt-Anchor" href="#1å®šä¹‰-2"></a> ï¼ˆ1ï¼‰å®šä¹‰</h4><blockquote><p>å®šä¹‰ï¼šäº‹åŠ¡åªèƒ½è¯»å–ï¼Œäº‹åŠ¡å¼€å§‹æ—¶å·²ç»æäº¤äº†çš„äº‹åŠ¡äº§ç”Ÿçš„æ•°æ®çš„ç‰ˆæœ¬ï¼Œç¡®ä¿äº‹åŠ¡åœ¨æ‰§è¡ŒæœŸé—´è¯»å–åˆ°çš„æ•°æ®æ˜¯ä¸€è‡´çš„</p></blockquote><h4 id="2å®ç°é€»è¾‘-2"><a class="markdownIt-Anchor" href="#2å®ç°é€»è¾‘-2"></a> ï¼ˆ2ï¼‰å®ç°é€»è¾‘</h4><ul><li>å¦‚æœç‰ˆæœ¬çš„åˆ›å»ºäº‹åŠ¡IDç­‰äºå½“å‰äº‹åŠ¡IDï¼Œå¹¶ä¸”ç‰ˆæœ¬çš„æ ‡å¿—åˆ é™¤ä¸ºç©ºï¼ˆè¡¨ç¤ºæœªè¢«åˆ é™¤ï¼‰ï¼ˆå³è¯¥ç‰ˆæœ¬ç”±å½“å‰äº‹åŠ¡åˆ›å»ºå¹¶ä¸”è¿˜æ²¡è¢«åˆ é™¤ï¼Œå¯è§ï¼‰</li><li>å¦‚æœç‰ˆæœ¬çš„åˆ›å»ºäº‹åŠ¡IDå·²ç»æäº¤ï¼Œå¹¶åˆ›å»ºäº‹åŠ¡IDå°äºå½“å‰äº‹åŠ¡IDï¼Œå¹¶åˆ›å»ºäº‹åŠ¡IDä¸åœ¨å½“å‰äº‹åŠ¡å¼€å§‹å‰ç«æ´»è·ƒçš„äº‹åŠ¡é›†åˆä¸­ï¼Œä¸”<ul><li>åˆ é™¤ç‰ˆæœ¬çš„äº‹åŠ¡IDä¸ºç©ºï¼Œè¡¨ç¤ºè¯¥ç‰ˆæœ¬å°šæœªè¢«åˆ é™¤</li></ul></li></ul>]]></content>
    
    
      
      
    <summary type="html">&lt;link rel=&quot;stylesheet&quot; class=&quot;aplayer-secondary-style-marker&quot; href=&quot;&#92;assets&#92;css&#92;APlayer.min.css&quot;&gt;&lt;script src=&quot;&#92;assets&#92;js&#92;APlayer.min.js&quot; cla</summary>
      
    
    
    
    <category term="ã€MiniDBã€‘" scheme="https://www.haipeng-lin.cn/categories/%E3%80%90MiniDB%E3%80%91/"/>
    
    
  </entry>
  
  <entry>
    <title>é¡¹ç›®éƒ¨ç½²</title>
    <link href="https://www.haipeng-lin.cn/posts/40aba349.html"/>
    <id>https://www.haipeng-lin.cn/posts/40aba349.html</id>
    <published>2024-09-09T02:13:35.000Z</published>
    <updated>2024-09-09T02:15:16.596Z</updated>
    
    <content type="html"><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="\assets\css\APlayer.min.css"><script src="\assets\js\APlayer.min.js" class="aplayer-secondary-script-marker"></script><h1 id="1dockeræ–¹å¼éƒ¨ç½²"><a class="markdownIt-Anchor" href="#1dockeræ–¹å¼éƒ¨ç½²"></a> 1.Dockeræ–¹å¼éƒ¨ç½²</h1><h2 id="11éƒ¨ç½²vue"><a class="markdownIt-Anchor" href="#11éƒ¨ç½²vue"></a> 1.1éƒ¨ç½²Vue</h2><h3 id="111ä¿®æ”¹æœåŠ¡å™¨åœ°å€"><a class="markdownIt-Anchor" href="#111ä¿®æ”¹æœåŠ¡å™¨åœ°å€"></a> 1.1.1ä¿®æ”¹æœåŠ¡å™¨åœ°å€</h3><blockquote><p>å…¨å±€ä¿®æ”¹è®¿é—®è·¯å¾„ä¸­localhostä¸ºæœåŠ¡å™¨åœ°å€</p></blockquote><h3 id="112æ‰“åŒ…"><a class="markdownIt-Anchor" href="#112æ‰“åŒ…"></a> 1.1.2æ‰“åŒ…</h3><blockquote><p>æ‰“åŒ…vueé¡¹ç›®ï¼Œç”Ÿæˆdistæ–‡ä»¶å¤¹</p><p>ä½¿ç”¨xftpå·¥å…·å°†distæ–‡ä»¶å¤¹ä¸Šä¼ åˆ°æœåŠ¡å™¨/home/å‰ç«¯é¡¹ç›®å æ–‡ä»¶å¤¹ä¸‹</p></blockquote><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">npm run build</span><br></pre></td></tr></table></figure><h3 id="113dockerfileæ–‡ä»¶"><a class="markdownIt-Anchor" href="#113dockerfileæ–‡ä»¶"></a> 1.1.3Dockerfileæ–‡ä»¶</h3><blockquote><p>åœ¨åŒçº§ç›®å½•ç¼–å†™Dockerfileæ–‡ä»¶ï¼Œå†…å®¹å¦‚ä¸‹</p></blockquote><figure class="highlight dockerfile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">FROM</span> nginx:latest</span><br><span class="line"><span class="keyword">COPY</span><span class="language-bash"> ./dist /usr/share/nginx/html/</span></span><br><span class="line"><span class="keyword">EXPOSE</span> <span class="number">80</span></span><br></pre></td></tr></table></figure><h3 id="114ç”Ÿæˆé•œåƒ"><a class="markdownIt-Anchor" href="#114ç”Ÿæˆé•œåƒ"></a> 1.1.4ç”Ÿæˆé•œåƒ</h3><blockquote><p>ç”Ÿæˆåä¸ºshuzhi_vueçš„é•œåƒ</p></blockquote><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker build -t shuzhi_vue .</span><br></pre></td></tr></table></figure><blockquote><p>æŸ¥çœ‹é•œåƒ</p></blockquote><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker images | grep shuzhi_vue</span><br></pre></td></tr></table></figure><h3 id="115è¿è¡Œå®¹å™¨"><a class="markdownIt-Anchor" href="#115è¿è¡Œå®¹å™¨"></a> 1.1.5è¿è¡Œå®¹å™¨</h3><blockquote><p>åŸºäºshuzhi_vueé•œåƒè¿è¡Œä¸€ä¸ªshuzhi_vue-80å®¹å™¨</p></blockquote><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker run -d -p 80:80 --name shuzhi_vue-80 shuzhi_vue</span><br></pre></td></tr></table></figure><blockquote><p>æŸ¥çœ‹æ­£åœ¨è¿è¡Œçš„å®¹å™¨</p></blockquote><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker ps</span><br></pre></td></tr></table></figure><h3 id="116æµ‹è¯•"><a class="markdownIt-Anchor" href="#116æµ‹è¯•"></a> 1.1.6æµ‹è¯•</h3><p>è®¿é—®åœ°å€ï¼š<a href="http://xn--ip-fr5c86lw2a0cw16k:80/">http://æœåŠ¡å™¨ipåœ°å€:80/</a></p><h2 id="12éƒ¨ç½²springboot"><a class="markdownIt-Anchor" href="#12éƒ¨ç½²springboot"></a> 1.2éƒ¨ç½²SpringBoot</h2><h3 id="121ä¿®æ”¹æ•°æ®åº“ä¿¡æ¯"><a class="markdownIt-Anchor" href="#121ä¿®æ”¹æ•°æ®åº“ä¿¡æ¯"></a> 1.2.1ä¿®æ”¹æ•°æ®åº“ä¿¡æ¯</h3><blockquote><p>ä¿®æ”¹mysqlã€redisç­‰æ•°æ®åº“çš„ è¿œç¨‹åœ°å€ã€ç”¨æˆ·åã€å¯†ç </p></blockquote><h3 id="122æ‰“åŒ…"><a class="markdownIt-Anchor" href="#122æ‰“åŒ…"></a> 1.2.2æ‰“åŒ…</h3><blockquote><p>mavenæ‰§è¡Œcleanã€installå‘½ä»¤ï¼Œç”ŸæˆjaråŒ…</p><p>ä½¿ç”¨xftpå·¥å…·å°†jaråŒ…ä¸Šä¼ åˆ°æœåŠ¡å™¨/home/åç«¯é¡¹ç›®å æ–‡ä»¶å¤¹ä¸‹</p></blockquote><h3 id="123dockerfileæ–‡ä»¶"><a class="markdownIt-Anchor" href="#123dockerfileæ–‡ä»¶"></a> 1.2.3Dockerfileæ–‡ä»¶</h3><blockquote><p>åœ¨åç«¯é¡¹ç›®åŒçº§ç›®å½•ä¸‹ï¼Œç¼–å†™Dockerfileæ–‡ä»¶</p></blockquote><figure class="highlight dockerfile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">FROM</span> java:<span class="number">8</span></span><br><span class="line"><span class="keyword">VOLUME</span><span class="language-bash"> /tmp</span></span><br><span class="line"><span class="keyword">ADD</span><span class="language-bash"> shuzhi_boot.jar shuzhi_boot.jar</span></span><br><span class="line"><span class="keyword">EXPOSE</span> <span class="number">8081</span></span><br><span class="line"><span class="keyword">ENTRYPOINT</span><span class="language-bash"> [<span class="string">&quot;java&quot;</span>,<span class="string">&quot;-jar&quot;</span>,<span class="string">&quot;/shuzhi_boot.jar&quot;</span>]</span></span><br></pre></td></tr></table></figure><h3 id="124ç”Ÿæˆé•œåƒ"><a class="markdownIt-Anchor" href="#124ç”Ÿæˆé•œåƒ"></a> 1.2.4ç”Ÿæˆé•œåƒ</h3><blockquote><p>ç”Ÿæˆé•œåƒ</p></blockquote><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker build -t shuzhi_boot .</span><br></pre></td></tr></table></figure><blockquote><p>æŸ¥çœ‹é•œåƒ</p></blockquote><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker images | grep shuzhi_boot</span><br></pre></td></tr></table></figure><h3 id="125è¿è¡Œå®¹å™¨"><a class="markdownIt-Anchor" href="#125è¿è¡Œå®¹å™¨"></a> 1.2.5è¿è¡Œå®¹å™¨</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker run -d -p 8081:8081 --name shuzhi_boot-8081 shuzhi_boot</span><br></pre></td></tr></table></figure><h2 id="13è¡¥å……"><a class="markdownIt-Anchor" href="#13è¡¥å……"></a> 1.3è¡¥å……</h2><blockquote><p>-vå‚æ•°ï¼šå®¿æœºåœ°å€æ˜ å°„åˆ°ä¸»æœºåœ°å€</p></blockquote><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker run -d -p 80:80 --name nginx-easypan -v /mydata/nginx/dist:/usr/share/nginx/html --restart=always nginx</span><br></pre></td></tr></table></figure>]]></content>
    
    
      
      
    <summary type="html">&lt;link rel=&quot;stylesheet&quot; class=&quot;aplayer-secondary-style-marker&quot; href=&quot;&#92;assets&#92;css&#92;APlayer.min.css&quot;&gt;&lt;script src=&quot;&#92;assets&#92;js&#92;APlayer.min.js&quot; cla</summary>
      
    
    
    
    <category term="éƒ¨ç½²" scheme="https://www.haipeng-lin.cn/categories/%E9%83%A8%E7%BD%B2/"/>
    
    
  </entry>
  
  <entry>
    <title>MiniDBâ€”â€”æ•°æ®ç®¡ç†å™¨</title>
    <link href="https://www.haipeng-lin.cn/posts/c9808524.html"/>
    <id>https://www.haipeng-lin.cn/posts/c9808524.html</id>
    <published>2024-09-05T00:28:24.000Z</published>
    <updated>2024-09-19T08:57:13.491Z</updated>
    
    <content type="html"><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="\assets\css\APlayer.min.css"><script src="\assets\js\APlayer.min.js" class="aplayer-secondary-script-marker"></script><h1 id="3æ•°æ®ç®¡ç†å™¨å¼•ç”¨è®¡æ•°ç¼“å­˜æ¡†æ¶"><a class="markdownIt-Anchor" href="#3æ•°æ®ç®¡ç†å™¨å¼•ç”¨è®¡æ•°ç¼“å­˜æ¡†æ¶"></a> 3.æ•°æ®ç®¡ç†å™¨â€”â€”å¼•ç”¨è®¡æ•°ç¼“å­˜æ¡†æ¶</h1><h2 id="31è®¾è®¡æ€è·¯"><a class="markdownIt-Anchor" href="#31è®¾è®¡æ€è·¯"></a> 3.1è®¾è®¡æ€è·¯</h2><p>â€‹å½“æŸä¸ªèµ„æºè¢«ä½¿ç”¨åˆ°æ—¶ï¼Œå°±åŠ å…¥åˆ°ç¼“å­˜ï¼Œå¦‚æœæœ‰å…¶ä»–çš„æ¨¡å—ä¹Ÿåœ¨è®¿é—®è¿™ä¸ªç¼“å­˜ï¼Œé‚£ä¹ˆè®¡æ•°å°±åŠ 1ï¼Œåªæœ‰å½“æ‰€æœ‰çš„æ¨¡å—éƒ½é‡Šæ”¾äº†è¯¥èµ„æºæ—¶ï¼Œå°†å…¶ä»ç¼“å­˜ä¸­é‡Šæ”¾</p><blockquote><p>é—®é¢˜ï¼šä¸ºä»€ä¹ˆä¸ä½¿ç”¨LRUï¼Ÿ</p><ul><li>å› ä¸ºMiniDBæ¶‰åŠåˆ°äº†å›æºæ“ä½œ<ul><li><strong>å›æºæ“ä½œ</strong> æŒ‡çš„æ˜¯å°†èµ„æºåˆ·å›æ•°æ®æºï¼Œä¸¾ä¾‹ï¼šæŸä¸ªæ—¶åˆ»ç¼“å­˜æ»¡äº†ï¼Œç¼“å­˜é©±é€äº†ä¸€ä¸ªèµ„æºï¼Œè¿™æ—¶ä¸Šå±‚æ¨¡å—æƒ³è¦å°†æŸä¸ªèµ„æºå¼ºåˆ¶åˆ·å›æ•°æ®æºï¼Œ<mark>è¿™ä¸ªèµ„æºæ°å¥½æ˜¯åˆšåˆšè¢«é©±é€çš„èµ„æº</mark>ã€‚é‚£ä¹ˆä¸Šå±‚æ¨¡å—å°±å‘ç°ï¼Œè¿™ä¸ªæ•°æ®åœ¨ç¼“å­˜é‡Œæ¶ˆå¤±äº†</li><li>LRU ç­–ç•¥ä¸­ï¼Œèµ„æºé©±é€ä¸å¯æ§ï¼Œä¸Šå±‚æ¨¡å—æ— æ³•æ„ŸçŸ¥ã€‚è€Œå¼•ç”¨è®¡æ•°ç­–ç•¥æ­£å¥½è§£å†³äº†è¿™ä¸ªé—®é¢˜ï¼Œåªæœ‰ä¸Šå±‚æ¨¡å—ä¸»åŠ¨é‡Šæ”¾å¼•ç”¨ï¼Œç¼“å­˜åœ¨ç¡®ä¿æ²¡æœ‰æ¨¡å—åœ¨ä½¿ç”¨è¿™ä¸ªèµ„æºäº†ï¼Œæ‰ä¼šå»é©±é€èµ„æº</li></ul></li></ul></blockquote><h2 id="32abstractcacheæŠ½è±¡ç¼“å­˜æ¥å£"><a class="markdownIt-Anchor" href="#32abstractcacheæŠ½è±¡ç¼“å­˜æ¥å£"></a> 3.2AbstractCacheæŠ½è±¡ç¼“å­˜æ¥å£</h2><blockquote><p>com.peng.minidb.backend.common.AbstractCacheç±»</p></blockquote><h3 id="321ç¼“å­˜ç»“æ„"><a class="markdownIt-Anchor" href="#321ç¼“å­˜ç»“æ„"></a> 3.2.1ç¼“å­˜ç»“æ„</h3><ul><li>cacheMap&lt;key,value&gt;ï¼šç¼“å­˜å®é™…å­˜å‚¨çš„æ•°æ®</li><li>referecesMap&lt;key,count&gt;ï¼šå­˜å‚¨æ¯ä¸ªèµ„æºçš„å¼•ç”¨è®¡æ•°</li><li>getting&lt;key,value&gt;ï¼šè®°å½•å“ªäº›èµ„æºå½“å‰æ­£åœ¨ä»æ•°æ®æºä¸­è·å–ï¼Œkeyæ˜¯èµ„æºçš„å”¯ä¸€æ ‡è¯†ç¬¦ï¼Œvalueæ˜¯å¸ƒå°”å€¼ï¼Œè¡¨ç¤ºè¯¥èµ„æºæ˜¯å¦æ­£åœ¨è¢«è·å–ä¸­ï¼ˆå¤šçº¿ç¨‹ç¯å¢ƒä¸‹å¯èƒ½ä¸€ä¸ªèµ„æºè¢«åŒæ—¶è·å–ï¼Œè€Œè·å–çš„è¿‡ç¨‹è¾ƒé•¿ï¼ˆå¦‚ä»æ–‡ä»¶ä¸­è¯»å–ï¼‰ï¼Œé˜²æ­¢å¤šçº¿ç¨‹å¹¶å‘é—®é¢˜è€Œå¼•å…¥è¯¥mapï¼‰</li><li>maxResourcesï¼šç¼“å­˜çš„æœ€å¤§èµ„æºæ•°ï¼Œé˜²æ­¢å†…å­˜æº¢å‡º</li><li>countï¼šå½“å‰ç¼“å­˜çš„èµ„æºæ•°</li><li>lockï¼šé”ï¼ˆæ•´ä¸ªæ•°æ®ç¼“å­˜çš„é”ï¼‰</li></ul><h3 id="322æŠ½è±¡æ–¹æ³•"><a class="markdownIt-Anchor" href="#322æŠ½è±¡æ–¹æ³•"></a> 3.2.2æŠ½è±¡æ–¹æ³•</h3><blockquote><p>ä¸¤ä¸ªæ–¹æ³•å‡ç”±PageCacheImplï¼ˆé¡µé¢ç¼“å­˜ï¼‰ã€DataManagerImplï¼ˆæ•°æ®ç®¡ç†ï¼‰ã€VersionManagerImplï¼ˆç‰ˆæœ¬ç®¡ç†ï¼‰å®ç°ç±»å®ç°ï¼Œå…·ä½“é€»è¾‘å…·ä½“å®ç°</p></blockquote><ul><li>getForCache(key)ï¼šå½“èµ„æºä¸åœ¨ç¼“å­˜æ—¶çš„è·å–è¡Œä¸º</li><li>releaseForCache(key)ï¼šå½“èµ„æºè¢«é©±é€æ—¶çš„å†™å›è¡Œä¸º</li></ul><h3 id="323é‡è¦æ–¹æ³•"><a class="markdownIt-Anchor" href="#323é‡è¦æ–¹æ³•"></a> 3.2.3é‡è¦æ–¹æ³•</h3><ul><li>get(key)ï¼š<ul><li>ä½œç”¨ï¼šä»ç¼“å­˜è·å–æŒ‡å®škeyçš„èµ„æºè¿‡ç¨‹ï¼š</li><li>é¦–å…ˆï¼Œå…ˆè·å–æŠ½è±¡ç¼“å­˜ç»“æ„çš„é”ï¼Œå†åˆ¤æ–­<mark>æ˜¯å¦æœ‰å…¶ä»–çº¿ç¨‹æ­£åœ¨ä»æ•°æ®æºä¸­è·å–è¯¥èµ„æº</mark><ul><li>æœ‰ï¼Œè§£é”ï¼Œç¡çœ ä¸€ç§’å¹¶continue</li><li>æ²¡æœ‰ï¼Œ<mark>åˆ¤æ–­èµ„æºæ˜¯å¦å­˜åœ¨äºç¼“å­˜ä¸­</mark><ul><li>å­˜åœ¨ï¼Œå°†èµ„æºçš„å¼•ç”¨æ•°+1ï¼Œè§£é”ï¼Œç›´æ¥è·å–èµ„æºå¹¶è¿”å›</li><li>ä¸å­˜åœ¨ï¼Œåˆ¤æ–­èµ„æºæ€»æ•°æ˜¯å¦è¶…è¿‡æœ€å¤§å€¼ï¼Œæ²¡è¶…è¿‡ï¼Œåˆ™åœ¨<code>getting</code>ä¸­æ ‡è®°trueï¼Œç„¶åè¯¥çº¿ç¨‹ä»æ•°æ®æºä¸­è·å–èµ„æºï¼Œè·å–åˆ°ä¹‹åæ ‡è®°falseï¼Œè§£é”</li></ul></li></ul></li></ul></li></ul><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">protected</span> T <span class="title function_">get</span><span class="params">(<span class="type">long</span> key)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">    <span class="keyword">while</span>(<span class="literal">true</span>) &#123;</span><br><span class="line">        lock.lock();</span><br><span class="line">        <span class="comment">// 1ã€è¯·æ±‚çš„èµ„æºæ­£åœ¨è¢«å…¶ä»–çº¿ç¨‹è·å–</span></span><br><span class="line">        <span class="keyword">if</span>(getting.containsKey(key)) &#123;</span><br><span class="line">            lock.unlock();</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                Thread.sleep(<span class="number">1</span>);</span><br><span class="line">            &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">                e.printStackTrace();</span><br><span class="line">                <span class="keyword">continue</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">continue</span>;</span><br><span class="line">        &#125;</span><br><span class="line"><span class="comment">// 2ã€åˆ¤æ–­èµ„æºæ˜¯å¦å­˜åœ¨äºç¼“å­˜ä¸­</span></span><br><span class="line">        <span class="keyword">if</span>(cache.containsKey(key)) &#123;</span><br><span class="line">            <span class="comment">// 2.1ã€èµ„æºåœ¨ç¼“å­˜ä¸­ï¼Œç›´æ¥è¿”å›</span></span><br><span class="line">            <span class="type">T</span> <span class="variable">obj</span> <span class="operator">=</span> cache.get(key);</span><br><span class="line">            references.put(key, references.get(key) + <span class="number">1</span>);</span><br><span class="line">            lock.unlock();</span><br><span class="line">            <span class="keyword">return</span> obj;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 3ã€å°è¯•è·å–è¯¥èµ„æº</span></span><br><span class="line">        <span class="keyword">if</span>(maxResource &gt; <span class="number">0</span> &amp;&amp; count == maxResource) &#123;</span><br><span class="line">            lock.unlock();</span><br><span class="line">            <span class="keyword">throw</span> Error.CacheFullException;</span><br><span class="line">        &#125;</span><br><span class="line">        count ++;</span><br><span class="line">        getting.put(key, <span class="literal">true</span>);</span><br><span class="line">        lock.unlock();</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="type">T</span> <span class="variable">obj</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        obj = getForCache(key);</span><br><span class="line">    &#125; <span class="keyword">catch</span>(Exception e) &#123;</span><br><span class="line">        lock.lock();</span><br><span class="line">        count --;</span><br><span class="line">        getting.remove(key);</span><br><span class="line">        lock.unlock();</span><br><span class="line">        <span class="keyword">throw</span> e;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    lock.lock();</span><br><span class="line">    getting.remove(key);</span><br><span class="line">    cache.put(key, obj);</span><br><span class="line">    references.put(key, <span class="number">1</span>);</span><br><span class="line">    lock.unlock();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> obj;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ul><li>release(key)ï¼š<ul><li>ä½œç”¨ï¼šé‡Šæ”¾ç¼“å­˜</li><li>é‡Šæ”¾ç¼“å­˜æ—¶ï¼Œå°†å¯¹åº”çš„å¼•ç”¨è®¡æ•°-1ï¼Œå¦‚æœå·²ç»å‡åˆ°0äº†å°±å›æºï¼Œç„¶ååˆ é™¤ç¼“å­˜ä¸­ç›¸å…³çš„å„ç§æ•°æ®</li></ul></li></ul><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * å¼ºè¡Œé‡Šæ”¾ä¸€ä¸ªç¼“å­˜</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">release</span><span class="params">(<span class="type">long</span> key)</span> &#123;</span><br><span class="line">    lock.lock(); <span class="comment">// è·å–é”</span></span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="type">int</span> <span class="variable">ref</span> <span class="operator">=</span> references.get(key) - <span class="number">1</span>; <span class="comment">// è·å–èµ„æºçš„å¼•ç”¨è®¡æ•°å¹¶å‡ä¸€</span></span><br><span class="line">        <span class="keyword">if</span> (ref == <span class="number">0</span>) &#123; <span class="comment">// å¦‚æœå¼•ç”¨è®¡æ•°ä¸º0</span></span><br><span class="line">            <span class="type">T</span> <span class="variable">obj</span> <span class="operator">=</span> cache.get(key); <span class="comment">// ä»ç¼“å­˜ä¸­è·å–èµ„æº</span></span><br><span class="line">            releaseForCache(obj); <span class="comment">// å¤„ç†èµ„æºçš„é‡Šæ”¾</span></span><br><span class="line">            references.remove(key); <span class="comment">// ä»å¼•ç”¨è®¡æ•°çš„æ˜ å°„ä¸­ç§»é™¤èµ„æº</span></span><br><span class="line">            cache.remove(key); <span class="comment">// ä»ç¼“å­˜ä¸­ç§»é™¤èµ„æº</span></span><br><span class="line">            count--; <span class="comment">// å°†ç¼“å­˜ä¸­çš„èµ„æºè®¡æ•°å‡ä¸€</span></span><br><span class="line">        &#125; <span class="keyword">else</span> &#123; <span class="comment">// å¦‚æœå¼•ç”¨è®¡æ•°ä¸ä¸º0</span></span><br><span class="line">            references.put(key, ref); <span class="comment">// æ›´æ–°èµ„æºçš„å¼•ç”¨è®¡æ•°</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">        lock.unlock(); <span class="comment">// é‡Šæ”¾é”</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ul><li>close()ï¼š<ul><li>ä½œç”¨ï¼šå…³é—­ç¼“å­˜</li><li>æ³¨æ„ï¼Œåœ¨å…³é—­ç¼“å­˜ç»“æ„æ—¶ï¼Œæ‰€æœ‰çš„ç¼“å­˜èµ„æºè¦å¼ºè¡Œå›æº</li></ul></li></ul><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * å…³é—­ç¼“å­˜ï¼Œå†™å›æ‰€æœ‰èµ„æº</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">close</span><span class="params">()</span> &#123;</span><br><span class="line">    lock.lock();</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="comment">//è·å–æ‰€æœ‰èµ„æºkey</span></span><br><span class="line">        Set&lt;Long&gt; keys = cache.keySet();</span><br><span class="line">        <span class="keyword">for</span> (<span class="type">long</span> key : keys) &#123;</span><br><span class="line">            <span class="comment">//è·å–ç¼“å­˜</span></span><br><span class="line">            <span class="type">T</span> <span class="variable">obj</span> <span class="operator">=</span> cache.get(key);</span><br><span class="line">            <span class="comment">//é‡Šæ”¾ç¼“å­˜</span></span><br><span class="line">            releaseForCache(obj);</span><br><span class="line">            <span class="comment">//å¼•ç”¨è®¡æ•°ç§»é™¤ç¼“å­˜</span></span><br><span class="line">            references.remove(key);</span><br><span class="line">            <span class="comment">//å®é™…ç¼“å­˜ç§»é™¤ç¼“å­˜</span></span><br><span class="line">            cache.remove(key);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">        <span class="comment">//é‡Šæ”¾é”</span></span><br><span class="line">        lock.unlock();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h1 id="4æ•°æ®ç®¡ç†å™¨æ•°æ®é¡µç¼“å­˜"><a class="markdownIt-Anchor" href="#4æ•°æ®ç®¡ç†å™¨æ•°æ®é¡µç¼“å­˜"></a> 4.æ•°æ®ç®¡ç†å™¨â€”â€”æ•°æ®é¡µç¼“å­˜</h1><h2 id="41è®¾è®¡æ€è·¯"><a class="markdownIt-Anchor" href="#41è®¾è®¡æ€è·¯"></a> 4.1è®¾è®¡æ€è·¯</h2><p>â€‹æ•°æ®é¡µç¼“å­˜ï¼šå°†é¡µé¢æ•°æ®ä¿å­˜åœ¨å†…å­˜ä¸­ï¼Œå‡å°é¢‘ç¹çš„ç£ç›˜I/Oæ“ä½œï¼Œå°†é»˜è®¤æ•°æ®é¡µçš„å¤§å°å®šä¸º8KB</p><h2 id="42pageç±»"><a class="markdownIt-Anchor" href="#42pageç±»"></a> 4.2Pageç±»</h2><blockquote><p>com.peng.minidb.backend.dm.page.Pageç±»</p><p>com.peng.minidb.backend.dm.page.PageImplç±»</p></blockquote><ul><li>å®šä¹‰ï¼šé¡µé¢(Page)æ˜¯æ•°æ®åº“ä¸­å­˜å‚¨æ•°æ®çš„åŸºæœ¬å•å…ƒ</li><li>ç»“æ„ï¼š<ul><li>pageNumberï¼šé¡µå·</li><li>dataï¼šå­—èŠ‚æ•°æ®</li><li>dirtyï¼šæ˜¯å¦è„é¡µé¢æ•°æ®ï¼›è„é¡µé¢åœ¨é‡Šæ”¾é¡µé¢ç¼“å­˜æ—¶éœ€è¦è¢«å†™å›åˆ°ç£ç›˜</li><li>lockï¼šé”ï¼Œç”¨äºä¿è¯é¡µé¢æ“ä½œçš„çº¿ç¨‹å®‰å…¨</li><li>PageCacheï¼šå¼•ç”¨é¡µé¢ç¼“å­˜</li></ul></li></ul><h2 id="43pagecacheé¡µé¢ç¼“å­˜æ¥å£"><a class="markdownIt-Anchor" href="#43pagecacheé¡µé¢ç¼“å­˜æ¥å£"></a> 4.3PageCacheé¡µé¢ç¼“å­˜æ¥å£</h2><blockquote><p>com.peng.minidb.backend.dm.pageCache.PageCache</p></blockquote><p>â€‹ å®šä¹‰äº†é¡µé¢ç¼“å­˜çš„æ¥å£ï¼ŒåŒ…æ‹¬æ–°å»ºé¡µé¢ã€è·å–é¡µé¢ã€é‡Šæ”¾é¡µé¢ã€å…³é—­ç¼“å­˜ã€æ ¹æ®æœ€å¤§é¡µå·æˆªæ–­ç¼“å­˜ã€è·å–å½“å‰é¡µé¢æ•°é‡ä»¥åŠåˆ·æ–°é¡µé¢ç­‰æ–¹æ³•</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">PageCache</span> &#123;</span><br><span class="line">    <span class="comment">// æ–°å»ºé¡µé¢</span></span><br><span class="line">    <span class="type">int</span> <span class="title function_">newPage</span><span class="params">(<span class="type">byte</span>[] initData)</span>;</span><br><span class="line">    Page <span class="title function_">getPage</span><span class="params">(<span class="type">int</span> pgno)</span> <span class="keyword">throws</span> Exception;</span><br><span class="line">    <span class="keyword">void</span> <span class="title function_">close</span><span class="params">()</span>;</span><br><span class="line">    <span class="keyword">void</span> <span class="title function_">release</span><span class="params">(Page page)</span>;</span><br><span class="line">    <span class="keyword">void</span> <span class="title function_">truncateByBgno</span><span class="params">(<span class="type">int</span> maxPgno)</span>;</span><br><span class="line">    <span class="type">int</span> <span class="title function_">getPageNumber</span><span class="params">()</span>;</span><br><span class="line">    <span class="keyword">void</span> <span class="title function_">flushPage</span><span class="params">(Page pg)</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="44pagecacheimplé¡µé¢ç¼“å­˜å®ç°ç±»"><a class="markdownIt-Anchor" href="#44pagecacheimplé¡µé¢ç¼“å­˜å®ç°ç±»"></a> 4.4PageCacheImplé¡µé¢ç¼“å­˜å®ç°ç±»</h2><h3 id="441ç»§æ‰¿æŠ½è±¡ç¼“å­˜æ¡†æ¶"><a class="markdownIt-Anchor" href="#441ç»§æ‰¿æŠ½è±¡ç¼“å­˜æ¡†æ¶"></a> 4.4.1ç»§æ‰¿æŠ½è±¡ç¼“å­˜æ¡†æ¶</h3><p>å®ç°ä»¥ä¸‹ä¸¤ä¸ªæ–¹æ³•</p><ul><li><code>getForCache()</code>ï¼šç”¨äºä»æ–‡ä»¶ä¸­è¯»å–é¡µé¢æ•°æ®ï¼Œå¹¶å°†å…¶åŒ…è£…æˆ <code>Page</code> å¯¹è±¡ã€‚</li><li><code>releaseForCache()</code>ï¼šç”¨äºåœ¨é©±é€é¡µé¢æ—¶æ ¹æ®é¡µé¢æ˜¯å¦ä¸ºè„é¡µé¢ï¼Œå†³å®šæ˜¯å¦å°†å…¶å†™å›æ–‡ä»¶ç³»ç»Ÿã€‚</li></ul><h4 id="1getforcache"><a class="markdownIt-Anchor" href="#1getforcache"></a> ï¼ˆ1ï¼‰getForCache()</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * æ ¹æ®pageNumberä»æ•°æ®åº“æ–‡ä»¶ä¸­è¯»å–é¡µæ•°æ®ï¼Œå¹¶åŒ…è£¹æˆPage</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">protected</span> Page <span class="title function_">getForCache</span><span class="params">(<span class="type">long</span> key)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">    <span class="comment">// å°†keyè½¬æ¢ä¸ºé¡µç </span></span><br><span class="line">    <span class="type">int</span> <span class="variable">pgno</span> <span class="operator">=</span> (<span class="type">int</span>) key;</span><br><span class="line">    <span class="comment">// è®¡ç®—é¡µç å¯¹åº”çš„åç§»é‡</span></span><br><span class="line">    <span class="type">long</span> <span class="variable">offset</span> <span class="operator">=</span> PageCacheImpl.pageOffset(pgno);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// åˆ†é…ä¸€ä¸ªå¤§å°ä¸ºPAGE_SIZEçš„ByteBuffer</span></span><br><span class="line">    <span class="type">ByteBuffer</span> <span class="variable">buf</span> <span class="operator">=</span> ByteBuffer.allocate(PAGE_SIZE);</span><br><span class="line">    <span class="comment">// é”å®šæ–‡ä»¶ï¼Œç¡®ä¿çº¿ç¨‹å®‰å…¨</span></span><br><span class="line">    fileLock.lock();</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="comment">// è®¾ç½®æ–‡ä»¶é€šé“çš„ä½ç½®ä¸ºè®¡ç®—å‡ºçš„åç§»é‡</span></span><br><span class="line">        fc.position(offset);</span><br><span class="line">        <span class="comment">// ä»æ–‡ä»¶é€šé“è¯»å–æ•°æ®åˆ°ByteBuffer</span></span><br><span class="line">        fc.read(buf);</span><br><span class="line">    &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">        <span class="comment">// å¦‚æœå‘ç”Ÿå¼‚å¸¸ï¼Œè°ƒç”¨Panic.panicæ–¹æ³•å¤„ç†</span></span><br><span class="line">        Panic.panic(e);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// æ— è®ºæ˜¯å¦å‘ç”Ÿå¼‚å¸¸ï¼Œéƒ½è¦è§£é”</span></span><br><span class="line">    fileLock.unlock();</span><br><span class="line">    <span class="comment">// ä½¿ç”¨è¯»å–åˆ°çš„æ•°æ®ã€é¡µç å’Œå½“å‰å¯¹è±¡åˆ›å»ºä¸€ä¸ªæ–°çš„PageImplå¯¹è±¡å¹¶è¿”å›</span></span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">PageImpl</span>(pgno, buf.array(), <span class="built_in">this</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="title function_">PageImpl</span><span class="params">(<span class="type">int</span> pageNumber, <span class="type">byte</span>[] data, PageCache pc)</span> &#123;</span><br><span class="line">    <span class="built_in">this</span>.pageNumber = pageNumber; <span class="comment">// è®¾ç½®é¡µé¢çš„é¡µå·</span></span><br><span class="line">    <span class="built_in">this</span>.data = data; <span class="comment">// è®¾ç½®é¡µé¢å®é™…åŒ…å«çš„å­—èŠ‚æ•°æ®</span></span><br><span class="line">    <span class="built_in">this</span>.pc = pc; <span class="comment">// è®¾ç½®é¡µé¢ç¼“å­˜</span></span><br><span class="line">    lock = <span class="keyword">new</span> <span class="title class_">ReentrantLock</span>(); <span class="comment">// åˆå§‹åŒ–ä¸€ä¸ªæ–°çš„å¯é‡å…¥é”</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="2releaseforcache"><a class="markdownIt-Anchor" href="#2releaseforcache"></a> ï¼ˆ2ï¼‰releaseForCache</h4><p>â€‹å½“é¡µé¢ä¸å†éœ€è¦æ—¶ï¼Œ<code>releaseForCache()</code> æ–¹æ³•ä¼š<mark>æ£€æŸ¥é¡µé¢æ˜¯å¦æ˜¯è„é¡µé¢</mark>ï¼Œå¦‚æœé¡µé¢è¢«æ ‡è®°ä¸ºè„é¡µé¢ï¼ˆå³å…¶æ•°æ®å·²è¢«ä¿®æ”¹ä½†å°šæœªå†™å›ç£ç›˜ï¼‰ï¼Œåˆ™éœ€è¦é€šè¿‡ <code>flush()</code> æ–¹æ³•å°†å…¶å†…å®¹å†™å…¥ç£ç›˜ã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">releaseForCache</span><span class="params">(Page pg)</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (pg.isDirty()) &#123;</span><br><span class="line">        flush(pg);</span><br><span class="line">        pg.setDirty(<span class="literal">false</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"> <span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">flush</span><span class="params">(Page pg)</span> &#123;</span><br><span class="line">    <span class="type">int</span> <span class="variable">pgno</span> <span class="operator">=</span> pg.getPageNumber(); <span class="comment">// è·å–Pageçš„é¡µç </span></span><br><span class="line">    <span class="type">long</span> <span class="variable">offset</span> <span class="operator">=</span> pageOffset(pgno); <span class="comment">// è®¡ç®—Pageåœ¨æ–‡ä»¶ä¸­çš„åç§»é‡</span></span><br><span class="line"></span><br><span class="line">    fileLock.lock(); <span class="comment">// åŠ é”ï¼Œç¡®ä¿çº¿ç¨‹å®‰å…¨</span></span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="type">ByteBuffer</span> <span class="variable">buf</span> <span class="operator">=</span> ByteBuffer.wrap(pg.getData()); <span class="comment">// å°†Pageçš„æ•°æ®åŒ…è£…æˆByteBuffer</span></span><br><span class="line">        fc.position(offset); <span class="comment">// è®¾ç½®æ–‡ä»¶é€šé“çš„ä½ç½®</span></span><br><span class="line">        fc.write(buf); <span class="comment">// å°†æ•°æ®å†™å…¥åˆ°æ–‡ä»¶ä¸­</span></span><br><span class="line">        fc.force(<span class="literal">false</span>); <span class="comment">// å¼ºåˆ¶å°†æ•°æ®ä»æ“ä½œç³»ç»Ÿçš„ç¼“å­˜åˆ·æ–°åˆ°ç£ç›˜</span></span><br><span class="line">    &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">        Panic.panic(e); <span class="comment">// å¦‚æœå‘ç”Ÿå¼‚å¸¸ï¼Œè°ƒç”¨Panic.panicæ–¹æ³•å¤„ç†</span></span><br><span class="line">    &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">        fileLock.unlock(); <span class="comment">// æœ€åï¼Œæ— è®ºæ˜¯å¦å‘ç”Ÿå¼‚å¸¸ï¼Œéƒ½è¦è§£é”</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="442æ–°å»ºé¡µé¢"><a class="markdownIt-Anchor" href="#442æ–°å»ºé¡µé¢"></a> 4.4.2æ–°å»ºé¡µé¢</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="type">int</span> <span class="title function_">newPage</span><span class="params">(<span class="type">byte</span>[] initData)</span> &#123;</span><br><span class="line">    <span class="type">int</span> <span class="variable">pgno</span> <span class="operator">=</span> pageNumbers.incrementAndGet();</span><br><span class="line">    <span class="type">Page</span> <span class="variable">pg</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">PageImpl</span>(pgno, initData, <span class="literal">null</span>);</span><br><span class="line">    flush(pg);  <span class="comment">// æ–°å»ºçš„é¡µé¢éœ€è¦ç«‹åˆ»å†™å›</span></span><br><span class="line">    <span class="keyword">return</span> pgno;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="443æ•°æ®æ¢å¤æ“ä½œ"><a class="markdownIt-Anchor" href="#443æ•°æ®æ¢å¤æ“ä½œ"></a> 4.4.3æ•°æ®æ¢å¤æ“ä½œ</h3><p>â€‹æ•°æ®æ¢å¤æ“ä½œæ˜¯ä¸ºäº†ç¡®ä¿åœ¨ç³»ç»Ÿå´©æºƒåï¼Œèƒ½å¤Ÿä»æ—¥å¿—æˆ–å…¶ä»–æŒä¹…åŒ–å­˜å‚¨ä¸­æ¢å¤æ•°æ®ã€‚<code>recoverInsert()</code> å’Œ <code>recoverUpdate()</code> æ–¹æ³•ç”¨äºåœ¨æ•°æ®åº“å´©æºƒåé‡æ–°æ’å…¥æ•°æ®å’Œæ¢å¤ä¿®æ”¹</p><blockquote><p><code>recoverInsert()</code>ï¼šå°†æ•°æ®æ’å…¥åˆ°æŒ‡å®šçš„åç§»ä½ç½®ï¼Œå¹¶æ›´æ–°ç©ºé—²ç©ºé—´çš„åç§»é‡</p><p><code>recoverUpdate()</code>ï¼šåœ¨æŒ‡å®šçš„åç§»ä½ç½®ç›´æ¥æ›´æ–°æ•°æ®ï¼Œè€Œä¸æ›´æ–°ç©ºé—²ç©ºé—´çš„åç§»é‡</p></blockquote><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// å°†rawæ’å…¥pgä¸­çš„offsetä½ç½®ï¼Œå¹¶å°†pgçš„offsetè®¾ç½®ä¸ºè¾ƒå¤§çš„offset</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">recoverInsert</span><span class="params">(Page pg, <span class="type">byte</span>[] raw, <span class="type">short</span> offset)</span> &#123;</span><br><span class="line">    pg.setDirty(<span class="literal">true</span>); <span class="comment">// å°†pgçš„dirtyæ ‡å¿—è®¾ç½®ä¸ºtrueï¼Œè¡¨ç¤ºpgçš„æ•°æ®å·²ç»è¢«ä¿®æ”¹</span></span><br><span class="line">    System.arraycopy(raw, <span class="number">0</span>, pg.getData(), offset, raw.length); <span class="comment">// å°†rawçš„æ•°æ®å¤åˆ¶åˆ°pgçš„æ•°æ®ä¸­çš„offsetä½ç½®</span></span><br><span class="line"></span><br><span class="line">    <span class="type">short</span> <span class="variable">rawFSO</span> <span class="operator">=</span> getFSO(pg.getData()); <span class="comment">// è·å–pgçš„å½“å‰ç©ºé—²ç©ºé—´åç§»é‡</span></span><br><span class="line">    <span class="keyword">if</span> (rawFSO &lt; offset + raw.length) &#123; <span class="comment">// å¦‚æœå½“å‰çš„ç©ºé—²ç©ºé—´åç§»é‡å°äºoffset + raw.length</span></span><br><span class="line">        setFSO(pg.getData(), (<span class="type">short</span>) (offset + raw.length)); <span class="comment">// å°†pgçš„ç©ºé—²ç©ºé—´åç§»é‡è®¾ç½®ä¸ºoffset + raw.length</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// å°†rawæ’å…¥pgä¸­çš„offsetä½ç½®ï¼Œä¸æ›´æ–°update</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">recoverUpdate</span><span class="params">(Page pg, <span class="type">byte</span>[] raw, <span class="type">short</span> offset)</span> &#123;</span><br><span class="line">    pg.setDirty(<span class="literal">true</span>); <span class="comment">// å°†pgçš„dirtyæ ‡å¿—è®¾ç½®ä¸ºtrueï¼Œè¡¨ç¤ºpgçš„æ•°æ®å·²ç»è¢«ä¿®æ”¹</span></span><br><span class="line">    System.arraycopy(raw, <span class="number">0</span>, pg.getData(), offset, raw.length); <span class="comment">// å°†rawçš„æ•°æ®å¤åˆ¶åˆ°pgçš„æ•°æ®ä¸­çš„offsetä½ç½®</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h1 id="5æ•°æ®ç®¡ç†å™¨æ•°æ®é¡µç®¡ç†"><a class="markdownIt-Anchor" href="#5æ•°æ®ç®¡ç†å™¨æ•°æ®é¡µç®¡ç†"></a> 5.æ•°æ®ç®¡ç†å™¨â€”â€”æ•°æ®é¡µç®¡ç†</h1><h2 id="51è®¾è®¡æ€è·¯"><a class="markdownIt-Anchor" href="#51è®¾è®¡æ€è·¯"></a> 5.1è®¾è®¡æ€è·¯</h2><p>åœ¨MiniDBä¸­ï¼Œé¡µé¢ç®¡ç†çš„è®¾è®¡ç›®æ ‡ä¹‹ä¸€æ˜¯ç¡®ä¿ç³»ç»Ÿåœ¨å¯åŠ¨æ—¶èƒ½å¤Ÿæ­£ç¡®æ¢å¤ï¼Œå¹¶ä¸”åœ¨è¿è¡Œè¿‡ç¨‹ä¸­æœ‰æ•ˆç®¡ç†é¡µé¢çš„ç©ºé—²ç©ºé—´</p><h2 id="52ç¬¬ä¸€é¡µ"><a class="markdownIt-Anchor" href="#52ç¬¬ä¸€é¡µ"></a> 5.2ç¬¬ä¸€é¡µ</h2><h3 id="521å®šä¹‰"><a class="markdownIt-Anchor" href="#521å®šä¹‰"></a> 5.2.1å®šä¹‰</h3><p>â€‹æ•°æ®æ–‡ä»¶çš„ç¬¬ä¸€é¡µ<mark>ç”¨äºæ•°æ®åº“å¯åŠ¨æ£€æŸ¥</mark>ï¼Œæ˜¯å¦éœ€è¦æ‰§è¡Œæ•°æ®æ¢å¤æµç¨‹</p><p>â€‹åœ¨æ¯æ¬¡==<strong>å¯åŠ¨æ•°æ®åº“</strong><mark>çš„æ—¶å€™ï¼Œç”Ÿæˆä¸€æ®µ8å­—èŠ‚çš„éšæœºå­—èŠ‚ï¼Œ<mark>å­˜å‚¨åœ¨100-107å­—èŠ‚å¤„</mark>ï¼Œ</mark><strong>æ­£å¸¸å…³é—­æ—¶</strong>==ï¼Œè¿™ä¸²å­—èŠ‚ä¼šè¢«å¤åˆ¶åˆ°ç¬¬ä¸€é¡µçš„ <mark>108~115</mark> å­—èŠ‚ã€‚æ¯æ¬¡æ•°æ®åº“å¯åŠ¨æ—¶ï¼Œç³»ç»Ÿä¼šæ¯”è¾ƒè¿™ä¸¤å¤„çš„å­—èŠ‚ï¼Œå¦‚æœç›¸åŒï¼Œåˆ™è¡¨æ˜ä¸Šæ¬¡å…³é—­æ˜¯æ­£å¸¸çš„ï¼›å¦‚æœä¸åŒï¼Œåˆ™æ„å‘³ç€éœ€è¦æ‰§è¡Œæ•°æ®æ¢å¤æµç¨‹</p><h3 id="522ç›¸å…³å‡½æ•°"><a class="markdownIt-Anchor" href="#522ç›¸å…³å‡½æ•°"></a> 5.2.2ç›¸å…³å‡½æ•°</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// è®¾ç½®å¯åŠ¨æ—¶çš„æ ¡éªŒå­—èŠ‚</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">setVcOpen</span><span class="params">(Page pg)</span> &#123;</span><br><span class="line">    pg.setDirty(<span class="literal">true</span>);</span><br><span class="line">    setVcOpen(pg.getData());</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">setVcOpen</span><span class="params">(<span class="type">byte</span>[] raw)</span> &#123;</span><br><span class="line">    <span class="comment">// ç”Ÿæˆå¹¶è®¾ç½®éšæœºæ ¡éªŒå­—èŠ‚</span></span><br><span class="line">    System.arraycopy(RandomUtil.randomBytes(LEN_VC), <span class="number">0</span>, raw, OF_VC, LEN_VC);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// è®¾ç½®å…³é—­æ—¶çš„æ ¡éªŒå­—èŠ‚</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">setVcClose</span><span class="params">(Page pg)</span> &#123;</span><br><span class="line">    pg.setDirty(<span class="literal">true</span>);</span><br><span class="line">    setVcClose(pg.getData());</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">setVcClose</span><span class="params">(<span class="type">byte</span>[] raw)</span> &#123;</span><br><span class="line">    <span class="comment">// å°†å¯åŠ¨æ—¶çš„æ ¡éªŒå­—èŠ‚å¤åˆ¶åˆ°å…³é—­æ—¶çš„å­˜å‚¨ä½ç½®</span></span><br><span class="line">    System.arraycopy(raw, OF_VC, raw, OF_VC + LEN_VC, LEN_VC);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// æ ¡éªŒå­—èŠ‚æ˜¯å¦ä¸€è‡´</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="type">boolean</span> <span class="title function_">checkVc</span><span class="params">(Page pg)</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> checkVc(pg.getData());</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="type">boolean</span> <span class="title function_">checkVc</span><span class="params">(<span class="type">byte</span>[] raw)</span> &#123;</span><br><span class="line">    <span class="comment">// æ¯”è¾ƒå¯åŠ¨å’Œå…³é—­æ—¶çš„æ ¡éªŒå­—èŠ‚</span></span><br><span class="line">    <span class="keyword">return</span> Arrays.equals(Arrays.copyOfRange(raw, OF_VC, OF_VC + LEN_VC),</span><br><span class="line">                         Arrays.copyOfRange(raw, OF_VC + LEN_VC, OF_VC + <span class="number">2</span> * LEN_VC));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="53æ™®é€šé¡µ"><a class="markdownIt-Anchor" href="#53æ™®é€šé¡µ"></a> 5.3æ™®é€šé¡µ</h2><p>â€‹æ™®é€šé¡µæ˜¯ç”¨äº<mark>å®é™…å­˜å‚¨æ•°æ®çš„é¡µé¢</mark>ã€‚åœ¨MiniDBä¸­ï¼Œæ¯ä¸ªæ™®é€šé¡µä»¥ä¸€ä¸ª2å­—èŠ‚çš„æ— ç¬¦å·æ•°å¼€å¤´ï¼Œè¡¨ç¤º<mark>è¯¥é¡µçš„ç©ºé—²ä½ç½®çš„åç§»é‡</mark>ã€‚</p><p>â€‹ç”±äºé¡µé¢çš„æœ€å¤§å®¹é‡ä¸º8Kï¼Œå› æ­¤2å­—èŠ‚çš„åç§»é‡è¶³ä»¥è¡¨è¾¾è¿™ä¸€é¡µçš„æ‰€æœ‰å¯èƒ½åç§»</p><h3 id="531ç©ºé—²ç©ºé—´åç§»é‡fsoçš„ç®¡ç†"><a class="markdownIt-Anchor" href="#531ç©ºé—²ç©ºé—´åç§»é‡fsoçš„ç®¡ç†"></a> 5.3.1ç©ºé—²ç©ºé—´åç§»é‡ï¼ˆFSOï¼‰çš„ç®¡ç†</h3><p>â€‹æ™®é€šé¡µçš„ç®¡ç†æ ¸å¿ƒåœ¨äºç®¡ç†ç©ºé—²ç©ºé—´åç§»é‡ï¼ˆFSOï¼‰ã€‚FSOæŒ‡ç¤ºäº†é¡µé¢ä¸­ç¬¬ä¸€ä¸ªå¯ç”¨çš„ç©ºé—²å­—èŠ‚çš„ä½ç½®ã€‚æ¯æ¬¡æ’å…¥æ•°æ®æ—¶ï¼ŒFSOä¼šæ›´æ–°ä¸ºæ–°æ’å…¥æ•°æ®çš„æœ«å°¾ä½ç½®ï¼Œä»¥ä¾¿åç»­æ’å…¥æ“ä½œå¯ä»¥å‡†ç¡®åœ°æ‰¾åˆ°ç©ºé—²ä½ç½®ã€‚ ä»¥ä¸‹æ˜¯FSOç®¡ç†çš„ä»£ç ç¤ºä¾‹ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// è®¾ç½®ç©ºé—²ç©ºé—´åç§»é‡</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">setFSO</span><span class="params">(<span class="type">byte</span>[] raw, <span class="type">short</span> ofData)</span> &#123;</span><br><span class="line">    System.arraycopy(Parser.short2Byte(ofData), <span class="number">0</span>, raw, OF_FREE, OF_DATA);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// è·å–é¡µé¢çš„ç©ºé—²ç©ºé—´åç§»é‡</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="type">short</span> <span class="title function_">getFSO</span><span class="params">(Page pg)</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> getFSO(pg.getData());</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="type">short</span> <span class="title function_">getFSO</span><span class="params">(<span class="type">byte</span>[] raw)</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> Parser.parseShort(Arrays.copyOfRange(raw, <span class="number">0</span>, <span class="number">2</span>));</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// è·å–é¡µé¢çš„ç©ºé—²ç©ºé—´å¤§å°</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="type">int</span> <span class="title function_">getFreeSpace</span><span class="params">(Page pg)</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> PageCache.PAGE_SIZE - (<span class="type">int</span>) getFSO(pg.getData());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="532æ•°æ®æ’å…¥"><a class="markdownIt-Anchor" href="#532æ•°æ®æ’å…¥"></a> 5.3.2æ•°æ®æ’å…¥</h3><p>â€‹åœ¨æ™®é€šé¡µä¸­æ’å…¥æ•°æ®æ—¶ï¼Œç³»ç»Ÿé¦–å…ˆ<mark>æ ¹æ®å½“å‰çš„FSOç¡®å®šæ’å…¥ä½ç½®</mark>ï¼Œç„¶åå°†æ•°æ®å†™å…¥è¯¥ä½ç½®ï¼Œæœ€åæ›´æ–°FSOã€‚æ’å…¥å®Œæˆåï¼Œé¡µé¢è¢«æ ‡è®°ä¸ºè„é¡µé¢ï¼Œä»¥ä¾¿åœ¨éœ€è¦æ—¶å°†å…¶å†™å›ç£ç›˜ã€‚ ä»¥ä¸‹æ˜¯æ’å…¥æ“ä½œçš„ä»£ç ç¤ºä¾‹ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// å°†æ•°æ®æ’å…¥é¡µé¢ï¼Œè¿”å›æ’å…¥ä½ç½®</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="type">short</span> <span class="title function_">insert</span><span class="params">(Page pg, <span class="type">byte</span>[] raw)</span> &#123;</span><br><span class="line">    pg.setDirty(<span class="literal">true</span>); <span class="comment">// æ ‡è®°é¡µé¢ä¸ºè„é¡µé¢</span></span><br><span class="line">    <span class="type">short</span> <span class="variable">offset</span> <span class="operator">=</span> getFSO(pg.getData()); <span class="comment">// è·å–å½“å‰ç©ºé—²ç©ºé—´åç§»é‡</span></span><br><span class="line">    System.arraycopy(raw, <span class="number">0</span>, pg.getData(), offset, raw.length); <span class="comment">// å°†æ•°æ®å†™å…¥é¡µé¢</span></span><br><span class="line">    setFSO(pg.getData(), (<span class="type">short</span>) (offset + raw.length)); <span class="comment">// æ›´æ–°ç©ºé—²ç©ºé—´åç§»é‡</span></span><br><span class="line">    <span class="keyword">return</span> offset; <span class="comment">// è¿”å›æ•°æ®æ’å…¥ä½ç½®</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="54æ€»ç»“"><a class="markdownIt-Anchor" href="#54æ€»ç»“"></a> 5.4æ€»ç»“</h2><p>â€‹MiniDBå¯ä»¥æœ‰æ•ˆåœ°ç®¡ç†é¡µé¢çš„ç©ºé—²ç©ºé—´ï¼Œå¹¶ç¡®ä¿æ•°æ®çš„ä¸€è‡´æ€§ä¸å®Œæ•´æ€§ã€‚ç¬¬ä¸€é¡µçš„æ ¡éªŒæœºåˆ¶ç¡®ä¿äº†æ•°æ®åº“åœ¨å¯åŠ¨æ—¶èƒ½å¤Ÿæ£€æµ‹å¹¶å¤„ç†æœªæ­£å¸¸å…³é—­çš„æƒ…å†µï¼Œè€Œæ™®é€šé¡µçš„FSOç®¡ç†åˆ™ç¡®ä¿äº†æ•°æ®æ’å…¥å’Œå­˜å‚¨çš„é«˜æ•ˆä¸å‡†ç¡®</p><h1 id="6æ•°æ®ç®¡ç†å™¨æ—¥å¿—ç®¡ç†"><a class="markdownIt-Anchor" href="#6æ•°æ®ç®¡ç†å™¨æ—¥å¿—ç®¡ç†"></a> 6.æ•°æ®ç®¡ç†å™¨â€”â€”æ—¥å¿—ç®¡ç†</h1><h2 id="61è®¾è®¡æ€è·¯"><a class="markdownIt-Anchor" href="#61è®¾è®¡æ€è·¯"></a> 6.1è®¾è®¡æ€è·¯</h2><p>â€‹DM å±‚å¯¹åº•å±‚æ•°æ®è¿›è¡Œæ“ä½œæ—¶ï¼Œéƒ½ä¼š<mark>å°†ä¸€æ¡æ—¥å¿—è®°å½•åˆ°ç£ç›˜ä¸Š</mark>ã€‚åœ¨æ•°æ®åº“å´©æºƒåï¼Œå†æ¬¡å¯åŠ¨æ—¶ï¼Œç³»ç»Ÿå¯ä»¥æ ¹æ®è¿™äº›æ—¥å¿—å†…å®¹æ¢å¤æ•°æ®æ–‡ä»¶ï¼Œä»è€Œç¡®ä¿æ•°æ®çš„å®Œæ•´æ€§</p><h2 id="62æ—¥å¿—æ ¼å¼"><a class="markdownIt-Anchor" href="#62æ—¥å¿—æ ¼å¼"></a> 6.2æ—¥å¿—æ ¼å¼</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[XChecksum][log1][log2][BadTail]</span><br></pre></td></tr></table></figure><blockquote><ul><li><code>XChecksum</code>ï¼šå››å­—èŠ‚çš„æ•´æ•°ï¼Œæ˜¯å¯¹åç»­æ‰€æœ‰æ—¥å¿—è®¡ç®—çš„æ ¡éªŒå’Œ</li><li><code>Log1 ~ LogN</code>ï¼šå¸¸è§„çš„æ—¥å¿—æ•°æ®</li><li><code>BadTail</code>ï¼šæ•°æ®åº“å´©æºƒæ—¶å°šæœªå†™å®Œçš„æ—¥å¿—æ•°æ®ï¼ˆå¯èƒ½ä¸å­˜åœ¨ï¼‰</li></ul></blockquote><p>æ¯æ¡æ—¥å¿—ç»“æ„ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[Size][Checksum][Data]</span><br></pre></td></tr></table></figure><h2 id="63æ—¥å¿—æ–‡ä»¶çš„æ ¡éªŒå’Œ"><a class="markdownIt-Anchor" href="#63æ—¥å¿—æ–‡ä»¶çš„æ ¡éªŒå’Œ"></a> 6.3æ—¥å¿—æ–‡ä»¶çš„æ ¡éªŒå’Œ</h2><h2 id="64æ—¥å¿—æ–‡ä»¶çš„åˆ›å»ºä¸åˆå§‹åŒ–"><a class="markdownIt-Anchor" href="#64æ—¥å¿—æ–‡ä»¶çš„åˆ›å»ºä¸åˆå§‹åŒ–"></a> 6.4æ—¥å¿—æ–‡ä»¶çš„åˆ›å»ºä¸åˆå§‹åŒ–</h2><h2 id="65minidbæ¢å¤ç­–ç•¥è¯¦è§£"><a class="markdownIt-Anchor" href="#65minidbæ¢å¤ç­–ç•¥è¯¦è§£"></a> 6.5MiniDBæ¢å¤ç­–ç•¥è¯¦è§£</h2><h1 id="7æ•°æ®ç®¡ç†å™¨é¡µé¢ç´¢å¼•"><a class="markdownIt-Anchor" href="#7æ•°æ®ç®¡ç†å™¨é¡µé¢ç´¢å¼•"></a> 7.æ•°æ®ç®¡ç†å™¨â€”â€”é¡µé¢ç´¢å¼•</h1><h1 id="8æ•°æ®ç®¡ç†å™¨dmå®ç°"><a class="markdownIt-Anchor" href="#8æ•°æ®ç®¡ç†å™¨dmå®ç°"></a> 8.æ•°æ®ç®¡ç†å™¨â€”â€”DMå®ç°</h1><p>â€‹æ•°æ®ç®¡ç†å™¨æ˜¯MiniDBä¸­çš„æ•°æ®æŠ½è±¡å±‚ï¼Œè´Ÿè´£å­˜å‚¨å’Œç®¡ç†å…·ä½“çš„æ•°æ®å†…å®¹ï¼Œå¹¶ä¸ºä¸Šå±‚æ¨¡å—æä¾›è®¿é—®æ¥å£ï¼š</p><ul><li><strong><mark>æ•°æ®å­˜å‚¨å’Œè®¿é—®</mark></strong>ï¼š<code>DataItem</code> å­˜å‚¨äº†æ•°æ®çš„å…·ä½“å†…å®¹ï¼Œä»¥åŠç›¸å…³çš„å…ƒæ•°æ®ä¿¡æ¯å¦‚æ•°æ®å¤§å°å’Œæœ‰æ•ˆæ ‡å¿—ç­‰</li><li><strong><mark>æ•°æ®ä¿®æ”¹ä¸äº‹åŠ¡ç®¡ç†</mark></strong>ï¼š<code>DataItem</code> æ”¯æŒæ•°æ®çš„ä¿®æ”¹æ“ä½œï¼Œå¹¶åœ¨ä¿®æ”¹æ“ä½œå‰åæ‰§è¡Œä¿å­˜åŸå§‹æ•°æ®ã€è®°å½•æ—¥å¿—ç­‰æµç¨‹ï¼Œä»¥ç¡®ä¿æ•°æ®ä¿®æ”¹çš„åŸå­æ€§å’Œä¸€è‡´æ€§</li><li><strong><mark>ç¼“å­˜ç®¡ç†</mark></strong>ï¼š<code>DataItem</code> å¯¹è±¡ç”±åº•å±‚ <code>DataManager</code> ç¼“å­˜ç®¡ç†ï¼Œä½¿ç”¨ <code>release()</code> æ–¹æ³•å¯ä»¥é‡Šæ”¾ç¼“å­˜ä¸­çš„ <code>DataItem</code> å¯¹è±¡ï¼Œä»¥ä¾¿å›æ”¶å†…å­˜èµ„æº</li></ul><h2 id="81dataitemæ•°æ®ç»“æ„"><a class="markdownIt-Anchor" href="#81dataitemæ•°æ®ç»“æ„"></a> 8.1DataItemæ•°æ®ç»“æ„</h2><h3 id="811æ•°æ®ç»“æ„"><a class="markdownIt-Anchor" href="#811æ•°æ®ç»“æ„"></a> 8.1.1æ•°æ®ç»“æ„</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[ValidFlag] [DataSize] [Data]</span><br></pre></td></tr></table></figure><blockquote><ul><li><strong>ValidFlag</strong>ï¼š1 å­—èŠ‚ï¼Œè¡¨ç¤ºè¯¥ <code>DataItem</code> æ˜¯å¦æœ‰æ•ˆã€‚åˆ é™¤ <code>DataItem</code> åªéœ€å°†å…¶æœ‰æ•ˆä½è®¾ç½®ä¸º 0</li><li><strong>DataSize</strong>ï¼š2 å­—èŠ‚ï¼Œè¡¨ç¤º <code>Data</code> éƒ¨åˆ†çš„é•¿åº¦</li></ul></blockquote><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">DataItemImpl</span> <span class="keyword">implements</span> <span class="title class_">DataItem</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> SubArray raw; <span class="comment">// åŸå§‹æ•°æ®</span></span><br><span class="line">    <span class="keyword">private</span> <span class="type">byte</span>[] oldRaw; <span class="comment">// æ—§çš„åŸå§‹æ•°æ®</span></span><br><span class="line">    <span class="keyword">private</span> DataManagerImpl dm; <span class="comment">// æ•°æ®ç®¡ç†å™¨</span></span><br><span class="line">    <span class="keyword">private</span> <span class="type">long</span> uid; <span class="comment">// å”¯ä¸€æ ‡è¯†ç¬¦</span></span><br><span class="line">    <span class="keyword">private</span> Page pg; <span class="comment">// é¡µé¢å¯¹è±¡</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="812uidçš„ç”Ÿæˆä¸è§£æ"><a class="markdownIt-Anchor" href="#812uidçš„ç”Ÿæˆä¸è§£æ"></a> 8.1.2uidçš„ç”Ÿæˆä¸è§£æ</h3><p><code>DataItem</code> åœ¨ <code>DataManager</code> ä¸­çš„å­˜å‚¨å’Œç®¡ç†æ˜¯é€šè¿‡ä¸€ä¸ªå”¯ä¸€æ ‡è¯†ç¬¦ <code>Uid</code> æ¥å®ç°çš„ã€‚è¿™ä¸ª <code>Uid</code> æ˜¯ç”±é¡µé¢ç¼–å· (<code>pgno</code>) å’Œé¡µé¢å†…åç§»é‡ (<code>offset</code>) ç»„æˆçš„ä¸€ä¸ª 8 å­—èŠ‚æ— ç¬¦å·æ•´æ•°ï¼Œå…¶ä¸­é¡µå·å’Œåç§»é‡å„å  4 å­—èŠ‚ã€‚è¿™é‡Œä»¥<code>pgno = 2 å’Œ offset = 0</code>æ¥æ¼”ç¤ºç”Ÿæˆå’Œè§£æ <code>Uid</code> çš„è¯¦ç»†è¿‡ç¨‹ã€‚</p><h2 id="82dmå…³é”®æ–¹æ³•"><a class="markdownIt-Anchor" href="#82dmå…³é”®æ–¹æ³•"></a> 8.2DMå…³é”®æ–¹æ³•</h2><p>**æ•°æ®è®¿é—®ï¼š**data()ï¼šè¿”å› <code>DataItem</code> ä¸­çš„æ•°æ®éƒ¨åˆ†ï¼Œä¸è¿›è¡Œæ•°æ®æ‹·è´ï¼Œç›´æ¥è¿”å›åŸå§‹æ•°æ®çš„å¼•ç”¨</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> SubArray <span class="title function_">data</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">SubArray</span>(raw.raw, raw.start + OF_DATA, raw.end);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong>æ•°æ®ä¿®æ”¹å‰å‡†å¤‡</strong>ï¼šbefore()ï¼šåœ¨ä¿®æ”¹æ•°æ®é¡¹ä¹‹å‰è°ƒç”¨ï¼Œé”å®šæ•°æ®é¡¹å¹¶ä¿å­˜åŸå§‹æ•°æ®ï¼Œä»¥æ”¯æŒäº‹åŠ¡å›æ»š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">before</span><span class="params">()</span> &#123;</span><br><span class="line">    wLock.lock();</span><br><span class="line">    pg.setDirty(<span class="literal">true</span>);</span><br><span class="line">    System.arraycopy(raw.raw, raw.start, oldRaw, <span class="number">0</span>, oldRaw.length);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å›æ»šä¿®æ”¹ï¼šåœ¨éœ€è¦æ’¤é”€ä¿®æ”¹æ—¶è°ƒç”¨ï¼Œæ¢å¤åŸå§‹æ•°æ®å¹¶è§£é”æ•°æ®é¡¹</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">unBefore</span><span class="params">()</span> &#123;</span><br><span class="line">    System.arraycopy(oldRaw, <span class="number">0</span>, raw.raw, raw.start, oldRaw.length);</span><br><span class="line">    wLock.unlock();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="83dmæ ¸å¿ƒæ–¹æ³•"><a class="markdownIt-Anchor" href="#83dmæ ¸å¿ƒæ–¹æ³•"></a> 8.3DMæ ¸å¿ƒæ–¹æ³•</h2><h3 id="831è¯»å–æ•°æ®"><a class="markdownIt-Anchor" href="#831è¯»å–æ•°æ®"></a> 8.3.1è¯»å–æ•°æ®</h3><p>â€‹read()ï¼šæ ¹æ® <code>Uid</code> ä»ç¼“å­˜ä¸­è·å– <code>DataItem</code>ï¼Œå¹¶æ ¡éªŒå…¶æœ‰æ•ˆæ€§</p><p>â€‹<code>DataItem</code> çš„ <code>Uid</code> æ˜¯ç”±é¡µå·å’Œé¡µå†…åç§»ç»„æˆçš„ä¸€ä¸ª 8 å­—èŠ‚æ— ç¬¦å·æ•´æ•°</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> DataItem <span class="title function_">read</span><span class="params">(<span class="type">long</span> uid)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">    <span class="comment">//ä»ç¼“å­˜é¡µé¢ä¸­è¯»å–åˆ°DataItemImpl</span></span><br><span class="line">    <span class="type">DataItemImpl</span> <span class="variable">di</span> <span class="operator">=</span> (DataItemImpl) <span class="built_in">super</span>.get(uid); <span class="comment">// è‹¥ç¼“å­˜ä¸­ä¸å­˜åœ¨åˆ™è°ƒç”¨ getForCache() æ–¹æ³•</span></span><br><span class="line">    <span class="comment">//æ ¡éªŒdiæ˜¯å¦æœ‰æ•ˆ</span></span><br><span class="line">    <span class="keyword">if</span> (!di.isValid()) &#123;</span><br><span class="line">        <span class="comment">// æ— æ•ˆé‡Šæ”¾ç¼“å­˜</span></span><br><span class="line">        di.release();</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> di;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="832æ’å…¥æ•°æ®"><a class="markdownIt-Anchor" href="#832æ’å…¥æ•°æ®"></a> 8.3.2æ’å…¥æ•°æ®</h3><p>â€‹insert()ï¼šåœ¨ <code>PageIndex</code> ä¸­é€‰æ‹©ä¸€ä¸ªåˆé€‚çš„é¡µé¢è¿›è¡Œæ’å…¥æ“ä½œï¼Œè®°å½•æ’å…¥æ—¥å¿—ï¼Œå¹¶è¿”å›æ’å…¥ä½ç½®çš„åç§»ã€‚</p><p>â€‹æ’å…¥çš„ä½ç½®å’Œé¡µé¢ä¿¡æ¯éƒ½æ˜¯é€šè¿‡é¡µå·å’Œåç§»é‡è¿›è¡Œç®¡ç†çš„</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> <span class="type">long</span> <span class="title function_">insert</span><span class="params">(<span class="type">long</span> xid, <span class="type">byte</span>[] data)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">    <span class="comment">// å°†è¾“å…¥çš„æ•°æ®åŒ…è£…æˆDataItemçš„åŸå§‹æ ¼å¼</span></span><br><span class="line">    <span class="type">byte</span>[] raw = DataItem.wrapDataItemRaw(data);</span><br><span class="line">    <span class="comment">// å¦‚æœæ•°æ®é¡¹çš„å¤§å°è¶…è¿‡äº†é¡µé¢çš„æœ€å¤§ç©ºé—²ç©ºé—´ï¼ŒæŠ›å‡ºå¼‚å¸¸</span></span><br><span class="line">    <span class="keyword">if</span> (raw.length &gt; PageX.MAX_FREE_SPACE) &#123;</span><br><span class="line">        <span class="keyword">throw</span> Error.DataTooLargeException;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// åˆå§‹åŒ–ä¸€ä¸ªé¡µé¢ä¿¡æ¯å¯¹è±¡</span></span><br><span class="line">    <span class="type">PageInfo</span> <span class="variable">pi</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line">    <span class="comment">// å°è¯•5æ¬¡æ‰¾åˆ°ä¸€ä¸ªå¯ä»¥å®¹çº³æ–°æ•°æ®é¡¹çš„é¡µé¢</span></span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; <span class="number">5</span>; i++) &#123;</span><br><span class="line">        <span class="comment">// ä»é¡µé¢ç´¢å¼•ä¸­é€‰æ‹©ä¸€ä¸ªå¯ä»¥å®¹çº³æ–°æ•°æ®é¡¹çš„é¡µé¢</span></span><br><span class="line">        pi = pIndex.select(raw.length);</span><br><span class="line">        <span class="comment">// å¦‚æœæ‰¾åˆ°äº†åˆé€‚çš„é¡µé¢ï¼Œè·³å‡ºå¾ªç¯</span></span><br><span class="line">        <span class="keyword">if</span> (pi != <span class="literal">null</span>) &#123;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="comment">// å¦‚æœæ²¡æœ‰æ‰¾åˆ°åˆé€‚çš„é¡µé¢ï¼Œåˆ›å»ºä¸€ä¸ªæ–°çš„é¡µé¢ï¼Œå¹¶å°†å…¶æ·»åŠ åˆ°é¡µé¢ç´¢å¼•ä¸­</span></span><br><span class="line">            <span class="type">int</span> <span class="variable">newPgno</span> <span class="operator">=</span> pc.newPage(PageX.initRaw());</span><br><span class="line">            pIndex.add(newPgno, PageX.MAX_FREE_SPACE);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// å¦‚æœè¿˜æ˜¯æ²¡æœ‰æ‰¾åˆ°åˆé€‚çš„é¡µé¢ï¼ŒæŠ›å‡ºå¼‚å¸¸</span></span><br><span class="line">    <span class="keyword">if</span> (pi == <span class="literal">null</span>) &#123;</span><br><span class="line">        <span class="keyword">throw</span> Error.DatabaseBusyException;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// åˆå§‹åŒ–ä¸€ä¸ªé¡µé¢å¯¹è±¡</span></span><br><span class="line">    <span class="type">Page</span> <span class="variable">pg</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line">    <span class="comment">// åˆå§‹åŒ–ç©ºé—²ç©ºé—´å¤§å°ä¸º0</span></span><br><span class="line">    <span class="type">int</span> <span class="variable">freeSpace</span> <span class="operator">=</span> <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="comment">// è·å–é¡µé¢ä¿¡æ¯å¯¹è±¡ä¸­çš„é¡µé¢</span></span><br><span class="line">        pg = pc.getPage(pi.pgno);</span><br><span class="line">        <span class="comment">// ç”Ÿæˆæ’å…¥æ—¥å¿—</span></span><br><span class="line">        <span class="type">byte</span>[] log = Recover.insertLog(xid, pg, raw);</span><br><span class="line">        <span class="comment">// å°†æ—¥å¿—å†™å…¥æ—¥å¿—æ–‡ä»¶</span></span><br><span class="line">        logger.log(log);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// åœ¨é¡µé¢ä¸­æ’å…¥æ–°çš„æ•°æ®é¡¹ï¼Œå¹¶è·å–å…¶åœ¨é¡µé¢ä¸­çš„åç§»é‡</span></span><br><span class="line">        <span class="type">short</span> <span class="variable">offset</span> <span class="operator">=</span> PageX.insert(pg, raw);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// é‡Šæ”¾é¡µé¢</span></span><br><span class="line">        pg.release();</span><br><span class="line">        <span class="comment">// è¿”å›æ–°æ’å…¥çš„æ•°æ®é¡¹çš„å”¯ä¸€æ ‡è¯†ç¬¦</span></span><br><span class="line">        <span class="keyword">return</span> Types.addressToUid(pi.pgno, offset);</span><br><span class="line"></span><br><span class="line">    &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">        <span class="comment">// å°†é¡µé¢é‡æ–°æ·»åŠ åˆ°é¡µé¢ç´¢å¼•ä¸­</span></span><br><span class="line">        <span class="keyword">if</span> (pg != <span class="literal">null</span>) &#123;</span><br><span class="line">            pIndex.add(pi.pgno, PageX.getFreeSpace(pg));</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            pIndex.add(pi.pgno, freeSpace);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> *  è¿”å›ä¸€ä¸ªå®Œæ•´çš„ DataItem ç»“æ„æ•°æ®</span></span><br><span class="line"><span class="comment"> *  dataItem ç»“æ„å¦‚ä¸‹ï¼š</span></span><br><span class="line"><span class="comment"> *  [ValidFlag] [DataSize] [Data]</span></span><br><span class="line"><span class="comment"> *  ValidFlag 1å­—èŠ‚ï¼Œ0ä¸ºåˆæ³•ï¼Œ1ä¸ºéæ³•</span></span><br><span class="line"><span class="comment"> *  DataSize  2å­—èŠ‚ï¼Œæ ‡è¯†Dataçš„é•¿åº¦</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> raw</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="type">byte</span>[] wrapDataItemRaw(<span class="type">byte</span>[] raw) &#123;</span><br><span class="line">    <span class="type">byte</span>[] valid = <span class="keyword">new</span> <span class="title class_">byte</span>[<span class="number">1</span>]; <span class="comment">//è¯æ˜æ­¤æ—¶ä¸ºéæ³•æ•°æ®</span></span><br><span class="line">    <span class="type">byte</span>[] size = Parser.short2Byte((<span class="type">short</span>)raw.length); <span class="comment">//è®¡ç®—æ•°æ®å­—èŠ‚å¤§å°</span></span><br><span class="line">    <span class="keyword">return</span> Bytes.concat(valid, size, raw); <span class="comment">//æ‹¼æ¥DataItem ç»“æ„æ•°æ®</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * æ ¹æ®ç»™å®šçš„ç©ºé—´å¤§å°é€‰æ‹©ä¸€ä¸ª PageInfo å¯¹è±¡ã€‚</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> spaceSize éœ€è¦çš„ç©ºé—´å¤§å°</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span> ä¸€ä¸ª PageInfo å¯¹è±¡ï¼Œå…¶ç©ºé—²ç©ºé—´å¤§äºæˆ–ç­‰äºç»™å®šçš„ç©ºé—´å¤§å°ã€‚å¦‚æœæ²¡æœ‰æ‰¾åˆ°åˆé€‚çš„ PageInfoï¼Œè¿”å› nullã€‚</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> PageInfo <span class="title function_">select</span><span class="params">(<span class="type">int</span> spaceSize)</span> &#123;</span><br><span class="line">lock.lock(); <span class="comment">// è·å–é”ï¼Œç¡®ä¿çº¿ç¨‹å®‰å…¨</span></span><br><span class="line"><span class="keyword">try</span> &#123;</span><br><span class="line">    <span class="type">int</span> <span class="variable">number</span> <span class="operator">=</span> spaceSize / THRESHOLD; <span class="comment">// è®¡ç®—éœ€è¦çš„ç©ºé—´å¤§å°å¯¹åº”çš„åŒºé—´ç¼–å·</span></span><br><span class="line">    <span class="comment">// æ­¤å¤„+1ä¸»è¦ä¸ºäº†å‘ä¸Šå–æ•´</span></span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">            1ã€å‡éœ€è¦å­˜å‚¨çš„å­—èŠ‚å¤§å°ä¸º5168ï¼Œæ­¤æ—¶è®¡ç®—å‡ºæ¥çš„åŒºé—´å·æ˜¯25ï¼Œä½†æ˜¯25*204=5100æ˜¾ç„¶æ˜¯ä¸æ»¡è¶³æ¡ä»¶çš„</span></span><br><span class="line"><span class="comment">            2ã€æ­¤æ—¶å‘ä¸Šå–æ•´æ‰¾åˆ° 26ï¼Œè€Œ26*204=5304ï¼Œæ˜¯æ»¡è¶³æ’å…¥æ¡ä»¶çš„</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">    <span class="keyword">if</span> (number &lt; INTERVALS_NO) number++; <span class="comment">// å¦‚æœè®¡ç®—å‡ºçš„åŒºé—´ç¼–å·å°äºæ€»çš„åŒºé—´æ•°ï¼Œç¼–å·åŠ ä¸€</span></span><br><span class="line">    <span class="keyword">while</span> (number &lt;= INTERVALS_NO) &#123; <span class="comment">// ä»è®¡ç®—å‡ºçš„åŒºé—´ç¼–å·å¼€å§‹ï¼Œå‘ä¸Šå¯»æ‰¾åˆé€‚çš„ PageInfo</span></span><br><span class="line">        <span class="keyword">if</span> (lists[number].size() == <span class="number">0</span>) &#123; <span class="comment">// å¦‚æœå½“å‰åŒºé—´æ²¡æœ‰ PageInfoï¼Œç»§ç»­æŸ¥æ‰¾ä¸‹ä¸€ä¸ªåŒºé—´</span></span><br><span class="line">            number++;</span><br><span class="line">            <span class="keyword">continue</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> lists[number].remove(<span class="number">0</span>); <span class="comment">// å¦‚æœå½“å‰åŒºé—´æœ‰ PageInfoï¼Œè¿”å›ç¬¬ä¸€ä¸ª PageInfoï¼Œå¹¶ä»åˆ—è¡¨ä¸­ç§»é™¤</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">null</span>; <span class="comment">// å¦‚æœæ²¡æœ‰æ‰¾åˆ°åˆé€‚çš„ PageInfoï¼Œè¿”å› null</span></span><br><span class="line">&#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">    lock.unlock(); <span class="comment">// é‡Šæ”¾é”</span></span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// å®šä¹‰ä¸€ä¸ªé™æ€æ–¹æ³•ï¼Œç”¨äºåˆ›å»ºæ’å…¥æ—¥å¿—</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="type">byte</span>[] insertLog(<span class="type">long</span> xid, Page pg, <span class="type">byte</span>[] raw) &#123;</span><br><span class="line">    <span class="comment">// åˆ›å»ºä¸€ä¸ªè¡¨ç¤ºæ—¥å¿—ç±»å‹çš„å­—èŠ‚æ•°ç»„ï¼Œå¹¶è®¾ç½®å…¶å€¼ä¸ºLOG_TYPE_INSERT</span></span><br><span class="line">    <span class="type">byte</span>[] logTypeRaw = &#123;LOG_TYPE_INSERT&#125;;</span><br><span class="line">    <span class="comment">// å°†äº‹åŠ¡IDè½¬æ¢ä¸ºå­—èŠ‚æ•°ç»„</span></span><br><span class="line">    <span class="type">byte</span>[] xidRaw = Parser.long2Byte(xid);</span><br><span class="line">    <span class="comment">// å°†é¡µé¢ç¼–å·è½¬æ¢ä¸ºå­—èŠ‚æ•°ç»„</span></span><br><span class="line">    <span class="type">byte</span>[] pgnoRaw = Parser.int2Byte(pg.getPageNumber());</span><br><span class="line">    <span class="comment">// è·å–é¡µé¢çš„ç¬¬ä¸€ä¸ªç©ºé—²ç©ºé—´çš„åç§»é‡ï¼Œå¹¶å°†å…¶è½¬æ¢ä¸ºå­—èŠ‚æ•°ç»„</span></span><br><span class="line">    <span class="type">byte</span>[] offsetRaw = Parser.short2Byte(PageX.getFSO(pg));</span><br><span class="line">    <span class="comment">// å°†æ‰€æœ‰å­—èŠ‚æ•°ç»„è¿æ¥åœ¨ä¸€èµ·ï¼Œå½¢æˆä¸€ä¸ªå®Œæ•´çš„æ’å…¥æ—¥å¿—ï¼Œå¹¶è¿”å›è¿™ä¸ªæ—¥å¿—</span></span><br><span class="line">    <span class="keyword">return</span> Bytes.concat(logTypeRaw, xidRaw, pgnoRaw, offsetRaw, raw);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// å°†rawæ’å…¥pgä¸­ï¼Œè¿”å›æ’å…¥ä½ç½®</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="type">short</span> <span class="title function_">insert</span><span class="params">(Page pg, <span class="type">byte</span>[] raw)</span> &#123;</span><br><span class="line">    pg.setDirty(<span class="literal">true</span>); <span class="comment">// å°†pgçš„dirtyæ ‡å¿—è®¾ç½®ä¸ºtrueï¼Œè¡¨ç¤ºpgçš„æ•°æ®å·²ç»è¢«ä¿®æ”¹</span></span><br><span class="line">    <span class="type">short</span> <span class="variable">offset</span> <span class="operator">=</span> getFSO(pg.getData()); <span class="comment">// è·å–pgçš„ç©ºé—²ç©ºé—´åç§»é‡</span></span><br><span class="line">    System.arraycopy(raw, <span class="number">0</span>, pg.getData(), offset, raw.length); <span class="comment">// å°†rawçš„æ•°æ®å¤åˆ¶åˆ°pgçš„æ•°æ®ä¸­çš„offsetä½ç½®</span></span><br><span class="line">    setFSO(pg.getData(), (<span class="type">short</span>) (offset + raw.length)); <span class="comment">// æ›´æ–°pgçš„ç©ºé—²ç©ºé—´åç§»é‡</span></span><br><span class="line">    <span class="keyword">return</span> offset; <span class="comment">// è¿”å›æ’å…¥ä½ç½®</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="833å…³é—­dm"><a class="markdownIt-Anchor" href="#833å…³é—­dm"></a> 8.3.3å…³é—­DM</h3><p>â€‹æ­£å¸¸å…³é—­æ—¶ï¼Œæ‰§è¡Œç¼“å­˜å’Œæ—¥å¿—çš„å…³é—­æµç¨‹ï¼Œå¹¶è®¾ç½®ç¬¬ä¸€é¡µçš„å­—èŠ‚æ ¡éªŒ</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">close</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="built_in">super</span>.close();</span><br><span class="line">    logger.close();</span><br><span class="line"></span><br><span class="line">    PageOne.setVcClose(pageOne);</span><br><span class="line">    pageOne.release();</span><br><span class="line">    pc.close();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>]]></content>
    
    
      
      
    <summary type="html">&lt;link rel=&quot;stylesheet&quot; class=&quot;aplayer-secondary-style-marker&quot; href=&quot;&#92;assets&#92;css&#92;APlayer.min.css&quot;&gt;&lt;script src=&quot;&#92;assets&#92;js&#92;APlayer.min.js&quot; cla</summary>
      
    
    
    
    <category term="ã€MiniDBã€‘" scheme="https://www.haipeng-lin.cn/categories/%E3%80%90MiniDB%E3%80%91/"/>
    
    
  </entry>
  
  <entry>
    <title>MiniDBâ€”â€”äº‹åŠ¡ç®¡ç†å™¨</title>
    <link href="https://www.haipeng-lin.cn/posts/2a5b6ce0.html"/>
    <id>https://www.haipeng-lin.cn/posts/2a5b6ce0.html</id>
    <published>2024-09-05T00:27:51.000Z</published>
    <updated>2024-09-19T08:57:11.071Z</updated>
    
    <content type="html"><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="\assets\css\APlayer.min.css"><script src="\assets\js\APlayer.min.js" class="aplayer-secondary-script-marker"></script><h1 id="2äº‹åŠ¡ç®¡ç†å™¨"><a class="markdownIt-Anchor" href="#2äº‹åŠ¡ç®¡ç†å™¨"></a> 2.äº‹åŠ¡ç®¡ç†å™¨</h1><h2 id="21è®¾è®¡æ€è·¯"><a class="markdownIt-Anchor" href="#21è®¾è®¡æ€è·¯"></a> 2.1è®¾è®¡æ€è·¯</h2><p>äº‹åŠ¡ç®¡ç†å™¨é€šè¿‡ç»´æŠ¤ .xid æ–‡ä»¶æ¥ç»´æŠ¤äº‹åŠ¡çš„çŠ¶æ€çš„ï¼Œå¹¶æä¾›æ¥å£ä¾›å…¶ä»–æ¨¡å—æ¥æŸ¥è¯¢æŸä¸ªäº‹åŠ¡çš„çŠ¶æ€</p><p>.xidæ–‡ä»¶åŒ…å«äº†æ‰€æœ‰äº‹åŠ¡ï¼Œæ¯ä¸ªäº‹åŠ¡éƒ½æœ‰å”¯ä¸€çš„äº‹åŠ¡IDï¼Œå³XID</p><h2 id="22xidæ–‡ä»¶"><a class="markdownIt-Anchor" href="#22xidæ–‡ä»¶"></a> 2.2xidæ–‡ä»¶</h2><h3 id="221xidå®šä¹‰"><a class="markdownIt-Anchor" href="#221xidå®šä¹‰"></a> 2.2.1XIDå®šä¹‰</h3><ul><li>æ¯ä¸ªäº‹åŠ¡éƒ½æœ‰ä¸€ä¸ªå”¯ä¸€çš„äº‹åŠ¡æ ‡è¯†ç¬¦ XIDï¼Œä» 1 å¼€å§‹é€’å¢</li><li><code>XID 0</code>è¢«ç‰¹æ®Šå®šä¹‰ä¸ºè¶…çº§äº‹åŠ¡ï¼ˆSuper Transactionï¼‰ï¼Œç”¨äºè¡¨ç¤ºåœ¨æ²¡æœ‰ç”³è¯·äº‹åŠ¡çš„æƒ…å†µä¸‹è¿›è¡Œçš„æ“ä½œï¼Œå…¶çŠ¶æ€æ°¸è¿œæ˜¯<code>committed</code></li></ul><h3 id="222äº‹åŠ¡çŠ¶æ€"><a class="markdownIt-Anchor" href="#222äº‹åŠ¡çŠ¶æ€"></a> 2.2.2äº‹åŠ¡çŠ¶æ€</h3><ul><li><code>active</code>ï¼šæ­£åœ¨è¿›è¡Œï¼Œå°šæœªç»“æŸã€‚</li><li><code>committed</code>ï¼šå·²æäº¤ã€‚</li><li><code>aborted</code>ï¼šå·²æ’¤é”€æˆ–å›æ»š</li></ul><h3 id="223æ–‡ä»¶ç»“æ„"><a class="markdownIt-Anchor" href="#223æ–‡ä»¶ç»“æ„"></a> 2.2.3æ–‡ä»¶ç»“æ„</h3><ol><li>æ¯ä¸ªäº‹åŠ¡åœ¨ .xidæ–‡ä»¶ä¸­åˆ†é…ä¸€ä¸ªå­—èŠ‚çš„ç©ºé—´ï¼Œç”¨äºä¿å­˜å…¶çŠ¶æ€</li><li>.xidæ–‡ä»¶çš„å¤´éƒ¨ä¿å­˜ä¸€ä¸ª 8 å­—èŠ‚çš„æ•°å­—ï¼Œç”¨äºè®°å½•è¿™ä¸ª .xidæ–‡ä»¶ç®¡ç†çš„äº‹åŠ¡çš„ä¸ªæ•°</li><li>äº‹åŠ¡ XID åœ¨æ–‡ä»¶ä¸­çš„çŠ¶æ€å­˜å‚¨åœ¨ <code>(XID-1) + 8</code> å­—èŠ‚çš„ä½ç½®å¤„ã€‚ä¾‹å¦‚ï¼Œäº‹åŠ¡2åœ¨æ–‡ä»¶ä¸­çš„çŠ¶æ€å­˜å‚¨åœ¨ï¼ˆ2-1ï¼‰+8=9å­—èŠ‚çš„ä½ç½®</li></ol><h2 id="23transactionmanageræ¥å£å®šä¹‰"><a class="markdownIt-Anchor" href="#23transactionmanageræ¥å£å®šä¹‰"></a> 2.3TransactionManageræ¥å£å®šä¹‰</h2><blockquote><p>TMæä¾›æ¥å£ï¼Œä¾›ä¸Šå±‚æ¨¡å—è°ƒç”¨</p></blockquote><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">TransactionManager</span> &#123;</span><br><span class="line">    <span class="type">long</span> <span class="title function_">begin</span><span class="params">()</span>;                       <span class="comment">// å¼€å¯ä¸€ä¸ªæ–°äº‹åŠ¡</span></span><br><span class="line">    <span class="keyword">void</span> <span class="title function_">commit</span><span class="params">(<span class="type">long</span> xid)</span>;              <span class="comment">// æäº¤ä¸€ä¸ªäº‹åŠ¡</span></span><br><span class="line">    <span class="keyword">void</span> <span class="title function_">abort</span><span class="params">(<span class="type">long</span> xid)</span>;               <span class="comment">// å–æ¶ˆä¸€ä¸ªäº‹åŠ¡</span></span><br><span class="line">    <span class="type">boolean</span> <span class="title function_">isActive</span><span class="params">(<span class="type">long</span> xid)</span>;         <span class="comment">// æŸ¥è¯¢ä¸€ä¸ªäº‹åŠ¡çš„çŠ¶æ€æ˜¯å¦æ˜¯æ­£åœ¨è¿›è¡Œçš„çŠ¶æ€</span></span><br><span class="line">    <span class="type">boolean</span> <span class="title function_">isCommitted</span><span class="params">(<span class="type">long</span> xid)</span>;      <span class="comment">// æŸ¥è¯¢ä¸€ä¸ªäº‹åŠ¡çš„çŠ¶æ€æ˜¯å¦æ˜¯å·²æäº¤</span></span><br><span class="line">    <span class="type">boolean</span> <span class="title function_">isAborted</span><span class="params">(<span class="type">long</span> xid)</span>;        <span class="comment">// æŸ¥è¯¢ä¸€ä¸ªäº‹åŠ¡çš„çŠ¶æ€æ˜¯å¦æ˜¯å·²å–æ¶ˆ</span></span><br><span class="line">    <span class="keyword">void</span> <span class="title function_">close</span><span class="params">()</span>;                       <span class="comment">// å…³é—­TM</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="24tmæ¨¡å—çš„å®ç°"><a class="markdownIt-Anchor" href="#24tmæ¨¡å—çš„å®ç°"></a> 2.4TMæ¨¡å—çš„å®ç°</h2><h3 id="241å¸¸é‡å®šä¹‰"><a class="markdownIt-Anchor" href="#241å¸¸é‡å®šä¹‰"></a> 2.4.1å¸¸é‡å®šä¹‰</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">TransactionManagerImpl</span> <span class="keyword">implements</span> <span class="title class_">TransactionManager</span> &#123;</span><br><span class="line">    <span class="comment">// XIDæ–‡ä»¶å¤´é•¿åº¦</span></span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">int</span> <span class="variable">LEN_XID_HEADER_LENGTH</span> <span class="operator">=</span> <span class="number">8</span>;</span><br><span class="line">    <span class="comment">// æ¯ä¸ªäº‹åŠ¡çš„å ç”¨é•¿åº¦</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">int</span> <span class="variable">XID_FIELD_SIZE</span> <span class="operator">=</span> <span class="number">1</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// äº‹åŠ¡çš„ä¸‰ç§çŠ¶æ€</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">byte</span> <span class="variable">FIELD_TRAN_ACTIVE</span> <span class="operator">=</span> <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">byte</span> <span class="variable">FIELD_TRAN_COMMITTED</span> <span class="operator">=</span> <span class="number">1</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">byte</span> <span class="variable">FIELD_TRAN_ABORTED</span> <span class="operator">=</span> <span class="number">2</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// è¶…çº§äº‹åŠ¡ï¼Œæ°¸è¿œä¸ºcommitedçŠ¶æ€</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">long</span> <span class="variable">SUPER_XID</span> <span class="operator">=</span> <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// XIDæ–‡ä»¶åç¼€</span></span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">XID_SUFFIX</span> <span class="operator">=</span> <span class="string">&quot;.xid&quot;</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="242xidæ–‡ä»¶çš„æ ¡éªŒä¸è¯»å–"><a class="markdownIt-Anchor" href="#242xidæ–‡ä»¶çš„æ ¡éªŒä¸è¯»å–"></a> 2.4.2xidæ–‡ä»¶çš„æ ¡éªŒä¸è¯»å–</h3><h4 id="1æ ¡éªŒxidæ–‡ä»¶"><a class="markdownIt-Anchor" href="#1æ ¡éªŒxidæ–‡ä»¶"></a> ï¼ˆ1ï¼‰æ ¡éªŒxidæ–‡ä»¶</h4><ol><li>åœ¨åˆ›å»º <code>TransactionManager</code>çš„æ„é€ å‡½æ•°åï¼Œé¦–å…ˆéœ€è¦å¯¹ XID æ–‡ä»¶è¿›è¡Œæ ¡éªŒï¼Œä»¥ç¡®ä¿å…¶åˆæ³•æ€§ã€‚</li><li>æ ¡éªŒè¿‡ç¨‹ç›¸å¯¹ç®€å•ï¼Œé€šè¿‡è¯»å–æ–‡ä»¶å¤´çš„ 8 å­—èŠ‚æ•°å­—æ¨ç®—å‡ºæ–‡ä»¶çš„ç†è®ºé•¿åº¦ï¼Œå¹¶å°†å…¶ä¸å®é™…é•¿åº¦è¿›è¡Œå¯¹æ¯”ã€‚</li><li>å¦‚æœä¸¤è€…ä¸ä¸€è‡´ï¼Œåˆ™è®¤ä¸ºè¯¥ XID æ–‡ä»¶å­˜åœ¨é—®é¢˜ï¼Œä¸ç¬¦åˆè§„èŒƒã€‚å¯¹äºæ ¡éªŒæœªé€šè¿‡çš„æƒ…å†µï¼Œç³»ç»Ÿä¼šç«‹å³è§¦å‘ panic æ–¹æ³•ï¼Œå¼ºåˆ¶ç»ˆæ­¢è¿è¡Œã€‚</li><li>åœ¨ä¸€äº›å…³é”®åŸºç¡€æ¨¡å—ä¸­ï¼Œä¸€æ—¦å‘ç”Ÿæ— æ³•æ¢å¤çš„é”™è¯¯ï¼Œç³»ç»Ÿä¼šç›´æ¥åœæœºï¼Œä»¥ç¡®ä¿æ•´ä½“ç³»ç»Ÿçš„å®‰å…¨æ€§å’Œç¨³å®šæ€§ã€‚</li></ol><h4 id="2å¼€å§‹ä¸€ä¸ªäº‹åŠ¡"><a class="markdownIt-Anchor" href="#2å¼€å§‹ä¸€ä¸ªäº‹åŠ¡"></a> ï¼ˆ2ï¼‰å¼€å§‹ä¸€ä¸ªäº‹åŠ¡</h4><blockquote><p>å¼€å§‹ä¸€ä¸ªäº‹åŠ¡ï¼šä¸ºäº‹åŠ¡åˆ†é…ä¸€ä¸ªç¼–å·ï¼Œå¹¶æ ‡è®°ä¸ºâ€œè¿›è¡Œä¸­â€ï¼Œä¿å­˜åˆ°.xidæ–‡ä»¶</p></blockquote><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="type">long</span> <span class="title function_">begin</span><span class="params">()</span> &#123;</span><br><span class="line">    counterLock.lock();</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="comment">// ä¸ºäº‹åŠ¡åˆ†é…ä¸€ä¸ªç¼–å·</span></span><br><span class="line">        <span class="type">long</span> <span class="variable">xid</span> <span class="operator">=</span> xidCounter + <span class="number">1</span>;</span><br><span class="line">        <span class="comment">// æ ‡è®°ä¸ºâ€œè¿›è¡Œä¸­â€</span></span><br><span class="line">        updateXID(xid, FIELD_TRAN_ACTIVE);</span><br><span class="line">        <span class="comment">// å°†äº‹åŠ¡ä¿¡æ¯ ä¿å­˜åˆ°.xidæ–‡ä»¶</span></span><br><span class="line">        incrXIDCounter();</span><br><span class="line">        <span class="keyword">return</span> xid;</span><br><span class="line">    &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">        counterLock.unlock();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="3æ›´æ–°äº‹åŠ¡çŠ¶æ€"><a class="markdownIt-Anchor" href="#3æ›´æ–°äº‹åŠ¡çŠ¶æ€"></a> ï¼ˆ3ï¼‰æ›´æ–°äº‹åŠ¡çŠ¶æ€</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// æ›´æ–°xidäº‹åŠ¡çš„çŠ¶æ€ä¸ºstatus</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">updateXID</span><span class="params">(<span class="type">long</span> xid, <span class="type">byte</span> status)</span> &#123;</span><br><span class="line">    <span class="comment">// è·å–äº‹åŠ¡xidåœ¨xidæ–‡ä»¶ä¸­å¯¹åº”çš„ä½ç½®</span></span><br><span class="line">    <span class="type">long</span> <span class="variable">offset</span> <span class="operator">=</span> getXidPosition(xid);</span><br><span class="line">    <span class="comment">// åˆ›å»ºä¸€ä¸ªé•¿åº¦ä¸ºXID_FIELD_SIZEçš„å­—èŠ‚æ•°ç»„</span></span><br><span class="line">    <span class="type">byte</span>[] tmp = <span class="keyword">new</span> <span class="title class_">byte</span>[XID_FIELD_SIZE];</span><br><span class="line">    <span class="comment">// å°†äº‹åŠ¡çŠ¶æ€è®¾ç½®ä¸ºstatus</span></span><br><span class="line">    tmp[<span class="number">0</span>] = status;</span><br><span class="line">    <span class="comment">// ä½¿ç”¨å­—èŠ‚æ•°ç»„åˆ›å»ºä¸€ä¸ªByteBuffer</span></span><br><span class="line">    <span class="type">ByteBuffer</span> <span class="variable">buf</span> <span class="operator">=</span> ByteBuffer.wrap(tmp);</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="comment">// å°†æ–‡ä»¶é€šé“çš„ä½ç½®è®¾ç½®ä¸ºoffset</span></span><br><span class="line">        fc.position(offset);</span><br><span class="line">        <span class="comment">// å°†ByteBufferä¸­çš„æ•°æ®å†™å…¥åˆ°æ–‡ä»¶é€šé“</span></span><br><span class="line">        fc.write(buf);</span><br><span class="line">    &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">        <span class="comment">// å¦‚æœå‡ºç°å¼‚å¸¸ï¼Œè°ƒç”¨Panic.panicæ–¹æ³•å¤„ç†</span></span><br><span class="line">        Panic.panic(e);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="comment">// å¼ºåˆ¶å°†æ–‡ä»¶é€šé“ä¸­çš„æ‰€æœ‰æœªå†™å…¥çš„æ•°æ®å†™å…¥åˆ°ç£ç›˜</span></span><br><span class="line">        fc.force(<span class="literal">false</span>);</span><br><span class="line">    &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">        <span class="comment">// å¦‚æœå‡ºç°å¼‚å¸¸ï¼Œè°ƒç”¨Panic.panicæ–¹æ³•å¤„ç†</span></span><br><span class="line">        Panic.panic(e);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="4å¢åŠ äº‹åŠ¡è®¡æ•°"><a class="markdownIt-Anchor" href="#4å¢åŠ äº‹åŠ¡è®¡æ•°"></a> ï¼ˆ4ï¼‰å¢åŠ äº‹åŠ¡è®¡æ•°</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// å°†XIDåŠ ä¸€ï¼Œå¹¶æ›´æ–°XID Header</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">incrXIDCounter</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="comment">// äº‹åŠ¡æ€»æ•°åŠ ä¸€</span></span><br><span class="line">    xidCounter++;</span><br><span class="line">    <span class="comment">// å°†æ–°çš„äº‹åŠ¡æ€»æ•°è½¬æ¢ä¸ºå­—èŠ‚æ•°ç»„ï¼Œå¹¶ç”¨ByteBufferåŒ…è£…</span></span><br><span class="line">    <span class="type">ByteBuffer</span> <span class="variable">buf</span> <span class="operator">=</span> ByteBuffer.wrap(Parser.long2Byte(xidCounter));</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="comment">// å°†æ–‡ä»¶é€šé“çš„ä½ç½®è®¾ç½®ä¸º0ï¼Œå³æ–‡ä»¶çš„å¼€å§‹ä½ç½®</span></span><br><span class="line">        fc.position(<span class="number">0</span>);</span><br><span class="line">        <span class="comment">// å°†ByteBufferä¸­çš„æ•°æ®å†™å…¥åˆ°æ–‡ä»¶é€šé“ï¼Œå³æ›´æ–°äº†XIDæ–‡ä»¶çš„å¤´éƒ¨ä¿¡æ¯</span></span><br><span class="line">        fc.write(buf);</span><br><span class="line">    &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">        <span class="comment">// å¦‚æœå‡ºç°å¼‚å¸¸ï¼Œè°ƒç”¨Panic.panicæ–¹æ³•å¤„ç†</span></span><br><span class="line">        Panic.panic(e);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="comment">// å¼ºåˆ¶å°†æ–‡ä»¶é€šé“ä¸­çš„æ‰€æœ‰æœªå†™å…¥çš„æ•°æ®å†™å…¥åˆ°ç£ç›˜</span></span><br><span class="line">        fc.force(<span class="literal">false</span>);</span><br><span class="line">    &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">        <span class="comment">// å¦‚æœå‡ºç°å¼‚å¸¸ï¼Œè°ƒç”¨Panic.panicæ–¹æ³•å¤„ç†</span></span><br><span class="line">        Panic.panic(e);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="5äº‹åŠ¡çŠ¶æ€æ£€æŸ¥"><a class="markdownIt-Anchor" href="#5äº‹åŠ¡çŠ¶æ€æ£€æŸ¥"></a> ï¼ˆ5ï¼‰äº‹åŠ¡çŠ¶æ€æ£€æŸ¥</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// å®šä¹‰ä¸€ä¸ªæ–¹æ³•ï¼Œæ¥æ”¶ä¸€ä¸ªäº‹åŠ¡IDï¼ˆxidï¼‰å’Œä¸€ä¸ªçŠ¶æ€ï¼ˆstatusï¼‰ä½œä¸ºå‚æ•°</span></span><br><span class="line"><span class="keyword">private</span> <span class="type">boolean</span> <span class="title function_">checkXID</span><span class="params">(<span class="type">long</span> xid, <span class="type">byte</span> status)</span> &#123;</span><br><span class="line">    <span class="comment">// è®¡ç®—äº‹åŠ¡IDåœ¨XIDæ–‡ä»¶ä¸­çš„ä½ç½®</span></span><br><span class="line">    <span class="type">long</span> <span class="variable">offset</span> <span class="operator">=</span> getXidPosition(xid);</span><br><span class="line">    <span class="comment">// åˆ›å»ºä¸€ä¸ªæ–°çš„å­—èŠ‚ç¼“å†²åŒºï¼ˆByteBufferï¼‰ï¼Œé•¿åº¦ä¸ºXID_FIELD_SIZE</span></span><br><span class="line">    <span class="type">ByteBuffer</span> <span class="variable">buf</span> <span class="operator">=</span> ByteBuffer.wrap(<span class="keyword">new</span> <span class="title class_">byte</span>[XID_FIELD_SIZE]);</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="comment">// å°†æ–‡ä»¶é€šé“çš„ä½ç½®è®¾ç½®ä¸ºoffset</span></span><br><span class="line">        fc.position(offset);</span><br><span class="line">        <span class="comment">// ä»æ–‡ä»¶é€šé“è¯»å–æ•°æ®åˆ°å­—èŠ‚ç¼“å†²åŒº</span></span><br><span class="line">        fc.read(buf);</span><br><span class="line">    &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">        <span class="comment">// å¦‚æœå‡ºç°å¼‚å¸¸ï¼Œè°ƒç”¨Panic.panicæ–¹æ³•å¤„ç†</span></span><br><span class="line">        Panic.panic(e);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// æ£€æŸ¥å­—èŠ‚ç¼“å†²åŒºçš„ç¬¬ä¸€ä¸ªå­—èŠ‚æ˜¯å¦ç­‰äºç»™å®šçš„çŠ¶æ€</span></span><br><span class="line">    <span class="comment">// å¦‚æœç­‰äºï¼Œè¿”å›trueï¼Œå¦åˆ™è¿”å›false</span></span><br><span class="line">    <span class="keyword">return</span> buf.array()[<span class="number">0</span>] == status;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="6å…³é—­äº‹åŠ¡ç®¡ç†å™¨"><a class="markdownIt-Anchor" href="#6å…³é—­äº‹åŠ¡ç®¡ç†å™¨"></a> ï¼ˆ6ï¼‰å…³é—­äº‹åŠ¡ç®¡ç†å™¨</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">close</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        fc.close();</span><br><span class="line">        file.close();</span><br><span class="line">    &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">        Panic.panic(e);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="25æ€»ç»“"><a class="markdownIt-Anchor" href="#25æ€»ç»“"></a> 2.5æ€»ç»“</h2><ol><li>TM æ¨¡å—çš„ä¸»è¦åŠŸèƒ½æ˜¯ <strong>ç®¡ç†äº‹åŠ¡</strong>ï¼ŒåŒ…æ‹¬äº‹åŠ¡çš„å¼€å§‹ã€æäº¤ã€å›æ»šä»¥åŠçŠ¶æ€æ£€æŸ¥ã€‚</li><li>ä¸ºå®ç°è¿™äº›åŠŸèƒ½ï¼Œæ¨¡å—ä¸­å®šä¹‰äº†ä¸€ç³»åˆ—å…³é”®å¸¸é‡ï¼Œå¦‚ <code>LEN_XID_HEADER_LENGTH</code>ã€<code>XID_FIELD_SIZE</code>ã€<code>FIELD_TRAN_ACTIVE</code>ã€<code>FIELD_TRAN_COMMITTED</code>ã€<code>FIELD_TRAN_ABORTED</code>ã€<code>SUPER_XID</code> å’Œ <code>XID_SUFFIX</code>ï¼Œåˆ†åˆ«è¡¨ç¤º XID æ–‡ä»¶å¤´é•¿åº¦ã€æ¯ä¸ªäº‹åŠ¡çš„å ç”¨é•¿åº¦ã€äº‹åŠ¡çš„ä¸‰ç§çŠ¶æ€ã€è¶…çº§äº‹åŠ¡æ ‡è¯†ä»¥åŠ XID æ–‡ä»¶çš„åç¼€ã€‚</li><li>åœ¨å®ç°ä¸Šï¼ŒTM æ¨¡å—é€šè¿‡ <code>RandomAccessFile</code> ç±»å‹çš„ <code>file</code> å’Œ <code>FileChannel</code> ç±»å‹çš„ <code>fc</code> æ“ä½œ XID æ–‡ä»¶ï¼Œå¹¶ä½¿ç”¨ <code>xidCounter</code> æ¥è®°å½•äº‹åŠ¡çš„æ•°é‡ï¼ŒåŒæ—¶é€šè¿‡ <code>Lock</code> ç±»ç¡®ä¿çº¿ç¨‹å®‰å…¨ã€‚</li><li>æ„é€ å‡½æ•°ä¸­ï¼Œé¦–å…ˆå¯¹ <code>file</code> å’Œ <code>fc</code> è¿›è¡Œåˆå§‹åŒ–ï¼Œå¹¶è°ƒç”¨ <code>checkXIDCounter</code> æ–¹æ³•æ ¡éªŒ XID æ–‡ä»¶çš„åˆæ³•æ€§ï¼Œç¡®ä¿æ–‡ä»¶çš„æ­£ç¡®æ€§ã€‚</li><li>åœ¨äº‹åŠ¡ç®¡ç†æ–¹é¢ï¼Œ<code>begin()</code> æ–¹æ³•ç”¨äºå¼€å§‹ä¸€ä¸ªæ–°äº‹åŠ¡ï¼Œé€šè¿‡è°ƒç”¨ <code>updateXID()</code> æ–¹æ³•å°†äº‹åŠ¡ ID å’ŒçŠ¶æ€å†™å…¥ XID æ–‡ä»¶ï¼Œå¹¶é€šè¿‡ <code>incrXIDCounter()</code> æ–¹æ³•æ›´æ–° XID è®¡æ•°å™¨ã€‚<code>commit()</code> å’Œ <code>abort()</code> æ–¹æ³•åˆ†åˆ«ç”¨äºæäº¤å’Œå›æ»šäº‹åŠ¡ï¼Œä¾èµ– <code>updateXID()</code> æ–¹æ³•æ¥æ›´æ–°äº‹åŠ¡çŠ¶æ€ã€‚<code>isActive()</code>ã€<code>isCommitted()</code> å’Œ <code>isAborted()</code> æ–¹æ³•ç”¨äºæ£€æŸ¥äº‹åŠ¡çŠ¶æ€ï¼Œé€šè¿‡ <code>checkXID()</code> æ–¹æ³•ç¡®è®¤äº‹åŠ¡çš„å½“å‰çŠ¶æ€ã€‚<code>close()</code> æ–¹æ³•åˆ™è´Ÿè´£å…³é—­æ–‡ä»¶é€šé“å’Œæ–‡ä»¶ï¼Œç¡®ä¿èµ„æºçš„æ­£ç¡®é‡Šæ”¾ã€‚</li></ol>]]></content>
    
    
      
      
    <summary type="html">&lt;link rel=&quot;stylesheet&quot; class=&quot;aplayer-secondary-style-marker&quot; href=&quot;&#92;assets&#92;css&#92;APlayer.min.css&quot;&gt;&lt;script src=&quot;&#92;assets&#92;js&#92;APlayer.min.js&quot; cla</summary>
      
    
    
    
    <category term="ã€MiniDBã€‘" scheme="https://www.haipeng-lin.cn/categories/%E3%80%90MiniDB%E3%80%91/"/>
    
    
  </entry>
  
</feed>
